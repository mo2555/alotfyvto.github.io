(function(){var CM={924:function(Ai,ft,St){"use strict";var _t=St(210),ni=St(559),ai=ni(_t("String.prototype.indexOf"));Ai.exports=function(ui,Si){var zi=_t(ui,!!Si);return typeof zi=="function"&&ai(ui,".prototype.")>-1?ni(zi):zi}},559:function(Ai,ft,St){"use strict";var _t=St(612),ni=St(210),ai=ni("%Function.prototype.apply%"),kt=ni("%Function.prototype.call%"),ui=ni("%Reflect.apply%",!0)||_t.call(kt,ai),Si=ni("%Object.getOwnPropertyDescriptor%",!0),zi=ni("%Object.defineProperty%",!0),Te=ni("%Math.max%");if(zi)try{zi({},"a",{value:1})}catch{zi=null}Ai.exports=function(Je){var qt=ui(_t,kt,arguments);if(Si&&zi){var nr=Si(qt,"length");nr.configurable&&zi(qt,"length",{value:1+Te(0,Je.length-(arguments.length-1))})}return qt};var yi=function(){return ui(_t,ai,arguments)};zi?zi(Ai.exports,"apply",{value:yi}):Ai.exports.apply=yi},187:function(Ai){"use strict";var ft=typeof Reflect=="object"?Reflect:null,St=ft&&typeof ft.apply=="function"?ft.apply:function(ut,bt,_i){return Function.prototype.apply.call(ut,bt,_i)},_t;ft&&typeof ft.ownKeys=="function"?_t=ft.ownKeys:Object.getOwnPropertySymbols?_t=function(ut){return Object.getOwnPropertyNames(ut).concat(Object.getOwnPropertySymbols(ut))}:_t=function(ut){return Object.getOwnPropertyNames(ut)};function ni(ct){console&&console.warn&&console.warn(ct)}var ai=Number.isNaN||function(ut){return ut!==ut};function kt(){kt.init.call(this)}Ai.exports=kt,Ai.exports.once=Mr,kt.EventEmitter=kt,kt.prototype._events=void 0,kt.prototype._eventsCount=0,kt.prototype._maxListeners=void 0;var ui=10;function Si(ct){if(typeof ct!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof ct)}Object.defineProperty(kt,"defaultMaxListeners",{enumerable:!0,get:function(){return ui},set:function(ct){if(typeof ct!="number"||ct<0||ai(ct))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+ct+".");ui=ct}}),kt.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},kt.prototype.setMaxListeners=function(ut){if(typeof ut!="number"||ut<0||ai(ut))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+ut+".");return this._maxListeners=ut,this};function zi(ct){return ct._maxListeners===void 0?kt.defaultMaxListeners:ct._maxListeners}kt.prototype.getMaxListeners=function(){return zi(this)},kt.prototype.emit=function(ut){for(var bt=[],_i=1;_i<arguments.length;_i++)bt.push(arguments[_i]);var vi=ut==="error",Zi=this._events;if(Zi!==void 0)vi=vi&&Zi.error===void 0;else if(!vi)return!1;if(vi){var Pi;if(bt.length>0&&(Pi=bt[0]),Pi instanceof Error)throw Pi;var hs=new Error("Unhandled error."+(Pi?" ("+Pi.message+")":""));throw hs.context=Pi,hs}var yr=Zi[ut];if(yr===void 0)return!1;if(typeof yr=="function")St(yr,this,bt);else for(var tr=yr.length,qr=nr(yr,tr),_i=0;_i<tr;++_i)St(qr[_i],this,bt);return!0};function Te(ct,ut,bt,_i){var vi,Zi,Pi;if(Si(bt),Zi=ct._events,Zi===void 0?(Zi=ct._events=Object.create(null),ct._eventsCount=0):(Zi.newListener!==void 0&&(ct.emit("newListener",ut,bt.listener?bt.listener:bt),Zi=ct._events),Pi=Zi[ut]),Pi===void 0)Pi=Zi[ut]=bt,++ct._eventsCount;else if(typeof Pi=="function"?Pi=Zi[ut]=_i?[bt,Pi]:[Pi,bt]:_i?Pi.unshift(bt):Pi.push(bt),vi=zi(ct),vi>0&&Pi.length>vi&&!Pi.warned){Pi.warned=!0;var hs=new Error("Possible EventEmitter memory leak detected. "+Pi.length+" "+String(ut)+" listeners added. Use emitter.setMaxListeners() to increase limit");hs.name="MaxListenersExceededWarning",hs.emitter=ct,hs.type=ut,hs.count=Pi.length,ni(hs)}return ct}kt.prototype.addListener=function(ut,bt){return Te(this,ut,bt,!1)},kt.prototype.on=kt.prototype.addListener,kt.prototype.prependListener=function(ut,bt){return Te(this,ut,bt,!0)};function yi(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Fi(ct,ut,bt){var _i={fired:!1,wrapFn:void 0,target:ct,type:ut,listener:bt},vi=yi.bind(_i);return vi.listener=bt,_i.wrapFn=vi,vi}kt.prototype.once=function(ut,bt){return Si(bt),this.on(ut,Fi(this,ut,bt)),this},kt.prototype.prependOnceListener=function(ut,bt){return Si(bt),this.prependListener(ut,Fi(this,ut,bt)),this},kt.prototype.removeListener=function(ut,bt){var _i,vi,Zi,Pi,hs;if(Si(bt),vi=this._events,vi===void 0)return this;if(_i=vi[ut],_i===void 0)return this;if(_i===bt||_i.listener===bt)--this._eventsCount===0?this._events=Object.create(null):(delete vi[ut],vi.removeListener&&this.emit("removeListener",ut,_i.listener||bt));else if(typeof _i!="function"){for(Zi=-1,Pi=_i.length-1;Pi>=0;Pi--)if(_i[Pi]===bt||_i[Pi].listener===bt){hs=_i[Pi].listener,Zi=Pi;break}if(Zi<0)return this;Zi===0?_i.shift():gs(_i,Zi),_i.length===1&&(vi[ut]=_i[0]),vi.removeListener!==void 0&&this.emit("removeListener",ut,hs||bt)}return this},kt.prototype.off=kt.prototype.removeListener,kt.prototype.removeAllListeners=function(ut){var bt,_i,vi;if(_i=this._events,_i===void 0)return this;if(_i.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):_i[ut]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete _i[ut]),this;if(arguments.length===0){var Zi=Object.keys(_i),Pi;for(vi=0;vi<Zi.length;++vi)Pi=Zi[vi],Pi!=="removeListener"&&this.removeAllListeners(Pi);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(bt=_i[ut],typeof bt=="function")this.removeListener(ut,bt);else if(bt!==void 0)for(vi=bt.length-1;vi>=0;vi--)this.removeListener(ut,bt[vi]);return this};function Je(ct,ut,bt){var _i=ct._events;if(_i===void 0)return[];var vi=_i[ut];return vi===void 0?[]:typeof vi=="function"?bt?[vi.listener||vi]:[vi]:bt?ys(vi):nr(vi,vi.length)}kt.prototype.listeners=function(ut){return Je(this,ut,!0)},kt.prototype.rawListeners=function(ut){return Je(this,ut,!1)},kt.listenerCount=function(ct,ut){return typeof ct.listenerCount=="function"?ct.listenerCount(ut):qt.call(ct,ut)},kt.prototype.listenerCount=qt;function qt(ct){var ut=this._events;if(ut!==void 0){var bt=ut[ct];if(typeof bt=="function")return 1;if(bt!==void 0)return bt.length}return 0}kt.prototype.eventNames=function(){return this._eventsCount>0?_t(this._events):[]};function nr(ct,ut){for(var bt=new Array(ut),_i=0;_i<ut;++_i)bt[_i]=ct[_i];return bt}function gs(ct,ut){for(;ut+1<ct.length;ut++)ct[ut]=ct[ut+1];ct.pop()}function ys(ct){for(var ut=new Array(ct.length),bt=0;bt<ut.length;++bt)ut[bt]=ct[bt].listener||ct[bt];return ut}function Mr(ct,ut){return new Promise(function(bt,_i){function vi(Pi){ct.removeListener(ut,Zi),_i(Pi)}function Zi(){typeof ct.removeListener=="function"&&ct.removeListener("error",vi),bt([].slice.call(arguments))}jt(ct,ut,Zi,{once:!0}),ut!=="error"&&Xi(ct,vi,{once:!0})})}function Xi(ct,ut,bt){typeof ct.on=="function"&&jt(ct,"error",ut,bt)}function jt(ct,ut,bt,_i){if(typeof ct.on=="function")_i.once?ct.once(ut,bt):ct.on(ut,bt);else if(typeof ct.addEventListener=="function")ct.addEventListener(ut,function vi(Zi){_i.once&&ct.removeEventListener(ut,vi),bt(Zi)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof ct)}},29:function(Ai,ft,St){"use strict";var _t=St(320),ni=Object.prototype.toString,ai=Object.prototype.hasOwnProperty,kt=function(yi,Fi,Je){for(var qt=0,nr=yi.length;qt<nr;qt++)ai.call(yi,qt)&&(Je==null?Fi(yi[qt],qt,yi):Fi.call(Je,yi[qt],qt,yi))},ui=function(yi,Fi,Je){for(var qt=0,nr=yi.length;qt<nr;qt++)Je==null?Fi(yi.charAt(qt),qt,yi):Fi.call(Je,yi.charAt(qt),qt,yi)},Si=function(yi,Fi,Je){for(var qt in yi)ai.call(yi,qt)&&(Je==null?Fi(yi[qt],qt,yi):Fi.call(Je,yi[qt],qt,yi))},zi=function(yi,Fi,Je){if(!_t(Fi))throw new TypeError("iterator must be a function");var qt;arguments.length>=3&&(qt=Je),ni.call(yi)==="[object Array]"?kt(yi,Fi,qt):typeof yi=="string"?ui(yi,Fi,qt):Si(yi,Fi,qt)};Ai.exports=zi},648:function(Ai){"use strict";var ft="Function.prototype.bind called on incompatible ",St=Array.prototype.slice,_t=Object.prototype.toString,ni="[object Function]";Ai.exports=function(kt){var ui=this;if(typeof ui!="function"||_t.call(ui)!==ni)throw new TypeError(ft+ui);for(var Si=St.call(arguments,1),zi,Te=function(){if(this instanceof zi){var nr=ui.apply(this,Si.concat(St.call(arguments)));return Object(nr)===nr?nr:this}else return ui.apply(kt,Si.concat(St.call(arguments)))},yi=Math.max(0,ui.length-Si.length),Fi=[],Je=0;Je<yi;Je++)Fi.push("$"+Je);if(zi=Function("binder","return function ("+Fi.join(",")+"){ return binder.apply(this,arguments); }")(Te),ui.prototype){var qt=function(){};qt.prototype=ui.prototype,zi.prototype=new qt,qt.prototype=null}return zi}},612:function(Ai,ft,St){"use strict";var _t=St(648);Ai.exports=Function.prototype.bind||_t},210:function(Ai,ft,St){"use strict";var _t,ni=SyntaxError,ai=Function,kt=TypeError,ui=function(yr){try{return ai('"use strict"; return ('+yr+").constructor;")()}catch{}},Si=Object.getOwnPropertyDescriptor;if(Si)try{Si({},"")}catch{Si=null}var zi=function(){throw new kt},Te=Si?function(){try{return arguments.callee,zi}catch{try{return Si(arguments,"callee").get}catch{return zi}}}():zi,yi=St(405)(),Fi=Object.getPrototypeOf||function(yr){return yr.__proto__},Je={},qt=typeof Uint8Array>"u"?_t:Fi(Uint8Array),nr={"%AggregateError%":typeof AggregateError>"u"?_t:AggregateError,"%Array%":Array,"%ArrayBuffer%":typeof ArrayBuffer>"u"?_t:ArrayBuffer,"%ArrayIteratorPrototype%":yi?Fi([][Symbol.iterator]()):_t,"%AsyncFromSyncIteratorPrototype%":_t,"%AsyncFunction%":Je,"%AsyncGenerator%":Je,"%AsyncGeneratorFunction%":Je,"%AsyncIteratorPrototype%":Je,"%Atomics%":typeof Atomics>"u"?_t:Atomics,"%BigInt%":typeof BigInt>"u"?_t:BigInt,"%Boolean%":Boolean,"%DataView%":typeof DataView>"u"?_t:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":Error,"%eval%":eval,"%EvalError%":EvalError,"%Float32Array%":typeof Float32Array>"u"?_t:Float32Array,"%Float64Array%":typeof Float64Array>"u"?_t:Float64Array,"%FinalizationRegistry%":typeof FinalizationRegistry>"u"?_t:FinalizationRegistry,"%Function%":ai,"%GeneratorFunction%":Je,"%Int8Array%":typeof Int8Array>"u"?_t:Int8Array,"%Int16Array%":typeof Int16Array>"u"?_t:Int16Array,"%Int32Array%":typeof Int32Array>"u"?_t:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":yi?Fi(Fi([][Symbol.iterator]())):_t,"%JSON%":typeof JSON=="object"?JSON:_t,"%Map%":typeof Map>"u"?_t:Map,"%MapIteratorPrototype%":typeof Map>"u"||!yi?_t:Fi(new Map()[Symbol.iterator]()),"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":typeof Promise>"u"?_t:Promise,"%Proxy%":typeof Proxy>"u"?_t:Proxy,"%RangeError%":RangeError,"%ReferenceError%":ReferenceError,"%Reflect%":typeof Reflect>"u"?_t:Reflect,"%RegExp%":RegExp,"%Set%":typeof Set>"u"?_t:Set,"%SetIteratorPrototype%":typeof Set>"u"||!yi?_t:Fi(new Set()[Symbol.iterator]()),"%SharedArrayBuffer%":typeof SharedArrayBuffer>"u"?_t:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":yi?Fi(""[Symbol.iterator]()):_t,"%Symbol%":yi?Symbol:_t,"%SyntaxError%":ni,"%ThrowTypeError%":Te,"%TypedArray%":qt,"%TypeError%":kt,"%Uint8Array%":typeof Uint8Array>"u"?_t:Uint8Array,"%Uint8ClampedArray%":typeof Uint8ClampedArray>"u"?_t:Uint8ClampedArray,"%Uint16Array%":typeof Uint16Array>"u"?_t:Uint16Array,"%Uint32Array%":typeof Uint32Array>"u"?_t:Uint32Array,"%URIError%":URIError,"%WeakMap%":typeof WeakMap>"u"?_t:WeakMap,"%WeakRef%":typeof WeakRef>"u"?_t:WeakRef,"%WeakSet%":typeof WeakSet>"u"?_t:WeakSet},gs=function yr(tr){var qr;if(tr==="%AsyncFunction%")qr=ui("async function () {}");else if(tr==="%GeneratorFunction%")qr=ui("function* () {}");else if(tr==="%AsyncGeneratorFunction%")qr=ui("async function* () {}");else if(tr==="%AsyncGenerator%"){var ar=yr("%AsyncGeneratorFunction%");ar&&(qr=ar.prototype)}else if(tr==="%AsyncIteratorPrototype%"){var Zr=yr("%AsyncGenerator%");Zr&&(qr=Fi(Zr.prototype))}return nr[tr]=qr,qr},ys={"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},Mr=St(612),Xi=St(642),jt=Mr.call(Function.call,Array.prototype.concat),ct=Mr.call(Function.apply,Array.prototype.splice),ut=Mr.call(Function.call,String.prototype.replace),bt=Mr.call(Function.call,String.prototype.slice),_i=Mr.call(Function.call,RegExp.prototype.exec),vi=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,Zi=/\\(\\)?/g,Pi=function(tr){var qr=bt(tr,0,1),ar=bt(tr,-1);if(qr==="%"&&ar!=="%")throw new ni("invalid intrinsic syntax, expected closing `%`");if(ar==="%"&&qr!=="%")throw new ni("invalid intrinsic syntax, expected opening `%`");var Zr=[];return ut(tr,vi,function(bs,Ni,Qr,Ys){Zr[Zr.length]=Qr?ut(Ys,Zi,"$1"):Ni||bs}),Zr},hs=function(tr,qr){var ar=tr,Zr;if(Xi(ys,ar)&&(Zr=ys[ar],ar="%"+Zr[0]+"%"),Xi(nr,ar)){var bs=nr[ar];if(bs===Je&&(bs=gs(ar)),typeof bs>"u"&&!qr)throw new kt("intrinsic "+tr+" exists, but is not available. Please file an issue!");return{alias:Zr,name:ar,value:bs}}throw new ni("intrinsic "+tr+" does not exist!")};Ai.exports=function(tr,qr){if(typeof tr!="string"||tr.length===0)throw new kt("intrinsic name must be a non-empty string");if(arguments.length>1&&typeof qr!="boolean")throw new kt('"allowMissing" argument must be a boolean');if(_i(/^%?[^%]*%?$/,tr)===null)throw new ni("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var ar=Pi(tr),Zr=ar.length>0?ar[0]:"",bs=hs("%"+Zr+"%",qr),Ni=bs.name,Qr=bs.value,Ys=!1,La=bs.alias;La&&(Zr=La[0],ct(ar,jt([0,1],La)));for(var co=1,ze=!0;co<ar.length;co+=1){var xt=ar[co],vt=bt(xt,0,1),Ri=bt(xt,-1);if((vt==='"'||vt==="'"||vt==="`"||Ri==='"'||Ri==="'"||Ri==="`")&&vt!==Ri)throw new ni("property names with quotes must have matching quotes");if((xt==="constructor"||!ze)&&(Ys=!0),Zr+="."+xt,Ni="%"+Zr+"%",Xi(nr,Ni))Qr=nr[Ni];else if(Qr!=null){if(!(xt in Qr)){if(!qr)throw new kt("base intrinsic for "+tr+" exists, but the property is not available.");return}if(Si&&co+1>=ar.length){var Wi=Si(Qr,xt);ze=!!Wi,ze&&"get"in Wi&&!("originalValue"in Wi.get)?Qr=Wi.get:Qr=Qr[xt]}else ze=Xi(Qr,xt),Qr=Qr[xt];ze&&!Ys&&(nr[Ni]=Qr)}}return Qr}},296:function(Ai,ft,St){"use strict";var _t=St(210),ni=_t("%Object.getOwnPropertyDescriptor%",!0);if(ni)try{ni([],"length")}catch{ni=null}Ai.exports=ni},405:function(Ai,ft,St){"use strict";var _t=typeof Symbol<"u"&&Symbol,ni=St(419);Ai.exports=function(){return typeof _t!="function"||typeof Symbol!="function"||typeof _t("foo")!="symbol"||typeof Symbol("bar")!="symbol"?!1:ni()}},419:function(Ai){"use strict";Ai.exports=function(){if(typeof Symbol!="function"||typeof Object.getOwnPropertySymbols!="function")return!1;if(typeof Symbol.iterator=="symbol")return!0;var St={},_t=Symbol("test"),ni=Object(_t);if(typeof _t=="string"||Object.prototype.toString.call(_t)!=="[object Symbol]"||Object.prototype.toString.call(ni)!=="[object Symbol]")return!1;var ai=42;St[_t]=ai;for(_t in St)return!1;if(typeof Object.keys=="function"&&Object.keys(St).length!==0||typeof Object.getOwnPropertyNames=="function"&&Object.getOwnPropertyNames(St).length!==0)return!1;var kt=Object.getOwnPropertySymbols(St);if(kt.length!==1||kt[0]!==_t||!Object.prototype.propertyIsEnumerable.call(St,_t))return!1;if(typeof Object.getOwnPropertyDescriptor=="function"){var ui=Object.getOwnPropertyDescriptor(St,_t);if(ui.value!==ai||ui.enumerable!==!0)return!1}return!0}},410:function(Ai,ft,St){"use strict";var _t=St(419);Ai.exports=function(){return _t()&&!!Symbol.toStringTag}},642:function(Ai,ft,St){"use strict";var _t=St(612);Ai.exports=_t.call(Function.call,Object.prototype.hasOwnProperty)},717:function(Ai){typeof Object.create=="function"?Ai.exports=function(St,_t){_t&&(St.super_=_t,St.prototype=Object.create(_t.prototype,{constructor:{value:St,enumerable:!1,writable:!0,configurable:!0}}))}:Ai.exports=function(St,_t){if(_t){St.super_=_t;var ni=function(){};ni.prototype=_t.prototype,St.prototype=new ni,St.prototype.constructor=St}}},584:function(Ai,ft,St){"use strict";var _t=St(410)(),ni=St(924),ai=ni("Object.prototype.toString"),kt=function(Te){return _t&&Te&&typeof Te=="object"&&Symbol.toStringTag in Te?!1:ai(Te)==="[object Arguments]"},ui=function(Te){return kt(Te)?!0:Te!==null&&typeof Te=="object"&&typeof Te.length=="number"&&Te.length>=0&&ai(Te)!=="[object Array]"&&ai(Te.callee)==="[object Function]"},Si=function(){return kt(arguments)}();kt.isLegacyArguments=ui,Ai.exports=Si?kt:ui},320:function(Ai){"use strict";var ft=Function.prototype.toString,St=typeof Reflect=="object"&&Reflect!==null&&Reflect.apply,_t,ni;if(typeof St=="function"&&typeof Object.defineProperty=="function")try{_t=Object.defineProperty({},"length",{get:function(){throw ni}}),ni={},St(function(){throw 42},null,_t)}catch(Xi){Xi!==ni&&(St=null)}else St=null;var ai=/^\s*class\b/,kt=function(jt){try{var ct=ft.call(jt);return ai.test(ct)}catch{return!1}},ui=function(jt){try{return kt(jt)?!1:(ft.call(jt),!0)}catch{return!1}},Si=Object.prototype.toString,zi="[object Object]",Te="[object Function]",yi="[object GeneratorFunction]",Fi="[object HTMLAllCollection]",Je="[object HTML document.all class]",qt="[object HTMLCollection]",nr=typeof Symbol=="function"&&!!Symbol.toStringTag,gs=!(0 in[,]),ys=function(){return!1};if(typeof document=="object"){var Mr=document.all;Si.call(Mr)===Si.call(document.all)&&(ys=function(jt){if((gs||!jt)&&(typeof jt>"u"||typeof jt=="object"))try{var ct=Si.call(jt);return(ct===Fi||ct===Je||ct===qt||ct===zi)&&jt("")==null}catch{}return!1})}Ai.exports=St?function(jt){if(ys(jt))return!0;if(!jt||typeof jt!="function"&&typeof jt!="object")return!1;try{St(jt,null,_t)}catch(ct){if(ct!==ni)return!1}return!kt(jt)&&ui(jt)}:function(jt){if(ys(jt))return!0;if(!jt||typeof jt!="function"&&typeof jt!="object")return!1;if(nr)return ui(jt);if(kt(jt))return!1;var ct=Si.call(jt);return ct!==Te&&ct!==yi&&!/^\[object HTML/.test(ct)?!1:ui(jt)}},662:function(Ai,ft,St){"use strict";var _t=Object.prototype.toString,ni=Function.prototype.toString,ai=/^\s*(?:function)?\*/,kt=St(410)(),ui=Object.getPrototypeOf,Si=function(){if(!kt)return!1;try{return Function("return function*() {}")()}catch{}},zi;Ai.exports=function(yi){if(typeof yi!="function")return!1;if(ai.test(ni.call(yi)))return!0;if(!kt){var Fi=_t.call(yi);return Fi==="[object GeneratorFunction]"}if(!ui)return!1;if(typeof zi>"u"){var Je=Si();zi=Je?ui(Je):!1}return ui(yi)===zi}},692:function(Ai,ft,St){"use strict";var _t=St(430);Ai.exports=function(ai){return!!_t(ai)}},300:function(Ai,ft,St){"use strict";var _t=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof St.g<"u")return St.g;throw new Error("unable to locate global object")},ni=_t();Ai.exports=ft=ni.fetch,ni.fetch&&(ft.default=ni.fetch.bind(ni)),ft.Headers=ni.Headers,ft.Request=ni.Request,ft.Response=ni.Response},384:function(Ai){Ai.exports=function(St){return St&&typeof St=="object"&&typeof St.copy=="function"&&typeof St.fill=="function"&&typeof St.readUInt8=="function"}},955:function(Ai,ft,St){"use strict";var _t=St(584),ni=St(662),ai=St(430),kt=St(692);function ui(gt){return gt.call.bind(gt)}var Si=typeof BigInt<"u",zi=typeof Symbol<"u",Te=ui(Object.prototype.toString),yi=ui(Number.prototype.valueOf),Fi=ui(String.prototype.valueOf),Je=ui(Boolean.prototype.valueOf);if(Si)var qt=ui(BigInt.prototype.valueOf);if(zi)var nr=ui(Symbol.prototype.valueOf);function gs(gt,Yx){if(typeof gt!="object")return!1;try{return Yx(gt),!0}catch{return!1}}ft.isArgumentsObject=_t,ft.isGeneratorFunction=ni,ft.isTypedArray=kt;function ys(gt){return typeof Promise<"u"&&gt instanceof Promise||gt!==null&&typeof gt=="object"&&typeof gt.then=="function"&&typeof gt.catch=="function"}ft.isPromise=ys;function Mr(gt){return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(gt):kt(gt)||xt(gt)}ft.isArrayBufferView=Mr;function Xi(gt){return ai(gt)==="Uint8Array"}ft.isUint8Array=Xi;function jt(gt){return ai(gt)==="Uint8ClampedArray"}ft.isUint8ClampedArray=jt;function ct(gt){return ai(gt)==="Uint16Array"}ft.isUint16Array=ct;function ut(gt){return ai(gt)==="Uint32Array"}ft.isUint32Array=ut;function bt(gt){return ai(gt)==="Int8Array"}ft.isInt8Array=bt;function _i(gt){return ai(gt)==="Int16Array"}ft.isInt16Array=_i;function vi(gt){return ai(gt)==="Int32Array"}ft.isInt32Array=vi;function Zi(gt){return ai(gt)==="Float32Array"}ft.isFloat32Array=Zi;function Pi(gt){return ai(gt)==="Float64Array"}ft.isFloat64Array=Pi;function hs(gt){return ai(gt)==="BigInt64Array"}ft.isBigInt64Array=hs;function yr(gt){return ai(gt)==="BigUint64Array"}ft.isBigUint64Array=yr;function tr(gt){return Te(gt)==="[object Map]"}tr.working=typeof Map<"u"&&tr(new Map);function qr(gt){return typeof Map>"u"?!1:tr.working?tr(gt):gt instanceof Map}ft.isMap=qr;function ar(gt){return Te(gt)==="[object Set]"}ar.working=typeof Set<"u"&&ar(new Set);function Zr(gt){return typeof Set>"u"?!1:ar.working?ar(gt):gt instanceof Set}ft.isSet=Zr;function bs(gt){return Te(gt)==="[object WeakMap]"}bs.working=typeof WeakMap<"u"&&bs(new WeakMap);function Ni(gt){return typeof WeakMap>"u"?!1:bs.working?bs(gt):gt instanceof WeakMap}ft.isWeakMap=Ni;function Qr(gt){return Te(gt)==="[object WeakSet]"}Qr.working=typeof WeakSet<"u"&&Qr(new WeakSet);function Ys(gt){return Qr(gt)}ft.isWeakSet=Ys;function La(gt){return Te(gt)==="[object ArrayBuffer]"}La.working=typeof ArrayBuffer<"u"&&La(new ArrayBuffer);function co(gt){return typeof ArrayBuffer>"u"?!1:La.working?La(gt):gt instanceof ArrayBuffer}ft.isArrayBuffer=co;function ze(gt){return Te(gt)==="[object DataView]"}ze.working=typeof ArrayBuffer<"u"&&typeof DataView<"u"&&ze(new DataView(new ArrayBuffer(1),0,1));function xt(gt){return typeof DataView>"u"?!1:ze.working?ze(gt):gt instanceof DataView}ft.isDataView=xt;var vt=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:void 0;function Ri(gt){return Te(gt)==="[object SharedArrayBuffer]"}function Wi(gt){return typeof vt>"u"?!1:(typeof Ri.working>"u"&&(Ri.working=Ri(new vt)),Ri.working?Ri(gt):gt instanceof vt)}ft.isSharedArrayBuffer=Wi;function br(gt){return Te(gt)==="[object AsyncFunction]"}ft.isAsyncFunction=br;function Yi(gt){return Te(gt)==="[object Map Iterator]"}ft.isMapIterator=Yi;function hr(gt){return Te(gt)==="[object Set Iterator]"}ft.isSetIterator=hr;function Er(gt){return Te(gt)==="[object Generator]"}ft.isGeneratorObject=Er;function gn(gt){return Te(gt)==="[object WebAssembly.Module]"}ft.isWebAssemblyCompiledModule=gn;function Ue(gt){return gs(gt,yi)}ft.isNumberObject=Ue;function Xx(gt){return gs(gt,Fi)}ft.isStringObject=Xx;function q0(gt){return gs(gt,Je)}ft.isBooleanObject=q0;function Z0(gt){return Si&&gs(gt,qt)}ft.isBigIntObject=Z0;function eh(gt){return zi&&gs(gt,nr)}ft.isSymbolObject=eh;function af(gt){return Ue(gt)||Xx(gt)||q0(gt)||Z0(gt)||eh(gt)}ft.isBoxedPrimitive=af;function th(gt){return typeof Uint8Array<"u"&&(co(gt)||Wi(gt))}ft.isAnyArrayBuffer=th,["isProxy","isExternal","isModuleNamespaceObject"].forEach(function(gt){Object.defineProperty(ft,gt,{enumerable:!1,value:function(){throw new Error(gt+" is not supported in userland")}})})},539:function(Ai,ft,St){var _t=Object.getOwnPropertyDescriptors||function(xt){for(var vt=Object.keys(xt),Ri={},Wi=0;Wi<vt.length;Wi++)Ri[vt[Wi]]=Object.getOwnPropertyDescriptor(xt,vt[Wi]);return Ri},ni=/%[sdj%]/g;ft.format=function(ze){if(!bt(ze)){for(var xt=[],vt=0;vt<arguments.length;vt++)xt.push(Si(arguments[vt]));return xt.join(" ")}for(var vt=1,Ri=arguments,Wi=Ri.length,br=String(ze).replace(ni,function(hr){if(hr==="%%")return"%";if(vt>=Wi)return hr;switch(hr){case"%s":return String(Ri[vt++]);case"%d":return Number(Ri[vt++]);case"%j":try{return JSON.stringify(Ri[vt++])}catch{return"[Circular]"}default:return hr}}),Yi=Ri[vt];vt<Wi;Yi=Ri[++vt])jt(Yi)||!Pi(Yi)?br+=" "+Yi:br+=" "+Si(Yi);return br},ft.deprecate=function(ze,xt){if(typeof process<"u"&&process.noDeprecation===!0)return ze;if(typeof process>"u")return function(){return ft.deprecate(ze,xt).apply(this,arguments)};var vt=!1;function Ri(){if(!vt){if(process.throwDeprecation)throw new Error(xt);process.traceDeprecation?console.trace(xt):console.error(xt),vt=!0}return ze.apply(this,arguments)}return Ri};var ai={},kt=/^$/;if(process.env.NODE_DEBUG){var ui=process.env.NODE_DEBUG;ui=ui.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".*").replace(/,/g,"$|^").toUpperCase(),kt=new RegExp("^"+ui+"$","i")}ft.debuglog=function(ze){if(ze=ze.toUpperCase(),!ai[ze])if(kt.test(ze)){var xt=process.pid;ai[ze]=function(){var vt=ft.format.apply(ft,arguments);console.error("%s %d: %s",ze,xt,vt)}}else ai[ze]=function(){};return ai[ze]};function Si(ze,xt){var vt={seen:[],stylize:Te};return arguments.length>=3&&(vt.depth=arguments[2]),arguments.length>=4&&(vt.colors=arguments[3]),Xi(xt)?vt.showHidden=xt:xt&&ft._extend(vt,xt),vi(vt.showHidden)&&(vt.showHidden=!1),vi(vt.depth)&&(vt.depth=2),vi(vt.colors)&&(vt.colors=!1),vi(vt.customInspect)&&(vt.customInspect=!0),vt.colors&&(vt.stylize=zi),Fi(vt,ze,vt.depth)}ft.inspect=Si,Si.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},Si.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};function zi(ze,xt){var vt=Si.styles[xt];return vt?"\x1B["+Si.colors[vt][0]+"m"+ze+"\x1B["+Si.colors[vt][1]+"m":ze}function Te(ze,xt){return ze}function yi(ze){var xt={};return ze.forEach(function(vt,Ri){xt[vt]=!0}),xt}function Fi(ze,xt,vt){if(ze.customInspect&&xt&&tr(xt.inspect)&&xt.inspect!==ft.inspect&&!(xt.constructor&&xt.constructor.prototype===xt)){var Ri=xt.inspect(vt,ze);return bt(Ri)||(Ri=Fi(ze,Ri,vt)),Ri}var Wi=Je(ze,xt);if(Wi)return Wi;var br=Object.keys(xt),Yi=yi(br);if(ze.showHidden&&(br=Object.getOwnPropertyNames(xt)),yr(xt)&&(br.indexOf("message")>=0||br.indexOf("description")>=0))return qt(xt);if(br.length===0){if(tr(xt)){var hr=xt.name?": "+xt.name:"";return ze.stylize("[Function"+hr+"]","special")}if(Zi(xt))return ze.stylize(RegExp.prototype.toString.call(xt),"regexp");if(hs(xt))return ze.stylize(Date.prototype.toString.call(xt),"date");if(yr(xt))return qt(xt)}var Er="",gn=!1,Ue=["{","}"];if(Mr(xt)&&(gn=!0,Ue=["[","]"]),tr(xt)){var Xx=xt.name?": "+xt.name:"";Er=" [Function"+Xx+"]"}if(Zi(xt)&&(Er=" "+RegExp.prototype.toString.call(xt)),hs(xt)&&(Er=" "+Date.prototype.toUTCString.call(xt)),yr(xt)&&(Er=" "+qt(xt)),br.length===0&&(!gn||xt.length==0))return Ue[0]+Er+Ue[1];if(vt<0)return Zi(xt)?ze.stylize(RegExp.prototype.toString.call(xt),"regexp"):ze.stylize("[Object]","special");ze.seen.push(xt);var q0;return gn?q0=nr(ze,xt,vt,Yi,br):q0=br.map(function(Z0){return gs(ze,xt,vt,Yi,Z0,gn)}),ze.seen.pop(),ys(q0,Er,Ue)}function Je(ze,xt){if(vi(xt))return ze.stylize("undefined","undefined");if(bt(xt)){var vt="'"+JSON.stringify(xt).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ze.stylize(vt,"string")}if(ut(xt))return ze.stylize(""+xt,"number");if(Xi(xt))return ze.stylize(""+xt,"boolean");if(jt(xt))return ze.stylize("null","null")}function qt(ze){return"["+Error.prototype.toString.call(ze)+"]"}function nr(ze,xt,vt,Ri,Wi){for(var br=[],Yi=0,hr=xt.length;Yi<hr;++Yi)Qr(xt,String(Yi))?br.push(gs(ze,xt,vt,Ri,String(Yi),!0)):br.push("");return Wi.forEach(function(Er){Er.match(/^\d+$/)||br.push(gs(ze,xt,vt,Ri,Er,!0))}),br}function gs(ze,xt,vt,Ri,Wi,br){var Yi,hr,Er;if(Er=Object.getOwnPropertyDescriptor(xt,Wi)||{value:xt[Wi]},Er.get?Er.set?hr=ze.stylize("[Getter/Setter]","special"):hr=ze.stylize("[Getter]","special"):Er.set&&(hr=ze.stylize("[Setter]","special")),Qr(Ri,Wi)||(Yi="["+Wi+"]"),hr||(ze.seen.indexOf(Er.value)<0?(jt(vt)?hr=Fi(ze,Er.value,null):hr=Fi(ze,Er.value,vt-1),hr.indexOf(`
`)>-1&&(br?hr=hr.split(`
`).map(function(gn){return"  "+gn}).join(`
`).slice(2):hr=`
`+hr.split(`
`).map(function(gn){return"   "+gn}).join(`
`))):hr=ze.stylize("[Circular]","special")),vi(Yi)){if(br&&Wi.match(/^\d+$/))return hr;Yi=JSON.stringify(""+Wi),Yi.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(Yi=Yi.slice(1,-1),Yi=ze.stylize(Yi,"name")):(Yi=Yi.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),Yi=ze.stylize(Yi,"string"))}return Yi+": "+hr}function ys(ze,xt,vt){var Ri=0,Wi=ze.reduce(function(br,Yi){return Ri++,Yi.indexOf(`
`)>=0&&Ri++,br+Yi.replace(/\u001b\[\d\d?m/g,"").length+1},0);return Wi>60?vt[0]+(xt===""?"":xt+`
 `)+" "+ze.join(`,
  `)+" "+vt[1]:vt[0]+xt+" "+ze.join(", ")+" "+vt[1]}ft.types=St(955);function Mr(ze){return Array.isArray(ze)}ft.isArray=Mr;function Xi(ze){return typeof ze=="boolean"}ft.isBoolean=Xi;function jt(ze){return ze===null}ft.isNull=jt;function ct(ze){return ze==null}ft.isNullOrUndefined=ct;function ut(ze){return typeof ze=="number"}ft.isNumber=ut;function bt(ze){return typeof ze=="string"}ft.isString=bt;function _i(ze){return typeof ze=="symbol"}ft.isSymbol=_i;function vi(ze){return ze===void 0}ft.isUndefined=vi;function Zi(ze){return Pi(ze)&&ar(ze)==="[object RegExp]"}ft.isRegExp=Zi,ft.types.isRegExp=Zi;function Pi(ze){return typeof ze=="object"&&ze!==null}ft.isObject=Pi;function hs(ze){return Pi(ze)&&ar(ze)==="[object Date]"}ft.isDate=hs,ft.types.isDate=hs;function yr(ze){return Pi(ze)&&(ar(ze)==="[object Error]"||ze instanceof Error)}ft.isError=yr,ft.types.isNativeError=yr;function tr(ze){return typeof ze=="function"}ft.isFunction=tr;function qr(ze){return ze===null||typeof ze=="boolean"||typeof ze=="number"||typeof ze=="string"||typeof ze=="symbol"||typeof ze>"u"}ft.isPrimitive=qr,ft.isBuffer=St(384);function ar(ze){return Object.prototype.toString.call(ze)}function Zr(ze){return ze<10?"0"+ze.toString(10):ze.toString(10)}var bs=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function Ni(){var ze=new Date,xt=[Zr(ze.getHours()),Zr(ze.getMinutes()),Zr(ze.getSeconds())].join(":");return[ze.getDate(),bs[ze.getMonth()],xt].join(" ")}ft.log=function(){console.log("%s - %s",Ni(),ft.format.apply(ft,arguments))},ft.inherits=St(717),ft._extend=function(ze,xt){if(!xt||!Pi(xt))return ze;for(var vt=Object.keys(xt),Ri=vt.length;Ri--;)ze[vt[Ri]]=xt[vt[Ri]];return ze};function Qr(ze,xt){return Object.prototype.hasOwnProperty.call(ze,xt)}var Ys=typeof Symbol<"u"?Symbol("util.promisify.custom"):void 0;ft.promisify=function(xt){if(typeof xt!="function")throw new TypeError('The "original" argument must be of type Function');if(Ys&&xt[Ys]){var vt=xt[Ys];if(typeof vt!="function")throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(vt,Ys,{value:vt,enumerable:!1,writable:!1,configurable:!0}),vt}function vt(){for(var Ri,Wi,br=new Promise(function(Er,gn){Ri=Er,Wi=gn}),Yi=[],hr=0;hr<arguments.length;hr++)Yi.push(arguments[hr]);Yi.push(function(Er,gn){Er?Wi(Er):Ri(gn)});try{xt.apply(this,Yi)}catch(Er){Wi(Er)}return br}return Object.setPrototypeOf(vt,Object.getPrototypeOf(xt)),Ys&&Object.defineProperty(vt,Ys,{value:vt,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(vt,_t(xt))},ft.promisify.custom=Ys;function La(ze,xt){if(!ze){var vt=new Error("Promise was rejected with a falsy value");vt.reason=ze,ze=vt}return xt(ze)}function co(ze){if(typeof ze!="function")throw new TypeError('The "original" argument must be of type Function');function xt(){for(var vt=[],Ri=0;Ri<arguments.length;Ri++)vt.push(arguments[Ri]);var Wi=vt.pop();if(typeof Wi!="function")throw new TypeError("The last argument must be of type Function");var br=this,Yi=function(){return Wi.apply(br,arguments)};ze.apply(this,vt).then(function(hr){process.nextTick(Yi.bind(null,null,hr))},function(hr){process.nextTick(La.bind(null,hr,Yi))})}return Object.setPrototypeOf(xt,Object.getPrototypeOf(ze)),Object.defineProperties(xt,_t(ze)),xt}ft.callbackify=co},430:function(Ai,ft,St){"use strict";var _t=St(29),ni=St(83),ai=St(559),kt=St(924),ui=St(296),Si=kt("Object.prototype.toString"),zi=St(410)(),Te=typeof globalThis>"u"?St.g:globalThis,yi=ni(),Fi=kt("String.prototype.slice"),Je=Object.getPrototypeOf,qt=kt("Array.prototype.indexOf",!0)||function(Xi,jt){for(var ct=0;ct<Xi.length;ct+=1)if(Xi[ct]===jt)return ct;return-1},nr={__proto__:null};zi&&ui&&Je?_t(yi,function(Mr){var Xi=new Te[Mr];if(Symbol.toStringTag in Xi){var jt=Je(Xi),ct=ui(jt,Symbol.toStringTag);if(!ct){var ut=Je(jt);ct=ui(ut,Symbol.toStringTag)}nr["$"+Mr]=ai(ct.get)}}):_t(yi,function(Mr){var Xi=new Te[Mr];nr["$"+Mr]=ai(Xi.slice)});var gs=function(Xi){var jt=!1;return _t(nr,function(ct,ut){if(!jt)try{"$"+ct(Xi)===ut&&(jt=Fi(ut,1))}catch{}}),jt},ys=function(Xi){var jt=!1;return _t(nr,function(ct,ut){if(!jt)try{ct(Xi),jt=Fi(ut,1)}catch{}}),jt};Ai.exports=function(Xi){if(!Xi||typeof Xi!="object")return!1;if(!zi){var jt=Fi(Si(Xi),8,-1);return qt(yi,jt)>-1?jt:jt!=="Object"?!1:ys(Xi)}return ui?gs(Xi):null}},653:function(){},83:function(Ai,ft,St){"use strict";var _t=["BigInt64Array","BigUint64Array","Float32Array","Float64Array","Int16Array","Int32Array","Int8Array","Uint16Array","Uint32Array","Uint8Array","Uint8ClampedArray"],ni=typeof globalThis>"u"?St.g:globalThis;Ai.exports=function(){for(var kt=[],ui=0;ui<_t.length;ui++)typeof ni[_t[ui]]=="function"&&(kt[kt.length]=_t[ui]);return kt}}},Hg={};function fa(Ai){var ft=Hg[Ai];if(ft!==void 0)return ft.exports;var St=Hg[Ai]={exports:{}};return CM[Ai](St,St.exports,fa),St.exports}(function(){fa.g=function(){if(typeof globalThis=="object")return globalThis;try{return this||new Function("return this")()}catch{if(typeof window=="object")return window}}()})();var uX={};(function(){"use strict";function Ai(l,e){return e.forEach(function(i){i&&typeof i!="string"&&!Array.isArray(i)&&Object.keys(i).forEach(function(s){if(s!=="default"&&!(s in l)){var n=Object.getOwnPropertyDescriptor(i,s);Object.defineProperty(l,s,n.get?n:{enumerable:!0,get:function(){return i[s]}})}})}),Object.freeze(l)}const ft=1e-7,St=1e-4;class _t{constructor(e,i){this.backend=e,this.dataMover=i,this.data=new WeakMap,this.dataIdsCount=0}get(e){return this.data.has(e)||this.dataMover.moveData(this.backend,e),this.data.get(e)}set(e,i){this.dataIdsCount++,this.data.set(e,i)}has(e){return this.data.has(e)}delete(e){return this.dataIdsCount--,this.data.delete(e)}numDataIds(){return this.dataIdsCount}}class ni{refCount(e){return ai("refCount")}incRef(e){return ai("incRef")}timerAvailable(){return!0}time(e){return ai("time")}read(e){return ai("read")}readSync(e){return ai("readSync")}readToGPU(e,i){return ai("readToGPU")}numDataIds(){return ai("numDataIds")}disposeData(e,i){return ai("disposeData")}write(e,i,s){return ai("write")}move(e,i,s,n,a){return ai("move")}createTensorFromGPUData(e,i,s){return ai("createTensorFromGPUData")}memory(){return ai("memory")}floatPrecision(){return ai("floatPrecision")}epsilon(){return this.floatPrecision()===32?ft:St}dispose(){return ai("dispose")}}function ai(l){throw new Error("'"+l+"' not yet implemented or not found in the registry. This kernel may not be supported by the tfjs backend you have chosen")}function kt(l,e,i){return Math.max(l,Math.min(e,i))}function ui(l){return l%2===0?l:l+1}function Si(l,e,i){const s=l[e];l[e]=l[i],l[i]=s}function zi(l){let e=0;for(let i=0;i<l.length;i++)e+=l[i];return e}function Te(l,e){if(!l)throw new Error(typeof e=="string"?e:e())}function yi(l,e,i=""){Te(qt(l,e),()=>i+(" Shapes "+l+" and "+e+" must match"))}function Fi(l){Te(l!=null,()=>"The input to the tensor constructor must be a non-null value.")}function Je(l){if(l.length===0)return 1;let e=l[0];for(let i=1;i<l.length;i++)e*=l[i];return e}function qt(l,e){if(l===e)return!0;if(l==null||e==null||l.length!==e.length)return!1;for(let i=0;i<l.length;i++)if(l[i]!==e[i])return!1;return!0}function nr(l){return l%1===0}function gs(l){const e=Math.ceil(Math.sqrt(l));return[e,Math.ceil(l/e)]}function ys(l,e){return e<=l.length?l:l+" ".repeat(e-l.length)}function Mr(l,e=n=>0,i,s){return new Promise((n,a)=>{let p=0;const _=()=>{if(l()){n();return}p++;const g=e(p);if(i!=null&&p>=i){a();return}s!=null?s(_,g):setTimeout(_,g)};_()})}function Xi(l,e){let i=1,s=-1;for(let a=0;a<l.length;++a)if(l[a]>=0)i*=l[a];else if(l[a]===-1){if(s!==-1)throw Error("Shapes can only have 1 implicit size. Found -1 at dim "+s+" and dim "+a);s=a}else if(l[a]<0)throw Error("Shapes can not be < 0. Found "+l[a]+" at dim "+a);if(s===-1){if(e>0&&e!==i)throw Error("Size("+e+") must match the product of shape "+l);return l}if(i===0)throw Error("Cannot infer the missing size in ["+l+"] when there are 0 elements");if(e%i!==0)throw Error("The implicit shape can't be a fractional number. Got "+e+" / "+i);const n=l.slice();return n[s]=e/i,n}function jt(l,e){const i=e.length;return l=l==null?e.map((s,n)=>n):[].concat(l),Te(l.every(s=>s>=-i&&s<i),()=>"All values in axis param must be in range [-"+i+", "+i+") but got axis "+l),Te(l.every(s=>nr(s)),()=>"All values in axis param must be integers but got axis "+l),l.map(s=>s<0?i+s:s)}function ct(l,e){const i=[],s=[],n=e!=null&&Array.isArray(e)&&e.length===0,a=e==null||n?null:jt(e,l).sort();let p=0;for(let _=0;_<l.length;++_){if(a!=null){if(a[p]===_&&l[_]!==1)throw new Error("Can't squeeze axis "+_+" since its dim '"+l[_]+"' is not 1");(a[p]==null||a[p]>_)&&l[_]===1&&(i.push(l[_]),s.push(_)),a[p]<=_&&p++}l[_]!==1&&(i.push(l[_]),s.push(_))}return{newShape:i,keptDims:s}}function ut(l,e){return bt(l,e)}function bt(l,e){let i=null;if(l==null||l==="float32")i=new Float32Array(e);else if(l==="int32")i=new Int32Array(e);else if(l==="bool")i=new Uint8Array(e);else if(l==="string")i=new Array(e);else throw new Error("Unknown data type "+l);return i}function _i(l,e){for(let i=0;i<l.length;i++){const s=l[i];if(isNaN(s)||!isFinite(s))throw Error("A tensor of type "+e+" being uploaded contains "+s+".")}}function vi(l){return l==="bool"||l==="complex64"||l==="float32"||l==="int32"||l==="string"}function Zi(l,e){return!(e==="complex64"||e==="float32"&&l!=="complex64"||e==="int32"&&l!=="float32"&&l!=="complex64"||e==="bool"&&l==="bool")}function Pi(l){if(l==="float32"||l==="int32")return 4;if(l==="complex64")return 8;if(l==="bool")return 1;throw new Error("Unknown dtype "+l)}function hs(l){if(l==null)return 0;let e=0;return l.forEach(i=>e+=i.length),e}function yr(l){return typeof l=="string"||l instanceof String}function tr(l){return typeof l=="boolean"}function qr(l){return typeof l=="number"}function ar(l){return Array.isArray(l)?ar(l[0]):l instanceof Float32Array?"float32":l instanceof Int32Array||l instanceof Uint8Array||l instanceof Uint8ClampedArray?"int32":qr(l)?"float32":yr(l)?"string":tr(l)?"bool":"float32"}function Zr(l){return!!(l&&l.constructor&&l.call&&l.apply)}function bs(l,e){for(let i=e;i<l;++i)if(l%i===0)return i;return l}function Ni(l){const e=l.length;if(e<2)return[];const i=new Array(e-1);i[e-2]=l[e-1];for(let s=e-3;s>=0;--s)i[s]=i[s+1]*l[s+1];return i}function Qr(l,e,i,s=!1){const n=new Array;if(e.length===1){const a=e[0]*(s?2:1);for(let p=0;p<a;p++)n[p]=i[l+p]}else{const a=e[0],p=e.slice(1),_=p.reduce((g,y)=>g*y)*(s?2:1);for(let g=0;g<a;g++)n[g]=Qr(l+g*_,p,i,s)}return n}function Ys(l,e,i=!1){if(l.length===0)return e[0];const s=l.reduce((n,a)=>n*a)*(i?2:1);if(s===0)return[];if(s!==e.length)throw new Error("["+l+"] does not match the input size "+e.length+(i?" for a complex tensor":"")+".");return Qr(0,l,e,i)}function La(l,e){if(Array.isArray(l))return l;if(e==="float32")return l instanceof Float32Array?l:new Float32Array(l);if(e==="int32")return l instanceof Int32Array?l:new Int32Array(l);if(e==="bool"||e==="string")return Uint8Array.from(new Int32Array(l));throw new Error("Unknown dtype "+e)}function co(l,e){const i=ze(l,e);for(let s=0;s<i.length;s++)i[s]=1;return i}function ze(l,e){if(e==null||e==="float32"||e==="complex64")return new Float32Array(l);if(e==="int32")return new Int32Array(l);if(e==="bool")return new Uint8Array(l);throw new Error("Unknown data type "+e)}function xt(l){l.forEach(e=>{Te(Number.isInteger(e)&&e>=0,()=>"Tensor must have a shape comprised of positive integers but got shape ["+l+"].")})}function vt(l,e,i){if(e===0)return 0;if(e===1)return l[0];let s=l[l.length-1];for(let n=0;n<l.length-1;++n)s+=i[n]*l[n];return s}function Ri(l,e,i){if(e===0)return[];if(e===1)return[l];const s=new Array(e);for(let n=0;n<s.length-1;++n)s[n]=Math.floor(l/i[n]),l-=s[n]*i[n];return s[s.length-1]=l,s}function Wi(l){return l&&l.then&&typeof l.then=="function"}const br="tfjsflags";class Yi{constructor(e){this.global=e,this.flags={},this.flagRegistry={},this.urlFlags={},this.getQueryParams=hr,this.populateURLFlags()}setPlatform(e,i){this.platform!=null&&(Ue().getBool("IS_TEST")||Ue().getBool("PROD")||console.warn("Platform "+this.platformName+" has already been set. Overwriting the platform with "+e+".")),this.platformName=e,this.platform=i}registerFlag(e,i,s){if(this.flagRegistry[e]={evaluationFn:i,setHook:s},this.urlFlags[e]!=null){const n=this.urlFlags[e];Ue().getBool("IS_TEST")||Ue().getBool("PROD")||console.warn("Setting feature override from URL "+e+": "+n+"."),this.set(e,n)}}async getAsync(e){return e in this.flags?this.flags[e]:(this.flags[e]=await this.evaluateFlag(e),this.flags[e])}get(e){if(e in this.flags)return this.flags[e];const i=this.evaluateFlag(e);if(Wi(i))throw new Error("Flag "+e+" cannot be synchronously evaluated. Please use getAsync() instead.");return this.flags[e]=i,this.flags[e]}getNumber(e){return this.get(e)}getBool(e){return this.get(e)}getString(e){return this.get(e)}getFlags(){return this.flags}get features(){return this.flags}set(e,i){if(this.flagRegistry[e]==null)throw new Error("Cannot set flag "+e+" as it has not been registered.");this.flags[e]=i,this.flagRegistry[e].setHook!=null&&this.flagRegistry[e].setHook(i)}evaluateFlag(e){if(this.flagRegistry[e]==null)throw new Error("Cannot evaluate flag '"+e+"': no evaluation function found.");return this.flagRegistry[e].evaluationFn()}setFlags(e){this.flags=Object.assign({},e)}reset(){this.flags={},this.urlFlags={},this.populateURLFlags()}populateURLFlags(){if(typeof this.global>"u"||typeof this.global.location>"u"||typeof this.global.location.search>"u")return;const e=this.getQueryParams(this.global.location.search);br in e&&e[br].split(",").forEach(i=>{const[s,n]=i.split(":");this.urlFlags[s]=gn(s,n)})}}function hr(l){const e={};return l.replace(/[?&]([^=?&]+)(?:=([^&]*))?/g,(i,...s)=>(Er(e,s[0],s[1]),s.join("="))),e}function Er(l,e,i){l[decodeURIComponent(e)]=decodeURIComponent(i||"")}function gn(l,e){const i=e.toLowerCase();return i==="true"||i==="false"?i==="true":""+ +i===i?+i:e}function Ue(){return Xx}let Xx=null;function q0(l){Xx=l}let Z0;function eh(){if(Z0==null){let l;if(typeof window<"u")l=window;else if(typeof fa.g<"u")l=fa.g;else if(typeof process<"u")l=process;else if(typeof self<"u")l=self;else throw new Error("Could not find a global object");Z0=l}return Z0}function af(){const l=eh();return l._tfGlobals==null&&(l._tfGlobals=new Map),l._tfGlobals}function th(l,e){const i=af();if(i.has(l))return i.get(l);{const s=e();return i.set(l,s),i.get(l)}}const gt="Abs",Yx="Add",Xu="AddN",Yu="Atan2",of="AvgPool",xf="BatchMatMul",RM="BatchToSpaceND",IM="Bincount",Ku="Cast",ju="ClipByValue",SM="Complex",MM="ComplexAbs",lf="Concat",cf="Conv2D",PM="Conv2DBackpropFilter",OM="Conv2DBackpropInput",qu="Cos",hf="CropAndResize",uf="DepthToSpace",df="DepthwiseConv2dNative",wM="DepthwiseConv2dNativeBackpropFilter",DM="DepthwiseConv2dNativeBackpropInput",Zu="RealDiv",FM="Einsum",Xg="Elu",ff="ExpandDims",pf="Fill",LM="FlipLeftRight",Qu="Floor",NM="FloorDiv",mf="GatherV2",BM="Greater",$u="GreaterEqual",Ju="Identity",kM="Imag",UM="LeakyRelu",ed="Less",td="LessEqual",id="LogicalAnd",rd="LogicalOr",_f="Max",sd="Maximum",gf="MaxPool",yf="Mean",bf="Min",nd="Minimum",ad="Multiply",vf="Neg",VM="NonMaxSuppressionV3",GM="NonMaxSuppressionV4",WM="NonMaxSuppressionV5",Tf="Pack",Ef="PadV2",od="Pow",Af="Prelu",Cf="Range",zM="Real",xd="Relu",Rf="Reshape",HM="ResizeNearestNeighbor",If="ResizeBilinear",ld="Relu6",XM="Round",YM="TensorScatterUpdate",KM="Select",Sf="Slice",cd="Sin",hd="Sigmoid",ud="Sqrt",Mf="Sum",jM="SpaceToBatchND",qM="SplitV",Yg="Square",Pf="StridedSlice",dd="Sub",fd="Tile",Of="Transform",ih="Transpose",ZM="Unpack",wf="ZerosLike",QM="Step",Df="FromPixels",Ff="RotateWithOffset",pd="_FusedMatMul",md="FusedConv2D",_d="FusedDepthwiseConv2D";function l0(...l){Ue().getBool("IS_TEST")||Ue().getBool("PROD")||console.warn(...l)}function $M(...l){Ue().getBool("IS_TEST")||Ue().getBool("PROD")||console.log(...l)}const gd=th("kernelRegistry",()=>new Map),JM=th("gradRegistry",()=>new Map);function Lf(l,e){const i=qg(l,e);return gd.get(i)}function Kg(l){return JM.get(l)}function jg(l){const e=gd.entries(),i=[];for(;;){const{done:s,value:n}=e.next();if(s)break;const[a,p]=n,[_]=a.split("_");_===l&&i.push(p)}return i}function ht(l){const{kernelName:e,backendName:i}=l,s=qg(e,i);gd.has(s)&&l0("The kernel '"+e+"' for backend '"+i+"' is already registered"),gd.set(s,l)}function qg(l,e){return e+"_"+l}function Zg(l){return l instanceof Float32Array||l instanceof Int32Array||l instanceof Uint8Array||l instanceof Uint8ClampedArray}var c0=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof fa.g<"u"?fa.g:typeof self<"u"?self:{};function eP(l){return l&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l}var Qg=Fr,Na=null;try{Na=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch{}function Fr(l,e,i){this.low=l|0,this.high=e|0,this.unsigned=!!i}Fr.prototype.__isLong__,Object.defineProperty(Fr.prototype,"__isLong__",{value:!0});function $n(l){return(l&&l.__isLong__)===!0}Fr.isLong=$n;var $g={},Jg={};function Kx(l,e){var i,s,n;return e?(l>>>=0,(n=0<=l&&l<256)&&(s=Jg[l],s)?s:(i=Lr(l,(l|0)<0?-1:0,!0),n&&(Jg[l]=i),i)):(l|=0,(n=-128<=l&&l<128)&&(s=$g[l],s)?s:(i=Lr(l,l<0?-1:0,!1),n&&($g[l]=i),i))}Fr.fromInt=Kx;function Ba(l,e){if(isNaN(l))return e?jx:ka;if(e){if(l<0)return jx;if(l>=ty)return ay}else{if(l<=-iy)return Jn;if(l+1>=iy)return ny}return l<0?Ba(-l,e).neg():Lr(l%Ul|0,l/Ul|0,e)}Fr.fromNumber=Ba;function Lr(l,e,i){return new Fr(l,e,i)}Fr.fromBits=Lr;var yd=Math.pow;function Nf(l,e,i){if(l.length===0)throw Error("empty string");if(l==="NaN"||l==="Infinity"||l==="+Infinity"||l==="-Infinity")return ka;if(typeof e=="number"?(i=e,e=!1):e=!!e,i=i||10,i<2||36<i)throw RangeError("radix");var s;if((s=l.indexOf("-"))>0)throw Error("interior hyphen");if(s===0)return Nf(l.substring(1),e,i).neg();for(var n=Ba(yd(i,8)),a=ka,p=0;p<l.length;p+=8){var _=Math.min(8,l.length-p),g=parseInt(l.substring(p,p+_),i);if(_<8){var y=Ba(yd(i,_));a=a.mul(y).add(Ba(g))}else a=a.mul(n),a=a.add(Ba(g))}return a.unsigned=e,a}Fr.fromString=Nf;function ho(l,e){return typeof l=="number"?Ba(l,e):typeof l=="string"?Nf(l,e):Lr(l.low,l.high,typeof e=="boolean"?e:l.unsigned)}Fr.fromValue=ho;var ey=65536,tP=1<<24,Ul=ey*ey,ty=Ul*Ul,iy=ty/2,ry=Kx(tP),ka=Kx(0);Fr.ZERO=ka;var jx=Kx(0,!0);Fr.UZERO=jx;var Vl=Kx(1);Fr.ONE=Vl;var sy=Kx(1,!0);Fr.UONE=sy;var Bf=Kx(-1);Fr.NEG_ONE=Bf;var ny=Lr(-1,2147483647,!1);Fr.MAX_VALUE=ny;var ay=Lr(-1,-1,!0);Fr.MAX_UNSIGNED_VALUE=ay;var Jn=Lr(0,-2147483648,!1);Fr.MIN_VALUE=Jn;var Ut=Fr.prototype;Ut.toInt=function(){return this.unsigned?this.low>>>0:this.low},Ut.toNumber=function(){return this.unsigned?(this.high>>>0)*Ul+(this.low>>>0):this.high*Ul+(this.low>>>0)},Ut.toString=function(l){if(l=l||10,l<2||36<l)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative())if(this.eq(Jn)){var e=Ba(l),i=this.div(e),s=i.mul(e).sub(this);return i.toString(l)+s.toInt().toString(l)}else return"-"+this.neg().toString(l);for(var n=Ba(yd(l,6),this.unsigned),a=this,p="";;){var _=a.div(n),g=a.sub(_.mul(n)).toInt()>>>0,y=g.toString(l);if(a=_,a.isZero())return y+p;for(;y.length<6;)y="0"+y;p=""+y+p}},Ut.getHighBits=function(){return this.high},Ut.getHighBitsUnsigned=function(){return this.high>>>0},Ut.getLowBits=function(){return this.low},Ut.getLowBitsUnsigned=function(){return this.low>>>0},Ut.getNumBitsAbs=function(){if(this.isNegative())return this.eq(Jn)?64:this.neg().getNumBitsAbs();for(var l=this.high!=0?this.high:this.low,e=31;e>0&&!(l&1<<e);e--);return this.high!=0?e+33:e+1},Ut.isZero=function(){return this.high===0&&this.low===0},Ut.eqz=Ut.isZero,Ut.isNegative=function(){return!this.unsigned&&this.high<0},Ut.isPositive=function(){return this.unsigned||this.high>=0},Ut.isOdd=function(){return(this.low&1)===1},Ut.isEven=function(){return(this.low&1)===0},Ut.equals=function(l){return $n(l)||(l=ho(l)),this.unsigned!==l.unsigned&&this.high>>>31===1&&l.high>>>31===1?!1:this.high===l.high&&this.low===l.low},Ut.eq=Ut.equals,Ut.notEquals=function(l){return!this.eq(l)},Ut.neq=Ut.notEquals,Ut.ne=Ut.notEquals,Ut.lessThan=function(l){return this.comp(l)<0},Ut.lt=Ut.lessThan,Ut.lessThanOrEqual=function(l){return this.comp(l)<=0},Ut.lte=Ut.lessThanOrEqual,Ut.le=Ut.lessThanOrEqual,Ut.greaterThan=function(l){return this.comp(l)>0},Ut.gt=Ut.greaterThan,Ut.greaterThanOrEqual=function(l){return this.comp(l)>=0},Ut.gte=Ut.greaterThanOrEqual,Ut.ge=Ut.greaterThanOrEqual,Ut.compare=function(l){if($n(l)||(l=ho(l)),this.eq(l))return 0;var e=this.isNegative(),i=l.isNegative();return e&&!i?-1:!e&&i?1:this.unsigned?l.high>>>0>this.high>>>0||l.high===this.high&&l.low>>>0>this.low>>>0?-1:1:this.sub(l).isNegative()?-1:1},Ut.comp=Ut.compare,Ut.negate=function(){return!this.unsigned&&this.eq(Jn)?Jn:this.not().add(Vl)},Ut.neg=Ut.negate,Ut.add=function(l){$n(l)||(l=ho(l));var e=this.high>>>16,i=this.high&65535,s=this.low>>>16,n=this.low&65535,a=l.high>>>16,p=l.high&65535,_=l.low>>>16,g=l.low&65535,y=0,b=0,v=0,S=0;return S+=n+g,v+=S>>>16,S&=65535,v+=s+_,b+=v>>>16,v&=65535,b+=i+p,y+=b>>>16,b&=65535,y+=e+a,y&=65535,Lr(v<<16|S,y<<16|b,this.unsigned)},Ut.subtract=function(l){return $n(l)||(l=ho(l)),this.add(l.neg())},Ut.sub=Ut.subtract,Ut.multiply=function(l){if(this.isZero())return ka;if($n(l)||(l=ho(l)),Na){var e=Na.mul(this.low,this.high,l.low,l.high);return Lr(e,Na.get_high(),this.unsigned)}if(l.isZero())return ka;if(this.eq(Jn))return l.isOdd()?Jn:ka;if(l.eq(Jn))return this.isOdd()?Jn:ka;if(this.isNegative())return l.isNegative()?this.neg().mul(l.neg()):this.neg().mul(l).neg();if(l.isNegative())return this.mul(l.neg()).neg();if(this.lt(ry)&&l.lt(ry))return Ba(this.toNumber()*l.toNumber(),this.unsigned);var i=this.high>>>16,s=this.high&65535,n=this.low>>>16,a=this.low&65535,p=l.high>>>16,_=l.high&65535,g=l.low>>>16,y=l.low&65535,b=0,v=0,S=0,M=0;return M+=a*y,S+=M>>>16,M&=65535,S+=n*y,v+=S>>>16,S&=65535,S+=a*g,v+=S>>>16,S&=65535,v+=s*y,b+=v>>>16,v&=65535,v+=n*g,b+=v>>>16,v&=65535,v+=a*_,b+=v>>>16,v&=65535,b+=i*y+s*g+n*_+a*p,b&=65535,Lr(S<<16|M,b<<16|v,this.unsigned)},Ut.mul=Ut.multiply,Ut.divide=function(l){if($n(l)||(l=ho(l)),l.isZero())throw Error("division by zero");if(Na){if(!this.unsigned&&this.high===-2147483648&&l.low===-1&&l.high===-1)return this;var e=(this.unsigned?Na.div_u:Na.div_s)(this.low,this.high,l.low,l.high);return Lr(e,Na.get_high(),this.unsigned)}if(this.isZero())return this.unsigned?jx:ka;var i,s,n;if(this.unsigned){if(l.unsigned||(l=l.toUnsigned()),l.gt(this))return jx;if(l.gt(this.shru(1)))return sy;n=jx}else{if(this.eq(Jn)){if(l.eq(Vl)||l.eq(Bf))return Jn;if(l.eq(Jn))return Vl;var a=this.shr(1);return i=a.div(l).shl(1),i.eq(ka)?l.isNegative()?Vl:Bf:(s=this.sub(l.mul(i)),n=i.add(s.div(l)),n)}else if(l.eq(Jn))return this.unsigned?jx:ka;if(this.isNegative())return l.isNegative()?this.neg().div(l.neg()):this.neg().div(l).neg();if(l.isNegative())return this.div(l.neg()).neg();n=ka}for(s=this;s.gte(l);){i=Math.max(1,Math.floor(s.toNumber()/l.toNumber()));for(var p=Math.ceil(Math.log(i)/Math.LN2),_=p<=48?1:yd(2,p-48),g=Ba(i),y=g.mul(l);y.isNegative()||y.gt(s);)i-=_,g=Ba(i,this.unsigned),y=g.mul(l);g.isZero()&&(g=Vl),n=n.add(g),s=s.sub(y)}return n},Ut.div=Ut.divide,Ut.modulo=function(l){if($n(l)||(l=ho(l)),Na){var e=(this.unsigned?Na.rem_u:Na.rem_s)(this.low,this.high,l.low,l.high);return Lr(e,Na.get_high(),this.unsigned)}return this.sub(this.div(l).mul(l))},Ut.mod=Ut.modulo,Ut.rem=Ut.modulo,Ut.not=function(){return Lr(~this.low,~this.high,this.unsigned)},Ut.and=function(l){return $n(l)||(l=ho(l)),Lr(this.low&l.low,this.high&l.high,this.unsigned)},Ut.or=function(l){return $n(l)||(l=ho(l)),Lr(this.low|l.low,this.high|l.high,this.unsigned)},Ut.xor=function(l){return $n(l)||(l=ho(l)),Lr(this.low^l.low,this.high^l.high,this.unsigned)},Ut.shiftLeft=function(l){return $n(l)&&(l=l.toInt()),(l&=63)===0?this:l<32?Lr(this.low<<l,this.high<<l|this.low>>>32-l,this.unsigned):Lr(0,this.low<<l-32,this.unsigned)},Ut.shl=Ut.shiftLeft,Ut.shiftRight=function(l){return $n(l)&&(l=l.toInt()),(l&=63)===0?this:l<32?Lr(this.low>>>l|this.high<<32-l,this.high>>l,this.unsigned):Lr(this.high>>l-32,this.high>=0?0:-1,this.unsigned)},Ut.shr=Ut.shiftRight,Ut.shiftRightUnsigned=function(l){if($n(l)&&(l=l.toInt()),l&=63,l===0)return this;var e=this.high;if(l<32){var i=this.low;return Lr(i>>>l|e<<32-l,e>>>l,this.unsigned)}else return l===32?Lr(e,0,this.unsigned):Lr(e>>>l-32,0,this.unsigned)},Ut.shru=Ut.shiftRightUnsigned,Ut.shr_u=Ut.shiftRightUnsigned,Ut.toSigned=function(){return this.unsigned?Lr(this.low,this.high,!1):this},Ut.toUnsigned=function(){return this.unsigned?this:Lr(this.low,this.high,!0)},Ut.toBytes=function(l){return l?this.toBytesLE():this.toBytesBE()},Ut.toBytesLE=function(){var l=this.high,e=this.low;return[e&255,e>>>8&255,e>>>16&255,e>>>24,l&255,l>>>8&255,l>>>16&255,l>>>24]},Ut.toBytesBE=function(){var l=this.high,e=this.low;return[l>>>24,l>>>16&255,l>>>8&255,l&255,e>>>24,e>>>16&255,e>>>8&255,e&255]},Fr.fromBytes=function(l,e,i){return i?Fr.fromBytesLE(l,e):Fr.fromBytesBE(l,e)},Fr.fromBytesLE=function(l,e){return new Fr(l[0]|l[1]<<8|l[2]<<16|l[3]<<24,l[4]|l[5]<<8|l[6]<<16|l[7]<<24,e)},Fr.fromBytesBE=function(l,e){return new Fr(l[4]<<24|l[5]<<16|l[6]<<8|l[7],l[0]<<24|l[1]<<16|l[2]<<8|l[3],e)};var oy=eP(Qg),iP=Ai({__proto__:null,default:oy},[Qg]);const qx=oy||iP;function bd(l){return qx.fromString(l,!0,16)}const xy=bd("c3a5c85c97cb3127"),Zx=bd("b492b66fbe98f273"),yn=bd("9ae16a3b2f90404f");function kf(l){return l.xor(l.shru(47))}function ly(l,e,i){const s=l.slice(e,e+i);return qx.fromBytes(Array.from(s),!0,!0)}function Pr(l,e){return ly(l,e,8)}function cy(l,e){return ly(l,e,4)}function Ns(l,e){return e===0?l:l.shru(e).or(l.shl(64-e))}function Q0(l,e,i=bd("9ddfea08eb382d69")){let s=l.xor(e).mul(i);s=s.xor(s.shru(47));let n=e.xor(s).mul(i);return n=n.xor(n.shru(47)),n=n.mul(i),n}function rP(l,e,i,s,n,a){n=n.add(l),a=Ns(a.add(n).add(s),21);const p=n;return n=n.add(e),n=n.add(i),a=a.add(Ns(n,44)),[n.add(s),a.add(p)]}function vd(l,e,i,s){return rP(Pr(l,e),Pr(l,e+8),Pr(l,e+16),Pr(l,e+24),i,s)}function sP(l,e=l.length){if(e>=8){const i=yn.add(e*2),s=Pr(l,0).add(yn),n=Pr(l,e-8),a=Ns(n,37).mul(i).add(s),p=Ns(s,25).add(n).mul(i);return Q0(a,p,i)}if(e>=4){const i=yn.add(e*2),s=cy(l,0);return Q0(s.shl(3).add(e),cy(l,e-4),i)}if(e>0){const i=l[0],s=l[e>>1],n=l[e-1],a=i+(s<<8),p=e+(n<<2);return kf(yn.mul(a).xor(xy.mul(p))).mul(yn)}return yn}function nP(l,e=l.length){const i=yn.add(e*2),s=Pr(l,0).mul(Zx),n=Pr(l,8),a=Pr(l,e-8).mul(i),p=Pr(l,e-16).mul(yn);return Q0(Ns(s.add(n),43).add(Ns(a,30)).add(p),s.add(Ns(n.add(yn),18)).add(a),i)}function aP(l,e=l.length){const i=yn.add(e*2),s=Pr(l,0).mul(yn),n=Pr(l,8),a=Pr(l,e-8).mul(i),p=Pr(l,e-16).mul(yn),_=Ns(s.add(n),43).add(Ns(a,30)).add(p),g=Q0(_,s.add(Ns(n.add(yn),18)).add(a),i),y=Pr(l,16).mul(i),b=Pr(l,24),v=_.add(Pr(l,e-32)).mul(i),S=g.add(Pr(l,e-24)).mul(i);return Q0(Ns(y.add(b),43).add(Ns(v,30)).add(S),y.add(Ns(b.add(s),18)).add(v),i)}function oP(l,e=l.length){const i=qx.fromNumber(81,!0);if(e<=32)return e<=16?sP(l,e):nP(l,e);if(e<=64)return aP(l,e);let s=i,n=i.mul(Zx).add(113),a=kf(n.mul(yn).add(113)).mul(yn),p=[qx.UZERO,qx.UZERO],_=[qx.UZERO,qx.UZERO];s=s.mul(yn).add(Pr(l,0));let g=0;const y=(e-1>>6)*64,b=y+(e-1&63)-63;do s=Ns(s.add(n).add(p[0]).add(Pr(l,g+8)),37).mul(Zx),n=Ns(n.add(p[1]).add(Pr(l,g+48)),42).mul(Zx),s=s.xor(_[1]),n=n.add(p[0]).add(Pr(l,g+40)),a=Ns(a.add(_[0]),33).mul(Zx),p=vd(l,g,p[1].mul(Zx),s.add(_[0])),_=vd(l,g+32,a.add(_[1]),n.add(Pr(l,g+16))),[a,s]=[s,a],g+=64;while(g!==y);const v=Zx.add(a.and(255).shl(1));return g=b,_[0]=_[0].add(e-1&63),p[0]=p[0].add(_[0]),_[0]=_[0].add(p[0]),s=Ns(s.add(n).add(p[0]).add(Pr(l,g+8)),37).mul(v),n=Ns(n.add(p[1]).add(Pr(l,g+48)),42).mul(v),s=s.xor(_[1].mul(9)),n=n.add(p[0].mul(9).add(Pr(l,g+40))),a=Ns(a.add(_[0]),33).mul(v),p=vd(l,g,p[1].mul(v),s.add(_[0])),_=vd(l,g+32,a.add(_[1]),n.add(Pr(l,g+16))),[a,s]=[s,a],Q0(Q0(p[0],_[0],v).add(kf(n).mul(xy)).add(a),Q0(p[1],_[1],v).add(s),v)}function rh(l,e){return e==="string"?$0(l):Td([l],e)}function xP(l,e){return l instanceof Float32Array&&e==="float32"||l instanceof Int32Array&&e==="int32"||l instanceof Uint8Array&&e==="bool"}function Td(l,e){if(e==="string")throw new Error("Cannot convert a string[] to a TypedArray");if(Array.isArray(l)&&(l=Qx(l)),Ue().getBool("DEBUG")&&_i(l,e),xP(l,e))return l;if(e==null||e==="float32"||e==="complex64")return new Float32Array(l);if(e==="int32")return new Int32Array(l);if(e==="bool"){const i=new Uint8Array(l.length);for(let s=0;s<i.length;++s)Math.round(l[s])!==0&&(i[s]=1);return i}else throw new Error("Unknown data type "+e)}function pa(){return Ue().platform.now()}function $0(l,e="utf-8"){return e=e||"utf-8",Ue().platform.encode(l,e)}function Gl(l,e="utf-8"){return e=e||"utf-8",Ue().platform.decode(l,e)}function Ua(l){return Ue().platform.isTypedArray!=null?Ue().platform.isTypedArray(l):Zg(l)}function Qx(l,e=[],i=!1){if(e==null&&(e=[]),typeof l=="boolean"||typeof l=="number"||typeof l=="string"||Wi(l)||l==null||Ua(l)&&i)e.push(l);else if(Array.isArray(l)||Ua(l))for(let s=0;s<l.length;++s)Qx(l[s],e,i);else{let s=-1;for(const n of Object.keys(l))/^([1-9]+[0-9]*|0)$/.test(n)&&(s=Math.max(s,Number(n)));for(let n=0;n<=s;n++)Qx(l[n],e,i)}return e}class lP{constructor(e,i){this.backendTimer=e,this.logger=i,i==null&&(this.logger=new hP)}profileKernel(e,i,s){let n;const a=()=>{n=s()};let p;const _=pa();if(this.backendTimer.timerAvailable())p=this.backendTimer.time(a);else{a();for(const g of n)g.dataSync();p=Promise.resolve({kernelMs:pa()-_})}if(Ue().getBool("CHECK_COMPUTATION_FOR_ERRORS"))for(let g=0;g<n.length;g++){const y=n[g];y.data().then(b=>{cP(b,y.dtype,e)})}return{kernelName:e,outputs:n,inputs:i,timeMs:p.then(g=>g.kernelMs),extraInfo:p.then(g=>g.getExtraProfileInfo!=null?g.getExtraProfileInfo():"")}}logKernelProfile(e){const{kernelName:i,outputs:s,timeMs:n,inputs:a,extraInfo:p}=e;s.forEach(_=>{Promise.all([_.data(),n,p]).then(g=>{this.logger.logKernelProfile(i,_,g[0],g[1],a,g[2])})})}}function cP(l,e,i){if(e!=="float32")return!1;for(let s=0;s<l.length;s++){const n=l[s];if(isNaN(n)||!isFinite(n))return console.warn("Found "+n+" in the result of '"+i+"'"),!0}return!1}class hP{logKernelProfile(e,i,s,n,a,p){const _=typeof n=="number"?ys(n+"ms",9):n.error,g=ys(e,25),y=i.rank,b=i.size,v=ys(i.shape.toString(),14);let S="";for(const M in a){const F=a[M];if(F!=null){const L=F.shape||i.shape,N=L.length;S+=M+": "+N+"D "+(N>0?L:"")+" "}}console.log("%c"+g+"	%c"+_+"	%c"+y+"D "+v+"	%c"+b+"	%c"+S+"	%c"+p,"font-weight:bold","color:red","color:blue","color: orange","color: green","color: steelblue")}}function uP(l,e,i){const s={},n={};for(let g=0;g<e.length;g++)s[e[g].id]=!0;for(let g=0;g<l.length;g++){const y=l[g],b=y.inputs;for(const v in b){const S=b[v];let M=!1;for(let F=0;F<e.length;F++)if(s[S.id]){y.outputs.forEach(L=>s[L.id]=!0),M=!0,n[y.id]=!0;break}if(M)break}}const a={};a[i.id]=!0;const p={};for(let g=l.length-1;g>=0;g--){const y=l[g],b=y.inputs;for(let v=0;v<y.outputs.length;v++)if(a[y.outputs[v].id]){for(const S in b)a[b[S].id]=!0,p[y.id]=!0;break}}const _=[];for(let g=0;g<l.length;g++){const y=l[g];if(n[y.id]&&p[y.id]){const b={};for(const S in y.inputs){const M=y.inputs[S];s[M.id]&&(b[S]=M)}const v=Object.assign({},y);v.inputs=b,v.outputs=y.outputs,_.push(v)}}return _}function dP(l,e,i,s){for(let n=e.length-1;n>=0;n--){const a=e[n],p=[];if(a.outputs.forEach(g=>{const y=l[g.id];y!=null?p.push(y):p.push(null)}),a.gradient==null)throw new Error("Cannot compute gradient: gradient function not found for "+a.kernelName+".");const _=a.gradient(p);for(const g in a.inputs){if(!(g in _))throw new Error("Cannot backprop through input "+g+". Available gradients found: "+Object.keys(_)+".");const y=i(()=>_[g]());if(y.dtype!=="float32")throw new Error("Error in gradient for op "+a.kernelName+". The gradient of input "+g+" must have 'float32' dtype, but has '"+y.dtype+"'");const b=a.inputs[g];if(!qt(y.shape,b.shape))throw new Error("Error in gradient for op "+a.kernelName+". The gradient of input '"+g+"' has shape '"+y.shape+"', which does not match the shape of the input '"+b.shape+"'");if(l[b.id]==null)l[b.id]=y;else{const v=l[b.id];l[b.id]=s(v,y),v.dispose()}}}}const hy=20,sh=3,Uf=7;function fP(l,e,i,s){const n=Ni(e),a=pP(l,e,i,n),p=e.length,_=Ed(l,e,i,n,a),g=["Tensor"];return s&&(g.push("  dtype: "+i),g.push("  rank: "+p),g.push("  shape: ["+e+"]"),g.push("  values:")),g.push(_.map(y=>"    "+y).join(`
`)),g.join(`
`)}function pP(l,e,i,s){const n=Je(e),a=s[s.length-1],p=new Array(a).fill(0),_=e.length,g=i==="complex64"?ah(l):l;if(_>1)for(let y=0;y<n/a;y++){const b=y*a;for(let v=0;v<a;v++)p[v]=Math.max(p[v],nh(g[b+v],0,i).length)}return p}function nh(l,e,i){let s;return Array.isArray(l)?s=parseFloat(l[0].toFixed(Uf))+" + "+parseFloat(l[1].toFixed(Uf))+"j":yr(l)?s="'"+l+"'":i==="bool"?s=uy(l):s=parseFloat(l.toFixed(Uf)).toString(),ys(s,e)}function uy(l){return l===0?"false":"true"}function Ed(l,e,i,s,n,a=!0){const p=i==="complex64"?2:1,_=e[0],g=e.length;if(g===0){if(i==="complex64"){const L=ah(l);return[nh(L[0],0,i)]}return i==="bool"?[uy(l[0])]:[l[0].toString()]}if(g===1){if(_>hy){const L=sh*p;let N=Array.from(l.slice(0,L)),k=Array.from(l.slice((_-sh)*p,_*p));return i==="complex64"&&(N=ah(N),k=ah(k)),["["+N.map((G,H)=>nh(G,n[H],i)).join(", ")+", ..., "+k.map((G,H)=>nh(G,n[_-sh+H],i)).join(", ")+"]"]}return["["+(i==="complex64"?ah(l):Array.from(l)).map((L,N)=>nh(L,n[N],i)).join(", ")+"]"]}const y=e.slice(1),b=s.slice(1),v=s[0]*p,S=[];if(_>hy){for(let L=0;L<sh;L++){const N=L*v,k=N+v;S.push(...Ed(l.slice(N,k),y,i,b,n,!1))}S.push("...");for(let L=_-sh;L<_;L++){const N=L*v,k=N+v;S.push(...Ed(l.slice(N,k),y,i,b,n,L===_-1))}}else for(let L=0;L<_;L++){const N=L*v,k=N+v;S.push(...Ed(l.slice(N,k),y,i,b,n,L===_-1))}const M=g===2?",":"";S[0]="["+(_>0?S[0]+M:"");for(let L=1;L<S.length-1;L++)S[L]=" "+S[L]+M;let F=`,
`;for(let L=2;L<g;L++)F+=`
`;return S[S.length-1]=" "+S[S.length-1]+"]"+(a?"":F),S}function ah(l){const e=[];for(let i=0;i<l.length;i+=2)e.push([l[i],l[i+1]]);return e}class Wl{constructor(e,i,s){if(this.dtype=i,this.shape=e.slice(),this.size=Je(e),s!=null){const n=s.length;Te(n===this.size,()=>"Length of values '"+n+"' does not match the size inferred by the shape '"+this.size+"'.")}if(i==="complex64")throw new Error("complex64 dtype TensorBuffers are not supported. Please create a TensorBuffer for the real and imaginary parts separately and call tf.complex(real, imag).");this.values=s||bt(i,this.size),this.strides=Ni(e)}set(e,...i){i.length===0&&(i=[0]),Te(i.length===this.rank,()=>"The number of provided coordinates ("+i.length+") must match the rank ("+this.rank+")");const s=this.locToIndex(i);this.values[s]=e}get(...e){e.length===0&&(e=[0]);let i=0;for(const n of e){if(n<0||n>=this.shape[i]){const a="Requested out of range element at "+e+".   Buffer shape="+this.shape;throw new Error(a)}i++}let s=e[e.length-1];for(let n=0;n<e.length-1;++n)s+=this.strides[n]*e[n];return this.values[s]}locToIndex(e){if(this.rank===0)return 0;if(this.rank===1)return e[0];let i=e[e.length-1];for(let s=0;s<e.length-1;++s)i+=this.strides[s]*e[s];return i}indexToLoc(e){if(this.rank===0)return[];if(this.rank===1)return[e];const i=new Array(this.shape.length);for(let s=0;s<i.length-1;++s)i[s]=Math.floor(e/this.strides[s]),e-=i[s]*this.strides[s];return i[i.length-1]=e,i}get rank(){return this.shape.length}toTensor(){return uo().makeTensor(this.values,this.shape,this.dtype)}}let uo=null,zl=null;function mP(l){uo=l}function _P(l){zl=l}class ea{constructor(e,i,s,n){this.kept=!1,this.isDisposedInternal=!1,this.shape=e.slice(),this.dtype=i||"float32",this.size=Je(e),this.strides=Ni(e),this.dataId=s,this.id=n,this.rankType=this.rank<5?this.rank.toString():"higher"}get rank(){return this.shape.length}async buffer(){const e=await this.data();return zl.buffer(this.shape,this.dtype,e)}bufferSync(){return zl.buffer(this.shape,this.dtype,this.dataSync())}async array(){const e=await this.data();return Ys(this.shape,e,this.dtype==="complex64")}arraySync(){return Ys(this.shape,this.dataSync(),this.dtype==="complex64")}async data(){this.throwIfDisposed();const e=uo().read(this.dataId);if(this.dtype==="string"){const i=await e;try{return i.map(s=>Gl(s))}catch{throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}}return e}dataToGPU(e){return this.throwIfDisposed(),uo().readToGPU(this.dataId,e)}dataSync(){this.throwIfDisposed();const e=uo().readSync(this.dataId);if(this.dtype==="string")try{return e.map(i=>Gl(i))}catch{throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}return e}async bytes(){this.throwIfDisposed();const e=await uo().read(this.dataId);return this.dtype==="string"?e:new Uint8Array(e.buffer)}dispose(){this.isDisposed||(uo().disposeTensor(this),this.isDisposedInternal=!0)}get isDisposed(){return this.isDisposedInternal}throwIfDisposed(){if(this.isDisposed)throw new Error("Tensor is disposed.")}print(e=!1){return zl.print(this,e)}clone(){return this.throwIfDisposed(),zl.clone(this)}toString(e=!1){const i=this.dataSync();return fP(i,this.shape,this.dtype,e)}cast(e){return this.throwIfDisposed(),zl.cast(this,e)}variable(e=!0,i,s){return this.throwIfDisposed(),uo().makeVariable(this,e,i,s)}}Object.defineProperty(ea,Symbol.hasInstance,{value:l=>!!l&&l.data!=null&&l.dataSync!=null&&l.throwIfDisposed!=null});function gP(){return th("Tensor",()=>ea)}gP();class Vf extends ea{constructor(e,i,s,n){super(e.shape,e.dtype,e.dataId,n),this.trainable=i,this.name=s}assign(e){if(e.dtype!==this.dtype)throw new Error("dtype of the new value ("+e.dtype+") and previous value ("+this.dtype+") must match");if(!qt(e.shape,this.shape))throw new Error("shape of the new value ("+e.shape+") and previous value ("+this.shape+") must match");uo().disposeTensor(this),this.dataId=e.dataId,uo().incRef(this,null)}dispose(){uo().disposeVariable(this),this.isDisposedInternal=!0}}Object.defineProperty(Vf,Symbol.hasInstance,{value:l=>l instanceof ea&&l.assign!=null&&l.assign instanceof Function});var dy;(function(l){l.R0="R0",l.R1="R1",l.R2="R2",l.R3="R3",l.R4="R4",l.R5="R5",l.R6="R6"})(dy||(dy={}));var Gf;(function(l){l.float32="float32",l.int32="int32",l.bool="int32",l.complex64="complex64"})(Gf||(Gf={}));var Wf;(function(l){l.float32="float32",l.int32="int32",l.bool="bool",l.complex64="complex64"})(Wf||(Wf={}));var zf;(function(l){l.float32="float32",l.int32="float32",l.bool="float32",l.complex64="complex64"})(zf||(zf={}));var Hf;(function(l){l.float32="complex64",l.int32="complex64",l.bool="complex64",l.complex64="complex64"})(Hf||(Hf={}));const yP={float32:zf,int32:Gf,bool:Wf,complex64:Hf};function Do(l,e){if(l==="string"||e==="string"){if(l==="string"&&e==="string")return"string";throw new Error("Can not upcast "+l+" with "+e)}return yP[l][e]}function bP(l){return Do(l,"int32")}function fy(l){return l!=null&&typeof l=="object"&&"texture"in l&&l.texture instanceof WebGLTexture}function py(l){return typeof GPUBuffer<"u"&&l!=null&&typeof l=="object"&&"buffer"in l&&l.buffer instanceof GPUBuffer}function Ks(l,e){if(l.dtype===e.dtype)return[l,e];const i=Do(l.dtype,e.dtype);return[l.cast(i),e.cast(i)]}function my(l){const e=[];return _y(l,e,new Set),e}function _y(l,e,i){if(l==null)return;if(l instanceof ea){e.push(l);return}if(!vP(l))return;const s=l;for(const n in s){const a=s[n];i.has(a)||(i.add(a),_y(a,e,i))}}function vP(l){return Array.isArray(l)||typeof l=="object"}function Xf(l){return l.kernelName!=null}class gy{constructor(){this.registeredVariables={},this.nextTapeNodeId=0,this.numBytes=0,this.numTensors=0,this.numStringTensors=0,this.numDataBuffers=0,this.gradientDepth=0,this.kernelDepth=0,this.scopeStack=[],this.numDataMovesStack=[],this.nextScopeId=0,this.tensorInfo=new WeakMap,this.profiling=!1,this.activeProfile={newBytes:0,newTensors:0,peakBytes:0,kernels:[],result:null,get kernelNames(){return Array.from(new Set(this.kernels.map(e=>e.name)))}}}dispose(){for(const e in this.registeredVariables)this.registeredVariables[e].dispose()}}class Hl{constructor(e){this.ENV=e,this.registry={},this.registryFactory={},this.pendingBackendInitId=0,this.state=new gy}async ready(){if(this.pendingBackendInit!=null)return this.pendingBackendInit.then(()=>{});if(this.backendInstance!=null)return;const e=this.getSortedBackends();for(let i=0;i<e.length;i++){const s=e[i];if(await this.initializeBackend(s).success){await this.setBackend(s);return}}throw new Error("Could not initialize any backends, all backend initializations failed.")}get backend(){if(this.pendingBackendInit!=null)throw new Error("Backend '"+this.backendName+"' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods");if(this.backendInstance==null){const{name:e,asyncInit:i}=this.initializeBackendsAndReturnBest();if(i)throw new Error("The highest priority backend '"+e+"' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods");this.setBackend(e)}return this.backendInstance}backendNames(){return Object.keys(this.registryFactory)}findBackend(e){if(!(e in this.registry))if(e in this.registryFactory){const{asyncInit:i}=this.initializeBackend(e);if(i)return null}else return null;return this.registry[e]}findBackendFactory(e){return e in this.registryFactory?this.registryFactory[e].factory:null}registerBackend(e,i,s=1){return e in this.registryFactory?(l0(e+" backend was already registered. Reusing existing backend factory."),!1):(this.registryFactory[e]={factory:i,priority:s},!0)}async setBackend(e){if(this.registryFactory[e]==null)throw new Error("Backend name '"+e+"' not found in registry");if(this.backendName=e,this.registry[e]==null){this.backendInstance=null;const{success:i,asyncInit:s}=this.initializeBackend(e);if(!(s?await i:i))return!1}return this.backendInstance=this.registry[e],this.setupRegisteredKernels(),this.profiler=new lP(this.backendInstance),!0}setupRegisteredKernels(){jg(this.backendName).forEach(e=>{e.setupFunc!=null&&e.setupFunc(this.backendInstance)})}disposeRegisteredKernels(e){jg(e).forEach(i=>{i.disposeFunc!=null&&i.disposeFunc(this.registry[e])})}initializeBackend(e){const i=this.registryFactory[e];if(i==null)throw new Error("Cannot initialize backend "+e+", no registration found.");try{const s=i.factory();if(s&&!(s instanceof ni)&&typeof s.then=="function"){const n=++this.pendingBackendInitId,a=s.then(p=>n<this.pendingBackendInitId?!1:(this.registry[e]=p,this.pendingBackendInit=null,!0)).catch(p=>(n<this.pendingBackendInitId||(this.pendingBackendInit=null,l0("Initialization of backend "+e+" failed"),l0(p.stack||p.message)),!1));return this.pendingBackendInit=a,{success:a,asyncInit:!0}}else return this.registry[e]=s,{success:!0,asyncInit:!1}}catch(s){return l0("Initialization of backend "+e+" failed"),l0(s.stack||s.message),{success:!1,asyncInit:!1}}}removeBackend(e){if(!(e in this.registryFactory))throw new Error(e+" backend not found in registry");this.backendName===e&&this.pendingBackendInit!=null&&this.pendingBackendInitId++,e in this.registry&&(this.disposeRegisteredKernels(e),this.registry[e].dispose(),delete this.registry[e]),delete this.registryFactory[e],this.backendName===e&&(this.pendingBackendInit=null,this.backendName=null,this.backendInstance=null)}getSortedBackends(){if(Object.keys(this.registryFactory).length===0)throw new Error("No backend found in registry.");return Object.keys(this.registryFactory).sort((e,i)=>this.registryFactory[i].priority-this.registryFactory[e].priority)}initializeBackendsAndReturnBest(){const e=this.getSortedBackends();for(let i=0;i<e.length;i++){const s=e[i],{success:n,asyncInit:a}=this.initializeBackend(s);if(a||n)return{name:s,asyncInit:a}}throw new Error("Could not initialize any backends, all backend initializations failed.")}moveData(e,i){const s=this.state.tensorInfo.get(i),n=s.backend,a=this.readSync(i),p=n.refCount(i);n.disposeData(i,!0),s.backend=e,e.move(i,a,s.shape,s.dtype,p),this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack[this.state.numDataMovesStack.length-1]++}tidy(e,i){let s=null;if(i==null){if(typeof e!="function")throw new Error("Please provide a function to tidy()");i=e}else{if(typeof e!="string"&&!(e instanceof String))throw new Error("When calling with two arguments, the first argument to tidy() must be a string");if(typeof i!="function")throw new Error("When calling with two arguments, the 2nd argument to tidy() must be a function");s=e}let n;return this.scopedRun(()=>this.startScope(s),()=>this.endScope(n),()=>(n=i(),n instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),n))}scopedRun(e,i,s){e();try{const n=s();return i(),n}catch(n){throw i(),n}}nextTensorId(){return Hl.nextTensorId++}nextVariableId(){return Hl.nextVariableId++}clone(e){const i=dt.runKernel(Ju,{x:e}),s={x:e},n=p=>({x:()=>{const _="float32",g={x:p},y={dtype:_};return dt.runKernel(Ku,g,y)}}),a=[];return this.addTapeNode(this.state.activeScope.name,s,[i],n,a,{}),i}runKernel(e,i,s){if(this.backendName==null&&this.backend,Lf(e,this.backendName)==null)throw new Error("Kernel '"+e+"' not registered for backend '"+this.backendName+"'");return this.runKernelFunc({kernelName:e,inputs:i,attrs:s})}shouldCheckForMemLeaks(){return this.ENV.getBool("IS_TEST")}checkKernelForMemLeak(e,i,s){const n=this.backend.numDataIds();let a=0;s.forEach(g=>{a+=g.dtype==="complex64"?3:1});const p=this.state.numDataMovesStack[this.state.numDataMovesStack.length-1],_=n-i-a-p;if(_>0)throw new Error("Backend '"+this.backendName+"' has an internal memory leak ("+_+" data ids) after running '"+e+"'")}runKernelFunc(e){let i,s=[];const n=this.isTapeOn(),a=this.state.numBytes,p=this.state.numTensors;this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack.push(0);let _;this.backendName==null&&this.backend;let g;const y=Xf(e)?e.kernelName:this.state.activeScope!=null?this.state.activeScope.name:"";if(Xf(e)){const{kernelName:F,inputs:L,attrs:N}=e;this.backendName==null&&this.backend;const k=Lf(F,this.backendName);Te(k!=null,()=>"Cannot find registered kernel '"+F+"' for backend '"+this.backendName+"'"),_=()=>{const G=this.backend.numDataIds();g=k.kernelFunc({inputs:L,attrs:N,backend:this.backend});const H=Array.isArray(g)?g:[g];this.shouldCheckForMemLeaks()&&this.checkKernelForMemLeak(F,G,H);const z=H.map(W=>W.rank!=null?W:this.makeTensorFromTensorInfo(W));if(n){const W=this.getTensorsForGradient(F,L,z);s=this.saveTensorsForBackwardMode(W)}return z}}else{const{forwardFunc:F}=e,L=N=>{n&&(s=N.map(k=>this.keep(this.clone(k))))};_=()=>{const N=this.backend.numDataIds();g=this.tidy(()=>F(this.backend,L));const k=Array.isArray(g)?g:[g];return this.shouldCheckForMemLeaks()&&this.checkKernelForMemLeak(y,N,k),k}}const{inputs:b,attrs:v}=e,S=Xf(e)?null:e.backwardsFunc;let M;return this.scopedRun(()=>this.state.kernelDepth++,()=>this.state.kernelDepth--,()=>{!this.ENV.getBool("DEBUG")&&!this.state.profiling?i=_():(M=this.profiler.profileKernel(y,b,()=>_()),this.ENV.getBool("DEBUG")&&this.profiler.logKernelProfile(M),i=M.outputs)}),n&&this.addTapeNode(y,b,i,S,s,v),this.state.profiling&&this.state.activeProfile.kernels.push({name:y,bytesAdded:this.state.numBytes-a,totalBytesSnapshot:this.state.numBytes,tensorsAdded:this.state.numTensors-p,totalTensorsSnapshot:this.state.numTensors,inputShapes:Object.keys(b).map(F=>b[F]!=null?b[F].shape:null),outputShapes:i.map(F=>F.shape),kernelTimeMs:M.timeMs,extraInfo:M.extraInfo}),Array.isArray(g)?i:i[0]}saveTensorsForBackwardMode(e){return e.map(i=>this.keep(this.clone(i)))}getTensorsForGradient(e,i,s){const n=Kg(e);if(n!=null){const a=n.inputsToSave||[],p=n.outputsToSave||[];let _;n.saveAllInputs?(Te(Array.isArray(i),()=>"saveAllInputs is true, expected inputs to be an array."),_=Object.keys(i).map(y=>i[y])):_=a.map(y=>i[y]);const g=s.filter((y,b)=>p[b]);return _.concat(g)}return[]}makeTensor(e,i,s,n){if(e==null)throw new Error("Values passed to engine.makeTensor() are null");s=s||"float32",n=n||this.backend;let a=e;s==="string"&&yr(e[0])&&(a=e.map(g=>$0(g)));const p=n.write(a,i,s),_=new ea(i,s,p,this.nextTensorId());if(this.trackTensor(_,n),s==="string"){const g=this.state.tensorInfo.get(p),y=hs(a);this.state.numBytes+=y-g.bytes,g.bytes=y}return _}makeTensorFromDataId(e,i,s,n){s=s||"float32";const a={dataId:e,shape:i,dtype:s};return this.makeTensorFromTensorInfo(a,n)}makeTensorFromTensorInfo(e,i){const{dataId:s,shape:n,dtype:a}=e,p=new ea(n,a,s,this.nextTensorId());return this.trackTensor(p,i),p}makeVariable(e,i=!0,s,n){s=s||this.nextVariableId().toString(),n!=null&&n!==e.dtype&&(e=e.cast(n));const a=new Vf(e,i,s,this.nextTensorId());if(this.state.registeredVariables[a.name]!=null)throw new Error("Variable with name "+a.name+" was already registered");return this.state.registeredVariables[a.name]=a,this.incRef(a,this.backend),a}trackTensor(e,i){this.state.numTensors++,e.dtype==="string"&&this.state.numStringTensors++;let s=0;e.dtype!=="complex64"&&e.dtype!=="string"&&(s=e.size*Pi(e.dtype)),this.state.numBytes+=s,this.state.tensorInfo.has(e.dataId)||(this.state.numDataBuffers++,this.state.tensorInfo.set(e.dataId,{backend:i||this.backend,dtype:e.dtype,shape:e.shape,bytes:s})),e instanceof Vf||this.track(e)}incRef(e,i){this.trackTensor(e,i),this.backend.incRef(e.dataId)}removeDataId(e,i){this.state.tensorInfo.has(e)&&this.state.tensorInfo.get(e).backend===i&&(this.state.tensorInfo.delete(e),this.state.numDataBuffers--)}disposeTensor(e){if(!this.state.tensorInfo.has(e.dataId))return;const i=this.state.tensorInfo.get(e.dataId);if(this.state.numTensors--,e.dtype==="string"&&(this.state.numStringTensors--,this.state.numBytes-=i.bytes),e.dtype!=="complex64"&&e.dtype!=="string"){const s=e.size*Pi(e.dtype);this.state.numBytes-=s}i.backend.disposeData(e.dataId)&&this.removeDataId(e.dataId,i.backend)}disposeVariables(){for(const e in this.state.registeredVariables){const i=this.state.registeredVariables[e];this.disposeVariable(i)}}disposeVariable(e){this.disposeTensor(e),this.state.registeredVariables[e.name]!=null&&delete this.state.registeredVariables[e.name]}memory(){const e=this.backend.memory();return e.numTensors=this.state.numTensors,e.numDataBuffers=this.state.numDataBuffers,e.numBytes=this.state.numBytes,this.state.numStringTensors>0&&(e.unreliable=!0,e.reasons==null&&(e.reasons=[]),e.reasons.push("Memory usage by string tensors is approximate (2 bytes per character)")),e}async profile(e){this.state.profiling=!0;const i=this.state.numBytes,s=this.state.numTensors;this.state.activeProfile.kernels=[],this.state.activeProfile.result=await e(),this.state.profiling=!1,this.state.activeProfile.peakBytes=Math.max(...this.state.activeProfile.kernels.map(n=>n.totalBytesSnapshot)),this.state.activeProfile.newBytes=this.state.numBytes-i,this.state.activeProfile.newTensors=this.state.numTensors-s;for(const n of this.state.activeProfile.kernels)n.kernelTimeMs=await n.kernelTimeMs,n.extraInfo=await n.extraInfo;return this.state.activeProfile}isTapeOn(){return this.state.gradientDepth>0&&this.state.kernelDepth===0}addTapeNode(e,i,s,n,a,p){const _={id:this.state.nextTapeNodeId++,kernelName:e,inputs:i,outputs:s,saved:a},g=Kg(e);g!=null&&(n=g.gradFunc),n!=null&&(_.gradient=y=>(y=y.map((b,v)=>{if(b==null){const S=s[v],M=ze(S.size,S.dtype);return this.makeTensor(M,S.shape,S.dtype)}return b}),n(y.length>1?y:y[0],a,p))),this.state.activeTape.push(_)}keep(e){return e.kept=!0,e}startTape(){this.state.gradientDepth===0&&(this.state.activeTape=[]),this.state.gradientDepth++}endTape(){this.state.gradientDepth--}startScope(e){const i={track:[],name:"unnamed scope",id:this.state.nextScopeId++};e&&(i.name=e),this.state.scopeStack.push(i),this.state.activeScope=i}endScope(e){const i=my(e),s=new Set(i.map(a=>a.id));for(let a=0;a<this.state.activeScope.track.length;a++){const p=this.state.activeScope.track[a];!p.kept&&!s.has(p.id)&&p.dispose()}const n=this.state.scopeStack.pop();this.state.activeScope=this.state.scopeStack.length===0?null:this.state.scopeStack[this.state.scopeStack.length-1],i.forEach(a=>{!a.kept&&a.scopeId===n.id&&this.track(a)})}gradients(e,i,s,n=!1){if(Te(i.length>0,()=>"gradients() received an empty list of xs."),s!=null&&s.dtype!=="float32")throw new Error("dy must have 'float32' dtype, but has '"+s.dtype+"'");const a=this.scopedRun(()=>this.startTape(),()=>this.endTape(),()=>this.tidy("forward",e));Te(a instanceof ea,()=>"The result y returned by f() must be a tensor.");const p=uP(this.state.activeTape,i,a);if(!n&&p.length===0&&i.length>0)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that the f you passed encloses all operations that lead from x to y.");return this.tidy("backward",()=>{const _={};_[a.id]=s??TP(a.shape),dP(_,p,y=>this.tidy(y),EP);const g=i.map(y=>_[y.id]);return this.state.gradientDepth===0&&(this.state.activeTape.forEach(y=>{for(const b of y.saved)b.dispose()}),this.state.activeTape=null),{value:a,grads:g}})}customGrad(e){return Te(Zr(e),()=>"The f passed in customGrad(f) must be a function."),(...i)=>{Te(i.every(_=>_ instanceof ea),()=>"The args passed in customGrad(f)(x1, x2,...) must all be tensors");let s;const n={};i.forEach((_,g)=>{n[g]=_});const a=(_,g)=>(s=e(...i,g),Te(s.value instanceof ea,()=>"The function f passed in customGrad(f) must return an object where `obj.value` is a tensor"),Te(Zr(s.gradFunc),()=>"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function."),s.value),p=(_,g)=>{const y=s.gradFunc(_,g),b=Array.isArray(y)?y:[y];Te(b.length===i.length,()=>"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns the same number of tensors as inputs passed to f(...)."),Te(b.every(S=>S instanceof ea),()=>"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns a list of only tensors.");const v={};return b.forEach((S,M)=>{v[M]=()=>S}),v};return this.runKernelFunc({forwardFunc:a,backwardsFunc:p,inputs:n})}}readSync(e){return this.state.tensorInfo.get(e).backend.readSync(e)}read(e){return this.state.tensorInfo.get(e).backend.read(e)}readToGPU(e,i){return this.state.tensorInfo.get(e).backend.readToGPU(e,i)}async time(e){const i=pa(),s=await this.backend.time(e);return s.wallMs=pa()-i,s}track(e){return this.state.activeScope!=null&&(e.scopeId=this.state.activeScope.id,this.state.activeScope.track.push(e)),e}get registeredVariables(){return this.state.registeredVariables}reset(){this.pendingBackendInitId++,this.state.dispose(),this.ENV.reset(),this.state=new gy;for(const e in this.registry)this.disposeRegisteredKernels(e),this.registry[e].dispose(),delete this.registry[e];this.backendName=null,this.backendInstance=null,this.pendingBackendInit=null}}Hl.nextTensorId=0,Hl.nextVariableId=0;function TP(l){const e=co(Je(l),"float32");return dt.makeTensor(e,l,"float32")}function yy(){const l=eh();if(l._tfengine==null){const e=new Yi(l);l._tfengine=new Hl(e)}return q0(l._tfengine.ENV),mP(()=>l._tfengine),l._tfengine}const dt=yy();function EP(l,e){const i={a:l,b:e};return dt.runKernel(Yx,i)}function AP(){return typeof navigator<"u"&&navigator!=null}function by(l){if(l||AP()){if(l||(l=navigator),l.product==="ReactNative")return!0;const e=l.userAgent||l.vendor||(typeof window<"u"?window.opera:"");if(!e){const i=l;return i.userAgentData&&i.userAgentData.mobile}return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))}return!1}function vy(){return typeof window<"u"&&window.document!=null||typeof WorkerGlobalScope<"u"}const Bn=Ue();Bn.registerFlag("DEBUG",()=>!1,l=>{l&&console.warn("Debugging mode is ON. The output of every math call will be downloaded to CPU and checked for NaNs. This significantly impacts performance.")}),Bn.registerFlag("IS_BROWSER",()=>vy()),Bn.registerFlag("IS_NODE",()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"),Bn.registerFlag("IS_CHROME",()=>typeof navigator<"u"&&navigator!=null&&navigator.userAgent!=null&&/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)),Bn.registerFlag("IS_SAFARI",()=>typeof navigator<"u"&&navigator!=null&&navigator.userAgent!=null&&/Safari/.test(navigator.userAgent)&&/Apple/.test(navigator.vendor)),Bn.registerFlag("PROD",()=>!1),Bn.registerFlag("TENSORLIKE_CHECK_SHAPE_CONSISTENCY",()=>Bn.getBool("DEBUG")),Bn.registerFlag("DEPRECATION_WARNINGS_ENABLED",()=>!0),Bn.registerFlag("IS_TEST",()=>!1),Bn.registerFlag("CHECK_COMPUTATION_FOR_ERRORS",()=>Bn.getBool("DEBUG")),Bn.registerFlag("WRAP_TO_IMAGEBITMAP",()=>!1),Bn.registerFlag("CANVAS2D_WILL_READ_FREQUENTLY_FOR_GPU",()=>!1),Bn.registerFlag("USE_SETTIMEOUTCUSTOM",()=>!1);function oh(l,e){let i=l;if(Ua(l))return e==="string"?[]:[l.length];if(fy(l)){const n=l.channels||"RGBA";return[l.height,l.width*n.length]}else if(py(l))return[l.buffer.size/(e==null?4:Pi(e))];if(!Array.isArray(l))return[];const s=[];for(;Array.isArray(i)||Ua(i)&&e!=="string";)s.push(i.length),i=i[0];return Array.isArray(l)&&Ue().getBool("TENSORLIKE_CHECK_SHAPE_CONSISTENCY")&&Ty(l,s,[]),s}function Ty(l,e,i){if(i=i||[],!Array.isArray(l)&&!Ua(l)){Te(e.length===0,()=>"Element arr["+i.join("][")+"] is a primitive, but should be an array/TypedArray of "+e[0]+" elements");return}Te(e.length>0,()=>"Element arr["+i.join("][")+"] should be a primitive, but is an array of "+l.length+" elements"),Te(l.length===e[0],()=>"Element arr["+i.join("][")+"] should have "+e[0]+" elements, but has "+l.length+" elements");const s=e.slice(1);for(let n=0;n<l.length;++n)Ty(l[n],s,i.concat(n))}function Ey(l,e,i,s){if(l!=="string_or_numeric"){if(l==null)throw new Error("Expected dtype cannot be null.");if(l!=="numeric"&&l!==e||l==="numeric"&&e==="string")throw new Error("Argument '"+i+"' passed to '"+s+"' must be "+l+" tensor, but got "+e+" tensor")}}function rt(l,e,i,s="numeric"){if(l instanceof ea)return Ey(s,l.dtype,e,i),l;let n=ar(l);if(n!=="string"&&["bool","int32","float32"].indexOf(s)>=0&&(n=s),Ey(s,n,e,i),l==null||!Ua(l)&&!Array.isArray(l)&&typeof l!="number"&&typeof l!="boolean"&&typeof l!="string"){const _=l==null?"null":l.constructor.name;throw new Error("Argument '"+e+"' passed to '"+i+"' must be a Tensor or TensorLike, but got '"+_+"'")}const a=oh(l,n);!Ua(l)&&!Array.isArray(l)&&(l=[l]);const p=n!=="string"?Td(l,n):Qx(l,[],!0);return dt.makeTensor(p,a,n)}function Ay(l,e,i,s="numeric"){if(!Array.isArray(l))throw new Error("Argument "+e+" passed to "+i+" must be a `Tensor[]` or `TensorLike[]`");return l.map((n,a)=>rt(n,e+"["+a+"]",i,s))}const CP="__op";function It(l){const e=Object.keys(l);if(e.length!==1)throw new Error("Please provide an object with a single key (operation name) mapping to a function. Got an object with "+e.length+" keys.");let i=e[0];const s=l[i];i.endsWith("_")&&(i=i.substring(0,i.length-1)),i=i+CP;const n=(...a)=>{dt.startScope(i);try{const p=s(...a);return Wi(p)&&console.error("Cannot return a Promise inside of tidy."),dt.endScope(p),p}catch(p){throw dt.endScope(null),p}};return Object.defineProperty(n,"name",{value:i,configurable:!0}),n}function RP(l,e){const i=rt(l,"real","complex"),s=rt(e,"imag","complex");yi(i.shape,s.shape,"real and imag shapes, "+i.shape+" and "+s.shape+", must match in call to tf.complex().");const n={real:i,imag:s};return dt.runKernel(SM,n)}const Yf=It({complex_:RP});function xh(l,e,i,s){if(s==null)s=ar(l);else if(s==="complex64")throw new Error("Cannot construct a complex64 tensor directly. Please use tf.complex(real, imag).");if(py(l)||fy(l)){if(s!=="float32"&&s!=="int32")throw new Error("Creating tensor from GPU data only supports 'float32'|'int32' dtype, while the dtype is "+s+".");return dt.backend.createTensorFromGPUData(l,e||i,s)}if(!Ua(l)&&!Array.isArray(l)&&typeof l!="number"&&typeof l!="boolean"&&typeof l!="string")throw new Error("values passed to tensor(values) must be a number/boolean/string or an array of numbers/booleans/strings, or a TypedArray");if(e!=null){xt(e);const n=Je(e),a=Je(i);Te(n===a,()=>"Based on the provided shape, ["+e+"], the tensor should have "+n+" values but has "+a);for(let p=0;p<i.length;++p){const _=i[p],g=p===i.length-1?_!==Je(e.slice(p)):!0;Te(i[p]===e[p]||!g,()=>"Error creating a new Tensor. Inferred shape ("+i+") does not match the provided shape ("+e+"). ")}}return!Ua(l)&&!Array.isArray(l)&&(l=[l]),e=e||i,l=s!=="string"?Td(l,s):Qx(l,[],!0),dt.makeTensor(l,e,s)}function J0(l,e,i){const s=oh(l,i);return xh(l,e,s,i)}const Kf={float32:4,float16:2,int32:4,uint16:2,uint8:1,bool:1,complex64:8};class fo{static join(e){return new fo(e).slice()}constructor(e){if(this.shards=[],this.previousShardIndex=0,e==null||(e instanceof Array||(e=[e]),e=e.map(s=>Ua(s)?s.buffer:s),e.length===0))return;this.bufferUniformSize=e[0].byteLength;let i=0;for(let s=0;s<e.length;s++){const n=e[s];s!==e.length-1&&n.byteLength!==this.bufferUniformSize&&(this.bufferUniformSize=void 0);const a=i+n.byteLength;this.shards.push({buffer:n,start:i,end:a}),i=a}this.shards.length===0&&(this.byteLength=0),this.byteLength=this.shards[this.shards.length-1].end}slice(e=0,i=this.byteLength){if(this.shards.length===0)return new ArrayBuffer(0);if(e=isNaN(Number(e))?0:e,i=isNaN(Number(i))?0:i,e=Math.max(0,e),i=Math.min(this.byteLength,i),i<=e)return new ArrayBuffer(0);const s=this.findShardForByte(e);if(s===-1)throw new Error("Could not find start shard for byte "+e);const n=i-e,a=new ArrayBuffer(n),p=new Uint8Array(a);let _=0;for(let g=s;g<this.shards.length;g++){const y=this.shards[g],b=e+_-y.start,v=_,S=Math.min(i,y.end)-y.start,M=new Uint8Array(y.buffer,b,S-b);if(p.set(M,v),_+=M.length,i<y.end)break}return a}findShardForByte(e){if(this.shards.length===0||e<0||e>=this.byteLength)return-1;if(this.bufferUniformSize!=null)return this.previousShardIndex=Math.floor(e/this.bufferUniformSize),this.previousShardIndex;function i(n){return e<n.start?-1:e>=n.end?1:0}if(i(this.shards[this.previousShardIndex])===0)return this.previousShardIndex;const s=IP(this.shards,i);return s===-1?-1:(this.previousShardIndex=s,this.previousShardIndex)}}function IP(l,e){let i=0,s=l.length;for(;i<=s;){const n=Math.floor((s-i)/2)+i,a=e(l[n]);if(a===0)return n;a<0?s=n:i=n+1}return-1}const Ad=4;async function SP(l,e){const i=[],s=[],n=Array.isArray(l)?l.map(p=>p.name):Object.keys(l);for(let p=0;p<n.length;++p){const _=n[p],g=Array.isArray(l)?l[p].tensor:l[_];if(g.dtype!=="float32"&&g.dtype!=="int32"&&g.dtype!=="bool"&&g.dtype!=="string"&&g.dtype!=="complex64")throw new Error("Unsupported dtype in weight '"+_+"': "+g.dtype);const y={name:_,shape:g.shape,dtype:g.dtype};if(g.dtype==="string"){const b=new Promise(async v=>{const S=await g.bytes(),M=S.reduce((N,k)=>N+k.length,0)+Ad*S.length,F=new Uint8Array(M);let L=0;for(let N=0;N<S.length;N++){const k=S[N],G=new Uint8Array(new Uint32Array([k.length]).buffer);F.set(G,L),L+=Ad,F.set(k,L),L+=k.length}v(F)});s.push(b)}else s.push(g.data());e!=null&&(y.group=e),i.push(y)}const a=await Promise.all(s);return{data:MP(a),specs:i}}function Cy(l,e){const i=new fo(l),s={};let n,a=0;for(const p of e){const _=p.name,g=p.dtype,y=p.shape,b=Je(y);let v;if("quantization"in p){const S=p.quantization;if(S.dtype==="uint8"||S.dtype==="uint16"){if(!("min"in S&&"scale"in S))throw new Error("Weight "+p.name+" with quantization "+S.dtype+" doesn't have corresponding metadata min and scale.")}else if(S.dtype==="float16"){if(g!=="float32")throw new Error("Weight "+p.name+" is quantized with "+S.dtype+" which only supports weights of type float32 not "+g+".")}else throw new Error("Weight "+p.name+" has unknown quantization dtype "+S.dtype+". Supported quantization dtypes are: 'uint8', 'uint16', and 'float16'.");const M=Kf[S.dtype],F=i.slice(a,a+b*M),L=S.dtype==="uint8"?new Uint8Array(F):new Uint16Array(F);if(g==="float32")if(S.dtype==="uint8"||S.dtype==="uint16"){v=new Float32Array(L.length);for(let N=0;N<L.length;N++){const k=L[N];v[N]=k*S.scale+S.min}}else if(S.dtype==="float16")n===void 0&&(n=NP()),v=n(L);else throw new Error("Unsupported quantization type "+S.dtype+" for weight type float32.");else if(g==="int32"){if(S.dtype!=="uint8"&&S.dtype!=="uint16")throw new Error("Unsupported quantization type "+S.dtype+" for weight type int32.");v=new Int32Array(L.length);for(let N=0;N<L.length;N++){const k=L[N];v[N]=Math.round(k*S.scale+S.min)}}else throw new Error("Unsupported dtype in weight '"+_+"': "+g);a+=b*M}else if(g==="string"){const S=Je(p.shape);v=[];for(let M=0;M<S;M++){const F=new Uint32Array(i.slice(a,a+Ad))[0];a+=Ad;const L=new Uint8Array(i.slice(a,a+F));v.push(L),a+=F}}else{const S=Kf[g],M=i.slice(a,a+b*S);if(g==="float32")v=new Float32Array(M);else if(g==="int32")v=new Int32Array(M);else if(g==="bool")v=new Uint8Array(M);else if(g==="complex64"){v=new Float32Array(M);const F=new Float32Array(v.length/2),L=new Float32Array(v.length/2);for(let G=0;G<F.length;G++)F[G]=v[G*2],L[G]=v[G*2+1];const N=J0(F,y,"float32"),k=J0(L,y,"float32");s[_]=Yf(N,k),N.dispose(),k.dispose()}else throw new Error("Unsupported dtype in weight '"+_+"': "+g);a+=b*S}g!=="complex64"&&(s[_]=J0(v,y,g))}return s}function MP(l){if(l===null)throw new Error("Invalid input value: "+JSON.stringify(l));let e=0;const i=[];l.forEach(a=>{if(e+=a.byteLength,i.push(a.byteLength===a.buffer.byteLength?a:new a.constructor(a)),!(a instanceof Float32Array||a instanceof Int32Array||a instanceof Uint8Array))throw new Error("Unsupported TypedArray subtype: "+a.constructor.name)});const s=new Uint8Array(e);let n=0;return i.forEach(a=>{s.set(new Uint8Array(a.buffer),n),n+=a.byteLength}),s.buffer}const jf=typeof Buffer<"u"&&(typeof Blob>"u"||typeof atob>"u"||typeof btoa>"u");function Ry(l){return jf?Buffer.byteLength(l,"utf8"):new Blob([l]).size}function PP(l){if(jf)return Buffer.from(l).toString("base64");const e=new Uint8Array(l);let i="";for(let s=0,n=e.length;s<n;s++)i+=String.fromCharCode(e[s]);return btoa(i)}function OP(l){if(jf){const s=Buffer.from(l,"base64");return s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength)}const e=atob(l),i=new Uint8Array(e.length);for(let s=0;s<e.length;++s)i.set([e.charCodeAt(s)],s);return i.buffer}function wP(l){return fo.join(l)}function Iy(l){const e="/";for(l=l.trim();l.endsWith(e);)l=l.slice(0,l.length-1);const i=l.split(e);return i[i.length-1]}function Sy(l,e){const i={modelTopology:l.modelTopology,format:l.format,generatedBy:l.generatedBy,convertedBy:l.convertedBy,weightsManifest:e};return l.signature!=null&&(i.signature=l.signature),l.userDefinedMetadata!=null&&(i.userDefinedMetadata=l.userDefinedMetadata),l.modelInitializer!=null&&(i.modelInitializer=l.modelInitializer),l.initializerSignature!=null&&(i.initializerSignature=l.initializerSignature),l.trainingConfig!=null&&(i.trainingConfig=l.trainingConfig),i}function My(l,e,i){const s={modelTopology:l.modelTopology,format:l.format,generatedBy:l.generatedBy,convertedBy:l.convertedBy};if(l.trainingConfig!=null&&(s.trainingConfig=l.trainingConfig),l.weightsManifest!=null){if(!e)throw new Error("modelJSON has weightsManifest but weightSpecs is null");if(!i)throw new Error("modelJSON has weightsManifest but weightData is null");s.weightSpecs=e,s.weightData=i}return l.signature!=null&&(s.signature=l.signature),l.userDefinedMetadata!=null&&(s.userDefinedMetadata=l.userDefinedMetadata),l.modelInitializer!=null&&(s.modelInitializer=l.modelInitializer),l.initializerSignature!=null&&(s.initializerSignature=l.initializerSignature),s}async function qf(l,e){let i,s;return l.weightsManifest!=null&&([i,s]=await e(l.weightsManifest)),My(l,i,s)}function lh(l){if(l.modelTopology instanceof ArrayBuffer)throw new Error("Expected JSON model topology, received ArrayBuffer.");return{dateSaved:new Date,modelTopologyType:"JSON",modelTopologyBytes:l.modelTopology==null?0:Ry(JSON.stringify(l.modelTopology)),weightSpecsBytes:l.weightSpecs==null?0:Ry(JSON.stringify(l.weightSpecs)),weightDataBytes:l.weightData==null?0:new fo(l.weightData).byteLength}}function Py(l){const e=[];for(const i of l)e.push(...i.weights);return e}function DP(){const l=i=>{let s=i<<13,n=0;for(;!(s&8388608);)n-=8388608,s<<=1;return s&=-8388609,n+=947912704,s|n},e=new Uint32Array(2048);e[0]=0;for(let i=1;i<1024;i++)e[i]=l(i);for(let i=1024;i<2048;i++)e[i]=939524096+(i-1024<<13);return e}function FP(){const l=new Uint32Array(64);l[0]=0,l[31]=1199570944,l[32]=2147483648,l[63]=3347054592;for(let e=1;e<31;e++)l[e]=e<<23;for(let e=33;e<63;e++)l[e]=2147483648+(e-32<<23);return l}function LP(){const l=new Uint32Array(64);for(let e=0;e<64;e++)l[e]=1024;return l[0]=l[32]=0,l}function NP(){const l=DP(),e=FP(),i=LP();return s=>{const n=new ArrayBuffer(4*s.length),a=new Uint32Array(n);for(let p=0;p<s.length;p++){const _=s[p],g=l[i[_>>10]+(_&1023)]+e[_>>10];a[p]=g}return new Float32Array(n)}}class $r{constructor(){this.saveRouters=[],this.loadRouters=[]}static getInstance(){return $r.instance==null&&($r.instance=new $r),$r.instance}static registerSaveRouter(e){$r.getInstance().saveRouters.push(e)}static registerLoadRouter(e){$r.getInstance().loadRouters.push(e)}static getSaveHandlers(e){return $r.getHandlers(e,"save")}static getLoadHandlers(e,i){return $r.getHandlers(e,"load",i)}static getHandlers(e,i,s){const n=[];return(i==="load"?$r.getInstance().loadRouters:$r.getInstance().saveRouters).forEach(a=>{const p=a(e,s);p!==null&&n.push(p)}),n}}const BP=l=>$r.registerSaveRouter(l),kP=l=>$r.registerLoadRouter(l),UP=l=>$r.getSaveHandlers(l),VP=(l,e)=>$r.getLoadHandlers(l,e),Zf="tensorflowjs",Qf=1,$x="models_store",ex="model_info_store";function Oy(){if(!Ue().getBool("IS_BROWSER"))throw new Error("Failed to obtain IndexedDB factory because the current environmentis not a web browser.");const l=typeof window>"u"?self:window,e=l.indexedDB||l.mozIndexedDB||l.webkitIndexedDB||l.msIndexedDB||l.shimIndexedDB;if(e==null)throw new Error("The current browser does not appear to support IndexedDB.");return e}function $f(l){const e=l.result;e.createObjectStore($x,{keyPath:"modelPath"}),e.createObjectStore(ex,{keyPath:"modelPath"})}class Jx{constructor(e){if(this.indexedDB=Oy(),e==null||!e)throw new Error("For IndexedDB, modelPath must not be null, undefined or empty.");this.modelPath=e}async save(e){if(e.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");return this.databaseAction(this.modelPath,e)}async load(){return this.databaseAction(this.modelPath)}databaseAction(e,i){return new Promise((s,n)=>{const a=this.indexedDB.open(Zf,Qf);a.onupgradeneeded=()=>$f(a),a.onsuccess=()=>{const p=a.result;if(i==null){const _=p.transaction($x,"readonly"),g=_.objectStore($x).get(this.modelPath);g.onsuccess=()=>{if(g.result==null)return p.close(),n(new Error("Cannot find model with path '"+this.modelPath+"' in IndexedDB."));s(g.result.modelArtifacts)},g.onerror=y=>(p.close(),n(g.error)),_.oncomplete=()=>p.close()}else{i.weightData=fo.join(i.weightData);const _=lh(i),g=p.transaction(ex,"readwrite");let y=g.objectStore(ex),b;try{b=y.put({modelPath:this.modelPath,modelArtifactsInfo:_})}catch(S){return n(S)}let v;b.onsuccess=()=>{v=p.transaction($x,"readwrite");const S=v.objectStore($x);let M;try{M=S.put({modelPath:this.modelPath,modelArtifacts:i,modelArtifactsInfo:_})}catch(F){return n(F)}M.onsuccess=()=>s({modelArtifactsInfo:_}),M.onerror=F=>{y=g.objectStore(ex);const L=y.delete(this.modelPath);L.onsuccess=()=>(p.close(),n(M.error)),L.onerror=N=>(p.close(),n(M.error))}},b.onerror=S=>(p.close(),n(b.error)),g.oncomplete=()=>{v==null?p.close():v.oncomplete=()=>p.close()}}},a.onerror=p=>n(a.error)})}}Jx.URL_SCHEME="indexeddb://";const wy=l=>Ue().getBool("IS_BROWSER")&&!Array.isArray(l)&&l.startsWith(Jx.URL_SCHEME)?GP(l.slice(Jx.URL_SCHEME.length)):null;$r.registerSaveRouter(wy),$r.registerLoadRouter(wy);function GP(l){return new Jx(l)}function WP(l){return l.startsWith(Jx.URL_SCHEME)?l.slice(Jx.URL_SCHEME.length):l}class zP{constructor(){this.indexedDB=Oy()}async listModels(){return new Promise((e,i)=>{const s=this.indexedDB.open(Zf,Qf);s.onupgradeneeded=()=>$f(s),s.onsuccess=()=>{const n=s.result,a=n.transaction(ex,"readonly"),p=a.objectStore(ex).getAll();p.onsuccess=()=>{const _={};for(const g of p.result)_[g.modelPath]=g.modelArtifactsInfo;e(_)},p.onerror=_=>(n.close(),i(p.error)),a.oncomplete=()=>n.close()},s.onerror=n=>i(s.error)})}async removeModel(e){return e=WP(e),new Promise((i,s)=>{const n=this.indexedDB.open(Zf,Qf);n.onupgradeneeded=()=>$f(n),n.onsuccess=()=>{const a=n.result,p=a.transaction(ex,"readwrite"),_=p.objectStore(ex),g=_.get(e);let y;g.onsuccess=()=>{if(g.result==null)return a.close(),s(new Error("Cannot find model with path '"+e+"' in IndexedDB."));{const b=_.delete(e),v=()=>{y=a.transaction($x,"readwrite");const S=y.objectStore($x).delete(e);S.onsuccess=()=>i(g.result.modelArtifactsInfo),S.onerror=M=>s(g.error)};b.onsuccess=v,b.onerror=S=>(v(),a.close(),s(g.error))}},g.onerror=b=>(a.close(),s(g.error)),p.oncomplete=()=>{y==null?a.close():y.oncomplete=()=>a.close()}},n.onerror=a=>s(n.error)})}}const h0="/",Xl="tensorflowjs_models",Dy="info",HP="model_topology",XP="weight_specs",YP="weight_data",KP="model_metadata";function Fy(l){return{info:[Xl,l,Dy].join(h0),topology:[Xl,l,HP].join(h0),weightSpecs:[Xl,l,XP].join(h0),weightData:[Xl,l,YP].join(h0),modelMetadata:[Xl,l,KP].join(h0)}}function Ly(l){for(const e of Object.values(l))window.localStorage.removeItem(e)}function jP(l){const e=l.split(h0);if(e.length<3)throw new Error("Invalid key format: "+l);return e.slice(1,e.length-1).join(h0)}function qP(l){return l.startsWith(el.URL_SCHEME)?l.slice(el.URL_SCHEME.length):l}class el{constructor(e){if(!Ue().getBool("IS_BROWSER")||typeof window>"u"||typeof window.localStorage>"u")throw new Error("The current environment does not support local storage.");if(this.LS=window.localStorage,e==null||!e)throw new Error("For local storage, modelPath must not be null, undefined or empty.");this.modelPath=e,this.keys=Fy(this.modelPath)}async save(e){if(e.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");{const i=JSON.stringify(e.modelTopology),s=JSON.stringify(e.weightSpecs),n=lh(e),a=fo.join(e.weightData);try{this.LS.setItem(this.keys.info,JSON.stringify(n)),this.LS.setItem(this.keys.topology,i),this.LS.setItem(this.keys.weightSpecs,s),this.LS.setItem(this.keys.weightData,PP(a));const p={format:e.format,generatedBy:e.generatedBy,convertedBy:e.convertedBy,signature:e.signature!=null?e.signature:void 0,userDefinedMetadata:e.userDefinedMetadata!=null?e.userDefinedMetadata:void 0,modelInitializer:e.modelInitializer!=null?e.modelInitializer:void 0,initializerSignature:e.initializerSignature!=null?e.initializerSignature:void 0,trainingConfig:e.trainingConfig!=null?e.trainingConfig:void 0};return this.LS.setItem(this.keys.modelMetadata,JSON.stringify(p)),{modelArtifactsInfo:n}}catch{throw Ly(this.keys),new Error("Failed to save model '"+this.modelPath+"' to local storage: size quota being exceeded is a possible cause of this failure: modelTopologyBytes="+n.modelTopologyBytes+", weightSpecsBytes="+n.weightSpecsBytes+", weightDataBytes="+n.weightDataBytes+".")}}}async load(){const e=JSON.parse(this.LS.getItem(this.keys.info));if(e==null)throw new Error("In local storage, there is no model with name '"+this.modelPath+"'");if(e.modelTopologyType!=="JSON")throw new Error("BrowserLocalStorage does not support loading non-JSON model topology yet.");const i={},s=JSON.parse(this.LS.getItem(this.keys.topology));if(s==null)throw new Error("In local storage, the topology of model '"+this.modelPath+"' is missing.");i.modelTopology=s;const n=JSON.parse(this.LS.getItem(this.keys.weightSpecs));if(n==null)throw new Error("In local storage, the weight specs of model '"+this.modelPath+"' are missing.");i.weightSpecs=n;const a=this.LS.getItem(this.keys.modelMetadata);if(a!=null){const _=JSON.parse(a);i.format=_.format,i.generatedBy=_.generatedBy,i.convertedBy=_.convertedBy,_.signature!=null&&(i.signature=_.signature),_.userDefinedMetadata!=null&&(i.userDefinedMetadata=_.userDefinedMetadata),_.modelInitializer!=null&&(i.modelInitializer=_.modelInitializer),_.initializerSignature!=null&&(i.initializerSignature=_.initializerSignature),_.trainingConfig!=null&&(i.trainingConfig=_.trainingConfig)}const p=this.LS.getItem(this.keys.weightData);if(p==null)throw new Error("In local storage, the binary weight values of model '"+this.modelPath+"' are missing.");return i.weightData=OP(p),i}}el.URL_SCHEME="localstorage://";const Ny=l=>Ue().getBool("IS_BROWSER")&&!Array.isArray(l)&&l.startsWith(el.URL_SCHEME)?ZP(l.slice(el.URL_SCHEME.length)):null;$r.registerSaveRouter(Ny),$r.registerLoadRouter(Ny);function ZP(l){return new el(l)}class QP{constructor(){Te(Ue().getBool("IS_BROWSER"),()=>"Current environment is not a web browser"),Te(typeof window>"u"||typeof window.localStorage<"u",()=>"Current browser does not appear to support localStorage"),this.LS=window.localStorage}async listModels(){const e={},i=Xl+h0,s=h0+Dy;for(let n=0;n<this.LS.length;++n){const a=this.LS.key(n);if(a.startsWith(i)&&a.endsWith(s)){const p=jP(a);e[p]=JSON.parse(this.LS.getItem(a))}}return e}async removeModel(e){e=qP(e);const i=Fy(e);if(this.LS.getItem(i.info)==null)throw new Error("Cannot find model at path '"+e+"'");const s=JSON.parse(this.LS.getItem(i.info));return Ly(i),s}}const $P="model",JP=".json",eO=".weights.bin";function By(l){return new Promise(e=>setTimeout(e)).then(l)}class tl{constructor(e){if(!Ue().getBool("IS_BROWSER"))throw new Error("browserDownloads() cannot proceed because the current environment is not a browser.");e.startsWith(tl.URL_SCHEME)&&(e=e.slice(tl.URL_SCHEME.length)),(e==null||e.length===0)&&(e=$P),this.modelJsonFileName=e+JP,this.weightDataFileName=e+eO}async save(e){if(typeof document>"u")throw new Error("Browser downloads are not supported in this environment since `document` is not present");const i=fo.join(e.weightData),s=window.URL.createObjectURL(new Blob([i],{type:"application/octet-stream"}));if(e.modelTopology instanceof ArrayBuffer)throw new Error("BrowserDownloads.save() does not support saving model topology in binary formats yet.");{const n=[{paths:["./"+this.weightDataFileName],weights:e.weightSpecs}],a=Sy(e,n),p=window.URL.createObjectURL(new Blob([JSON.stringify(a)],{type:"application/json"})),_=this.modelJsonAnchor==null?document.createElement("a"):this.modelJsonAnchor;if(_.download=this.modelJsonFileName,_.href=p,await By(()=>_.dispatchEvent(new MouseEvent("click"))),e.weightData!=null){const g=this.weightDataAnchor==null?document.createElement("a"):this.weightDataAnchor;g.download=this.weightDataFileName,g.href=s,await By(()=>g.dispatchEvent(new MouseEvent("click")))}return{modelArtifactsInfo:lh(e)}}}}tl.URL_SCHEME="downloads://";class tO{constructor(e){if(e==null||e.length<1)throw new Error("When calling browserFiles, at least 1 file is required, but received "+e);this.jsonFile=e[0],this.weightsFiles=e.slice(1)}async load(){return new Promise((e,i)=>{const s=new FileReader;s.onload=n=>{const a=JSON.parse(n.target.result),p=a.modelTopology;if(p==null){i(new Error("modelTopology field is missing from file "+this.jsonFile.name));return}if(a.weightsManifest==null){i(new Error("weightManifest field is missing from file "+this.jsonFile.name));return}if(this.weightsFiles.length===0){e({modelTopology:p});return}const _=qf(a,g=>this.loadWeights(g));e(_)},s.onerror=n=>i("Failed to read model topology and weights manifest JSON from file '"+this.jsonFile.name+"'. BrowserFiles supports loading Keras-style tf.Model artifacts only."),s.readAsText(this.jsonFile)})}loadWeights(e){const i=[],s=[];for(const p of e)i.push(...p.weights),s.push(...p.paths);const n=this.checkManifestAndWeightFiles(e),a=s.map(p=>this.loadWeightsFile(p,n[p]));return Promise.all(a).then(p=>[i,p])}loadWeightsFile(e,i){return new Promise((s,n)=>{const a=new FileReader;a.onload=p=>{const _=p.target.result;s(_)},a.onerror=p=>n("Failed to weights data from file of path '"+e+"'."),a.readAsArrayBuffer(i)})}checkManifestAndWeightFiles(e){const i=[],s=this.weightsFiles.map(a=>Iy(a.name)),n={};for(const a of e)a.paths.forEach(p=>{const _=Iy(p);if(i.indexOf(_)!==-1)throw new Error("Duplicate file basename found in weights manifest: '"+_+"'");if(i.push(_),s.indexOf(_)===-1)throw new Error("Weight file with basename '"+_+"' is not provided.");n[p]=this.weightsFiles[s.indexOf(_)]});if(i.length!==this.weightsFiles.length)throw new Error("Mismatch in the number of files in weights manifest ("+i.length+") and the number of weight files provided ("+this.weightsFiles.length+").");return n}}const iO=l=>Ue().getBool("IS_BROWSER")&&!Array.isArray(l)&&l.startsWith(tl.URL_SCHEME)?rO(l.slice(tl.URL_SCHEME.length)):null;$r.registerSaveRouter(iO);function rO(l="model"){return new tl(l)}function sO(l){return new tO(l)}function ky(l,e,i,s){p(l),i=i??0,s=s??1,_(i,s);let n=0;const a=g=>(g.then(y=>{const b=i+ ++n/l.length*(s-i);return e(b),y}),g);function p(g){Te(g!=null&&Array.isArray(g)&&g.length>0,()=>"promises must be a none empty array")}function _(g,y){Te(g>=0&&g<=1,()=>"Progress fraction must be in range [0, 1], but got startFraction "+g),Te(y>=0&&y<=1,()=>"Progress fraction must be in range [0, 1], but got endFraction "+y),Te(y>=g,()=>"startFraction must be no more than endFraction, but got startFraction "+g+" and endFraction "+y)}return Promise.all(l.map(a))}async function Uy(l,e){e==null&&(e={});const i=e.fetchFunc==null?Ue().platform.fetch:e.fetchFunc,s=l.map(y=>i(y,e.requestInit,{isBinary:!0})),n=0,a=.5,p=(e.onProgress==null?await Promise.all(s):await ky(s,e.onProgress,n,a)).map(y=>y.arrayBuffer()),_=.5,g=1;return e.onProgress==null?await Promise.all(p):await ky(p,e.onProgress,_,g)}async function nO(l,e="",i,s){return Vy(n=>Uy(n,{requestInit:s}))(l,e,i)}function Vy(l){return async(e,i="",s)=>{const n=e.map(()=>!1),a={},p=s!=null?s.map(()=>!1):[],_=[];if(e.forEach((M,F)=>{let L=0;M.weights.forEach(N=>{const k="quantization"in N?N.quantization.dtype:N.dtype,G=Kf[k]*Je(N.shape),H=()=>{n[F]=!0,a[F]==null&&(a[F]=[]),a[F].push({manifestEntry:N,groupOffset:L,sizeBytes:G})};s!=null?s.forEach((z,W)=>{z===N.name&&(H(),p[W]=!0)}):H(),_.push(N.name),L+=G})}),!p.every(M=>M)){const M=s.filter((F,L)=>!p[L]);throw new Error("Could not find weights in manifest with names: "+M.join(", ")+`. 
Manifest JSON has weights with names: `+_.join(", ")+".")}const g=n.reduce((M,F,L)=>(F&&M.push(L),M),[]),y=[];g.forEach(M=>{e[M].paths.forEach(F=>{const L=i+(i.endsWith("/")?"":"/")+F;y.push(L)})});const b=await l(y),v={};let S=0;return g.forEach(M=>{const F=e[M].paths.length,L=new fo(b.slice(S,S+F));a[M].forEach(N=>{const k=L.slice(N.groupOffset,N.groupOffset+N.sizeBytes),G=Cy(k,[N.manifestEntry]);for(const H in G)v[H]=G[H]}),S+=F}),v}}const aO="application/octet-stream",oO="application/json";class Jf{constructor(e,i){if(this.DEFAULT_METHOD="POST",i==null&&(i={}),this.weightPathPrefix=i.weightPathPrefix,this.onProgress=i.onProgress,this.weightUrlConverter=i.weightUrlConverter,i.fetchFunc!=null?(Te(typeof i.fetchFunc=="function",()=>"Must pass a function that matches the signature of `fetch` (see https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)"),this.fetch=i.fetchFunc):this.fetch=Ue().platform.fetch,Te(e!=null&&e.length>0,()=>"URL path for http must not be null, undefined or empty."),Array.isArray(e)&&Te(e.length===2,()=>"URL paths for http must have a length of 2, (actual length is "+e.length+")."),this.path=e,i.requestInit!=null&&i.requestInit.body!=null)throw new Error("requestInit is expected to have no pre-existing body, but has one.");this.requestInit=i.requestInit||{}}async save(e){if(e.modelTopology instanceof ArrayBuffer)throw new Error("BrowserHTTPRequest.save() does not support saving model topology in binary formats yet.");const i=Object.assign({method:this.DEFAULT_METHOD},this.requestInit);i.body=new FormData;const s=[{paths:["./model.weights.bin"],weights:e.weightSpecs}],n=Sy(e,s);if(i.body.append("model.json",new Blob([JSON.stringify(n)],{type:oO}),"model.json"),e.weightData!=null){const p=fo.join(e.weightData);i.body.append("model.weights.bin",new Blob([p],{type:aO}),"model.weights.bin")}const a=await this.fetch(this.path,i);if(a.ok)return{modelArtifactsInfo:lh(e),responses:[a]};throw new Error("BrowserHTTPRequest.save() failed due to HTTP response status "+a.status+".")}async load(){const e=await this.fetch(this.path,this.requestInit);if(!e.ok)throw new Error("Request to "+this.path+" failed with status code "+e.status+". Please verify this URL points to the model JSON of the model to load.");let i;try{i=await e.json()}catch{let p="Failed to parse model JSON of response from "+this.path+".";throw this.path.endsWith(".pb")?p+=" Your path contains a .pb file extension. Support for .pb models have been removed in TensorFlow.js 1.0 in favor of .json models. You can re-convert your Python TensorFlow model using the TensorFlow.js 1.0 conversion scripts or you can convert your.pb models with the 'pb2json'NPM script in the tensorflow/tfjs-converter repository.":p+=" Please make sure the server is serving valid JSON for this request.",new Error(p)}const s=i.modelTopology,n=i.weightsManifest;if(s==null&&n==null)throw new Error("The JSON from HTTP path "+this.path+" contains neither model topology or manifest for weights.");return qf(i,a=>this.loadWeights(a))}async loadWeights(e){const i=Array.isArray(this.path)?this.path[1]:this.path,[s,n]=xO(i),a=this.weightPathPrefix||s,p=Py(e),_=[],g=[];for(const b of e)for(const v of b.paths)this.weightUrlConverter!=null?g.push(this.weightUrlConverter(v)):_.push(a+v+n);this.weightUrlConverter&&_.push(...await Promise.all(g));const y=await Uy(_,{requestInit:this.requestInit,fetchFunc:this.fetch,onProgress:this.onProgress});return[p,y]}}Jf.URL_SCHEME_REGEX=/^https?:\/\//;function xO(l){const e=l.lastIndexOf("/"),i=l.lastIndexOf("?"),s=l.substring(0,e),n=i>e?l.substring(i):"";return[s+"/",n]}function ep(l){return l.match(Jf.URL_SCHEME_REGEX)!=null}const Gy=(l,e)=>{if(typeof fetch>"u"&&(e==null||e.fetchFunc==null))return null;{let i=!0;if(Array.isArray(l)?i=l.every(s=>ep(s)):i=ep(l),i)return tp(l,e)}return null};$r.registerSaveRouter(Gy),$r.registerLoadRouter(Gy);function tp(l,e){return new Jf(l,e)}function lO(l,e){return tp(l,e)}class ip{constructor(e){this.modelArtifacts=e}load(){return this.modelArtifacts}}class Wy{constructor(e){this.saveHandler=e}save(e){return this.saveHandler(e)}}class cO{constructor(e){e.load&&(this.load=()=>Promise.resolve(e.load())),e.save&&(this.save=i=>Promise.resolve(e.save(i)))}}function hO(l,e,i,s){const n=arguments;return new cO(zy(...n))}function zy(l,e,i,s){return arguments.length===1?l.modelTopology!=null||l.weightSpecs!=null?new ip(l):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new ip({modelTopology:l})):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new ip({modelTopology:l,weightSpecs:e,weightData:i,trainingConfig:s}))}function uO(l){return new Wy(l)}function dO(l){return new Wy(l)}const Yl="://";class bn{constructor(){this.managers={}}static getInstance(){return bn.instance==null&&(bn.instance=new bn),bn.instance}static registerManager(e,i){Te(e!=null,()=>"scheme must not be undefined or null."),e.endsWith(Yl)&&(e=e.slice(0,e.indexOf(Yl))),Te(e.length>0,()=>"scheme must not be an empty string.");const s=bn.getInstance();Te(s.managers[e]==null,()=>"A model store manager is already registered for scheme '"+e+"'."),s.managers[e]=i}static getManager(e){const i=bn.getInstance().managers[e];if(i==null)throw new Error("Cannot find model manager for scheme '"+e+"'");return i}static getSchemes(){return Object.keys(bn.getInstance().managers)}}function Cd(l){if(l.indexOf(Yl)===-1)throw new Error("The url string provided does not contain a scheme. Supported schemes are: "+bn.getSchemes().join(","));return{scheme:l.split(Yl)[0],path:l.split(Yl)[1]}}async function Hy(l,e,i=!1){Te(l!==e,()=>"Old path and new path are the same: '"+l+"'");const s=$r.getLoadHandlers(l);Te(s.length>0,()=>"Copying failed because no load handler is found for source URL "+l+"."),Te(s.length<2,()=>"Copying failed because more than one ("+s.length+") load handlers for source URL "+l+".");const n=s[0],a=$r.getSaveHandlers(e);Te(a.length>0,()=>"Copying failed because no save handler is found for destination URL "+e+"."),Te(a.length<2,()=>"Copying failed because more than one ("+s.length+") save handlers for destination URL "+e+".");const p=a[0],_=Cd(l).scheme,g=Cd(l).path,y=_===Cd(l).scheme,b=await n.load();i&&y&&await bn.getManager(_).removeModel(g);const v=await p.save(b);return i&&!y&&await bn.getManager(_).removeModel(g),v.modelArtifactsInfo}async function fO(){const l=bn.getSchemes(),e={};for(const i of l){const s=await bn.getManager(i).listModels();for(const n in s){const a=i+Yl+n;e[a]=s[n]}}return e}async function pO(l){const e=Cd(l);return bn.getManager(e.scheme).removeModel(e.path)}async function mO(l,e){return Hy(l,e,!1)}async function _O(l,e){return Hy(l,e,!0)}var Xy=Object.freeze({__proto__:null,CompositeArrayBuffer:fo,browserFiles:sO,browserHTTPRequest:lO,concatenateArrayBuffers:wP,copyModel:mO,decodeWeights:Cy,encodeWeights:SP,fromMemory:hO,fromMemorySync:zy,getLoadHandlers:VP,getModelArtifactsForJSON:qf,getModelArtifactsForJSONSync:My,getModelArtifactsInfoForJSON:lh,getSaveHandlers:UP,getWeightSpecs:Py,http:tp,isHTTPScheme:ep,listModels:fO,loadWeights:nO,moveModel:_O,registerLoadRouter:kP,registerSaveRouter:BP,removeModel:pO,weightsLoaderFactory:Vy,withSaveHandler:uO,withSaveHandlerSync:dO});function gO(l,e){const i=rt(l,"x","cast");if(!vi(e))throw new Error("Failed to cast to unknown dtype "+e);if(e==="string"&&i.dtype!=="string"||e!=="string"&&i.dtype==="string")throw new Error("Only strings can be casted to strings");const s={x:i},n={dtype:e};return dt.runKernel(Ku,s,n)}const kn=It({cast_:gO});function yO(l,e,i=!1,s=!1){let n=rt(l,"a","matMul"),a=rt(e,"b","matMul");[n,a]=Ks(n,a);const p={a:n,b:a},_={transposeA:i,transposeB:s};return dt.runKernel(xf,p,_)}const po=It({matMul_:yO});function rp(){Ue().set("PROD",!0)}function Va(){return dt}function zr(l,e){return dt.tidy(l,e)}function bO(l){my(l).forEach(e=>e.dispose())}function u0(l){return dt.keep(l)}function sp(l){return dt.setBackend(l)}function vO(){return dt.backendName}function Yy(l,e,i=1){return dt.registerBackend(l,e,i)}function Rd(){return dt.backend}function TO(l){const e={input:rt(l,"input","imag")};return dt.runKernel(kM,e)}const EO=It({imag_:TO});function AO(l){const e={x:rt(l,"x","neg")};return dt.runKernel(vf,e)}const Ky=It({neg_:AO});function CO(l){const e={input:rt(l,"input","real")};return dt.runKernel(zM,e)}const RO=It({real_:CO});function IO(l,e,i){const s=rt(l,"x","transpose");if(e==null&&(e=s.shape.map((p,_)=>_).reverse()),Te(s.rank===e.length,()=>"Error in transpose: rank of input "+s.rank+" must match length of perm "+e+"."),e.forEach(p=>{Te(p>=0&&p<s.rank,()=>"All entries in 'perm' must be between 0 and "+(s.rank-1)+" but got "+e)}),s.rank<=1)return s.clone();const n={x:s},a={perm:e};return s.dtype==="complex64"?zr(()=>{let p=RO(s),_=EO(s);return p=dt.runKernel(ih,{x:p},a),_=dt.runKernel(ih,{x:_},a),i&&(_=Ky(_)),Yf(p,_)}):dt.runKernel(ih,n,a)}const SO=It({transpose_:IO});function Kl(l,e){const i=l.length,s=[];for(let n=0;n<i;n++){const a=i-1-n,p=l[a]||1;(e[e.length-1-n]||1)>1&&p===1&&s.unshift(a)}return s}function jy(l,e){const i=[];for(let s=0;s<e.length;s++){const n=l[l.length-s-1],a=e.length-s-1,p=e[a];(n==null||n===1&&p>1)&&i.unshift(a)}return i}function is(l,e){const i=Math.max(l.length,e.length),s=new Array(i);for(let n=0;n<i;n++){let a=l[l.length-n-1];a==null&&(a=1);let p=e[e.length-n-1];if(p==null&&(p=1),a===1)s[i-n-1]=p;else if(p===1)s[i-n-1]=a;else if(a!==p){const _="Operands could not be broadcast together with shapes "+l+" and "+e+".";throw Error(_)}else s[i-n-1]=a}return s}function MO(l,e,i){if(Fi(l),e!=null&&e.length!==3)throw new Error("tensor3d() requires shape to have three numbers");const s=oh(l,i);if(s.length!==3&&s.length!==1)throw new Error("tensor3d() requires values to be number[][][] or flat/TypedArray");if(s.length===1&&e==null)throw new Error("tensor3d() requires shape to be provided when `values` are a flat array");return xh(l,e,s,i)}let il;function PO(l,e=3){if(e>4)throw new Error("Cannot construct Tensor with more than 4 channels from pixels.");if(l==null)throw new Error("pixels passed to tf.browser.fromPixels() can not be null");let i=!1,s=!1,n=!1,a=!1,p=!1,_=!1;if(l.data instanceof Uint8Array)i=!0;else if(typeof ImageData<"u"&&l instanceof ImageData)s=!0;else if(typeof HTMLVideoElement<"u"&&l instanceof HTMLVideoElement)n=!0;else if(typeof HTMLImageElement<"u"&&l instanceof HTMLImageElement)a=!0;else if(l.getContext!=null)p=!0;else if(typeof ImageBitmap<"u"&&l instanceof ImageBitmap)_=!0;else throw new Error("pixels passed to tf.browser.fromPixels() must be either an HTMLVideoElement, HTMLImageElement, HTMLCanvasElement, ImageData in browser, or OffscreenCanvas, ImageData in webworker or {data: Uint32Array, width: number, height: number}, but was "+l.constructor.name);if(Lf(Df,dt.backendName)!=null){const S={pixels:l},M={numChannels:e};return dt.runKernel(Df,S,M)}const[g,y]=n?[l.videoWidth,l.videoHeight]:[l.width,l.height];let b;if(p)b=l.getContext("2d").getImageData(0,0,g,y).data;else if(s||i)b=l.data;else if(a||n||_){if(il==null)if(typeof document>"u")if(typeof OffscreenCanvas<"u"&&typeof OffscreenCanvasRenderingContext2D<"u")il=new OffscreenCanvas(1,1).getContext("2d");else throw new Error("Cannot parse input in current context. Reason: OffscreenCanvas Context2D rendering is not supported.");else il=document.createElement("canvas").getContext("2d",{willReadFrequently:!0});il.canvas.width=g,il.canvas.height=y,il.drawImage(l,0,0,g,y),b=il.getImageData(0,0,g,y).data}let v;if(e===4)v=new Int32Array(b);else{const S=g*y;v=new Int32Array(S*e);for(let M=0;M<S;M++)for(let F=0;F<e;++F)v[M*e+F]=b[M*4+F]}return MO(v,[y,g,e],"int32")}const np=It({fromPixels_:PO});function OO(l,e){const i=l.shape.length,s=e.shape.length;if(i<1)throw new Error("tf.gatherND() expects the input to be rank 1 or higher, but the rank was "+i+".");if(s<1)throw new Error("tf.gatherND() expects the indices to be rank 1 or higher, but the rank was "+s+".");if(e.dtype!=="int32")throw new Error("tf.gatherND() expects the indices to be int32 type, but the dtype was "+e.dtype+".");if(e.shape[s-1]>i)throw new Error("index innermost dimension length must be <= tensor rank; saw: "+e.shape[s-1]+" vs. "+i);if(Je(l.shape)===0)throw new Error("Requested more than 0 entries, but input is empty. Input shape: "+l.shape+".");const n=e.shape,a=n[n.length-1];let p=1;for(let v=0;v<n.length-1;++v)p*=n[v];const _=l.shape,g=n.slice();g.pop();let y=1;for(let v=a;v<i;++v)y*=_[v],g.push(_[v]);const b=[...Ni(l.shape).map(v=>v/y),1].slice(0,a);return[g,p,y,b]}function qy(l,e,i){const s=e.rank>1?e.shape[e.rank-1]:1,n=e.rank>1?e.rank-1:1,a="Must have updates.shape = indices.shape[:batchDim] + shape[sliceDim:], got updates.shape: "+i.shape+", indices.shape: "+e.shape+", shape: "+l+", sliceDim: "+s+", and batchDim: "+n+".";if(i.rank<n)throw new Error(a+(" update.rank < "+n+". "));if(l.length<s+(i.rank-n))throw new Error(a+(" Output shape length < "+(s+(i.rank-n))));if(i.rank!==n+l.length-s)throw new Error(a+(" update.rank != "+(n+l.length-s)));for(let p=0;p<n;++p)if(i.shape[p]!==e.shape[p])throw new Error(a+(" updates.shape["+p+"] ("+i.shape[p]+") != indices.shape["+p+"] ("+e.shape[p]+")."));for(let p=0;p<i.rank-n;++p)if(i.shape[p+n]!==l[p+s])throw new Error(a+(" updates.shape["+(p+n)+"] ("+i.shape[p+n]+") != shape["+(p+n)+"] ("+l[p+n]+")"))}function Zy(l,e,i){if(e.rank<1)throw new Error("tf.scatterND() expects the indices to be rank 1 or higher, but the rank was "+e.rank+".");if(l.rank<1)throw new Error("tf.scatterND() expects the updates to be rank 1 or higher, but the rank was "+l.rank+".");if(e.dtype!=="int32")throw new Error("The dtype of 'indices' should be int32, but got dtype: "+e.dtype);if(i.length<1)throw new Error("Output rank must be greater or equal to 1, but got shape: "+i);if(i.length===0){if(e.size===0)throw new Error("Indices specified for empty output. indices shape: "+e.shape);if(l.size===0)throw new Error("Updates specified for empty output. updates shape: "+l.shape)}qy(i,e,l)}function wO(l,e,i){const s=e.shape.length,n=s>1?e.shape[s-1]:1,a=i.length;let p=1;for(let v=n;v<a;++v)p*=i[v];const _=n<1?1:n,g=Je(e.shape)/_,y=[...Ni(i.slice(0,n)),1],b=Je(i);return{sliceRank:n,numUpdates:g,sliceSize:p,strides:y,outputSize:b}}const ap=-2,DO=-1;function op(l,e,i){const s=l.shape.length;Te(s===e.length,()=>"Error in slice"+s+"D: Length of begin "+e+" must match the rank of the array ("+s+")."),Te(s===i.length,()=>"Error in slice"+s+"D: Length of size "+i+" must match the rank of the array ("+s+").");for(let n=0;n<s;++n)Te(e[n]+i[n]<=l.shape[n],()=>"Error in slice"+s+"D: begin["+n+"] + size["+n+"] ("+(e[n]+i[n])+") would overflow input.shape["+n+"] ("+l.shape[n]+")")}function FO(l){const e=[];let i=0;for(;l>0;)l&1&&e.push(i),l/=2,i++;return e}function xp(l,e,i){const s=[];for(let n=0;n<l.length;n++)s[n]=Math.ceil((e[n]-l[n])/i[n]);return s}function Qy(l,e,i,s){const n=[...l];for(let a=n.length;a<s.length;a++)n.push(1);for(let a=0;a<i;a++)a===0?n[e]=1:(n.splice(e,0,1),n.pop());return n}function $y(l,e,i){return i<=l?i:i-(e-1)}function Jy(l,e){const i=[];for(let s=0;s<l;s++)i.push(e+s);return i}function LO(l,e,i,s,n,a,p,_,g){const y=l.length;let b=new Array(y),v=new Array(y),S=new Array(y);if(e.length&&i>0){const M=e[0],F=i+1;b=eb(p,M,F,s,l),v=tb(_,M,F,n,l),S=Qy(a,M,F,l)}else for(let M=0;M<y;M++)b[M]=rb(p,s,a,l,M,g),v[M]=sb(_,n,a,l,M,g),S[M]=ib(a,M,g);return{begin:b,end:v,strides:S}}function eb(l,e,i,s,n){const a=[...n],p=Jy(i,e);for(let _=0;_<a.length;_++)if(p.indexOf(_)>-1)a[_]=0;else{const g=$y(e,i,_);let y=s[g];l&1<<g&&(y=0),a[_]=y}return a}function tb(l,e,i,s,n){const a=[...n],p=Jy(i,e);for(let _=0;_<a.length;_++)if(p.indexOf(_)>-1)a[_]=Number.MAX_SAFE_INTEGER;else{const g=$y(e,i,_);let y=s[g];l&1<<g&&(y=Number.MAX_SAFE_INTEGER),a[_]=y}for(let _=0;_<a.length;_++){const g=n[_];a[_]<0&&(a[_]+=g),a[_]=kt(0,a[_],n[_])}return a}function ib(l,e,i){let s=l[e];return(i&1<<e||s==null)&&(s=1),s}function rb(l,e,i,s,n,a){let p=e[n];const _=i[n]||1;(l&1<<n||a&1<<n||p==null)&&(_>0?p=Number.MIN_SAFE_INTEGER:p=Number.MAX_SAFE_INTEGER);const g=s[n];return p<0&&(p+=g),p=kt(0,p,g-1),p}function sb(l,e,i,s,n,a){let p=e[n];const _=i[n]||1;(l&1<<n||a&1<<n||p==null)&&(_>0?p=Number.MAX_SAFE_INTEGER:p=Number.MIN_SAFE_INTEGER);const g=s[n];return p<0&&(p+=g),_>0?p=kt(0,p,g):p=kt(-1,p,g-1),p}function lp(l,e,i){let s=i.length;for(let n=0;n<i.length;n++)if(i[n]>1){s=n;break}for(let n=s+1;n<i.length;n++)if(e[n]>0||i[n]!==l[n])return!1;return!0}function cp(l,e){let i=l.length>0?l[l.length-1]:1;for(let s=0;s<l.length-1;s++)i+=l[s]*e[s];return i}function hp(l,e,i){let s;const n=l.shape.length;typeof e=="number"?s=[e,...new Array(n-1).fill(0)]:e.length<n?s=e.concat(new Array(n-e.length).fill(0)):s=e.slice(),s.forEach(p=>{Te(p!==-1,()=>"slice() does not support negative begin indexing.")});let a;return i==null?a=new Array(n).fill(-1):typeof i=="number"?a=[i,...new Array(n-1).fill(-1)]:i.length<n?a=i.concat(new Array(n-i.length).fill(-1)):a=i,a=a.map((p,_)=>p>=0?p:(Te(p===-1,()=>"Negative size values should be exactly -1 but got "+p+" for the slice() size at index "+_+"."),l.shape[_]-s[_])),[s,a]}function up(l,e,i,s,n,a,p,_,g){let y;if(s==null?(y=new Array(e.length),y.fill(1)):y=s,p!=null&&p&p-1)throw new Error("Multiple ellipses in slice is not allowed.");let b=!1;const v={dims:y.length,numAddAxisAfterEllipsis:0,begin:e.slice(),end:i.slice(),strides:y.slice(),beginMask:n,endMask:a,ellipsisMask:p,newAxisMask:_,shrinkAxisMask:g};for(let G=0;G<v.dims;G++)b&&1<<G&_&&v.numAddAxisAfterEllipsis++,1<<G&p&&(b=!0);b||(v.ellipsisMask|=1<<v.dims,v.dims++);const S={dims:l.length,beginMask:0,endMask:0,beginValid:!1,endValid:!1};NO(v,S);let M=!0,F=!0,L=!0;const N=[],k=[];for(let G=0;G<l.length;++G){if(S.strides[G]===0)throw Error("strides["+G+"] must be non-zero");const H=!!(S.shrinkAxisMask&1<<G),z=l[G];if(z===-1){N.push(H?1:-1);continue}const W=[S.beginMask&1<<G,S.endMask&1<<G],Y=[S.strides[G]>0?0:-1,S.strides[G]>0?z:z-1];if(H&&S.strides[G]<=0)throw Error("only stride 1 allowed on non-range indexing.");L=L&&S.strides[G]===1;const Z=!!(S.beginMask&1<<G&&S.endMask&1<<G);if(S.beginValid&&S.endValid){if(H){const oe=S.begin[G]<0?z+S.begin[G]:S.begin[G];if(S.begin[G]=oe,S.end[G]=S.begin[G]+1,oe<0||oe>=z)throw Error("slice index "+S.begin[G]+" of dimension "+G+" out of bounds.")}else S.begin[G]=nb(S.begin[G],0,S.strides[G],z,W,Y),S.end[G]=nb(S.end[G],1,S.strides[G],z,W,Y);const $=S.strides[G]===1&&S.begin[G]===0&&S.end[G]===z;M=M&&$,F=F&&(G===0&&S.strides[G]===1||$)}else M=M&&S.strides[G]===1&&Z,F=F&&(G===0&&S.strides[G]===1||Z);let Q,se=!1;if(S.beginValid&&S.endValid?(Q=S.end[G]-S.begin[G],se=!0):H?(Q=1,se=!0):Z&&z>=0&&(S.strides[G]<0?Q=-z:Q=z,se=!0),se){let $;Q===0||Q<0!=S.strides[G]<0?$=0:$=Math.trunc(Q/S.strides[G])+(Q%S.strides[G]!==0?1:0),N.push($)}else N.push(-1)}for(let G=0;G<S.finalShapeGatherIndices.length;++G){const H=S.finalShapeGatherIndices[G];H>=0?k.push(N[H]):H===ap&&k.push(1)}return{finalShapeSparse:k.filter((G,H)=>S.finalShapeGatherIndices[H]!==ap),finalShape:k,isIdentity:M,sliceDim0:F,isSimpleSlice:L,begin:S.begin,end:S.end,strides:S.strides}}function NO(l,e){e.beginMask=0,e.endMask=0,e.shrinkAxisMask=0;let i=0;e.beginValid=l.begin!=null,e.endValid=l.end!=null,e.begin=new Array(e.dims),e.end=new Array(e.dims),e.strides=new Array(e.dims),e.finalShapeGatherIndices=[],e.finalShapeGatherIndicesSparse=[],e.inputShapeGatherIndicesSparse=new Array(e.dims);for(let s=0;s<l.dims;s++)if(1<<s&l.ellipsisMask){const n=Math.min(e.dims-(l.dims-s)+1+l.numAddAxisAfterEllipsis,e.dims);for(;i<n;i++)e.begin[i]=0,e.end[i]=0,e.strides[i]=1,e.beginMask|=1<<i,e.endMask|=1<<i,e.finalShapeGatherIndices.push(i),e.finalShapeGatherIndicesSparse.push(-1),e.inputShapeGatherIndicesSparse[i]=s}else if(1<<s&l.newAxisMask)e.finalShapeGatherIndices.push(ap),e.finalShapeGatherIndicesSparse.push(-1);else{if(i===e.begin.length)throw Error("Index out of range using input dim "+i+"; input has only "+e.dims+" dims, "+e.begin.length+".");l.begin!=null&&(e.begin[i]=l.begin[s]),l.end!=null&&(e.end[i]=l.end[s]),e.strides[i]=l.strides[s],l.beginMask&1<<s&&(e.beginMask|=1<<i),l.endMask&1<<s&&(e.endMask|=1<<i),l.shrinkAxisMask&1<<s?(e.finalShapeGatherIndices.push(DO),e.finalShapeGatherIndicesSparse.push(-1),e.shrinkAxisMask|=1<<i):(e.finalShapeGatherIndices.push(i),e.finalShapeGatherIndicesSparse.push(s)),e.inputShapeGatherIndicesSparse[i]=s,i++}}function nb(l,e,i,s,n,a){if(n[e])return i>0?a[e]:a[e+1&1];{const p=l<0?s+l:l;return p<a[0]?a[0]:p>a[1]?a[1]:p}}var BO=Object.freeze({__proto__:null,assertParamsValid:op,computeFlatOffset:cp,computeOutShape:xp,getNormalizedAxes:LO,isSliceContinous:lp,maskToAxes:FO,parseSliceParams:hp,sliceInfo:up,startForAxis:rb,startIndicesWithElidedDims:eb,stopForAxis:sb,stopIndicesWithElidedDims:tb,stridesForAxis:ib,stridesWithElidedDims:Qy});function kO(l,e){let i=rt(l,"a","add"),s=rt(e,"b","add");[i,s]=Ks(i,s);const n={a:i,b:s};return dt.runKernel(Yx,n)}const Hr=It({add_:kO});function UO(l,e){let i=rt(l,"a","floorDiv"),s=rt(e,"b","floorDiv");[i,s]=Ks(i,s);const n={a:i,b:s};return dt.runKernel(NM,n)}const VO=It({floorDiv_:UO});function GO(l,e){let i=rt(l,"a","div"),s=rt(e,"b","div");if([i,s]=Ks(i,s),i.dtype==="int32"&&s.dtype==="int32")return VO(i,s);const n={a:i,b:s},a={};return dt.runKernel(Zu,n,a)}const us=It({div_:GO});function WO(l,e){let i=rt(l,"a","mul"),s=rt(e,"b","mul");[i,s]=Ks(i,s);const n={a:i,b:s};return dt.runKernel(ad,n)}const js=It({mul_:WO});function zO(l){const e=rt(l,"x","abs");if(e.dtype==="complex64"){const i={x:e};return dt.runKernel(MM,i)}else{const i={x:e};return dt.runKernel(gt,i)}}const tx=It({abs_:zO});function HO(l){Te(Array.isArray(l),()=>"The argument passed to tf.addN() must be a list of tensors"),Te(l.length>=1,()=>"Must pass at least one tensor to tf.addN(), but got "+l.length);const e=l.map((n,a)=>rt(n,"tensors"+a,"addN")),i=e[0];e.forEach(n=>{if(n.dtype!==i.dtype)throw new Error("All tensors passed to tf.addN() must have the same dtype")}),e.forEach(n=>{if(!qt(n.shape,i.shape))throw new Error("All tensors passed to tf.addN() must have the same shape")});const s=e;return dt.runKernel(Xu,s)}const XO=It({addN_:HO});function YO(l,e){let i=rt(l,"a","atan2"),s=rt(e,"b","atan2");[i,s]=Ks(i,s);const n={a:i,b:s};return dt.runKernel(Yu,n)}const KO=It({atan2_:YO});function jO(l,e,i,s,n="NHWC",a){const p=l[3],_=[...e,p],g=dh(n);return mo(l,_,i,a,s,null,null,g)}function jl(l,e,i,s,n,a,p="channelsLast"){const[_,g]=ch(e);let y;if(p==="channelsLast")y=[_,g,l[3],l[3]];else if(p==="channelsFirst")y=[_,g,l[1],l[1]];else throw new Error("Unknown dataFormat "+p);return mo(l,y,i,s,n,a,!1,p)}function qO(l,e,i,s,n,a,p="NDHWC"){const[_,g,y]=fp(e);let b,v;if(p==="NDHWC")v="channelsLast",b=[_,g,y,l[4],l[4]];else if(p==="NCDHW")v="channelsFirst",b=[_,g,y,l[1],l[1]];else throw new Error("Unknown dataFormat "+p);return ab(l,b,i,s,n,!1,v,a)}function mo(l,e,i,s,n,a,p=!1,_="channelsLast"){let[g,y,b,v]=[-1,-1,-1,-1];if(_==="channelsLast")[g,y,b,v]=l;else if(_==="channelsFirst")[g,v,y,b]=l;else throw new Error("Unknown dataFormat "+_);const[S,M,,F]=e,[L,N]=ch(i),[k,G]=ch(s),H=ql(S,k),z=ql(M,G),{padInfo:W,outHeight:Y,outWidth:Z}=$O(n,y,b,L,N,H,z,a,_),Q=p?F*v:F;let se;return _==="channelsFirst"?se=[g,Q,Y,Z]:_==="channelsLast"&&(se=[g,Y,Z,Q]),{batchSize:g,dataFormat:_,inHeight:y,inWidth:b,inChannels:v,outHeight:Y,outWidth:Z,outChannels:Q,padInfo:W,strideHeight:L,strideWidth:N,filterHeight:S,filterWidth:M,effectiveFilterHeight:H,effectiveFilterWidth:z,dilationHeight:k,dilationWidth:G,inShape:l,outShape:se,filterShape:e}}function ab(l,e,i,s,n,a=!1,p="channelsLast",_){let[g,y,b,v,S]=[-1,-1,-1,-1,-1];if(p==="channelsLast")[g,y,b,v,S]=l;else if(p==="channelsFirst")[g,S,y,b,v]=l;else throw new Error("Unknown dataFormat "+p);const[M,F,L,,N]=e,[k,G,H]=fp(i),[z,W,Y]=fp(s),Z=ql(M,z),Q=ql(F,W),se=ql(L,Y),{padInfo:$,outDepth:oe,outHeight:ue,outWidth:de}=JO(n,y,b,v,k,G,H,Z,Q,se,_),ye=a?N*S:N;let _e;return p==="channelsFirst"?_e=[g,ye,oe,ue,de]:p==="channelsLast"&&(_e=[g,oe,ue,de,ye]),{batchSize:g,dataFormat:p,inDepth:y,inHeight:b,inWidth:v,inChannels:S,outDepth:oe,outHeight:ue,outWidth:de,outChannels:ye,padInfo:$,strideDepth:k,strideHeight:G,strideWidth:H,filterDepth:M,filterHeight:F,filterWidth:L,effectiveFilterDepth:Z,effectiveFilterHeight:Q,effectiveFilterWidth:se,dilationDepth:z,dilationHeight:W,dilationWidth:Y,inShape:l,outShape:_e,filterShape:e}}function ZO(l,e,i,s,n){s==null&&(s=dp(l,e,i));const a=l[0],p=l[1],_=hh((a-e+2*s)/i+1,n),g=hh((p-e+2*s)/i+1,n);return[_,g]}function QO(l,e,i,s,n,a){n==null&&(n=dp(l,e[0],s[0]));const p=[0,0,0,i];for(let _=0;_<3;_++)l[_]+2*n>=e[_]&&(p[_]=hh((l[_]-e[_]+2*n)/s[_]+1,a));return p}function dp(l,e,i,s=1){const n=ql(e,s);return Math.floor((l[0]*(i-1)-i+n)/2)}function ch(l){return typeof l=="number"?[l,l,l]:l.length===2?[l[0],l[1],1]:l}function fp(l){return typeof l=="number"?[l,l,l]:l}function ql(l,e){return e<=1?l:l+(l-1)*(e-1)}function $O(l,e,i,s,n,a,p,_,g){let y,b,v;if(typeof l=="number"){y={top:l,bottom:l,left:l,right:l,type:l===0?"VALID":"NUMBER"};const S=ZO([e,i],a,s,l,_);b=S[0],v=S[1]}else if(l==="same"){b=Math.ceil(e/s),v=Math.ceil(i/n);const S=Math.max(0,(b-1)*s+a-e),M=Math.max(0,(v-1)*n+p-i),F=Math.floor(S/2),L=S-F,N=Math.floor(M/2),k=M-N;y={top:F,bottom:L,left:N,right:k,type:"SAME"}}else if(l==="valid")y={top:0,bottom:0,left:0,right:0,type:"VALID"},b=Math.ceil((e-a+1)/s),v=Math.ceil((i-p+1)/n);else if(typeof l=="object"){const S=g==="channelsLast"?l[1][0]:l[2][0],M=g==="channelsLast"?l[1][1]:l[2][1],F=g==="channelsLast"?l[2][0]:l[3][0],L=g==="channelsLast"?l[2][1]:l[3][1];y={top:S,bottom:M,left:F,right:L,type:S===0&&M===0&&F===0&&L===0?"VALID":"EXPLICIT"},b=hh((e-a+S+M)/s+1,_),v=hh((i-p+F+L)/n+1,_)}else throw Error("Unknown padding parameter: "+l);return{padInfo:y,outHeight:b,outWidth:v}}function JO(l,e,i,s,n,a,p,_,g,y,b){let v,S,M,F;if(l==="valid"&&(l=0),typeof l=="number"){v={top:l,bottom:l,left:l,right:l,front:l,back:l,type:l===0?"VALID":"NUMBER"};const L=QO([e,i,s,1],[_,g,y],1,[n,a,p],l,b);S=L[0],M=L[1],F=L[2]}else if(l==="same"){S=Math.ceil(e/n),M=Math.ceil(i/a),F=Math.ceil(s/p);const L=(S-1)*n+_-e,N=(M-1)*a+g-i,k=(F-1)*p+y-s,G=Math.floor(L/2),H=L-G,z=Math.floor(N/2),W=N-z,Y=Math.floor(k/2),Z=k-Y;v={top:z,bottom:W,left:Y,right:Z,front:G,back:H,type:"SAME"}}else throw Error("Unknown padding parameter: "+l);return{padInfo:v,outDepth:S,outHeight:M,outWidth:F}}function hh(l,e){if(!e)return Math.trunc(l);switch(e){case"round":return Math.round(l);case"ceil":return Math.ceil(l);case"floor":return Math.floor(l);default:throw new Error("Unknown roundingMode "+e)}}function uh(l){const[e,i,s]=ch(l);return e===1&&i===1&&s===1}function ta(l,e){return uh(l)||uh(e)}function pp(l){return ch(l).every(e=>e>0)}function dh(l){if(l==="NHWC")return"channelsLast";if(l==="NCHW")return"channelsFirst";throw new Error("Unknown dataFormat "+l)}function d0(l,e,i){if(i!=null){if(typeof e=="string")throw Error("Error in "+l+": pad must be an integer when using dimRoundingMode "+i+" but got pad "+e+".");if(typeof e=="number")Te(nr(e),()=>"Error in "+l+": pad must be an integer when using dimRoundingMode "+i+" but got pad "+e+".");else if(typeof e=="object")e.forEach(s=>{s.forEach(n=>{Te(nr(n),()=>"Error in "+l+": pad must be an integer when using dimRoundingMode "+i+" but got pad "+n+".")})});else throw Error("Error in "+l+": Unknown padding parameter: "+e)}}function ew(l,e){const i={x:rt(l,"x","reshape","string_or_numeric")},s={shape:e};return dt.runKernel(Rf,i,s)}const ti=It({reshape_:ew});function tw(l,e,i,s,n){const a=rt(l,"x","avgPool","float32"),p=1;Te(ta(i,p),()=>"Error in avgPool: Either strides or dilations must be 1. Got strides "+i+" and dilations '"+p+"'");let _=a,g=!1;a.rank===3&&(g=!0,_=ti(a,[1,a.shape[0],a.shape[1],a.shape[2]])),Te(_.rank===4,()=>"Error in avgPool: x must be rank 4 but got rank "+_.rank+"."),d0("avgPool",s,n);const y={x:_},b={filterSize:e,strides:i,pad:s,dimRoundingMode:n};let v=dt.runKernel(of,y,b);return v=kn(v,a.dtype),g?ti(v,[v.shape[1],v.shape[2],v.shape[3]]):v}const mp=It({avgPool_:tw});function iw(l){const e={x:rt(l,"x","clone","string_or_numeric")};return dt.runKernel(Ju,e)}const Id=It({clone_:iw});function rw(l,e=0){Te(l.length>=1,()=>"Pass at least one tensor to concat");const i=Ay(l,"tensors","concat","string_or_numeric");if(i[0].dtype==="complex64"&&i.forEach(a=>{if(a.dtype!=="complex64")throw new Error(`Cannot concatenate complex64 tensors with a tensor
          with dtype `+a.dtype+". ")}),i.length===1)return Id(i[0]);const s=i,n={axis:e};return dt.runKernel(lf,s,n)}const Zl=It({concat_:rw});function sw(l){const e={x:rt(l,"x","sigmoid","float32")};return dt.runKernel(hd,e)}const fh=It({sigmoid_:sw});function nw(l,e,i){const s=rt(l,"x","slice","string_or_numeric");if(s.rank===0)throw new Error("Slicing scalar is not possible");const n={x:s},a={begin:e,size:i};return dt.runKernel(Sf,n,a)}const Or=It({slice_:nw});function aw(l,e,i){const s=rt(l,"x","batchToSpaceND"),n=e.reduce((_,g)=>_*g);Te(s.rank>=1+e.length,()=>"input rank is "+s.rank+" but should be > than blockShape.length "+e.length),Te(i.length===e.length,()=>"crops.length is "+i.length+" but should be equal to blockShape.length  "+e.length),Te(s.shape[0]%n===0,()=>"input tensor batch is "+s.shape[0]+" but is not divisible by the product of the elements of blockShape "+e.join(" * ")+" === "+n);const a={x:s},p={blockShape:e,crops:i};return dt.runKernel(RM,a,p)}const ow=It({batchToSpaceND_:aw});function xw(l,e,i){const s=rt(l,"x","bincount"),n=rt(e,"weights","bincount");Te(s.dtype==="int32",()=>"Error in bincount: input dtype must be int32, but got "+s.dtype),Te(i>=0,()=>"size must be non-negative, but got "+i+"."),Te(n.size===s.size||n.size===0,()=>"Error in bincount: weights must have the same size as input or0-length, but got input shape: "+s.shape+", weights shape: "+n.shape+".");const a={x:s,weights:n},p={size:i};return dt.runKernel(IM,a,p)}const lw=It({bincount_:xw});function cw(l,e){let i=rt(l,"broadcastTo","x");const s=i.shape;if(xt(e),e.length<i.rank)throw new Error("broadcastTo(): shape.length="+e.length+" < input.rank="+i.rank+".");if(e.length>i.rank){const g=i.shape.slice();for(;g.length<e.length;)g.unshift(1);i=ti(i,g)}const n=i.shape,a=Array.from(e);for(let g=e.length-1;g>=0;g--)if(n[g]===e[g])a[g]=1;else if(i.shape[g]!==1)throw new Error("broadcastTo(): ["+s+"] cannot be broadcast to ["+e+"].");if(a.map((g,y)=>g>1?y:-1).filter(g=>g>=0).length===0)return Id(i);const p={x:i},_={reps:a};return dt.runKernel(fd,p,_)}const Sd=It({broadcastTo_:cw});function Jr(l,e="float32",i){return e=e||"float32",xt(l),new Wl(l,e,i)}function _p(l,e,i){xt(l),i=i||ar(e);const s={shape:l,value:e,dtype:i};return dt.runKernel(pf,{},s)}function hw(l,e,i){const s=rt(l,"x","clipByValue");if(Te(e<=i,()=>"Error in clip: min ("+e+") must be less than or equal to max ("+i+")."),e===i)return _p(s.shape,e,s.dtype);const n={x:s},a={clipValueMin:e,clipValueMax:i};return dt.runKernel(ju,n,a)}const ob=It({clipByValue_:hw});function uw(l,e){return Zl(l,e)}const ph=It({concat2d_:uw});function dw(l,e){return Zl(l,e)}const fw=It({concat3d_:dw});function pw(l,e,i,s,n="NHWC",a=[1,1],p){const _=rt(l,"x","conv2d","float32"),g=rt(e,"filter","conv2d","float32");let y=_,b=!1;_.rank===3&&(b=!0,y=ti(_,[1,_.shape[0],_.shape[1],_.shape[2]])),Te(y.rank===4,()=>"Error in conv2d: input must be rank 4, but got rank "+y.rank+"."),Te(g.rank===4,()=>"Error in conv2d: filter must be rank 4, but got rank "+g.rank+"."),d0("conv2d",s,p);const v=n==="NHWC"?y.shape[3]:y.shape[1];Te(v===g.shape[2],()=>"Error in conv2d: depth of input ("+v+") must match input depth for filter "+g.shape[2]+"."),Te(ta(i,a),()=>"Error in conv2D: Either strides or dilations must be 1. Got strides "+i+" and dilations '"+a+"'"),Te(pp(a),()=>"Error in conv2D: Dilated rates should be larger than 0."),Te(pp(i),()=>"Error in conv2D: Strides should be larger than 0.");const S={x:y,filter:g},M={strides:i,pad:s,dataFormat:n,dilations:a,dimRoundingMode:p},F=dt.runKernel(cf,S,M);return b?ti(F,[F.shape[1],F.shape[2],F.shape[3]]):F}const xb=It({conv2d_:pw});function mw(l,e,i,s,n,a="NHWC",p){Te(l.length===e.rank,()=>"Length of inShape ("+l.length+") and rank of dy ("+e.rank+") must match");let _=l,g=e,y=!1;e.rank===3&&(y=!0,g=ti(e,[1,e.shape[0],e.shape[1],e.shape[2]]),_=[1,l[0],l[1],l[2]]),Te(_.length===4,()=>"Error in conv2dDerInput: inShape must be length 4, but got length "+_.length+"."),Te(g.rank===4,()=>"Error in conv2dDerInput: dy must be rank 4, but got rank "+g.rank),Te(i.rank===4,()=>"Error in conv2dDerInput: filter must be rank 4, but got rank "+i.rank);const b=a==="NHWC"?_[3]:_[1],v=a==="NHWC"?g.shape[3]:g.shape[1];Te(b===i.shape[2],()=>"Error in conv2dDerInput: depth of input ("+b+") must match input depth for filter "+i.shape[2]+"."),Te(v===i.shape[3],()=>"Error in conv2dDerInput: depth of output ("+v+") must match output depth for filter "+i.shape[3]+"."),d0("conv2dDerInput",n,p);const S={dy:g,filter:i},M={strides:s,pad:n,dataFormat:a,dimRoundingMode:p,inputShape:_},F=dt.runKernel(OM,S,M);return y?ti(F,[F.shape[1],F.shape[2],F.shape[3]]):F}const _w=It({conv2DBackpropInput_:mw});function gw(l){const e={x:rt(l,"x","cos","float32")};return dt.runKernel(qu,e)}const yw=It({cos_:gw});function bw(l,e,i="NHWC"){const s=rt(l,"x","depthToSpace","float32"),n=i==="NHWC"?s.shape[1]:s.shape[2],a=i==="NHWC"?s.shape[2]:s.shape[3],p=i==="NHWC"?s.shape[3]:s.shape[1];Te(e>1,()=>"blockSize should be > 1 for depthToSpace, but was: "+e),Te(n*e>=0,()=>`Negative dimension size caused by overflow when multiplying
    `+n+" and "+e+`  for depthToSpace with input shape
    `+s.shape),Te(a*e>=0,()=>`Negative dimension size caused by overflow when multiplying
    `+a+" and "+e+` for depthToSpace with input shape
        `+s.shape),Te(p%(e*e)===0,()=>"Dimension size must be evenly divisible by "+e*e+" but is "+p+" for depthToSpace with input shape "+s.shape);const _={x:s},g={blockSize:e,dataFormat:i};return dt.runKernel(uf,_,g)}const vw=It({depthToSpace_:bw});function Tw(l,e,i,s,n="NHWC",a=[1,1],p){const _=rt(l,"x","depthwiseConv2d","float32"),g=rt(e,"filter","depthwiseConv2d","float32");let y=_,b=!1;_.rank===3&&(b=!0,y=ti(_,[1,_.shape[0],_.shape[1],_.shape[2]])),Te(y.rank===4,()=>"Error in depthwiseConv2d: input must be rank 4, but got rank "+y.rank+"."),Te(g.rank===4,()=>"Error in depthwiseConv2d: filter must be rank 4, but got rank "+g.rank+".");const v=n==="NHWC"?y.shape[3]:y.shape[1];Te(v===g.shape[2],()=>"Error in depthwiseConv2d: number of input channels ("+v+") must match the inChannels dimension in filter "+g.shape[2]+"."),d0("depthwiseConv2d",s,p);const S={x:y,filter:g},M={strides:i,pad:s,dataFormat:n,dilations:a,dimRoundingMode:p},F=dt.runKernel(df,S,M);return b?ti(F,[F.shape[1],F.shape[2],F.shape[3]]):F}const Md=It({depthwiseConv2d_:Tw});function Ew(l,e,i){const s=rt(e,"a","where"),n=rt(i,"b","where"),a=rt(l,"condition","where","bool"),p=is(is(a.shape,s.shape),n.shape),_=Sd(a,p),g=Sd(s,p),y=Sd(n,p),b={condition:_,t:g,e:y};return dt.runKernel(KM,b)}const lb=It({where_:Ew});function Aw(l){const e={x:rt(l,"x","zerosLike")};return dt.runKernel(wf,e)}const Cw=It({zerosLike_:Aw});function Rw(l,...e){const i=e.map((n,a)=>rt(n,"tensors"+a,"einsum")),s={equation:l};return dt.runKernel(FM,i,s)}const mh=It({einsum_:Rw});function Iw(l){const e={x:rt(l,"x","elu","float32")};return dt.runKernel(Xg,e)}const Sw=It({elu_:Iw});function gp(l,e){for(let i=0;i<l.length;++i)if(l[l.length-i-1]!==e-1-i)return!1;return!0}function cb(l,e,i){const s=l.length+e.length,n=[];let a=0,p=0;for(let _=0;_<s;_++)i.indexOf(_)===-1?n.push(l[a++]):n.push(e[p++]);return n}function Fo(l,e){const i=[],s=l.length;for(let a=0;a<s;a++)e.indexOf(a)===-1&&i.push(l[a]);const n=e.map(a=>l[a]);return[i,n]}function f0(l,e){const i=e.map(s=>1);return cb(l,i,e)}function ix(l,e,i){Te(gp(e,i),()=>l+" supports only inner-most axes for now. Got axes "+e+" and rank-"+i+" input.")}function rx(l,e){if(gp(l,e))return null;const i=[];for(let s=0;s<e;++s)l.indexOf(s)===-1&&i.push(s);return l.forEach(s=>i.push(s)),i}function Mw(l){return l.map((e,i)=>[i,e]).sort((e,i)=>e[1]-i[1]).map(e=>e[0])}function sx(l,e){const i=[];for(let s=e-l;s<e;++s)i.push(s);return i}function Pw(l,e=null,i=!1){const s={x:rt(l,"x","max")},n={reductionIndices:e,keepDims:i};return dt.runKernel(_f,s,n)}const Pd=It({max_:Pw});function Ow(l,e=null,i=!1){const s={x:rt(l,"x","min")},n={axis:e,keepDims:i};return dt.runKernel(bf,s,n)}const _h=It({min_:Ow});function ww(l,e){let i=rt(l,"base","pow"),s=rt(e,"exp","pow");[i,s]=Ks(i,s);const n={a:i,b:s};return dt.runKernel(od,n)}const Dw=It({pow_:ww});function p0(l,e){if((Ua(l)&&e!=="string"||Array.isArray(l))&&e!=="complex64")throw new Error("Error creating a new Scalar: value must be a primitive (number|boolean|string)");if(e==="string"&&Ua(l)&&!(l instanceof Uint8Array))throw new Error("When making a scalar from encoded string, the value must be `Uint8Array`.");return xh(l,[],[],e)}function Fw(l){const e={x:rt(l,"x","sqrt","float32")};return dt.runKernel(ud,e)}const yp=It({sqrt_:Fw});function Lw(l){const e=rt(l,"x","square"),i={};return dt.runKernel("Square",{x:e},i)}const gh=It({square_:Lw});function Nw(l,e=null,i=!1){let s=rt(l,"x","sum");s.dtype==="bool"&&(s=kn(s,"int32"));const n={x:s},a={axis:e,keepDims:i};return dt.runKernel(Mf,n,a)}const vn=It({sum_:Nw});function Bw(l,e="euclidean",i=null,s=!1){l=rt(l,"x","norm");const n=hb(l,e,i);let a=n.shape;if(s){const p=jt(i,l.shape);a=f0(n.shape,p)}return ti(n,a)}function hb(l,e,i=null){if(l.rank===0)return tx(l);if(l.rank!==1&&i===null)return hb(ti(l,[-1]),e,i);if(l.rank===1||typeof i=="number"||Array.isArray(i)&&i.length===1){if(e===1)return vn(tx(l),i);if(e===1/0)return Pd(tx(l),i);if(e===-1/0)return _h(tx(l),i);if(e==="euclidean"||e===2)return yp(vn(Dw(tx(l),p0(2,"int32")),i));throw new Error("Error in norm: invalid ord value: "+e)}if(Array.isArray(i)&&i.length===2){if(e===1)return Pd(vn(tx(l),i[0]),i[1]-1);if(e===1/0)return Pd(vn(tx(l),i[1]),i[0]);if(e===-1/0)return _h(vn(tx(l),i[1]),i[0]);if(e==="fro"||e==="euclidean")return yp(vn(gh(l),i));throw new Error("Error in norm: invalid ord value: "+e)}throw new Error("Error in norm: invalid axis: "+i)}const kw=It({norm_:Bw});function Uw(l,e=null,i=!1){return kw(l,"euclidean",e,i)}const Od=It({euclideanNorm_:Uw});function Vw(l,e=0){const i=rt(l,"x","expandDims","string_or_numeric");Te(e<=i.rank,()=>"Axis must be <= rank of the tensor");const s={input:i},n={dim:e};return dt.runKernel(ff,s,n)}const yh=It({expandDims_:Vw});function Gw(l,e){const i=rt(l,"x","tile","string_or_numeric");Te(i.rank===e.length,()=>"Error in transpose: rank of input "+i.rank+" must match length of reps "+e+".");const s={x:i},n={reps:e};return dt.runKernel(fd,s,n)}const ub=It({tile_:Gw});function Ww(l){const e={x:rt(l,"x","floor","float32")};return dt.runKernel(Qu,e)}const zw=It({floor_:Ww});function Hw(l,e,i=0,s=0){const n=rt(l,"x","gather"),a=rt(e,"indices","gather","int32"),p={x:n,indices:a},_={axis:i,batchDims:s};return dt.runKernel(mf,p,_)}const Xw=It({gather_:Hw});function Yw(l,e){let i=rt(l,"a","greater","string_or_numeric"),s=rt(e,"b","greater","string_or_numeric");[i,s]=Ks(i,s),is(i.shape,s.shape);const n={a:i,b:s};return dt.runKernel(BM,n)}const db=It({greater_:Yw});function Kw(l,e){let i=rt(l,"a","greaterEqual","string_or_numeric"),s=rt(e,"b","greaterEqual","string_or_numeric");[i,s]=Ks(i,s),is(i.shape,s.shape);const n={a:i,b:s};return dt.runKernel($u,n)}const jw=It({greaterEqual_:Kw});function qw(l,e=.2){const i={x:rt(l,"x","leakyRelu")},s={alpha:e};return dt.runKernel(UM,i,s)}const Zw=It({leakyRelu_:qw});function Qw(l,e){let i=rt(l,"a","less","string_or_numeric"),s=rt(e,"b","less","string_or_numeric");[i,s]=Ks(i,s),is(i.shape,s.shape);const n={a:i,b:s};return dt.runKernel(ed,n)}const fb=It({less_:Qw});function $w(l,e){let i=rt(l,"a","lessEqual","string_or_numeric"),s=rt(e,"b","lessEqual","string_or_numeric");[i,s]=Ks(i,s),is(i.shape,s.shape);const n={a:i,b:s};return dt.runKernel(td,n)}const pb=It({lessEqual_:$w});function Ql(l){return dt.customGrad(l)}function Jw(l,e){let i=rt(l,"a","sub"),s=rt(e,"b","sub");[i,s]=Ks(i,s);const n={a:i,b:s};return dt.runKernel(dd,n)}const ia=It({sub_:Jw});function eD(l,e){const i=rt(l,"a","logicalAnd","bool"),s=rt(e,"b","logicalAnd","bool");is(i.shape,s.shape);const n={a:i,b:s};return dt.runKernel(id,n)}const tD=It({logicalAnd_:eD});function iD(l,e){const i=rt(l,"a","logicalOr","bool"),s=rt(e,"b","logicalOr","bool");is(i.shape,s.shape);const n={a:i,b:s};return dt.runKernel(rd,n)}const rD=It({logicalOr_:iD});function sD(l,e,i,s,n){const a=rt(l,"x","maxPool"),p=1;let _=a,g=!1;a.rank===3&&(g=!0,_=ti(a,[1,a.shape[0],a.shape[1],a.shape[2]])),Te(_.rank===4,()=>"Error in maxPool: input must be rank 4 but got rank "+_.rank+"."),Te(ta(i,p),()=>"Error in maxPool: Either strides or dilations must be 1. Got strides "+i+" and dilations '"+p+"'"),d0("maxPool",s,n);const y={x:_},b={filterSize:e,strides:i,pad:s,dimRoundingMode:n},v=dt.runKernel(gf,y,b);return g?ti(v,[v.shape[1],v.shape[2],v.shape[3]]):v}const bp=It({maxPool_:sD});function nD(l,e){let i=rt(l,"a","maximum"),s=rt(e,"b","maximum");[i,s]=Ks(i,s),i.dtype==="bool"&&(i=kn(i,"int32"),s=kn(s,"int32")),is(i.shape,s.shape);const n={a:i,b:s};return dt.runKernel(sd,n)}const aD=It({maximum_:nD});function oD(l,e=null,i=!1){const s={x:rt(l,"x","mean")},n={axis:e,keepDims:i};return dt.runKernel(yf,s,n)}const xD=It({mean_:oD});function Lo(l,e="float32"){if(xt(l),e==="complex64"){const s=Lo(l,"float32"),n=Lo(l,"float32");return Yf(s,n)}const i=ze(Je(l),e);return dt.makeTensor(i,l,e)}function lD(l,e){let i=rt(l,"a","minimum"),s=rt(e,"b","minimum");[i,s]=Ks(i,s),i.dtype==="bool"&&(i=kn(i,"int32"),s=kn(s,"int32")),is(i.shape,s.shape);const n={a:i,b:s};return dt.runKernel(nd,n)}const cD=It({minimum_:lD});function hD(l,e,i=0){const s=rt(l,"x","pad");if(s.rank===0)throw new Error("pad(scalar) is not defined. Pass non-scalar to pad");const n={paddings:e,constantValue:i},a={x:s};return dt.runKernel(Ef,a,n)}const wd=It({pad_:hD});function uD(l,e,i){const s=rt(l,"x","spaceToBatchND");Te(s.rank>=1+e.length,()=>"input rank "+s.rank+" should be > than [blockShape] "+e.length),Te(i.length===e.length,()=>"paddings.shape[0] "+i.length+" must be equal to [blockShape] "+e.length),Te(s.shape.reduce((p,_,g)=>g>0&&g<=e.length?p&&(_+i[g-1][0]+i[g-1][1])%e[g-1]===0:p,!0),()=>"input spatial dimensions "+s.shape.slice(1)+" with paddings "+i.toString()+" must be divisible by blockShapes "+e.toString());const n={x:s},a={blockShape:e,paddings:i};return dt.runKernel(jM,n,a)}const dD=It({spaceToBatchND_:uD});function fD(l,e,i,s,n,a,p){n==null&&(n=[1,1]),a==null&&(a=1),s===0&&(s="valid");const _=rt(l,"x","maxPool");let g=_,y=!1;_.rank===3&&(y=!0,g=ti(_,[1,_.shape[0],_.shape[1],_.shape[2]])),Te(ta(a,n),()=>"Error in pool: Either strides or dilations must be 1. Got strides "+a+" and dilations '"+n+"'");const b=jl(g.shape,e,a,n,s),v=[b.dilationHeight,b.dilationWidth];let S;s==="same"?S=mD([b.filterHeight,b.filterWidth],v):S=[[0,0],[0,0]];const M=v[0]===1&&v[1]===1,[F,L]=pD([b.inHeight,b.inWidth],v,S),N=M?s:"valid",k=M?g:dD(g,v,F),G=(i==="avg"?()=>mp(k,e,a,N,p):()=>bp(k,e,a,N,p))(),H=M?G:ow(G,v,L);return y?ti(H,[H.shape[1],H.shape[2],H.shape[3]]):H}function pD(l,e,i){const s=i.map(b=>b[0]),n=i.map(b=>b[1]),a=l.concat(s,n),p=e.map((b,v)=>(b-a[v]%b)%b),_=n.map((b,v)=>b+p[v]),g=e.map((b,v)=>[s[v],_[v]]),y=e.map((b,v)=>[0,p[v]]);return[g,y]}function mD(l,e){const i=l.map((a,p)=>a+(a-1)*(e[p]-1)).map(a=>a-1),s=i.map(a=>Math.floor(a/2)),n=i.map((a,p)=>a-s[p]);return i.map((a,p)=>[s[p],n[p]])}const _D=It({pool_:fD});function gD(l,e){const i=rt(l,"x","prelu"),s=rt(e,"alpha","prelu"),n={x:i,alpha:s};return dt.runKernel(Af,n)}const mb=It({prelu_:gD});function yD(l,e=!1){console.log(l.toString(e))}var vp={exports:{}};vp.exports,function(l){(function(e,i,s){function n(g){var y=this,b=_();y.next=function(){var v=2091639*y.s0+y.c*23283064365386963e-26;return y.s0=y.s1,y.s1=y.s2,y.s2=v-(y.c=v|0)},y.c=1,y.s0=b(" "),y.s1=b(" "),y.s2=b(" "),y.s0-=b(g),y.s0<0&&(y.s0+=1),y.s1-=b(g),y.s1<0&&(y.s1+=1),y.s2-=b(g),y.s2<0&&(y.s2+=1),b=null}function a(g,y){return y.c=g.c,y.s0=g.s0,y.s1=g.s1,y.s2=g.s2,y}function p(g,y){var b=new n(g),v=y&&y.state,S=b.next;return S.int32=function(){return b.next()*4294967296|0},S.double=function(){return S()+(S()*2097152|0)*11102230246251565e-32},S.quick=S,v&&(typeof v=="object"&&a(v,b),S.state=function(){return a(b,{})}),S}function _(){var g=4022871197,y=function(b){b=String(b);for(var v=0;v<b.length;v++){g+=b.charCodeAt(v);var S=.02519603282416938*g;g=S>>>0,S-=g,S*=g,g=S>>>0,S-=g,g+=S*4294967296}return(g>>>0)*23283064365386963e-26};return y}i&&i.exports?i.exports=p:s&&s.amd?s(function(){return p}):this.alea=p})(c0,l,!1)}(vp);var bD=vp.exports,Tp={exports:{}};Tp.exports,function(l){(function(e,i,s){function n(_){var g=this,y="";g.x=0,g.y=0,g.z=0,g.w=0,g.next=function(){var v=g.x^g.x<<11;return g.x=g.y,g.y=g.z,g.z=g.w,g.w^=g.w>>>19^v^v>>>8},_===(_|0)?g.x=_:y+=_;for(var b=0;b<y.length+64;b++)g.x^=y.charCodeAt(b)|0,g.next()}function a(_,g){return g.x=_.x,g.y=_.y,g.z=_.z,g.w=_.w,g}function p(_,g){var y=new n(_),b=g&&g.state,v=function(){return(y.next()>>>0)/4294967296};return v.double=function(){do var S=y.next()>>>11,M=(y.next()>>>0)/4294967296,F=(S+M)/(1<<21);while(F===0);return F},v.int32=y.next,v.quick=v,b&&(typeof b=="object"&&a(b,y),v.state=function(){return a(y,{})}),v}i&&i.exports?i.exports=p:s&&s.amd?s(function(){return p}):this.xor128=p})(c0,l,!1)}(Tp);var vD=Tp.exports,Ep={exports:{}};Ep.exports,function(l){(function(e,i,s){function n(_){var g=this,y="";g.next=function(){var v=g.x^g.x>>>2;return g.x=g.y,g.y=g.z,g.z=g.w,g.w=g.v,(g.d=g.d+362437|0)+(g.v=g.v^g.v<<4^(v^v<<1))|0},g.x=0,g.y=0,g.z=0,g.w=0,g.v=0,_===(_|0)?g.x=_:y+=_;for(var b=0;b<y.length+64;b++)g.x^=y.charCodeAt(b)|0,b==y.length&&(g.d=g.x<<10^g.x>>>4),g.next()}function a(_,g){return g.x=_.x,g.y=_.y,g.z=_.z,g.w=_.w,g.v=_.v,g.d=_.d,g}function p(_,g){var y=new n(_),b=g&&g.state,v=function(){return(y.next()>>>0)/4294967296};return v.double=function(){do var S=y.next()>>>11,M=(y.next()>>>0)/4294967296,F=(S+M)/(1<<21);while(F===0);return F},v.int32=y.next,v.quick=v,b&&(typeof b=="object"&&a(b,y),v.state=function(){return a(y,{})}),v}i&&i.exports?i.exports=p:s&&s.amd?s(function(){return p}):this.xorwow=p})(c0,l,!1)}(Ep);var TD=Ep.exports,Ap={exports:{}};Ap.exports,function(l){(function(e,i,s){function n(_){var g=this;g.next=function(){var b=g.x,v=g.i,S,M;return S=b[v],S^=S>>>7,M=S^S<<24,S=b[v+1&7],M^=S^S>>>10,S=b[v+3&7],M^=S^S>>>3,S=b[v+4&7],M^=S^S<<7,S=b[v+7&7],S=S^S<<13,M^=S^S<<9,b[v]=M,g.i=v+1&7,M};function y(b,v){var S,M=[];if(v===(v|0))M[0]=v;else for(v=""+v,S=0;S<v.length;++S)M[S&7]=M[S&7]<<15^v.charCodeAt(S)+M[S+1&7]<<13;for(;M.length<8;)M.push(0);for(S=0;S<8&&M[S]===0;++S);for(S==8?M[7]=-1:M[S],b.x=M,b.i=0,S=256;S>0;--S)b.next()}y(g,_)}function a(_,g){return g.x=_.x.slice(),g.i=_.i,g}function p(_,g){_==null&&(_=+new Date);var y=new n(_),b=g&&g.state,v=function(){return(y.next()>>>0)/4294967296};return v.double=function(){do var S=y.next()>>>11,M=(y.next()>>>0)/4294967296,F=(S+M)/(1<<21);while(F===0);return F},v.int32=y.next,v.quick=v,b&&(b.x&&a(b,y),v.state=function(){return a(y,{})}),v}i&&i.exports?i.exports=p:s&&s.amd?s(function(){return p}):this.xorshift7=p})(c0,l,!1)}(Ap);var ED=Ap.exports,Cp={exports:{}};Cp.exports,function(l){(function(e,i,s){function n(_){var g=this;g.next=function(){var b=g.w,v=g.X,S=g.i,M,F;return g.w=b=b+1640531527|0,F=v[S+34&127],M=v[S=S+1&127],F^=F<<13,M^=M<<17,F^=F>>>15,M^=M>>>12,F=v[S]=F^M,g.i=S,F+(b^b>>>16)|0};function y(b,v){var S,M,F,L,N,k=[],G=128;for(v===(v|0)?(M=v,v=null):(v=v+"\0",M=0,G=Math.max(G,v.length)),F=0,L=-32;L<G;++L)v&&(M^=v.charCodeAt((L+32)%v.length)),L===0&&(N=M),M^=M<<10,M^=M>>>15,M^=M<<4,M^=M>>>13,L>=0&&(N=N+1640531527|0,S=k[L&127]^=M+N,F=S==0?F+1:0);for(F>=128&&(k[(v&&v.length||0)&127]=-1),F=127,L=4*128;L>0;--L)M=k[F+34&127],S=k[F=F+1&127],M^=M<<13,S^=S<<17,M^=M>>>15,S^=S>>>12,k[F]=M^S;b.w=N,b.X=k,b.i=F}y(g,_)}function a(_,g){return g.i=_.i,g.w=_.w,g.X=_.X.slice(),g}function p(_,g){_==null&&(_=+new Date);var y=new n(_),b=g&&g.state,v=function(){return(y.next()>>>0)/4294967296};return v.double=function(){do var S=y.next()>>>11,M=(y.next()>>>0)/4294967296,F=(S+M)/(1<<21);while(F===0);return F},v.int32=y.next,v.quick=v,b&&(b.X&&a(b,y),v.state=function(){return a(y,{})}),v}i&&i.exports?i.exports=p:s&&s.amd?s(function(){return p}):this.xor4096=p})(c0,l,!1)}(Cp);var AD=Cp.exports,Rp={exports:{}};Rp.exports,function(l){(function(e,i,s){function n(_){var g=this,y="";g.next=function(){var v=g.b,S=g.c,M=g.d,F=g.a;return v=v<<25^v>>>7^S,S=S-M|0,M=M<<24^M>>>8^F,F=F-v|0,g.b=v=v<<20^v>>>12^S,g.c=S=S-M|0,g.d=M<<16^S>>>16^F,g.a=F-v|0},g.a=0,g.b=0,g.c=-1640531527,g.d=1367130551,_===Math.floor(_)?(g.a=_/4294967296|0,g.b=_|0):y+=_;for(var b=0;b<y.length+20;b++)g.b^=y.charCodeAt(b)|0,g.next()}function a(_,g){return g.a=_.a,g.b=_.b,g.c=_.c,g.d=_.d,g}function p(_,g){var y=new n(_),b=g&&g.state,v=function(){return(y.next()>>>0)/4294967296};return v.double=function(){do var S=y.next()>>>11,M=(y.next()>>>0)/4294967296,F=(S+M)/(1<<21);while(F===0);return F},v.int32=y.next,v.quick=v,b&&(typeof b=="object"&&a(b,y),v.state=function(){return a(y,{})}),v}i&&i.exports?i.exports=p:s&&s.amd?s(function(){return p}):this.tychei=p})(c0,l,!1)}(Rp);var CD=Rp.exports,_b={exports:{}};(function(l){(function(e,i,s){var n=256,a=6,p=52,_="random",g=s.pow(n,a),y=s.pow(2,p),b=y*2,v=n-1,S;function M(z,W,Y){var Z=[];W=W==!0?{entropy:!0}:W||{};var Q=k(N(W.entropy?[z,H(i)]:z??G(),3),Z),se=new F(Z),$=function(){for(var oe=se.g(a),ue=g,de=0;oe<y;)oe=(oe+de)*n,ue*=n,de=se.g(1);for(;oe>=b;)oe/=2,ue/=2,de>>>=1;return(oe+de)/ue};return $.int32=function(){return se.g(4)|0},$.quick=function(){return se.g(4)/4294967296},$.double=$,k(H(se.S),i),(W.pass||Y||function(oe,ue,de,ye){return ye&&(ye.S&&L(ye,se),oe.state=function(){return L(se,{})}),de?(s[_]=oe,ue):oe})($,Q,"global"in W?W.global:this==s,W.state)}function F(z){var W,Y=z.length,Z=this,Q=0,se=Z.i=Z.j=0,$=Z.S=[];for(Y||(z=[Y++]);Q<n;)$[Q]=Q++;for(Q=0;Q<n;Q++)$[Q]=$[se=v&se+z[Q%Y]+(W=$[Q])],$[se]=W;(Z.g=function(oe){for(var ue,de=0,ye=Z.i,_e=Z.j,we=Z.S;oe--;)ue=we[ye=v&ye+1],de=de*n+we[v&(we[ye]=we[_e=v&_e+ue])+(we[_e]=ue)];return Z.i=ye,Z.j=_e,de})(n)}function L(z,W){return W.i=z.i,W.j=z.j,W.S=z.S.slice(),W}function N(z,W){var Y=[],Z=typeof z,Q;if(W&&Z=="object")for(Q in z)try{Y.push(N(z[Q],W-1))}catch{}return Y.length?Y:Z=="string"?z:z+"\0"}function k(z,W){for(var Y=z+"",Z,Q=0;Q<Y.length;)W[v&Q]=v&(Z^=W[v&Q]*19)+Y.charCodeAt(Q++);return H(W)}function G(){try{var z;return S&&(z=S.randomBytes)?z=z(n):(z=new Uint8Array(n),(e.crypto||e.msCrypto).getRandomValues(z)),H(z)}catch{var W=e.navigator,Y=W&&W.plugins;return[+new Date,e,Y,e.screen,H(i)]}}function H(z){return String.fromCharCode.apply(0,z)}if(k(s.random(),i),l.exports){l.exports=M;try{S=fa(653)}catch{}}else s["seed"+_]=M})(typeof self<"u"?self:c0,[],Math)})(_b);var RD=_b.exports,ID=bD,SD=vD,MD=TD,PD=ED,OD=AD,wD=CD,$l=RD;$l.alea=ID,$l.xor128=SD,$l.xorwow=MD,$l.xorshift7=PD,$l.xor4096=OD,$l.tychei=wD;function Ip(l,e,i=1,s="float32"){if(i===0)throw new Error("Cannot have a step of zero");const n={start:l,stop:e,step:i,dtype:s};return dt.runKernel(Cf,{},n)}function DD(l){const e={x:rt(l,"x","relu")};return dt.runKernel(xd,e)}const gb=It({relu_:DD});function FD(l){const e={x:rt(l,"x","relu6")};return dt.runKernel(ld,e)}const yb=It({relu6_:FD});function LD(l){const e={x:rt(l,"x","round")};return dt.runKernel(XM,e)}const ND=It({round_:LD});function BD(l){const e={x:rt(l,"x","sin","float32")};return dt.runKernel(cd,e)}const kD=It({sin_:BD});function UD(l,e,i){const s=rt(l,"x","slice3d");return Te(s.rank===3,()=>"slice3d expects a rank-3 tensor, but got a rank-"+s.rank+" tensor"),Or(s,e,i)}const Sp=It({slice3d_:UD});function VD(l,e,i=0){const s={x:rt(l,"x","split")},n={numOrSizeSplits:e,axis:i};return dt.runKernel(qM,s,n)}const GD=It({split_:VD});function WD(l,e){const i=rt(l,"x","squeeze","string_or_numeric");return ti(i,ct(i.shape,e).newShape)}const ds=It({squeeze_:WD});function zD(l,e=0){const i=Ay(l,"tensors","stack","string_or_numeric");Te(i.length>=1,()=>"Pass at least one tensor to tf.stack"),i.length>0&&Te(e<=i[0].rank,()=>"Axis must be <= rank of the tensor");const s=i,n={axis:e};return dt.runKernel(Tf,s,n)}const bh=It({stack_:zD});function HD(l,e=0){const i={x:rt(l,"x","step")},s={alpha:e};return dt.runKernel(QM,i,s)}const XD=It({step_:HD});function YD(l,e,i,s,n=0,a=0,p=0,_=0,g=0){const y={x:rt(l,"x","stridedSlice","string_or_numeric")},b={begin:e,end:i,strides:s,beginMask:n,endMask:a,ellipsisMask:p,newAxisMask:_,shrinkAxisMask:g};return dt.runKernel(Pf,y,b)}const KD=It({stridedSlice_:YD});function qs(l,e){Fi(l);const i=oh(l,e);if(i.length!==1)throw new Error("tensor1d() requires values to be a flat/TypedArray");return xh(l,null,i,e)}function Mp(l,e,i){if(Fi(l),e!=null&&e.length!==2)throw new Error("tensor2d() requires shape to have two numbers");const s=oh(l,i);if(s.length!==2&&s.length!==1)throw new Error("tensor2d() requires values to be number[][] or flat/TypedArray");if(s.length===1&&e==null)throw new Error("tensor2d() requires shape to be provided when `values` are a flat/TypedArray");return xh(l,e,s,i)}function jD(l,e,i){const s=rt(l,"tensor","tensorScatterupdate"),n=rt(e,"indices","tensorScatterupdate","int32"),a=rt(i,"updates","tensorScatterupdate");if(Zy(a,n,s.shape),s.dtype!==a.dtype)throw new Error("tensor and updates must have the same dtype, instead they are "+s.dtype+" and "+a.dtype+".");const p={tensor:s,indices:n,updates:a},_={};return dt.runKernel(YM,p,_)}It({tensorScatterUpdate_:jD});function qD(l,e=0){const i=rt(l,"x","unstack","string_or_numeric");Te(e>=-i.shape.length&&e<i.shape.length,()=>"Axis = "+e+" is not in [-"+i.shape.length+", "+i.shape.length+")");const s={value:i},n={axis:e};return dt.runKernel(ZM,s,n)}const Dd=It({unstack_:qD});function bb(l,e){const i=[];for(let a=0;a<e.length;a++)e[a]&&i.push(a);const s=Jr(l,"int32"),n=Jr([i.length,l.length],"int32");for(let a=0;a<i.length;a++){const p=s.indexToLoc(i[a]),_=a*l.length;n.values.set(p,_)}return n.toTensor()}function ZD(l,e,i,s,n,a="NHWC",p){let _=l;l.rank===3&&(_=ti(l,[1,l.shape[0],l.shape[1],l.shape[2]]));let g=e;g.rank===3&&(g=ti(e,[1,e.shape[0],e.shape[1],e.shape[2]])),Te(_.rank===4,()=>"Error in conv2dDerFilter: input must be rank 4, but got shape "+_.shape+"."),Te(g.rank===4,()=>"Error in conv2dDerFilter: dy must be rank 4, but got shape "+g.shape+"."),Te(i.length===4,()=>"Error in conv2dDerFilter: filterShape must be length 4, but got "+i+".");const y=a==="NHWC"?_.shape[3]:_.shape[1],b=a==="NHWC"?g.shape[3]:g.shape[1];Te(y===i[2],()=>"Error in conv2dDerFilter: depth of input "+y+") must match input depth in filter ("+i[2]+"."),Te(b===i[3],()=>"Error in conv2dDerFilter: depth of dy ("+b+") must match output depth for filter ("+i[3]+")."),d0("conv2dDerFilter",n,p);const v={x:_,dy:g},S={strides:s,pad:n,dataFormat:a,dimRoundingMode:p,filterShape:i};return dt.runKernel(PM,v,S)}const QD=It({conv2DBackpropFilter_:ZD});function Fd(l,e,i){if(i==null||i==="linear")return l;if(i==="relu")return js(l,XD(e));throw new Error("Cannot compute gradient for fused activation "+i+".")}function Ld(l,e){let i=e;const s=jy(l.shape,e.shape);return s.length>0&&(i=vn(i,s)),ti(i,l.shape)}function Nd(l,e,i,s){if(e==="linear")return l;if(e==="relu")return gb(l);if(e==="elu")return Sw(l);if(e==="relu6")return yb(l);if(e==="prelu")return mb(l,i);if(e==="leakyrelu")return Zw(l,s);if(e==="sigmoid")return fh(l);throw new Error("Unknown fused activation "+e+".")}const Bd=(l,e)=>!(l>0)||e==="linear";function $D({x:l,filter:e,strides:i,pad:s,dataFormat:n="NHWC",dilations:a=[1,1],dimRoundingMode:p,bias:_,activation:g="linear",preluActivationWeights:y,leakyreluAlpha:b}){if(g=g||"linear",Bd(dt.state.gradientDepth,g)===!1){Te(n==="NHWC",()=>"Error in fused conv2d: got dataFormat of "+n+" but only NHWC is currently supported for the case of gradient depth is 0 and the activation is not linear.");let Y=xb(l,e,i,s,n,a,p);return _!=null&&(Y=Hr(Y,_)),Nd(Y,g,y,b)}const v=rt(l,"x","conv2d","float32"),S=rt(e,"filter","conv2d","float32");let M=v,F=!1;v.rank===3&&(F=!0,M=ti(v,[1,v.shape[0],v.shape[1],v.shape[2]])),Te(M.rank===4,()=>"Error in fused conv2d: input must be rank 4, but got rank "+M.rank+"."),Te(S.rank===4,()=>"Error in fused conv2d: filter must be rank 4, but got rank "+S.rank+"."),d0("fused conv2d",s,p);const L=n==="NHWC"?M.shape[3]:M.shape[1];Te(S.shape[2]===L,()=>"Error in conv2d: depth of input ("+L+") must match input depth for filter "+S.shape[2]+"."),Te(ta(i,a),()=>"Error in conv2D: Either strides or dilations must be 1. Got strides "+i+" and dilations '"+a+"'");const N=mo(M.shape,S.shape,i,a,s,p);let k;_!=null&&(k=rt(_,"bias","fused conv2d"),[k]=Ks(k,v),n==="NHWC"?is(N.outShape,k.shape):(Te(k.shape.length<=1,()=>"Error in fused conv2d: only supports scalar or 1-D Tensor bias for NCHW format but got the bias of rank-"+k.shape.length+"."),Te(k.shape.length===0||k.shape[0]===N.outChannels||k.shape[0]===1,()=>"Error in fused conv2d: bias shape ("+k.shape+") is not compatible with the number of output channels ("+N.outChannels+")")));let G;if(y!=null){const Y=y.shape;if(Te(Y.length<=1||Y.length===3,()=>"Error in fused conv2d: only supports scalar, 1-D Tensor or 3-D Tensor PReLU activation weights but got a tensor of rank-"+Y.length+"."),Y.length===1)Te(Y[0]===1||Y[0]===N.outChannels,()=>"Error in fused conv2d: PReLU activation weights ("+Y+") is not compatible with the number of output channels ("+N.outChannels+").");else if(Y.length===3)try{is(Y,N.outShape)}catch{const Q="Error in fused conv2d: PReLU activation weights ("+Y+") is not compatible with the output shape of the conv2d ("+N.outShape+").";throw Error(Q)}G=rt(y,"prelu weights","fused conv2d")}const H=(Y,Z)=>{Te(n==="NHWC",()=>"Error in gradient of fused conv2D: got dataFormat of "+n+" but only NHWC is currently supported.");const[Q,se,$,oe]=Z,ue=Fd(Y,$,g);Te(uh(a),()=>"Error in gradient of fused conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+a+"'");const de=_w(se.shape,ue,Q,i,s),ye=QD(se,ue,Q.shape,i,s),_e=[de,ye];if(oe!=null){const we=Ld(oe,ue);_e.push(we)}return _e},z={x:M,filter:S,bias:k,preluActivationWeights:G},W={strides:i,pad:s,dataFormat:n,dilations:a,dimRoundingMode:p,activation:g,leakyreluAlpha:b};return _==null?Ql((Y,Z,Q)=>{let se=dt.runKernel(md,z,W);return Q([Z,Y,se]),F&&(se=ti(se,[se.shape[1],se.shape[2],se.shape[3]])),{value:se,gradFunc:H}})(M,S):Ql((Y,Z,Q,se)=>{let $=dt.runKernel(md,z,W);return se([Z,Y,$,Q]),F&&($=ti($,[$.shape[1],$.shape[2],$.shape[3]])),{value:$,gradFunc:H}})(M,S,k)}const JD=It({fusedConv2d_:$D});function eF(l,e,i,s,n,a=[1,1],p){let _=l;l.rank===3&&(_=ti(l,[1,l.shape[0],l.shape[1],l.shape[2]]));let g=e;g.rank===3&&(g=ti(e,[1,e.shape[0],e.shape[1],e.shape[2]]));const y={x:_,dy:g},b={strides:s,pad:n,dimRoundingMode:p,dilations:a,filterShape:i};return dt.runKernel(wM,y,b)}const tF=It({depthwiseConv2dNativeBackpropFilter_:eF});function iF(l,e,i,s,n,a=[1,1],p){let _=e,g=!1;e.rank===3&&(g=!0,_=ti(e,[1,e.shape[0],e.shape[1],e.shape[2]]));const y={dy:_,filter:i},b={strides:s,pad:n,dimRoundingMode:p,dilations:a,inputShape:l},v=dt.runKernel(DM,y,b);return g?ti(v,[v.shape[1],v.shape[2],v.shape[3]]):v}const rF=It({depthwiseConv2dNativeBackpropInput_:iF});function sF({x:l,filter:e,strides:i,pad:s,dataFormat:n="NHWC",dilations:a=[1,1],dimRoundingMode:p,bias:_,activation:g="linear",preluActivationWeights:y,leakyreluAlpha:b}){if(Bd(dt.state.gradientDepth,g)===!1){let W=Md(l,e,i,s,n,a,p);return _!=null&&(W=Hr(W,_)),Nd(W,g,y,b)}const v=rt(l,"x","depthwiseConv2d","float32"),S=rt(e,"filter","depthwiseConv2d","float32");let M=v,F=!1;v.rank===3&&(F=!0,M=ti(v,[1,v.shape[0],v.shape[1],v.shape[2]])),Te(M.rank===4,()=>"Error in fused depthwiseConv2d: input must be rank 4, but got rank "+M.rank+"."),Te(S.rank===4,()=>"Error in fused depthwiseConv2d: filter must be rank 4, but got rank "+S.rank+"."),Te(M.shape[3]===S.shape[2],()=>"Error in fused depthwiseConv2d: number of input channels ("+M.shape[3]+") must match the inChannels dimension in filter "+S.shape[2]+"."),a==null&&(a=[1,1]),Te(ta(i,a),()=>"Error in fused depthwiseConv2d: Either strides or dilations must be 1. Got strides "+i+" and dilations '"+a+"'"),d0("fused depthwiseConv2d",s,p);const L=mo(M.shape,S.shape,i,a,s,p,!0);let N;_!=null&&(N=rt(_,"bias","fused conv2d"),[N]=Ks(N,v),is(L.outShape,N.shape));let k;y!=null&&(k=rt(y,"prelu weights","fused depthwiseConv2d"));const G=(W,Y)=>{Te(uh(a),()=>"Error in gradient of fused depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+a+"'");const[Z,Q,se,$]=Y,oe=Fd(W,se,g),ue=rF(Q.shape,oe,Z,i,s,a,p),de=tF(Q,oe,Z.shape,i,s,a,p);if($!=null){const ye=Ld(N,oe);return[ue,de,ye]}return[ue,de]},H={x:M,filter:S,bias:N,preluActivationWeights:k},z={strides:i,pad:s,dataFormat:n,dilations:a,dimRoundingMode:p,activation:g,leakyreluAlpha:b};return _==null?Ql((W,Y,Z)=>{let Q=dt.runKernel(_d,H,z);return Z([Y,W,Q]),F&&(Q=ti(Q,[Q.shape[1],Q.shape[2],Q.shape[3]])),{value:Q,gradFunc:G}})(M,S):Ql((W,Y,Z,Q)=>{let se=dt.runKernel(_d,H,z);return Q([Y,W,se,Z]),F&&(se=ti(se,[se.shape[1],se.shape[2],se.shape[3]])),{value:se,gradFunc:G}})(M,S,N)}const nF=It({fusedDepthwiseConv2d_:sF});function aF({a:l,b:e,transposeA:i=!1,transposeB:s=!1,bias:n,activation:a="linear",preluActivationWeights:p,leakyreluAlpha:_=.2}){if(Bd(dt.state.gradientDepth,a)===!1){let $=po(l,e,i,s);return n!=null&&($=Hr($,n)),Nd($,a,p,_)}let g=rt(l,"a","fused matMul"),y=rt(e,"b","fused matMul");[g,y]=Ks(g,y);const b=i?g.shape[g.rank-2]:g.shape[g.rank-1],v=s?y.shape[y.rank-1]:y.shape[y.rank-2],S=i?g.shape[g.rank-1]:g.shape[g.rank-2],M=s?y.shape[y.rank-2]:y.shape[y.rank-1],F=g.shape.slice(0,-2),L=y.shape.slice(0,-2),N=Je(F),k=Je(L);Te(b===v,()=>"Error in fused matMul: inner shapes ("+b+") and ("+v+") of Tensors with shapes "+g.shape+" and "+y.shape+" and transposeA="+i+" and transposeB="+s+" must match.");const G=is(g.shape.slice(0,-2),y.shape.slice(0,-2)).concat([S,M]),H=i?ti(g,[N,b,S]):ti(g,[N,S,b]),z=s?ti(y,[k,M,v]):ti(y,[k,v,M]);let W;n!=null&&(W=rt(n,"bias","fused matMul"),[W]=Ks(W,g),is(G,W.shape));let Y;p!=null&&(Y=rt(p,"prelu weights","fused matMul"));const Z=($,oe)=>{const[ue,de,ye,_e]=oe,we=Fd(ti($,ye.shape),ye,a);let Pe,Ee;if(!i&&!s?(Pe=po(we,de,!1,!0),Ee=po(ue,we,!0,!1)):!i&&s?(Pe=po(we,de,!1,!1),Ee=po(we,ue,!0,!1)):i&&!s?(Pe=po(de,we,!1,!0),Ee=po(ue,we,!1,!1)):(Pe=po(de,we,!0,!0),Ee=po(we,ue,!0,!0)),n!=null){const We=Ld(_e,we);return[Pe,Ee,We]}else return[Pe,Ee]},Q={a:H,b:z,bias:W,preluActivationWeights:Y},se={transposeA:i,transposeB:s,activation:a,leakyreluAlpha:_};return n==null?Ql(($,oe,ue)=>{const de=dt.runKernel(pd,Q,se);return ue([$,oe,de]),{value:ti(de,G),gradFunc:Z}})(H,z):Ql(($,oe,ue,de)=>{const ye=dt.runKernel(pd,Q,se);return de([$,oe,ye,ue]),{value:ti(ye,G),gradFunc:Z}})(H,z,W)}const oF=It({fusedMatMul_:aF});function xF(l,e,i,s,n="bilinear",a=0){const p=rt(l,"image","cropAndResize"),_=rt(e,"boxes","cropAndResize","float32"),g=rt(i,"boxInd","cropAndResize","int32"),y=_.shape[0];Te(p.rank===4,()=>"Error in cropAndResize: image must be rank 4,but got rank "+p.rank+"."),Te(_.rank===2&&_.shape[1]===4,()=>"Error in cropAndResize: boxes must be have size ["+y+",4] but had shape "+_.shape+"."),Te(g.rank===1&&g.shape[0]===y,()=>"Error in cropAndResize: boxInd must be have size ["+y+"] but had shape "+_.shape+"."),Te(s.length===2,()=>"Error in cropAndResize: cropSize must be of length 2, but got length "+s.length+"."),Te(s[0]>=1&&s[1]>=1,()=>"cropSize must be atleast [1,1], but was "+s),Te(n==="bilinear"||n==="nearest",()=>"method must be bilinear or nearest, but was "+n);const b={image:p,boxes:_,boxInd:g},v={method:n,extrapolationValue:a,cropSize:s};return dt.runKernel(hf,b,v)}const lF=It({cropAndResize_:xF});function cF(l){const e=rt(l,"image","flipLeftRight","float32");Te(e.rank===4,()=>"Error in flipLeftRight: image must be rank 4,but got rank "+e.rank+".");const i={image:e};return dt.runKernel(LM,i,{})}const hF=It({flipLeftRight_:cF});function uF(l){const e=rt(l,"image","grayscaleToRGB"),i=e.rank-1,s=e.shape[i];Te(e.rank>=2,()=>"Error in grayscaleToRGB: images must be at least rank 2, but got rank "+e.rank+"."),Te(s===1,()=>"Error in grayscaleToRGB: last dimension of a grayscale image should be size 1, but got size "+s+".");const n=new Array(e.rank);return n.fill(1,0,i),n[i]=3,ub(e,n)}const dF=It({grayscaleToRGB_:uF});function fF(l){const e=rt(l,"image","RGBToGrayscale"),i=e.rank-1,s=e.shape[i];Te(e.rank>=2,()=>"Error in RGBToGrayscale: images must be at least rank 2, but got rank "+e.rank+"."),Te(s===3,()=>"Error in RGBToGrayscale: last dimension of an RGB image should be size 3, but got size "+s+".");const n=e.dtype,a=kn(e,"float32"),p=qs([.2989,.587,.114]);let _;switch(e.rank){case 2:_=mh("ij,j->i",a,p);break;case 3:_=mh("ijk,k->ij",a,p);break;case 4:_=mh("ijkl,l->ijk",a,p);break;case 5:_=mh("ijklm,m->ijkl",a,p);break;case 6:_=mh("ijklmn,n->ijklm",a,p);break;default:throw new Error("Not a valid tensor rank.")}return _=yh(_,-1),kn(_,n)}const pF=It({rgbToGrayscale_:fF});function mF(l,e,i=0,s=.5){const n=rt(l,"image","rotateWithOffset","float32");Te(n.rank===4,()=>"Error in rotateWithOffset: image must be rank 4,but got rank "+n.rank+".");const a={image:n},p={radians:e,fillValue:i,center:s};return dt.runKernel(Ff,a,p)}const _F=It({rotateWithOffset_:mF});function Jl(l,e,i,s,n,a){s==null&&(s=.5),n==null&&(n=Number.NEGATIVE_INFINITY),a==null&&(a=0);const p=l.shape[0];return i=Math.min(i,p),Te(0<=s&&s<=1,()=>"iouThreshold must be in [0, 1], but was '"+s+"'"),Te(l.rank===2,()=>"boxes must be a 2D tensor, but was of rank '"+l.rank+"'"),Te(l.shape[1]===4,()=>"boxes must have 4 columns, but 2nd dimension was "+l.shape[1]),Te(e.rank===1,()=>"scores must be a 1D tensor"),Te(e.shape[0]===p,()=>"scores has incompatible shape with boxes. Expected "+p+", but was "+e.shape[0]),Te(0<=a&&a<=1,()=>"softNmsSigma must be in [0, 1], but was '"+a+"'"),{maxOutputSize:i,iouThreshold:s,scoreThreshold:n,softNmsSigma:a}}function gF(l,e,i,s=.5,n=Number.NEGATIVE_INFINITY){const a=rt(l,"boxes","nonMaxSuppression","float32"),p=rt(e,"scores","nonMaxSuppression","float32"),_=Jl(a,p,i,s,n);i=_.maxOutputSize,s=_.iouThreshold,n=_.scoreThreshold;const g={maxOutputSize:i,iouThreshold:s,scoreThreshold:n};return dt.runKernel(VM,{boxes:a,scores:p},g)}const yF=It({nonMaxSuppression_:gF});function bF(l,e,i){const s=vF(l,e,i),n=s<0?-(s+1):s;l.splice(n,0,e)}function vF(l,e,i){return EF(l,e,i||TF)}function TF(l,e){return l>e?1:l<e?-1:0}function EF(l,e,i){let s=0,n=l.length,a=0,p=!1;for(;s<n;){a=s+(n-s>>>1);const _=i(e,l[a]);_>0?s=a+1:(n=a,p=!_)}return p?s:-s-1}function AF(l,e,i,s,n){return Pp(l,e,i,s,n,0)}function CF(l,e,i,s,n,a){return Pp(l,e,i,s,n,0,!1,a,!0)}function RF(l,e,i,s,n,a){return Pp(l,e,i,s,n,a,!0)}function Pp(l,e,i,s,n,a,p=!1,_=!1,g=!1){const y=[];for(let N=0;N<e.length;N++)e[N]>n&&y.push({score:e[N],boxIndex:N,suppressBeginIndex:0});y.sort(vb);const b=a>0?-.5/a:0,v=[],S=[];for(;v.length<i&&y.length>0;){const N=y.pop(),{score:k,boxIndex:G,suppressBeginIndex:H}=N;if(k<n)break;let z=!1;for(let W=v.length-1;W>=H;--W){const Y=IF(l,G,v[W]);if(Y>=s){z=!0;break}if(N.score=N.score*SF(s,b,Y),N.score<=n)break}N.suppressBeginIndex=v.length,z||(N.score===k?(v.push(G),S.push(N.score)):N.score>n&&bF(y,N,vb))}const M=v.length,F=i-M;_&&F>0&&(v.push(...new Array(F).fill(0)),S.push(...new Array(F).fill(0)));const L={selectedIndices:v};return p&&(L.selectedScores=S),g&&(L.validOutputs=M),L}function IF(l,e,i){const s=l.subarray(e*4,e*4+4),n=l.subarray(i*4,i*4+4),a=Math.min(s[0],s[2]),p=Math.min(s[1],s[3]),_=Math.max(s[0],s[2]),g=Math.max(s[1],s[3]),y=Math.min(n[0],n[2]),b=Math.min(n[1],n[3]),v=Math.max(n[0],n[2]),S=Math.max(n[1],n[3]),M=(_-a)*(g-p),F=(v-y)*(S-b);if(M<=0||F<=0)return 0;const L=Math.max(a,y),N=Math.max(p,b),k=Math.min(_,v),G=Math.min(g,S),H=Math.max(k-L,0)*Math.max(G-N,0);return H/(M+F-H)}function SF(l,e,i){const s=Math.exp(e*i*i);return i<=l?s:0}function vb(l,e){return l.score-e.score||l.score===e.score&&e.boxIndex-l.boxIndex}async function MF(l,e,i,s=.5,n=Number.NEGATIVE_INFINITY){const a=rt(l,"boxes","nonMaxSuppressionAsync"),p=rt(e,"scores","nonMaxSuppressionAsync"),_=Jl(a,p,i,s,n);i=_.maxOutputSize,s=_.iouThreshold,n=_.scoreThreshold;const g=await Promise.all([a.data(),p.data()]),y=g[0],b=g[1],{selectedIndices:v}=AF(y,b,i,s,n);return a!==l&&a.dispose(),p!==e&&p.dispose(),qs(v,"int32")}const PF=MF;function OF(l,e,i,s=.5,n=Number.NEGATIVE_INFINITY,a=0){const p=rt(l,"boxes","nonMaxSuppression"),_=rt(e,"scores","nonMaxSuppression"),g=Jl(p,_,i,s,n,a);i=g.maxOutputSize,s=g.iouThreshold,n=g.scoreThreshold,a=g.softNmsSigma;const y={boxes:p,scores:_},b={maxOutputSize:i,iouThreshold:s,scoreThreshold:n,softNmsSigma:a},v=dt.runKernel(WM,y,b);return{selectedIndices:v[0],selectedScores:v[1]}}const wF=It({nonMaxSuppressionWithScore_:OF});async function DF(l,e,i,s=.5,n=Number.NEGATIVE_INFINITY,a=0){const p=rt(l,"boxes","nonMaxSuppressionAsync"),_=rt(e,"scores","nonMaxSuppressionAsync"),g=Jl(p,_,i,s,n,a);i=g.maxOutputSize,s=g.iouThreshold,n=g.scoreThreshold,a=g.softNmsSigma;const y=await Promise.all([p.data(),_.data()]),b=y[0],v=y[1],{selectedIndices:S,selectedScores:M}=RF(b,v,i,s,n,a);return p!==l&&p.dispose(),_!==e&&_.dispose(),{selectedIndices:qs(S,"int32"),selectedScores:qs(M)}}const FF=DF;function LF(l,e,i,s=.5,n=Number.NEGATIVE_INFINITY,a=!1){const p=rt(l,"boxes","nonMaxSuppression"),_=rt(e,"scores","nonMaxSuppression"),g=Jl(p,_,i,s,n,null),y=g.maxOutputSize,b=g.iouThreshold,v=g.scoreThreshold,S={boxes:p,scores:_},M={maxOutputSize:y,iouThreshold:b,scoreThreshold:v,padToMaxOutputSize:a},F=dt.runKernel(GM,S,M);return{selectedIndices:F[0],validOutputs:F[1]}}const NF=It({nonMaxSuppressionPadded_:LF});async function BF(l,e,i,s=.5,n=Number.NEGATIVE_INFINITY,a=!1){const p=rt(l,"boxes","nonMaxSuppressionAsync"),_=rt(e,"scores","nonMaxSuppressionAsync"),g=Jl(p,_,i,s,n,null),y=g.maxOutputSize,b=g.iouThreshold,v=g.scoreThreshold,[S,M]=await Promise.all([p.data(),_.data()]),{selectedIndices:F,validOutputs:L}=CF(S,M,y,b,v,a);return p!==l&&p.dispose(),_!==e&&_.dispose(),{selectedIndices:qs(F,"int32"),validOutputs:p0(L,"int32")}}const kF=BF;function UF(l,e,i=!1,s=!1){const n=rt(l,"images","resizeBilinear");Te(n.rank===3||n.rank===4,()=>"Error in resizeBilinear: x must be rank 3 or 4, but got rank "+n.rank+"."),Te(e.length===2,()=>"Error in resizeBilinear: new shape must 2D, but got shape "+e+"."),Te(s===!1||i===!1,()=>"Error in resizeBilinear: If halfPixelCenters is true, alignCorners must be false.");let a=n,p=!1;n.rank===3&&(p=!0,a=ti(n,[1,n.shape[0],n.shape[1],n.shape[2]]));const _={images:a},g={alignCorners:i,halfPixelCenters:s,size:e},y=dt.runKernel(If,_,g);return p?ti(y,[y.shape[1],y.shape[2],y.shape[3]]):y}const Tb=It({resizeBilinear_:UF});function VF(l,e,i=!1,s=!1){const n=rt(l,"images","resizeNearestNeighbor");Te(n.rank===3||n.rank===4,()=>"Error in resizeNearestNeighbor: x must be rank 3 or 4, but got rank "+n.rank+"."),Te(e.length===2,()=>"Error in resizeNearestNeighbor: new shape must 2D, but got shape "+e+"."),Te(n.dtype==="float32"||n.dtype==="int32",()=>"`images` must have `int32` or `float32` as dtype"),Te(s===!1||i===!1,()=>"Error in resizeNearestNeighbor: If halfPixelCenters is true, alignCorners must be false.");let a=n,p=!1;n.rank===3&&(p=!0,a=ti(n,[1,n.shape[0],n.shape[1],n.shape[2]]));const _={images:a},g={alignCorners:i,halfPixelCenters:s,size:e},y=dt.runKernel(HM,_,g);return p?ti(y,[y.shape[1],y.shape[2],y.shape[3]]):y}const GF=It({resizeNearestNeighbor_:VF});function WF(l,e="binary",i=!1,s=.5){const n=rt(l,"image","threshold"),a=.2989,p=.587,_=.114,g=n.shape[0]*n.shape[1];let y=js(qs([s]),255),b,v,S,M;if(Te(n.rank===3,()=>"Error in threshold: image must be rank 3,but got rank "+n.rank+"."),Te(n.shape[2]===3||n.shape[2]===1,()=>"Error in threshold: image color channel must be equal to 3 or 1but got "+n.shape[2]+"."),Te(n.dtype==="int32"||n.dtype==="float32",()=>"Error in dtype: image dtype must be int32 or float32,but got dtype "+n.dtype+"."),Te(e==="otsu"||e==="binary",()=>"Method must be binary or otsu, but was "+e),n.shape[2]===3){[b,v,S]=GD(n,[1,1,1],-1);const L=js(b,a),N=js(v,p),k=js(S,_);M=Hr(Hr(L,N),k)}else M=l;if(e==="otsu"){const L=lw(kn(ND(M),"int32"),J0([]),256);y=zF(L,g)}const F=i?pb(M,y):db(M,y);return kn(js(F,255),"int32")}function zF(l,e){let i=qs([-1]),s=qs([0]),n=qs([0]),a,p,_,g,y,b;for(let v=0;v<l.size-1;v++){a=Or(l,0,v+1),p=Or(l,v+1),y=us(vn(a),e),b=us(vn(p),e);const S=vn(js(a,Ip(0,a.size)));_=us(S,vn(a));const M=_p(p.shape,a.size),F=Hr(Ip(0,p.size),M),L=js(p,F);g=us(vn(L),vn(p));const N=ia(_,g),k=ia(_,g),G=js(y,b);n=js(js(G,N),k);const H=db(n,s);s=lb(H,n,s),i=lb(H,qs([v]),i)}return i}const HF=It({threshold_:WF});function XF(l,e,i="nearest",s="constant",n=0,a){const p=rt(l,"image","transform","float32"),_=rt(e,"transforms","transform","float32");Te(p.rank===4,()=>"Error in transform: image must be rank 4,but got rank "+p.rank+"."),Te(_.rank===2&&(_.shape[0]===p.shape[0]||_.shape[0]===1)&&_.shape[1]===8,()=>"Error in transform: Input transform should be batch x 8 or 1 x 8"),Te(a==null||a.length===2,()=>"Error in transform: outputShape must be [height, width] or null, but got "+a+".");const g={image:p,transforms:_},y={interpolation:i,fillMode:s,fillValue:n,outputShape:a};return dt.runKernel(Of,g,y)}const YF=It({transform_:XF});var Eb;(function(l){l[l.NONE=0]="NONE",l[l.MEAN=1]="MEAN",l[l.SUM=2]="SUM",l[l.SUM_BY_NONZERO_WEIGHTS=3]="SUM_BY_NONZERO_WEIGHTS"})(Eb||(Eb={}));const No={flipLeftRight:hF,grayscaleToRGB:dF,resizeNearestNeighbor:GF,resizeBilinear:Tb,rgbToGrayscale:pF,rotateWithOffset:_F,cropAndResize:lF,nonMaxSuppression:yF,nonMaxSuppressionAsync:PF,nonMaxSuppressionWithScore:wF,nonMaxSuppressionWithScoreAsync:FF,nonMaxSuppressionPadded:NF,nonMaxSuppressionPaddedAsync:kF,threshold:HF,transform:YF},KF=(()=>typeof requestAnimationFrame<"u"?requestAnimationFrame:typeof setImmediate<"u"?setImmediate:l=>l())();function jF(){return new Promise(l=>KF(()=>l()))}function Op(l,e){const i=l[0].length;l.forEach((n,a)=>{Te(n.length===i,()=>"Error in concat"+i+"D: rank of tensors["+a+"] must be the same as the rank of the rest ("+i+")")}),Te(e>=0&&e<i,()=>"Error in concat"+i+"D: axis must be between 0 and "+(i-1)+".");const s=l[0];l.forEach((n,a)=>{for(let p=0;p<i;p++)Te(p===e||n[p]===s[p],()=>"Error in concat"+i+"D: Shape of tensors["+a+"] ("+n+") does not match the shape of the rest ("+s+") along the non-concatenated axis "+a+".")})}function Bo(l,e){const i=l[0].slice();for(let s=1;s<l.length;s++)i[e]+=l[s][e];return i}var _o;(function(l){l[l.FIRST_DIM_SIZE=0]="FIRST_DIM_SIZE",l[l.VALUE_ROWIDS=1]="VALUE_ROWIDS",l[l.ROW_LENGTHS=2]="ROW_LENGTHS",l[l.ROW_SPLITS=3]="ROW_SPLITS",l[l.ROW_LIMITS=4]="ROW_LIMITS",l[l.ROW_STARTS=5]="ROW_STARTS"})(_o||(_o={}));function Ab(l,e,i){let s=new Array;if(i==null&&e==null)return s;if(e==null)for(;s.length<l+i.length;)s.push(-1);else s=e.slice();if(i==null)return s;if(l+i.length!==s.length)throw new Error("rt input.shape and shape="+e+" are incompatible: rt input.rank = "+(l+i.length)+", but shape.rank = "+s.length);for(let n=1;n<i.length;++n){const a=i[n],p=s[s.length-i.length+n],_=s[p];if(a>=0)if(_>=0){if(_!==a)throw new Error("rt input.shape and shape="+e+" are incompatible: rt input.shape["+(n+l)+"] = "+a+" but shape["+(n+l)+"] = "+_)}else s[p]=a}return s}function Cb(l){const e={FIRST_DIM_SIZE:_o.FIRST_DIM_SIZE,VALUE_ROWIDS:_o.VALUE_ROWIDS,ROW_LENGTHS:_o.ROW_LENGTHS,ROW_SPLITS:_o.ROW_SPLITS,ROW_LIMITS:_o.ROW_LIMITS,ROW_STARTS:_o.ROW_STARTS},i=[];for(const s of l)if(s in e)i.push(e[s]);else break;return i}function Rb(l){return l.length===0?0:l[0]===_o.FIRST_DIM_SIZE?l.length-1:l.length}function Ib(l,e){if(l==null||e==null)return;const i=l.length,s=e.length;if(i>=s)throw new Error("defaultValue.shape="+l+" and ragged tensor flatValues.shape="+e+", are incompatible: defaultValue.rank = "+i+" must be less than ragged tensor input flatValues.rank = "+s+")");for(let n=0;n<Math.min(i,s-1);++n){const a=l[n],p=e[n+1];if(a>=0&&p>=0&&a!==1&&a!==p)throw new Error("defaultValue.shape="+l+", and ragged tensor input flatValues.shape="+e+" are incompatible: defaultValue.shape["+(n-l.length)+"] = "+a+" but ragged tensor input.flatValues.shape["+(n-l.length)+"] = "+p)}}const wp=30;function Sb(l){return l<=wp?l:bs(l,Math.floor(Math.sqrt(l)))}function Dp(l,e,i){const s=i*(typeof l=="number"?l:l[0]),n=e*(typeof l=="number"?l:l[1]);return[s,n]}function qF(l,e,i,s=!0){let n=[];if(s)n=n.concat(e.slice(0)),n.push(l[0]/i),n=n.concat(l.slice(1));else{n=n.concat(l[0]);const a=e.length;for(let p=0;p<a;++p)n=n.concat([l[p+1]/e[p],e[p]]);n=n.concat(l.slice(a+1))}return n}function ZF(l,e,i=!0){const s=[];if(i){s.push(e);for(let n=e+1;n<l;++n)n<=2*e?(s.push(n),s.push(n-(e+1))):s.push(n)}else{const n=[],a=[];for(let p=1;p<l;++p)p>=e*2+1||p%2===1?a.push(p):n.push(p);s.push(...n),s.push(0),s.push(...a)}return s}function QF(l,e,i,s=!0){const n=[];s?n.push(l[0]/i):n.push(l[0]*i);for(let a=1;a<l.length;++a)a<=e.length?s?n.push(e[a-1]*l[a]):n.push(l[a]/e[a-1]):n.push(l[a]);return n}function $F(l,e){const i=[0];for(let s=0;s<e;++s)i.push(l[s][0]);return i}function JF(l,e,i){const s=l.slice(0,1);for(let n=0;n<i;++n)s.push(l[n+1]-e[n][0]-e[n][1]);return s}const eL=1.7580993408473768,tL=1.0507009873554805,iL=.3275911,rL=.254829592,sL=-.284496736,nL=1.421413741,aL=-1.453152027,oL=1.061405429;function ec(l,e){if(l.length!==e.length)throw new Error("Cannot merge real and imag arrays of different lengths. real:"+l.length+", imag: "+e.length+".");const i=new Float32Array(l.length*2);for(let s=0;s<i.length;s+=2)i[s]=l[s/2],i[s+1]=e[s/2];return i}function xL(l){const e=new Float32Array(l.length/2),i=new Float32Array(l.length/2);for(let s=0;s<l.length;s+=2)e[s/2]=l[s],i[s/2]=l[s+1];return{real:e,imag:i}}function lL(l){const e=Math.ceil(l.length/4),i=new Float32Array(e),s=new Float32Array(e);for(let n=0;n<l.length;n+=4)i[Math.floor(n/4)]=l[n],s[Math.floor(n/4)]=l[n+1];return{real:i,imag:s}}function cL(l){const e=Math.floor(l.length/4),i=new Float32Array(e),s=new Float32Array(e);for(let n=2;n<l.length;n+=4)i[Math.floor(n/4)]=l[n],s[Math.floor(n/4)]=l[n+1];return{real:i,imag:s}}function hL(l,e){const i=l[e*2],s=l[e*2+1];return{real:i,imag:s}}function uL(l,e,i,s){l[s*2]=e,l[s*2+1]=i}function dL(l,e){const i=new Float32Array(l/2),s=new Float32Array(l/2);for(let n=0;n<Math.ceil(l/2);n++){const a=(e?2:-2)*Math.PI*(n/l);i[n]=Math.cos(a),s[n]=Math.sin(a)}return{real:i,imag:s}}function fL(l,e,i){const s=(i?2:-2)*Math.PI*(l/e),n=Math.cos(s),a=Math.sin(s);return{real:n,imag:a}}const Fp="->",pL=/->/g,Mb=",",Pb="...";function mL(l,e){l=l.replace(/\s/g,"");const i=(l.length-l.replace(pL,"").length)/Fp.length;if(i<1)throw new Error("Equations without an arrow are not supported.");if(i>1)throw new Error('Equation must contain exactly one arrow ("'+Fp+'").');const[s,n]=l.split(Fp);Te(s.indexOf(Pb)===-1,()=>'The ellipsis notation ("'+Pb+'") is not supported yet.');const a=s.split(Mb),p=a.length;if(e!==p)throw new Error("Expected "+p+" input tensors, received "+e);if(p>2)throw new Error("Support for more than 2 input tensors is not implemented yet.");const _=[];for(let S=0;S<n.length;++S){const M=n[S];if(!a.some(F=>F.indexOf(M)!==-1))throw new Error("Output subscripts contain the label "+M+" not present in the input subscripts.");_.indexOf(M)===-1&&_.push(M)}for(let S=0;S<s.length;++S){const M=s[S];_.indexOf(M)===-1&&M!==Mb&&_.push(M)}const g=new Array(a.length);for(let S=0;S<p;++S){if(new Set(a[S].split("")).size!==a[S].length)throw new Error("Found duplicate axes in input component "+a[S]+". Support for duplicate axes in input is not implemented yet.");g[S]=[];for(let M=0;M<a[S].length;++M)g[S].push(_.indexOf(a[S][M]))}const y=_.length,b=n.length,v=[];for(let S=b;S<y;++S)v.push(S);return{allDims:_,summedDims:v,idDims:g}}function _L(l,e){let i=new Array(l);i.fill(-1);for(let n=0;n<e.length;++n)i[e[n]]=n;const s=[];for(let n=0;n<l;++n)i[n]===-1&&s.push(n);return i=i.filter(n=>n!==-1),{permutationIndices:i,expandDims:s}}function gL(l,e,i){const s=new Array(l);for(let n=0;n<i.length;++n){const a=i[n].shape;for(let p=0;p<e[n].length;++p)s[e[n][p]]===void 0?s[e[n][p]]=a[p]:Te(s[e[n][p]]===a[p],()=>"Expected dimension "+s[e[n][p]]+" at axis "+p+" of input shaped "+JSON.stringify(a)+", but got dimension "+a[p])}}function yL(l,e){const i=l,s=[];let n=0;l.length===0&&i.push(-1),n=l.length+1;for(let p=0;p<n;++p)s.push([]);const a=[];for(let p=0;p<i.length;++p){const _=i[p],g=vL(e,_);for(const y of g)a.indexOf(y)===-1&&(s[p].push(y),a.push(y))}return{path:i,steps:s}}function bL(l){return l.every((e,i)=>e===i)}function vL(l,e){const i=[];for(let s=0;s<l.length;++s)(l[s].length===0||l[s].indexOf(e)!==-1||e===-1)&&i.push(s);return i}function TL(l,e,i=0){let s=[];if(typeof e=="number")Te(l.shape[i]%e===0,()=>"Number of splits must evenly divide the axis."),s=new Array(e).fill(l.shape[i]/e);else{const n=e.reduce((p,_)=>(_===-1&&(p+=1),p),0);Te(n<=1,()=>"There should be only one negative value in split array.");const a=e.indexOf(-1);if(a!==-1){const p=e.reduce((_,g)=>g>0?_+g:_);e[a]=l.shape[i]-p}Te(l.shape[i]===e.reduce((p,_)=>p+_),()=>"The sum of sizes must match the size of the axis dimension."),s=e}return s}function Ob(l){return`Received SparseTensor with denseShape[0] = 0 but
  indices.shape[0] = `+l}function wb(l,e){return"indices("+l+", 0) is invalid: "+e+" < 0"}function Db(l,e,i){return"indices("+l+", 0) is invalid: "+e+" >= "+i}function Fb(l,e){return"only one output dimension may be -1, not both "+l+" and "+e}function Lb(l,e){return"size "+l+" must be non-negative, not "+e}function Nb(){return"reshape cannot infer the missing input size for an empty tensor unless all specified input sizes are non-zero"}function Bb(l,e){const i=Je(l),s=Je(e);return"Input to reshape is a SparseTensor with "+i+`
  dense values, but the requested shape requires a multiple of `+s+". inputShape="+l+" outputShape= "+e}function kb(l,e){const i=Je(l),s=Je(e);return"Input to reshape is a tensor with "+i+" dense values, but the requested shape has "+s+". inputShape="+l+" outputShape="+e}function Lp(){return"segment ids must be >= 0"}function Ub(){return"segment ids are not increasing"}function Vb(l,e){return"Segment id "+l+" out of range [0, "+e+"), possibly because segmentIds input is not sorted."}function Gb(l,e,i){return"Bad: indices["+l+"] == "+e+" out of range [0, "+i+")"}function EL(l,e){let i=!1,s;for(l<=wp?(s=l,i=!0):s=bs(l,Math.floor(Math.sqrt(l)));!i;)s>e||s===l?i=!0:s=bs(l,s+1);return s}function AL(l,e,i){const s=[],n=l.length;for(let a=0;a<n;a++)a!==e?s.push(l[a]):s.push(i);return s}function Np(l,e,i,s){const n=e.shape.length,a=l.shape.length;if(s!==0&&(s<-n||s>n))throw new Error("Expect batchDims in the range of [-"+n+", "+n+"], but got "+s);if(s<0&&(s+=n),s>a)throw new Error("batchDims ("+s+`) must be less than rank(x) (
    `+a+").");if(i<s)throw new Error("batchDims ("+s+") must be less than or equal to axis ("+i+").");for(let v=0;v<s;++v)if(l.shape[v]!==e.shape[v])throw new Error("x.shape["+v+"]: "+l.shape[v]+" should be equal to indices.shape["+v+"]: "+e.shape[v]+".");const p=l.shape[i],_=[];let g=1,y=1,b=1;for(let v=0;v<s;++v)_.push(l.shape[v]),g*=l.shape[v];for(let v=s;v<i;v++)_.push(l.shape[v]),y*=l.shape[v];for(let v=s;v<n;v++)_.push(e.shape[v]);for(let v=i+1;v<a;v++)_.push(l.shape[v]),b*=l.shape[v];return{batchSize:g,sliceSize:b,outerSize:y,dimSize:p,outputShape:_}}var CL=Object.freeze({__proto__:null,collectGatherOpShapeInfo:Np,computeOutShape:AL,segOpComputeOptimalWindowSize:EL});function nx(l){try{return l.map(e=>Gl(e))}catch(e){throw new Error("Failed to decode encoded string bytes into utf-8, error: "+e)}}function Wb(l){return l.map(e=>$0(e))}var RL=Object.freeze({__proto__:null,ERF_A1:rL,ERF_A2:sL,ERF_A3:nL,ERF_A4:aL,ERF_A5:oL,ERF_P:iL,PARALLELIZE_THRESHOLD:wp,get RowPartitionType(){return _o},SELU_SCALE:tL,SELU_SCALEALPHA:eL,applyActivation:Nd,assertAndGetBroadcastShape:is,assertAxesAreInnerMostDims:ix,assertParamsConsistent:Op,assignToTypedArray:uL,axesAreInnerMostDims:gp,calculateShapes:wO,checkEinsumDimSizes:gL,checkPadOnDimRoundingMode:d0,combineLocations:cb,combineRaggedTensorToTensorShapes:Ab,complexWithEvenIndex:lL,complexWithOddIndex:cL,computeConv2DInfo:mo,computeConv3DInfo:ab,computeDefaultPad:dp,computeDilation2DInfo:jO,computeOptimalWindowSize:Sb,computeOutAndReduceShapes:Fo,computeOutShape:Bo,computePool2DInfo:jl,computePool3DInfo:qO,convertConv2DDataFormat:dh,decodeEinsumEquation:mL,eitherStridesOrDilationsAreOne:ta,expandShapeToKeepDim:f0,exponent:fL,exponents:dL,fromStringArrayToUint8:Wb,fromUint8ToStringArray:nx,getAxesPermutation:rx,getBroadcastDims:Kl,getComplexWithIndex:hL,getEinsumComputePath:yL,getEinsumPermutation:_L,getFusedBiasGradient:Ld,getFusedDyActivation:Fd,getImageCenter:Dp,getInnerMostAxes:sx,getPermuted:ZF,getRaggedRank:Rb,getReductionAxes:jy,getReshaped:qF,getReshapedPermuted:QF,getRowPartitionTypesHelper:Cb,getSliceBeginCoords:$F,getSliceSize:JF,getSparseFillEmptyRowsIndicesDenseShapeMismatch:Ob,getSparseFillEmptyRowsNegativeIndexErrorMessage:wb,getSparseFillEmptyRowsOutOfRangeIndexErrorMessage:Db,getSparseReshapeEmptyTensorZeroOutputDimErrorMessage:Nb,getSparseReshapeInputOutputMismatchErrorMessage:kb,getSparseReshapeInputOutputMultipleErrorMessage:Bb,getSparseReshapeMultipleNegativeOneOutputDimErrorMessage:Fb,getSparseReshapeNegativeOutputDimErrorMessage:Lb,getSparseSegmentReductionIndicesOutOfRangeErrorMessage:Gb,getSparseSegmentReductionNegativeSegmentIdsErrorMessage:Lp,getSparseSegmentReductionNonIncreasingSegmentIdsErrorMessage:Ub,getSparseSegmentReductionSegmentIdOutOfRangeErrorMessage:Vb,getUndoAxesPermutation:Mw,isIdentityPermutation:bL,log:$M,mergeRealAndImagArrays:ec,prepareAndValidate:OO,prepareSplitSize:TL,segment_util:CL,shouldFuse:Bd,slice_util:BO,splitRealAndImagArrays:xL,stridesOrDilationsArePositive:pp,tupleValuesAreOne:uh,upcastType:Do,validateDefaultValueShape:Ib,validateInput:Zy,validateUpdateShape:qy,warn:l0});class IL{constructor(){this.messageName="setTimeoutCustom",this.functionRefs=[],this.handledMessageCount=0,this.hasEventListener=!1}fetch(e,i){return fetch(e,i)}now(){return performance.now()}encode(e,i){if(i!=="utf-8"&&i!=="utf8")throw new Error("Browser's encoder only supports utf-8, but got "+i);return this.textEncoder==null&&(this.textEncoder=new TextEncoder),this.textEncoder.encode(e)}decode(e,i){return new TextDecoder(i).decode(e)}setTimeoutCustom(e,i){if(typeof window>"u"||!Ue().getBool("USE_SETTIMEOUTCUSTOM")){setTimeout(e,i);return}this.functionRefs.push(e),setTimeout(()=>{window.postMessage({name:this.messageName,index:this.functionRefs.length-1},"*")},i),this.hasEventListener||(this.hasEventListener=!0,window.addEventListener("message",s=>{if(s.source===window&&s.data.name===this.messageName){s.stopPropagation();const n=this.functionRefs[s.data.index];n(),this.handledMessageCount++,this.handledMessageCount===this.functionRefs.length&&(this.functionRefs=[],this.handledMessageCount=0)}},!0))}isTypedArray(e){return Zg(e)}}if(Ue().get("IS_BROWSER")){Ue().setPlatform("browser",new IL);try{bn.registerManager(el.URL_SCHEME,new QP)}catch{}try{bn.registerManager(Jx.URL_SCHEME,new zP)}catch{}}const SL={importFetch:()=>fa(300)};let Bp;class ML{constructor(){this.util=fa(539),this.textEncoder=new this.util.TextEncoder}fetch(e,i){return Ue().global.fetch!=null?Ue().global.fetch(e,i):(Bp==null&&(Bp=SL.importFetch()),Bp(e,i))}now(){const e=process.hrtime();return e[0]*1e3+e[1]/1e6}encode(e,i){if(i!=="utf-8"&&i!=="utf8")throw new Error("Node built-in encoder only supports utf-8, but got "+i);return this.textEncoder.encode(e)}decode(e,i){return e.length===0?"":new this.util.TextDecoder(i).decode(e)}isTypedArray(e){return this.util.types.isFloat32Array(e)||this.util.types.isInt32Array(e)||this.util.types.isUint8Array(e)||this.util.types.isUint8ClampedArray(e)}}Ue().get("IS_NODE")&&!Ue().get("IS_BROWSER")&&Ue().setPlatform("node",new ML),yy(),_P({buffer:Jr,cast:kn,clone:Id,print:yD});var PL=Object.defineProperty,zb=Object.getOwnPropertySymbols,OL=Object.prototype.hasOwnProperty,wL=Object.prototype.propertyIsEnumerable,kp=(l,e,i)=>e in l?PL(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,DL=(l,e)=>{for(var i in e||(e={}))OL.call(e,i)&&kp(l,i,e[i]);if(zb)for(var i of zb(e))wL.call(e,i)&&kp(l,i,e[i]);return l},ax=(l,e,i)=>(kp(l,typeof e!="symbol"?e+"":e,i),i);class FL{constructor(e){this.model=e,ax(this,"modelSize"),ax(this,"modelRatio"),ax(this,"anchorsX"),ax(this,"anchorsY"),ax(this,"anchorsData"),ax(this,"posesMax",1),ax(this,"iouThresh",.3),ax(this,"scoreThresh",.5),this.model=e,this.modelSize=e.inputs[0].shape?{width:e.inputs[0].shape[2],height:e.inputs[0].shape[1]}:{width:224,height:224},this.modelRatio=this.modelSize.width/this.modelSize.height,this.anchorsData=this.buildAnchors(this.modelSize),this.anchorsX=qs(this.anchorsData.map(i=>i.x)),this.anchorsY=qs(this.anchorsData.map(i=>i.y))}async process(e){let i={x:0,y:0};const[s,n]=zr(()=>{const y={width:e.shape[2],height:e.shape[1]},b=y.width/y.height;let v=DL({},y),S={x:0,y:0};b>this.modelRatio?(v.height=e.shape[2]/this.modelRatio,S.y=Math.floor((v.height-e.shape[1])*.5),i.y=S.y/v.height):b<this.modelRatio&&(v.width=e.shape[1]*this.modelRatio,S.x=Math.floor((v.width-e.shape[2])*.5),i.x=S.x/v.width);const M=wd(e,[[0,0],[S.y,S.y],[S.x,S.x],[0,0]],0),F=No.resizeBilinear(M,[this.modelSize.height,this.modelSize.width]),L=this.model.execute(F,"person"),N=ds(Or(L,[0,0,1],[1,-1,-1])),k=ds(Or(L,[0,0,0],[1,-1,1])),G=fh(ob(k,-100,100));return[this.decodeBoxes(N,[this.anchorsX,this.anchorsY],this.modelSize),G]}),a=await s.data(),p=await n.data();let _=[];for(let y=0;y<p.length;y++){if(p[y]<this.scoreThresh)continue;const b=a[y*12+2]-a[y*12+0],v=a[y*12+3]-a[y*12+1];b<0||v<0||_.push({box:[[a[y*12+0],a[y*12+1]],[a[y*12+2],a[y*12+3]]],points:[[a[y*12+4],a[y*12+5]],[a[y*12+6],a[y*12+7]],[a[y*12+8],a[y*12+9]],[a[y*12+10],a[y*12+11]]],score:p[y]})}if(s.dispose(),n.dispose(),_.length<1)return[];if(_.length>1){const y=Mp(_.map(F=>[F.box[0][1],F.box[0][0],F.box[1][1],F.box[1][0]])),b=qs(_.map(F=>F.score)),v=await No.nonMaxSuppressionAsync(y,b,this.posesMax,this.iouThresh,this.scoreThresh),S=await v.data();v.dispose();const M=[];for(let F=0;F<S.length;F++)M.push(_[S[F]]);_=M}if(_.length<1)return[];const g={width:1-2*i.x,height:1-2*i.y};return _.map(y=>({box:y.box.map(b=>[(b[0]-i.x)/g.width,(b[1]-i.y)/g.height]),points:y.points.map(b=>[(b[0]-i.x)/g.width,(b[1]-i.y)/g.height]),score:y.score}))}decodeBoxes(e,i,s){let n=ds(Or(e,[0,0],[-1,1])),a=ds(Or(e,[0,1],[-1,1])),p=ds(Or(e,[0,2],[-1,1])),_=ds(Or(e,[0,3],[-1,1]));n=Hr(us(n,s.width),i[0]),a=Hr(us(a,s.height),i[1]),p=us(p,s.width*2),_=us(_,s.height*2);const g=ti(ia(n,p),[2254,1]),y=ti(ia(a,_),[2254,1]),b=ti(Hr(n,p),[2254,1]),v=ti(Hr(a,_),[2254,1]);let S=ph([g,y,b,v],1);for(let M=0;M<4;M++){let F=ds(Or(e,[0,4+M*2],[-1,1])),L=ds(Or(e,[0,4+M*2+1],[-1,1]));F=ti(Hr(us(F,s.width),i[0]),[2254,1]),L=ti(Hr(us(L,s.height),i[1]),[2254,1]),S=ph([S,F,L],1)}return S}buildAnchors(e){const i=[8,16,32,32,32],s=[];let n=0;for(;n<5;){let a=0,p=n;for(;p<i.length&&i[p]===i[n];)a+=2,p++;const _=i[n],g=Math.ceil(e.height/_),y=Math.ceil(e.width/_);for(let b=0;b<g;++b)for(let v=0;v<y;++v)for(let S=0;S<a;++S)s.push({x:(v+.5)/y,y:(b+.5)/g});n=p}return s}async prepare(){const{width:e,height:i}=this.modelSize,s=Lo([1,i,e,3]),n=this.model.execute(s,"person");await n.data(),s.dispose(),n.dispose()}dispose(){this.model.dispose(),this.anchorsX.dispose(),this.anchorsY.dispose()}}var LL=Object.defineProperty,NL=(l,e,i)=>e in l?LL(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,Hb=(l,e,i)=>(NL(l,typeof e!="symbol"?e+"":e,i),i);class BL{constructor(e,i=!1){this.model=e,this.mask=i,Hb(this,"modelSize"),Hb(this,"sizeFactor",1.2),this.model=e,this.modelSize=e.inputs[0].shape?{width:e.inputs[0].shape[2],height:e.inputs[0].shape[1]}:{width:256,height:256}}async process(e,i){const[s,n]=[e.shape[1],e.shape[2]],{modelSize:a}=this;return i.map(p=>{const _=[p.center[0]*n,p.center[1]*s],g=[p.top[0]*n,p.top[1]*s],y=[g[0]-_[0],g[1]-_[1]],b=Math.sqrt(y[0]*y[0]+y[1]*y[1])*this.sizeFactor,v=Math.atan2(y[0],-y[1]),S=[_[1]-b,_[0]-b,_[1]+b,_[0]+b],M=zr(()=>{const se=this.rotatedRect(e,S,v,a);return Hr(js(se,.5),.5)}),F=["ld_3d","world_3d","output_poseflag","activation_heatmap"];this.mask&&F.push("activation_segmentation");const[L,N,k,G,H]=this.model.execute(M,F),z=L.dataSync(),W=N.dataSync(),Y=k.dataSync()[0];let Z=[];for(let se=0;se<39;se++)Z.push([z[se*5+0]/a.width,z[se*5+1]/a.height,z[se*5+2]/a.width]);let Q;if(H){const se=No.rotateWithOffset(H,-v),$=ds(se,[0]),oe=js($,255);Q=new Uint8Array(oe.dataSync()),se.dispose(),$.dispose(),oe.dispose(),H.dispose()}return M.dispose(),L.dispose(),N.dispose(),k.dispose(),Z=this.refinePoints(Z,G),G.dispose(),{points:Z,pointsData:z,metricData:W,maskData:Q,score:Y,center:_,top:g,radius:b,angle:v}}).map(p=>{const{points:_,pointsData:g,metricData:y,maskData:b,score:v,center:S,top:M,radius:F,angle:L}=p;let N=_.map((Z,Q)=>({pixel:Z,metric:[y[Q*3+0],y[Q*3+1],y[Q*3+2]],score:1/(1+Math.exp(-g[Q*5+3])),visibility:1/(1+Math.exp(-g[Q*5+4]))}));N.forEach(Z=>{Z.pixel[0]=(Z.pixel[0]-.5)*2*F,Z.pixel[1]=(Z.pixel[1]-.5)*2*F,Z.pixel[2]*=2*F});const k=Math.sin(L),G=Math.cos(L);N.forEach(Z=>{const Q=Z.pixel[0],se=Z.pixel[1];Z.pixel[0]=(Q*G-se*k+S[0])/n,Z.pixel[1]=(Q*k+se*G+S[1])/s,Z.pixel[2]/=n;const $=Z.metric[0],oe=Z.metric[1];Z.metric[0]=$*G-oe*k,Z.metric[1]=$*k+oe*G});const H=N.map(Z=>Z.pixel[0]),z=N.map(Z=>Z.pixel[1]),W=[[Math.min(...H),Math.min(...z)],[Math.max(...H),Math.max(...z)]],Y=b&&{buffer:b,size:{width:256,height:256},box:[[(S[0]-F)/n,(S[1]-F)/s],[(S[0]+F)/n,(S[1]+F)/s]]};return{keypoints:N,score:v,mask:Y,center:[N[33].pixel[0],N[33].pixel[1]],top:[N[34].pixel[0],N[34].pixel[1]],debug:{center:S,top:M,box:W,radius:F,angle:L}}})}refinePoints(e,i){const s=ds(i,[0]),n=s.bufferSync(),[a,p,_]=s.shape;return e.map((g,y)=>{const b=g,v=Math.trunc(b[0]*p),S=Math.trunc(b[1]*a);if(v<0||v>=p||S<0||S>=a)return g;const M=Math.trunc((7-1)/2),F=Math.max(v-M,0),L=Math.min(v+M+1,p),N=Math.max(S-M,0),k=Math.min(S+M+1,a);let G=0,H=0,z=0,W=0;for(let Y=N;Y<k;Y++)for(let Z=F;Z<L;Z++){const Q=n.get(Y,Z,y);G+=Q,H=Math.max(Q,H),z+=Z*Q,W+=Y*Q}return s.dispose(),H>=.5&&G>0?[z/G/p,W/G/a,b[2]]:g})}rotatedRect(e,i,s,n){const[a,p]=[i[2]-i[0],i[3]-i[1]],[_,g]=[(i[2]+i[0])*.5,(i[3]+i[1])*.5],[y,b]=[a/n.height,p/n.width],[v,S]=[Math.cos(s),Math.sin(s)],M=[v*b,-S*y,(-v*p+S*a)*.5+g,S*b,v*y,(-S*p-v*a)*.5+_,0,0];return No.transform(e,[M],"bilinear","constant",0,[n.height,n.width])}async prepare(){const{width:e,height:i}=this.modelSize,s=Lo([1,i,e,3]),n=this.model.execute(s);await Promise.all(n.map(async a=>{await a.data(),a.dispose()})),s.dispose()}async dispose(){var e;(e=this.model)==null||e.dispose()}}var kL=Object.defineProperty,Xb=Object.getOwnPropertySymbols,UL=Object.prototype.hasOwnProperty,VL=Object.prototype.propertyIsEnumerable,Up=(l,e,i)=>e in l?kL(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,Yb=(l,e)=>{for(var i in e||(e={}))UL.call(e,i)&&Up(l,i,e[i]);if(Xb)for(var i of Xb(e))VL.call(e,i)&&Up(l,i,e[i]);return l},ko=(l,e,i)=>(Up(l,typeof e!="symbol"?e+"":e,i),i);class GL{constructor(){ko(this,"freq",30),ko(this,"pixelParams",{minCutOff:.2,minCutOffD:1,beta:20}),ko(this,"metricParams",{minCutOff:.1,minCutOffD:1,beta:20}),ko(this,"boxParams",{minCutOff:.05,minCutOffD:1,beta:5}),ko(this,"scoreCutOff",1),ko(this,"visibilityCutOff",1),ko(this,"raw"),ko(this,"smooth"),ko(this,"der"),ko(this,"time",0)}filter(e,i,s=1){return this.time>=i?e:(this.time!==0&&(this.freq=1/(i-this.time)),this.time=i,!this.raw||!this.smooth||!this.der?(this.raw=this.clonePose(e),this.smooth=this.clonePose(e),this.der={keypoints:e.keypoints.map(()=>({pixel:[0,0,0],metric:[0,0,0],score:0,visibility:0})),score:0,center:[0,0],top:[0,0],debug:{box:[[0,0],[0,0]],center:[0,0],top:[0,0],radius:0,angle:0}},this.clonePose(this.smooth)):(this.filterKeypoints(e.keypoints,this.raw.keypoints,this.der.keypoints,this.smooth.keypoints,s),this.filterCoord2D(e.center,this.raw.center,this.der.center,this.smooth.center,s,this.boxParams),this.filterCoord2D(e.top,this.raw.top,this.der.top,this.smooth.top,s,this.boxParams),this.smooth.score=e.score,this.smooth.mask=e.mask&&{buffer:e.mask.buffer,size:Yb({},e.mask.size),box:[[...e.mask.box[0]],[...e.mask.box[1]]]},this.smooth.debug=e.debug&&{center:[...e.debug.center],top:[...e.debug.top],box:[[...e.debug.box[0]],[...e.debug.box[1]]],radius:e.debug.radius,angle:e.debug.angle},this.clonePose(this.smooth)))}filterKeypoints(e,i,s,n,a){const p=this.alpha(this.visibilityCutOff),_=this.alpha(this.scoreCutOff);for(let g=0;g<e.length;g++)this.filterCoord3D(e[g].pixel,i[g].pixel,s[g].pixel,n[g].pixel,a,this.pixelParams),this.filterCoord3D(e[g].metric,i[g].metric,s[g].metric,n[g].metric,a,this.metricParams),n[g].score=n[g].score+_*(e[g].score-n[g].score),n[g].visibility=n[g].visibility+p*(e[g].visibility-n[g].visibility)}filterCoord3D(e,i,s,n,a,p){const _=[(e[0]-n[0])*a*this.freq,(e[1]-n[1])*a*this.freq,(e[2]-n[2])*a*this.freq],g=this.alpha(p.minCutOffD);s[0]=s[0]+g*(_[0]-s[0]),s[1]=s[1]+g*(_[1]-s[1]),s[2]=s[2]+g*(_[2]-s[2]);const y=[this.alpha(p.minCutOff+p.beta*Math.abs(s[0])),this.alpha(p.minCutOff+p.beta*Math.abs(s[1])),this.alpha(p.minCutOff+p.beta*Math.abs(s[2]))];n[0]=n[0]+y[0]*(e[0]-n[0]),n[1]=n[1]+y[1]*(e[1]-n[1]),n[2]=n[2]+y[2]*(e[2]-n[2]),i[0]=e[0],i[1]=e[1],i[2]=e[2]}filterCoord2D(e,i,s,n,a,p){const _=[(e[0]-n[0])*a*this.freq,(e[1]-n[1])*a*this.freq],g=this.alpha(p.minCutOffD);s[0]=s[0]+g*(_[0]-s[0]),s[1]=s[1]+g*(_[1]-s[1]);const y=[this.alpha(p.minCutOff+p.beta*Math.abs(s[0])),this.alpha(p.minCutOff+p.beta*Math.abs(s[1]))];n[0]=n[0]+y[0]*(e[0]-n[0]),n[1]=n[1]+y[1]*(e[1]-n[1]),i[0]=e[0],i[1]=e[1]}reset(){delete this.raw,delete this.smooth,delete this.der}alpha(e){return 1/(1+this.freq/(2*Math.PI*e))}clonePose(e){return{keypoints:e.keypoints.map(i=>({pixel:[...i.pixel],metric:[...i.metric],score:i.score,visibility:i.visibility})),score:e.score,center:[...e.center],top:[...e.top],mask:e.mask&&{buffer:e.mask.buffer,size:Yb({},e.mask.size),box:[[...e.mask.box[0]],[...e.mask.box[1]]]},debug:e.debug&&{box:[[...e.debug.box[0]],[...e.debug.box[1]]],center:[...e.debug.center],top:[...e.debug.top],radius:e.debug.radius,angle:e.debug.angle}}}}function WL(l,e){const i=[Math.max(l.xy.x,e.xy.x),Math.max(l.xy.y,e.xy.y)],s=[Math.min(l.xy.x+l.size.width,l.xy.x+l.size.width),Math.min(l.xy.y+l.size.height,l.xy.y+l.size.height)],n=(s[0]-i[0])*(s[1]-i[1]);return n/(l.size.width*l.size.height+e.size.width*e.size.height-n)}function Kb(l,e){const i=[[Math.max(l[0][0],e[0][0]),Math.max(l[0][1],e[0][1])],[Math.min(l[1][0],e[1][0]),Math.min(l[1][1],e[1][1])]],s=(i[1][0]-i[0][0])*(i[1][1]-i[0][1]);return s/((l[1][0]-l[0][0])*(l[1][1]-l[0][1])+(e[1][0]-e[0][0])*(e[1][1]-e[0][1])-s)}var zL=(()=>{var l=typeof document<"u"&&document.currentScript?document.currentScript.src:void 0;return function(e){e=e||{};var i=typeof e<"u"?e:{},s,n;i.ready=new Promise(function(he,le){s=he,n=le});var a=Object.assign({},i),p=!0,_="";function g(he){return i.locateFile?i.locateFile(he,_):_+he}var y;typeof document<"u"&&document.currentScript&&(_=document.currentScript.src),l&&(_=l),_.indexOf("blob:")!==0?_=_.substr(0,_.replace(/[?#].*/,"").lastIndexOf("/")+1):_="",i.print||console.log.bind(console);var b=i.printErr||console.warn.bind(console);Object.assign(i,a),a=null,i.arguments&&i.arguments,i.thisProgram&&i.thisProgram,i.quit&&i.quit;var v;i.wasmBinary&&(v=i.wasmBinary),i.noExitRuntime,typeof WebAssembly!="object"&&mi("no native wasm support detected");var S,M=!1;function F(he,le){he||mi(le)}var L=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function N(he,le,ve){for(var Ge=le+ve,ne=le;he[ne]&&!(ne>=Ge);)++ne;if(ne-le>16&&he.buffer&&L)return L.decode(he.subarray(le,ne));for(var re="";le<ne;){var ce=he[le++];if(!(ce&128)){re+=String.fromCharCode(ce);continue}var me=he[le++]&63;if((ce&224)==192){re+=String.fromCharCode((ce&31)<<6|me);continue}var Se=he[le++]&63;if((ce&240)==224?ce=(ce&15)<<12|me<<6|Se:ce=(ce&7)<<18|me<<12|Se<<6|he[le++]&63,ce<65536)re+=String.fromCharCode(ce);else{var Fe=ce-65536;re+=String.fromCharCode(55296|Fe>>10,56320|Fe&1023)}}return re}function k(he,le){return he?N(ye,he,le):""}function G(he,le,ve,Ge){if(!(Ge>0))return 0;for(var ne=ve,re=ve+Ge-1,ce=0;ce<he.length;++ce){var me=he.charCodeAt(ce);if(me>=55296&&me<=57343){var Se=he.charCodeAt(++ce);me=65536+((me&1023)<<10)|Se&1023}if(me<=127){if(ve>=re)break;le[ve++]=me}else if(me<=2047){if(ve+1>=re)break;le[ve++]=192|me>>6,le[ve++]=128|me&63}else if(me<=65535){if(ve+2>=re)break;le[ve++]=224|me>>12,le[ve++]=128|me>>6&63,le[ve++]=128|me&63}else{if(ve+3>=re)break;le[ve++]=240|me>>18,le[ve++]=128|me>>12&63,le[ve++]=128|me>>6&63,le[ve++]=128|me&63}}return le[ve]=0,ve-ne}function H(he,le,ve){return G(he,ye,le,ve)}function z(he){for(var le=0,ve=0;ve<he.length;++ve){var Ge=he.charCodeAt(ve);Ge>=55296&&Ge<=57343&&(Ge=65536+((Ge&1023)<<10)|he.charCodeAt(++ve)&1023),Ge<=127?++le:Ge<=2047?le+=2:Ge<=65535?le+=3:le+=4}return le}var W=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0;function Y(he,le){for(var ve=he,Ge=ve>>1,ne=Ge+le/2;!(Ge>=ne)&&we[Ge];)++Ge;if(ve=Ge<<1,ve-he>32&&W)return W.decode(ye.subarray(he,ve));for(var re="",ce=0;!(ce>=le/2);++ce){var me=_e[he+ce*2>>1];if(me==0)break;re+=String.fromCharCode(me)}return re}function Z(he,le,ve){if(ve===void 0&&(ve=2147483647),ve<2)return 0;ve-=2;for(var Ge=le,ne=ve<he.length*2?ve/2:he.length,re=0;re<ne;++re){var ce=he.charCodeAt(re);_e[le>>1]=ce,le+=2}return _e[le>>1]=0,le-Ge}function Q(he){return he.length*2}function se(he,le){for(var ve=0,Ge="";!(ve>=le/4);){var ne=Pe[he+ve*4>>2];if(ne==0)break;if(++ve,ne>=65536){var re=ne-65536;Ge+=String.fromCharCode(55296|re>>10,56320|re&1023)}else Ge+=String.fromCharCode(ne)}return Ge}function $(he,le,ve){if(ve===void 0&&(ve=2147483647),ve<4)return 0;for(var Ge=le,ne=Ge+ve-4,re=0;re<he.length;++re){var ce=he.charCodeAt(re);if(ce>=55296&&ce<=57343){var me=he.charCodeAt(++re);ce=65536+((ce&1023)<<10)|me&1023}if(Pe[le>>2]=ce,le+=4,le+4>ne)break}return Pe[le>>2]=0,le-Ge}function oe(he){for(var le=0,ve=0;ve<he.length;++ve){var Ge=he.charCodeAt(ve);Ge>=55296&&Ge<=57343&&++ve,le+=4}return le}var ue,de,ye,_e,we,Pe,Ee,We,et;function ke(he){ue=he,i.HEAP8=de=new Int8Array(he),i.HEAP16=_e=new Int16Array(he),i.HEAP32=Pe=new Int32Array(he),i.HEAPU8=ye=new Uint8Array(he),i.HEAPU16=we=new Uint16Array(he),i.HEAPU32=Ee=new Uint32Array(he),i.HEAPF32=We=new Float32Array(he),i.HEAPF64=et=new Float64Array(he)}i.INITIAL_MEMORY;var $e,pt=[],Xe=[],Tt=[];function fi(){if(i.preRun)for(typeof i.preRun=="function"&&(i.preRun=[i.preRun]);i.preRun.length;)Gt(i.preRun.shift());Zn(pt)}function li(){Zn(Xe)}function Ot(){if(i.postRun)for(typeof i.postRun=="function"&&(i.postRun=[i.postRun]);i.postRun.length;)si(i.postRun.shift());Zn(Tt)}function Gt(he){pt.unshift(he)}function bi(he){Xe.unshift(he)}function si(he){Tt.unshift(he)}var oi=0,ci=null;function Li(he){oi++,i.monitorRunDependencies&&i.monitorRunDependencies(oi)}function hi(he){if(oi--,i.monitorRunDependencies&&i.monitorRunDependencies(oi),oi==0&&ci){var le=ci;ci=null,le()}}function mi(he){i.onAbort&&i.onAbort(he),he="Aborted("+he+")",b(he),M=!0,he+=". Build with -sASSERTIONS for more info.";var le=new WebAssembly.RuntimeError(he);throw n(le),le}var cr="data:application/octet-stream;base64,";function Ui(he){return he.startsWith(cr)}var Ii;Ii="poseutils.wasm",Ui(Ii)||(Ii=g(Ii));function Cr(he){try{if(he==Ii&&v)return new Uint8Array(v);throw"both async and sync fetching of the wasm failed"}catch(le){mi(le)}}function an(){return!v&&p&&typeof fetch=="function"?fetch(Ii,{credentials:"same-origin"}).then(function(he){if(!he.ok)throw"failed to load wasm binary file at '"+Ii+"'";return he.arrayBuffer()}).catch(function(){return Cr(Ii)}):Promise.resolve().then(function(){return Cr(Ii)})}function un(){var he={a:Qc};function le(ce,me){var Se=ce.exports;i.asm=Se,S=i.asm.y,ke(S.buffer),$e=i.asm.C,bi(i.asm.z),hi()}Li();function ve(ce){le(ce.instance)}function Ge(ce){return an().then(function(me){return WebAssembly.instantiate(me,he)}).then(function(me){return me}).then(ce,function(me){b("failed to asynchronously prepare wasm: "+me),mi(me)})}function ne(){return!v&&typeof WebAssembly.instantiateStreaming=="function"&&!Ui(Ii)&&typeof fetch=="function"?fetch(Ii,{credentials:"same-origin"}).then(function(ce){var me=WebAssembly.instantiateStreaming(ce,he);return me.then(ve,function(Se){return b("wasm streaming compile failed: "+Se),b("falling back to ArrayBuffer instantiation"),Ge(ve)})}):Ge(ve)}if(i.instantiateWasm)try{var re=i.instantiateWasm(he,le);return re}catch(ce){return b("Module.instantiateWasm callback failed with error: "+ce),!1}return ne().catch(n),{}}function Zn(he){for(;he.length>0;){var le=he.shift();if(typeof le=="function"){le(i);continue}var ve=le.func;typeof ve=="number"?le.arg===void 0?Yr(ve)():Yr(ve)(le.arg):ve(le.arg===void 0?null:le.arg)}}var On=[];function Yr(he){var le=On[he];return le||(he>=On.length&&(On.length=he+1),On[he]=le=$e.get(he)),le}function eo(he){return Hx(he+24)+24}function $o(he){this.excPtr=he,this.ptr=he-24,this.set_type=function(le){Ee[this.ptr+4>>2]=le},this.get_type=function(){return Ee[this.ptr+4>>2]},this.set_destructor=function(le){Ee[this.ptr+8>>2]=le},this.get_destructor=function(){return Ee[this.ptr+8>>2]},this.set_refcount=function(le){Pe[this.ptr>>2]=le},this.set_caught=function(le){le=le?1:0,de[this.ptr+12>>0]=le},this.get_caught=function(){return de[this.ptr+12>>0]!=0},this.set_rethrown=function(le){le=le?1:0,de[this.ptr+13>>0]=le},this.get_rethrown=function(){return de[this.ptr+13>>0]!=0},this.init=function(le,ve){this.set_adjusted_ptr(0),this.set_type(le),this.set_destructor(ve),this.set_refcount(0),this.set_caught(!1),this.set_rethrown(!1)},this.add_ref=function(){var le=Pe[this.ptr>>2];Pe[this.ptr>>2]=le+1},this.release_ref=function(){var le=Pe[this.ptr>>2];return Pe[this.ptr>>2]=le-1,le===1},this.set_adjusted_ptr=function(le){Ee[this.ptr+16>>2]=le},this.get_adjusted_ptr=function(){return Ee[this.ptr+16>>2]},this.get_exception_ptr=function(){var le=Jc(this.get_type());if(le)return Ee[this.excPtr>>2];var ve=this.get_adjusted_ptr();return ve!==0?ve:this.excPtr}}function Jo(he,le,ve){var Ge=new $o(he);throw Ge.init(le,ve),he}var dn={};function wn(he){for(;he.length;){var le=he.pop(),ve=he.pop();ve(le)}}function Wr(he){return this.fromWireType(Ee[he>>2])}var fn={},zs={},Qn={},k0=48,U0=57;function to(he){if(he===void 0)return"_unknown";he=he.replace(/[^a-zA-Z0-9_]/g,"$");var le=he.charCodeAt(0);return le>=k0&&le<=U0?"_"+he:he}function V0(he,le){return he=to(he),function(){return le.apply(this,arguments)}}function io(he,le){var ve=V0(le,function(Ge){this.name=le,this.message=Ge;var ne=new Error(Ge).stack;ne!==void 0&&(this.stack=this.toString()+`
`+ne.replace(/^Error(:[^\n]*)?\n/,""))});return ve.prototype=Object.create(he.prototype),ve.prototype.constructor=ve,ve.prototype.toString=function(){return this.message===void 0?this.name:this.name+": "+this.message},ve}var Kr=void 0;function Hs(he){throw new Kr(he)}function Sr(he,le,ve){he.forEach(function(me){Qn[me]=le});function Ge(me){var Se=ve(me);Se.length!==he.length&&Hs("Mismatched type converter count");for(var Fe=0;Fe<he.length;++Fe)ps(he[Fe],Se[Fe])}var ne=new Array(le.length),re=[],ce=0;le.forEach((me,Se)=>{zs.hasOwnProperty(me)?ne[Se]=zs[me]:(re.push(me),fn.hasOwnProperty(me)||(fn[me]=[]),fn[me].push(()=>{ne[Se]=zs[me],++ce,ce===re.length&&Ge(ne)}))}),re.length===0&&Ge(ne)}function e0(he){var le=dn[he];delete dn[he];var ve=le.rawConstructor,Ge=le.rawDestructor,ne=le.fields,re=ne.map(ce=>ce.getterReturnType).concat(ne.map(ce=>ce.setterArgumentType));Sr([he],re,ce=>{var me={};return ne.forEach((Se,Fe)=>{var Ne=Se.fieldName,De=ce[Fe],it=Se.getter,mt=Se.getterContext,Dt=ce[Fe+ne.length],Wt=Se.setter,Di=Se.setterContext;me[Ne]={read:Hi=>De.fromWireType(it(mt,Hi)),write:(Hi,fr)=>{var Gi=[];Wt(Di,Hi,Dt.toWireType(Gi,fr)),wn(Gi)}}}),[{name:le.name,fromWireType:function(Se){var Fe={};for(var Ne in me)Fe[Ne]=me[Ne].read(Se);return Ge(Se),Fe},toWireType:function(Se,Fe){for(var Ne in me)if(!(Ne in Fe))throw new TypeError('Missing field:  "'+Ne+'"');var De=ve();for(Ne in me)me[Ne].write(De,Fe[Ne]);return Se!==null&&Se.push(Ge,De),De},argPackAdvance:8,readValueFromPointer:Wr,destructorFunction:Ge}]})}function ro(he,le,ve,Ge,ne){}function Ro(he){switch(he){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+he)}}function t0(){for(var he=new Array(256),le=0;le<256;++le)he[le]=String.fromCharCode(le);so=he}var so=void 0;function xs(he){for(var le="",ve=he;ye[ve];)le+=so[ye[ve++]];return le}var on=void 0;function Rt(he){throw new on(he)}function ps(he,le,ve={}){if(!("argPackAdvance"in le))throw new TypeError("registerType registeredInstance requires argPackAdvance");var Ge=le.name;if(he||Rt('type "'+Ge+'" must have a positive integer typeid pointer'),zs.hasOwnProperty(he)){if(ve.ignoreDuplicateRegistrations)return;Rt("Cannot register type '"+Ge+"' twice")}if(zs[he]=le,delete Qn[he],fn.hasOwnProperty(he)){var ne=fn[he];delete fn[he],ne.forEach(re=>re())}}function Vi(he,le,ve,Ge,ne){var re=Ro(ve);le=xs(le),ps(he,{name:le,fromWireType:function(ce){return!!ce},toWireType:function(ce,me){return me?Ge:ne},argPackAdvance:8,readValueFromPointer:function(ce){var me;if(ve===1)me=de;else if(ve===2)me=_e;else if(ve===4)me=Pe;else throw new TypeError("Unknown boolean type size: "+le);return this.fromWireType(me[ce>>re])},destructorFunction:null})}function Rs(he){if(!(this instanceof oo)||!(he instanceof oo))return!1;for(var le=this.$$.ptrType.registeredClass,ve=this.$$.ptr,Ge=he.$$.ptrType.registeredClass,ne=he.$$.ptr;le.baseClass;)ve=le.upcast(ve),le=le.baseClass;for(;Ge.baseClass;)ne=Ge.upcast(ne),Ge=Ge.baseClass;return le===Ge&&ve===ne}function Ls(he){return{count:he.count,deleteScheduled:he.deleteScheduled,preservePointerOnDelete:he.preservePointerOnDelete,ptr:he.ptr,ptrType:he.ptrType,smartPtr:he.smartPtr,smartPtrType:he.smartPtrType}}function da(he){function le(ve){return ve.$$.ptrType.registeredClass.name}Rt(le(he)+" instance already deleted")}var Io=!1;function Nx(he){}function G0(he){he.smartPtr?he.smartPtrType.rawDestructor(he.smartPtr):he.ptrType.registeredClass.rawDestructor(he.ptr)}function W0(he){he.count.value-=1;var le=he.count.value===0;le&&G0(he)}function Sl(he,le,ve){if(le===ve)return he;if(ve.baseClass===void 0)return null;var Ge=Sl(he,le,ve.baseClass);return Ge===null?null:ve.downcast(Ge)}var Ml={};function Pl(){return Object.keys(Sa).length}function Ol(){var he=[];for(var le in Sa)Sa.hasOwnProperty(le)&&he.push(Sa[le]);return he}var i0=[];function wl(){for(;i0.length;){var he=i0.pop();he.$$.deleteScheduled=!1,he.delete()}}var Ia=void 0;function So(he){Ia=he,i0.length&&Ia&&Ia(wl)}function Mo(){i.getInheritedInstanceCount=Pl,i.getLiveInheritedInstances=Ol,i.flushPendingDeletes=wl,i.setDelayFunction=So}var Sa={};function bu(he,le){for(le===void 0&&Rt("ptr should not be undefined");he.baseClass;)le=he.upcast(le),he=he.baseClass;return le}function z0(he,le){return le=bu(he,le),Sa[le]}function no(he,le){(!le.ptrType||!le.ptr)&&Hs("makeClassHandle requires ptr and ptrType");var ve=!!le.smartPtrType,Ge=!!le.smartPtr;return ve!==Ge&&Hs("Both smartPtrType and smartPtr must be specified"),le.count={value:1},ao(Object.create(he,{$$:{value:le}}))}function vu(he){var le=this.getPointee(he);if(!le)return this.destructor(he),null;var ve=z0(this.registeredClass,le);if(ve!==void 0){if(ve.$$.count.value===0)return ve.$$.ptr=le,ve.$$.smartPtr=he,ve.clone();var Ge=ve.clone();return this.destructor(he),Ge}function ne(){return this.isSmartPointer?no(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:le,smartPtrType:this,smartPtr:he}):no(this.registeredClass.instancePrototype,{ptrType:this,ptr:he})}var re=this.registeredClass.getActualType(le),ce=Ml[re];if(!ce)return ne.call(this);var me;this.isConst?me=ce.constPointerType:me=ce.pointerType;var Se=Sl(le,this.registeredClass,me.registeredClass);return Se===null?ne.call(this):this.isSmartPointer?no(me.registeredClass.instancePrototype,{ptrType:me,ptr:Se,smartPtrType:this,smartPtr:he}):no(me.registeredClass.instancePrototype,{ptrType:me,ptr:Se})}function ao(he){return typeof FinalizationRegistry>"u"?(ao=le=>le,he):(Io=new FinalizationRegistry(le=>{W0(le.$$)}),ao=le=>{var ve=le.$$,Ge=!!ve.smartPtr;if(Ge){var ne={$$:ve};Io.register(le,ne,le)}return le},Nx=le=>Io.unregister(le),ao(he))}function Bx(){if(this.$$.ptr||da(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var he=ao(Object.create(Object.getPrototypeOf(this),{$$:{value:Ls(this.$$)}}));return he.$$.count.value+=1,he.$$.deleteScheduled=!1,he}function H0(){this.$$.ptr||da(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&Rt("Object already scheduled for deletion"),Nx(this),W0(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0)}function X0(){return!this.$$.ptr}function Tu(){return this.$$.ptr||da(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&Rt("Object already scheduled for deletion"),i0.push(this),i0.length===1&&Ia&&Ia(wl),this.$$.deleteScheduled=!0,this}function Eu(){oo.prototype.isAliasOf=Rs,oo.prototype.clone=Bx,oo.prototype.delete=H0,oo.prototype.isDeleted=X0,oo.prototype.deleteLater=Tu}function oo(){}function Xc(he,le,ve){if(he[le].overloadTable===void 0){var Ge=he[le];he[le]=function(){return he[le].overloadTable.hasOwnProperty(arguments.length)||Rt("Function '"+ve+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+he[le].overloadTable+")!"),he[le].overloadTable[arguments.length].apply(this,arguments)},he[le].overloadTable=[],he[le].overloadTable[Ge.argCount]=Ge}}function xo(he,le,ve){i.hasOwnProperty(he)?((ve===void 0||i[he].overloadTable!==void 0&&i[he].overloadTable[ve]!==void 0)&&Rt("Cannot register public name '"+he+"' twice"),Xc(i,he,he),i.hasOwnProperty(ve)&&Rt("Cannot register multiple overloads of a function with the same number of arguments ("+ve+")!"),i[he].overloadTable[ve]=le):(i[he]=le,ve!==void 0&&(i[he].numArguments=ve))}function Ma(he,le,ve,Ge,ne,re,ce,me){this.name=he,this.constructor=le,this.instancePrototype=ve,this.rawDestructor=Ge,this.baseClass=ne,this.getActualType=re,this.upcast=ce,this.downcast=me,this.pureVirtualFunctions=[]}function Y0(he,le,ve){for(;le!==ve;)le.upcast||Rt("Expected null or instance of "+ve.name+", got an instance of "+le.name),he=le.upcast(he),le=le.baseClass;return he}function Au(he,le){if(le===null)return this.isReference&&Rt("null is not a valid "+this.name),0;le.$$||Rt('Cannot pass "'+s0(le)+'" as a '+this.name),le.$$.ptr||Rt("Cannot pass deleted object as a pointer of type "+this.name);var ve=le.$$.ptrType.registeredClass,Ge=Y0(le.$$.ptr,ve,this.registeredClass);return Ge}function kx(he,le){var ve;if(le===null)return this.isReference&&Rt("null is not a valid "+this.name),this.isSmartPointer?(ve=this.rawConstructor(),he!==null&&he.push(this.rawDestructor,ve),ve):0;le.$$||Rt('Cannot pass "'+s0(le)+'" as a '+this.name),le.$$.ptr||Rt("Cannot pass deleted object as a pointer of type "+this.name),!this.isConst&&le.$$.ptrType.isConst&&Rt("Cannot convert argument of type "+(le.$$.smartPtrType?le.$$.smartPtrType.name:le.$$.ptrType.name)+" to parameter type "+this.name);var Ge=le.$$.ptrType.registeredClass;if(ve=Y0(le.$$.ptr,Ge,this.registeredClass),this.isSmartPointer)switch(le.$$.smartPtr===void 0&&Rt("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:le.$$.smartPtrType===this?ve=le.$$.smartPtr:Rt("Cannot convert argument of type "+(le.$$.smartPtrType?le.$$.smartPtrType.name:le.$$.ptrType.name)+" to parameter type "+this.name);break;case 1:ve=le.$$.smartPtr;break;case 2:if(le.$$.smartPtrType===this)ve=le.$$.smartPtr;else{var ne=le.clone();ve=this.rawShare(ve,xn.toHandle(function(){ne.delete()})),he!==null&&he.push(this.rawDestructor,ve)}break;default:Rt("Unsupporting sharing policy")}return ve}function Ux(he,le){if(le===null)return this.isReference&&Rt("null is not a valid "+this.name),0;le.$$||Rt('Cannot pass "'+s0(le)+'" as a '+this.name),le.$$.ptr||Rt("Cannot pass deleted object as a pointer of type "+this.name),le.$$.ptrType.isConst&&Rt("Cannot convert argument of type "+le.$$.ptrType.name+" to parameter type "+this.name);var ve=le.$$.ptrType.registeredClass,Ge=Y0(le.$$.ptr,ve,this.registeredClass);return Ge}function Cu(he){return this.rawGetPointee&&(he=this.rawGetPointee(he)),he}function Ru(he){this.rawDestructor&&this.rawDestructor(he)}function Iu(he){he!==null&&he.delete()}function Vx(){Pa.prototype.getPointee=Cu,Pa.prototype.destructor=Ru,Pa.prototype.argPackAdvance=8,Pa.prototype.readValueFromPointer=Wr,Pa.prototype.deleteObject=Iu,Pa.prototype.fromWireType=vu}function Pa(he,le,ve,Ge,ne,re,ce,me,Se,Fe,Ne){this.name=he,this.registeredClass=le,this.isReference=ve,this.isConst=Ge,this.isSmartPointer=ne,this.pointeeType=re,this.sharingPolicy=ce,this.rawGetPointee=me,this.rawConstructor=Se,this.rawShare=Fe,this.rawDestructor=Ne,!ne&&le.baseClass===void 0?Ge?(this.toWireType=Au,this.destructorFunction=null):(this.toWireType=Ux,this.destructorFunction=null):this.toWireType=kx}function Su(he,le,ve){i.hasOwnProperty(he)||Hs("Replacing nonexistant public symbol"),i[he].overloadTable!==void 0&&ve!==void 0?i[he].overloadTable[ve]=le:(i[he]=le,i[he].argCount=ve)}function Oa(he,le,ve){var Ge=i["dynCall_"+he];return ve&&ve.length?Ge.apply(null,[le].concat(ve)):Ge.call(null,le)}function Mu(he,le,ve){return he.includes("j")?Oa(he,le,ve):Yr(le).apply(null,ve)}function wa(he,le){var ve=[];return function(){return ve.length=0,Object.assign(ve,arguments),Mu(he,le,ve)}}function Dn(he,le){he=xs(he);function ve(){return he.includes("j")?wa(he,le):Yr(le)}var Ge=ve();return typeof Ge!="function"&&Rt("unknown function pointer with signature "+he+": "+le),Ge}var Yc=void 0;function Is(he){var le=$c(he),ve=xs(le);return Fa(le),ve}function r0(he,le){var ve=[],Ge={};function ne(re){if(!Ge[re]&&!zs[re]){if(Qn[re]){Qn[re].forEach(ne);return}ve.push(re),Ge[re]=!0}}throw le.forEach(ne),new Yc(he+": "+ve.map(Is).join([", "]))}function Da(he,le,ve,Ge,ne,re,ce,me,Se,Fe,Ne,De,it){Ne=xs(Ne),re=Dn(ne,re),me&&(me=Dn(ce,me)),Fe&&(Fe=Dn(Se,Fe)),it=Dn(De,it);var mt=to(Ne);xo(mt,function(){r0("Cannot construct "+Ne+" due to unbound types",[Ge])}),Sr([he,le,ve],Ge?[Ge]:[],function(Dt){Dt=Dt[0];var Wt,Di;Ge?(Wt=Dt.registeredClass,Di=Wt.instancePrototype):Di=oo.prototype;var Hi=V0(mt,function(){if(Object.getPrototypeOf(this)!==fr)throw new on("Use 'new' to construct "+Ne);if(Gi.constructor_body===void 0)throw new on(Ne+" has no accessible constructor");var ts=Gi.constructor_body[arguments.length];if(ts===void 0)throw new on("Tried to invoke ctor of "+Ne+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(Gi.constructor_body).toString()+") parameters instead!");return ts.apply(this,arguments)}),fr=Object.create(Di,{constructor:{value:Hi}});Hi.prototype=fr;var Gi=new Ma(Ne,Hi,fr,it,Wt,re,me,Fe),ls=new Pa(Ne,Gi,!0,!1,!1),ms=new Pa(Ne+"*",Gi,!1,!1,!1),mn=new Pa(Ne+" const*",Gi,!1,!0,!1);return Ml[he]={pointerType:ms,constPointerType:mn},Su(mt,Hi),[ls,ms,mn]})}function Po(he,le){for(var ve=[],Ge=0;Ge<he;Ge++)ve.push(Pe[(le>>2)+Ge]);return ve}function Kc(he,le,ve,Ge,ne,re){F(le>0);var ce=Po(le,ve);ne=Dn(Ge,ne),Sr([],[he],function(me){me=me[0];var Se="constructor "+me.name;if(me.registeredClass.constructor_body===void 0&&(me.registeredClass.constructor_body=[]),me.registeredClass.constructor_body[le-1]!==void 0)throw new on("Cannot register multiple constructors with identical number of parameters ("+(le-1)+") for class '"+me.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return me.registeredClass.constructor_body[le-1]=()=>{r0("Cannot construct "+me.name+" due to unbound types",ce)},Sr([],ce,function(Fe){return Fe.splice(1,0,null),me.registeredClass.constructor_body[le-1]=Oo(Se,Fe,null,ne,re),[]}),[]})}function Oo(he,le,ve,Ge,ne){var re=le.length;re<2&&Rt("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var ce=le[1]!==null&&ve!==null,me=!1,Se=1;Se<le.length;++Se)if(le[Se]!==null&&le[Se].destructorFunction===void 0){me=!0;break}var Fe=le[0].name!=="void",Ne=re-2,De=new Array(Ne),it=[],mt=[];return function(){arguments.length!==Ne&&Rt("function "+he+" called with "+arguments.length+" arguments, expected "+Ne+" args!"),mt.length=0;var Dt;it.length=ce?2:1,it[0]=ne,ce&&(Dt=le[1].toWireType(mt,this),it[1]=Dt);for(var Wt=0;Wt<Ne;++Wt)De[Wt]=le[Wt+2].toWireType(mt,arguments[Wt]),it.push(De[Wt]);var Di=Ge.apply(null,it);function Hi(fr){if(me)wn(mt);else for(var Gi=ce?1:2;Gi<le.length;Gi++){var ls=Gi===1?Dt:De[Gi-2];le[Gi].destructorFunction!==null&&le[Gi].destructorFunction(ls)}if(Fe)return le[0].fromWireType(fr)}return Hi(Di)}}function Pu(he,le,ve,Ge,ne,re,ce,me){var Se=Po(ve,Ge);le=xs(le),re=Dn(ne,re),Sr([],[he],function(Fe){Fe=Fe[0];var Ne=Fe.name+"."+le;le.startsWith("@@")&&(le=Symbol[le.substring(2)]),me&&Fe.registeredClass.pureVirtualFunctions.push(le);function De(){r0("Cannot call "+Ne+" due to unbound types",Se)}var it=Fe.registeredClass.instancePrototype,mt=it[le];return mt===void 0||mt.overloadTable===void 0&&mt.className!==Fe.name&&mt.argCount===ve-2?(De.argCount=ve-2,De.className=Fe.name,it[le]=De):(Xc(it,le,Ne),it[le].overloadTable[ve-2]=De),Sr([],Se,function(Dt){var Wt=Oo(Ne,Dt,Fe,re,ce);return it[le].overloadTable===void 0?(Wt.argCount=ve-2,it[le]=Wt):it[le].overloadTable[ve-2]=Wt,[]}),[]})}function Gx(he,le,ve){return he instanceof Object||Rt(ve+' with invalid "this": '+he),he instanceof le.registeredClass.constructor||Rt(ve+' incompatible with "this" of type '+he.constructor.name),he.$$.ptr||Rt("cannot call emscripten binding method "+ve+" on deleted object"),Y0(he.$$.ptr,he.$$.ptrType.registeredClass,le.registeredClass)}function Dl(he,le,ve,Ge,ne,re,ce,me,Se,Fe){le=xs(le),ne=Dn(Ge,ne),Sr([],[he],function(Ne){Ne=Ne[0];var De=Ne.name+"."+le,it={get:function(){r0("Cannot access "+De+" due to unbound types",[ve,ce])},enumerable:!0,configurable:!0};return Se?it.set=()=>{r0("Cannot access "+De+" due to unbound types",[ve,ce])}:it.set=mt=>{Rt(De+" is a read-only property")},Object.defineProperty(Ne.registeredClass.instancePrototype,le,it),Sr([],Se?[ve,ce]:[ve],function(mt){var Dt=mt[0],Wt={get:function(){var Hi=Gx(this,Ne,De+" getter");return Dt.fromWireType(ne(re,Hi))},enumerable:!0};if(Se){Se=Dn(me,Se);var Di=mt[1];Wt.set=function(Hi){var fr=Gx(this,Ne,De+" setter"),Gi=[];Se(Fe,fr,Di.toWireType(Gi,Hi)),wn(Gi)}}return Object.defineProperty(Ne.registeredClass.instancePrototype,le,Wt),[]}),[]})}var Wx=[],Fn=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function zx(he){he>4&&--Fn[he].refcount===0&&(Fn[he]=void 0,Wx.push(he))}function Ln(){for(var he=0,le=5;le<Fn.length;++le)Fn[le]!==void 0&&++he;return he}function jc(){for(var he=5;he<Fn.length;++he)if(Fn[he]!==void 0)return Fn[he];return null}function Fl(){i.count_emval_handles=Ln,i.get_first_emval=jc}var xn={toValue:he=>(he||Rt("Cannot use deleted val. handle = "+he),Fn[he].value),toHandle:he=>{switch(he){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:{var le=Wx.length?Wx.pop():Fn.length;return Fn[le]={refcount:1,value:he},le}}}};function Ll(he,le){le=xs(le),ps(he,{name:le,fromWireType:function(ve){var Ge=xn.toValue(ve);return zx(ve),Ge},toWireType:function(ve,Ge){return xn.toHandle(Ge)},argPackAdvance:8,readValueFromPointer:Wr,destructorFunction:null})}function s0(he){if(he===null)return"null";var le=typeof he;return le==="object"||le==="array"||le==="function"?he.toString():""+he}function Ou(he,le){switch(le){case 2:return function(ve){return this.fromWireType(We[ve>>2])};case 3:return function(ve){return this.fromWireType(et[ve>>3])};default:throw new TypeError("Unknown float type: "+he)}}function Nl(he,le,ve){var Ge=Ro(ve);le=xs(le),ps(he,{name:le,fromWireType:function(ne){return ne},toWireType:function(ne,re){return re},argPackAdvance:8,readValueFromPointer:Ou(le,Ge),destructorFunction:null})}function pn(he,le,ve){switch(le){case 0:return ve?function(Ge){return de[Ge]}:function(Ge){return ye[Ge]};case 1:return ve?function(Ge){return _e[Ge>>1]}:function(Ge){return we[Ge>>1]};case 2:return ve?function(Ge){return Pe[Ge>>2]}:function(Ge){return Ee[Ge>>2]};default:throw new TypeError("Unknown integer type: "+he)}}function wu(he,le,ve,Ge,ne){le=xs(le);var re=Ro(ve),ce=De=>De;if(Ge===0){var me=32-8*ve;ce=De=>De<<me>>>me}var Se=le.includes("unsigned"),Fe=(De,it)=>{},Ne;Se?Ne=function(De,it){return Fe(it,this.name),it>>>0}:Ne=function(De,it){return Fe(it,this.name),it},ps(he,{name:le,fromWireType:ce,toWireType:Ne,argPackAdvance:8,readValueFromPointer:pn(le,re,Ge!==0),destructorFunction:null})}function Bl(he,le,ve){var Ge=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],ne=Ge[le];function re(ce){ce=ce>>2;var me=Ee,Se=me[ce],Fe=me[ce+1];return new ne(ue,Fe,Se)}ve=xs(ve),ps(he,{name:ve,fromWireType:re,argPackAdvance:8,readValueFromPointer:re},{ignoreDuplicateRegistrations:!0})}function Du(he,le){le=xs(le);var ve=le==="std::string";ps(he,{name:le,fromWireType:function(Ge){var ne=Ee[Ge>>2],re;if(ve)for(var ce=Ge+4,me=0;me<=ne;++me){var Se=Ge+4+me;if(me==ne||ye[Se]==0){var Fe=Se-ce,Ne=k(ce,Fe);re===void 0?re=Ne:(re+=String.fromCharCode(0),re+=Ne),ce=Se+1}}else{for(var De=new Array(ne),me=0;me<ne;++me)De[me]=String.fromCharCode(ye[Ge+4+me]);re=De.join("")}return Fa(Ge),re},toWireType:function(Ge,ne){ne instanceof ArrayBuffer&&(ne=new Uint8Array(ne));var re,ce=typeof ne=="string";ce||ne instanceof Uint8Array||ne instanceof Uint8ClampedArray||ne instanceof Int8Array||Rt("Cannot pass non-string to std::string"),ve&&ce?re=()=>z(ne):re=()=>ne.length;var me=re(),Se=Hx(4+me+1);if(Ee[Se>>2]=me,ve&&ce)H(ne,Se+4,me+1);else if(ce)for(var Fe=0;Fe<me;++Fe){var Ne=ne.charCodeAt(Fe);Ne>255&&(Fa(Se),Rt("String has UTF-16 code units that do not fit in 8 bits")),ye[Se+4+Fe]=Ne}else for(var Fe=0;Fe<me;++Fe)ye[Se+4+Fe]=ne[Fe];return Ge!==null&&Ge.push(Fa,Se),Se},argPackAdvance:8,readValueFromPointer:Wr,destructorFunction:function(Ge){Fa(Ge)}})}function Fu(he,le,ve){ve=xs(ve);var Ge,ne,re,ce,me;le===2?(Ge=Y,ne=Z,ce=Q,re=()=>we,me=1):le===4&&(Ge=se,ne=$,ce=oe,re=()=>Ee,me=2),ps(he,{name:ve,fromWireType:function(Se){for(var Fe=Ee[Se>>2],Ne=re(),De,it=Se+4,mt=0;mt<=Fe;++mt){var Dt=Se+4+mt*le;if(mt==Fe||Ne[Dt>>me]==0){var Wt=Dt-it,Di=Ge(it,Wt);De===void 0?De=Di:(De+=String.fromCharCode(0),De+=Di),it=Dt+le}}return Fa(Se),De},toWireType:function(Se,Fe){typeof Fe!="string"&&Rt("Cannot pass non-string to C++ string type "+ve);var Ne=ce(Fe),De=Hx(4+Ne+le);return Ee[De>>2]=Ne>>me,ne(Fe,De+4,Ne+le),Se!==null&&Se.push(Fa,De),De},argPackAdvance:8,readValueFromPointer:Wr,destructorFunction:function(Se){Fa(Se)}})}function Lu(he,le,ve,Ge,ne,re){dn[he]={name:xs(le),rawConstructor:Dn(ve,Ge),rawDestructor:Dn(ne,re),fields:[]}}function Nu(he,le,ve,Ge,ne,re,ce,me,Se,Fe){dn[he].fields.push({fieldName:xs(le),getterReturnType:ve,getter:Dn(Ge,ne),getterContext:re,setterArgumentType:ce,setter:Dn(me,Se),setterContext:Fe})}function Bu(he,le){le=xs(le),ps(he,{isVoid:!0,name:le,argPackAdvance:0,fromWireType:function(){},toWireType:function(ve,Ge){}})}function ku(he){he>4&&(Fn[he].refcount+=1)}function Uu(he,le){var ve=zs[he];return ve===void 0&&Rt(le+" has unknown type "+Is(he)),ve}function Vu(he,le){he=Uu(he,"_emval_take_value");var ve=he.readValueFromPointer(le);return xn.toHandle(ve)}function Gu(){mi("")}function qc(he,le,ve){ye.copyWithin(he,le,le+ve)}function Wu(){return 2147483648}function zu(he){try{return S.grow(he-ue.byteLength+65535>>>16),ke(S.buffer),1}catch{}}function Zc(he){var le=ye.length;he=he>>>0;var ve=Wu();if(he>ve)return!1;let Ge=(Se,Fe)=>Se+(Fe-Se%Fe)%Fe;for(var ne=1;ne<=4;ne*=2){var re=le*(1+.2/ne);re=Math.min(re,he+100663296);var ce=Math.min(ve,Ge(Math.max(he,re),65536)),me=zu(ce);if(me)return!0}return!1}Kr=i.InternalError=io(Error,"InternalError"),t0(),on=i.BindingError=io(Error,"BindingError"),Eu(),Mo(),Vx(),Yc=i.UnboundTypeError=io(Error,"UnboundTypeError"),Fl();var Qc={c:eo,b:Jo,x:e0,q:ro,v:Vi,j:Da,i:Kc,d:Pu,f:Dl,u:Ll,l:Nl,e:wu,a:Bl,k:Du,g:Fu,m:Lu,h:Nu,w:Bu,n:zx,o:ku,p:Vu,r:Gu,t:qc,s:Zc};un(),i.___wasm_call_ctors=function(){return(i.___wasm_call_ctors=i.asm.z).apply(null,arguments)};var Fa=i._free=function(){return(Fa=i._free=i.asm.A).apply(null,arguments)},Hx=i._malloc=function(){return(Hx=i._malloc=i.asm.B).apply(null,arguments)},$c=i.___getTypeName=function(){return($c=i.___getTypeName=i.asm.D).apply(null,arguments)};i.___embind_register_native_and_builtin_types=function(){return(i.___embind_register_native_and_builtin_types=i.asm.E).apply(null,arguments)};var Jc=i.___cxa_is_pointer_type=function(){return(Jc=i.___cxa_is_pointer_type=i.asm.F).apply(null,arguments)},Nn;ci=function he(){Nn||n0(),Nn||(ci=he)};function n0(he){if(oi>0||(fi(),oi>0))return;function le(){Nn||(Nn=!0,i.calledRun=!0,!M&&(li(),s(i),i.onRuntimeInitialized&&i.onRuntimeInitialized(),Ot()))}i.setStatus?(i.setStatus("Running..."),setTimeout(function(){setTimeout(function(){i.setStatus("")},1),le()},1)):le()}if(i.run=n0,i.preInit)for(typeof i.preInit=="function"&&(i.preInit=[i.preInit]);i.preInit.length>0;)i.preInit.pop()();return n0(),e.ready}})(),Vp=(()=>{var l=typeof document<"u"&&document.currentScript?document.currentScript.src:void 0;return function(e){e=e||{};var i=typeof e<"u"?e:{},s,n;i.ready=new Promise(function(ae,ie){s=ae,n=ie});var a=Object.assign({},i),p="./this.program",_=(ae,ie)=>{throw ie},g=!0,y=!1,b="";function v(ae){return i.locateFile?i.locateFile(ae,b):b+ae}var S;typeof document<"u"&&document.currentScript&&(b=document.currentScript.src),l&&(b=l),b.indexOf("blob:")!==0?b=b.substr(0,b.replace(/[?#].*/,"").lastIndexOf("/")+1):b="",i.print||console.log.bind(console);var M=i.printErr||console.warn.bind(console);Object.assign(i,a),a=null,i.arguments&&i.arguments,i.thisProgram&&(p=i.thisProgram),i.quit&&(_=i.quit);var F;i.wasmBinary&&(F=i.wasmBinary),i.noExitRuntime,typeof WebAssembly!="object"&&un("no native wasm support detected");var L,N=!1,k;function G(ae,ie){ae||un(ie)}var H=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function z(ae,ie,pe){for(var Me=ie+pe,tt=ie;ae[tt]&&!(tt>=Me);)++tt;if(tt-ie>16&&ae.buffer&&H)return H.decode(ae.subarray(ie,tt));for(var st="";ie<tt;){var lt=ae[ie++];if(!(lt&128)){st+=String.fromCharCode(lt);continue}var je=ae[ie++]&63;if((lt&224)==192){st+=String.fromCharCode((lt&31)<<6|je);continue}var Ft=ae[ie++]&63;if((lt&240)==224?lt=(lt&15)<<12|je<<6|Ft:lt=(lt&7)<<18|je<<12|Ft<<6|ae[ie++]&63,lt<65536)st+=String.fromCharCode(lt);else{var Ht=lt-65536;st+=String.fromCharCode(55296|Ht>>10,56320|Ht&1023)}}return st}function W(ae,ie){return ae?z(et,ae,ie):""}function Y(ae,ie,pe,Me){if(!(Me>0))return 0;for(var tt=pe,st=pe+Me-1,lt=0;lt<ae.length;++lt){var je=ae.charCodeAt(lt);if(je>=55296&&je<=57343){var Ft=ae.charCodeAt(++lt);je=65536+((je&1023)<<10)|Ft&1023}if(je<=127){if(pe>=st)break;ie[pe++]=je}else if(je<=2047){if(pe+1>=st)break;ie[pe++]=192|je>>6,ie[pe++]=128|je&63}else if(je<=65535){if(pe+2>=st)break;ie[pe++]=224|je>>12,ie[pe++]=128|je>>6&63,ie[pe++]=128|je&63}else{if(pe+3>=st)break;ie[pe++]=240|je>>18,ie[pe++]=128|je>>12&63,ie[pe++]=128|je>>6&63,ie[pe++]=128|je&63}}return ie[pe]=0,pe-tt}function Z(ae,ie,pe){return Y(ae,et,ie,pe)}function Q(ae){for(var ie=0,pe=0;pe<ae.length;++pe){var Me=ae.charCodeAt(pe);Me>=55296&&Me<=57343&&(Me=65536+((Me&1023)<<10)|ae.charCodeAt(++pe)&1023),Me<=127?++ie:Me<=2047?ie+=2:Me<=65535?ie+=3:ie+=4}return ie}var se=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0;function $(ae,ie){for(var pe=ae,Me=pe>>1,tt=Me+ie/2;!(Me>=tt)&&$e[Me];)++Me;if(pe=Me<<1,pe-ae>32&&se)return se.decode(et.subarray(ae,pe));for(var st="",lt=0;!(lt>=ie/2);++lt){var je=ke[ae+lt*2>>1];if(je==0)break;st+=String.fromCharCode(je)}return st}function oe(ae,ie,pe){if(pe===void 0&&(pe=2147483647),pe<2)return 0;pe-=2;for(var Me=ie,tt=pe<ae.length*2?pe/2:ae.length,st=0;st<tt;++st){var lt=ae.charCodeAt(st);ke[ie>>1]=lt,ie+=2}return ke[ie>>1]=0,ie-Me}function ue(ae){return ae.length*2}function de(ae,ie){for(var pe=0,Me="";!(pe>=ie/4);){var tt=pt[ae+pe*4>>2];if(tt==0)break;if(++pe,tt>=65536){var st=tt-65536;Me+=String.fromCharCode(55296|st>>10,56320|st&1023)}else Me+=String.fromCharCode(tt)}return Me}function ye(ae,ie,pe){if(pe===void 0&&(pe=2147483647),pe<4)return 0;for(var Me=ie,tt=Me+pe-4,st=0;st<ae.length;++st){var lt=ae.charCodeAt(st);if(lt>=55296&&lt<=57343){var je=ae.charCodeAt(++st);lt=65536+((lt&1023)<<10)|je&1023}if(pt[ie>>2]=lt,ie+=4,ie+4>tt)break}return pt[ie>>2]=0,ie-Me}function _e(ae){for(var ie=0,pe=0;pe<ae.length;++pe){var Me=ae.charCodeAt(pe);Me>=55296&&Me<=57343&&++pe,ie+=4}return ie}function we(ae,ie){We.set(ae,ie)}function Pe(ae,ie,pe){for(var Me=0;Me<ae.length;++Me)We[ie++>>0]=ae.charCodeAt(Me);pe||(We[ie>>0]=0)}var Ee,We,et,ke,$e,pt,Xe,Tt,fi;function li(ae){Ee=ae,i.HEAP8=We=new Int8Array(ae),i.HEAP16=ke=new Int16Array(ae),i.HEAP32=pt=new Int32Array(ae),i.HEAPU8=et=new Uint8Array(ae),i.HEAPU16=$e=new Uint16Array(ae),i.HEAPU32=Xe=new Uint32Array(ae),i.HEAPF32=Tt=new Float32Array(ae),i.HEAPF64=fi=new Float64Array(ae)}i.INITIAL_MEMORY;var Ot,Gt=[],bi=[],si=[];function oi(){if(i.preRun)for(typeof i.preRun=="function"&&(i.preRun=[i.preRun]);i.preRun.length;)hi(i.preRun.shift());dn(Gt)}function ci(){dn(bi)}function Li(){if(i.postRun)for(typeof i.postRun=="function"&&(i.postRun=[i.postRun]);i.postRun.length;)cr(i.postRun.shift());dn(si)}function hi(ae){Gt.unshift(ae)}function mi(ae){bi.unshift(ae)}function cr(ae){si.unshift(ae)}var Ui=0,Ii=null;function Cr(ae){Ui++,i.monitorRunDependencies&&i.monitorRunDependencies(Ui)}function an(ae){if(Ui--,i.monitorRunDependencies&&i.monitorRunDependencies(Ui),Ui==0&&Ii){var ie=Ii;Ii=null,ie()}}function un(ae){i.onAbort&&i.onAbort(ae),ae="Aborted("+ae+")",M(ae),N=!0,k=1,ae+=". Build with -sASSERTIONS for more info.";var ie=new WebAssembly.RuntimeError(ae);throw n(ie),ie}var Zn="data:application/octet-stream;base64,";function On(ae){return ae.startsWith(Zn)}var Yr;Yr="bodyutils.wasm",On(Yr)||(Yr=v(Yr));function eo(ae){try{if(ae==Yr&&F)return new Uint8Array(F);throw"both async and sync fetching of the wasm failed"}catch(ie){un(ie)}}function $o(){return!F&&g&&typeof fetch=="function"?fetch(Yr,{credentials:"same-origin"}).then(function(ae){if(!ae.ok)throw"failed to load wasm binary file at '"+Yr+"'";return ae.arrayBuffer()}).catch(function(){return eo(Yr)}):Promise.resolve().then(function(){return eo(Yr)})}function Jo(){var ae={a:rf};function ie(lt,je){var Ft=lt.exports;i.asm=Ft,L=i.asm.G,li(L.buffer),Ot=i.asm.J,mi(i.asm.H),an()}Cr();function pe(lt){ie(lt.instance)}function Me(lt){return $o().then(function(je){return WebAssembly.instantiate(je,ae)}).then(function(je){return je}).then(lt,function(je){M("failed to asynchronously prepare wasm: "+je),un(je)})}function tt(){return!F&&typeof WebAssembly.instantiateStreaming=="function"&&!On(Yr)&&typeof fetch=="function"?fetch(Yr,{credentials:"same-origin"}).then(function(lt){var je=WebAssembly.instantiateStreaming(lt,ae);return je.then(pe,function(Ft){return M("wasm streaming compile failed: "+Ft),M("falling back to ArrayBuffer instantiation"),Me(pe)})}):Me(pe)}if(i.instantiateWasm)try{var st=i.instantiateWasm(ae,ie);return st}catch(lt){return M("Module.instantiateWasm callback failed with error: "+lt),!1}return tt().catch(n),{}}function dn(ae){for(;ae.length>0;){var ie=ae.shift();if(typeof ie=="function"){ie(i);continue}var pe=ie.func;typeof pe=="number"?ie.arg===void 0?Wr(pe)():Wr(pe)(ie.arg):pe(ie.arg===void 0?null:ie.arg)}}var wn=[];function Wr(ae){var ie=wn[ae];return ie||(ae>=wn.length&&(wn.length=ae+1),wn[ae]=ie=Ot.get(ae)),ie}function fn(ae){if(ae instanceof hX||ae=="unwind")return k;_(1,ae)}function zs(ae){return a0(ae+24)+24}function Qn(ae){this.excPtr=ae,this.ptr=ae-24,this.set_type=function(ie){Xe[this.ptr+4>>2]=ie},this.get_type=function(){return Xe[this.ptr+4>>2]},this.set_destructor=function(ie){Xe[this.ptr+8>>2]=ie},this.get_destructor=function(){return Xe[this.ptr+8>>2]},this.set_refcount=function(ie){pt[this.ptr>>2]=ie},this.set_caught=function(ie){ie=ie?1:0,We[this.ptr+12>>0]=ie},this.get_caught=function(){return We[this.ptr+12>>0]!=0},this.set_rethrown=function(ie){ie=ie?1:0,We[this.ptr+13>>0]=ie},this.get_rethrown=function(){return We[this.ptr+13>>0]!=0},this.init=function(ie,pe){this.set_adjusted_ptr(0),this.set_type(ie),this.set_destructor(pe),this.set_refcount(0),this.set_caught(!1),this.set_rethrown(!1)},this.add_ref=function(){var ie=pt[this.ptr>>2];pt[this.ptr>>2]=ie+1},this.release_ref=function(){var ie=pt[this.ptr>>2];return pt[this.ptr>>2]=ie-1,ie===1},this.set_adjusted_ptr=function(ie){Xe[this.ptr+16>>2]=ie},this.get_adjusted_ptr=function(){return Xe[this.ptr+16>>2]},this.get_exception_ptr=function(){var ie=AM(this.get_type());if(ie)return Xe[this.excPtr>>2];var pe=this.get_adjusted_ptr();return pe!==0?pe:this.excPtr}}function k0(ae,ie,pe){var Me=new Qn(ae);throw Me.init(ie,pe),ae}function U0(ae,ie,pe,Me,tt){}function to(ae){switch(ae){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+ae)}}function V0(){for(var ae=new Array(256),ie=0;ie<256;++ie)ae[ie]=String.fromCharCode(ie);io=ae}var io=void 0;function Kr(ae){for(var ie="",pe=ae;et[pe];)ie+=io[et[pe++]];return ie}var Hs={},Sr={},e0={},ro=48,Ro=57;function t0(ae){if(ae===void 0)return"_unknown";ae=ae.replace(/[^a-zA-Z0-9_]/g,"$");var ie=ae.charCodeAt(0);return ie>=ro&&ie<=Ro?"_"+ae:ae}function so(ae,ie){return ae=t0(ae),function(){return ie.apply(this,arguments)}}function xs(ae,ie){var pe=so(ie,function(Me){this.name=ie,this.message=Me;var tt=new Error(Me).stack;tt!==void 0&&(this.stack=this.toString()+`
`+tt.replace(/^Error(:[^\n]*)?\n/,""))});return pe.prototype=Object.create(ae.prototype),pe.prototype.constructor=pe,pe.prototype.toString=function(){return this.message===void 0?this.name:this.name+": "+this.message},pe}var on=void 0;function Rt(ae){throw new on(ae)}var ps=void 0;function Vi(ae){throw new ps(ae)}function Rs(ae,ie,pe){ae.forEach(function(je){e0[je]=ie});function Me(je){var Ft=pe(je);Ft.length!==ae.length&&Vi("Mismatched type converter count");for(var Ht=0;Ht<ae.length;++Ht)Ls(ae[Ht],Ft[Ht])}var tt=new Array(ie.length),st=[],lt=0;ie.forEach((je,Ft)=>{Sr.hasOwnProperty(je)?tt[Ft]=Sr[je]:(st.push(je),Hs.hasOwnProperty(je)||(Hs[je]=[]),Hs[je].push(()=>{tt[Ft]=Sr[je],++lt,lt===st.length&&Me(tt)}))}),st.length===0&&Me(tt)}function Ls(ae,ie,pe={}){if(!("argPackAdvance"in ie))throw new TypeError("registerType registeredInstance requires argPackAdvance");var Me=ie.name;if(ae||Rt('type "'+Me+'" must have a positive integer typeid pointer'),Sr.hasOwnProperty(ae)){if(pe.ignoreDuplicateRegistrations)return;Rt("Cannot register type '"+Me+"' twice")}if(Sr[ae]=ie,delete e0[ae],Hs.hasOwnProperty(ae)){var tt=Hs[ae];delete Hs[ae],tt.forEach(st=>st())}}function da(ae,ie,pe,Me,tt){var st=to(pe);ie=Kr(ie),Ls(ae,{name:ie,fromWireType:function(lt){return!!lt},toWireType:function(lt,je){return je?Me:tt},argPackAdvance:8,readValueFromPointer:function(lt){var je;if(pe===1)je=We;else if(pe===2)je=ke;else if(pe===4)je=pt;else throw new TypeError("Unknown boolean type size: "+ie);return this.fromWireType(je[lt>>st])},destructorFunction:null})}function Io(ae){if(!(this instanceof Ma)||!(ae instanceof Ma))return!1;for(var ie=this.$$.ptrType.registeredClass,pe=this.$$.ptr,Me=ae.$$.ptrType.registeredClass,tt=ae.$$.ptr;ie.baseClass;)pe=ie.upcast(pe),ie=ie.baseClass;for(;Me.baseClass;)tt=Me.upcast(tt),Me=Me.baseClass;return ie===Me&&pe===tt}function Nx(ae){return{count:ae.count,deleteScheduled:ae.deleteScheduled,preservePointerOnDelete:ae.preservePointerOnDelete,ptr:ae.ptr,ptrType:ae.ptrType,smartPtr:ae.smartPtr,smartPtrType:ae.smartPtrType}}function G0(ae){function ie(pe){return pe.$$.ptrType.registeredClass.name}Rt(ie(ae)+" instance already deleted")}var W0=!1;function Sl(ae){}function Ml(ae){ae.smartPtr?ae.smartPtrType.rawDestructor(ae.smartPtr):ae.ptrType.registeredClass.rawDestructor(ae.ptr)}function Pl(ae){ae.count.value-=1;var ie=ae.count.value===0;ie&&Ml(ae)}function Ol(ae,ie,pe){if(ie===pe)return ae;if(pe.baseClass===void 0)return null;var Me=Ol(ae,ie,pe.baseClass);return Me===null?null:pe.downcast(Me)}var i0={};function wl(){return Object.keys(no).length}function Ia(){var ae=[];for(var ie in no)no.hasOwnProperty(ie)&&ae.push(no[ie]);return ae}var So=[];function Mo(){for(;So.length;){var ae=So.pop();ae.$$.deleteScheduled=!1,ae.delete()}}var Sa=void 0;function bu(ae){Sa=ae,So.length&&Sa&&Sa(Mo)}function z0(){i.getInheritedInstanceCount=wl,i.getLiveInheritedInstances=Ia,i.flushPendingDeletes=Mo,i.setDelayFunction=bu}var no={};function vu(ae,ie){for(ie===void 0&&Rt("ptr should not be undefined");ae.baseClass;)ie=ae.upcast(ie),ae=ae.baseClass;return ie}function ao(ae,ie){return ie=vu(ae,ie),no[ie]}function Bx(ae,ie){(!ie.ptrType||!ie.ptr)&&Vi("makeClassHandle requires ptr and ptrType");var pe=!!ie.smartPtrType,Me=!!ie.smartPtr;return pe!==Me&&Vi("Both smartPtrType and smartPtr must be specified"),ie.count={value:1},X0(Object.create(ae,{$$:{value:ie}}))}function H0(ae){var ie=this.getPointee(ae);if(!ie)return this.destructor(ae),null;var pe=ao(this.registeredClass,ie);if(pe!==void 0){if(pe.$$.count.value===0)return pe.$$.ptr=ie,pe.$$.smartPtr=ae,pe.clone();var Me=pe.clone();return this.destructor(ae),Me}function tt(){return this.isSmartPointer?Bx(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:ie,smartPtrType:this,smartPtr:ae}):Bx(this.registeredClass.instancePrototype,{ptrType:this,ptr:ae})}var st=this.registeredClass.getActualType(ie),lt=i0[st];if(!lt)return tt.call(this);var je;this.isConst?je=lt.constPointerType:je=lt.pointerType;var Ft=Ol(ie,this.registeredClass,je.registeredClass);return Ft===null?tt.call(this):this.isSmartPointer?Bx(je.registeredClass.instancePrototype,{ptrType:je,ptr:Ft,smartPtrType:this,smartPtr:ae}):Bx(je.registeredClass.instancePrototype,{ptrType:je,ptr:Ft})}function X0(ae){return typeof FinalizationRegistry>"u"?(X0=ie=>ie,ae):(W0=new FinalizationRegistry(ie=>{Pl(ie.$$)}),X0=ie=>{var pe=ie.$$,Me=!!pe.smartPtr;if(Me){var tt={$$:pe};W0.register(ie,tt,ie)}return ie},Sl=ie=>W0.unregister(ie),X0(ae))}function Tu(){if(this.$$.ptr||G0(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var ae=X0(Object.create(Object.getPrototypeOf(this),{$$:{value:Nx(this.$$)}}));return ae.$$.count.value+=1,ae.$$.deleteScheduled=!1,ae}function Eu(){this.$$.ptr||G0(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&Rt("Object already scheduled for deletion"),Sl(this),Pl(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0)}function oo(){return!this.$$.ptr}function Xc(){return this.$$.ptr||G0(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&Rt("Object already scheduled for deletion"),So.push(this),So.length===1&&Sa&&Sa(Mo),this.$$.deleteScheduled=!0,this}function xo(){Ma.prototype.isAliasOf=Io,Ma.prototype.clone=Tu,Ma.prototype.delete=Eu,Ma.prototype.isDeleted=oo,Ma.prototype.deleteLater=Xc}function Ma(){}function Y0(ae,ie,pe){if(ae[ie].overloadTable===void 0){var Me=ae[ie];ae[ie]=function(){return ae[ie].overloadTable.hasOwnProperty(arguments.length)||Rt("Function '"+pe+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+ae[ie].overloadTable+")!"),ae[ie].overloadTable[arguments.length].apply(this,arguments)},ae[ie].overloadTable=[],ae[ie].overloadTable[Me.argCount]=Me}}function Au(ae,ie,pe){i.hasOwnProperty(ae)?((pe===void 0||i[ae].overloadTable!==void 0&&i[ae].overloadTable[pe]!==void 0)&&Rt("Cannot register public name '"+ae+"' twice"),Y0(i,ae,ae),i.hasOwnProperty(pe)&&Rt("Cannot register multiple overloads of a function with the same number of arguments ("+pe+")!"),i[ae].overloadTable[pe]=ie):(i[ae]=ie,pe!==void 0&&(i[ae].numArguments=pe))}function kx(ae,ie,pe,Me,tt,st,lt,je){this.name=ae,this.constructor=ie,this.instancePrototype=pe,this.rawDestructor=Me,this.baseClass=tt,this.getActualType=st,this.upcast=lt,this.downcast=je,this.pureVirtualFunctions=[]}function Ux(ae,ie,pe){for(;ie!==pe;)ie.upcast||Rt("Expected null or instance of "+pe.name+", got an instance of "+ie.name),ae=ie.upcast(ae),ie=ie.baseClass;return ae}function Cu(ae,ie){if(ie===null)return this.isReference&&Rt("null is not a valid "+this.name),0;ie.$$||Rt('Cannot pass "'+Bl(ie)+'" as a '+this.name),ie.$$.ptr||Rt("Cannot pass deleted object as a pointer of type "+this.name);var pe=ie.$$.ptrType.registeredClass,Me=Ux(ie.$$.ptr,pe,this.registeredClass);return Me}function Ru(ae,ie){var pe;if(ie===null)return this.isReference&&Rt("null is not a valid "+this.name),this.isSmartPointer?(pe=this.rawConstructor(),ae!==null&&ae.push(this.rawDestructor,pe),pe):0;ie.$$||Rt('Cannot pass "'+Bl(ie)+'" as a '+this.name),ie.$$.ptr||Rt("Cannot pass deleted object as a pointer of type "+this.name),!this.isConst&&ie.$$.ptrType.isConst&&Rt("Cannot convert argument of type "+(ie.$$.smartPtrType?ie.$$.smartPtrType.name:ie.$$.ptrType.name)+" to parameter type "+this.name);var Me=ie.$$.ptrType.registeredClass;if(pe=Ux(ie.$$.ptr,Me,this.registeredClass),this.isSmartPointer)switch(ie.$$.smartPtr===void 0&&Rt("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:ie.$$.smartPtrType===this?pe=ie.$$.smartPtr:Rt("Cannot convert argument of type "+(ie.$$.smartPtrType?ie.$$.smartPtrType.name:ie.$$.ptrType.name)+" to parameter type "+this.name);break;case 1:pe=ie.$$.smartPtr;break;case 2:if(ie.$$.smartPtrType===this)pe=ie.$$.smartPtr;else{var tt=ie.clone();pe=this.rawShare(pe,pn.toHandle(function(){tt.delete()})),ae!==null&&ae.push(this.rawDestructor,pe)}break;default:Rt("Unsupporting sharing policy")}return pe}function Iu(ae,ie){if(ie===null)return this.isReference&&Rt("null is not a valid "+this.name),0;ie.$$||Rt('Cannot pass "'+Bl(ie)+'" as a '+this.name),ie.$$.ptr||Rt("Cannot pass deleted object as a pointer of type "+this.name),ie.$$.ptrType.isConst&&Rt("Cannot convert argument of type "+ie.$$.ptrType.name+" to parameter type "+this.name);var pe=ie.$$.ptrType.registeredClass,Me=Ux(ie.$$.ptr,pe,this.registeredClass);return Me}function Vx(ae){return this.fromWireType(Xe[ae>>2])}function Pa(ae){return this.rawGetPointee&&(ae=this.rawGetPointee(ae)),ae}function Su(ae){this.rawDestructor&&this.rawDestructor(ae)}function Oa(ae){ae!==null&&ae.delete()}function Mu(){wa.prototype.getPointee=Pa,wa.prototype.destructor=Su,wa.prototype.argPackAdvance=8,wa.prototype.readValueFromPointer=Vx,wa.prototype.deleteObject=Oa,wa.prototype.fromWireType=H0}function wa(ae,ie,pe,Me,tt,st,lt,je,Ft,Ht,Qt){this.name=ae,this.registeredClass=ie,this.isReference=pe,this.isConst=Me,this.isSmartPointer=tt,this.pointeeType=st,this.sharingPolicy=lt,this.rawGetPointee=je,this.rawConstructor=Ft,this.rawShare=Ht,this.rawDestructor=Qt,!tt&&ie.baseClass===void 0?Me?(this.toWireType=Cu,this.destructorFunction=null):(this.toWireType=Iu,this.destructorFunction=null):this.toWireType=Ru}function Dn(ae,ie,pe){i.hasOwnProperty(ae)||Vi("Replacing nonexistant public symbol"),i[ae].overloadTable!==void 0&&pe!==void 0?i[ae].overloadTable[pe]=ie:(i[ae]=ie,i[ae].argCount=pe)}function Yc(ae,ie,pe){var Me=i["dynCall_"+ae];return pe&&pe.length?Me.apply(null,[ie].concat(pe)):Me.call(null,ie)}function Is(ae,ie,pe){return ae.includes("j")?Yc(ae,ie,pe):Wr(ie).apply(null,pe)}function r0(ae,ie){var pe=[];return function(){return pe.length=0,Object.assign(pe,arguments),Is(ae,ie,pe)}}function Da(ae,ie){ae=Kr(ae);function pe(){return ae.includes("j")?r0(ae,ie):Wr(ie)}var Me=pe();return typeof Me!="function"&&Rt("unknown function pointer with signature "+ae+": "+ie),Me}var Po=void 0;function Kc(ae){var ie=EM(ae),pe=Kr(ie);return o0(ie),pe}function Oo(ae,ie){var pe=[],Me={};function tt(st){if(!Me[st]&&!Sr[st]){if(e0[st]){e0[st].forEach(tt);return}pe.push(st),Me[st]=!0}}throw ie.forEach(tt),new Po(ae+": "+pe.map(Kc).join([", "]))}function Pu(ae,ie,pe,Me,tt,st,lt,je,Ft,Ht,Qt,gi,Ci){Qt=Kr(Qt),st=Da(tt,st),je&&(je=Da(lt,je)),Ht&&(Ht=Da(Ft,Ht)),Ci=Da(gi,Ci);var pr=t0(Qt);Au(pr,function(){Oo("Cannot construct "+Qt+" due to unbound types",[Me])}),Rs([ae,ie,pe],Me?[Me]:[],function(jr){jr=jr[0];var gr,cs;Me?(gr=jr.registeredClass,cs=gr.instancePrototype):cs=Ma.prototype;var Ss=so(pr,function(){if(Object.getPrototypeOf(this)!==yt)throw new on("Use 'new' to construct "+Qt);if(ei.constructor_body===void 0)throw new on(Qt+" has no accessible constructor");var Ti=ei.constructor_body[arguments.length];if(Ti===void 0)throw new on("Tried to invoke ctor of "+Qt+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(ei.constructor_body).toString()+") parameters instead!");return Ti.apply(this,arguments)}),yt=Object.create(cs,{constructor:{value:Ss}});Ss.prototype=yt;var ei=new kx(Qt,Ss,yt,Ci,gr,st,je,Ht),Ms=new wa(Qt,ei,!0,!1,!1),_s=new wa(Qt+"*",ei,!1,!1,!1),wo=new wa(Qt+" const*",ei,!1,!0,!1);return i0[ae]={pointerType:_s,constPointerType:wo},Dn(pr,Ss),[Ms,_s,wo]})}function Gx(ae,ie){for(var pe=[],Me=0;Me<ae;Me++)pe.push(pt[(ie>>2)+Me]);return pe}function Dl(ae){for(;ae.length;){var ie=ae.pop(),pe=ae.pop();pe(ie)}}function Wx(ae,ie,pe,Me,tt,st){G(ie>0);var lt=Gx(ie,pe);tt=Da(Me,tt),Rs([],[ae],function(je){je=je[0];var Ft="constructor "+je.name;if(je.registeredClass.constructor_body===void 0&&(je.registeredClass.constructor_body=[]),je.registeredClass.constructor_body[ie-1]!==void 0)throw new on("Cannot register multiple constructors with identical number of parameters ("+(ie-1)+") for class '"+je.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return je.registeredClass.constructor_body[ie-1]=()=>{Oo("Cannot construct "+je.name+" due to unbound types",lt)},Rs([],lt,function(Ht){return Ht.splice(1,0,null),je.registeredClass.constructor_body[ie-1]=Fn(Ft,Ht,null,tt,st),[]}),[]})}function Fn(ae,ie,pe,Me,tt){var st=ie.length;st<2&&Rt("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var lt=ie[1]!==null&&pe!==null,je=!1,Ft=1;Ft<ie.length;++Ft)if(ie[Ft]!==null&&ie[Ft].destructorFunction===void 0){je=!0;break}var Ht=ie[0].name!=="void",Qt=st-2,gi=new Array(Qt),Ci=[],pr=[];return function(){arguments.length!==Qt&&Rt("function "+ae+" called with "+arguments.length+" arguments, expected "+Qt+" args!"),pr.length=0;var jr;Ci.length=lt?2:1,Ci[0]=tt,lt&&(jr=ie[1].toWireType(pr,this),Ci[1]=jr);for(var gr=0;gr<Qt;++gr)gi[gr]=ie[gr+2].toWireType(pr,arguments[gr]),Ci.push(gi[gr]);var cs=Me.apply(null,Ci);function Ss(yt){if(je)Dl(pr);else for(var ei=lt?1:2;ei<ie.length;ei++){var Ms=ei===1?jr:gi[ei-2];ie[ei].destructorFunction!==null&&ie[ei].destructorFunction(Ms)}if(Ht)return ie[0].fromWireType(yt)}return Ss(cs)}}function zx(ae,ie,pe,Me,tt,st,lt,je){var Ft=Gx(pe,Me);ie=Kr(ie),st=Da(tt,st),Rs([],[ae],function(Ht){Ht=Ht[0];var Qt=Ht.name+"."+ie;ie.startsWith("@@")&&(ie=Symbol[ie.substring(2)]),je&&Ht.registeredClass.pureVirtualFunctions.push(ie);function gi(){Oo("Cannot call "+Qt+" due to unbound types",Ft)}var Ci=Ht.registeredClass.instancePrototype,pr=Ci[ie];return pr===void 0||pr.overloadTable===void 0&&pr.className!==Ht.name&&pr.argCount===pe-2?(gi.argCount=pe-2,gi.className=Ht.name,Ci[ie]=gi):(Y0(Ci,ie,Qt),Ci[ie].overloadTable[pe-2]=gi),Rs([],Ft,function(jr){var gr=Fn(Qt,jr,Ht,st,lt);return Ci[ie].overloadTable===void 0?(gr.argCount=pe-2,Ci[ie]=gr):Ci[ie].overloadTable[pe-2]=gr,[]}),[]})}function Ln(ae,ie,pe){return ae instanceof Object||Rt(pe+' with invalid "this": '+ae),ae instanceof ie.registeredClass.constructor||Rt(pe+' incompatible with "this" of type '+ae.constructor.name),ae.$$.ptr||Rt("cannot call emscripten binding method "+pe+" on deleted object"),Ux(ae.$$.ptr,ae.$$.ptrType.registeredClass,ie.registeredClass)}function jc(ae,ie,pe,Me,tt,st,lt,je,Ft,Ht){ie=Kr(ie),tt=Da(Me,tt),Rs([],[ae],function(Qt){Qt=Qt[0];var gi=Qt.name+"."+ie,Ci={get:function(){Oo("Cannot access "+gi+" due to unbound types",[pe,lt])},enumerable:!0,configurable:!0};return Ft?Ci.set=()=>{Oo("Cannot access "+gi+" due to unbound types",[pe,lt])}:Ci.set=pr=>{Rt(gi+" is a read-only property")},Object.defineProperty(Qt.registeredClass.instancePrototype,ie,Ci),Rs([],Ft?[pe,lt]:[pe],function(pr){var jr=pr[0],gr={get:function(){var Ss=Ln(this,Qt,gi+" getter");return jr.fromWireType(tt(st,Ss))},enumerable:!0};if(Ft){Ft=Da(je,Ft);var cs=pr[1];gr.set=function(Ss){var yt=Ln(this,Qt,gi+" setter"),ei=[];Ft(Ht,yt,cs.toWireType(ei,Ss)),Dl(ei)}}return Object.defineProperty(Qt.registeredClass.instancePrototype,ie,gr),[]}),[]})}var Fl=[],xn=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function Ll(ae){ae>4&&--xn[ae].refcount===0&&(xn[ae]=void 0,Fl.push(ae))}function s0(){for(var ae=0,ie=5;ie<xn.length;++ie)xn[ie]!==void 0&&++ae;return ae}function Ou(){for(var ae=5;ae<xn.length;++ae)if(xn[ae]!==void 0)return xn[ae];return null}function Nl(){i.count_emval_handles=s0,i.get_first_emval=Ou}var pn={toValue:ae=>(ae||Rt("Cannot use deleted val. handle = "+ae),xn[ae].value),toHandle:ae=>{switch(ae){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:{var ie=Fl.length?Fl.pop():xn.length;return xn[ie]={refcount:1,value:ae},ie}}}};function wu(ae,ie){ie=Kr(ie),Ls(ae,{name:ie,fromWireType:function(pe){var Me=pn.toValue(pe);return Ll(pe),Me},toWireType:function(pe,Me){return pn.toHandle(Me)},argPackAdvance:8,readValueFromPointer:Vx,destructorFunction:null})}function Bl(ae){if(ae===null)return"null";var ie=typeof ae;return ie==="object"||ie==="array"||ie==="function"?ae.toString():""+ae}function Du(ae,ie){switch(ie){case 2:return function(pe){return this.fromWireType(Tt[pe>>2])};case 3:return function(pe){return this.fromWireType(fi[pe>>3])};default:throw new TypeError("Unknown float type: "+ae)}}function Fu(ae,ie,pe){var Me=to(pe);ie=Kr(ie),Ls(ae,{name:ie,fromWireType:function(tt){return tt},toWireType:function(tt,st){return st},argPackAdvance:8,readValueFromPointer:Du(ie,Me),destructorFunction:null})}function Lu(ae,ie,pe){switch(ie){case 0:return pe?function(Me){return We[Me]}:function(Me){return et[Me]};case 1:return pe?function(Me){return ke[Me>>1]}:function(Me){return $e[Me>>1]};case 2:return pe?function(Me){return pt[Me>>2]}:function(Me){return Xe[Me>>2]};default:throw new TypeError("Unknown integer type: "+ae)}}function Nu(ae,ie,pe,Me,tt){ie=Kr(ie);var st=to(pe),lt=gi=>gi;if(Me===0){var je=32-8*pe;lt=gi=>gi<<je>>>je}var Ft=ie.includes("unsigned"),Ht=(gi,Ci)=>{},Qt;Ft?Qt=function(gi,Ci){return Ht(Ci,this.name),Ci>>>0}:Qt=function(gi,Ci){return Ht(Ci,this.name),Ci},Ls(ae,{name:ie,fromWireType:lt,toWireType:Qt,argPackAdvance:8,readValueFromPointer:Lu(ie,st,Me!==0),destructorFunction:null})}function Bu(ae,ie,pe){var Me=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],tt=Me[ie];function st(lt){lt=lt>>2;var je=Xe,Ft=je[lt],Ht=je[lt+1];return new tt(Ee,Ht,Ft)}pe=Kr(pe),Ls(ae,{name:pe,fromWireType:st,argPackAdvance:8,readValueFromPointer:st},{ignoreDuplicateRegistrations:!0})}function ku(ae,ie){ie=Kr(ie);var pe=ie==="std::string";Ls(ae,{name:ie,fromWireType:function(Me){var tt=Xe[Me>>2],st;if(pe)for(var lt=Me+4,je=0;je<=tt;++je){var Ft=Me+4+je;if(je==tt||et[Ft]==0){var Ht=Ft-lt,Qt=W(lt,Ht);st===void 0?st=Qt:(st+=String.fromCharCode(0),st+=Qt),lt=Ft+1}}else{for(var gi=new Array(tt),je=0;je<tt;++je)gi[je]=String.fromCharCode(et[Me+4+je]);st=gi.join("")}return o0(Me),st},toWireType:function(Me,tt){tt instanceof ArrayBuffer&&(tt=new Uint8Array(tt));var st,lt=typeof tt=="string";lt||tt instanceof Uint8Array||tt instanceof Uint8ClampedArray||tt instanceof Int8Array||Rt("Cannot pass non-string to std::string"),pe&&lt?st=()=>Q(tt):st=()=>tt.length;var je=st(),Ft=a0(4+je+1);if(Xe[Ft>>2]=je,pe&&lt)Z(tt,Ft+4,je+1);else if(lt)for(var Ht=0;Ht<je;++Ht){var Qt=tt.charCodeAt(Ht);Qt>255&&(o0(Ft),Rt("String has UTF-16 code units that do not fit in 8 bits")),et[Ft+4+Ht]=Qt}else for(var Ht=0;Ht<je;++Ht)et[Ft+4+Ht]=tt[Ht];return Me!==null&&Me.push(o0,Ft),Ft},argPackAdvance:8,readValueFromPointer:Vx,destructorFunction:function(Me){o0(Me)}})}function Uu(ae,ie,pe){pe=Kr(pe);var Me,tt,st,lt,je;ie===2?(Me=$,tt=oe,lt=ue,st=()=>$e,je=1):ie===4&&(Me=de,tt=ye,lt=_e,st=()=>Xe,je=2),Ls(ae,{name:pe,fromWireType:function(Ft){for(var Ht=Xe[Ft>>2],Qt=st(),gi,Ci=Ft+4,pr=0;pr<=Ht;++pr){var jr=Ft+4+pr*ie;if(pr==Ht||Qt[jr>>je]==0){var gr=jr-Ci,cs=Me(Ci,gr);gi===void 0?gi=cs:(gi+=String.fromCharCode(0),gi+=cs),Ci=jr+ie}}return o0(Ft),gi},toWireType:function(Ft,Ht){typeof Ht!="string"&&Rt("Cannot pass non-string to C++ string type "+pe);var Qt=lt(Ht),gi=a0(4+Qt+ie);return Xe[gi>>2]=Qt>>je,tt(Ht,gi+4,Qt+ie),Ft!==null&&Ft.push(o0,gi),gi},argPackAdvance:8,readValueFromPointer:Vx,destructorFunction:function(Ft){o0(Ft)}})}function Vu(ae,ie){ie=Kr(ie),Ls(ae,{isVoid:!0,name:ie,argPackAdvance:0,fromWireType:function(){},toWireType:function(pe,Me){}})}function Gu(ae){delete ce.xhrs[ae-1]}function qc(ae,ie){var pe=Sr[ae];return pe===void 0&&Rt(ie+" has unknown type "+Kc(ae)),pe}function Wu(ae,ie,pe){ae=pn.toValue(ae),ie=qc(ie,"emval::as");var Me=[],tt=pn.toHandle(Me);return pt[pe>>2]=tt,ie.toWireType(Me,ae)}var zu={};function Zc(ae){var ie=zu[ae];return ie===void 0?Kr(ae):ie}function Qc(){if(typeof globalThis=="object")return globalThis;function ae(ie){ie.$$$embind_global$$$=ie;var pe=typeof $$$embind_global$$$=="object"&&ie.$$$embind_global$$$==ie;return pe||delete ie.$$$embind_global$$$,pe}if(typeof $$$embind_global$$$=="object"||(typeof fa.g=="object"&&ae(fa.g)?$$$embind_global$$$=fa.g:typeof self=="object"&&ae(self)&&($$$embind_global$$$=self),typeof $$$embind_global$$$=="object"))return $$$embind_global$$$;throw Error("unable to get global object.")}function Fa(ae){return ae===0?pn.toHandle(Qc()):(ae=Zc(ae),pn.toHandle(Qc()[ae]))}function Hx(ae,ie){return ae=pn.toValue(ae),ie=pn.toValue(ie),pn.toHandle(ae[ie])}function $c(ae){ae>4&&(xn[ae].refcount+=1)}function Jc(ae){return pn.toHandle(Zc(ae))}function Nn(ae){var ie=pn.toValue(ae);Dl(ie),Ll(ae)}function n0(ae,ie){ae=qc(ae,"_emval_take_value");var pe=ae.readValueFromPointer(ie);return pn.toHandle(pe)}function he(){un("")}function le(){return!y}function ve(ae,ie,pe){et.copyWithin(ae,ie,ie+pe)}function Ge(){return 2147483648}function ne(ae){try{return L.grow(ae-Ee.byteLength+65535>>>16),li(L.buffer),1}catch{}}function re(ae){var ie=et.length;ae=ae>>>0;var pe=Ge();if(ae>pe)return!1;let Me=(Ft,Ht)=>Ft+(Ht-Ft%Ht)%Ht;for(var tt=1;tt<=4;tt*=2){var st=ie*(1+.2/tt);st=Math.min(st,ae+100663296);var lt=Math.min(pe,Me(Math.max(ae,st),65536)),je=ne(lt);if(je)return!0}return!1}var ce={xhrs:[],setu64:function(ae,ie){Xe[ae>>2]=ie,Xe[ae+4>>2]=ie/4294967296|0},openDatabase:function(ae,ie,pe,Me){try{var tt=indexedDB.open(ae,ie)}catch(st){return Me(st)}tt.onupgradeneeded=st=>{var lt=st.target.result;lt.objectStoreNames.contains("FILES")&&lt.deleteObjectStore("FILES"),lt.createObjectStore("FILES")},tt.onsuccess=st=>pe(st.target.result),tt.onerror=st=>Me(st)},staticInit:function(){var ae=pe=>{ce.dbInstance=pe,an()},ie=()=>{ce.dbInstance=!1,an()};ce.openDatabase("emscripten_filesystem",1,ae,ie),(typeof ENVIRONMENT_IS_FETCH_WORKER>"u"||!ENVIRONMENT_IS_FETCH_WORKER)&&Cr()}};function me(ae,ie,pe,Me,tt){var st=Xe[ae+8>>2];if(!st){pe(ae,0,"no url specified!");return}var lt=W(st),je=ae+112,Ft=W(je);Ft||(Ft="GET"),Xe[ae+4>>2];var Ht=Xe[je+52>>2],Qt=Xe[je+56>>2],gi=!!Xe[je+60>>2];Xe[je+64>>2];var Ci=Xe[je+68>>2],pr=Xe[je+72>>2],jr=Xe[je+76>>2],gr=Xe[je+80>>2],cs=Xe[je+84>>2],Ss=Xe[je+88>>2],yt=!!(Ht&1),ei=!!(Ht&2),Ms=!!(Ht&64),_s=Ci?W(Ci):void 0,wo=pr?W(pr):void 0,Ti=new XMLHttpRequest;if(Ti.withCredentials=gi,Ti.open(Ft,lt,!Ms,_s,wo),Ms||(Ti.timeout=Qt),Ti.url_=lt,Ti.responseType="arraybuffer",gr){var Xs=W(gr);Ti.overrideMimeType(Xs)}if(jr)for(;;){var x0=Xe[jr>>2];if(!x0)break;var K0=Xe[jr+4>>2];if(!K0)break;jr+=8;var Gg=W(x0),Wg=W(K0);Ti.setRequestHeader(Gg,Wg)}ce.xhrs.push(Ti);var kl=ce.xhrs.length;Xe[ae+0>>2]=kl;var zg=cs&&Ss?et.slice(cs,cs+Ss):null;function nf(_n){var lo=0,j0=0;_n&&(j0=Ti.response?Ti.response.byteLength:0,lo=a0(j0),et.set(new Uint8Array(Ti.response),lo)),Xe[ae+12>>2]=lo,ce.setu64(ae+16,j0)}Ti.onload=_n=>{nf(yt&&!ei);var lo=Ti.response?Ti.response.byteLength:0;ce.setu64(ae+24,0),lo&&ce.setu64(ae+32,lo),$e[ae+40>>1]=Ti.readyState,$e[ae+42>>1]=Ti.status,Ti.statusText&&Z(Ti.statusText,ae+44,64),Ti.status>=200&&Ti.status<300?ie&&ie(ae,Ti,_n):pe&&pe(ae,Ti,_n)},Ti.onerror=_n=>{nf(yt);var lo=Ti.status;ce.setu64(ae+24,0),ce.setu64(ae+32,Ti.response?Ti.response.byteLength:0),$e[ae+40>>1]=Ti.readyState,$e[ae+42>>1]=lo,pe&&pe(ae,Ti,_n)},Ti.ontimeout=_n=>{pe&&pe(ae,Ti,_n)},Ti.onprogress=_n=>{var lo=yt&&ei&&Ti.response?Ti.response.byteLength:0,j0=0;yt&&ei&&(j0=a0(lo),et.set(new Uint8Array(Ti.response),j0)),Xe[ae+12>>2]=j0,ce.setu64(ae+16,lo),ce.setu64(ae+24,_n.loaded-lo),ce.setu64(ae+32,_n.total),$e[ae+40>>1]=Ti.readyState,Ti.readyState>=3&&Ti.status===0&&_n.loaded>0&&(Ti.status=200),$e[ae+42>>1]=Ti.status,Ti.statusText&&Z(Ti.statusText,ae+44,64),Me&&Me(ae,Ti,_n),j0&&o0(j0)},Ti.onreadystatechange=_n=>{$e[ae+40>>1]=Ti.readyState,Ti.readyState>=2&&($e[ae+42>>1]=Ti.status),tt&&tt(ae,Ti,_n)};try{Ti.send(zg)}catch(_n){pe&&pe(ae,Ti,_n)}}function Se(ae,ie){if(!N){if(ie){ae();return}try{ae()}catch(pe){fn(pe)}}}function Fe(ae,ie,pe,Me,tt){if(!ae){tt(ie,0,"IndexedDB not available!");return}var st=ie+112,lt=Xe[st+64>>2];lt||(lt=Xe[ie+8>>2]);var je=W(lt);try{var Ft=ae.transaction(["FILES"],"readwrite"),Ht=Ft.objectStore("FILES"),Qt=Ht.put(pe,je);Qt.onsuccess=gi=>{$e[ie+40>>1]=4,$e[ie+42>>1]=200,Z("OK",ie+44,64),Me(ie,0,je)},Qt.onerror=gi=>{$e[ie+40>>1]=4,$e[ie+42>>1]=413,Z("Payload Too Large",ie+44,64),tt(ie,0,gi)}}catch(gi){tt(ie,0,gi)}}function Ne(ae,ie,pe,Me){if(!ae){Me(ie,0,"IndexedDB not available!");return}var tt=ie+112,st=Xe[tt+64>>2];st||(st=Xe[ie+8>>2]);var lt=W(st);try{var je=ae.transaction(["FILES"],"readonly"),Ft=je.objectStore("FILES"),Ht=Ft.get(lt);Ht.onsuccess=Qt=>{if(Qt.target.result){var gi=Qt.target.result,Ci=gi.byteLength||gi.length,pr=a0(Ci);et.set(new Uint8Array(gi),pr),Xe[ie+12>>2]=pr,ce.setu64(ie+16,Ci),ce.setu64(ie+24,0),ce.setu64(ie+32,Ci),$e[ie+40>>1]=4,$e[ie+42>>1]=200,Z("OK",ie+44,64),pe(ie,0,gi)}else $e[ie+40>>1]=4,$e[ie+42>>1]=404,Z("Not Found",ie+44,64),Me(ie,0,"no data")},Ht.onerror=Qt=>{$e[ie+40>>1]=4,$e[ie+42>>1]=404,Z("Not Found",ie+44,64),Me(ie,0,Qt)}}catch(Qt){Me(ie,0,Qt)}}function De(ae,ie,pe,Me){if(!ae){Me(ie,0,"IndexedDB not available!");return}var tt=ie+112,st=Xe[tt+64>>2];st||(st=Xe[ie+8>>2]);var lt=W(st);try{var je=ae.transaction(["FILES"],"readwrite"),Ft=je.objectStore("FILES"),Ht=Ft.delete(lt);Ht.onsuccess=Qt=>{var gi=Qt.target.result;Xe[ie+12>>2]=0,ce.setu64(ie+16,0),ce.setu64(ie+24,0),ce.setu64(ie+32,0),$e[ie+40>>1]=4,$e[ie+42>>1]=200,Z("OK",ie+44,64),pe(ie,0,gi)},Ht.onerror=Qt=>{$e[ie+40>>1]=4,$e[ie+42>>1]=404,Z("Not Found",ie+44,64),Me(ie,0,Qt)}}catch(Qt){Me(ie,0,Qt)}}function it(ae,ie,pe,Me,tt){var st=ae+112,lt=W(st),je=Xe[st+36>>2],Ft=Xe[st+40>>2],Ht=Xe[st+44>>2],Qt=Xe[st+48>>2],gi=Xe[st+52>>2],Ci=!!(gi&4),pr=!!(gi&32),jr=!!(gi&16),gr=!!(gi&64),cs=(Xs,x0,K0)=>{Se(()=>{je?Wr(je)(Xs):ie&&ie(Xs)},gr)},Ss=(Xs,x0,K0)=>{Se(()=>{Ht?Wr(Ht)(Xs):Me&&Me(Xs)},gr)},yt=(Xs,x0,K0)=>{Se(()=>{Ft?Wr(Ft)(Xs):pe&&pe(Xs)},gr)},ei=(Xs,x0,K0)=>{Se(()=>{Qt?Wr(Qt)(Xs):tt&&tt(Xs)},gr)},Ms=(Xs,x0,K0)=>{me(Xs,cs,yt,Ss,ei)},_s=(Xs,x0,K0)=>{var Gg=(kl,zg,nf)=>{Se(()=>{je?Wr(je)(kl):ie&&ie(kl)},gr)},Wg=(kl,zg,nf)=>{Se(()=>{je?Wr(je)(kl):ie&&ie(kl)},gr)};Fe(ce.dbInstance,Xs,x0.response,Gg,Wg)},wo=(Xs,x0,K0)=>{me(Xs,_s,yt,Ss,ei)};if(lt==="EM_IDB_STORE"){var Ti=Xe[st+84>>2];Fe(ce.dbInstance,ae,et.slice(Ti,Ti+Xe[st+88>>2]),cs,yt)}else if(lt==="EM_IDB_DELETE")De(ce.dbInstance,ae,cs,yt);else if(!jr)Ne(ce.dbInstance,ae,cs,pr?yt:Ci?wo:Ms);else if(!pr)me(ae,Ci?_s:cs,yt,Ss,ei);else return 0;return ae}var mt={};function Dt(){return p||"./this.program"}function Wt(){if(!Wt.strings){var ae=(typeof navigator=="object"&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",ie={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:ae,_:Dt()};for(var pe in mt)mt[pe]===void 0?delete ie[pe]:ie[pe]=mt[pe];var Me=[];for(var pe in ie)Me.push(pe+"="+ie[pe]);Wt.strings=Me}return Wt.strings}function Di(ae,ie){var pe=0;return Wt().forEach(function(Me,tt){var st=ie+pe;Xe[ae+tt*4>>2]=st,Pe(Me,st),pe+=Me.length+1}),0}function Hi(ae,ie){var pe=Wt();Xe[ae>>2]=pe.length;var Me=0;return pe.forEach(function(tt){Me+=tt.length+1}),Xe[ie>>2]=Me,0}function fr(ae){return ae%4===0&&(ae%100!==0||ae%400===0)}function Gi(ae,ie){for(var pe=0,Me=0;Me<=ie;pe+=ae[Me++]);return pe}var ls=[31,29,31,30,31,30,31,31,30,31,30,31],ms=[31,28,31,30,31,30,31,31,30,31,30,31];function mn(ae,ie){for(var pe=new Date(ae.getTime());ie>0;){var Me=fr(pe.getFullYear()),tt=pe.getMonth(),st=(Me?ls:ms)[tt];if(ie>st-pe.getDate())ie-=st-pe.getDate()+1,pe.setDate(1),tt<11?pe.setMonth(tt+1):(pe.setMonth(0),pe.setFullYear(pe.getFullYear()+1));else return pe.setDate(pe.getDate()+ie),pe}return pe}function ts(ae,ie,pe,Me){var tt=pt[Me+40>>2],st={tm_sec:pt[Me>>2],tm_min:pt[Me+4>>2],tm_hour:pt[Me+8>>2],tm_mday:pt[Me+12>>2],tm_mon:pt[Me+16>>2],tm_year:pt[Me+20>>2],tm_wday:pt[Me+24>>2],tm_yday:pt[Me+28>>2],tm_isdst:pt[Me+32>>2],tm_gmtoff:pt[Me+36>>2],tm_zone:tt?W(tt):""},lt=W(pe),je={"%c":"%a %b %d %H:%M:%S %Y","%D":"%m/%d/%y","%F":"%Y-%m-%d","%h":"%b","%r":"%I:%M:%S %p","%R":"%H:%M","%T":"%H:%M:%S","%x":"%m/%d/%y","%X":"%H:%M:%S","%Ec":"%c","%EC":"%C","%Ex":"%m/%d/%y","%EX":"%H:%M:%S","%Ey":"%y","%EY":"%Y","%Od":"%d","%Oe":"%e","%OH":"%H","%OI":"%I","%Om":"%m","%OM":"%M","%OS":"%S","%Ou":"%u","%OU":"%U","%OV":"%V","%Ow":"%w","%OW":"%W","%Oy":"%y"};for(var Ft in je)lt=lt.replace(new RegExp(Ft,"g"),je[Ft]);var Ht=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],Qt=["January","February","March","April","May","June","July","August","September","October","November","December"];function gi(yt,ei,Ms){for(var _s=typeof yt=="number"?yt.toString():yt||"";_s.length<ei;)_s=Ms[0]+_s;return _s}function Ci(yt,ei){return gi(yt,ei,"0")}function pr(yt,ei){function Ms(wo){return wo<0?-1:wo>0?1:0}var _s;return(_s=Ms(yt.getFullYear()-ei.getFullYear()))===0&&(_s=Ms(yt.getMonth()-ei.getMonth()))===0&&(_s=Ms(yt.getDate()-ei.getDate())),_s}function jr(yt){switch(yt.getDay()){case 0:return new Date(yt.getFullYear()-1,11,29);case 1:return yt;case 2:return new Date(yt.getFullYear(),0,3);case 3:return new Date(yt.getFullYear(),0,2);case 4:return new Date(yt.getFullYear(),0,1);case 5:return new Date(yt.getFullYear()-1,11,31);case 6:return new Date(yt.getFullYear()-1,11,30)}}function gr(yt){var ei=mn(new Date(yt.tm_year+1900,0,1),yt.tm_yday),Ms=new Date(ei.getFullYear(),0,4),_s=new Date(ei.getFullYear()+1,0,4),wo=jr(Ms),Ti=jr(_s);return pr(wo,ei)<=0?pr(Ti,ei)<=0?ei.getFullYear()+1:ei.getFullYear():ei.getFullYear()-1}var cs={"%a":function(yt){return Ht[yt.tm_wday].substring(0,3)},"%A":function(yt){return Ht[yt.tm_wday]},"%b":function(yt){return Qt[yt.tm_mon].substring(0,3)},"%B":function(yt){return Qt[yt.tm_mon]},"%C":function(yt){var ei=yt.tm_year+1900;return Ci(ei/100|0,2)},"%d":function(yt){return Ci(yt.tm_mday,2)},"%e":function(yt){return gi(yt.tm_mday,2," ")},"%g":function(yt){return gr(yt).toString().substring(2)},"%G":function(yt){return gr(yt)},"%H":function(yt){return Ci(yt.tm_hour,2)},"%I":function(yt){var ei=yt.tm_hour;return ei==0?ei=12:ei>12&&(ei-=12),Ci(ei,2)},"%j":function(yt){return Ci(yt.tm_mday+Gi(fr(yt.tm_year+1900)?ls:ms,yt.tm_mon-1),3)},"%m":function(yt){return Ci(yt.tm_mon+1,2)},"%M":function(yt){return Ci(yt.tm_min,2)},"%n":function(){return`
`},"%p":function(yt){return yt.tm_hour>=0&&yt.tm_hour<12?"AM":"PM"},"%S":function(yt){return Ci(yt.tm_sec,2)},"%t":function(){return"	"},"%u":function(yt){return yt.tm_wday||7},"%U":function(yt){var ei=yt.tm_yday+7-yt.tm_wday;return Ci(Math.floor(ei/7),2)},"%V":function(yt){var ei=Math.floor((yt.tm_yday+7-(yt.tm_wday+6)%7)/7);if((yt.tm_wday+371-yt.tm_yday-2)%7<=2&&ei++,ei){if(ei==53){var Ms=(yt.tm_wday+371-yt.tm_yday)%7;Ms!=4&&(Ms!=3||!fr(yt.tm_year))&&(ei=1)}}else{ei=52;var _s=(yt.tm_wday+7-yt.tm_yday-1)%7;(_s==4||_s==5&&fr(yt.tm_year%400-1))&&ei++}return Ci(ei,2)},"%w":function(yt){return yt.tm_wday},"%W":function(yt){var ei=yt.tm_yday+7-(yt.tm_wday+6)%7;return Ci(Math.floor(ei/7),2)},"%y":function(yt){return(yt.tm_year+1900).toString().substring(2)},"%Y":function(yt){return yt.tm_year+1900},"%z":function(yt){var ei=yt.tm_gmtoff,Ms=ei>=0;return ei=Math.abs(ei)/60,ei=ei/60*100+ei%60,(Ms?"+":"-")+("0000"+ei).slice(-4)},"%Z":function(yt){return yt.tm_zone},"%%":function(){return"%"}};lt=lt.replace(/%%/g,"\0\0");for(var Ft in cs)lt.includes(Ft)&&(lt=lt.replace(new RegExp(Ft,"g"),cs[Ft](st)));lt=lt.replace(/\0\0/g,"%");var Ss=tf(lt,!1);return Ss.length>ie?0:(we(Ss,ae),Ss.length-1)}function Hu(ae,ie,pe,Me){return ts(ae,ie,pe,Me)}V0(),on=i.BindingError=xs(Error,"BindingError"),ps=i.InternalError=xs(Error,"InternalError"),xo(),z0(),Mu(),Po=i.UnboundTypeError=xs(Error,"UnboundTypeError"),Nl(),ce.staticInit();function tf(ae,ie,pe){var Me=pe>0?pe:Q(ae)+1,tt=new Array(Me),st=Y(ae,tt,0,tt.length);return ie&&(tt.length=st),tt}var rf={b:zs,d:k0,u:U0,B:da,m:Pu,g:Wx,e:zx,q:jc,A:wu,t:Fu,f:Nu,a:Bu,s:ku,n:Uu,C:Vu,D:Gu,h:Wu,c:Ll,p:Fa,i:Hx,o:$c,l:Jc,k:Nn,j:n0,r:he,F:le,z:ve,y:re,E:it,w:Di,x:Hi,v:Hu};Jo(),i.___wasm_call_ctors=function(){return(i.___wasm_call_ctors=i.asm.H).apply(null,arguments)};var a0=i._malloc=function(){return(a0=i._malloc=i.asm.I).apply(null,arguments)},o0=i._free=function(){return(o0=i._free=i.asm.K).apply(null,arguments)},EM=i.___getTypeName=function(){return(EM=i.___getTypeName=i.asm.L).apply(null,arguments)};i.___embind_register_native_and_builtin_types=function(){return(i.___embind_register_native_and_builtin_types=i.asm.M).apply(null,arguments)};var AM=i.___cxa_is_pointer_type=function(){return(AM=i.___cxa_is_pointer_type=i.asm.N).apply(null,arguments)};i.dynCall_viijii=function(){return(i.dynCall_viijii=i.asm.O).apply(null,arguments)},i.dynCall_iiiiij=function(){return(i.dynCall_iiiiij=i.asm.P).apply(null,arguments)},i.dynCall_iiiiijj=function(){return(i.dynCall_iiiiijj=i.asm.Q).apply(null,arguments)},i.dynCall_iiiiiijj=function(){return(i.dynCall_iiiiiijj=i.asm.R).apply(null,arguments)};var sf;function hX(ae){this.name="ExitStatus",this.message="Program terminated with exit("+ae+")",this.status=ae}Ii=function ae(){sf||Vg(),sf||(Ii=ae)};function Vg(ae){if(Ui>0||(oi(),Ui>0))return;function ie(){sf||(sf=!0,i.calledRun=!0,!N&&(ci(),s(i),i.onRuntimeInitialized&&i.onRuntimeInitialized(),Li()))}i.setStatus?(i.setStatus("Running..."),setTimeout(function(){setTimeout(function(){i.setStatus("")},1),ie()},1)):ie()}if(i.run=Vg,i.preInit)for(typeof i.preInit=="function"&&(i.preInit=[i.preInit]);i.preInit.length>0;)i.preInit.pop()();return Vg(),e.ready}})();Ue().registerFlag("KEEP_INTERMEDIATE_TENSORS",()=>!1,l=>{l&&console.warn("Keep intermediate tensors is ON. This will print the values of all intermediate tensors during model inference. Not all models support this mode. For details, check e2e/benchmarks/ model_config.js. This significantly impacts performance.")});var Ga;(function(l){l[l.DT_INVALID=0]="DT_INVALID",l[l.DT_FLOAT=1]="DT_FLOAT",l[l.DT_DOUBLE=2]="DT_DOUBLE",l[l.DT_INT32=3]="DT_INT32",l[l.DT_UINT8=4]="DT_UINT8",l[l.DT_INT16=5]="DT_INT16",l[l.DT_INT8=6]="DT_INT8",l[l.DT_STRING=7]="DT_STRING",l[l.DT_COMPLEX64=8]="DT_COMPLEX64",l[l.DT_INT64=9]="DT_INT64",l[l.DT_BOOL=10]="DT_BOOL",l[l.DT_QINT8=11]="DT_QINT8",l[l.DT_QUINT8=12]="DT_QUINT8",l[l.DT_QINT32=13]="DT_QINT32",l[l.DT_BFLOAT16=14]="DT_BFLOAT16",l[l.DT_QINT16=15]="DT_QINT16",l[l.DT_QUINT16=16]="DT_QUINT16",l[l.DT_UINT16=17]="DT_UINT16",l[l.DT_COMPLEX128=18]="DT_COMPLEX128",l[l.DT_HALF=19]="DT_HALF",l[l.DT_RESOURCE=20]="DT_RESOURCE",l[l.DT_VARIANT=21]="DT_VARIANT",l[l.DT_UINT32=22]="DT_UINT32",l[l.DT_UINT64=23]="DT_UINT64",l[l.DT_FLOAT_REF=101]="DT_FLOAT_REF",l[l.DT_DOUBLE_REF=102]="DT_DOUBLE_REF",l[l.DT_INT32_REF=103]="DT_INT32_REF",l[l.DT_UINT8_REF=104]="DT_UINT8_REF",l[l.DT_INT16_REF=105]="DT_INT16_REF",l[l.DT_INT8_REF=106]="DT_INT8_REF",l[l.DT_STRING_REF=107]="DT_STRING_REF",l[l.DT_COMPLEX64_REF=108]="DT_COMPLEX64_REF",l[l.DT_INT64_REF=109]="DT_INT64_REF",l[l.DT_BOOL_REF=110]="DT_BOOL_REF",l[l.DT_QINT8_REF=111]="DT_QINT8_REF",l[l.DT_QUINT8_REF=112]="DT_QUINT8_REF",l[l.DT_QINT32_REF=113]="DT_QINT32_REF",l[l.DT_BFLOAT16_REF=114]="DT_BFLOAT16_REF",l[l.DT_QINT16_REF=115]="DT_QINT16_REF",l[l.DT_QUINT16_REF=116]="DT_QUINT16_REF",l[l.DT_UINT16_REF=117]="DT_UINT16_REF",l[l.DT_COMPLEX128_REF=118]="DT_COMPLEX128_REF",l[l.DT_HALF_REF=119]="DT_HALF_REF",l[l.DT_RESOURCE_REF=120]="DT_RESOURCE_REF",l[l.DT_VARIANT_REF=121]="DT_VARIANT_REF",l[l.DT_UINT32_REF=122]="DT_UINT32_REF",l[l.DT_UINT64_REF=123]="DT_UINT64_REF"})(Ga||(Ga={}));var jb;(function(l){(function(e){e[e.LEGACY=0]="LEGACY",e[e.V1=1]="V1",e[e.V2=2]="V2"})(l.CheckpointFormatVersion||(l.CheckpointFormatVersion={}))})(jb||(jb={}));const HL={};function qb(l){return HL[l]}function ee(l,e,i,s,n){const a=e.inputParams[l];if(a&&a.inputIndexStart!==void 0){const _=a.inputIndexStart,g=a.inputIndexEnd===0?void 0:a.inputIndexEnd===void 0?_+1:a.inputIndexEnd,y=_<0?e.inputNames.length+_:_;if(a.type==="tensor")return Zs(e.inputNames[y],i,s,n);if(a.type==="tensors"){const S=e.inputs.slice(_,g);return e.inputNames.slice(_,g).filter((M,F)=>{var L;return((L=S[F])===null||L===void 0?void 0:L.op)!=="NoOp"}).map(M=>Zs(M,i,s,n))}const b=Zs(e.inputNames[y],i,s,n),v=b.dataSync();return a.type==="number"?v[0]:Ys(b.shape,v)}const p=e.attrParams[l];return p&&p.value}function Zs(l,e,i,s){const[n,a]=ra(l,i);if(s!=null){const _=s.getHashTableHandleByName(n);if(_!=null)return _}const p=i.currentContextIds.find(_=>!!e[kd(n,_)]);return p!==void 0?e[kd(n,p)][a]:void 0}function Zb(l,e,i){return e[kd(l,i.currentContextId)]}function m0(l,e){const[i,s,n]=ra(l,e);return[kd(i,e&&e.currentContextId),s,n]}function kd(l,e){return e?l+"-"+e:l}function ra(l,e){if(l==="")return["",0,void 0];const i=e!=null&&e.parseNodeNameCache!=null;if(i){const a=e.parseNodeNameCache.get(l);if(a!=null)return a}const s=l.split(":");let n;if(s.length===1)n=[l,0,void 0];else{const a=s[0],p=s.length===3?s[1]:void 0,_=Number(s[s.length-1]);n=[a,_,p]}return i&&e.parseNodeNameCache.set(l,n),n}function Ud(l,e,i){let s=ee("pad",l,e,i);if(s==="explicit"){s=ee("explicitPaddings",l,e,i);const n=[[0,0],[0,0],[0,0],[0,0]];for(let a=0;a<4;a++)n[a][0]=s[a*2],n[a][1]=s[a*2+1];return n}return s}function _0(l){return l.kept?l:Id(l)}var XL=Object.freeze({__proto__:null,json:[{tfOpName:"Add",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"AddV2",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"AddN",category:"arithmetic",inputs:[{start:0,end:0,name:"tensors",type:"tensors"}]},{tfOpName:"BiasAdd",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"Sub",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"RealDiv",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Div",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"DivNoNan",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"FloorDiv",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Mul",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Maximum",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Minimum",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Pow",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"SquaredDifference",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Mod",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"FloorMod",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}]}),YL=Object.freeze({__proto__:null,json:[{tfOpName:"Abs",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Acos",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Asin",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Atan",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Atan2",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"y",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Ceil",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ClipByValue",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"clipValueMin",type:"number"},{start:2,name:"clipValueMax",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Complex",category:"basic_math",inputs:[{start:0,name:"real",type:"tensor"},{start:1,name:"imag",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ComplexAbs",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Cos",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Cosh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Elu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Exp",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Floor",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Log",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Imag",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"Tout",name:"outputType",type:"dtype",notSupported:!0}]},{tfOpName:"Neg",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Real",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"Tout",name:"outputType",type:"dtype",notSupported:!0}]},{tfOpName:"Prelu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"alpha",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Relu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Relu6",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Selu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sigmoid",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sin",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sinh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sqrt",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Rsqrt",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Square",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Tan",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Tanh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sign",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Round",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Expm1",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Log1p",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Reciprocal",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Softplus",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Asinh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Acosh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Atanh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Erf",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LeakyRelu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"alpha",name:"alpha",type:"number",defaultValue:.2},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"IsNan",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"IsFinite",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"IsInf",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}]}),KL=Object.freeze({__proto__:null,json:[{tfOpName:"EmptyTensorList",category:"control",inputs:[{start:0,name:"elementShape",type:"shape"},{start:1,name:"maxNumElements",type:"number"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"LoopCond",category:"control",inputs:[{start:0,name:"pred",type:"tensor"}]},{tfOpName:"Switch",category:"control",inputs:[{start:0,name:"data",type:"tensor"},{start:1,name:"pred",type:"tensor"}]},{tfOpName:"Merge",category:"control",inputs:[{start:0,end:0,name:"tensors",type:"tensors"}]},{tfOpName:"Enter",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"frame_name",name:"frameName",type:"string"},{tfName:"is_constant",name:"isConstant",type:"bool"}]},{tfOpName:"Exit",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"NextIteration",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"TensorArrayV3",category:"control",inputs:[{start:0,name:"size",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"element_shape",name:"elementShape",type:"shape"},{tfName:"dynamic_size",name:"dynamicSize",type:"bool"},{tfName:"clear_after_read",name:"clearAfterRead",type:"bool"},{tfName:"identical_element_shapes",name:"identicalElementShapes",type:"bool"},{tfName:"tensor_array_name",name:"name",type:"string"}]},{tfOpName:"TensorArrayWriteV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"tensor"},{start:1,name:"index",type:"number"},{start:2,name:"tensor",type:"tensor"},{start:3,name:"flowIn",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"TensorArrayReadV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"tensor"},{start:1,name:"index",type:"number"},{start:2,name:"flowIn",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"TensorArrayGatherV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"tensor"},{start:1,name:"indices",type:"number[]"},{start:2,name:"flowIn",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"element_shape",name:"elementShape",type:"shape"}]},{tfOpName:"TensorArrayScatterV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"tensor"},{start:1,name:"indices",type:"number[]"},{start:2,name:"tensor",type:"tensor"},{start:3,name:"flowIn",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"TensorArrayConcatV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"tensor"},{start:1,name:"flowIn",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"element_shape_except0",name:"elementShapeExcept0",type:"shape",notSupported:!0}]},{tfOpName:"TensorArraySplitV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"tensor"},{start:1,name:"tensor",type:"tensor"},{start:2,name:"lengths",type:"number[]"},{start:3,name:"flowIn",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"TensorArraySizeV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"tensor"},{start:1,name:"flowIn",type:"number"}]},{tfOpName:"TensorArrayCloseV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"tensor"}]},{tfOpName:"StatelessIf",category:"control",inputs:[{start:0,name:"cond",type:"tensor"},{start:1,end:0,name:"args",type:"tensors"}],attrs:[{tfName:"then_branch",name:"thenBranch",type:"func"},{tfName:"else_branch",name:"elseBranch",type:"func"}]},{tfOpName:"If",category:"control",inputs:[{start:0,name:"cond",type:"tensor"},{start:1,end:0,name:"args",type:"tensors"}],attrs:[{tfName:"then_branch",name:"thenBranch",type:"func"},{tfName:"else_branch",name:"elseBranch",type:"func"}]},{tfOpName:"StatelessWhile",category:"control",inputs:[{start:0,end:0,name:"args",type:"tensors"}],attrs:[{tfName:"cond",name:"cond",type:"func"},{tfName:"body",name:"body",type:"func"}]},{tfOpName:"While",category:"control",inputs:[{start:0,end:0,name:"args",type:"tensors"}],attrs:[{tfName:"cond",name:"cond",type:"func"},{tfName:"body",name:"body",type:"func"}]},{tfOpName:"TensorListScatter",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"},{start:1,name:"indices",type:"number[]"},{start:2,name:"elementShape",type:"shape"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListScatterV2",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"},{start:1,name:"indices",type:"number[]"},{start:2,name:"elementShape",type:"shape"},{start:3,name:"numElements",type:"number"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListGather",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"},{start:1,name:"indices",type:"number[]"},{start:2,name:"elementShape",type:"shape"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListGetItem",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"},{start:1,name:"index",type:"number"},{start:2,name:"elementShape",type:"shape"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListSetItem",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"},{start:1,name:"index",type:"number"},{start:2,name:"tensor",type:"tensor"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListReserve",category:"control",inputs:[{start:0,name:"elementShape",type:"shape"},{start:1,name:"numElements",type:"number"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListFromTensor",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"},{start:1,name:"elementShape",type:"shape"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListStack",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"},{start:1,name:"elementShape",type:"shape"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"},{tfName:"num_elements",name:"numElements",type:"dtype"}]},{tfOpName:"TensorListSplit",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"},{start:1,name:"elementShape",type:"shape"},{start:2,name:"lengths",type:"number[]"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListConcat",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"}],attrs:[{tfName:"element_shape",name:"elementShape",type:"shape"},{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListConcatV2",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"}],attrs:[{tfName:"element_shape",name:"elementShape",type:"shape"},{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListPopBack",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"},{start:1,name:"elementShape",type:"shape"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListPushBack",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"},{start:1,name:"tensor",type:"tensor"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListLength",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"}]},{tfOpName:"TensorListResize",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"},{start:1,name:"size",type:"number"}]}]}),jL=Object.freeze({__proto__:null,json:[{tfOpName:"AvgPool",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"MaxPool",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"explicit_paddings",name:"explicitPaddings",type:"number[]",defaultValue:[],notSupported:!0},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"MaxPoolWithArgmax",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"include_batch_in_index",name:"includeBatchInIndex",type:"bool"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"AvgPool3D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"MaxPool3D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Conv1D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"stride",name:"stride",type:"number"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NWC"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"dilation",name:"dilation",type:"number",defaultValue:1}]},{tfOpName:"Conv2D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"useCudnnOnGpu",name:"useCudnnOnGpu",type:"bool"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"explicit_paddings",name:"explicitPaddings",type:"number[]",defaultValue:[]},{tfName:"dilations",name:"dilations",type:"number[]"}]},{tfOpName:"_FusedConv2D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"},{start:2,end:0,name:"args",type:"tensors"}],attrs:[{tfName:"num_args",name:"numArgs",type:"number"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"explicit_paddings",name:"explicitPaddings",type:"number[]",defaultValue:[]},{tfName:"use_cudnn_on_gpu",name:"useCudnnOnGpu",type:"bool",defaultValue:!0},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"dilations",name:"dilations",type:"number[]",defaultValue:[1,1,1,1]},{tfName:"fused_ops",name:"fusedOps",type:"string[]",defaultValue:[]},{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:1e-4},{tfName:"leakyrelu_alpha",name:"leakyreluAlpha",type:"number",defaultValue:.2}]},{tfOpName:"Conv2DBackpropInput",category:"convolution",inputs:[{start:2,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"},{start:0,name:"outputShape",type:"number[]"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"explicit_paddings",name:"explicitPaddings",type:"number[]",defaultValue:[]},{tfName:"dilations",name:"dilations",type:"number[]",notSupported:!0}]},{tfOpName:"DepthwiseConv2d",category:"convolution",inputs:[{start:0,name:"input",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"explicit_paddings",name:"explicitPaddings",type:"number[]",defaultValue:[]},{tfName:"dilations",name:"dilations",type:"number[]"}]},{tfOpName:"DepthwiseConv2dNative",category:"convolution",inputs:[{start:0,name:"input",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"explicit_paddings",name:"explicitPaddings",type:"number[]",defaultValue:[]},{tfName:"dilations",name:"dilations",type:"number[]"}]},{tfOpName:"FusedDepthwiseConv2dNative",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"},{start:2,end:0,name:"args",type:"tensors"}],attrs:[{tfName:"num_args",name:"numArgs",type:"number"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"dilations",name:"dilations",type:"number[]",defaultValue:[1,1,1,1]},{tfName:"fused_ops",name:"fusedOps",type:"string[]",defaultValue:[]},{tfName:"explicit_paddings",name:"explicitPaddings",type:"number[]",defaultValue:[]}]},{tfOpName:"Conv3D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"dilations",name:"dilations",type:"number[]"}]},{tfOpName:"Dilation2D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"rates",name:"dilations",type:"number[]"},{tfName:"padding",name:"pad",type:"string"}]}]}),qL=Object.freeze({__proto__:null,json:[{tfOpName:"Fill",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"},{start:1,name:"value",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"LinSpace",category:"creation",inputs:[{start:0,name:"start",type:"number"},{start:1,name:"stop",type:"number"},{start:2,name:"num",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"OneHot",category:"creation",inputs:[{start:0,name:"indices",type:"tensor"},{start:1,name:"depth",type:"number"},{start:2,name:"onValue",type:"number",defaultValue:1},{start:3,name:"offValue",type:"number",defaultValue:0}],attrs:[{tfName:"axis",name:"axis",type:"number",notSupported:!0},{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"Ones",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"OnesLike",category:"creation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"}]},{tfOpName:"RandomStandardNormal",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"seed",name:"seed",type:"number",defaultValue:0},{tfName:"seed2",name:"seed2",type:"number",defaultValue:0,notSupported:!0},{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"T",name:"T",type:"number",notSupported:!0}]},{tfOpName:"RandomUniform",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"minval",name:"minval",type:"number",defaultValue:0},{tfName:"maxval",name:"maxval",type:"number",defaultValue:1},{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"seed",name:"seed",type:"number",defaultValue:0},{tfName:"seed2",name:"seed2",type:"number",defaultValue:0,notSupported:!0},{tfName:"T",name:"T",type:"number",notSupported:!0}]},{tfOpName:"RandomUniformInt",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"minval",name:"minval",type:"number"},{tfName:"maxval",name:"maxval",type:"number"},{tfName:"seed",name:"seed",type:"number",defaultValue:0},{tfName:"seed2",name:"seed2",type:"number",defaultValue:0,notSupported:!0}]},{tfOpName:"Range",category:"creation",inputs:[{start:0,name:"start",type:"number"},{start:1,name:"stop",type:"number"},{start:2,name:"step",type:"number",defaultValue:0}],attrs:[{tfName:"Tidx",name:"dtype",type:"dtype"}]},{tfOpName:"TruncatedNormal",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"means",name:"mean",type:"number",defaultValue:0},{tfName:"stddev",name:"stdDev",type:"number",defaultValue:1},{tfName:"seed",name:"seed",type:"number"},{tfName:"seed2",name:"seed2",type:"number",defaultValue:0,notSupported:!0},{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"T",name:"T",type:"number",notSupported:!0}]},{tfOpName:"Zeros",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"ZerosLike",category:"creation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"Multinomial",category:"creation",inputs:[{start:0,name:"logits",type:"tensor"},{start:1,name:"numSamples",type:"number"}],attrs:[{tfName:"seed",name:"seed",type:"number"},{tfName:"seed2",name:"seed2",type:"number"},{tfName:"T",name:"dtype",type:"dtype"},{tfName:"output_dtype",name:"output_dtype",type:"dtype"}]}]}),ZL=Object.freeze({__proto__:null,json:[{tfOpName:"NonMaxSuppressionV2",category:"dynamic",inputs:[{start:0,name:"boxes",type:"tensor"},{start:1,name:"scores",type:"tensor"},{start:2,name:"maxOutputSize",type:"number"},{start:3,name:"iouThreshold",type:"number"}]},{tfOpName:"NonMaxSuppressionV3",category:"dynamic",inputs:[{start:0,name:"boxes",type:"tensor"},{start:1,name:"scores",type:"tensor"},{start:2,name:"maxOutputSize",type:"number"},{start:3,name:"iouThreshold",type:"number"},{start:4,name:"scoreThreshold",type:"number"}]},{tfOpName:"NonMaxSuppressionV4",category:"dynamic",inputs:[{start:0,name:"boxes",type:"tensor"},{start:1,name:"scores",type:"tensor"},{start:2,name:"maxOutputSize",type:"number"},{start:3,name:"iouThreshold",type:"number"},{start:4,name:"scoreThreshold",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"T_threshold",name:"threshold",type:"dtype",notSupported:!0},{tfName:"pad_to_max_output_size",name:"padToMaxOutputSize",type:"bool"}]},{tfOpName:"NonMaxSuppressionV5",category:"dynamic",inputs:[{start:0,name:"boxes",type:"tensor"},{start:1,name:"scores",type:"tensor"},{start:2,name:"maxOutputSize",type:"number"},{start:3,name:"iouThreshold",type:"number"},{start:4,name:"scoreThreshold",type:"number"},{start:5,name:"softNmsSigma",type:"number"}]},{tfOpName:"Where",category:"dynamic",inputs:[{start:0,name:"condition",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ListDiff",category:"dynamic",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"y",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}]}),QL=Object.freeze({__proto__:null,json:[{tfOpName:"LowerBound",category:"evaluation",inputs:[{start:0,name:"sortedSequence",type:"tensor"},{start:1,name:"values",type:"tensor"}]},{tfOpName:"TopKV2",category:"evaluation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"k",type:"number"}],attrs:[{tfName:"sorted",name:"sorted",type:"bool"}]},{tfOpName:"UpperBound",category:"evaluation",inputs:[{start:0,name:"sortedSequence",type:"tensor"},{start:1,name:"values",type:"tensor"}]},{tfOpName:"Unique",category:"evaluation",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"UniqueV2",category:"evaluation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}]}]}),$L=Object.freeze({__proto__:null,json:[{tfOpName:"PlaceholderWithDefault",category:"graph",inputs:[{start:0,name:"default",type:"tensor"}],attrs:[{tfName:"shape",name:"shape",type:"shape"},{tfName:"dtype",name:"dtype",type:"dtype"}]},{tfOpName:"Placeholder",category:"graph",attrs:[{tfName:"shape",name:"shape",type:"shape"},{tfName:"dtype",name:"dtype",type:"dtype"}]},{tfOpName:"Const",category:"graph"},{tfOpName:"Identity",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"IdentityN",category:"graph",inputs:[{start:0,end:0,name:"x",type:"tensors"}]},{tfOpName:"Snapshot",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"Rank",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"Size",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"Shape",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"ShapeN",category:"graph",inputs:[{start:0,end:0,name:"x",type:"tensors"}]},{tfOpName:"Print",category:"graph",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"data",type:"tensors"}],attrs:[{tfName:"message",name:"message",type:"string"},{tfName:"first_n",name:"firstN",type:"number",notSupported:!0},{tfName:"summarize",name:"summarize",type:"number",defaultValue:3}]},{tfOpName:"NoOp",category:"graph",inputs:[]},{tfOpName:"StopGradient",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"FakeQuantWithMinMaxVars",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"min",name:"min",type:"number"},{tfName:"max",name:"max",type:"number"}]}]}),JL=Object.freeze({__proto__:null,json:[{tfOpName:"HashTable",category:"hash_table",inputs:[],attrs:[{tfName:"shared_name",name:"sharedName",type:"string"},{tfName:"use_node_name_sharing",name:"useNodeNameSharing",type:"bool"},{tfName:"key_dtype",name:"keyDType",type:"dtype"},{tfName:"value_dtype",name:"valueDType",type:"dtype"}]},{tfOpName:"HashTableV2",category:"hash_table",inputs:[],attrs:[{tfName:"shared_name",name:"sharedName",type:"string"},{tfName:"use_node_name_sharing",name:"useNodeNameSharing",type:"bool"},{tfName:"key_dtype",name:"keyDType",type:"dtype"},{tfName:"value_dtype",name:"valueDType",type:"dtype"}]},{tfOpName:"LookupTableImport",category:"hash_table",inputs:[{start:0,name:"tableHandle",type:"tensor"},{start:1,name:"keys",type:"tensor"},{start:2,name:"values",type:"tensor"}],attrs:[{tfName:"Tin",name:"tIn",type:"dtype",notSupported:!0},{tfName:"Tout",name:"tOut",type:"dtype",notSupported:!0}]},{tfOpName:"LookupTableImportV2",category:"hash_table",inputs:[{start:0,name:"tableHandle",type:"tensor"},{start:1,name:"keys",type:"tensor"},{start:2,name:"values",type:"tensor"}],attrs:[{tfName:"Tin",name:"tIn",type:"dtype",notSupported:!0},{tfName:"Tout",name:"tOut",type:"dtype",notSupported:!0}]},{tfOpName:"LookupTableFind",category:"hash_table",inputs:[{start:0,name:"tableHandle",type:"tensor"},{start:1,name:"keys",type:"tensor"},{start:2,name:"defaultValue",type:"tensor"}],attrs:[{tfName:"Tin",name:"tIn",type:"dtype",notSupported:!0},{tfName:"Tout",name:"tOut",type:"dtype",notSupported:!0}]},{tfOpName:"LookupTableFindV2",category:"hash_table",inputs:[{start:0,name:"tableHandle",type:"tensor"},{start:1,name:"keys",type:"tensor"},{start:2,name:"defaultValue",type:"tensor"}],attrs:[{tfName:"Tin",name:"tIn",type:"dtype",notSupported:!0},{tfName:"Tout",name:"tOut",type:"dtype",notSupported:!0}]},{tfOpName:"LookupTableSize",category:"hash_table",inputs:[{start:0,name:"tableHandle",type:"tensor"}]},{tfOpName:"LookupTableSizeV2",category:"hash_table",inputs:[{start:0,name:"tableHandle",type:"tensor"}]},{tfOpName:"InitializeTable",category:"hash_table",inputs:[{start:0,name:"tableHandle",type:"tensor"},{start:1,name:"keys",type:"tensor"},{start:2,name:"values",type:"tensor"}]},{tfOpName:"InitializeTableV2",category:"hash_table",inputs:[{start:0,name:"tableHandle",type:"tensor"},{start:1,name:"keys",type:"tensor"},{start:2,name:"values",type:"tensor"}]}]}),eN=Object.freeze({__proto__:null,json:[{tfOpName:"ResizeBilinear",category:"image",inputs:[{start:0,name:"images",type:"tensor"},{start:1,name:"size",type:"number[]"}],attrs:[{tfName:"align_corners",name:"alignCorners",type:"bool"},{tfName:"half_pixel_centers",name:"halfPixelCenters",type:"bool"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ResizeNearestNeighbor",category:"image",inputs:[{start:0,name:"images",type:"tensor"},{start:1,name:"size",type:"number[]"}],attrs:[{tfName:"align_corners",name:"alignCorners",type:"bool"},{tfName:"half_pixel_centers",name:"halfPixelCenters",type:"bool"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"CropAndResize",category:"image",inputs:[{start:0,name:"image",type:"tensor"},{start:1,name:"boxes",type:"tensor"},{start:2,name:"boxInd",type:"tensor"},{start:3,name:"cropSize",type:"number[]"}],attrs:[{tfName:"method",name:"method",type:"string"},{tfName:"extrapolation_value",name:"extrapolationValue",type:"number"}]},{tfOpName:"ImageProjectiveTransformV3",category:"image",inputs:[{start:0,name:"images",type:"tensor"},{start:1,name:"transforms",type:"tensor"},{start:2,name:"outputShape",type:"number[]"},{start:3,name:"fillValue",type:"number"}],attrs:[{tfName:"interpolation",name:"interpolation",type:"string"},{tfName:"fill_mode",name:"fillMode",type:"string"}]}]}),tN=Object.freeze({__proto__:null,json:[{tfOpName:"Equal",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"NotEqual",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Greater",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"GreaterEqual",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Less",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LessEqual",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LogicalAnd",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LogicalNot",category:"logical",inputs:[{start:0,name:"a",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LogicalOr",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Select",category:"logical",inputs:[{start:0,name:"condition",type:"tensor"},{start:1,name:"a",type:"tensor"},{start:2,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"SelectV2",category:"logical",inputs:[{start:0,name:"condition",type:"tensor"},{start:1,name:"a",type:"tensor"},{start:2,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"BitwiseAnd",category:"logical",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"y",type:"tensor"}]}]}),iN=Object.freeze({__proto__:null,json:[{tfOpName:"_FusedMatMul",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"},{start:2,end:0,name:"args",type:"tensors"}],attrs:[{tfName:"num_args",name:"numArgs",type:"number"},{tfName:"fused_ops",name:"fusedOps",type:"string[]",defaultValue:[]},{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:1e-4},{tfName:"transpose_a",name:"transposeA",type:"bool",defaultValue:!1},{tfName:"transpose_b",name:"transposeB",type:"bool",defaultValue:!1},{tfName:"leakyrelu_alpha",name:"leakyreluAlpha",type:"number",defaultValue:.2},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"MatMul",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"transpose_a",name:"transposeA",type:"bool",defaultValue:!1},{tfName:"transpose_b",name:"transposeB",type:"bool",defaultValue:!1},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"BatchMatMul",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"adj_x",name:"transposeA",type:"bool",defaultValue:!1},{tfName:"adj_y",name:"transposeB",type:"bool",defaultValue:!1},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"BatchMatMulV2",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"adj_x",name:"transposeA",type:"bool",defaultValue:!1},{tfName:"adj_y",name:"transposeB",type:"bool",defaultValue:!1},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Transpose",category:"matrices",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"perm",type:"number[]"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Einsum",category:"matrices",inputs:[{start:0,end:0,name:"tensors",type:"tensors"}],attrs:[{tfName:"equation",name:"equation",type:"string"},{tfName:"N",name:"n",type:"number",defaultValue:2},{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"MatrixBandPart",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"numLower",type:"tensor"},{start:1,name:"numUpper",type:"tensor"}]}]}),rN=Object.freeze({__proto__:null,json:[{tfOpName:"EuclideanNorm",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool",defaultValue:!1}]},{tfOpName:"FusedBatchNorm",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"scale",type:"tensor"},{start:2,name:"offset",type:"tensor"},{start:3,name:"mean",type:"tensor"},{start:4,name:"variance",type:"tensor"}],attrs:[{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:.001},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"FusedBatchNormV2",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"scale",type:"tensor"},{start:2,name:"offset",type:"tensor"},{start:3,name:"mean",type:"tensor"},{start:4,name:"variance",type:"tensor"}],attrs:[{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:.001},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"FusedBatchNormV3",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"scale",type:"tensor"},{start:2,name:"offset",type:"tensor"},{start:3,name:"mean",type:"tensor"},{start:4,name:"variance",type:"tensor"}],attrs:[{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:.001},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"LRN",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"depth_radius",name:"radius",type:"number",defaultValue:5},{tfName:"bias",name:"bias",type:"number",defaultValue:1},{tfName:"alpha",name:"alpha",type:"number",defaultValue:1},{tfName:"beta",name:"beta",type:"number",defaultValue:.5}]},{tfOpName:"Softmax",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"LogSoftmax",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"}]}]}),sN=Object.freeze({__proto__:null,json:[{tfOpName:"Bincount",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"size",type:"number"},{start:2,name:"weights",type:"tensor"}]},{tfOpName:"DenseBincount",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"size",type:"number"},{start:2,name:"weights",type:"tensor"}],attrs:[{tfName:"binary_output",name:"binaryOutput",type:"bool"}]},{tfOpName:"Max",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Mean",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Min",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Sum",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"All",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Any",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"ArgMax",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}]},{tfOpName:"ArgMin",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}]},{tfOpName:"Prod",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Cumprod",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}],attrs:[{tfName:"exclusive",name:"exclusive",type:"bool"},{tfName:"reverse",name:"reverse",type:"bool"}]},{tfOpName:"Cumsum",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}],attrs:[{tfName:"exclusive",name:"exclusive",type:"bool"},{tfName:"reverse",name:"reverse",type:"bool"}]}]}),nN=Object.freeze({__proto__:null,json:[{tfOpName:"ConcatV2",category:"slice_join",inputs:[{start:0,end:-1,name:"tensors",type:"tensors"},{start:-1,name:"axis",type:"number"}],attrs:[{tfName:"N",name:"n",type:"number",defaultValue:2}]},{tfOpName:"Concat",category:"slice_join",inputs:[{start:1,end:0,name:"tensors",type:"tensors"},{start:0,name:"axis",type:"number"}],attrs:[{tfName:"N",name:"n",type:"number",defaultValue:2}]},{tfOpName:"GatherV2",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"indices",type:"tensor"},{start:2,name:"axis",type:"number",defaultValue:0}],attrs:[{tfName:"batch_dims",name:"batchDims",type:"number",defaultValue:0}]},{tfOpName:"Gather",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"indices",type:"tensor"}],attrs:[{tfName:"validate_indices",name:"validateIndices",type:"bool",notSupported:!0}]},{tfOpName:"Reverse",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"dims",type:"bool[]"}]},{tfOpName:"ReverseV2",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}]},{tfOpName:"Slice",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"begin",type:"number[]"},{start:2,name:"size",type:"number[]"}]},{tfOpName:"StridedSlice",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"begin",type:"number[]"},{start:2,name:"end",type:"number[]"},{start:3,name:"strides",type:"number[]"}],attrs:[{tfName:"begin_mask",name:"beginMask",type:"number",defaultValue:0},{tfName:"end_mask",name:"endMask",type:"number",defaultValue:0},{tfName:"new_axis_mask",name:"newAxisMask",type:"number",defaultValue:0},{tfName:"ellipsis_mask",name:"ellipsisMask",type:"number",defaultValue:0},{tfName:"shrink_axis_mask",name:"shrinkAxisMask",type:"number",defaultValue:0}]},{tfOpName:"Pack",category:"slice_join",inputs:[{start:0,end:0,name:"tensors",type:"tensors"}],attrs:[{tfName:"axis",name:"axis",type:"number",defaultValue:0}]},{tfOpName:"Unpack",category:"slice_join",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"axis",name:"axis",type:"number",defaultValue:0},{tfName:"num",name:"num",type:"number",defaultValue:0,notSupported:!0}]},{tfOpName:"Tile",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"reps",type:"number[]"}]},{tfOpName:"Split",category:"slice_join",inputs:[{start:0,name:"axis",type:"number",defaultValue:0},{start:1,name:"x",type:"tensor"}],attrs:[{tfName:"num_split",name:"numOrSizeSplits",type:"number",defaultValue:1}]},{tfOpName:"SplitV",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"numOrSizeSplits",type:"number[]"},{start:2,name:"axis",type:"number",defaultValue:0}]},{tfOpName:"ScatterNd",category:"slice_join",inputs:[{start:0,name:"indices",type:"tensor"},{start:1,name:"values",type:"tensor"},{start:2,name:"shape",type:"number[]"}]},{tfOpName:"GatherNd",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"indices",type:"tensor"}]},{tfOpName:"SparseToDense",category:"slice_join",inputs:[{start:0,name:"sparseIndices",type:"tensor"},{start:1,name:"outputShape",type:"number[]"},{start:2,name:"sparseValues",type:"tensor"},{start:3,name:"defaultValue",type:"tensor"}],attrs:[{tfName:"validate_indices",name:"validateIndices",type:"bool",defaultValue:!1,notSupported:!0}]},{tfOpName:"TensorScatterUpdate",category:"slice_join",inputs:[{start:0,name:"tensor",type:"tensor"},{start:1,name:"indices",type:"tensor"},{start:2,name:"values",type:"tensor"}]}]}),aN=Object.freeze({__proto__:null,json:[{tfOpName:"SparseFillEmptyRows",category:"sparse",inputs:[{start:0,name:"indices",type:"tensor"},{start:1,name:"values",type:"tensor"},{start:2,name:"denseShape",type:"tensor"},{start:3,name:"defaultValue",type:"tensor"}]},{tfOpName:"SparseReshape",category:"sparse",inputs:[{start:0,name:"inputIndices",type:"tensor"},{start:1,name:"inputShape",type:"tensor"},{start:2,name:"newShape",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"SparseSegmentMean",category:"sparse",inputs:[{start:0,name:"data",type:"tensor"},{start:1,name:"indices",type:"tensor"},{start:2,name:"segmentIds",type:"tensor"}]},{tfOpName:"SparseSegmentSum",category:"sparse",inputs:[{start:0,name:"data",type:"tensor"},{start:1,name:"indices",type:"tensor"},{start:2,name:"segmentIds",type:"tensor"}]}]}),oN=Object.freeze({__proto__:null,json:[{tfOpName:"FFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"IFFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"RFFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"fft_length",type:"number",notSupported:!0}]},{tfOpName:"IRFFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"fft_length",type:"number",notSupported:!0}]}]}),xN=Object.freeze({__proto__:null,json:[{tfOpName:"StaticRegexReplace",category:"string",inputs:[{start:0,name:"input",type:"tensor"}],attrs:[{tfName:"pattern",name:"pattern",type:"string"},{tfName:"rewrite",name:"rewrite",type:"string"},{tfName:"replace_global",name:"replaceGlobal",type:"bool"}]},{tfOpName:"StringNGrams",category:"string",inputs:[{start:0,name:"data",type:"tensor"},{start:1,name:"dataSplits",type:"tensor"}],attrs:[{tfName:"separator",name:"separator",type:"string"},{tfName:"ngram_widths",name:"nGramWidths",type:"number[]"},{tfName:"left_pad",name:"leftPad",type:"string"},{tfName:"right_pad",name:"rightPad",type:"string"},{tfName:"pad_width",name:"padWidth",type:"number"},{tfName:"preserve_short_sequences",name:"preserveShortSequences",type:"bool"}],outputs:["ngrams","ngrams_splits"]},{tfOpName:"StringSplit",category:"string",inputs:[{start:0,name:"input",type:"tensor"},{start:1,name:"delimiter",type:"tensor"}],attrs:[{tfName:"skip_empty",name:"skipEmpty",type:"bool"}],outputs:["indices","values","shape"]},{tfOpName:"StringToHashBucketFast",category:"string",inputs:[{start:0,name:"input",type:"tensor"}],attrs:[{tfName:"num_buckets",name:"numBuckets",type:"number"}]}]}),lN=Object.freeze({__proto__:null,json:[{tfOpName:"Cast",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"SrcT",name:"sdtype",type:"dtype",notSupported:!0},{tfName:"DstT",name:"dtype",type:"dtype"}]},{tfOpName:"ExpandDims",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}]},{tfOpName:"MirrorPad",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"padding",type:"number[]"}],attrs:[{tfName:"mode",name:"mode",type:"string"}]},{tfOpName:"Pad",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"padding",type:"number[]"}],attrs:[{tfName:"constant_value",name:"constantValue",type:"number",defaultValue:0}]},{tfOpName:"PadV2",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"padding",type:"number[]"},{start:2,name:"constantValue",type:"number",defaultValue:0}]},{tfOpName:"Reshape",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"shape",type:"number[]"}]},{tfOpName:"EnsureShape",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"shape",type:"number[]"}]},{tfOpName:"Squeeze",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"axis",tfDeprecatedName:"squeeze_dims",name:"axis",type:"number[]"}]},{tfOpName:"SpaceToBatchND",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"blockShape",type:"number[]"},{start:2,name:"paddings",type:"number[]"}]},{tfOpName:"BatchToSpaceND",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"blockShape",type:"number[]"},{start:2,name:"crops",type:"number[]"}]},{tfOpName:"DepthToSpace",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"block_size",name:"blockSize",type:"number"},{tfName:"data_format",name:"dataFormat",type:"string"}]},{tfOpName:"BroadcastTo",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"shape",type:"number[]"}],attrs:[]},{tfOpName:"BroadcastArgs",category:"transformation",inputs:[{start:0,name:"s0",type:"tensor"},{start:1,name:"s1",type:"tensor"}],attrs:[]}]});class Qb{static get Instance(){return this._instance||(this._instance=new this)}constructor(){const e=[XL,YL,KL,jL,qL,ZL,QL,$L,JL,eN,tN,iN,rN,sN,nN,aN,oN,xN,lN],i=[].concat(...e.map(s=>s.json));this.opMappers=i.reduce((s,n)=>(s[n.tfOpName]=n,s),{})}transformGraph(e,i={}){const s=e.node,n=[],a=[],p=[],_=s.reduce((L,N)=>(L[N.name]=this.mapNode(N),N.op.startsWith("Placeholder")?n.push(L[N.name]):N.op==="Const"?a.push(L[N.name]):(N.input==null||N.input.length===0)&&p.push(L[N.name]),L),{});let g=[];const y=[];let b={},v={};i!=null&&(b=this.mapSignatureEntries(i.inputs),v=this.mapSignatureEntries(i.outputs));const S=Object.keys(_);S.forEach(L=>{const N=_[L];N.inputNames.forEach((k,G)=>{const[H,,z]=m0(k),W=_[H];if(W.outputs!=null){const Y=W.outputs.indexOf(z);if(Y!==-1){const Z=H+":"+Y;N.inputNames[G]=Z}}N.inputs.push(W),W.children.push(N)})}),Object.keys(v).length===0?S.forEach(L=>{const N=_[L];N.children.length===0&&y.push(N)}):Object.keys(v).forEach(L=>{const[N]=m0(L),k=_[N];k!=null&&(k.signatureKey=v[L],y.push(k))}),Object.keys(b).length>0?Object.keys(b).forEach(L=>{const[N]=m0(L),k=_[N];k&&(k.signatureKey=b[L],g.push(k))}):g=n;let M={};e.library!=null&&e.library.function!=null&&(M=e.library.function.reduce((L,N)=>(L[N.signature.name]=this.mapFunction(N),L),{}));const F={nodes:_,inputs:g,outputs:y,weights:a,placeholders:n,signature:i,functions:M};return p.length>0&&(F.initNodes=p),F}mapSignatureEntries(e){return Object.keys(e||{}).reduce((i,s)=>(i[e[s].name]=s,i),{})}mapNode(e){const i=qb(e.op)||this.opMappers[e.op]||{};e.attr==null&&(e.attr={});const s={name:e.name,op:e.op,category:i.category,inputNames:(e.input||[]).map(n=>n.startsWith("^")?n.slice(1):n),inputs:[],children:[],inputParams:{},attrParams:{},rawAttrs:e.attr,outputs:i.outputs};return i.inputs!=null&&(s.inputParams=i.inputs.reduce((n,a)=>(n[a.name]={type:a.type,inputIndexStart:a.start,inputIndexEnd:a.end},n),{})),i.attrs!=null&&(s.attrParams=i.attrs.reduce((n,a)=>{const p=a.type;let _;switch(a.type){case"string":_=Gp(e.attr,a.tfName,a.defaultValue),_===void 0&&a.tfDeprecatedName&&(_=Gp(e.attr,a.tfDeprecatedName,a.defaultValue));break;case"string[]":_=qp(e.attr,a.tfName,a.defaultValue),_===void 0&&a.tfDeprecatedName&&(_=qp(e.attr,a.tfDeprecatedName,a.defaultValue));break;case"number":_=zp(e.attr,a.tfName,a.defaultValue||0),_===void 0&&a.tfDeprecatedName&&(_=zp(e.attr,a.tfDeprecatedName,a.defaultValue));break;case"number[]":_=jp(e.attr,a.tfName,a.defaultValue),_===void 0&&a.tfDeprecatedName&&(_=jp(e.attr,a.tfDeprecatedName,a.defaultValue));break;case"bool":_=Wp(e.attr,a.tfName,a.defaultValue),_===void 0&&a.tfDeprecatedName&&(_=Wp(e.attr,a.tfDeprecatedName,a.defaultValue));break;case"bool[]":_=Qp(e.attr,a.tfName,a.defaultValue),_===void 0&&a.tfDeprecatedName&&(_=Qp(e.attr,a.tfDeprecatedName,a.defaultValue));break;case"shape":_=Kp(e.attr,a.tfName,a.defaultValue),_===void 0&&a.tfDeprecatedName&&(_=Kp(e.attr,a.tfDeprecatedName,a.defaultValue));break;case"shape[]":_=Zp(e.attr,a.tfName,a.defaultValue),_===void 0&&a.tfDeprecatedName&&(_=Zp(e.attr,a.tfDeprecatedName,a.defaultValue));break;case"dtype":_=Xp(e.attr,a.tfName,a.defaultValue),_===void 0&&a.tfDeprecatedName&&(_=Xp(e.attr,a.tfDeprecatedName,a.defaultValue));break;case"dtype[]":_=Yp(e.attr,a.tfName,a.defaultValue),_===void 0&&a.tfDeprecatedName&&(_=Yp(e.attr,a.tfDeprecatedName,a.defaultValue));break;case"func":_=Jb(e.attr,a.tfName,a.defaultValue),_===void 0&&a.tfDeprecatedName&&(_=Jb(e.attr,a.tfDeprecatedName,a.defaultValue));break;case"tensor":case"tensors":break;default:throw new Error("Unsupported param type: "+a.type+" for op: "+e.op)}return n[a.name]={value:_,type:p},n},{})),s}mapFunction(e){const i=e.nodeDef,s=[],n=[];let a={};i!=null&&(a=i.reduce((b,v)=>(b[v.name]=this.mapNode(v),v.op==="Const"&&n.push(b[v.name]),b),{}));const p=[],_=[];e.signature.inputArg.forEach(b=>{const[v]=m0(b.name),S={name:v,op:"Placeholder",inputs:[],inputNames:[],category:"graph",inputParams:{},attrParams:{dtype:{value:Hp(b.type),type:"dtype"}},children:[]};S.signatureKey=b.name,p.push(S),a[v]=S}),Object.keys(a).forEach(b=>{const v=a[b];v.inputNames.forEach((S,M)=>{const[F,,L]=m0(S),N=a[F];if(N.outputs!=null){const k=N.outputs.indexOf(L);if(k!==-1){const G=F+":"+k;v.inputNames[M]=G}}v.inputs.push(N),N.children.push(v)})});const g=e.ret;e.signature.outputArg.forEach(b=>{const[v,S]=m0(g[b.name]),M=a[v];M!=null&&(M.defaultOutput=S,_.push(M))});const y=this.mapArgsToSignature(e);return{nodes:a,inputs:p,outputs:_,weights:n,placeholders:s,signature:y}}mapArgsToSignature(e){return{methodName:e.signature.name,inputs:e.signature.inputArg.reduce((i,s)=>(i[s.name]=this.mapArgToTensorInfo(s),i),{}),outputs:e.signature.outputArg.reduce((i,s)=>(i[s.name]=this.mapArgToTensorInfo(s,e.ret),i),{})}}mapArgToTensorInfo(e,i){let s=e.name;return i!=null&&(s=i[s]),{name:s,dtype:e.type}}}function cN(l){const e=Ue().global;if(typeof e.atob<"u")return e.atob(l);if(typeof Buffer<"u")return new Buffer(l,"base64").toString();throw new Error("Unable to decode base64 in this environment. Missing built-in atob() or Buffer()")}function $b(l,e){const i=Array.isArray(l)?String.fromCharCode.apply(null,l):cN(l);return e?i:i.toLowerCase()}function Gp(l,e,i,s=!1){const n=l[e];return n!=null?$b(n.s,s):i}function Wp(l,e,i){const s=l[e];return s?s.b:i}function zp(l,e,i){const s=l[e]||{},n=s.i!=null?s.i:s.f!=null?s.f:i;return typeof n=="number"?n:parseInt(n,10)}function Hp(l){switch(typeof l=="string"&&(l=Ga[l]),l){case Ga.DT_FLOAT:case Ga.DT_HALF:return"float32";case Ga.DT_INT32:case Ga.DT_INT64:case Ga.DT_INT8:case Ga.DT_UINT8:return"int32";case Ga.DT_BOOL:return"bool";case Ga.DT_DOUBLE:return"float32";case Ga.DT_STRING:return"string";default:return null}}function Jb(l,e,i){const s=l[e];return s&&s.func?s.func.name:i}function Xp(l,e,i){const s=l[e];return s&&s.type?Hp(s.type):i}function Yp(l,e,i){const s=l[e];return s&&s.list&&s.list.type?s.list.type.map(n=>Hp(n)):i}function ev(l){if(!l.unknownRank)return l.dim!=null?l.dim.map(e=>typeof e.size=="number"?e.size:parseInt(e.size,10)):[]}function Kp(l,e,i){const s=l[e];return s&&s.shape?ev(s.shape):i}function jp(l,e,i){const s=l[e];return s?((s.list.f&&s.list.f.length?s.list.f:s.list.i)||[]).map(n=>typeof n=="number"?n:parseInt(n,10)):i}function qp(l,e,i,s=!1){const n=l[e];return n&&n.list&&n.list.s?n.list.s.map(a=>$b(a,s)):i}function Zp(l,e,i){const s=l[e];return s&&s.list&&s.list.shape?s.list.shape.map(n=>ev(n)):i}function Qp(l,e,i){const s=l[e];return s&&s.list&&s.list.b?s.list.b:i}class hN{constructor(e,i,s){this.node=e,this.tensorMap=i,this.context=s,this.inputs=[],this.attrs={},this.inputs=e.inputNames.map(n=>this.getInput(n)),e.rawAttrs!=null&&(this.attrs=Object.keys(e.rawAttrs).reduce((n,a)=>(n[a]=this.getAttr(a),n),{}))}getInput(e){return Zs(e,this.tensorMap,this.context)}getAttr(e,i){const s=this.node.rawAttrs[e];if(s.tensor!=null)return Zs(e,this.tensorMap,this.context);if(s.i!=null||s.f!=null)return zp(this.node.rawAttrs,e,i);if(s.s!=null)return Gp(this.node.rawAttrs,e,i);if(s.b!=null)return Wp(this.node.rawAttrs,e,i);if(s.shape!=null)return Kp(this.node.rawAttrs,e,i);if(s.type!=null)return Xp(this.node.rawAttrs,e,i);if(s.list!=null){if(s.list.i!=null||s.list.f!=null)return jp(this.node.rawAttrs,e,i);if(s.list.s!=null)return qp(this.node.rawAttrs,e,i);if(s.list.shape!=null)return Zp(this.node.rawAttrs,e,i);if(s.list.b!=null)return Qp(this.node.rawAttrs,e,i);if(s.list.type!=null)return Yp(this.node.rawAttrs,e,i)}return i}}var Qs=Object.freeze({__proto__:null,add:Hr,addN:XO,atan2:KO,cast:kn,concat:Zl,conv2d:xb,cos:yw,depthToSpace:vw,depthwiseConv2d:Md,expandDims:yh,fill:_p,floor:zw,fused:{conv2d:JD,depthwiseConv2d:nF,matMul:oF},gather:Xw,greaterEqual:jw,image:{resizeBilinear:Tb},lessEqual:pb,logicalAnd:tD,matMul:po,max:Pd,maxPool:bp,maximum:aD,mean:xD,min:_h,minimum:cD,mul:js,neg:Ky,pad:wd,prelu:mb,range:Ip,relu:gb,relu6:yb,reshape:ti,sigmoid:fh,sin:kD,squeeze:ds,stack:bh,stridedSlice:KD,sub:ia,tensor1d:qs,tile:ub,transpose:SO,zerosLike:Cw});const uN=(l,e,i,s=Qs)=>{switch(l.op){case"BiasAdd":case"AddV2":case"Add":return[s.add(ee("a",l,e,i),ee("b",l,e,i))];case"AddN":return[s.addN(ee("tensors",l,e,i))];case"FloorMod":case"Mod":return[s.mod(ee("a",l,e,i),ee("b",l,e,i))];case"Mul":return[s.mul(ee("a",l,e,i),ee("b",l,e,i))];case"RealDiv":case"Div":return[s.div(ee("a",l,e,i),ee("b",l,e,i))];case"DivNoNan":return[s.divNoNan(ee("a",l,e,i),ee("b",l,e,i))];case"FloorDiv":return[s.floorDiv(ee("a",l,e,i),ee("b",l,e,i))];case"Sub":return[s.sub(ee("a",l,e,i),ee("b",l,e,i))];case"Minimum":return[s.minimum(ee("a",l,e,i),ee("b",l,e,i))];case"Maximum":return[s.maximum(ee("a",l,e,i),ee("b",l,e,i))];case"Pow":return[s.pow(ee("a",l,e,i),ee("b",l,e,i))];case"SquaredDifference":return[s.squaredDifference(ee("a",l,e,i),ee("b",l,e,i))];default:throw TypeError("Node type "+l.op+" is not implemented")}},dN=(l,e,i,s=Qs)=>{switch(l.op){case"Abs":case"ComplexAbs":return[s.abs(ee("x",l,e,i))];case"Acos":return[s.acos(ee("x",l,e,i))];case"Acosh":return[s.acosh(ee("x",l,e,i))];case"Asin":return[s.asin(ee("x",l,e,i))];case"Asinh":return[s.asinh(ee("x",l,e,i))];case"Atan":return[s.atan(ee("x",l,e,i))];case"Atan2":return[s.atan2(ee("x",l,e,i),ee("y",l,e,i))];case"Atanh":return[s.atanh(ee("x",l,e,i))];case"Ceil":return[s.ceil(ee("x",l,e,i))];case"Complex":return[s.complex(ee("real",l,e,i),ee("imag",l,e,i))];case"Cos":return[s.cos(ee("x",l,e,i))];case"Cosh":return[s.cosh(ee("x",l,e,i))];case"Elu":return[s.elu(ee("x",l,e,i))];case"Erf":return[s.erf(ee("x",l,e,i))];case"Exp":return[s.exp(ee("x",l,e,i))];case"Expm1":return[s.expm1(ee("x",l,e,i))];case"Floor":return[s.floor(ee("x",l,e,i))];case"Log":return[s.log(ee("x",l,e,i))];case"Log1p":return[s.log1p(ee("x",l,e,i))];case"Imag":return[s.imag(ee("x",l,e,i))];case"Neg":return[s.neg(ee("x",l,e,i))];case"Reciprocal":return[s.reciprocal(ee("x",l,e,i))];case"Real":return[s.real(ee("x",l,e,i))];case"Relu":return[s.relu(ee("x",l,e,i))];case"Round":return[s.round(ee("x",l,e,i))];case"Selu":return[s.selu(ee("x",l,e,i))];case"Sigmoid":return[s.sigmoid(ee("x",l,e,i))];case"Sin":return[s.sin(ee("x",l,e,i))];case"Sign":return[s.sign(ee("x",l,e,i))];case"Sinh":return[s.sinh(ee("x",l,e,i))];case"Softplus":return[s.softplus(ee("x",l,e,i))];case"Sqrt":return[s.sqrt(ee("x",l,e,i))];case"Square":return[s.square(ee("x",l,e,i))];case"Tanh":return[s.tanh(ee("x",l,e,i))];case"Tan":return[s.tan(ee("x",l,e,i))];case"ClipByValue":return[s.clipByValue(ee("x",l,e,i),ee("clipValueMin",l,e,i),ee("clipValueMax",l,e,i))];case"Relu6":return[s.relu6(ee("x",l,e,i))];case"Rsqrt":return[s.rsqrt(Zs(l.inputNames[0],e,i))];case"LeakyRelu":return[s.leakyRelu(ee("x",l,e,i),ee("alpha",l,e,i))];case"Prelu":return[s.prelu(ee("x",l,e,i),ee("alpha",l,e,i))];case"IsNan":return[s.isNaN(Zs(l.inputNames[0],e,i))];case"IsInf":return[s.isInf(Zs(l.inputNames[0],e,i))];case"IsFinite":return[s.isFinite(Zs(l.inputNames[0],e,i))];default:throw TypeError("Node type "+l.op+" is not implemented")}};function Wa(l,e,i=""){if(!(typeof l=="number"||typeof e=="number")){Te(l.length===e.length,()=>i+(" Shapes "+l+" and "+e+" must match"));for(let s=0;s<l.length;s++){const n=l[s],a=e[s];Te(n<0||a<0||n===a,()=>i+(" Shapes "+l+" and "+e+" must match"))}}}function tv(l){return!(typeof l=="number"||l.some(e=>e<0))}function vh(l,e,i){let s=$p(l,i);const n=!tv(s);if(n&&e.length===0)throw new Error("Tried to calculate elements of an empty list with non-fully-defined elementShape: "+s);if(n&&e.forEach(a=>{s=$p(a.shape,s)}),!tv(s))throw new Error("Non-fully-defined elementShape: "+s);return s}function $p(l,e){if(typeof l=="number")return e;if(typeof e=="number")return l;if(l.length!==e.length)throw new Error("Incompatible ranks during merge: "+l+" vs. "+e);const i=[];for(let s=0;s<l.length;++s){const n=l[s],a=e[s];if(n>=0&&a>=0&&n!==a)throw new Error("Incompatible shape during merge: "+l+" vs. "+e);i[s]=n>=0?n:a}return i}class fN{constructor(e,i,s,n,a,p,_){this.name=e,this.dtype=i,this.maxSize=s,this.elementShape=n,this.identicalElementShapes=a,this.dynamicSize=p,this.clearAfterRead=_,this.tensors=[],this.closed_=!1,this.idTensor=p0(0),u0(this.idTensor)}get id(){return this.idTensor.id}get closed(){return this.closed_}clearAndClose(e){this.tensors.forEach(i=>{(e==null||!e.has(i.tensor.id))&&i.tensor.dispose()}),this.tensors=[],this.closed_=!0,this.idTensor.dispose()}size(){return this.tensors.length}read(e){if(this.closed_)throw new Error("TensorArray "+this.name+" has already been closed.");if(e<0||e>=this.size())throw new Error("Tried to read from index "+e+", but array size is: "+this.size());const i=this.tensors[e];if(i.cleared)throw new Error("TensorArray "+this.name+": Could not read index "+e+" twice because it was cleared after a previous read (perhaps try setting clear_after_read = false?).");return this.clearAfterRead&&(i.cleared=!0),i.read=!0,i.tensor}readMany(e){return e.map(i=>this.read(i))}write(e,i){if(this.closed_)throw new Error("TensorArray "+this.name+" has already been closed.");if(e<0||!this.dynamicSize&&e>=this.maxSize)throw new Error("Tried to write to index "+e+", but array is not resizeable and size is: "+this.maxSize);const s=this.tensors[e]||{};if(i.dtype!==this.dtype)throw new Error("TensorArray "+this.name+": Could not write to TensorArray index "+e+`,
          because the value dtype is `+i.dtype+", but TensorArray dtype is "+this.dtype+".");if(this.size()===0&&(this.elementShape==null||this.elementShape.length===0)&&(this.elementShape=i.shape),Wa(this.elementShape,i.shape,"TensorArray "+this.name+": Could not write to TensorArray index "+e+"."),s.read)throw new Error("TensorArray "+this.name+": Could not write to TensorArray index "+e+", because it has already been read.");if(s.written)throw new Error("TensorArray "+this.name+": Could not write to TensorArray index "+e+", because it has already been written.");s.tensor=i,u0(i),s.written=!0,this.tensors[e]=s}writeMany(e,i){if(e.length!==i.length)throw new Error("TensorArray "+this.name+": could not write multiple tensors,because the index size: "+e.length+" is not the same as tensors size: "+i.length+".");e.forEach((s,n)=>this.write(s,i[n]))}gather(e,i){if(i&&i!==this.dtype)throw new Error("TensorArray dtype is "+this.dtype+" but gather requested dtype "+i);if(e)e=e.slice(0,this.size());else{e=[];for(let n=0;n<this.size();n++)e.push(n)}if(e.length===0)return J0([],[0].concat(this.elementShape));const s=this.readMany(e);return Wa(this.elementShape,s[0].shape,"TensorArray shape mismatch: "),bh(s,0)}concat(e){if(e&&e!==this.dtype)throw new Error("TensorArray dtype is "+this.dtype+" but concat requested dtype "+e);if(this.size()===0)return J0([],[0].concat(this.elementShape));const i=[];for(let n=0;n<this.size();n++)i.push(n);const s=this.readMany(i);return Wa(this.elementShape,s[0].shape,"TensorArray shape mismatch: tensor array shape ("+this.elementShape+") vs first tensor shape ("+s[0].shape+")"),Zl(s,0)}scatter(e,i){if(i.dtype!==this.dtype)throw new Error("TensorArray dtype is "+this.dtype+" but tensor has dtype "+i.dtype);if(e.length!==i.shape[0])throw new Error("Expected len(indices) == tensor.shape[0], but saw: "+e.length+" vs. "+i.shape[0]);const s=Math.max(...e);if(!this.dynamicSize&&s>=this.maxSize)throw new Error("Max index must be < array size ("+s+"  vs. "+this.maxSize+")");this.writeMany(e,Dd(i,0))}split(e,i){if(i.dtype!==this.dtype)throw new Error("TensorArray dtype is "+this.dtype+" but tensor has dtype "+i.dtype);let s=0;const n=e.map(g=>(s+=g,s));if(s!==i.shape[0])throw new Error(`Expected sum of lengths to be equal to
          tensor.shape[0], but sum of lengths is
        `+s+", and tensor's shape is: "+i.shape);if(!this.dynamicSize&&e.length!==this.maxSize)throw new Error("TensorArray's size is not equal to the size of lengths ("+this.maxSize+" vs. "+e.length+"), and the TensorArray is not marked as dynamically resizeable");const a=s===0?0:i.size/s,p=[];zr(()=>{i=ti(i,[1,s,a]);for(let g=0;g<e.length;++g){const y=[0,g===0?0:n[g-1],0],b=[1,e[g],a];p[g]=ti(Or(i,y,b),this.elementShape)}return p});const _=[];for(let g=0;g<e.length;g++)_[g]=g;this.writeMany(_,p)}}class rl{get id(){return this.idTensor.id}constructor(e,i,s,n=-1){this.tensors=e,this.elementShape=i,this.elementDtype=s,e?.forEach(a=>{if(s!==a.dtype)throw new Error("Invalid data types; op elements "+s+", but list elements "+a.dtype);Wa(i,a.shape,"TensorList shape mismatch: "),u0(a)}),this.idTensor=p0(0),this.maxNumElements=n,u0(this.idTensor)}copy(){return new rl([...this.tensors],this.elementShape,this.elementDtype)}clearAndClose(e){this.tensors.forEach(i=>{(e==null||!e.has(i.id))&&i.dispose()}),this.tensors.length=0,this.idTensor.dispose()}size(){return this.tensors.length}stack(e,i,s=-1){if(i!==this.elementDtype)throw new Error("Invalid data types; op elements "+i+", but list elements "+this.elementDtype);if(s!==-1&&this.tensors.length!==s)throw new Error("Operation expected a list with "+s+" elements but got a list with "+this.tensors.length+" elements.");Wa(e,this.elementShape,"TensorList shape mismatch: ");const n=vh(this.elementShape,this.tensors,e);return zr(()=>{const a=this.tensors.map(p=>ti(p,n));return bh(a,0)})}popBack(e,i){if(i!==this.elementDtype)throw new Error("Invalid data types; op elements "+i+", but list elements "+this.elementDtype);if(this.size()===0)throw new Error("Trying to pop from an empty list.");const s=vh(this.elementShape,this.tensors,e),n=this.tensors.pop();return n.kept=!1,Wa(n.shape,e,"TensorList shape mismatch: "),ti(n,s)}pushBack(e){if(e.dtype!==this.elementDtype)throw new Error("Invalid data types; op elements "+e.dtype+", but list elements "+this.elementDtype);if(Wa(e.shape,this.elementShape,"TensorList shape mismatch: "),this.maxNumElements===this.size())throw new Error("Trying to push element into a full list.");u0(e),this.tensors.push(e)}resize(e){if(e<0)throw new Error("TensorListResize expects size to be non-negative. Got: "+e);if(this.maxNumElements!==-1&&e>this.maxNumElements)throw new Error("TensorListResize input size "+e+" is greater maxNumElement "+this.maxNumElements+".");const i=new rl([],this.elementShape,this.elementDtype,this.maxNumElements);i.tensors.length=e;for(let s=0;s<Math.min(this.tensors.length,e);++s)i.tensors[s]=this.tensors[s];return i}getItem(e,i,s){if(s!==this.elementDtype)throw new Error("Invalid data types; op elements "+s+", but list elements "+this.elementDtype);if(e<0||e>this.tensors.length)throw new Error("Trying to access element "+e+" in a list with "+this.tensors.length+" elements.");if(this.tensors[e]==null)throw new Error("element at index "+e+" is null.");Wa(this.tensors[e].shape,i,"TensorList shape mismatch: ");const n=vh(this.elementShape,this.tensors,i);return ti(this.tensors[e],n)}setItem(e,i){if(i.dtype!==this.elementDtype)throw new Error("Invalid data types; op elements "+i.dtype+", but list elements "+this.elementDtype);if(e<0||this.maxNumElements!==-1&&e>=this.maxNumElements)throw new Error("Trying to set element "+e+" in a list with max "+this.maxNumElements+" elements.");Wa(this.elementShape,i.shape,"TensorList shape mismatch: "),u0(i),this.tensors[e]!=null&&(this.tensors[e].kept=!1),this.tensors[e]=i}gather(e,i,s){if(i!==this.elementDtype)throw new Error("Invalid data types; op elements "+i+", but list elements "+this.elementDtype);Wa(this.elementShape,s,"TensorList shape mismatch: "),e=e.slice(0,this.size());const n=vh(this.elementShape,this.tensors,s);return e.length===0?J0([],[0].concat(n)):zr(()=>{const a=e.map(p=>ti(this.tensors[p],n));return bh(a,0)})}concat(e,i){if(e&&e!==this.elementDtype)throw new Error("TensorList dtype is "+this.elementDtype+" but concat requested dtype "+e);Wa(this.elementShape,i,"TensorList shape mismatch: ");const s=vh(this.elementShape,this.tensors,i);return this.size()===0?J0([],[0].concat(s)):zr(()=>{const n=this.tensors.map(a=>ti(a,s));return Zl(n,0)})}}function pN(l,e,i){const s=l.dtype;if(l.shape.length<1)throw new Error("Tensor must be at least a vector, but saw shape: "+l.shape);if(l.dtype!==i)throw new Error("Invalid data types; op elements "+l.dtype+", but list elements "+i);const n=l.shape.slice(1);Wa(n,e,"TensorList shape mismatch: ");const a=Dd(l);return new rl(a,e,s)}function mN(l,e,i,s){return new rl([],l,e,s)}function _N(l,e,i,s){if(e.length!==l.shape[0])throw new Error("Expected len(indices) == tensor.shape[0], but saw: "+e.length+" vs. "+l.shape[0]);const n=Math.max(...e);if(s!=null&&s!==-1&&n>=s)throw new Error("Max index must be < array size ("+n+"  vs. "+s+")");const a=new rl([],i,l.dtype,s),p=Dd(l,0);return e.forEach((_,g)=>{a.setItem(_,p[g])}),a}function gN(l,e,i){let s=0;const n=e.map(b=>(s+=b,s));if(s!==l.shape[0])throw new Error(`Expected sum of lengths to be equal to
          tensor.shape[0], but sum of lengths is
        `+s+", and tensor's shape is: "+l.shape);const a=l.shape.slice(1),p=$p(a,i),_=s===0?0:l.size/s,g=zr(()=>{const b=[];l=ti(l,[1,s,_]);for(let v=0;v<e.length;++v){const S=[0,v===0?0:n[v-1],0],M=[1,e[v],_];b[v]=ti(Or(l,S,M),p)}return l.dispose(),b}),y=new rl([],i,l.dtype,e.length);for(let b=0;b<g.length;b++)y.setItem(b,g[b]);return y}const yN=async(l,e,i)=>{switch(l.op){case"If":case"StatelessIf":{const s=ee("thenBranch",l,e,i),n=ee("elseBranch",l,e,i),a=ee("cond",l,e,i),p=ee("args",l,e,i);return(await a.data())[0]?i.functionMap[s].executeFunctionAsync(p,i.tensorArrayMap,i.tensorListMap):i.functionMap[n].executeFunctionAsync(p,i.tensorArrayMap,i.tensorListMap)}case"While":case"StatelessWhile":{const s=ee("body",l,e,i),n=ee("cond",l,e,i),a=ee("args",l,e,i),p=await i.functionMap[n].executeFunctionAsync(a,i.tensorArrayMap,i.tensorListMap),_=a.map(b=>b.id);let g=await p[0].data();p.forEach(b=>{!b.kept&&_.indexOf(b.id)===-1&&b.dispose()});let y=a;for(;g[0];){const b=y;y=await i.functionMap[s].executeFunctionAsync(y,i.tensorArrayMap,i.tensorListMap);const v=y.map(M=>M.id);b.forEach(M=>{!M.kept&&_.indexOf(M.id)===-1&&v.indexOf(M.id)===-1&&M.dispose()});const S=await i.functionMap[n].executeFunctionAsync(y,i.tensorArrayMap,i.tensorListMap);g=await S[0].data(),S.forEach(M=>{!M.kept&&_.indexOf(M.id)===-1&&v.indexOf(M.id)===-1&&M.dispose()})}return y}case"LoopCond":{const s=ee("pred",l,e,i);return[_0(s)]}case"Switch":{const s=ee("pred",l,e,i);let n=ee("data",l,e,i);return n.kept||(n=_0(n)),(await s.data())[0]?[void 0,n]:[n,void 0]}case"Merge":{const s=l.inputNames.find(n=>Zs(n,e,i)!==void 0);if(s){const n=Zs(s,e,i);return[_0(n)]}return}case"Enter":{const s=ee("frameName",l,e,i),n=ee("tensor",l,e,i);return i.enterFrame(s),[_0(n)]}case"Exit":{const s=ee("tensor",l,e,i);return i.exitFrame(),[_0(s)]}case"NextIteration":{const s=ee("tensor",l,e,i);return i.nextIteration(),[_0(s)]}case"TensorArrayV3":{const s=ee("size",l,e,i),n=ee("dtype",l,e,i),a=ee("elementShape",l,e,i),p=ee("dynamicSize",l,e,i),_=ee("clearAfterRead",l,e,i),g=ee("identicalElementShapes",l,e,i),y=ee("name",l,e,i),b=new fN(y,n,s,a,g,p,_);return i.addTensorArray(b),[b.idTensor,p0(1)]}case"TensorArrayWriteV3":{const s=ee("tensorArrayId",l,e,i),n=ee("index",l,e,i),a=ee("tensor",l,e,i),p=i.getTensorArray(s.id);return p.write(n,a),[p.idTensor]}case"TensorArrayReadV3":{const s=ee("tensorArrayId",l,e,i),n=ee("index",l,e,i);return[i.getTensorArray(s.id).read(n)]}case"TensorArrayGatherV3":{const s=ee("tensorArrayId",l,e,i),n=ee("indices",l,e,i),a=ee("dtype",l,e,i);return[i.getTensorArray(s.id).gather(n,a)]}case"TensorArrayScatterV3":{const s=ee("tensorArrayId",l,e,i),n=ee("indices",l,e,i),a=ee("tensor",l,e,i),p=i.getTensorArray(s.id);return p.scatter(n,a),[p.idTensor]}case"TensorArrayConcatV3":{const s=ee("tensorArrayId",l,e,i),n=i.getTensorArray(s.id),a=ee("dtype",l,e,i);return[n.concat(a)]}case"TensorArraySplitV3":{const s=ee("tensorArrayId",l,e,i),n=ee("tensor",l,e,i),a=ee("lengths",l,e,i),p=i.getTensorArray(s.id);return p.split(a,n),[p.idTensor]}case"TensorArraySizeV3":{const s=ee("tensorArrayId",l,e,i),n=i.getTensorArray(s.id);return[p0(n.size(),"int32")]}case"TensorArrayCloseV3":{const s=ee("tensorArrayId",l,e,i),n=i.getTensorArray(s.id);return n.clearAndClose(),[n.idTensor]}case"TensorListSetItem":{const s=ee("tensorListId",l,e,i),n=ee("index",l,e,i),a=ee("tensor",l,e,i),p=i.getTensorList(s.id);return p.setItem(n,a),[p.idTensor]}case"TensorListGetItem":{const s=ee("tensorListId",l,e,i),n=ee("index",l,e,i),a=ee("elementShape",l,e,i),p=ee("elementDType",l,e,i);return[i.getTensorList(s.id).getItem(n,a,p)]}case"TensorListScatterV2":case"TensorListScatter":{const s=ee("indices",l,e,i),n=ee("tensor",l,e,i),a=ee("elementShape",l,e,i),p=ee("numElements",l,e,i),_=_N(n,s,a,p);return i.addTensorList(_),[_.idTensor]}case"TensorListReserve":case"EmptyTensorList":{const s=ee("elementShape",l,e,i),n=ee("elementDType",l,e,i);let a;l.op==="TensorListReserve"?a="numElements":a="maxNumElements";const p=ee(a,l,e,i),_=l.op==="TensorListReserve"?-1:p,g=mN(s,n,p,_);return i.addTensorList(g),[g.idTensor]}case"TensorListGather":{const s=ee("tensorListId",l,e,i),n=ee("indices",l,e,i),a=ee("elementShape",l,e,i),p=ee("elementDType",l,e,i);return[i.getTensorList(s.id).gather(n,p,a)]}case"TensorListStack":{const s=ee("tensorListId",l,e,i),n=ee("elementShape",l,e,i),a=ee("elementDType",l,e,i),p=ee("numElements",l,e,i);return[i.getTensorList(s.id).stack(n,a,p)]}case"TensorListFromTensor":{const s=ee("tensor",l,e,i),n=ee("elementShape",l,e,i),a=ee("elementDType",l,e,i),p=pN(s,n,a);return i.addTensorList(p),[p.idTensor]}case"TensorListConcat":case"TensorListConcatV2":{const s=ee("tensorListId",l,e,i),n=i.getTensorList(s.id),a=ee("dtype",l,e,i),p=ee("elementShape",l,e,i);return[n.concat(a,p)]}case"TensorListPushBack":{const s=ee("tensorListId",l,e,i),n=ee("tensor",l,e,i),a=i.getTensorList(s.id);return a.pushBack(n),[a.idTensor]}case"TensorListPopBack":{const s=ee("tensorListId",l,e,i),n=ee("elementShape",l,e,i),a=ee("elementDType",l,e,i);return[i.getTensorList(s.id).popBack(n,a)]}case"TensorListSplit":{const s=ee("tensor",l,e,i),n=ee("elementShape",l,e,i),a=ee("lengths",l,e,i),p=gN(s,a,n);return i.addTensorList(p),[p.idTensor]}case"TensorListLength":{const s=ee("tensorListId",l,e,i),n=i.getTensorList(s.id);return[p0(n.size(),"int32")]}case"TensorListResize":{const s=ee("tensorListId",l,e,i),n=ee("size",l,e,i),a=i.getTensorList(s.id).resize(n);return i.addTensorList(a),[a.idTensor]}default:throw TypeError("Node type "+l.op+" is not implemented")}};function iv(l,e,i){const[s,n]=ee("fusedOps",l,e,i),a=s==="biasadd",p=!a,_=n==="prelu",g=s==="fusedbatchnorm",y=ee("numArgs",l,e,i);if(a){if(_&&y!==2)throw new Error("FusedConv2d and DepthwiseConv2d with BiasAdd and Prelu must have two extra arguments: bias and alpha.");if(!_&&a&&y!==1)throw new Error("FusedConv2d and DepthwiseConv2d with BiasAdd must have one extra argument: bias.")}if(g)throw new Error("FusedConv2d and DepthwiseConv2d with FusedBatchNorm is not supported");const b=ee("strides",l,e,i),v=Ud(l,e,i),S=ee("dataFormat",l,e,i).toUpperCase(),M=ee("dilations",l,e,i);let[F,L]=ee("args",l,e,i);p&&(L=F,F=void 0);const N=ee("leakyreluAlpha",l,e,i);return{stride:b,pad:v,dataFormat:S,dilations:M,biasArg:F,preluArg:L,activationFunc:n,leakyreluAlpha:N}}const bN=(l,e,i,s=Qs)=>{switch(l.op){case"Conv1D":{const n=ee("stride",l,e,i),a=ee("pad",l,e,i),p=ee("dataFormat",l,e,i).toUpperCase(),_=ee("dilation",l,e,i);return[s.conv1d(ee("x",l,e,i),ee("filter",l,e,i),n,a,p,_)]}case"Conv2D":{const n=ee("strides",l,e,i),a=Ud(l,e,i),p=ee("dataFormat",l,e,i).toUpperCase(),_=ee("dilations",l,e,i);return[s.conv2d(ee("x",l,e,i),ee("filter",l,e,i),[n[1],n[2]],a,p,[_[1],_[2]])]}case"_FusedConv2D":{const{stride:n,pad:a,dataFormat:p,dilations:_,biasArg:g,preluArg:y,activationFunc:b,leakyreluAlpha:v}=iv(l,e,i),S=l.name.endsWith("batch_normalization_88/FusedBatchNormV3")||l.name.endsWith("batch_normalization_90/FusedBatchNormV3")?Ue().get("WEBGL_USE_SHAPES_UNIFORMS"):void 0;S!==void 0&&Ue().set("WEBGL_USE_SHAPES_UNIFORMS",!1);const M=s.fused.conv2d({x:ee("x",l,e,i),filter:ee("filter",l,e,i),strides:[n[1],n[2]],pad:a,dataFormat:p,dilations:[_[1],_[2]],bias:g,activation:b,preluActivationWeights:y,leakyreluAlpha:v});return S!==void 0&&Ue().set("WEBGL_USE_SHAPES_UNIFORMS",S),[M]}case"FusedDepthwiseConv2dNative":{const{stride:n,pad:a,dataFormat:p,dilations:_,biasArg:g,preluArg:y,activationFunc:b,leakyreluAlpha:v}=iv(l,e,i);return[s.fused.depthwiseConv2d({x:ee("x",l,e,i),filter:ee("filter",l,e,i),strides:[n[1],n[2]],pad:a,dataFormat:p,dilations:[_[1],_[2]],bias:g,activation:b,preluActivationWeights:y,leakyreluAlpha:v})]}case"Conv2DBackpropInput":case"Conv2dTranspose":{const n=ee("outputShape",l,e,i),a=ee("strides",l,e,i),p=Ud(l,e,i);return[s.conv2dTranspose(ee("x",l,e,i),ee("filter",l,e,i),n,[a[1],a[2]],p)]}case"DepthwiseConv2dNative":case"DepthwiseConv2d":{const n=ee("strides",l,e,i),a=Ud(l,e,i),p=ee("dilations",l,e,i),_=ee("dataFormat",l,e,i).toUpperCase();return[s.depthwiseConv2d(ee("input",l,e,i),ee("filter",l,e,i),[n[1],n[2]],a,_,[p[1],p[2]])]}case"Conv3D":{const n=ee("strides",l,e,i),a=ee("pad",l,e,i),p=ee("dataFormat",l,e,i).toUpperCase(),_=ee("dilations",l,e,i);return[s.conv3d(ee("x",l,e,i),ee("filter",l,e,i),[n[1],n[2],n[3]],a,p,[_[1],_[2],_[3]])]}case"AvgPool":{const n=ee("strides",l,e,i),a=ee("pad",l,e,i),p=ee("kernelSize",l,e,i);return[s.avgPool(ee("x",l,e,i),[p[1],p[2]],[n[1],n[2]],a)]}case"MaxPool":{const n=ee("strides",l,e,i),a=ee("pad",l,e,i),p=ee("kernelSize",l,e,i);return[s.maxPool(ee("x",l,e,i),[p[1],p[2]],[n[1],n[2]],a)]}case"MaxPoolWithArgmax":{const n=ee("strides",l,e,i),a=ee("pad",l,e,i),p=ee("kernelSize",l,e,i),_=ee("includeBatchInIndex",l,e,i),{result:g,indexes:y}=s.maxPoolWithArgmax(ee("x",l,e,i),[p[1],p[2]],[n[1],n[2]],a,_);return[g,y]}case"AvgPool3D":{const n=ee("strides",l,e,i),a=ee("pad",l,e,i),p=ee("kernelSize",l,e,i);return[s.avgPool3d(ee("x",l,e,i),[p[1],p[2],p[3]],[n[1],n[2],n[3]],a)]}case"MaxPool3D":{const n=ee("strides",l,e,i),a=ee("pad",l,e,i),p=ee("kernelSize",l,e,i);return[s.maxPool3d(ee("x",l,e,i),[p[1],p[2],p[3]],[n[1],n[2],n[3]],a)]}case"Dilation2D":{const n=ee("strides",l,e,i),a=ee("pad",l,e,i),p=ee("dilations",l,e,i),_=n[1],g=n[2],y=p[1],b=p[2];return[s.dilation2d(ee("x",l,e,i),ee("filter",l,e,i),[_,g],a,[y,b],"NHWC")]}default:throw TypeError("Node type "+l.op+" is not implemented")}},vN=(l,e,i,s=Qs)=>{switch(l.op){case"Fill":{const n=ee("shape",l,e,i),a=ee("dtype",l,e,i),p=ee("value",l,e,i);return[s.fill(n,p,a)]}case"LinSpace":{const n=ee("start",l,e,i),a=ee("stop",l,e,i),p=ee("num",l,e,i);return[s.linspace(n,a,p)]}case"Multinomial":{const n=ee("logits",l,e,i),a=ee("numSamples",l,e,i),p=ee("seed",l,e,i);return[s.multinomial(n,a,p)]}case"OneHot":{const n=ee("indices",l,e,i),a=ee("depth",l,e,i),p=ee("onValue",l,e,i),_=ee("offValue",l,e,i),g=ee("dtype",l,e,i);return[s.oneHot(n,a,p,_,g)]}case"Ones":return[s.ones(ee("shape",l,e,i),ee("dtype",l,e,i))];case"OnesLike":return[s.onesLike(ee("x",l,e,i))];case"RandomStandardNormal":return[s.randomStandardNormal(ee("shape",l,e,i),ee("dtype",l,e,i),ee("seed",l,e,i))];case"RandomUniform":return[s.randomUniform(ee("shape",l,e,i),ee("minval",l,e,i),ee("maxval",l,e,i),ee("dtype",l,e,i))];case"RandomUniformInt":return[s.randomUniformInt(ee("shape",l,e,i),ee("minval",l,e,i),ee("maxval",l,e,i),ee("seed",l,e,i))];case"Range":{const n=ee("start",l,e,i),a=ee("stop",l,e,i),p=ee("step",l,e,i);return[s.range(n,a,p,ee("dtype",l,e,i))]}case"TruncatedNormal":{const n=ee("shape",l,e,i),a=ee("mean",l,e,i),p=ee("stdDev",l,e,i),_=ee("seed",l,e,i);return[s.truncatedNormal(n,a,p,ee("dtype",l,e,i),_)]}case"Zeros":return[s.zeros(ee("shape",l,e,i),ee("dtype",l,e,i))];case"ZerosLike":return[s.zerosLike(ee("x",l,e,i))];default:throw TypeError("Node type "+l.op+" is not implemented")}};function Jp(l,e,i){const s=ee("boxes",l,e,i),n=ee("scores",l,e,i),a=ee("maxOutputSize",l,e,i),p=ee("iouThreshold",l,e,i),_=ee("scoreThreshold",l,e,i),g=ee("softNmsSigma",l,e,i);return{boxes:s,scores:n,maxOutputSize:a,iouThreshold:p,scoreThreshold:_,softNmsSigma:g}}const TN=async(l,e,i,s,n=Qs)=>{switch(l.op){case"NonMaxSuppressionV5":{const{boxes:a,scores:p,maxOutputSize:_,iouThreshold:g,scoreThreshold:y,softNmsSigma:b}=Jp(l,e,i),v=await n.image.nonMaxSuppressionWithScoreAsync(a,p,_,g,y,b);return[v.selectedIndices,v.selectedScores]}case"NonMaxSuppressionV4":{const{boxes:a,scores:p,maxOutputSize:_,iouThreshold:g,scoreThreshold:y}=Jp(l,e,i),b=ee("padToMaxOutputSize",l,e,i),v=await n.image.nonMaxSuppressionPaddedAsync(a,p,_,g,y,b);return[v.selectedIndices,v.validOutputs]}case"NonMaxSuppressionV3":case"NonMaxSuppressionV2":{const{boxes:a,scores:p,maxOutputSize:_,iouThreshold:g,scoreThreshold:y}=Jp(l,e,i);return[await n.image.nonMaxSuppressionAsync(a,p,_,g,y)]}case"Where":{const a=n.cast(ee("condition",l,e,i),"bool"),p=[await n.whereAsync(a)];return a.dispose(),p}case"ListDiff":return n.setdiff1dAsync(ee("x",l,e,i),ee("y",l,e,i));default:throw TypeError("Node type "+l.op+" is not implemented")}},EN=(l,e,i,s=Qs)=>{switch(l.op){case"LowerBound":{const n=ee("sortedSequence",l,e,i),a=ee("values",l,e,i);return[s.lowerBound(n,a)]}case"TopKV2":{const n=ee("x",l,e,i),a=ee("k",l,e,i),p=ee("sorted",l,e,i),_=s.topk(n,a,p);return[_.values,_.indices]}case"UpperBound":{const n=ee("sortedSequence",l,e,i),a=ee("values",l,e,i);return[s.upperBound(n,a)]}case"Unique":{const n=ee("x",l,e,i),a=s.unique(n);return[a.values,a.indices]}case"UniqueV2":{const n=ee("x",l,e,i),a=ee("axis",l,e,i),p=s.unique(n,a);return[p.values,p.indices]}default:throw TypeError("Node type "+l.op+" is not implemented")}},AN=(l,e,i,s=Qs)=>{switch(l.op){case"Const":return e[l.name];case"PlaceholderWithDefault":const n=ee("default",l,e,i);return[Zs(l.name,e,i)||n];case"Placeholder":return[Zs(l.name,e,i)];case"Identity":case"StopGradient":case"FakeQuantWithMinMaxVars":{const b=ee("x",l,e,i);return[_0(b)]}case"IdentityN":return ee("x",l,e,i).map(b=>_0(b));case"Snapshot":const a=ee("x",l,e,i);return[_0(a)];case"Shape":return[s.tensor1d(ee("x",l,e,i).shape,"int32")];case"ShapeN":return ee("x",l,e,i).map(b=>s.tensor1d(b.shape));case"Size":return[s.scalar(ee("x",l,e,i).size,"int32")];case"Rank":return[s.scalar(ee("x",l,e,i).rank,"int32")];case"NoOp":return[s.scalar(1)];case"Print":const p=ee("x",l,e,i),_=ee("data",l,e,i),g=ee("message",l,e,i),y=ee("summarize",l,e,i);console.warn("The graph has a tf.print() operation,usually used for debugging, which slows down performance."),console.log(g);for(let b=0;b<_.length;b++)console.log(Array.prototype.slice.call(_[b].dataSync()).slice(0,y));return[p];default:throw TypeError("Node type "+l.op+" is not implemented")}};class CN{get id(){return this.handle.id}constructor(e,i){this.keyDType=e,this.valueDType=i,this.handle=p0(0),this.tensorMap=new Map,u0(this.handle)}clearAndClose(){this.tensorMap.forEach(e=>e.dispose()),this.tensorMap.clear(),this.handle.dispose()}size(){return this.tensorMap.size}tensorSize(){return(void 0)(this.size(),"int32")}async import(e,i){this.checkKeyAndValueTensor(e,i);const s=await e.data();return this.tensorMap.forEach(n=>n.dispose()),this.tensorMap.clear(),zr(()=>{const n=Dd(i),a=s.length,p=n.length;Te(a===p,()=>"The number of elements doesn't match, keys has "+a+" elements, the values has "+p+" elements.");for(let _=0;_<a;_++){const g=s[_],y=n[_];u0(y),this.tensorMap.set(g,y)}return this.handle})}async find(e,i){this.checkKeyAndValueTensor(e,i);const s=await e.data();return zr(()=>{const n=[];for(let a=0;a<s.length;a++){const p=s[a],_=this.findWithDefault(p,i);n.push(_)}return bh(n)})}findWithDefault(e,i){const s=this.tensorMap.get(e);return s??i}checkKeyAndValueTensor(e,i){if(e.dtype!==this.keyDType)throw new Error("Expect key dtype "+this.keyDType+", but got "+e.dtype);if(i.dtype!==this.valueDType)throw new Error("Expect value dtype "+this.valueDType+", but got "+i.dtype)}}const RN=async(l,e,i,s)=>{switch(l.op){case"HashTable":case"HashTableV2":{const n=s.getHashTableHandleByName(l.name);if(n!=null)return[n];{const a=ee("keyDType",l,e,i),p=ee("valueDType",l,e,i),_=new CN(a,p);return s.addHashTable(l.name,_),[_.handle]}}case"InitializeTable":case"InitializeTableV2":case"LookupTableImport":case"LookupTableImportV2":{const n=ee("tableHandle",l,e,i,s),a=ee("keys",l,e,i),p=ee("values",l,e,i);return[await s.getHashTableById(n.id).import(a,p)]}case"LookupTableFind":case"LookupTableFindV2":{const n=ee("tableHandle",l,e,i,s),a=ee("keys",l,e,i),p=ee("defaultValue",l,e,i);return[await s.getHashTableById(n.id).find(a,p)]}case"LookupTableSize":case"LookupTableSizeV2":{const n=ee("tableHandle",l,e,i,s);return[s.getHashTableById(n.id).tensorSize()]}default:throw TypeError("Node type "+l.op+" is not implemented")}},IN=(l,e,i,s=Qs)=>{switch(l.op){case"ResizeBilinear":{const n=ee("images",l,e,i),a=ee("size",l,e,i),p=ee("alignCorners",l,e,i),_=ee("halfPixelCenters",l,e,i);return[s.image.resizeBilinear(n,[a[0],a[1]],p,_)]}case"ResizeNearestNeighbor":{const n=ee("images",l,e,i),a=ee("size",l,e,i),p=ee("alignCorners",l,e,i),_=ee("halfPixelCenters",l,e,i);return[s.image.resizeNearestNeighbor(n,[a[0],a[1]],p,_)]}case"CropAndResize":{const n=ee("image",l,e,i),a=ee("boxes",l,e,i),p=ee("boxInd",l,e,i),_=ee("cropSize",l,e,i),g=ee("method",l,e,i),y=ee("extrapolationValue",l,e,i);return[s.image.cropAndResize(n,a,p,_,g,y)]}case"ImageProjectiveTransformV3":{const n=ee("images",l,e,i),a=ee("transforms",l,e,i),p=ee("outputShape",l,e,i),_=ee("fillValue",l,e,i),g=ee("interpolation",l,e,i),y=ee("fillMode",l,e,i);return[s.image.transform(n,a,g.toLowerCase(),y.toLowerCase(),_,p)]}default:throw TypeError("Node type "+l.op+" is not implemented")}},SN=(l,e,i,s=Qs)=>{switch(l.op){case"Equal":return[s.equal(ee("a",l,e,i),ee("b",l,e,i))];case"NotEqual":return[s.notEqual(ee("a",l,e,i),ee("b",l,e,i))];case"Greater":return[s.greater(ee("a",l,e,i),ee("b",l,e,i))];case"GreaterEqual":return[s.greaterEqual(ee("a",l,e,i),ee("b",l,e,i))];case"Less":return[s.less(ee("a",l,e,i),ee("b",l,e,i))];case"LessEqual":return[s.lessEqual(ee("a",l,e,i),ee("b",l,e,i))];case"LogicalAnd":return[s.logicalAnd(ee("a",l,e,i),ee("b",l,e,i))];case"LogicalNot":return[s.logicalNot(ee("a",l,e,i))];case"LogicalOr":return[s.logicalOr(ee("a",l,e,i),ee("b",l,e,i))];case"Select":case"SelectV2":return[s.where(ee("condition",l,e,i),ee("a",l,e,i),ee("b",l,e,i))];case"BitwiseAnd":return[s.bitwiseAnd(ee("a",l,e,i),ee("b",l,e,i))];default:throw TypeError("Node type "+l.op+" is not implemented")}},MN=(l,e,i,s=Qs)=>{switch(l.op){case"BatchMatMul":case"BatchMatMulV2":case"MatMul":return[s.matMul(ee("a",l,e,i),ee("b",l,e,i),ee("transposeA",l,e,i),ee("transposeB",l,e,i))];case"Einsum":return[s.einsum(ee("equation",l,e,i),...ee("tensors",l,e,i))];case"Transpose":return[s.transpose(ee("x",l,e,i),ee("perm",l,e,i))];case"_FusedMatMul":const[n,a]=ee("fusedOps",l,e,i),p=n==="biasadd",_=a==="prelu",g=ee("numArgs",l,e,i),y=ee("leakyreluAlpha",l,e,i);if(p){if(_&&g!==2)throw new Error("Fused MatMul with BiasAdd and Prelu must have two extra arguments: bias and alpha.");if(!_&&g!==1)throw new Error("Fused MatMul with BiasAdd must have one extra argument: bias.")}const[b,v]=ee("args",l,e,i);return[s.fused.matMul({a:ee("a",l,e,i),b:ee("b",l,e,i),transposeA:ee("transposeA",l,e,i),transposeB:ee("transposeB",l,e,i),bias:b,activation:a,preluActivationWeights:v,leakyreluAlpha:y})];case"MatrixBandPart":return[s.linalg.bandPart(ee("a",l,e,i),ee("numLower",l,e,i),ee("numUpper",l,e,i))];default:throw TypeError("Node type "+l.op+" is not implemented")}},PN=(l,e,i,s=Qs)=>{switch(l.op){case"EuclideanNorm":return[s.euclideanNorm(ee("x",l,e,i),ee("axis",l,e,i),ee("keepDims",l,e,i))];case"FusedBatchNorm":case"FusedBatchNormV2":return[s.batchNorm(ee("x",l,e,i),ee("mean",l,e,i),ee("variance",l,e,i),ee("offset",l,e,i),ee("scale",l,e,i),ee("epsilon",l,e,i))];case"FusedBatchNormV3":return[s.batchNorm(ee("x",l,e,i),ee("mean",l,e,i),ee("variance",l,e,i),ee("offset",l,e,i),ee("scale",l,e,i),ee("epsilon",l,e,i))];case"LRN":return[s.localResponseNormalization(ee("x",l,e,i),ee("radius",l,e,i),ee("bias",l,e,i),ee("alpha",l,e,i),ee("beta",l,e,i))];case"Softmax":return[s.softmax(ee("x",l,e,i))];case"LogSoftmax":return[s.logSoftmax(ee("x",l,e,i))];default:throw TypeError("Node type "+l.op+" is not implemented")}},ON=(l,e,i,s=Qs)=>{switch(l.op){case"RaggedGather":{const{outputNestedSplits:n,outputDenseValues:a}=s.raggedGather(ee("paramsNestedSplits",l,e,i),ee("paramsDenseValues",l,e,i),ee("indices",l,e,i),ee("outputRaggedRank",l,e,i));return n.concat(a)}case"RaggedRange":{const{rtNestedSplits:n,rtDenseValues:a}=s.raggedRange(ee("starts",l,e,i),ee("limits",l,e,i),ee("splits",l,e,i));return[n,a]}case"RaggedTensorToTensor":return[s.raggedTensorToTensor(ee("shape",l,e,i),ee("values",l,e,i),ee("defaultValue",l,e,i),ee("rowPartitionTensors",l,e,i),ee("rowPartitionTypes",l,e,i))];default:throw TypeError("Node type "+l.op+" is not implemented")}},wN=(l,e,i,s=Qs)=>{switch(l.op){case"Max":{const _=ee("axis",l,e,i),g=ee("keepDims",l,e,i);return[s.max(ee("x",l,e,i),_,g)]}case"Mean":{const _=ee("axis",l,e,i),g=ee("keepDims",l,e,i);return[s.mean(ee("x",l,e,i),_,g)]}case"Min":{const _=ee("axis",l,e,i),g=ee("keepDims",l,e,i);return[s.min(ee("x",l,e,i),_,g)]}case"Sum":{const _=ee("axis",l,e,i),g=ee("keepDims",l,e,i);return[s.sum(ee("x",l,e,i),_,g)]}case"All":{const _=ee("axis",l,e,i),g=ee("keepDims",l,e,i);return[s.all(ee("x",l,e,i),_,g)]}case"Any":{const _=ee("axis",l,e,i),g=ee("keepDims",l,e,i);return[s.any(ee("x",l,e,i),_,g)]}case"ArgMax":{const _=ee("axis",l,e,i);return[s.argMax(ee("x",l,e,i),_)]}case"ArgMin":{const _=ee("axis",l,e,i);return[s.argMin(ee("x",l,e,i),_)]}case"Prod":{const _=ee("axis",l,e,i),g=ee("keepDims",l,e,i);return[s.prod(ee("x",l,e,i),_,g)]}case"Cumprod":{const _=ee("axis",l,e,i),g=ee("exclusive",l,e,i),y=ee("reverse",l,e,i);return[s.cumprod(ee("x",l,e,i),_,g,y)]}case"Cumsum":{const _=ee("axis",l,e,i),g=ee("exclusive",l,e,i),y=ee("reverse",l,e,i);return[s.cumsum(ee("x",l,e,i),_,g,y)]}case"Bincount":const n=ee("x",l,e,i),a=ee("weights",l,e,i),p=ee("size",l,e,i);return[s.bincount(n,a,p)];case"DenseBincount":{const _=ee("x",l,e,i),g=ee("weights",l,e,i),y=ee("size",l,e,i),b=ee("binaryOutput",l,e,i);return[s.denseBincount(_,g,y,b)]}default:throw TypeError("Node type "+l.op+" is not implemented")}},DN=(l,e,i,s=Qs)=>{switch(l.op){case"ConcatV2":case"Concat":{const n=ee("n",l,e,i),a=ee("axis",l,e,i);let p=ee("tensors",l,e,i);return p=p.slice(0,n),[s.concat(p,a)]}case"Gather":{const n=ee("x",l,e,i),a=ee("indices",l,e,i);return[s.gather(n,s.cast(a,"int32"),0)]}case"GatherV2":{const n=ee("axis",l,e,i),a=ee("batchDims",l,e,i),p=ee("x",l,e,i),_=ee("indices",l,e,i);return[s.gather(p,s.cast(_,"int32"),n,a)]}case"Reverse":{const n=ee("dims",l,e,i),a=[];for(let _=0;_<n.length;_++)n[_]&&a.push(_);const p=ee("x",l,e,i);return[s.reverse(p,a)]}case"ReverseV2":{const n=ee("axis",l,e,i),a=ee("x",l,e,i);return[s.reverse(a,n)]}case"Slice":{const n=ee("begin",l,e,i),a=ee("size",l,e,i);return[s.slice(ee("x",l,e,i),n,a)]}case"StridedSlice":{const n=ee("begin",l,e,i),a=ee("end",l,e,i),p=ee("strides",l,e,i),_=ee("beginMask",l,e,i),g=ee("endMask",l,e,i),y=ee("ellipsisMask",l,e,i),b=ee("newAxisMask",l,e,i),v=ee("shrinkAxisMask",l,e,i),S=ee("x",l,e,i);return[s.stridedSlice(S,n,a,p,_,g,y,b,v)]}case"Pack":return zr(()=>{const n=ee("axis",l,e,i),a=ee("tensors",l,e,i),p=a[0].shape,_=s.squeeze(a[0]).shape,g=a.map(y=>{const b=qt(y.shape,p);if(!b&&!qt(s.squeeze(y).shape,_))throw new Error("the input tensors shape does not match");return b?y:s.reshape(y,p)});return[s.stack(g,n)]});case"Unpack":{const n=ee("axis",l,e,i),a=ee("tensor",l,e,i);return s.unstack(a,n)}case"Tile":{const n=ee("reps",l,e,i);return[s.tile(ee("x",l,e,i),n)]}case"Split":case"SplitV":{const n=ee("axis",l,e,i),a=ee("numOrSizeSplits",l,e,i),p=ee("x",l,e,i);return s.split(p,a,n)}case"ScatterNd":{const n=ee("indices",l,e,i),a=ee("values",l,e,i),p=ee("shape",l,e,i);return[s.scatterND(n,a,p)]}case"GatherNd":{const n=ee("x",l,e,i),a=ee("indices",l,e,i);return[s.gatherND(n,a)]}case"SparseToDense":{const n=ee("sparseIndices",l,e,i),a=ee("outputShape",l,e,i),p=ee("sparseValues",l,e,i),_=ee("defaultValue",l,e,i);return[s.sparseToDense(n,p,a,p.dtype===_.dtype?_:s.cast(_,p.dtype))]}case"TensorScatterUpdate":{const n=ee("indices",l,e,i),a=ee("values",l,e,i),p=ee("tensor",l,e,i);return[s.tensorScatterUpdate(p,n,a)]}default:throw TypeError("Node type "+l.op+" is not implemented")}},FN=(l,e,i,s=Qs)=>{switch(l.op){case"SparseFillEmptyRows":{const{outputIndices:n,outputValues:a,emptyRowIndicator:p,reverseIndexMap:_}=s.sparse.sparseFillEmptyRows(ee("indices",l,e,i),ee("values",l,e,i),ee("denseShape",l,e,i),ee("defaultValue",l,e,i));return[n,a,p,_]}case"SparseReshape":{const{outputIndices:n,outputShape:a}=s.sparse.sparseReshape(ee("inputIndices",l,e,i),ee("inputShape",l,e,i),ee("newShape",l,e,i));return[n,a]}case"SparseSegmentMean":return[s.sparse.sparseSegmentMean(ee("data",l,e,i),ee("indices",l,e,i),ee("segmentIds",l,e,i))];case"SparseSegmentSum":return[s.sparse.sparseSegmentSum(ee("data",l,e,i),ee("indices",l,e,i),ee("segmentIds",l,e,i))];default:throw TypeError("Node type "+l.op+" is not implemented")}},LN=(l,e,i,s=Qs)=>{switch(l.op){case"FFT":return[s.fft(ee("x",l,e,i))];case"IFFT":return[s.ifft(ee("x",l,e,i))];case"RFFT":return[s.rfft(ee("x",l,e,i))];case"IRFFT":return[s.irfft(ee("x",l,e,i))];default:throw TypeError("Node type "+l.op+" is not implemented")}},NN=(l,e,i,s=Qs)=>{switch(l.op){case"StaticRegexReplace":return[s.string.staticRegexReplace(ee("input",l,e,i),ee("pattern",l,e,i),ee("rewrite",l,e,i),ee("replaceGlobal",l,e,i))];case"StringNGrams":{const{nGrams:n,nGramsSplits:a}=s.string.stringNGrams(ee("data",l,e,i),ee("dataSplits",l,e,i),ee("separator",l,e,i),ee("nGramWidths",l,e,i),ee("leftPad",l,e,i),ee("rightPad",l,e,i),ee("padWidth",l,e,i),ee("preserveShortSequences",l,e,i));return[n,a]}case"StringSplit":{const{indices:n,values:a,shape:p}=s.string.stringSplit(ee("input",l,e,i),ee("delimiter",l,e,i),ee("skipEmpty",l,e,i));return[n,a,p]}case"StringToHashBucketFast":return[s.string.stringToHashBucketFast(ee("input",l,e,i),ee("numBuckets",l,e,i))];default:throw TypeError("Node type "+l.op+" is not implemented")}},BN=(l,e,i,s=Qs)=>{switch(l.op){case"Cast":return[s.cast(ee("x",l,e,i),ee("dtype",l,e,i))];case"ExpandDims":{const n=ee("axis",l,e,i);return[s.expandDims(ee("x",l,e,i),n)]}case"Squeeze":{const n=ee("axis",l,e,i);return[s.squeeze(ee("x",l,e,i),n)]}case"Reshape":return[s.reshape(ee("x",l,e,i),ee("shape",l,e,i))];case"EnsureShape":return[s.ensureShape(ee("x",l,e,i),ee("shape",l,e,i))];case"MirrorPad":return[s.mirrorPad(ee("x",l,e,i),ee("padding",l,e,i),ee("mode",l,e,i))];case"PadV2":case"Pad":return[s.pad(ee("x",l,e,i),ee("padding",l,e,i),ee("constantValue",l,e,i))];case"SpaceToBatchND":{const n=ee("blockShape",l,e,i),a=ee("paddings",l,e,i);return[s.spaceToBatchND(ee("x",l,e,i),n,a)]}case"BatchToSpaceND":{const n=ee("blockShape",l,e,i),a=ee("crops",l,e,i);return[s.batchToSpaceND(ee("x",l,e,i),n,a)]}case"DepthToSpace":{const n=ee("blockSize",l,e,i),a=ee("dataFormat",l,e,i).toUpperCase();return[s.depthToSpace(ee("x",l,e,i),n,a)]}case"BroadcastTo":return[s.broadcastTo(ee("x",l,e,i),ee("shape",l,e,i))];case"BroadcastArgs":return[s.broadcastArgs(ee("s0",l,e,i),ee("s1",l,e,i))];default:throw TypeError("Node type "+l.op+" is not implemented")}};function rv(l,e,i,s,n=zr){const a=((p,_,g)=>{switch(p.category){case"arithmetic":return n(()=>uN(p,_,g));case"basic_math":return n(()=>dN(p,_,g));case"control":return yN(p,_,g);case"convolution":return n(()=>bN(p,_,g));case"creation":return n(()=>vN(p,_,g));case"dynamic":return TN(p,_,g);case"evaluation":return n(()=>EN(p,_,g));case"image":return n(()=>IN(p,_,g));case"graph":return n(()=>AN(p,_,g));case"logical":return n(()=>SN(p,_,g));case"matrices":return n(()=>MN(p,_,g));case"normalization":return n(()=>PN(p,_,g));case"ragged":return n(()=>ON(p,_,g));case"reduction":return n(()=>wN(p,_,g));case"slice_join":return n(()=>DN(p,_,g));case"sparse":return n(()=>FN(p,_,g));case"spectral":return n(()=>LN(p,_,g));case"string":return n(()=>NN(p,_,g));case"transformation":return n(()=>BN(p,_,g));case"hash_table":return RN(p,_,g,s);case"custom":const y=qb(p.op);if(y&&y.customExecutor)return y.customExecutor(new hN(p,_,g));throw TypeError("Custom op "+p.op+" is not registered.");default:throw TypeError("Unknown op '"+p.op+"'. File an issue at https://github.com/tensorflow/tfjs/issues so we can add it, or register a custom execution with tf.registerOp()")}})(l,e,i);return Wi(a)?a.then(p=>[].concat(p)):[].concat(a)}class sv{constructor(e={},i={},s={},n={},a){this.weightMap=e,this.tensorArrayMap=i,this.tensorListMap=s,this.functionMap=n,this.parseNodeNameCache=a,this.rootContext={id:0,frameName:"",iterationId:0},this.contexts=[this.rootContext],this.lastId=0,this.generateCurrentContextIds()}newFrame(e,i){return{id:e,frameName:i,iterationId:0}}set currentContext(e){this.contexts!==e&&(this.contexts=e,this.generateCurrentContextIds())}get currentContext(){return this.contexts}get currentContextId(){return this._currentContextIds[0]}get currentContextIds(){return this._currentContextIds}generateCurrentContextIds(){const e=[];for(let i=0;i<this.contexts.length-1;i++){const s=this.contexts.slice(0,this.contexts.length-i);e.push(this.contextIdforContexts(s))}e.push(""),this._currentContextIds=e}contextIdforContexts(e){return e?e.map(i=>i.id===0&&i.iterationId===0?"":i.frameName+"-"+i.iterationId).join("/"):""}enterFrame(e){this.contexts&&(this.lastId++,this.contexts=this.contexts.slice(),this.contexts.push(this.newFrame(this.lastId,e)),this._currentContextIds.unshift(this.contextIdforContexts(this.contexts)))}exitFrame(){if(this.contexts&&this.contexts.length>1)this.contexts=this.contexts.slice(),this.contexts.splice(-1),this.currentContextIds.shift();else throw new Error("Cannot exit frame, the context is empty")}nextIteration(){if(this.contexts&&this.contexts.length>0){this.contexts=this.contexts.slice(),this.lastId++;const e=Object.assign({},this.contexts[this.contexts.length-1]);e.iterationId+=1,e.id=this.lastId,this.contexts.splice(-1,1,e),this._currentContextIds.splice(0,1,this.contextIdforContexts(this.contexts))}else throw new Error("Cannot increase frame iteration, the context is empty")}getWeight(e){return this.weightMap[e]}addTensorArray(e){this.tensorArrayMap[e.id]=e}getTensorArray(e){return this.tensorArrayMap[e]}addTensorList(e){this.tensorListMap[e.id]=e}getTensorList(e){return this.tensorListMap[e]}dispose(e){for(const i in this.tensorArrayMap)this.tensorArrayMap[i].clearAndClose(e);for(const i in this.tensorListMap)this.tensorListMap[i].clearAndClose(e)}}function nv(l,e,i,s){const n=new Set,a=[];let p=null,_=null;const g=new Set,y=new Set(Object.keys(l).map(S=>ra(S)[0]));s=s||[];const b=new Set(s.map(S=>ra(S.name)[0])),v=[...e];for(;v.length>0;){const S=v.pop();if((sl(S)||XN(S)||YN(S))&&p==null&&(p=S,_=p.children.map(M=>M.name).filter(M=>n.has(M))),n.add(S.name),i[S.name]==null&&!y.has(S.name)&&!b.has(S.name)){if(S.inputs.length===0){a.push(S.name);continue}S.inputs.forEach(M=>{g.has(M.name)||(g.add(M.name),v.push(M))})}}return{inputs:l,outputs:e,usedNodes:n,missingInputs:a,dynamicNode:p,syncInputs:_}}function kN(l,e){const{usedNodes:i,inputs:s}=e,n=Object.keys(s).map(N=>ra(N)[0]).map(N=>l.nodes[N]),a=l.initNodes||[],p=N=>i.has(typeof N=="string"?N:N.name);function _(N){return[...new Map(N.map(k=>[k.name,k])).values()]}const g=_([...n,...l.weights,...a]).filter(p),y=_([...g,...Object.values(l.nodes)]).filter(p),b=new Map(y.map(N=>[N.name,N])),v={};for(const N of y){v[N.name]=v[N.name]||0;for(const k of N.children)p(k)||(v[k.name]=Number.POSITIVE_INFINITY),v[k.name]=(v[k.name]||0)+1}const S=Object.entries(v).filter(([,N])=>N===0).map(([N])=>N),M=[...S];for(;S.length>0;){const N=S.pop(),k=b.get(N);for(const G of k.children.filter(p))--v[G.name]===0&&(M.push(G.name),S.push(G.name))}const F=M.map(N=>b.get(N)),L=UN(F,g);return VN(L,g),L}function UN(l,e){const i=new Map(l.map(a=>[a.name,a])),s=e.map(a=>a.name),n=new Set(s);for(;s.length>0;){const a=s.pop(),p=i.get(a);for(const _ of p.children)!i.has(_.name)||n.has(_.name)||(n.add(_.name),s.push(_.name))}return l.filter(a=>n.has(a.name))}class Vd extends Error{constructor(e){super("NodesExecutionOrderError: "+e)}}function VN(l,e){const i=new Map(l.map((_,g)=>[_.name,g])),s=new Set(e.map(_=>_.name)),n=_=>s.has(typeof _=="string"?_:_.name),a=new Set(l.map(_=>_.name)),p=_=>a.has(typeof _=="string"?_:_.name);for(const _ of l){for(const g of _.children.filter(p)){if(!i.has(g.name))throw new Vd("Child "+g.name+" of node "+_.name+" is unreachable.");if(i.get(_.name)>i.get(g.name))throw new Vd("Node "+_.name+" is scheduled to run after its child "+g.name+".")}if(!n(_))for(const g of _.inputs){if(!i.has(g.name))throw new Vd("Input "+g.name+" of node "+_.name+" is unreachable.");if(i.get(g.name)>i.get(_.name))throw new Vd("Node "+_.name+" is scheduled to run before its input "+g.name+".")}}}function GN(l){const e=new Map(l.map((_,g)=>[_.name,g])),i=Number.MAX_SAFE_INTEGER,s=l.map((_,g)=>sl(_)?i:g),n=_=>{const g=s[e.get(_.name)];return g??-1},a=l.map((_,g)=>_.children.map(n).reduce((y,b)=>Math.max(y,b),s[g])),p=new Map;for(let _=0;_<l.length;++_){const g=a[_];if(g===i)continue;const y=l[_],b=l[g];p.has(b.name)||p.set(b.name,[]),p.get(b.name).push(y)}return p}const WN=new Set(["Switch","Merge","Enter","Exit","NextIteration","StatelessIf","StatelessWhile","if","While"]),zN=new Set(["NonMaxSuppressionV2","NonMaxSuppressionV3","NonMaxSuppressionV5","Where"]),HN=new Set(["HashTable","HashTableV2","LookupTableImport","LookupTableImportV2","LookupTableFind","LookupTableFindV2","LookupTableSize","LookupTableSizeV2"]);function sl(l){return WN.has(l.op)}function XN(l){return zN.has(l.op)}function YN(l){return HN.has(l.op)}class Gd{get weightIds(){return this.parent?this.parent.weightIds:this._weightIds}get functionExecutorMap(){return this.parent?this.parent.functionExecutorMap:this._functionExecutorMap}get weightMap(){return this.parent?this.parent.weightMap:this._weightMap}set weightMap(e){const i=Object.keys(e).map(s=>e[s].map(n=>n.id));this._weightIds=[].concat(...i),this._weightMap=e}set resourceManager(e){this._resourceManager=e}get inputs(){return this._inputs.map(e=>({name:e.name,shape:e.attrParams.shape?e.attrParams.shape.value:void 0,dtype:e.attrParams.dtype?e.attrParams.dtype.value:void 0}))}get outputs(){return this._outputs.map(e=>({name:e.name,shape:e.attrParams.shape?e.attrParams.shape.value:void 0,dtype:e.attrParams.dtype?e.attrParams.dtype.value:void 0}))}get inputNodes(){return this._inputs.map(e=>e.signatureKey||e.name)}get outputNodes(){return this._outputs.map(e=>{const i=e.signatureKey||e.name;return e.defaultOutput?i+":"+e.defaultOutput:i})}get functions(){return Object.keys(this._functions).reduce((e,i)=>(e[i]=this._functions[i].signature,e),{})}constructor(e,i){this.graph=e,this.parent=i,this.compiledMap=new Map,this.parseNodeNameCache=new Map,this._weightMap={},this.SEPARATOR=",",this._functions={},this._functionExecutorMap={},this.keepIntermediateTensors=!1,this._outputs=e.outputs,this._inputs=e.inputs,this._initNodes=e.initNodes,this._signature=e.signature,this._functions=e.functions,e.functions!=null&&Object.keys(e.functions).forEach(s=>{this._functionExecutorMap[s]=new Gd(e.functions[s],this)})}getCompilationKey(e,i){const s=e.map(a=>a.name).sort(),n=i.map(a=>a.name).sort();return s.join(this.SEPARATOR)+"--"+n.join(this.SEPARATOR)}compile(e,i){const s=nv(e,i,this.weightMap,this._initNodes),{missingInputs:n,dynamicNode:a,syncInputs:p}=s;if(a!=null)throw new Error("This execution contains the node '"+a.name+"', which has the dynamic op '"+a.op+"'. Please use model.executeAsync() instead. Alternatively, to avoid the dynamic ops, specify the inputs ["+p+"]");if(n.length>0){const y=i.map(v=>v.name),b=Object.keys(e);throw new Error("Cannot compute the outputs ["+y+"] from the provided inputs ["+b+"]. Missing the following inputs: ["+n+"]")}const _=kN(this.graph,s),g=GN(_);return{orderedNodes:_,nodeLiveUntilMap:g}}cloneAndKeepTensor(e){if(e==null)return null;const i=e.clone();return u0(i),i}cloneTensorList(e){return e?e.map(i=>this.cloneAndKeepTensor(i)):null}cloneTensorMap(e){return Object.fromEntries(Object.entries(e).map(([i,s])=>[i,this.cloneTensorList(s)]))}execute(e,i){this.disposeIntermediateTensors(),e=this.mapInputs(e);const s=Object.keys(e).sort();this.checkInputs(e),this.checkInputShapeAndType(e),i=this.mapOutputs(i),this.checkOutputs(i);const n=s.map(S=>this.graph.nodes[ra(S)[0]]),a=i.map(S=>ra(S)[0]),p=new Set(a);let _=a.map(S=>this.graph.nodes[S]);_.length===0&&(_=this._outputs);const g=this.getCompilationKey(n,_);let y=this.compiledMap.get(g);y==null&&(y=this.compile(e,_),this.compiledMap.set(g,y));try{this.keepIntermediateTensors=Ue().getBool("KEEP_INTERMEDIATE_TENSORS")}catch(S){this.keepIntermediateTensors=!1,console.warn(S.message)}const b={},v={};return zr(()=>{const S=new sv(this.weightMap,b,v,this.functionExecutorMap,this.parseNodeNameCache),M=Object.assign({},this.weightMap);this.keepIntermediateTensors&&(this.clonedTensorsMap=this.cloneTensorMap(this.weightMap)),Object.keys(e).forEach(k=>{const[G,H]=ra(k,S),z=[];z[H]=e[k],M[G]=z,this.keepIntermediateTensors&&(this.clonedTensorsMap[G]=this.cloneTensorList(z))});const F=this.getFrozenTensorIds(M),{orderedNodes:L,nodeLiveUntilMap:N}=y;for(const k of L){if(M[k.name])continue;const G=rv(k,M,S,this._resourceManager);if(Wi(G))throw new Error("The execution of the op '"+k.op+"' returned a promise. Please use model.executeAsync() instead.");M[k.name]=G,this.keepIntermediateTensors&&(this.clonedTensorsMap[k.name]=this.cloneTensorList(G)),this.checkTensorForDisposalWithNodeLiveUntilInfo(k,M,S,F,p,N.get(k.name))}return this.parent==null&&S.dispose(F),i.map(k=>Zs(k,M,S))})}getFrozenTensorIds(e){const i=[].concat.apply([],Object.keys(e).map(s=>e[s]).map(s=>s.map(n=>n.id)));return new Set(i)}checkTensorForDisposal(e,i,s,n,a,p,_){if(!(sl(i)||p.has(e))){for(const g of s[e])g!=null&&(_[g.id]=(_[g.id]||0)+i.children.length);for(const g of i.inputs){if(sl(g))continue;const y=Zb(g.name,s,n);if(y!=null)for(const b of y){if(!b||b.kept||a.has(b.id))continue;const v=_[b.id];v===1?(b.dispose(),delete _[b.id]):v!=null&&_[b.id]--}}}}checkTensorForDisposalWithNodeLiveUntilInfo(e,i,s,n,a,p){function _(g){return sl(g)||a.has(g.name)}if(!(sl(e)||p==null))for(const g of p){if(_(g))continue;const y=Zb(g.name,i,s);for(const b of y)!b||b.kept||n.has(b.id)||b.dispose()}}async executeAsync(e,i){return this._executeAsync(e,i)}disposeIntermediateTensors(){this.clonedTensorsMap&&(Object.values(this.clonedTensorsMap).forEach(e=>{for(const i of e)i&&!i.isDisposed&&i.dispose()}),this.clonedTensorsMap=null)}getIntermediateTensors(){return this.clonedTensorsMap}async _executeAsync(e,i,s=!1,n={},a={}){this.disposeIntermediateTensors(),s||(e=this.mapInputs(e),this.checkInputs(e),this.checkInputShapeAndType(e),i=this.mapOutputs(i),this.checkOutputs(i));try{this.keepIntermediateTensors=Ue().getBool("KEEP_INTERMEDIATE_TENSORS")}catch(S){this.keepIntermediateTensors=!1,console.warn(S.message)}const p=new sv(this.weightMap,n,a,this.functionExecutorMap,this.parseNodeNameCache);this.keepIntermediateTensors&&(this.clonedTensorsMap=this.cloneTensorMap(this.weightMap));const _=await this.executeWithControlFlow(e,p,i,s),g=i.map(S=>Zs(S,_,p)),y=g.map(S=>S.id),b=Object.keys(e).map(S=>e[S].id),v=new Set([...y,...b,...this.weightIds]);return Object.values(_).forEach(S=>{S.forEach(M=>{M&&!M.isDisposed&&!v.has(M.id)&&M.dispose()})}),this.parent==null&&p.dispose(v),g}async executeFunctionAsync(e,i,s){const n=e.reduce((a,p,_)=>(a[this.inputs[_].name]=p,a),{});return this._executeAsync(n,this.outputNodes,!0,i,s)}async executeWithControlFlow(e,i,s,n){const a=Object.keys(e),p=a.map(z=>this.graph.nodes[ra(z)[0]]),_=s.map(z=>ra(z)[0]),g=new Set(_);let y=_.map(z=>this.graph.nodes[z]);y.length===0&&(y=this._outputs);const{usedNodes:b,missingInputs:v,dynamicNode:S,syncInputs:M}=nv(e,y,this.weightMap,this._initNodes),F=[...p,...this.graph.weights,...this._initNodes||[]].map(z=>({node:z,contexts:i.currentContext})),L=Object.assign({},this.weightMap);Object.keys(e).forEach(z=>{const[W,Y]=ra(z),Z=[];Z[Y]=e[z],L[W]=Z});const N={},k=this.getFrozenTensorIds(L),G={};for(;F.length>0;){const z=this.processStack(p,F,i,L,G,k,g,N,b);await Promise.all(z)}S==null&&!n&&console.warn("This model execution did not contain any nodes with control flow or dynamic output shapes. You can use model.execute() instead.");const H=y.filter(z=>!sl(z)&&!Zs(z.name,L,i)).map(z=>z.name);if(H.length>0){let z="";throw S!=null&&(z="Alternatively, to avoid the dynamic ops, use model.execute() and specify the inputs ["+M+"]"),new Error("Cannot compute the outputs ["+H+"] from the provided inputs ["+a+"]. Consider providing the following inputs: ["+v+"]. "+z)}return L}processStack(e,i,s,n,a,p,_,g,y){const b=[];for(;i.length>0;){const v=i.pop();s.currentContext=v.contexts;let S="";if(v.node.op==="Enter"&&ee("isConstant",v.node,n,s)&&([S]=m0(v.node.name,s)),n[v.node.name]==null){const M=rv(v.node,n,s,this._resourceManager);S||([S]=m0(v.node.name,s));const F=s.currentContext;Wi(M)?b.push(M.then(L=>(n[S]=L,this.keepIntermediateTensors&&(this.clonedTensorsMap[S]=this.cloneTensorList(L)),s.currentContext=F,this.checkTensorForDisposal(S,v.node,n,s,p,_,g),this.processChildNodes(v.node,i,s,n,a,y),L))):(n[S]=M,this.keepIntermediateTensors&&(this.clonedTensorsMap[S]=this.cloneTensorList(M)),this.checkTensorForDisposal(S,v.node,n,s,p,_,g),this.processChildNodes(v.node,i,s,n,a,y))}else this.processChildNodes(v.node,i,s,n,a,y)}return b}processChildNodes(e,i,s,n,a,p){e.children.forEach(_=>{const[g]=m0(_.name,s);a[g]||!p.has(_.name)||(_.op==="Merge"?_.inputNames.some(y=>!!Zs(y,n,s))&&(a[g]=!0,i.push({contexts:s.currentContext,node:_})):_.inputNames.every(y=>!!Zs(y,n,s))&&(a[g]=!0,i.push({contexts:s.currentContext,node:_})))})}dispose(){Object.keys(this.weightMap).forEach(e=>this.weightMap[e].forEach(i=>i.dispose()))}checkInputShapeAndType(e){Object.keys(e).forEach(i=>{const s=e[i],[n]=ra(i),a=this.graph.nodes[n];if(a.attrParams.shape&&a.attrParams.shape.value){const p=a.attrParams.shape.value,_=p.length===s.shape.length&&s.shape.every((g,y)=>p[y]===-1||p[y]===g);Te(_,()=>"The shape of dict['"+a.name+"'] provided in model.execute(dict) must be ["+p+"], but was ["+s.shape+"]")}a.attrParams.dtype&&a.attrParams.dtype.value&&Te(s.dtype===a.attrParams.dtype.value,()=>"The dtype of dict['"+a.name+"'] provided in model.execute(dict) must be "+a.attrParams.dtype.value+", but was "+s.dtype)})}mapInputs(e){var i,s;const n={};for(const a in e){const p=(s=(i=this._signature)===null||i===void 0?void 0:i.inputs)===null||s===void 0?void 0:s[a];p!=null?n[p.name]=e[a]:n[a]=e[a]}return n}checkInputs(e){const i=Object.keys(e).filter(s=>{const[n]=ra(s);return this.graph.nodes[n]==null});if(i.length>0)throw new Error("The dict provided in model.execute(dict) has keys: ["+i+"] that are not part of graph")}mapOutputs(e){return e.map(i=>{var s,n;const a=(n=(s=this._signature)===null||s===void 0?void 0:s.outputs)===null||n===void 0?void 0:n[i];return a!=null?a.name:i},{})}checkOutputs(e){e.forEach(i=>{const[s]=ra(i);if(!this.graph.nodes[s])throw new Error("The output '"+i+"' is not found in the graph")})}}class KN{constructor(e={},i={}){this.hashTableNameToHandle=e,this.hashTableMap=i}addHashTable(e,i){this.hashTableNameToHandle[e]=i.handle,this.hashTableMap[i.id]=i}getHashTableHandleByName(e){return this.hashTableNameToHandle[e]}getHashTableById(e){return this.hashTableMap[e]}dispose(){for(const e in this.hashTableMap)this.hashTableMap[e].clearAndClose(),delete this.hashTableMap[e];for(const e in this.hashTableNameToHandle)this.hashTableNameToHandle[e].dispose(),delete this.hashTableNameToHandle[e]}}const jN="?tfjs-format=file",qN="model.json";class ZN{get modelVersion(){return this.version}get inputNodes(){return this.executor.inputNodes}get outputNodes(){return this.executor.outputNodes}get inputs(){return this.executor.inputs}get outputs(){return this.executor.outputs}get weights(){return this.executor.weightMap}get metadata(){return this.artifacts.userDefinedMetadata}get modelSignature(){return this.signature}get modelStructuredOutputKeys(){return this.structuredOutputKeys}constructor(e,i={},s=Xy){this.modelUrl=e,this.loadOptions=i,this.version="n/a",this.io=s,i==null&&(this.loadOptions={}),this.resourceManager=new KN}findIOHandler(){const e=this.modelUrl;if(e.load!=null)this.handler=e;else if(this.loadOptions.requestInit!=null)this.handler=this.io.browserHTTPRequest(e,this.loadOptions);else{const i=this.io.getLoadHandlers(e,this.loadOptions);if(i.length===0)i.push(this.io.browserHTTPRequest(e,this.loadOptions));else if(i.length>1)throw new Error("Found more than one ("+i.length+") load handlers for URL '"+[e]+"'");this.handler=i[0]}}load(){if(this.findIOHandler(),this.handler.load==null)throw new Error("Cannot proceed with model loading because the IOHandler provided does not have the `load` method implemented.");const e=this.handler.load();return Wi(e)?e.then(i=>this.loadSync(i)):this.loadSync(e)}loadSync(e){this.artifacts=e;const i=this.artifacts.modelTopology;let s=this.artifacts.signature;if(this.artifacts.userDefinedMetadata!=null){const a=this.artifacts.userDefinedMetadata;a.signature!=null&&(s=a.signature),a.structuredOutputKeys!=null&&(this.structuredOutputKeys=a.structuredOutputKeys)}this.signature=s,this.version=i.versions.producer+"."+i.versions.minConsumer;const n=this.io.decodeWeights(this.artifacts.weightData,this.artifacts.weightSpecs);if(this.executor=new Gd(Qb.Instance.transformGraph(i,this.signature)),this.executor.weightMap=this.convertTensorMapToTensorsMap(n),this.executor.resourceManager=this.resourceManager,e.modelInitializer!=null&&e.modelInitializer.node!=null){const a=Qb.Instance.transformGraph(e.modelInitializer);this.initializer=new Gd(a),this.initializer.weightMap=this.executor.weightMap,this.initializer.resourceManager=this.resourceManager,this.initializerSignature=e.initializerSignature}return!0}async save(e,i){if(typeof e=="string"){const s=this.io.getSaveHandlers(e);if(s.length===0)throw new Error("Cannot find any save handlers for URL '"+e+"'");if(s.length>1)throw new Error("Found more than one ("+s.length+") save handlers for URL '"+e+"'");e=s[0]}if(e.save==null)throw new Error("GraphModel.save() cannot proceed because the IOHandler provided does not have the `save` attribute defined.");return e.save(this.artifacts)}addStructuredOutputNames(e){if(this.structuredOutputKeys){const i=e instanceof ea?[e]:e,s={};return i.forEach((n,a)=>s[this.structuredOutputKeys[a]]=n),s}return e}predict(e,i){const s=this.execute(e,this.outputNodes);return this.addStructuredOutputNames(s)}async predictAsync(e,i){const s=await this.executeAsync(e,this.outputNodes);return this.addStructuredOutputNames(s)}normalizeInputs(e){var i;if(!(e instanceof ea)&&!Array.isArray(e)){const a=(i=this.signature)===null||i===void 0?void 0:i.inputs;if(a!=null)for(const p in a){const _=a[p];_.resourceId!=null&&(e[p]=this.resourceIdToCapturedInput[_.resourceId])}return e}e=Array.isArray(e)?e:[e];const s=Object.keys(this.resourceIdToCapturedInput).length;if(e.length+s!==this.inputNodes.length)throw new Error("Input tensor count mismatch, the graph model has "+(this.inputNodes.length-s)+" non-resource placeholders, while there are "+e.length+" input tensors provided.");let n=0;return this.inputNodes.reduce((a,p)=>{var _,g,y;const b=(y=(g=(_=this.signature)===null||_===void 0?void 0:_.inputs)===null||g===void 0?void 0:g[p])===null||y===void 0?void 0:y.resourceId;return b!=null?a[p]=this.resourceIdToCapturedInput[b]:a[p]=e[n++],a},{})}normalizeOutputs(e){return e=e||this.outputNodes,Array.isArray(e)?e:[e]}executeInitializerGraph(){return this.initializer==null?[]:this.initializerSignature==null?this.initializer.execute({},[]):this.initializer.execute({},Object.keys(this.initializerSignature.outputs))}async executeInitializerGraphAsync(){return this.initializer==null?[]:this.initializerSignature==null?this.initializer.executeAsync({},[]):this.initializer.executeAsync({},Object.keys(this.initializerSignature.outputs))}setResourceIdToCapturedInput(e){if(this.resourceIdToCapturedInput={},this.initializerSignature){const i=this.initializerSignature.outputs,s=Object.keys(i);for(let n=0;n<s.length;n++){const a=s[n],p=i[a];this.resourceIdToCapturedInput[p.resourceId]=e[n]}}}execute(e,i){this.resourceIdToCapturedInput==null&&this.setResourceIdToCapturedInput(this.executeInitializerGraph()),e=this.normalizeInputs(e),i=this.normalizeOutputs(i);const s=this.executor.execute(e,i);return s.length>1?s:s[0]}async executeAsync(e,i){this.resourceIdToCapturedInput==null&&this.setResourceIdToCapturedInput(await this.executeInitializerGraphAsync()),e=this.normalizeInputs(e),i=this.normalizeOutputs(i);const s=await this.executor.executeAsync(e,i);return s.length>1?s:s[0]}getIntermediateTensors(){return this.executor.getIntermediateTensors()}disposeIntermediateTensors(){this.executor.disposeIntermediateTensors()}convertTensorMapToTensorsMap(e){return Object.keys(e).reduce((i,s)=>(i[s]=[e[s]],i),{})}dispose(){this.executor.dispose(),this.initializer&&(this.initializer.dispose(),this.resourceIdToCapturedInput&&bO(this.resourceIdToCapturedInput)),this.resourceManager.dispose()}}async function tc(l,e={},i=Xy){if(l==null)throw new Error("modelUrl in loadGraphModel() cannot be null. Please provide a url or an IOHandler that loads the model");e==null&&(e={}),e.fromTFHub&&typeof l=="string"&&(l=QN(l));const s=new ZN(l,e,i);return await s.load(),s}function QN(l){return l.endsWith("/")||(l=l+"/"),""+l+qN+jN}const nl={},Wd={alpha:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,depth:!1,stencil:!1,failIfMajorPerformanceCaveat:!0};function $N(l,e){nl[l]=e}function go(l,e){if(!(l in nl)||e!=null){const s=eB(l,e);if(s!==null)nl[l]=s;else return console.log("Could not get context for WebGL version",l),null}const i=nl[l];return i==null||i.isContextLost()?(delete nl[l],go(l)):(i.disable(i.DEPTH_TEST),i.disable(i.STENCIL_TEST),i.disable(i.BLEND),i.disable(i.DITHER),i.disable(i.POLYGON_OFFSET_FILL),i.disable(i.SAMPLE_COVERAGE),i.enable(i.SCISSOR_TEST),i.enable(i.CULL_FACE),i.cullFace(i.BACK),nl[l])}function JN(l){if(!Ue().getBool("IS_SAFARI")&&typeof OffscreenCanvas<"u"&&l===2)return new OffscreenCanvas(300,150);if(typeof document<"u")return document.createElement("canvas");throw new Error("Cannot create a canvas in this context")}function eB(l,e){if(l!==1&&l!==2)throw new Error("Cannot get WebGL rendering context, WebGL is disabled.");const i=e??JN(l);return i.addEventListener("webglcontextlost",s=>{s.preventDefault(),delete nl[l]},!1),Ue().getBool("SOFTWARE_WEBGL_ENABLED")&&(Wd.failIfMajorPerformanceCaveat=!1),l===1?i.getContext("webgl",Wd)||i.getContext("experimental-webgl",Wd):i.getContext("webgl2",Wd)}var Th;(function(l){l[l.DENSE=0]="DENSE",l[l.SHARED_BATCH=1]="SHARED_BATCH"})(Th||(Th={}));var ma;(function(l){l[l.RENDER=0]="RENDER",l[l.UPLOAD=1]="UPLOAD",l[l.PIXELS=2]="PIXELS",l[l.DOWNLOAD=3]="DOWNLOAD"})(ma||(ma={}));var $s;(function(l){l[l.UNPACKED_FLOAT16=0]="UNPACKED_FLOAT16",l[l.UNPACKED_FLOAT32=1]="UNPACKED_FLOAT32",l[l.PACKED_4X1_UNSIGNED_BYTE=2]="PACKED_4X1_UNSIGNED_BYTE",l[l.PACKED_2X2_FLOAT32=3]="PACKED_2X2_FLOAT32",l[l.PACKED_2X2_FLOAT16=4]="PACKED_2X2_FLOAT16"})($s||($s={}));function Eh(l,e){return[e,l]}function tB(l,e){return l*e}function zd(l){const e=Je(l),i=Math.ceil(e/4);return gs(i)}function ic(l,e){return[Math.max(1,Math.ceil(e/2)),Math.max(1,Math.ceil(l/2))]}function iB(l,e){const[i,s]=ic(l,e);return i*s*4}function em(l,e){const i=l;let s,n,a,p,_,g,y,b,v,S;return Ue().getNumber("WEBGL_VERSION")===2?(s=i.R32F,n=i.R16F,a=i.RGBA16F,p=i.RGBA32F,_=i.RED,y=4,b=1,v=i.HALF_FLOAT,S=i.FLOAT,g=i.RGBA8):(s=l.RGBA,n=l.RGBA,a=l.RGBA,p=i.RGBA,_=l.RGBA,y=4,b=4,v=e!=null?e.HALF_FLOAT_OES:null,S=l.FLOAT,g=l.RGBA),{internalFormatFloat:s,internalFormatHalfFloat:n,internalFormatPackedHalfFloat:a,internalFormatPackedFloat:p,textureFormatFloat:_,downloadTextureFormat:g,downloadUnpackNumChannels:y,defaultNumChannels:b,textureTypeHalfFloat:v,textureTypeFloat:S}}function Xt(l,e){const i=e();return Ue().getBool("DEBUG")&&rB(l),i}function rB(l){const e=l.getError();if(e!==l.NO_ERROR)throw new Error("WebGL Error: "+oB(l,e))}const sB=596e-10,nB=65504;function aB(l){return!!(Ue().getBool("WEBGL_RENDER_FLOAT32_ENABLED")||l===0||sB<Math.abs(l)&&Math.abs(l)<nB)}function oB(l,e){switch(e){case l.NO_ERROR:return"NO_ERROR";case l.INVALID_ENUM:return"INVALID_ENUM";case l.INVALID_VALUE:return"INVALID_VALUE";case l.INVALID_OPERATION:return"INVALID_OPERATION";case l.INVALID_FRAMEBUFFER_OPERATION:return"INVALID_FRAMEBUFFER_OPERATION";case l.OUT_OF_MEMORY:return"OUT_OF_MEMORY";case l.CONTEXT_LOST_WEBGL:return"CONTEXT_LOST_WEBGL";default:return"Unknown error code "+e}}function Hd(l,e){return g0(l,()=>l.getExtension(e),'Extension "'+e+'" not supported on this browser.')}function xB(l,e){const i=g0(l,()=>l.createShader(l.VERTEX_SHADER),"Unable to create vertex WebGLShader.");if(Xt(l,()=>l.shaderSource(i,e)),Xt(l,()=>l.compileShader(i)),l.getShaderParameter(i,l.COMPILE_STATUS)===!1)throw console.log(l.getShaderInfoLog(i)),new Error("Failed to compile vertex shader.");return i}function lB(l,e){const i=g0(l,()=>l.createShader(l.FRAGMENT_SHADER),"Unable to create fragment WebGLShader.");if(Xt(l,()=>l.shaderSource(i,e)),Xt(l,()=>l.compileShader(i)),Ue().get("ENGINE_COMPILE_ONLY"))return i;if(l.getShaderParameter(i,l.COMPILE_STATUS)===!1)throw av(e,l.getShaderInfoLog(i)),new Error("Failed to compile fragment shader.");return i}const cB=/ERROR: [0-9]+:([0-9]+):/g;function av(l,e){const i=cB.exec(e);if(i==null){console.log("Couldn't parse line number in error: "+e),console.log(l);return}const s=+i[1],n=l.split(`
`),a=n.length.toString().length+2,p=n.map((v,S)=>ys((S+1).toString(),a)+v);let _=0;for(let v=0;v<p.length;v++)_=Math.max(p[v].length,_);const g=p.slice(0,s-1),y=p.slice(s-1,s),b=p.slice(s);console.log(g.join(`
`)),console.log(e.split(`
`)[0]),console.log("%c "+ys(y[0],_),"border:1px solid red; background-color:#e3d2d2; color:#a61717"),console.log(b.join(`
`))}function hB(l){return g0(l,()=>l.createProgram(),"Unable to create WebGLProgram.")}function uB(l,e){if(Xt(l,()=>l.linkProgram(e)),!Ue().get("ENGINE_COMPILE_ONLY")&&l.getProgramParameter(e,l.LINK_STATUS)===!1)throw console.log(l.getProgramInfoLog(e)),new Error("Failed to link vertex and fragment shaders.")}function tm(l,e){if(Xt(l,()=>l.validateProgram(e)),l.getProgramParameter(e,l.VALIDATE_STATUS)===!1)throw console.log(l.getProgramInfoLog(e)),new Error("Shader program validation failed.")}function dB(l,e){const i=g0(l,()=>l.createBuffer(),"Unable to create WebGLBuffer");return Xt(l,()=>l.bindBuffer(l.ARRAY_BUFFER,i)),Xt(l,()=>l.bufferData(l.ARRAY_BUFFER,e,l.STATIC_DRAW)),i}function fB(l,e){const i=g0(l,()=>l.createBuffer(),"Unable to create WebGLBuffer");return Xt(l,()=>l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,i)),Xt(l,()=>l.bufferData(l.ELEMENT_ARRAY_BUFFER,e,l.STATIC_DRAW)),i}function pB(l){return g0(l,()=>l.createTexture(),"Unable to create WebGLTexture.")}function mB(l,e){const i=Ue().getNumber("WEBGL_MAX_TEXTURE_SIZE");if(l<=0||e<=0){const s="["+l+"x"+e+"]";throw new Error("Requested texture size "+s+" is invalid.")}if(l>i||e>i){const s="["+l+"x"+e+"]",n="["+i+"x"+i+"]";throw new Error("Requested texture size "+s+" greater than WebGL maximum on this browser / GPU "+n+".")}}function _B(l){return g0(l,()=>l.createFramebuffer(),"Unable to create WebGLFramebuffer.")}function ov(l,e,i,s,n,a,p){const _=l.getAttribLocation(e,i);return _===-1?!1:(Xt(l,()=>l.bindBuffer(l.ARRAY_BUFFER,s)),Xt(l,()=>l.vertexAttribPointer(_,n,l.FLOAT,!1,a,p)),Xt(l,()=>l.enableVertexAttribArray(_)),!0)}function gB(l,e,i){EB(l,i),Xt(l,()=>l.activeTexture(l.TEXTURE0+i)),Xt(l,()=>l.bindTexture(l.TEXTURE_2D,e))}function yB(l,e,i){return g0(l,()=>l.getUniformLocation(e,i),'uniform "'+i+'" not present in program.')}function bB(l,e,i){return l.getUniformLocation(e,i)}function vB(l,e,i,s){Xt(l,()=>gB(l,e,s)),Xt(l,()=>l.uniform1i(i,s))}function im(l,e,i){Xt(l,()=>l.bindFramebuffer(l.FRAMEBUFFER,i)),Xt(l,()=>l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,e,0))}function xv(l,e){Xt(l,()=>l.bindFramebuffer(l.FRAMEBUFFER,e)),Xt(l,()=>l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,null,0))}function Xd(l){const e=l.checkFramebufferStatus(l.FRAMEBUFFER);if(e!==l.FRAMEBUFFER_COMPLETE)throw new Error("Error binding framebuffer: "+TB(l,e))}function TB(l,e){switch(e){case l.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case l.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case l.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return"FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case l.FRAMEBUFFER_UNSUPPORTED:return"FRAMEBUFFER_UNSUPPORTED";default:return"unknown error "+e}}function g0(l,e,i){const s=Xt(l,()=>e());if(s==null)throw new Error(i);return s}function EB(l,e){const i=l.MAX_COMBINED_TEXTURE_IMAGE_UNITS-1,s=e+l.TEXTURE0;if(s<l.TEXTURE0||s>i){const n="[gl.TEXTURE0, gl.TEXTURE"+i+"]";throw new Error("textureUnit must be in "+n+".")}}function rc(l,e=2){return Je(l.slice(0,l.length-e))}function sc(l){if(l.length===0)throw Error("Cannot get rows and columns of an empty shape array.");return[l.length>1?l[l.length-2]:1,l[l.length-1]]}function Yd(l){let e=[1,1,1];return l.length===0||l.length===1&&l[0]===1||(e=[rc(l),...sc(l)]),e}function AB(l,e=!1){let i=Ue().getNumber("WEBGL_MAX_TEXTURE_SIZE"),s=Ue().getNumber("WEBGL_MAX_SIZE_FOR_NARROW_TEXTURE");s===1/0&&Ue().getBool("WEBGL_AUTO_SQUARIFY_NARROW_TEXTURE_SHAPE")&&(s=i/2),e&&(i=i*2,s=s*2,l=l.map((_,g)=>g>=l.length-2?ui(l[g]):l[g]),l.length===1&&(l=[2,l[0]])),l.length!==2&&(l=ct(l).newShape);let n=Je(l),a=null;l.length<=1&&n<=i?a=[1,n]:l.length===2&&l[0]<=i&&l[1]<=i?a=l:l.length===3&&l[0]*l[1]<=i&&l[2]<=i?a=[l[0]*l[1],l[2]]:l.length===3&&l[0]<=i&&l[1]*l[2]<=i?a=[l[0],l[1]*l[2]]:l.length===4&&l[0]*l[1]*l[2]<=i&&l[3]<=i?a=[l[0]*l[1]*l[2],l[3]]:l.length===4&&l[0]<=i&&l[1]*l[2]*l[3]<=i&&(a=[l[0],l[1]*l[2]*l[3]]);const p=a!=null&&Math.max(...a)>s&&Math.min(...a)<=(e?2:1)&&Math.min(...a)>0;if(a==null||p)if(e){const _=rc(l);let g=2,y=2;l.length&&([g,y]=sc(l)),n=_*(g/2)*(y/2),a=gs(n).map(b=>b*2)}else a=gs(n);return a}function Kd(l){return l%2===0}function jd(l,e){if(l=l.slice(-2),e=e.slice(-2),qt(l,e)||!l.length||!e.length||l[0]===0||l[1]===0||e[0]===0||e[1]===0)return!0;if(l.length!==e.length){const i=l[l.length-1],s=e[e.length-1];if(i===s||Kd(i)&&Kd(s)&&(l[0]===1||e[0]===1))return!0}return l[1]===e[1]&&Kd(l[0])&&Kd(e[0])}let rm,sm;function CB(l){if(rm==null){const e=go(l);rm=e.getParameter(e.MAX_TEXTURE_SIZE)}return rm}function RB(l){if(sm==null){const e=go(l);sm=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS)}return Math.min(16,sm)}function IB(l){if(l===0)return 0;let e;const i=go(l);return za(i,"EXT_disjoint_timer_query_webgl2")&&l===2?e=2:za(i,"EXT_disjoint_timer_query")?e=1:e=0,e}function za(l,e){return l.getExtension(e)!=null}function lv(l){try{if(go(l)!=null)return!0}catch(e){return console.log("Error when getting WebGL context: ",e),!1}return!1}function SB(l){if(l===0)return!1;const e=go(l);if(l===1){if(!za(e,"OES_texture_float"))return!1}else if(!za(e,"EXT_color_buffer_float"))return!1;return nm(e)}function MB(l){if(l===0)return!1;const e=go(l);if(l===1){if(!za(e,"OES_texture_float")||!za(e,"WEBGL_color_buffer_float"))return!1}else{if(za(e,"EXT_color_buffer_float"))return nm(e);const i="EXT_color_buffer_half_float";if(za(e,i)){const s=e.getExtension(i);return PB(e,s)}return!1}return nm(e)}function nm(l){const e=em(l),i=l.createTexture();l.bindTexture(l.TEXTURE_2D,i);const s=1,n=1;l.texImage2D(l.TEXTURE_2D,0,e.internalFormatFloat,s,n,0,e.textureFormatFloat,e.textureTypeFloat,null);const a=l.createFramebuffer();l.bindFramebuffer(l.FRAMEBUFFER,a),l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,i,0);const p=l.checkFramebufferStatus(l.FRAMEBUFFER)===l.FRAMEBUFFER_COMPLETE;return l.bindTexture(l.TEXTURE_2D,null),l.bindFramebuffer(l.FRAMEBUFFER,null),l.deleteTexture(i),l.deleteFramebuffer(a),p}function PB(l,e){const i=em(l,e),s=l.createTexture();l.bindTexture(l.TEXTURE_2D,s);const n=1,a=1;l.texImage2D(l.TEXTURE_2D,0,i.internalFormatHalfFloat,n,a,0,i.textureFormatFloat,i.textureTypeHalfFloat,null);const p=l.createFramebuffer();l.bindFramebuffer(l.FRAMEBUFFER,p),l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,s,0);const _=l.checkFramebufferStatus(l.FRAMEBUFFER)===l.FRAMEBUFFER_COMPLETE;return l.bindTexture(l.TEXTURE_2D,null),l.bindFramebuffer(l.FRAMEBUFFER,null),l.deleteTexture(s),l.deleteFramebuffer(p),_}function OB(l){return l!==2?!1:go(l).fenceSync!=null}function cv(l,e){Array.isArray(l)||(l=[l]),l.forEach(i=>{i!=null&&Te(i.dtype!=="complex64",()=>e+" does not support complex64 tensors in the WebGL backend.")})}const di=Ue();di.registerFlag("HAS_WEBGL",()=>di.getNumber("WEBGL_VERSION")>0),di.registerFlag("WEBGL_VERSION",()=>lv(2)?2:lv(1)?1:0),di.registerFlag("WEBGL_CHECK_NUMERICAL_PROBLEMS",()=>!1),di.registerFlag("WEBGL_BUFFER_SUPPORTED",()=>di.get("WEBGL_VERSION")===2),di.registerFlag("WEBGL_CPU_FORWARD",()=>!0),di.registerFlag("WEBGL_FORCE_F16_TEXTURES",()=>!1),di.registerFlag("WEBGL_PACK",()=>di.getBool("HAS_WEBGL")),di.registerFlag("WEBGL_PACK_NORMALIZATION",()=>di.getBool("WEBGL_PACK")),di.registerFlag("WEBGL_PACK_CLIP",()=>di.getBool("WEBGL_PACK")),di.registerFlag("WEBGL_PACK_DEPTHWISECONV",()=>di.getBool("WEBGL_PACK")),di.registerFlag("WEBGL_PACK_BINARY_OPERATIONS",()=>di.getBool("WEBGL_PACK")),di.registerFlag("WEBGL_PACK_UNARY_OPERATIONS",()=>di.getBool("WEBGL_PACK")),di.registerFlag("WEBGL_PACK_ARRAY_OPERATIONS",()=>di.getBool("WEBGL_PACK")),di.registerFlag("WEBGL_PACK_IMAGE_OPERATIONS",()=>di.getBool("WEBGL_PACK")),di.registerFlag("WEBGL_PACK_REDUCE",()=>di.getBool("WEBGL_PACK")),di.registerFlag("WEBGL_LAZILY_UNPACK",()=>di.getBool("WEBGL_PACK")),di.registerFlag("WEBGL_CONV_IM2COL",()=>di.getBool("WEBGL_PACK")),di.registerFlag("WEBGL_MAX_TEXTURE_SIZE",()=>CB(di.getNumber("WEBGL_VERSION"))),di.registerFlag("WEBGL_MAX_TEXTURES_IN_SHADER",()=>RB(di.getNumber("WEBGL_VERSION"))),di.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION",()=>{const l=di.getNumber("WEBGL_VERSION");return l===0?0:IB(l)}),di.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE",()=>di.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0&&!by()),di.registerFlag("WEBGL_RENDER_FLOAT32_CAPABLE",()=>SB(di.getNumber("WEBGL_VERSION"))),di.registerFlag("WEBGL_RENDER_FLOAT32_ENABLED",()=>di.getBool("WEBGL_FORCE_F16_TEXTURES")?!1:di.getBool("WEBGL_RENDER_FLOAT32_CAPABLE")),di.registerFlag("WEBGL_DOWNLOAD_FLOAT_ENABLED",()=>MB(di.getNumber("WEBGL_VERSION"))),di.registerFlag("WEBGL_FENCE_API_ENABLED",()=>OB(di.getNumber("WEBGL_VERSION"))),di.registerFlag("WEBGL_SIZE_UPLOAD_UNIFORM",()=>di.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?4:0),di.registerFlag("WEBGL_DELETE_TEXTURE_THRESHOLD",()=>-1,l=>{if(typeof l!="number")throw new Error("WEBGL_DELETE_TEXTURE_THRESHOLD must be a number but got "+l+".");if(l<0&&l!==-1)throw new Error("WEBGL_DELETE_TEXTURE_THRESHOLD must be -1 (indicating never delete) or at least 0, but got "+l+".")}),di.registerFlag("WEBGL_FLUSH_THRESHOLD",()=>by()?1:-1,l=>{if(typeof l!="number")throw new Error("WEBGL_FLUSH_THRESHOLD must be a number but got "+l+".");if(l<0&&l!==-1)throw new Error("WEBGL_FLUSH_THRESHOLD must be -1 (indicating never manual flush) or at least 0, but got "+l+".")}),di.registerFlag("CPU_HANDOFF_SIZE_THRESHOLD",()=>128),di.registerFlag("WEBGL_USE_SHAPES_UNIFORMS",()=>!1),di.registerFlag("TOPK_LAST_DIM_CPU_HANDOFF_SIZE_THRESHOLD",()=>1e5),di.registerFlag("TOPK_K_CPU_HANDOFF_THRESHOLD",()=>128),di.registerFlag("WEBGL_EXP_CONV",()=>!1),di.registerFlag("SOFTWARE_WEBGL_ENABLED",()=>di.getBool("IS_TEST")),di.registerFlag("WEBGL_MAX_SIZE_FOR_NARROW_TEXTURE",()=>1/0),di.registerFlag("WEBGL_AUTO_SQUARIFY_NARROW_TEXTURE_SHAPE",()=>!1),di.registerFlag("WEBGL2_ISNAN_CUSTOM",()=>!1),di.registerFlag("ENGINE_COMPILE_ONLY",()=>!1);function Tn(){let l,e,i,s,n,a,p,_,g,y;return Ue().getNumber("WEBGL_VERSION")===2?(l="#version 300 es",e="in",i="out",s="in",n="texture",a="outputColor",p="out vec4 outputColor;",_=Ue().getBool("WEBGL2_ISNAN_CUSTOM")?`
      bool isnan_custom(float val) {
        uint floatToUint = floatBitsToUint(val);
        return (floatToUint & 0x7fffffffu) > 0x7f800000u;
      }

      bvec4 isnan_custom(vec4 val) {
        return bvec4(isnan_custom(val.x),
          isnan_custom(val.y), isnan_custom(val.z), isnan_custom(val.w));
      }

      #define isnan(value) isnan_custom(value)
    `:"",g="",y=`
      #define round(value) newRound(value)
      int newRound(float value) {
        return int(floor(value + 0.5));
      }

      ivec4 newRound(vec4 value) {
        return ivec4(floor(value + vec4(0.5)));
      }
    `):(l="",e="attribute",i="varying",s="varying",n="texture2D",a="gl_FragColor",p="",_=`
      #define isnan(value) isnan_custom(value)
      bool isnan_custom(float val) {
        return (val > 0. || val < 1. || val == 0.) ? false : true;
      }
      bvec4 isnan_custom(vec4 val) {
        return bvec4(isnan(val.x), isnan(val.y), isnan(val.z), isnan(val.w));
      }
    `,g=`
      uniform float INFINITY;

      bool isinf(float val) {
        return abs(val) == INFINITY;
      }
      bvec4 isinf(vec4 val) {
        return equal(abs(val), vec4(INFINITY));
      }
    `,y=`
      int round(float value) {
        return int(floor(value + 0.5));
      }

      ivec4 round(vec4 value) {
        return ivec4(floor(value + vec4(0.5)));
      }
    `),{version:l,attribute:e,varyingVs:i,varyingFs:s,texture2D:n,output:a,defineOutput:p,defineSpecialNaN:_,defineSpecialInf:g,defineRound:y}}function al(l,e,i="index"){const s=Ni(e);return s.map((n,a)=>{const p="int "+l[a]+" = "+i+" / "+n,_=a===s.length-1?"int "+l[a+1]+" = "+i+" - "+l[a]+" * "+n:"index -= "+l[a]+" * "+n;return p+"; "+_+";"}).join("")}function qd(l,e,i="index"){const s=Ni(e);return s.map((n,a)=>{const p="int "+l[a]+" = "+i+" / outShapeStrides["+a+"]",_=a===s.length-1?"int "+l[a+1]+" = "+i+" - "+l[a]+" * outShapeStrides["+a+"]":"index -= "+l[a]+" * outShapeStrides["+a+"]";return p+"; "+_+";"}).join("")}function wB(l,e){const i=l.length,s=l.map(a=>e+"["+a+"]"),n=new Array(i-1);n[i-2]=s[i-1];for(let a=i-3;a>=0;--a)n[a]="("+n[a+1]+" * "+s[a+1]+")";return n}function DB(l,e,i="index"){const s=l.map((a,p)=>p),n=wB(s,e);return n.map((a,p)=>{const _="int "+l[p]+" = "+i+" / "+n[p],g=p===n.length-1?"int "+l[p+1]+" = "+i+" - "+l[p]+" * "+n[p]:"index -= "+l[p]+" * "+n[p];return _+"; "+g+";"}).join("")}function am(l){const e=Ni(l).map(i=>i.toString());return`
  int getFlatIndex(ivec3 coords) {
    return coords.x * `+e[0]+" + coords.y * "+e[1]+` + coords.z;
  }
`}function om(){return`
  int getFlatIndex(ivec3 coords) {
    return coords.x * outShapeStrides[0] + coords.y * outShapeStrides[1] + coords.z;
  }
`}const hv=`
  const float FLOAT_MAX = 1.70141184e38;
  const float FLOAT_MIN = 1.17549435e-38;

  lowp vec4 encode_float(highp float v) {
    if (isnan(v)) {
      return vec4(255, 255, 255, 255);
    }

    highp float av = abs(v);

    if(av < FLOAT_MIN) {
      return vec4(0.0, 0.0, 0.0, 0.0);
    } else if(v > FLOAT_MAX) {
      return vec4(0.0, 0.0, 128.0, 127.0) / 255.0;
    } else if(v < -FLOAT_MAX) {
      return vec4(0.0, 0.0,  128.0, 255.0) / 255.0;
    }

    highp vec4 c = vec4(0,0,0,0);

    highp float e = floor(log2(av));
    highp float m = exp2(fract(log2(av))) - 1.0;

    c[2] = floor(128.0 * m);
    m -= c[2] / 128.0;
    c[1] = floor(32768.0 * m);
    m -= c[1] / 32768.0;
    c[0] = floor(8388608.0 * m);

    highp float ebias = e + 127.0;
    c[3] = floor(ebias / 2.0);
    ebias -= c[3] * 2.0;
    c[2] += floor(ebias) * 128.0;

    c[3] += 128.0 * step(0.0, -v);

    return c / 255.0;
  }
`,{getBroadcastDims:uv}=RL;function FB(l,e,i){const s=[];if(l.forEach(S=>{const M=Je(S.shapeInfo.logicalShape);if(S.shapeInfo.isUniform?s.push("uniform float "+S.name+(M>1?"["+M+"]":"")+";"):(s.push("uniform sampler2D "+S.name+";"),s.push("uniform int offset"+S.name+";")),i.enableShapeUniforms){const{uniformShape:F}=xm(i.packedInputs,S.shapeInfo.logicalShape,S.shapeInfo.texShape);switch(F.length){case 1:s.push("uniform int "+S.name+"Shape;");break;case 2:s.push("uniform ivec2 "+S.name+"Shape;");break;case 3:s.push("uniform ivec3 "+S.name+"Shape;");break;case 4:s.push("uniform ivec4 "+S.name+"Shape;");break}s.push("uniform ivec2 "+S.name+"TexShape;")}}),i.enableShapeUniforms){switch(e.logicalShape.length){case 1:s.push("uniform int outShape;");break;case 2:s.push("uniform ivec2 outShape;"),s.push("uniform int outShapeStrides;");break;case 3:s.push("uniform ivec3 outShape;"),s.push("uniform ivec2 outShapeStrides;");break;case 4:s.push("uniform ivec4 outShape;"),s.push("uniform ivec3 outShapeStrides;");break}s.push("uniform ivec2 outTexShape;")}i.customUniforms&&i.customUniforms.forEach(S=>{s.push("uniform "+S.type+" "+S.name+(S.arrayIndex?"["+S.arrayIndex+"]":"")+";")});const n=s.join(`
`),a=l.map(S=>LB(S,e,i.packedInputs,i.enableShapeUniforms)).join(`
`),p=e.texShape,_=Tn(),g=kB(_);let y,b,v=GB(_);return e.isPacked?(y=NB(e.logicalShape,p,i.enableShapeUniforms),b=VB(_)):(y=BB(e.logicalShape,p,i.enableShapeUniforms),b=UB(_)),i.packedInputs&&(v+=XB),[v,g,b,n,y,a,i.userCode].join(`
`)}function nc(l,e=!1){const i=l.shapeInfo.logicalShape;switch(i.length){case 0:return r3(l,e);case 1:return n3(l,e);case 2:return o3(l,e);case 3:return l3(l,e);case 4:return h3(l,e);case 5:return u3(l);case 6:return d3(l);default:throw new Error(i.length+"-D input sampling is not yet supported")}}function dv(l,e){switch(l.shapeInfo.logicalShape.length){case 0:return i3(l);case 1:return s3(l,e);case 2:return a3(l,e);case 3:return x3(l,e);default:return c3(l,e)}}function LB(l,e,i=!1,s){let n="";i?n+=dv(l,s):n+=nc(l,s);const a=l.shapeInfo.logicalShape,p=e.logicalShape;return a.length<=p.length&&(i?n+=f3(l,e):n+=p3(l,e)),n}function NB(l,e,i){switch(l.length){case 0:return fv();case 1:return YB(l,e,i);case 2:return e3(l,e,i);case 3:return jB(l,e,i);default:return ZB(l,e,i)}}function BB(l,e,i){switch(l.length){case 0:return fv();case 1:return KB(l,e,i);case 2:return t3(l,e,i);case 3:return qB(l,e,i);case 4:return QB(l,e,i);case 5:return $B(l,e);case 6:return JB(l,e);default:throw new Error(l.length+"-D output sampling is not yet supported")}}function kB(l){return`
    float sampleTexture(sampler2D textureSampler, vec2 uv) {
      return `+l.texture2D+`(textureSampler, uv).r;
    }
  `}function UB(l){return`
    void setOutput(float val) {
      `+l.output+` = vec4(val, 0, 0, 0);
    }
  `}function VB(l){return`
    void setOutput(vec4 val) {
      `+l.output+` = val;
    }
  `}function GB(l){return l.version+`
    precision highp float;
    precision highp int;
    precision highp sampler2D;
    `+l.varyingFs+` vec2 resultUV;
    `+l.defineOutput+`
    const vec2 halfCR = vec2(0.5, 0.5);

    struct ivec5
    {
      int x;
      int y;
      int z;
      int w;
      int u;
    };

    struct ivec6
    {
      int x;
      int y;
      int z;
      int w;
      int u;
      int v;
    };

    uniform float NAN;
    `+l.defineSpecialNaN+`
    `+l.defineSpecialInf+`
    `+l.defineRound+`

    int imod(int x, int y) {
      return x - y * (x / y);
    }

    int idiv(int a, int b, float sign) {
      int res = a / b;
      int mod = imod(a, b);
      if (sign < 0. && mod != 0) {
        res -= 1;
      }
      return res;
    }

    //Based on the work of Dave Hoskins
    //https://www.shadertoy.com/view/4djSRW
    #define HASHSCALE1 443.8975
    float random(float seed){
      vec2 p = resultUV * seed;
      vec3 p3  = fract(vec3(p.xyx) * HASHSCALE1);
      p3 += dot(p3, p3.yzx + 19.19);
      return fract((p3.x + p3.y) * p3.z);
    }

    `+WB+`
    `+zB+`
    `+HB+`
  `}const WB=`
vec2 uvFromFlat(int texNumR, int texNumC, int index) {
  int texR = index / texNumC;
  int texC = index - texR * texNumC;
  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);
}
vec2 packedUVfrom1D(int texNumR, int texNumC, int index) {
  int texelIndex = index / 2;
  int texR = texelIndex / texNumC;
  int texC = texelIndex - texR * texNumC;
  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);
}
`,zB=`
vec2 packedUVfrom2D(int texelsInLogicalRow, int texNumR,
  int texNumC, int row, int col) {
  int texelIndex = (row / 2) * texelsInLogicalRow + (col / 2);
  int texR = texelIndex / texNumC;
  int texC = texelIndex - texR * texNumC;
  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);
}
`,HB=`
vec2 packedUVfrom3D(int texNumR, int texNumC,
    int texelsInBatch, int texelsInLogicalRow, int b,
    int row, int col) {
  int index = b * texelsInBatch + (row / 2) * texelsInLogicalRow + (col / 2);
  int texR = index / texNumC;
  int texC = index - texR * texNumC;
  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);
}
`,XB=`
  float getChannel(vec4 frag, vec2 innerDims) {
    vec2 modCoord = mod(innerDims, 2.);
    return modCoord.x == 0. ?
      (modCoord.y == 0. ? frag.r : frag.g) :
      (modCoord.y == 0. ? frag.b : frag.a);
  }
  float getChannel(vec4 frag, int dim) {
    float modCoord = mod(float(dim), 2.);
    return modCoord == 0. ? frag.r : frag.g;
  }
`;function fv(){return`
    int getOutputCoords() {
      return 0;
    }
  `}function YB(l,e,i){const s=[Math.ceil(e[0]/2),Math.ceil(e[1]/2)];return s[0]===1?i?`
      int getOutputCoords() {
        return 2 * int(resultUV.x * ceil(float(outTexShape[1]) / 2.0));
      }
    `:`
      int getOutputCoords() {
        return 2 * int(resultUV.x * `+s[1]+`.0);
      }
    `:s[1]===1?i?`
      int getOutputCoords() {
        return 2 * int(resultUV.y * ceil(float(outTexShape[0]) / 2.0));
      }
    `:`
      int getOutputCoords() {
        return 2 * int(resultUV.y * `+s[0]+`.0);
      }
    `:i?`
    int getOutputCoords() {
      ivec2 packedTexShape = ivec2(ceil(float(outTexShape[0]) / 2.0), ceil(float(outTexShape[1]) / 2.0));
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(packedTexShape[0], packedTexShape[1]));
      return 2 * (resTexRC.x * packedTexShape[1] + resTexRC.y);
    }
  `:`
    int getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(`+s[0]+", "+s[1]+`));
      return 2 * (resTexRC.x * `+s[1]+` + resTexRC.y);
    }
  `}function KB(l,e,i){return e[0]===1?i?`
      int getOutputCoords() {
        return int(resultUV.x * float(outTexShape[1]));
      }
    `:`
      int getOutputCoords() {
        return int(resultUV.x * `+e[1]+`.0);
      }
    `:e[1]===1?i?`
      int getOutputCoords() {
        return int(resultUV.y * float(outTexShape[0]));
      }
    `:`
      int getOutputCoords() {
        return int(resultUV.y * `+e[0]+`.0);
      }
    `:i?`
    int getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(outTexShape[0], outTexShape[1]));
      return resTexRC.x * outTexShape[1] + resTexRC.y;
    }
  `:`
    int getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(`+e[0]+", "+e[1]+`));
      return resTexRC.x * `+e[1]+` + resTexRC.y;
    }
  `}function jB(l,e,i){if(i)return`
    ivec3 getOutputCoords() {
      ivec2 packedTexShape = ivec2(ceil(float(outTexShape[0]) / 2.0), ceil(float(outTexShape[1]) / 2.0));
      int texelsInLogicalRow = int(ceil(float(outShape[2]) / 2.0));
      int texelsInBatch = texelsInLogicalRow * int(ceil(float(outShape[1]) / 2.0));
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(packedTexShape[0], packedTexShape[1]));
      int index = resTexRC.x * packedTexShape[1] + resTexRC.y;

      int b = index / texelsInBatch;
      index -= b * texelsInBatch;

      int r = 2 * (index / texelsInLogicalRow);
      int c = imod(index, texelsInLogicalRow) * 2;

      return ivec3(b, r, c);
    }
  `;const s=[Math.ceil(e[0]/2),Math.ceil(e[1]/2)],n=Math.ceil(l[2]/2),a=n*Math.ceil(l[1]/2);return`
    ivec3 getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(`+s[0]+", "+s[1]+`));
      int index = resTexRC.x * `+s[1]+` + resTexRC.y;

      int b = index / `+a+`;
      index -= b * `+a+`;

      int r = 2 * (index / `+n+`);
      int c = imod(index, `+n+`) * 2;

      return ivec3(b, r, c);
    }
  `}function qB(l,e,i){if(i)return`
  ivec3 getOutputCoords() {
    ivec2 resTexRC = ivec2(resultUV.yx *
                           vec2(outTexShape[0], outTexShape[1]));
    int index = resTexRC.x * outTexShape[1] + resTexRC.y;
    `+qd(["r","c","d"],l)+`
    return ivec3(r, c, d);
  }
`;const s=al(["r","c","d"],l);return`
    ivec3 getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(`+e[0]+", "+e[1]+`));
      int index = resTexRC.x * `+e[1]+` + resTexRC.y;
      `+s+`
      return ivec3(r, c, d);
    }
  `}function ZB(l,e,i){if(i)return`
    ivec4 getOutputCoords() {
      ivec2 packedTexShape = ivec2(ceil(float(outTexShape[0]) / 2.0), ceil(float(outTexShape[1]) / 2.0));
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(packedTexShape[0], packedTexShape[1]));
      int index = resTexRC.x * packedTexShape[1] + resTexRC.y;

      int texelsInLogicalRow = int(ceil(float(outShape[3]) / 2.0));
      int texelsInBatch = texelsInLogicalRow * int(ceil(float(outShape[2]) / 2.0));
      int texelsInBatchN = texelsInBatch * outShape[1];

      int b2 = index / texelsInBatchN;
      index -= b2 * texelsInBatchN;

      int b = index / texelsInBatch;
      index -= b * texelsInBatch;

      int r = 2 * (index / texelsInLogicalRow);
      int c = imod(index, texelsInLogicalRow) * 2;

      return ivec4(b2, b, r, c);
    }
  `;const s=[Math.ceil(e[0]/2),Math.ceil(e[1]/2)],n=Math.ceil(l[l.length-1]/2),a=n*Math.ceil(l[l.length-2]/2);let p=a,_="",g="b, r, c";for(let y=2;y<l.length-1;y++)p*=l[l.length-y-1],_=`
      int b`+y+" = index / "+p+`;
      index -= b`+y+" * "+p+`;
    `+_,g="b"+y+", "+g;return`
    ivec`+l.length+` getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(`+s[0]+", "+s[1]+`));
      int index = resTexRC.x * `+s[1]+` + resTexRC.y;

      `+_+`

      int b = index / `+a+`;
      index -= b * `+a+`;

      int r = 2 * (index / `+n+`);
      int c = imod(index, `+n+`) * 2;

      return ivec`+l.length+"("+g+`);
    }
  `}function QB(l,e,i){if(i)return`
    ivec4 getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
        vec2(outTexShape[0], outTexShape[1]));
      int index = resTexRC.x * outTexShape[1] + resTexRC.y;
      `+qd(["r","c","d","d2"],l)+`
      return ivec4(r, c, d, d2);
    }
  `;const s=al(["r","c","d","d2"],l);return`
    ivec4 getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
        vec2(`+e[0]+", "+e[1]+`));
      int index = resTexRC.x * `+e[1]+` + resTexRC.y;
      `+s+`
      return ivec4(r, c, d, d2);
    }
  `}function $B(l,e){const i=al(["r","c","d","d2","d3"],l);return`
    ivec5 getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx * vec2(`+e[0]+`,
                             `+e[1]+`));

      int index = resTexRC.x * `+e[1]+` + resTexRC.y;

      `+i+`

      ivec5 outShape = ivec5(r, c, d, d2, d3);
      return outShape;
    }
  `}function JB(l,e){const i=al(["r","c","d","d2","d3","d4"],l);return`
    ivec6 getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
        vec2(`+e[0]+", "+e[1]+`));
      int index = resTexRC.x * `+e[1]+` + resTexRC.y;

      `+i+`

      ivec6 result = ivec6(r, c, d, d2, d3, d4);
      return result;
    }
  `}function e3(l,e,i){const s=[Math.ceil(e[0]/2),Math.ceil(e[1]/2)];if(qt(l,e))return i?`
      ivec2 getOutputCoords() {
        ivec2 packedTexShape = ivec2(ceil(float(outTexShape[0]) / 2.0), ceil(float(outTexShape[1]) / 2.0));
        return 2 * ivec2(resultUV.yx * vec2(packedTexShape[0], packedTexShape[1]));
      }
    `:`
      ivec2 getOutputCoords() {
        return 2 * ivec2(resultUV.yx * vec2(`+s[0]+", "+s[1]+`));
      }
    `;const n=Math.ceil(l[1]/2);return i?`
    ivec2 getOutputCoords() {
      ivec2 packedTexShape = ivec2(ceil(float(outTexShape[0]) / 2.0), ceil(float(outTexShape[1]) / 2.0));
      int texelsInLogicalRow = int(ceil(float(outShape[1]) / 2.0));
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(packedTexShape[0], packedTexShape[1]));

      int index = resTexRC.x * packedTexShape[1] + resTexRC.y;
      int r = 2 * (index / texelsInLogicalRow);
      int c = imod(index, texelsInLogicalRow) * 2;

      return ivec2(r, c);
    }
  `:`
    ivec2 getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(`+s[0]+", "+s[1]+`));

      int index = resTexRC.x * `+s[1]+` + resTexRC.y;
      int r = 2 * (index / `+n+`);
      int c = imod(index, `+n+`) * 2;

      return ivec2(r, c);
    }
  `}function t3(l,e,i){return qt(l,e)?i?`
      ivec2 getOutputCoords() {
        return ivec2(resultUV.yx * vec2(outTexShape[0], outTexShape[1]));
      }
    `:`
      ivec2 getOutputCoords() {
        return ivec2(resultUV.yx * vec2(`+e[0]+", "+e[1]+`));
      }
    `:l[1]===1?i?`
      ivec2 getOutputCoords() {
        ivec2 resTexRC = ivec2(resultUV.yx *
                               vec2(outTexShape[0], outTexShape[1]));
        int index = resTexRC.x * outTexShape[1] + resTexRC.y;
        return ivec2(index, 0);
      }
    `:`
      ivec2 getOutputCoords() {
        ivec2 resTexRC = ivec2(resultUV.yx *
                               vec2(`+e[0]+", "+e[1]+`));
        int index = resTexRC.x * `+e[1]+` + resTexRC.y;
        return ivec2(index, 0);
      }
    `:l[0]===1?i?`
      ivec2 getOutputCoords() {
        ivec2 resTexRC = ivec2(resultUV.yx *
                               vec2(outTexShape[0], outTexShape[1]));
        int index = resTexRC.x * outTexShape[1] + resTexRC.y;
        return ivec2(0, index);
      }
    `:`
      ivec2 getOutputCoords() {
        ivec2 resTexRC = ivec2(resultUV.yx *
                               vec2(`+e[0]+", "+e[1]+`));
        int index = resTexRC.x * `+e[1]+` + resTexRC.y;
        return ivec2(0, index);
      }
    `:i?`
    ivec2 getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(outTexShape[0], outTexShape[1]));
      int index = resTexRC.x * outTexShape[1] + resTexRC.y;
      int r = index / outShape[1];
      int c = index - r * outShape[1];
      return ivec2(r, c);
    }
  `:`
    ivec2 getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(`+e[0]+", "+e[1]+`));
      int index = resTexRC.x * `+e[1]+` + resTexRC.y;
      int r = index / `+l[1]+`;
      int c = index - r * `+l[1]+`;
      return ivec2(r, c);
    }
  `}function ol(l){return"offset"+l}function i3(l){const e=l.name,i="get"+e.charAt(0).toUpperCase()+e.slice(1),s=Tn();return`
    vec4 `+i+`() {
      return `+s.texture2D+"("+e+`, halfCR);
    }
  `}function r3(l,e){const i=l.name,s="get"+i.charAt(0).toUpperCase()+i.slice(1);if(l.shapeInfo.isUniform)return"float "+s+"() {return "+i+";}";const[n,a]=l.shapeInfo.texShape;if(n===1&&a===1)return`
      float `+s+`() {
        return sampleTexture(`+i+`, halfCR);
      }
    `;const p=ol(i);if(e)return`
    float `+s+`() {
      vec2 uv = uvFromFlat(`+i+"TexShape[0], "+i+"TexShape[1], "+p+`);
      return sampleTexture(`+i+`, uv);
    }
  `;const[_,g]=l.shapeInfo.texShape;return`
    float `+s+`() {
      vec2 uv = uvFromFlat(`+_+", "+g+", "+p+`);
      return sampleTexture(`+i+`, uv);
    }
  `}function s3(l,e){const i=l.name,s="get"+i.charAt(0).toUpperCase()+i.slice(1),n=l.shapeInfo.texShape,a=Tn();if(e)return`
    vec4 `+s+`(int index) {
      ivec2 packedTexShape = ivec2(ceil(float(`+i+"TexShape[0]) / 2.0), ceil(float("+i+`TexShape[1]) / 2.0));
      vec2 uv = packedUVfrom1D(
        packedTexShape[0], packedTexShape[1], index);
      return `+a.texture2D+"("+i+`, uv);
    }
  `;const p=[Math.ceil(n[0]/2),Math.ceil(n[1]/2)];return`
    vec4 `+s+`(int index) {
      vec2 uv = packedUVfrom1D(
        `+p[0]+", "+p[1]+`, index);
      return `+a.texture2D+"("+i+`, uv);
    }
  `}function n3(l,e){const i=l.name,s="get"+i.charAt(0).toUpperCase()+i.slice(1);if(l.shapeInfo.isUniform)return`
      float `+s+`(int index) {
        `+ac(l)+`
      }
    `;const n=l.shapeInfo.texShape,a=n[0],p=n[1];if(p===1&&a===1)return`
      float `+s+`(int index) {
        return sampleTexture(`+i+`, halfCR);
      }
    `;const _=ol(i);return p===1?e?`
      float `+s+`(int index) {
        vec2 uv = vec2(0.5, (float(index + `+_+") + 0.5) / float("+i+`TexShape[0]));
        return sampleTexture(`+i+`, uv);
      }
    `:`
      float `+s+`(int index) {
        vec2 uv = vec2(0.5, (float(index + `+_+") + 0.5) / "+a+`.0);
        return sampleTexture(`+i+`, uv);
      }
    `:a===1?e?`
      float `+s+`(int index) {
        vec2 uv = vec2((float(index + `+_+") + 0.5) / float("+i+`TexShape[1]), 0.5);
        return sampleTexture(`+i+`, uv);
      }
    `:`
      float `+s+`(int index) {
        vec2 uv = vec2((float(index + `+_+") + 0.5) / "+p+`.0, 0.5);
        return sampleTexture(`+i+`, uv);
      }
    `:e?`
    float `+s+`(int index) {
      vec2 uv = uvFromFlat(`+i+"TexShape[0], "+i+"TexShape[1], index + "+_+`);
      return sampleTexture(`+i+`, uv);
    }
  `:`
    float `+s+`(int index) {
      vec2 uv = uvFromFlat(`+a+", "+p+", index + "+_+`);
      return sampleTexture(`+i+`, uv);
    }
  `}function a3(l,e){const i=l.shapeInfo.logicalShape,s=l.name,n="get"+s.charAt(0).toUpperCase()+s.slice(1),a=l.shapeInfo.texShape,p=a[0],_=a[1],g=Tn();if(a!=null&&qt(i,a))return e?`
      vec4 `+n+`(int row, int col) {
        vec2 uv = (vec2(col, row) + halfCR) / vec2(`+s+"TexShape[1], "+s+`TexShape[0]);

        return `+g.texture2D+"("+s+`, uv);
      }
    `:`
      vec4 `+n+`(int row, int col) {
        vec2 uv = (vec2(col, row) + halfCR) / vec2(`+_+".0, "+p+`.0);

        return `+g.texture2D+"("+s+`, uv);
      }
    `;if(e)return`
    vec4 `+n+`(int row, int col) {
      ivec2 packedTexShape = ivec2(ceil(float(`+s+"TexShape[0]) / 2.0), ceil(float("+s+`TexShape[1]) / 2.0));
      int valuesPerRow = int(ceil(float(`+s+`Shape[1]) / 2.0));
      vec2 uv = packedUVfrom2D(valuesPerRow, packedTexShape[0], packedTexShape[1], row, col);
      return `+g.texture2D+"("+s+`, uv);
    }
  `;const y=[Math.ceil(a[0]/2),Math.ceil(a[1]/2)],b=Math.ceil(i[1]/2);return`
    vec4 `+n+`(int row, int col) {
      vec2 uv = packedUVfrom2D(`+b+", "+y[0]+", "+y[1]+`, row, col);
      return `+g.texture2D+"("+s+`, uv);
    }
  `}function o3(l,e){const i=l.shapeInfo.logicalShape,s=l.name,n="get"+s.charAt(0).toUpperCase()+s.slice(1),a=l.shapeInfo.texShape;if(a!=null&&qt(i,a)){if(e)return`
      float `+n+`(int row, int col) {
        vec2 uv = (vec2(col, row) + halfCR) / vec2(`+s+"TexShape[1], "+s+`TexShape[0]);
        return sampleTexture(`+s+`, uv);
      }
    `;const S=a[0],M=a[1];return`
    float `+n+`(int row, int col) {
      vec2 uv = (vec2(col, row) + halfCR) / vec2(`+M+".0, "+S+`.0);
      return sampleTexture(`+s+`, uv);
    }
  `}const{newShape:p,keptDims:_}=ct(i),g=p;if(g.length<i.length){const S=oc(l,g),M=["row","col"];return`
      `+nc(S,e)+`
      float `+n+`(int row, int col) {
        return `+n+"("+xc(M,_)+`);
      }
    `}if(l.shapeInfo.isUniform)return`
      float `+n+`(int row, int col) {
        int index = round(dot(vec2(row, col), vec2(`+i[1]+`, 1)));
        `+ac(l)+`
      }
    `;const y=a[0],b=a[1],v=ol(s);return b===1?e?`
      float `+n+`(int row, int col) {
        float index = dot(vec3(row, col, `+v+"), vec3("+s+`Shape[1], 1, 1));
        vec2 uv = vec2(0.5, (index + 0.5) / float(`+s+`TexShape[0]));
        return sampleTexture(`+s+`, uv);
      }
    `:`
    float `+n+`(int row, int col) {
      float index = dot(vec3(row, col, `+v+"), vec3("+i[1]+`, 1, 1));
      vec2 uv = vec2(0.5, (index + 0.5) / `+y+`.0);
      return sampleTexture(`+s+`, uv);
    }
  `:y===1?e?`
      float `+n+`(int row, int col) {
        float index = dot(vec3(row, col, `+v+"), vec3("+s+`Shape[1], 1, 1));
        vec2 uv = vec2((index + 0.5) / float(`+s+`TexShape[1]), 0.5);
        return sampleTexture(`+s+`, uv);
      }
    `:`
    float `+n+`(int row, int col) {
      float index = dot(vec3(row, col, `+v+"), vec3("+i[1]+`, 1, 1));
      vec2 uv = vec2((index + 0.5) / `+b+`.0, 0.5);
      return sampleTexture(`+s+`, uv);
    }
  `:e?`
      float `+n+`(int row, int col) {
        // Explicitly use integer operations as dot() only works on floats.
        int index = row * `+s+"Shape[1] + col + "+v+`;
        vec2 uv = uvFromFlat(`+s+"TexShape[0], "+s+`TexShape[1], index);
        return sampleTexture(`+s+`, uv);
      }
    `:`
  float `+n+`(int row, int col) {
    // Explicitly use integer operations as dot() only works on floats.
    int index = row * `+i[1]+" + col + "+v+`;
    vec2 uv = uvFromFlat(`+y+", "+b+`, index);
    return sampleTexture(`+s+`, uv);
  }
`}function x3(l,e){const i=l.shapeInfo.logicalShape,s=l.name,n="get"+s.charAt(0).toUpperCase()+s.slice(1),a=l.shapeInfo.texShape,p=[Math.ceil(a[0]/2),Math.ceil(a[1]/2)];if(i[0]===1){const S=i.slice(1),M=[1,2],F=oc(l,S),L=["b","row","col"];return`
        `+dv(F,e)+`
        vec4 `+n+`(int b, int row, int col) {
          return `+n+"("+xc(L,M)+`);
        }
      `}const _=Tn();if(e)return`
    vec4 `+n+`(int b, int row, int col) {
      ivec2 packedTexShape = ivec2(ceil(float(`+s+"TexShape[0]) / 2.0), ceil(float("+s+`TexShape[1]) / 2.0));
      int valuesPerRow = int(ceil(float(`+s+`Shape[2]) / 2.0));
      int texelsInBatch = valuesPerRow * int(ceil(float(`+s+`Shape[1]) / 2.0));
      vec2 uv = packedUVfrom3D(
        packedTexShape[0], packedTexShape[1], texelsInBatch, valuesPerRow, b, row, col);
      return `+_.texture2D+"("+s+`, uv);
    }
  `;const g=p[0],y=p[1],b=Math.ceil(i[2]/2),v=b*Math.ceil(i[1]/2);return`
    vec4 `+n+`(int b, int row, int col) {
      vec2 uv = packedUVfrom3D(
        `+g+", "+y+", "+v+", "+b+`, b, row, col);
      return `+_.texture2D+"("+s+`, uv);
    }
  `}function l3(l,e){const i=l.shapeInfo.logicalShape,s=l.name,n="get"+s.charAt(0).toUpperCase()+s.slice(1),a=i[1]*i[2],p=i[2],{newShape:_,keptDims:g}=ct(i),y=_;if(y.length<i.length){const L=oc(l,y),N=["row","col","depth"];return`
        `+nc(L,e)+`
        float `+n+`(int row, int col, int depth) {
          return `+n+"("+xc(N,g)+`);
        }
      `}if(l.shapeInfo.isUniform)return`
      float `+n+`(int row, int col, int depth) {
        int index = round(dot(vec3(row, col, depth),
                          vec3(`+a+", "+p+`, 1)));
        `+ac(l)+`
      }
    `;const b=l.shapeInfo.texShape,v=b[0],S=b[1],M=l.shapeInfo.flatOffset;if(S===a&&M==null)return e?`
      float `+n+`(int row, int col, int depth) {
        int stride1 = `+s+`Shape[2];
        float texR = float(row);
        float texC = dot(vec2(col, depth), vec2(stride1, 1));
        vec2 uv = (vec2(texC, texR) + halfCR) /
                   vec2(`+s+"TexShape[1], "+s+`TexShape[0]);
        return sampleTexture(`+s+`, uv);
      }
    `:`
        float `+n+`(int row, int col, int depth) {
          float texR = float(row);
          float texC = dot(vec2(col, depth), vec2(`+p+`, 1));
          vec2 uv = (vec2(texC, texR) + halfCR) /
                     vec2(`+S+".0, "+v+`.0);
          return sampleTexture(`+s+`, uv);
        }
      `;if(S===p&&M==null)return e?`
      float `+n+`(int row, int col, int depth) {
        float texR = dot(vec2(row, col), vec2(`+s+`Shape[1], 1));
        float texC = float(depth);
        vec2 uv = (vec2(texC, texR) + halfCR) / vec2(`+s+"TexShape[1], "+s+`TexShape[0]);
        return sampleTexture(`+s+`, uv);
      }
    `:`
    float `+n+`(int row, int col, int depth) {
      float texR = dot(vec2(row, col), vec2(`+i[1]+`, 1));
      float texC = float(depth);
      vec2 uv = (vec2(texC, texR) + halfCR) / vec2(`+S+".0, "+v+`.0);
      return sampleTexture(`+s+`, uv);
    }
  `;const F=ol(s);return e?`
    float `+n+`(int row, int col, int depth) {
      // Explicitly use integer operations as dot() only works on floats.
      int stride0 = `+s+"Shape[1] * "+s+`Shape[2];
      int stride1 = `+s+`Shape[2];
      int index = row * stride0 + col * stride1 + depth + `+F+`;
      vec2 uv = uvFromFlat(`+s+"TexShape[0], "+s+`TexShape[1], index);
      return sampleTexture(`+s+`, uv);
    }
    `:`
      float `+n+`(int row, int col, int depth) {
        // Explicitly use integer operations as dot() only works on floats.
        int index = row * `+a+" + col * "+p+" + depth + "+F+`;
        vec2 uv = uvFromFlat(`+v+", "+S+`, index);
        return sampleTexture(`+s+`, uv);
      }
  `}function c3(l,e){const i=l.name,s="get"+i.charAt(0).toUpperCase()+i.slice(1),n=Tn();if(e)return`
    vec4 `+s+`(int b2, int b, int row, int col) {
      int valuesPerRow = int(ceil(float(`+i+`Shape[3]) / 2.0));
      int texelsInBatch = valuesPerRow * int(ceil(float(`+i+`Shape[2]) / 2.0));
      int index = b * texelsInBatch + (row / 2) * valuesPerRow + (col / 2);
      texelsInBatch *= `+i+`Shape[1];
      index = b2 * texelsInBatch + index;
      ivec2 packedTexShape = ivec2(ceil(float(`+i+"TexShape[0]) / 2.0), ceil(float("+i+`TexShape[1]) / 2.0));
      int texR = index / packedTexShape[1];
      int texC = index - texR * packedTexShape[1];
      vec2 uv = (vec2(texC, texR) + halfCR) / vec2(packedTexShape[1], packedTexShape[0]); return `+n.texture2D+"("+i+`, uv);
    }
  `;const a=l.shapeInfo.logicalShape,p=a.length,_=l.shapeInfo.texShape,g=[Math.ceil(_[0]/2),Math.ceil(_[1]/2)],y=g[0],b=g[1],v=Math.ceil(a[p-1]/2);let S=v*Math.ceil(a[p-2]/2),M="int b, int row, int col",F="b * "+S+" + (row / 2) * "+v+" + (col / 2)";for(let L=2;L<p-1;L++)M="int b"+L+", "+M,S*=a[p-L-1],F="b"+L+" * "+S+" + "+F;return`
    vec4 `+s+"("+M+`) {
      int index = `+F+`;
      int texR = index / `+b+`;
      int texC = index - texR * `+b+`;
      vec2 uv = (vec2(texC, texR) + halfCR) / vec2(`+b+", "+y+`);
      return `+n.texture2D+"("+i+`, uv);
    }
  `}function h3(l,e){const i=l.shapeInfo.logicalShape,s=l.name,n="get"+s.charAt(0).toUpperCase()+s.slice(1),a=i[3],p=i[2]*a,_=i[1]*p,{newShape:g,keptDims:y}=ct(i);if(g.length<i.length){const G=oc(l,g),H=["row","col","depth","depth2"];return`
      `+nc(G,e)+`
      float `+n+`(int row, int col, int depth, int depth2) {
        return `+n+"("+xc(H,y)+`);
      }
    `}if(l.shapeInfo.isUniform)return`
      float `+n+`(int row, int col, int depth, int depth2) {
        int index = round(dot(vec4(row, col, depth, depth2),
                          vec4(`+_+", "+p+", "+a+`, 1)));
        `+ac(l)+`
      }
    `;const b=l.shapeInfo.flatOffset,v=l.shapeInfo.texShape,S=v[0],M=v[1],F="int stride2 = "+s+"Shape[3];",L="int stride1 = "+s+"Shape[2] * stride2;",N="int stride0 = "+s+"Shape[1] * stride1;";if(M===_&&b==null)return e?`
      float `+n+`(int row, int col, int depth, int depth2) {
        `+F+`
        `+L+`
        float texR = float(row);
        float texC =
            dot(vec3(col, depth, depth2),
                vec3(stride1, stride2, 1));
        vec2 uv = (vec2(texC, texR) + halfCR) /
                   vec2(`+s+"TexShape[1], "+s+`TexShape[0]);
        return sampleTexture(`+s+`, uv);
      }
    `:`
      float `+n+`(int row, int col, int depth, int depth2) {
        float texR = float(row);
        float texC =
            dot(vec3(col, depth, depth2),
                vec3(`+p+", "+a+`, 1));
        vec2 uv = (vec2(texC, texR) + halfCR) /
                   vec2(`+M+".0, "+S+`.0);
        return sampleTexture(`+s+`, uv);
      }
    `;if(M===a&&b==null)return e?`
      float `+n+`(int row, int col, int depth, int depth2) {
        float texR = dot(vec3(row, col, depth),
                         vec3(`+s+"Shape[1] * "+s+"Shape[2], "+s+`Shape[2], 1));
        float texC = float(depth2);
        vec2 uv = (vec2(texC, texR) + halfCR) /
                  vec2(`+s+"TexShape[1], "+s+`TexShape[0]);
        return sampleTexture(`+s+`, uv);
      }
    `:`
      float `+n+`(int row, int col, int depth, int depth2) {
        float texR = dot(vec3(row, col, depth),
                         vec3(`+i[1]*i[2]+", "+i[2]+`, 1));
        float texC = float(depth2);
        vec2 uv = (vec2(texC, texR) + halfCR) /
                  vec2(`+M+".0, "+S+`.0);
        return sampleTexture(`+s+`, uv);
      }
    `;const k=ol(s);return e?`
    float `+n+`(int row, int col, int depth, int depth2) {
      // Explicitly use integer operations as dot() only works on floats.
      `+F+`
      `+L+`
      `+N+`
      int index = row * stride0 + col * stride1 +
          depth * stride2 + depth2;
      vec2 uv = uvFromFlat(`+s+"TexShape[0], "+s+"TexShape[1], index + "+k+`);
      return sampleTexture(`+s+`, uv);
    }
  `:`
    float `+n+`(int row, int col, int depth, int depth2) {
      // Explicitly use integer operations as dot() only works on floats.
      int index = row * `+_+" + col * "+p+` +
          depth * `+a+` + depth2;
      vec2 uv = uvFromFlat(`+S+", "+M+", index + "+k+`);
      return sampleTexture(`+s+`, uv);
    }
  `}function u3(l){const e=l.shapeInfo.logicalShape,i=l.name,s="get"+i.charAt(0).toUpperCase()+i.slice(1),n=e[4],a=e[3]*n,p=e[2]*a,_=e[1]*p,{newShape:g,keptDims:y}=ct(e);if(g.length<e.length){const L=oc(l,g),N=["row","col","depth","depth2","depth3"];return`
      `+nc(L)+`
      float `+s+`(int row, int col, int depth, int depth2, int depth3) {
        return `+s+"("+xc(N,y)+`);
      }
    `}if(l.shapeInfo.isUniform)return`
      float `+s+`(int row, int col, int depth, int depth2, int depth3) {
        float index = dot(
          vec4(row, col, depth, depth2),
          vec4(`+_+", "+p+", "+a+", "+n+`)) +
          depth3;
        `+ac(l)+`
      }
    `;const b=l.shapeInfo.flatOffset,v=l.shapeInfo.texShape,S=v[0],M=v[1];if(M===_&&b==null)return`
      float `+s+`(int row, int col, int depth, int depth2, int depth3) {
        int texR = row;
        float texC = dot(vec4(col, depth, depth2, depth3),
                         vec4(`+p+", "+a+", "+n+`, 1));
        vec2 uv = (vec2(texC, texR) + halfCR) /
                   vec2(`+M+".0, "+S+`.0);
        return sampleTexture(`+i+`, uv);
      }
    `;if(M===n&&b==null)return`
      float `+s+`(int row, int col, int depth, int depth2, int depth3) {
        float texR = dot(
          vec4(row, col, depth, depth2),
          vec4(`+e[1]*e[2]*e[3]+`,
               `+e[2]*e[3]+", "+e[3]+`, 1));
        int texC = depth3;
        vec2 uv = (vec2(texC, texR) + halfCR) /
                  vec2(`+M+".0, "+S+`.0);
        return sampleTexture(`+i+`, uv);
      }
    `;const F=ol(i);return`
    float `+s+`(int row, int col, int depth, int depth2, int depth3) {
      // Explicitly use integer operations as dot() only works on floats.
      int index = row * `+_+" + col * "+p+" + depth * "+a+` +
          depth2 * `+n+" + depth3 + "+F+`;
      vec2 uv = uvFromFlat(`+S+", "+M+`, index);
      return sampleTexture(`+i+`, uv);
    }
  `}function d3(l){const e=l.shapeInfo.logicalShape,i=l.name,s="get"+i.charAt(0).toUpperCase()+i.slice(1),{newShape:n,keptDims:a}=ct(e);if(n.length<e.length){const N=oc(l,n),k=["row","col","depth","depth2","depth3","depth4"];return`
      `+nc(N)+`
      float `+s+`(int row, int col, int depth,
                    int depth2, int depth3, int depth4) {
        return `+s+"("+xc(k,a)+`);
      }
    `}const p=e[5],_=e[4]*p,g=e[3]*_,y=e[2]*g,b=e[1]*y;if(l.shapeInfo.isUniform)return`
      float `+s+`(int row, int col, int depth,
                  int depth2, int depth3, int depth4) {
        int index = round(dot(
          vec4(row, col, depth, depth2),
          vec4(`+b+", "+y+", "+g+", "+_+`)) +
          dot(
            vec2(depth3, depth4),
            vec2(`+p+`, 1)));
        `+ac(l)+`
      }
    `;const v=l.shapeInfo.flatOffset,S=l.shapeInfo.texShape,M=S[0],F=S[1];if(F===b&&v==null)return`
      float `+s+`(int row, int col, int depth,
                    int depth2, int depth3, int depth4) {
        int texR = row;
        float texC = dot(vec4(col, depth, depth2, depth3),
          vec4(`+y+", "+g+", "+_+", "+p+`)) +
               float(depth4);
        vec2 uv = (vec2(texC, texR) + halfCR) /
                   vec2(`+F+".0, "+M+`.0);
        return sampleTexture(`+i+`, uv);
      }
    `;if(F===p&&v==null)return`
      float `+s+`(int row, int col, int depth,
                    int depth2, int depth3, int depth4) {
        float texR = dot(vec4(row, col, depth, depth2),
          vec4(`+e[1]*e[2]*e[3]*e[4]+`,
               `+e[2]*e[3]*e[4]+`,
               `+e[3]*e[4]+`,
               `+e[4]+`)) + float(depth3);
        int texC = depth4;
        vec2 uv = (vec2(texC, texR) + halfCR) /
                  vec2(`+F+".0, "+M+`.0);
        return sampleTexture(`+i+`, uv);
      }
    `;const L=ol(i);return`
    float `+s+`(int row, int col, int depth,
                  int depth2, int depth3, int depth4) {
      // Explicitly use integer operations as dot() only works on floats.
      int index = row * `+b+" + col * "+y+" + depth * "+g+` +
          depth2 * `+_+" + depth3 * "+p+" + depth4 + "+L+`;
      vec2 uv = uvFromFlat(`+M+", "+F+`, index);
      return sampleTexture(`+i+`, uv);
    }
  `}function ac(l){const e=l.name,i=Je(l.shapeInfo.logicalShape);return i<2?"return "+e+";":`
    for (int i = 0; i < `+i+`; i++) {
      if (i == index) {
        return `+e+`[i];
      }
    }
  `}function f3(l,e){const i=l.name,s=i.charAt(0).toUpperCase()+i.slice(1),n="get"+s+"AtOutCoords",a=l.shapeInfo.logicalShape.length,p=e.logicalShape.length,_=uv(l.shapeInfo.logicalShape,e.logicalShape),g=En(p),y=p-a;let b;const v=["x","y","z","w","u","v"];a===0?b="":p<2&&_.length>=1?b="coords = 0;":b=_.map(N=>"coords."+v[N+y]+" = 0;").join(`
`);let S="";p<2&&a>0?S="coords":S=l.shapeInfo.logicalShape.map((N,k)=>"coords."+v[k+y]).join(", ");let M="return outputValue;";const F=Je(l.shapeInfo.logicalShape)===1,L=Je(e.logicalShape)===1;if(a===1&&!F&&!L)M=`
      return vec4(outputValue.xy, outputValue.xy);
    `;else if(F&&!L)p===1?M=`
        return vec4(outputValue.x, outputValue.x, 0., 0.);
      `:M=`
        return vec4(outputValue.x);
      `;else if(_.length){const N=a-2,k=a-1;_.indexOf(N)>-1&&_.indexOf(k)>-1?M="return vec4(outputValue.x);":_.indexOf(N)>-1?M="return vec4(outputValue.x, outputValue.y, outputValue.x, outputValue.y);":_.indexOf(k)>-1&&(M="return vec4(outputValue.xx, outputValue.zz);")}return`
    vec4 `+n+`() {
      `+g+` coords = getOutputCoords();
      `+b+`
      vec4 outputValue = get`+s+"("+S+`);
      `+M+`
    }
  `}function p3(l,e){const i=l.name,s=i.charAt(0).toUpperCase()+i.slice(1),n="get"+s+"AtOutCoords",a=e.texShape,p=l.shapeInfo.texShape,_=l.shapeInfo.logicalShape.length,g=e.logicalShape.length;if(!l.shapeInfo.isUniform&&_===g&&l.shapeInfo.flatOffset==null&&qt(p,a))return`
      float `+n+`() {
        return sampleTexture(`+i+`, resultUV);
      }
    `;const y=En(g),b=uv(l.shapeInfo.logicalShape,e.logicalShape),v=g-_;let S;const M=["x","y","z","w","u","v"];_===0?S="":g<2&&b.length>=1?S="coords = 0;":S=b.map(L=>"coords."+M[L+v]+" = 0;").join(`
`);let F="";return g<2&&_>0?F="coords":F=l.shapeInfo.logicalShape.map((L,N)=>"coords."+M[N+v]).join(", "),`
    float `+n+`() {
      `+y+` coords = getOutputCoords();
      `+S+`
      return get`+s+"("+F+`);
    }
  `}function En(l){if(l<=1)return"int";if(l===2)return"ivec2";if(l===3)return"ivec3";if(l===4)return"ivec4";if(l===5)return"ivec5";if(l===6)return"ivec6";throw Error("GPU for rank "+l+" is not yet supported")}function xm(l,e,i){const{newShape:s,keptDims:n}=ct(e),a=e.length,p=l&&a===3&&e[0]===1,_=p?e.slice(1):s,g=!l&&a>1&&!qt(e,i)&&s.length<a||p;return{useSqueezeShape:g,uniformShape:g?_:e,keptDims:n}}function oc(l,e){const i=JSON.parse(JSON.stringify(l));return i.shapeInfo.logicalShape=e,i}function xc(l,e){return e.map(i=>l[i]).join(", ")}function m3(l,e,i,s){const n=i.map((b,v)=>{const S={logicalShape:b.shape,texShape:b.isUniform?null:b.texData.texShape,isUniform:b.isUniform,isPacked:b.isUniform?!1:b.texData.isPacked,flatOffset:null};return b.texData!=null&&b.texData.slice!=null&&b.texData.slice.flatOffset>0&&(S.flatOffset=b.texData.slice.flatOffset),{name:e.variableNames[v],shapeInfo:S}}),a=n.map(b=>b.shapeInfo),p={logicalShape:s.shape,texShape:s.texData.texShape,isUniform:!1,isPacked:s.texData.isPacked,flatOffset:null},_=FB(n,p,e),g=lB(l.gl,_),y=l.createProgram(g);return Ue().get("ENGINE_COMPILE_ONLY")?{program:e,fragmentShader:g,source:_,webGLProgram:y,inShapeInfos:a,outShapeInfo:p,variablesLocations:null,customUniformLocations:null,infLoc:null,nanLoc:null,outShapeLocation:null,outShapeStridesLocation:null,outTexShapeLocation:null}:(l.buildVao(y),Object.assign({program:e,fragmentShader:g,source:_,webGLProgram:y,inShapeInfos:a,outShapeInfo:p},pv(l,e,y)))}function pv(l,e,i){const s=[],n=[];let a,p,_,g=null,y=null;y=l.getUniformLocation(i,"NAN",!1),Ue().getNumber("WEBGL_VERSION")===1&&(g=l.getUniformLocation(i,"INFINITY",!1));const b=!1;for(const v of e.variableNames){const S={name:v,uniform:l.getUniformLocation(i,v,b),offset:l.getUniformLocation(i,"offset"+v,b)};e.enableShapeUniforms&&(S.shape=l.getUniformLocation(i,v+"Shape",b),S.texShape=l.getUniformLocation(i,v+"TexShape",b)),s.push(S)}if(e.enableShapeUniforms&&(a=l.getUniformLocation(i,"outShape",b),_=l.getUniformLocation(i,"outShapeStrides",b),p=l.getUniformLocation(i,"outTexShape",b)),e.customUniforms)for(const v of e.customUniforms)n.push(l.getUniformLocation(i,v.name,b));return{variablesLocations:s,customUniformLocations:n,infLoc:g,nanLoc:y,outShapeLocation:a,outShapeStridesLocation:_,outTexShapeLocation:p}}function mv(l,e){if(l.length!==e.length)throw Error("Binary was compiled with "+l.length+" inputs, but was executed with "+e.length+" inputs");l.forEach((i,s)=>{const n=i.logicalShape,a=e[s],p=a.shape;if(!qt(n,p))throw Error("Binary was compiled with different shapes than the current args. Shapes "+n+" and "+p+" must match");if(i.isUniform&&a.isUniform)return;const _=i.texShape,g=a.isUniform?null:a.texData.texShape;if(!qt(_,g))throw Error("Binary was compiled with different texture shapes than the current args. Shape "+_+" and "+g+" must match")})}function _3(l,e,i,s,n){e.program.enableShapeUniforms||(mv(e.inShapeInfos,i),mv([e.outShapeInfo],[s]));const a=s.texData.texture,p=s.texData.texShape;s.texData.isPacked?l.setOutputPackedMatrixTexture(a.texture,p[0],p[1]):l.setOutputMatrixTexture(a.texture,p[0],p[1]),l.setProgram(e.webGLProgram),l.bindVertexArray(e.webGLProgram.vao),Ue().getNumber("WEBGL_VERSION")===1&&e.infLoc!==null&&l.gl.uniform1f(e.infLoc,1/0),e.nanLoc!==null&&l.gl.uniform1f(e.nanLoc,NaN);for(let g=0;g<i.length;++g){const y=i[g],{uniform:b,offset:v,shape:S,texShape:M}=e.variablesLocations[g];if(S){const{uniformShape:F}=xm(e.program.packedInputs,y.shape,y.texData.texShape);switch(F.length){case 1:l.gl.uniform1iv(S,new Int32Array(F));break;case 2:l.gl.uniform2iv(S,new Int32Array(F));break;case 3:l.gl.uniform3iv(S,new Int32Array(F));break;case 4:l.gl.uniform4iv(S,new Int32Array(F));break}}if(M&&l.gl.uniform2i(M,y.texData.texShape[0],y.texData.texShape[1]),b!=null){if(y.isUniform){if(Je(y.shape)<2)l.gl.uniform1f(b,y.uniformValues[0]);else{let F=y.uniformValues;F instanceof Float32Array||(F=new Float32Array(F)),l.gl.uniform1fv(b,F)}continue}y.texData.slice!=null&&v!=null&&l.gl.uniform1i(v,y.texData.slice.flatOffset),l.setInputMatrixTexture(y.texData.texture.texture,b,g)}}const _=e.outShapeLocation;if(_)switch(s.shape.length){case 1:l.gl.uniform1iv(_,new Int32Array(s.shape));break;case 2:l.gl.uniform2iv(_,new Int32Array(s.shape));break;case 3:l.gl.uniform3iv(_,new Int32Array(s.shape));break;case 4:l.gl.uniform4iv(_,new Int32Array(s.shape));break}if(e.outShapeStridesLocation){const g=Ni(s.shape);switch(s.shape.length){case 2:l.gl.uniform1iv(e.outShapeStridesLocation,new Int32Array(g));break;case 3:l.gl.uniform2iv(e.outShapeStridesLocation,new Int32Array(g));break;case 4:l.gl.uniform3iv(e.outShapeStridesLocation,new Int32Array(g));break}}if(e.outTexShapeLocation&&l.gl.uniform2i(e.outTexShapeLocation,s.texData.texShape[0],s.texData.texShape[1]),e.program.customUniforms&&n)for(let g=0;g<e.program.customUniforms.length;++g){const y=e.program.customUniforms[g],b=e.customUniformLocations[g],v=n[g];if(y.type==="float")l.gl.uniform1fv(b,v);else if(y.type==="vec2")l.gl.uniform2fv(b,v);else if(y.type==="vec3")l.gl.uniform3fv(b,v);else if(y.type==="vec4")l.gl.uniform4fv(b,v);else if(y.type==="int")l.gl.uniform1iv(b,v);else if(y.type==="ivec2")l.gl.uniform2iv(b,v);else if(y.type==="ivec3")l.gl.uniform3iv(b,v);else if(y.type==="ivec4")l.gl.uniform4iv(b,v);else throw Error("uniform type "+y.type+" is not supported yet.")}l.executeProgram()}function g3(l,e,i){let s="";e.concat(i).forEach(p=>{const _=p.texData!=null&&p.texData.slice!=null&&p.texData.slice.flatOffset>0;if(l.enableShapeUniforms&&!p.isUniform){const g=p.texData.texShape,{useSqueezeShape:y,uniformShape:b,keptDims:v}=xm(l.packedInputs,p.shape,g);let S="",M="",F="";if(b.length===1&&l.packedInputs){const W=[Math.ceil(g[0]/2),Math.ceil(g[1]/2)];S=(W[0]>1)+"_"+(W[1]>1)}else if(b.length===2&&!l.packedInputs)M=(b[0]>1)+"_"+(b[1]>1);else if(b.length>2&&!l.packedInputs){const W=Ni(b);F=(W[0]===g[1])+"_"+(W[W.length-1]===g[1])}const L=p.shape.length,N=b.length===2&&qt(p.shape,g),k=Je(p.shape)===1,G=Kl(p.shape,i.shape),H=!l.packedInputs&&L===i.shape.length&&qt(g,i.texData.texShape),z=l.packedInputs||b.length>2?"":(g[0]>1)+"_"+(g[1]>1);s+=L+"_"+H+"_"+(y?v:"")+"_"+b.length+"_"+k+"_"+G+"_"+N+"_"+S+"_"+M+"_"+F+"_"+z+"_"+_}else{const g=p.isUniform?"uniform":p.texData.texShape;s+=p.shape+"_"+g+"_"+_}});const n=l.userCode;let a=l.constructor.name;return a+="_"+s+"_"+n+(""+Ue().getNumber("WEBGL_VERSION")),a}function An(l){return Ue().getBool("WEBGL_USE_SHAPES_UNIFORMS")&&l<=4}class y3{constructor(e){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.outPackingScheme=Th.DENSE,this.customUniforms=[{name:"texShape",type:"ivec2"}];const i=Tn();this.outputShape=e,this.enableShapeUniforms=An(this.outputShape.length),this.userCode=`
      ivec3 outCoordsFromFlatIndex(int index) {
        `+(this.enableShapeUniforms?qd(["r","c","d"],e):al(["r","c","d"],e))+`
        return ivec3(r, c, d);
      }

      void main() {
        ivec2 resTexRC = ivec2(resultUV.yx * vec2(texShape[0], texShape[1]));
        int index = 4 * (resTexRC.x * texShape[1] + resTexRC.y);

        vec4 result = vec4(0.);

        for (int i=0; i<4; i++) {
          int flatIndex = index + i;
          ivec3 rc = outCoordsFromFlatIndex(flatIndex);
          result[i] = getA(rc.x, rc.y, rc.z);
        }

        `+i.output+` = result;
      }
    `}}class b3{constructor(e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outPackingScheme=Th.DENSE,this.customUniforms=[{name:"texShape",type:"ivec2"}];const i=Tn();this.outputShape=e,this.enableShapeUniforms=An(this.outputShape.length),this.userCode=`
      ivec3 outCoordsFromFlatIndex(int index) {
        `+(this.enableShapeUniforms?qd(["r","c","d"],e):al(["r","c","d"],e))+`
        return ivec3(r, c, d);
      }

      void main() {
        ivec2 resTexRC = ivec2(resultUV.yx * vec2(texShape[0], texShape[1]));
        int index = 4 * (resTexRC.x * texShape[1] + resTexRC.y);

        vec4 result = vec4(0.);

        for (int i=0; i<4; i++) {
          int flatIndex = index + i;
          ivec3 rc = outCoordsFromFlatIndex(flatIndex);
          result[i] = getChannel(getA(rc.x, rc.y, rc.z), vec2(rc.y, rc.z));
        }

        `+i.output+` = result;
      }
    `}}class v3{constructor(e){this.variableNames=["A"],this.outTexUsage=ma.DOWNLOAD;const i=Tn();this.outputShape=e,this.userCode=`
      `+hv+`

      void main() {
        float x = getAAtOutCoords();
        `+i.output+` = encode_float(x);
      }
    `}}class T3{constructor(e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1,this.outTexUsage=ma.DOWNLOAD;const i=Tn();this.outputShape=e,this.userCode=`
      `+hv+`

      void main() {
        ivec3 coords = getOutputCoords();
        float x = getChannel(getAAtOutCoords(), vec2(coords.y, coords.z));
        `+i.output+` = encode_float(x);
      }
    `}}const E3={R:0,G:1,B:2,A:3};class _v{constructor(e,i=!1,s="RGBA"){this.variableNames=["A"],this.customUniforms=[{name:"texShape",type:"ivec2"}];const n=Tn();this.outputShape=e,this.enableShapeUniforms=An(this.outputShape.length);let a="result";i&&(a="floor(result * 255. + 0.5)");let p="";for(let _=0;_<s.length;_++){const g=s[_];p+=`
          if(offset == `+_+`) {
            result = values[`+E3[g]+`];
          }`}this.userCode=`
      `+(this.enableShapeUniforms?om():am(e))+`

      void main() {
        ivec3 coords = getOutputCoords();
        int flatIndex = getFlatIndex(coords);
        float result = 0.;
        int offset = imod(flatIndex, `+s.length+`);

        flatIndex = idiv(flatIndex, `+s.length+`, 1.);

        int r = flatIndex / texShape[1];
        if (r < texShape[0]) {
          int c = imod(flatIndex, texShape[1]);
          vec2 uv = (vec2(c, r) + halfCR) / vec2(texShape[1], texShape[0]);
          vec4 values = `+n.texture2D+`(A, uv);
          `+p+`
        }
        `+n.output+" = vec4("+a+`, 0., 0., 0.);
      }
    `}}class A3{constructor(e,i=!1){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.customUniforms=[{name:"texShape",type:"ivec2"}];const s=Tn();this.outputShape=e,this.enableShapeUniforms=An(this.outputShape.length);let n="",a="result";i&&(a="floor(result * 255. + 0.5)");for(let p=0;p<=1;p++)for(let _=0;_<=1;_++){const g=p*2+_;n+=`
          localCoords = coords;
          if(localCoords[2] + `+_+" < "+(this.enableShapeUniforms?"outShape[2]":""+e[2])+`) {
          localCoords[2] += `+_+`;
          if (localCoords[1] + `+p+" < "+(this.enableShapeUniforms?"outShape[1]":""+e[1])+`) {
            localCoords[1] += `+p+`;

            flatIndex = getFlatIndex(localCoords);
            offset = imod(flatIndex, 4);

            flatIndex = idiv(flatIndex, 4, 1.);

            int r = flatIndex / texShape[1];
            int c = imod(flatIndex, texShape[1]);
            vec2 uv = (vec2(c, r) + halfCR) / vec2(texShape[1], texShape[0]);
            values = `+s.texture2D+`(A, uv);

            if (offset == 0) {
              result[`+g+`] = values[0];
            } else if (offset == 1) {
              result[`+g+`] = values[1];
            } else if (offset == 2) {
              result[`+g+`] = values[2];
            } else {
              result[`+g+`] = values[3];
            }
          }
        }
        `}this.userCode=`
        `+(this.enableShapeUniforms?om():am(e))+`

        void main() {
          ivec3 coords = getOutputCoords();

          vec4 result = vec4(0.);
          int flatIndex, r, c, offset;
          ivec3 localCoords;
          vec2 uv;
          vec4 values;

          `+n+`

          `+s.output+" = "+a+`;
        }
    `}}function C3(l){const e=Tn(),i=e.version+`
    precision highp float;
    `+e.attribute+` vec3 clipSpacePos;
    `+e.attribute+` vec2 uv;
    `+e.varyingVs+` vec2 resultUV;

    void main() {
      gl_Position = vec4(clipSpacePos, 1);
      resultUV = uv;
    }`;return xB(l,i)}function R3(l){const e=new Float32Array([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0]);return dB(l,e)}function I3(l){const e=new Uint16Array([0,1,2,2,1,3]);return fB(l,e)}function Ah(l,e,i,s,n,a){mB(e,i);const p=pB(l),_=l.TEXTURE_2D;return Xt(l,()=>l.bindTexture(_,p)),Xt(l,()=>l.texParameteri(_,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE)),Xt(l,()=>l.texParameteri(_,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE)),Xt(l,()=>l.texParameteri(_,l.TEXTURE_MIN_FILTER,l.NEAREST)),Xt(l,()=>l.texParameteri(_,l.TEXTURE_MAG_FILTER,l.NEAREST)),Ue().getNumber("WEBGL_VERSION")===1?Xt(l,()=>l.texImage2D(_,0,s,e,i,0,n,a,null)):Xt(l,()=>l.texStorage2D(_,1,s,e,i)),Xt(l,()=>l.bindTexture(l.TEXTURE_2D,null)),{texture:p,texShape:[i,e]}}function gv(l){return l.internalFormatFloat}function S3(l,e,i,s){const[n,a]=Eh(e,i);return Ah(l,n,a,gv(s),s.textureFormatFloat,l.FLOAT)}function yv(l){return l.internalFormatHalfFloat}function M3(l,e,i,s){const[n,a]=Eh(e,i);return Ah(l,n,a,yv(s),s.textureFormatFloat,s.textureTypeHalfFloat)}function bv(l){return l.downloadTextureFormat}function P3(l,e,i,s){const[n,a]=Eh(e,i);return Ah(l,n,a,bv(s),l.RGBA,l.UNSIGNED_BYTE)}function vv(l){return l.internalFormatPackedFloat}function O3(l,e,i,s){const[n,a]=ic(e,i);return Ah(l,n,a,vv(s),l.RGBA,l.FLOAT)}function Tv(l){return l.internalFormatPackedHalfFloat}function w3(l,e,i,s){const[n,a]=ic(e,i);return Ah(l,n,a,Tv(s),l.RGBA,s.textureTypeHalfFloat)}function D3(l,e,i){return Xt(l,()=>l.bindBuffer(l.ARRAY_BUFFER,i)),ov(l,e,"clipSpacePos",i,3,20,0)&&ov(l,e,"uv",i,2,20,12)}function F3(l,e,i,s,n,a){Xt(l,()=>l.bindTexture(l.TEXTURE_2D,e));let p,_,g;n instanceof Uint8Array?(p=new Uint8Array(i*s*4),_=l.UNSIGNED_BYTE,g=l.RGBA):(p=new Float32Array(i*s*4),_=l.FLOAT,g=a.internalFormatPackedFloat),p.set(n),Ue().getNumber("WEBGL_VERSION")===2?Xt(l,()=>l.texSubImage2D(l.TEXTURE_2D,0,0,0,i,s,l.RGBA,_,p)):Xt(l,()=>l.texImage2D(l.TEXTURE_2D,0,g,i,s,0,l.RGBA,_,p)),Xt(l,()=>l.bindTexture(l.TEXTURE_2D,null))}function L3(l,e,i){Xt(l,()=>l.bindTexture(l.TEXTURE_2D,e)),i.data instanceof Uint8Array?Ue().getNumber("WEBGL_VERSION")===2?Xt(l,()=>l.texSubImage2D(l.TEXTURE_2D,0,0,0,i.width,i.height,l.RGBA,l.UNSIGNED_BYTE,i.data)):Xt(l,()=>l.texImage2D(l.TEXTURE_2D,0,l.RGBA,i.width,i.height,0,l.RGBA,l.UNSIGNED_BYTE,i.data)):Ue().getNumber("WEBGL_VERSION")===2?Xt(l,()=>l.texSubImage2D(l.TEXTURE_2D,0,0,0,l.RGBA,l.UNSIGNED_BYTE,i)):Xt(l,()=>l.texImage2D(l.TEXTURE_2D,0,l.RGBA,l.RGBA,l.UNSIGNED_BYTE,i)),Xt(l,()=>l.bindTexture(l.TEXTURE_2D,null))}function N3(l,e,i,s){const n=l.createBuffer();Xt(l,()=>l.bindBuffer(l.PIXEL_PACK_BUFFER,n));const a=4*4*e*i;return Xt(l,()=>l.bufferData(l.PIXEL_PACK_BUFFER,a,l.STREAM_READ)),Xt(l,()=>l.readPixels(0,0,i,e,l.RGBA,l.FLOAT,0)),Xt(l,()=>l.bindBuffer(l.PIXEL_PACK_BUFFER,null)),n}function B3(l,e,i){const s=l,n=new Float32Array(i);return s.bindBuffer(s.PIXEL_PACK_BUFFER,e),s.getBufferSubData(s.PIXEL_PACK_BUFFER,0,n),s.bindBuffer(s.PIXEL_PACK_BUFFER,null),n}function k3(l,e,i,s){const[n,a]=Eh(e,i),p=4,_=new Uint8Array(tB(e*i,p));return Xt(l,()=>l.readPixels(0,0,n,a,s.downloadTextureFormat,l.UNSIGNED_BYTE,_)),new Float32Array(_.buffer)}function U3(l,e,i,s,n,a,p,_){const g=l,y=new Float32Array(iB(a,p));return g.bindBuffer(g.PIXEL_PACK_BUFFER,e),g.getBufferSubData(g.PIXEL_PACK_BUFFER,0,y),g.bindBuffer(g.PIXEL_PACK_BUFFER,null),y}function V3(l,e,i){const s=new Float32Array(e*i*4);return Xt(l,()=>l.readPixels(0,0,i,e,l.RGBA,l.FLOAT,s)),s}class lm{constructor(e){this.outputTexture=null,this.program=null,this.disposed=!1,this.itemsToPoll=[];const i=Ue().getNumber("WEBGL_VERSION");if(e!=null?(this.gl=e,$N(i,e)):this.gl=go(i),e=this.gl,Ue().getNumber("WEBGL_VERSION")===2){const a=e;this.createVertexArray=()=>Xt(a,()=>a.createVertexArray()),this.bindVertexArray=p=>Xt(a,()=>a.bindVertexArray(p)),this.deleteVertexArray=p=>Xt(a,()=>a.deleteVertexArray(p)),this.getVertexArray=()=>Xt(a,()=>a.getParameter(a.VERTEX_ARRAY_BINDING))}else if(e!=null){const a=e.getExtension("OES_vertex_array_object");if(a==null)throw new Error("All WebGL1 implementations are expected to offer OES_vertex_array_object.");this.createVertexArray=()=>Xt(e,()=>a.createVertexArrayOES()),this.bindVertexArray=p=>Xt(e,()=>a.bindVertexArrayOES(p)),this.deleteVertexArray=p=>Xt(e,()=>a.deleteVertexArrayOES(p)),this.getVertexArray=()=>Xt(e,()=>e.getParameter(a.VERTEX_ARRAY_BINDING_OES))}let s="WEBGL_color_buffer_float";const n="EXT_color_buffer_half_float";if(this.parallelCompilationExtension=this.gl.getExtension("KHR_parallel_shader_compile"),Ue().getNumber("WEBGL_VERSION")===1){const a="OES_texture_float",p="OES_texture_half_float";if(this.textureFloatExtension=Hd(this.gl,a),za(this.gl,p))this.textureHalfFloatExtension=Hd(this.gl,p);else if(Ue().get("WEBGL_FORCE_F16_TEXTURES"))throw new Error("GL context does not support half float textures, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.");if(this.colorBufferFloatExtension=this.gl.getExtension(s),za(this.gl,n))this.colorBufferHalfFloatExtension=Hd(this.gl,n);else if(Ue().get("WEBGL_FORCE_F16_TEXTURES"))throw new Error("GL context does not support color renderable half floats, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.")}else if(s="EXT_color_buffer_float",za(this.gl,s))this.colorBufferFloatExtension=this.gl.getExtension(s);else if(za(this.gl,n))this.colorBufferHalfFloatExtension=this.gl.getExtension(n);else throw new Error("GL context does not support color renderable floats");this.vertexBuffer=R3(this.gl),this.indexBuffer=I3(this.gl),this.framebuffer=_B(this.gl),this.textureConfig=em(this.gl,this.textureHalfFloatExtension)}get debug(){return Ue().getBool("DEBUG")}dispose(){if(this.disposed)return;this.program!=null&&console.warn("Disposing a GPGPUContext that still has a bound WebGLProgram. This is probably a resource leak, delete the program with GPGPUContext.deleteProgram before disposing."),this.outputTexture!=null&&console.warn("Disposing a GPGPUContext that still has a bound output matrix texture.  This is probably a resource leak, delete the output matrix texture with GPGPUContext.deleteMatrixTexture before disposing.");const e=this.gl;Xt(e,()=>e.finish()),Xt(e,()=>e.bindFramebuffer(e.FRAMEBUFFER,null)),Xt(e,()=>e.deleteFramebuffer(this.framebuffer)),Xt(e,()=>e.bindBuffer(e.ARRAY_BUFFER,null)),Xt(e,()=>e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)),Xt(e,()=>e.deleteBuffer(this.indexBuffer)),this.disposed=!0}createFloat32MatrixTexture(e,i){return this.throwIfDisposed(),S3(this.gl,e,i,this.textureConfig)}createFloat16MatrixTexture(e,i){return this.throwIfDisposed(),M3(this.gl,e,i,this.textureConfig)}createUnsignedBytesMatrixTexture(e,i){return this.throwIfDisposed(),P3(this.gl,e,i,this.textureConfig)}uploadPixelDataToTexture(e,i){this.throwIfDisposed(),L3(this.gl,e,i)}uploadDenseMatrixToTexture(e,i,s,n){this.throwIfDisposed(),F3(this.gl,e,i,s,n,this.textureConfig)}createFloat16PackedMatrixTexture(e,i){return this.throwIfDisposed(),w3(this.gl,e,i,this.textureConfig)}createPackedMatrixTexture(e,i){return this.throwIfDisposed(),O3(this.gl,e,i,this.textureConfig)}deleteMatrixTexture(e){this.throwIfDisposed(),this.outputTexture===e&&(xv(this.gl,this.framebuffer),this.outputTexture=null),Xt(this.gl,()=>this.gl.deleteTexture(e))}downloadByteEncodedFloatMatrixFromOutputTexture(e,i,s){return this.downloadMatrixDriver(e,()=>k3(this.gl,i,s,this.textureConfig))}downloadPackedMatrixFromBuffer(e,i,s,n,a,p){return U3(this.gl,e,i,s,n,a,p,this.textureConfig)}downloadFloat32MatrixFromBuffer(e,i){return B3(this.gl,e,i)}createBufferFromTexture(e,i,s){this.bindTextureToFrameBuffer(e);const n=N3(this.gl,i,s,this.textureConfig);return this.unbindTextureToFrameBuffer(),n}createAndWaitForFence(){const e=this.createFence(this.gl);return this.pollFence(e)}createFence(e){let i,s;if(Ue().getBool("WEBGL_FENCE_API_ENABLED")){const n=e,a=n.fenceSync(n.SYNC_GPU_COMMANDS_COMPLETE,0);e.flush(),s=()=>{const p=n.clientWaitSync(a,0,0);return p===n.ALREADY_SIGNALED||p===n.CONDITION_SATISFIED},i=a}else Ue().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0?(i=this.beginQuery(),this.endQuery(),s=()=>this.isQueryAvailable(i,Ue().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))):s=()=>!0;return{query:i,isFencePassed:s}}downloadMatrixFromPackedTexture(e,i,s){return this.downloadMatrixDriver(e,()=>V3(this.gl,i,s))}createProgram(e){this.throwIfDisposed();const i=this.gl;this.vertexShader==null&&(this.vertexShader=C3(i));const s=hB(i);Xt(i,()=>i.attachShader(s,this.vertexShader)),Xt(i,()=>i.attachShader(s,e)),uB(i,s);const n=Object.assign(s,{vao:this.createVertexArray()});return this.debug&&tm(i,n),n}buildVao(e){this.setProgram(e),this.bindVertexArray(e.vao);const i=this.gl;Xt(i,()=>i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.indexBuffer)),D3(i,e,this.vertexBuffer)}deleteProgram(e){this.throwIfDisposed(),e===this.program&&(this.program=null),e!=null&&(Xt(this.gl,()=>this.gl.deleteProgram(e)),this.deleteVertexArray(e.vao))}setProgram(e){this.throwIfDisposed(),this.program=e,this.program!=null&&this.debug&&tm(this.gl,this.program),Xt(this.gl,()=>this.gl.useProgram(e))}getUniformLocation(e,i,s=!0){return this.throwIfDisposed(),s?yB(this.gl,e,i):bB(this.gl,e,i)}getAttributeLocation(e,i){return this.throwIfDisposed(),Xt(this.gl,()=>this.gl.getAttribLocation(e,i))}getUniformLocationNoThrow(e,i){return this.throwIfDisposed(),this.gl.getUniformLocation(e,i)}setInputMatrixTexture(e,i,s){this.throwIfDisposed(),this.throwIfNoProgram(),vB(this.gl,e,i,s)}setOutputMatrixTexture(e,i,s){this.setOutputMatrixTextureDriver(e,s,i)}setOutputPackedMatrixTexture(e,i,s){this.throwIfDisposed();const[n,a]=ic(i,s);this.setOutputMatrixTextureDriver(e,n,a)}setOutputMatrixWriteRegion(e,i,s,n){this.setOutputMatrixWriteRegionDriver(s,e,n,i)}setOutputPackedMatrixWriteRegion(e,i,s,n){throw new Error("setOutputPackedMatrixWriteRegion not implemented.")}debugValidate(){this.program!=null&&tm(this.gl,this.program),Xd(this.gl)}executeProgram(){this.throwIfDisposed(),this.throwIfNoProgram();const e=this.gl;if(this.debug){const i=this.getVertexArray();console.assert(i===this.program.vao,"VAO changed between setProgram and executeProgram!"),this.debugValidate()}Xt(e,()=>e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0))}blockUntilAllProgramsCompleted(){this.throwIfDisposed(),Xt(this.gl,()=>this.gl.finish())}getQueryTimerExtension(){return this.disjointQueryTimerExtension==null&&(this.disjointQueryTimerExtension=Hd(this.gl,Ue().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")===2?"EXT_disjoint_timer_query_webgl2":"EXT_disjoint_timer_query")),this.disjointQueryTimerExtension}getQueryTimerExtensionWebGL2(){return this.getQueryTimerExtension()}getQueryTimerExtensionWebGL1(){return this.getQueryTimerExtension()}beginQuery(){if(Ue().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")===2){const s=this.gl,n=this.getQueryTimerExtensionWebGL2(),a=s.createQuery();return s.beginQuery(n.TIME_ELAPSED_EXT,a),a}const e=this.getQueryTimerExtensionWebGL1(),i=e.createQueryEXT();return e.beginQueryEXT(e.TIME_ELAPSED_EXT,i),i}endQuery(){if(Ue().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")===2){const i=this.gl,s=this.getQueryTimerExtensionWebGL2();i.endQuery(s.TIME_ELAPSED_EXT);return}const e=this.getQueryTimerExtensionWebGL1();e.endQueryEXT(e.TIME_ELAPSED_EXT)}async waitForQueryAndGetTime(e){return await Mr(()=>this.disposed||this.isQueryAvailable(e,Ue().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))),this.getQueryTime(e,Ue().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))}getQueryTime(e,i){if(i===0)return null;if(i===2){const s=this.gl;return s.getQueryParameter(e,s.QUERY_RESULT)/1e6}else{const s=this.getQueryTimerExtensionWebGL1();return s.getQueryObjectEXT(e,s.QUERY_RESULT_EXT)/1e6}}isQueryAvailable(e,i){if(i===0)return!0;if(i===2){const s=this.gl,n=this.getQueryTimerExtensionWebGL2(),a=s.getQueryParameter(e,s.QUERY_RESULT_AVAILABLE);return this.disjoint==null&&(this.disjoint=this.gl.getParameter(n.GPU_DISJOINT_EXT)),a&&!this.disjoint}else{const s=this.getQueryTimerExtensionWebGL1(),n=s.getQueryObjectEXT(e,s.QUERY_RESULT_AVAILABLE_EXT);return this.disjoint==null&&(this.disjoint=this.gl.getParameter(s.GPU_DISJOINT_EXT)),n&&!this.disjoint}}pollFence(e){return new Promise(i=>{this.addItemToPoll(()=>e.isFencePassed(),()=>i())})}pollItems(){const e=G3(this.itemsToPoll.map(i=>i.isDoneFn));for(let i=0;i<=e;++i){const{resolveFn:s}=this.itemsToPoll[i];s()}this.itemsToPoll=this.itemsToPoll.slice(e+1)}addItemToPoll(e,i){if(this.itemsToPoll.push({isDoneFn:e,resolveFn:i}),this.itemsToPoll.length>1)return;let s;"setTimeoutCustom"in Ue().platform&&(s=Ue().platform.setTimeoutCustom.bind(Ue().platform)),Mr(()=>(this.pollItems(),this.itemsToPoll.length===0),()=>0,null,s)}bindTextureToFrameBuffer(e){this.throwIfDisposed(),im(this.gl,e,this.framebuffer),this.debug&&Xd(this.gl)}unbindTextureToFrameBuffer(){this.outputTexture!=null?(im(this.gl,this.outputTexture,this.framebuffer),this.debug&&Xd(this.gl)):xv(this.gl,this.framebuffer)}downloadMatrixDriver(e,i){this.bindTextureToFrameBuffer(e);const s=i();return this.unbindTextureToFrameBuffer(),s}setOutputMatrixTextureDriver(e,i,s){this.throwIfDisposed();const n=this.gl;im(n,e,this.framebuffer),this.debug&&Xd(n),this.outputTexture=e,Xt(n,()=>n.viewport(0,0,i,s)),Xt(n,()=>n.scissor(0,0,i,s))}setOutputMatrixWriteRegionDriver(e,i,s,n){this.throwIfDisposed(),Xt(this.gl,()=>this.gl.scissor(e,i,s,n))}throwIfDisposed(){if(this.disposed)throw new Error("Attempted to use disposed GPGPUContext.")}throwIfNoProgram(){if(this.program==null)throw new Error("No GPU program is currently set.")}}function G3(l){let e=0;for(;e<l.length&&l[e]();++e);return e-1}function es(l,e){Array.isArray(l)||(l=[l]),l.forEach(i=>{i!=null&&Te(i.dtype!=="complex64",()=>e+" does not support complex64 tensors in the CPU backend.")})}function Ev(l){const e=new Float32Array(l.length);for(let i=0;i<l.length;++i)e[i]=Math.abs(l[i]);return e}const W3=l=>{const{x:e}=l.inputs,i=l.backend;es(e,"abs");let s=new Float32Array(Je(e.shape));const n=i.data.get(e.dataId).values;return s=Ev(n),i.makeOutput(s,e.shape,e.dtype)},z3={kernelName:gt,backendName:"cpu",kernelFunc:W3};function vs(l){return(e,i,s,n,a)=>{const p=is(e,i),_=p.length,g=Ni(p),y=Je(p),b=ut(a,y),v=e.length,S=i.length,M=Ni(e),F=Ni(i),L=Kl(e,p),N=Kl(i,p);if(L.length+N.length===0)for(let k=0;k<b.length;++k)b[k]=l(s[k%s.length],n[k%n.length]);else for(let k=0;k<b.length;++k){const G=Ri(k,_,g),H=G.slice(-v);L.forEach(Z=>H[Z]=0);const z=vt(H,v,M),W=G.slice(-S);N.forEach(Z=>W[Z]=0);const Y=vt(W,S,F);b[k]=l(s[z],n[Y])}return[b,p]}}function Ch(l){const{inputs:e,backend:i}=l,{real:s,imag:n}=e,a=i.data.get(s.dataId).values,p=i.data.get(n.dataId).values,_=i.makeTensorInfo(s.shape,"complex64"),g=i.data.get(_.dataId);return g.complexTensorInfos={real:i.makeTensorInfo(s.shape,"float32",a),imag:i.makeTensorInfo(n.shape,"float32",p)},_}function Zd(l,e,i="float32"){if(i==="complex64"){const n=Zd(l,e,"float32"),a=Zd(l,e,"float32");return Ch({inputs:{real:n,imag:a},backend:l})}const s=ze(Je(e),i);return l.makeTensorInfo(e,i,s)}function ox(l){const{inputs:e,backend:i}=l,{x:s}=e;return i.incRef(s.dataId),{dataId:s.dataId,shape:s.shape,dtype:s.dtype}}const H3={kernelName:Ju,backendName:"cpu",kernelFunc:ox};function cm(l){const{inputs:e,backend:i}=l,{input:s}=e,n=i.data.get(s.dataId).complexTensorInfos.real,a=i.data.get(n.dataId).values;return i.makeTensorInfo(n.shape,n.dtype,a)}function Av(l,e,i,s){if(s==="int32"){const n=Int32Array.from(l);return[e,"int32",n]}if(s==="bool"){const n=Td([0],i),[a,p]=vs((_,g)=>_!==g?1:0)(e,[],l,n,"bool");return[p,"bool",a]}throw new Error("Error in Cast: failed to cast "+i+" to "+s)}function xl(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{dtype:a}=s;if(a==="complex64"){if(n.dtype==="complex64")return ox({inputs:{x:n},backend:i});const b=Zd(i,n.shape,n.dtype),v=xl({inputs:{x:n},backend:i,attrs:{dtype:"float32"}}),S=Ch({inputs:{real:v,imag:b},backend:i});return i.disposeIntermediateTensorInfo(b),i.disposeIntermediateTensorInfo(v),S}if(n.dtype==="complex64"){const b=cm({inputs:{input:n},backend:i}),v=xl({inputs:{x:b},backend:i,attrs:{dtype:a}});return i.disposeIntermediateTensorInfo(b),v}if(!Zi(n.dtype,a)){const b=ox({inputs:{x:n},backend:i});return{dataId:b.dataId,shape:b.shape,dtype:a}}const p=i.data.get(n.dataId).values,[_,g,y]=Av(p,n.shape,n.dtype,a);return i.makeTensorInfo(_,g,y)}const X3={kernelName:Ku,backendName:"cpu",kernelFunc:xl};function _a(l,e,i,s){return i==null?({inputs:n,backend:a})=>{const{a:p,b:_}=n,g=a;es([p,_],l);const y=g.data.get(p.dataId).values,b=g.data.get(_.dataId).values,v=p.dtype==="string"?nx(y):y,S=p.dtype==="string"?nx(b):b,M=s||p.dtype,[F,L]=e(p.shape,_.shape,v,S,M);return g.makeTensorInfo(L,M,F)}:({inputs:n,backend:a})=>{const{a:p,b:_}=n,g=a;if(p.dtype==="complex64"||_.dtype==="complex64"){const y=xl({inputs:{x:p},backend:g,attrs:{dtype:"complex64"}}),b=g.data.get(y.dataId),v=b.complexTensorInfos.real,S=b.complexTensorInfos.imag,M=g.data.get(v.dataId).values,F=g.data.get(S.dataId).values,L=xl({inputs:{x:_},backend:g,attrs:{dtype:"complex64"}}),N=g.data.get(L.dataId),k=N.complexTensorInfos.real,G=N.complexTensorInfos.imag,H=g.data.get(k.dataId).values,z=g.data.get(G.dataId).values,[W,Y,Z]=i(p.shape,_.shape,M,F,H,z),Q=g.makeTensorInfo(Z,"float32",W),se=g.makeTensorInfo(Z,"float32",Y),$=Ch({inputs:{real:Q,imag:se},backend:g});return g.disposeIntermediateTensorInfo(y),g.disposeIntermediateTensorInfo(L),g.disposeIntermediateTensorInfo(Q),g.disposeIntermediateTensorInfo(se),$}else{const y=g.data.get(p.dataId).values,b=g.data.get(_.dataId).values,v=s||p.dtype,[S,M]=e(p.shape,_.shape,y,b,v);return g.makeTensorInfo(M,v,S)}}}function hm(l){return(e,i,s,n,a,p)=>{const _=is(e,i),g=Je(_),y=_.length,b=Ni(_),v=ut("float32",g),S=ut("float32",g),M=Kl(e,_),F=Kl(i,_),L=ec(s,n),N=ec(a,p),k=e.length,G=Ni(e),H=i.length,z=Ni(i);if(M.length+F.length===0)for(let W=0;W<v.length;W++){const Y=W%L.length,Z=W%N.length,Q=l(L[Y*2],L[Y*2+1],N[Z*2],N[Z*2+1]);v[W]=Q.real,S[W]=Q.imag}else for(let W=0;W<v.length;W++){const Y=Ri(W,y,b),Z=Y.slice(-k);M.forEach(ue=>Z[ue]=0);const Q=vt(Z,k,G),se=Y.slice(-H);F.forEach(ue=>se[ue]=0);const $=vt(se,H,z),oe=l(L[Q*2],L[Q*2+1],N[$*2],N[$*2+1]);v[W]=oe.real,S[W]=oe.imag}return[v,S,_]}}const Cv=vs((l,e)=>l+e),Y3=hm((l,e,i,s)=>({real:l+i,imag:e+s})),Rh=_a(Yx,Cv,Y3),K3={kernelName:Yx,backendName:"cpu",kernelFunc:Rh};function j3(l,e,i,s,n){const a=Je(s),p=ze(n,i);for(let _=0;_<l.length;_++){const g=l[_];if(g<0)throw new Error("Input x must be non-negative!");g>=n||(a>0?p[g]+=e[_]:p[g]+=1)}return p}function q3(l,e,i,s=!1){const n=l.shape[0],a=l.shape[1],p=Jr([n,i],e.dtype);for(let _=0;_<n;_++)for(let g=0;g<a;g++){const y=l.get(_,g);if(y<0)throw new Error("Input x must be non-negative!");y>=i||(s?p.set(1,_,y):e.size>0?p.set(p.get(_,y)+e.get(_,g),_,y):p.set(p.get(_,y)+1,_,y))}return p}const Z3=vs((l,e)=>l&e);function Uo(l){return(e,i,s)=>{const n=bt(i,e.length);for(let a=0;a<e.length;++a)n[a]=l(e[a],s);return n}}function xx(l,e,i){const s=Uo(e);return Rv(l,s,i)}function Rv(l,e,i){return({inputs:s,attrs:n,backend:a})=>{const{x:p}=s;es(p,l);const _=a,g=_.data.get(p.dataId).values;let y;if(p.dtype==="string"){if(!Array.isArray(g))throw new Error("String tensor's value was not an instance of Array");y=nx(g)}else y=g;const b=i||p.dtype,v=e(y,b,n);return _.makeTensorInfo(p.shape,b,v)}}const Q3=Uo(l=>Math.ceil(l));function Iv(l,e,i,s){const n=bt(i,Je(e));if(s&&i!=="string"){let a=0;l.forEach(p=>{const _=Je(p.shape);n.set(p.vals,a),a+=_})}else{let a=0;l.forEach(p=>{const _=i==="string"?nx(p.vals):p.vals;let g=0;for(let y=0;y<p.shape[0];++y){const b=y*e[1]+a;for(let v=0;v<p.shape[1];++v)n[b+v]=_[g++]}a+=p.shape[1]})}return n}const $3=vs((l,e)=>l===e?1:0),J3=Uo(l=>Math.exp(l)),ek=Uo(l=>Math.expm1(l)),Sv=Uo(l=>Math.floor(l)),tk=Rv(Qu,Sv),ik={kernelName:Qu,backendName:"cpu",kernelFunc:tk},rk=vs((l,e)=>Math.floor(l/e));function sk(l,e,i,s,n,a,p,_,g){const y=Jr([s,a],i);for(let b=0;b<s;b++){const v=[];let S=0;for(let M=0;M<n;M++){const F=l[b*n+M];S+=F*p[M],v.push(F)}if(S<0||S>=g/a)throw new Error("Invalid indices: "+v+" does not index into "+_);for(let M=0;M<a;M++)y.values[b*a+M]=e.get(...e.indexToLoc(S*a+M))}return y}function Mv(l,e,i){const s=Jr(i,l.dtype);for(let n=0;n<s.size;++n){const a=s.indexToLoc(n).slice(),p=a[0],_=a[2],g=e.locToIndex([p,_]);a[2]=e.values[g];const y=l.locToIndex(a);0<=y&&y<l.values.length&&(s.values[n]=l.values[y])}return s}const nk=vs((l,e)=>l>e?1:0),Pv=vs((l,e)=>l>=e?1:0),ak=_a($u,Pv,null,"bool"),ok={kernelName:$u,backendName:"cpu",kernelFunc:ak},Ov=vs((l,e)=>l<e?1:0),xk=_a(ed,Ov,null,"bool"),lk={kernelName:ed,backendName:"cpu",kernelFunc:xk},wv=vs((l,e)=>l<=e?1:0),ck=_a(td,wv,null,"bool"),hk={kernelName:td,backendName:"cpu",kernelFunc:ck};function uk(l,e,i){const s=(e-l)/(i-1),n=ze(i,"float32");n[0]=l;for(let a=1;a<n.length;a++)n[a]=n[a-1]+s;return n}const dk=Uo(l=>Math.log(l));function Dv(l,e,i,s){const n=ut(s,Je(i));for(let a=0;a<n.length;++a){const p=a*e;let _=l[p];for(let g=0;g<e;++g){const y=l[p+g];(Number.isNaN(y)||y>_)&&(_=y)}n[a]=_}return n}const Fv=vs((l,e)=>Math.max(l,e)),fk=_a(sd,Fv),pk={kernelName:sd,backendName:"cpu",kernelFunc:fk},Lv=vs((l,e)=>Math.min(l,e)),mk=_a(nd,Lv),_k={kernelName:nd,backendName:"cpu",kernelFunc:mk},um=vs((l,e)=>l*e),gk=hm((l,e,i,s)=>({real:l*i-e*s,imag:l*s+e*i})),yk=_a(ad,um,gk),bk={kernelName:ad,backendName:"cpu",kernelFunc:yk};function Nv(l,e,i){const s=rh(-1,i);return um([],e,s,l,i)}function vk(l){const{inputs:e,backend:i}=l,{x:s}=e;es(s,"neg");const n=i.data.get(s.dataId).values,[a,p]=Nv(n,s.shape,s.dtype);return i.makeTensorInfo(p,s.dtype,a)}const Tk={kernelName:vf,backendName:"cpu",kernelFunc:vk},Ek=vs((l,e)=>l!==e?1:0);function dm(l,e,i,s,n){const a=e.length,p=Je(e),_=Ni(e),g=Ni(n),y=ut(i,Je(n));for(let b=0;b<p;++b){const v=Ri(b,a,_),S=new Array(v.length);for(let F=0;F<S.length;F++)S[F]=v[s[F]];const M=vt(S,a,g);y[M]=l[b]}return y}function fm(l){const{inputs:e,attrs:i,backend:s}=l,{x:n}=e,{perm:a}=i;es(n,"transpose");const p=n.shape.length,_=new Array(p);for(let b=0;b<_.length;b++)_[b]=n.shape[a[b]];const g=s.data.get(n.dataId).values,y=dm(g,n.shape,n.dtype,a,_);return{dataId:s.write(y,_,n.dtype),shape:_,dtype:n.dtype}}const Ak={kernelName:ih,backendName:"cpu",kernelFunc:fm};function Ck(l,e,i,s){const[n,a]=Fo(l,s),p=Do(e,"int32"),_=ze(Je(n),p),g=Je(a);for(let y=0;y<_.length;++y){const b=y*g;let v=1;for(let S=0;S<g;++S)v*=i[b+S];_[y]=v}return{outVals:_,outShape:n,outDtype:p}}function Rk(l,e,i){l.forEach((s,n)=>{if(s<0||s>=i){const a=Ri(n,e.length,Ni(e)).join(",");throw new Error("indices["+a+"] = "+s+" is not in [0, "+i+")")}})}function Ik(l,e){for(let i=0;i<l.length;++i){const s=l[i],n=i===l.length-1?e:l[i+1].length;if(s.length===0)throw new Error("Ragged splits may not be empty");if(s[0]<0)throw new Error("Ragged splits must be non-negative");if(s[s.length-1]>n)throw new Error("Ragged splits must not point past values");for(let a=1;a<s.length;++a)if(s[a-1]>s[a])throw new Error("Ragged splits must be sorted in ascending order")}}function Sk(l,e,i,s){const n=[];let a=0;const p=e.length-1+i.length,_=new Array(p).fill(null).map(()=>[0]);Ik(i,s);let g=1;for(let y=0;y<e.length-1;++y){g*=e[y];const b=e[y+1];for(let v=1;v<g+1;++v)_[y].push(v*b)}for(let y=0;y<l.length;++y){let b=l[y],v=l[y]+1;for(let S=0;S<i.length;++S){const M=i[S],F=S+e.length-1;if(F>=0){const L=_[F],N=L[L.length-1]-M[b];for(let k=b;k<v;++k)_[F].push(M[k+1]+N)}b=M[b],v=M[v]}v!==b&&(n.push([b,v]),a+=v-b)}return{outSplits:_,valueSlices:n,numValues:a}}function Mk(l){const e=[];for(let i=0;i<l.length;++i){const s=l[i].length,n=bt("int32",s);e.push(n),l[i].forEach((a,p)=>n[p]=a)}return e}function Bv(l,e){const i=l.slice(0,e);for(;i.length<e;)i.push(1);for(let s=e;s<l.length;s++)i[e-1]*=l[s];return i}function Pk(l,e,i,s,n,a){const p=Bv(e,2)[1],_=Bv(a,2)[1];let g=0;for(const y of i)for(let b=y[0];b<y[1];++b){for(let v=0;v<s;++v)n[g*_+v]=l[b*p+v];++g}}function Ok(l,e,i,s,n){const a=e.slice();a[0]=n;const p=bt(i,Je(a)),_=l.length,g=_===0?0:_/e[0];return Pk(l,e,s,g,p,a),[p,a]}function wk(l,e,i,s,n,a,p,_){if(l.length===0)throw new Error("paramsNestedSplits must be non empty");if(e[0].length===0)throw new Error("Split tensors must not be scalars");const g=e[0][0]-1;if(Rk(a,p,g),s.length===0)throw new Error("params.rank must be nonzero");const y=s[0],{outSplits:b,valueSlices:v,numValues:S}=Sk(a,p,l,y),M=Mk(b),F=Ok(i,s,n,v,S);return[M,F[0],F[1]]}const kv=2147483647;function Dk(l,e,i,s,n,a,p){if(e.length>1)throw new Error("starts must be a scalar or vector");if(n.length>1)throw new Error("limits must be a scalar or vector");if(p.length>1)throw new Error("deltas must be a scalar or vector");const _=e.length===0,g=n.length===0,y=p.length===0,b=[];_||b.push(e[0]),g||b.push(n[0]),y||b.push(p[0]);for(let N=1;N<b.length;++N)if(b[N]!==b[N-1])throw new Error("starts, limits, and deltas must have the same shape");const v=b.length===0?1:b[0],S=bt("int32",v+1);S[0]=0;for(let N=0;N<v;++N){const k=_?l[0]:l[N],G=g?s[0]:s[N],H=y?a[0]:a[N];if(H===0)throw new Error("Requires delta != 0");let z;if(H>0&&G<k||H<0&&G>k)z=0;else if(z=Math.ceil(Math.abs((G-k)/H)),z>kv)throw new Error("Requires ((limit - start) / delta) <= "+kv);S[N+1]=S[N]+z}const M=S[v],F=bt(i,M);let L=0;for(let N=0;N<v;++N){const k=S[N+1]-S[N];let G=_?l[0]:l[N];const H=y?a[0]:a[N];for(let z=0;z<k;++z)F[L++]=G,G+=H}return[S,F]}var Ha=_o;class Qd{constructor(e,i,s,n,a,p,_,g,y,b){this.shape=e,this.shapeShape=i,this.values=s,this.valuesShape=n,this.valuesDType=a,this.defaultValue=p,this.defaultValueShape=_,this.rowPartitionValues=g,this.rowPartitionValuesShapes=y,this.rowPartitionTypes=Cb(b),this.raggedRank=Rb(this.rowPartitionTypes)}getRowPartitionTypeByDimension(e){return this.rowPartitionTypes[0]===Ha.FIRST_DIM_SIZE?this.rowPartitionTypes[e+1]:this.rowPartitionTypes[e]}getRowPartitionTensor(e){return this.rowPartitionTypes[0]===Ha.FIRST_DIM_SIZE?this.rowPartitionValues[e+1]:this.rowPartitionValues[e]}getMaxWidth(e){const i=this.getRowPartitionTensor(e-1);switch(this.getRowPartitionTypeByDimension(e-1)){case Ha.VALUE_ROWIDS:return Qd.getMaxWidthValueRowID(i);case Ha.ROW_SPLITS:return Qd.getMaxWidthRowSplit(i);default:throw new Error("Cannot handle partition type "+Ha[this.getRowPartitionTypeByDimension(e-1)])}}static getMaxWidthRowSplit(e){const i=e.length;if(i===0||i===1)return 0;let s=0;for(let n=0;n<i-1;++n){const a=e[n+1]-e[n];a>s&&(s=a)}return s}static getMaxWidthValueRowID(e){const i=e.length;if(i===0)return 0;let s=0,n=e[0],a=0;for(let p=1;p<i;++p){const _=e[p];_!==n&&(n=_,a=Math.max(p-s,a),s=p)}return Math.max(i-s,a)}tensorShapeFromTensor(e,i,s=!0){if(i.length===0){if(e[0]===-1)return[];throw new Error("The only valid scalar shape tensor is the fully unknown shape specified as -1.")}return Vv(e,s)}calculateOutputSize(e){const i=this.valuesShape,s=this.defaultValueShape;Ib(s,i);const n=this.tensorShapeFromTensor(this.shape,this.shapeShape),a=Ab(this.raggedRank,n,i);a[0]<0&&(a[0]=e);for(let p=1;p<=this.raggedRank;++p)a[p]<0&&(a[p]=this.getMaxWidth(p));return a}calculateFirstParentOutputIndex(e,i,s){const n=Math.min(e,s),a=[];let p=0;for(let _=0;_<n;++_,p+=i)a.push(p);for(let _=n;_<e;++_)a.push(-1);return Te(a.length===e,()=>"Final length of result must be equal to firstDimension."),a}calculateOutputIndexRowSplit(e,i,s,n){const a=e.length,p=[];for(let _=0;_<a-1;++_){const g=e[_+1]-e[_];let y=Math.min(n,g),b=i[_];b===-1&&(y=0);for(let v=0;v<y;++v)p.push(b),b+=s;for(let v=0;v<g-y;++v)p.push(-1)}if(a>0&&p.length!==e[a-1])throw new Error("Invalid row split size.");return p}calculateOutputIndexValueRowID(e,i,s,n){const a=e.length,p=[];if(a===0)return[];let _=0,g=e[0];if(g>=i.length)throw new Error("Got currentValueRowId="+g+", which is not less than "+i.length);let y=i[g];p.push(y);for(let b=1;b<a;++b){const v=e[b];if(v===g)y>=0&&(++_,_<n?y+=s:y=-1);else{if(_=0,g=v,v>=i.length)throw new Error("Got nextValueRowId="+v+" which is not less than "+i.length);y=i[v]}p.push(y)}if(p.length!==e.length)throw new Error("Invalid row ids.");return p}calculateOutputIndex(e,i,s,n){const a=this.getRowPartitionTensor(e),p=this.getRowPartitionTypeByDimension(e);switch(p){case Ha.VALUE_ROWIDS:return this.calculateOutputIndexValueRowID(a,i,s,n);case Ha.ROW_SPLITS:if(a.length-1>i.length)throw new Error("Row partition size is greater than output size: "+(a.length-1)+" > "+i.length);return this.calculateOutputIndexRowSplit(a,i,s,n);default:throw new Error("Unsupported partition type: "+Ha[p])}}getFirstDimensionSize(){const e=this.rowPartitionValues[0];if(this.rowPartitionTypes.length===0)throw new Error("No row_partition_types given.");const i=this.rowPartitionTypes[0];switch(i){case Ha.FIRST_DIM_SIZE:return e[0];case Ha.VALUE_ROWIDS:throw new Error("Cannot handle VALUE_ROWIDS in first dimension.");case Ha.ROW_SPLITS:return this.rowPartitionValuesShapes[0][0]-1;default:throw new Error("Cannot handle type "+Ha[i])}}compute(){if(this.rowPartitionValues[0].length<=0)throw new Error("Invalid first partition input. Tensor requires at least one element.");const e=this.getFirstDimensionSize(),i=this.calculateOutputSize(e),s=new Array(this.raggedRank+1);s[s.length-1]=1;for(let p=s.length-2;p>=0;--p)s[p]=s[p+1]*i[p+1];const n=Vv(i,!1),a=bt(this.valuesDType,Je(n));if(s[0]*i[0]>0){let p=this.calculateFirstParentOutputIndex(e,s[0],i[0]);for(let _=1;_<=this.raggedRank;++_)p=this.calculateOutputIndex(_-1,p,s[_],i[_]);this.setOutput(this.raggedRank,p,a,n)}return[n,a]}setOutput(e,i,s,n){if(s.length===0)return;const a=this.values,p=s;let _=n.slice();_=_.slice(e+1);const g=Je(_),y=i.length;let b=this.defaultValue;if(b.length!==g&&b.length!==1){const F=this.defaultValueShape;zr(()=>{const L=ti(b,F);b=Sd(L,_).dataSync()})}let v=0,S=0,M=0;for(let F=0;F<=y;++F){let L=F<y?i[F]:-1;if(L===M){++M;continue}if(S<M){const N=a.subarray(v*g),k=p.subarray(S*g),G=(M-S)*g;Uv(k,N,G)}if(F>=y){const N=s.length;L=Math.floor(N/g)}if(L>M)if(this.defaultValue.length===1)p.subarray(M*g,L*g).fill(this.defaultValue[0]),M=L;else for(;L>M;){const N=p.slice(M*g);Uv(N,b,g),++M}L<0?(v=F+1,S=M):(v=F,S=M,M=S+1)}}}function Uv(l,e,i){for(let s=0;s<i;s++)l[s]=e[s]}function Vv(l,e){const i=[];for(let s of l){if(s<0){if(!e)throw new Error("Dimension "+s+" must be >= 0");if(s<-1)throw new Error("Dimension "+s+" must be >= -1");s=-1}i.push(s)}return i}function Fk(l,e,i,s,n,a,p,_,g,y){return new Qd(l,e,i,s,n,a,p,_,g,y).compute()}function Gv(l,e,i,s){const n=l===e,a=l<e&&i<0,p=e<l&&i>1;if(n||a||p)return ze(0,s);const _=Math.abs(Math.ceil((e-l)/i)),g=ze(_,s);e<l&&i===1&&(i=-1),g[0]=l;for(let y=1;y<g.length;y++)g[y]=g[y-1]+i;return g}const Lk=Uo(l=>1/Math.sqrt(l));function Nk(l,e,i,s,n,a,p,_,g,y){const b=[s/n,n],v=l.values,S=e.values;if(s===0)return Jr(i,e.dtype);const M=g instanceof Wl?g:Jr(b,e.dtype);typeof g=="string"||typeof g=="number"?M.values.fill(g):typeof g=="boolean"&&M.values.fill(+g);for(let F=0;F<a;F++){const L=[];let N=0;for(let k=0;k<p;k++){const G=v[F*p+k];L.push(G),N+=G*_[k]}if(N<0||N>=s/n)throw new Error("Invalid indices: "+L+" does not index into "+i);for(let k=0;k<n;k++)y?M.values[N*n+k]+=S[F*n+k]:M.values[N*n+k]=e.rank===0?S[0]:S[F*n+k]}return M}const Bk=Uo(l=>1/(1+Math.exp(-l))),Wv=xx(hd,l=>1/(1+Math.exp(-l))),kk={kernelName:hd,backendName:"cpu",kernelFunc:Wv};function zv(l,e,i,s,n){const a=lp(s,e,i),p=Je(i),_=Ni(s);if(a){const v=cp(e,_);return n==="string"?l.slice(v,v+p):l.subarray(v,v+p)}const g=n==="string"?nx(l):l,y=Jr(s,n,g),b=Jr(i,n);for(let v=0;v<b.size;++v){const S=b.indexToLoc(v),M=S.map((F,L)=>F+e[L]);b.set(y.get(...M),...S)}return n==="string"?Wb(b.values):b.values}function Hv(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{begin:a,size:p}=s;es(n,"slice");const[_,g]=hp(n,a,p);op(n,_,g);const y=i.data.get(n.dataId).values,b=zv(y,_,g,n.shape,n.dtype);return i.makeTensorInfo(g,n.dtype,b)}const Uk={kernelName:Sf,backendName:"cpu",kernelFunc:Hv};function Vk(l,e,i,s,n,a,p){const _=e[0],g=a[0],y=new Array(g),b=new Array(_),v=e[1];if(g===0){if(_!==0)throw new Error(Ob(_));const N=bt(i,0),k=bt(n,0);return[N,[0,v],k,y,b]}let S=!0,M=0;const F=new Array(g).fill(0);for(let N=0;N<_;++N){const k=l[N*v];if(k<0)throw new Error(wb(N,k));if(k>=g)throw new Error(Db(N,k,g));++F[k],S=S&&k>=M,M=k}let L=!0;for(let N=0;N<g;++N){const k=F[N]===0;y[N]=k,L=L&&!k,F[N]=Math.max(F[N],1),N>0&&(F[N]+=F[N-1])}if(L&&S){const N=l,k=s;for(let G=0;G<_;++G)b[G]=G;return[N,[_,v],k,y,b]}else{const N=F[g-1],k=bt(i,N*v),G=bt(n,N),H=new Array(g).fill(0);for(let z=0;z<_;++z){const W=l[z*v],Y=H[W],Z=(W===0?0:F[W-1])+Y;H[W]++;for(let Q=0;Q<v;++Q)k[Z*v+Q]=l[z*v+Q];G[Z]=s[z],b[z]=Z}for(let z=0;z<g;++z)if(H[z]===0){const W=z===0?0:F[z-1];k[W*v+0]=z;for(let Y=1;Y<v;++Y)k[W*v+Y]=0;G[W]=p}return[k,[N,v],G,y,b]}}function Gk(l,e,i,s,n){const a=Je(s),p=e[0],_=n.length,g=[];let y=1,b=-1;for(let L=0;L<_;++L){const N=n[L];if(N===-1){if(b!==-1)throw new Error(Fb(b,L));b=L,g.push(1)}else{if(N<0)throw new Error(Lb(L,N));y*=N,g.push(N)}}if(b!==-1){if(y<=0)throw new Error(Nb());const L=Math.trunc(a/y);if(y*L!==a)throw new Error(Bb(s,g));g[b]=L}if(Je(g)!==a)throw new Error(kb(s,g));const v=s.length,S=[];if(v>0){S[v-1]=1;for(let L=v-2;L>=0;--L)S[L]=S[L+1]*s[L+1]}const M=[];if(_>0){M[_-1]=1;for(let L=_-2;L>=0;--L)M[L]=M[L+1]*g[L+1]}const F=bt(i,p*_);for(let L=0;L<p;++L){let N=0;for(let k=0;k<v;++k)N+=l[L*v+k]*S[k];for(let k=0;k<_;++k)F[L*_+k]=Math.trunc(N/M[k]),N%=M[k]}return[F,[p,_],g]}function Wk(l,e,i,s,n,a=!1,p=0){const _=s.length,g=[e[0],l.length/e[0]],y=g[1],b=_>0?n[_-1]+1:0;if(b<0)throw new Error(Lp());const v=e.slice();v[0]=b;const S=v.reduce((G,H)=>G*H,1),M=bt(i,S);if(_===0)return b>0&&M.fill(p),[M,v];if(b<=0)throw new Error(Lp());let F=0,L=1,N=0,k=n[F];for(;;){let G=0;if(L<_){if(G=n[L],k===G){++L;continue}if(k>=G)throw new Error(Ub())}if(k<0||k>=b)throw new Error(Vb(k,b));k>N&&M.fill(p,N*y,k*y);for(let H=F;H<L;++H){const z=s[H];if(z<0||z>=g[0])throw new Error(Gb(H,s[H],g[0]));for(let W=0;W<y;W++)M[k*y+W]+=l[z*y+W]}if(a)for(let H=0;H<y;H++)M[k*y+H]/=L-F;if(F=L,++L,N=k+1,k=G,L>_)break}return N<b&&M.fill(p,N*y,b*y),[M,v]}const zk=Uo(l=>Math.sqrt(l)),Hk=xx(ud,l=>Math.sqrt(l)),Xk={kernelName:ud,backendName:"cpu",kernelFunc:Hk},Yk=vs((l,e)=>{const i=l-e;return i*i}),Kk=Uo((l,e)=>{const{pattern:i,replaceGlobal:s,rewrite:n}=e;return l.replace(new RegExp(i,s?"g":""),n)});function Xv(l,e,i,s){const n=Jr(l,e.dtype);for(let a=0;a<n.size;a++){const p=n.indexToLoc(a),_=new Array(p.length);for(let g=0;g<_.length;g++)_[g]=p[g]*i[g]+s[g];n.set(e.get(..._),...p)}return n}class jk{constructor(e,i,s,n,a,p){this.separator=$0(e),this.nGramWidths=i,this.leftPad=$0(s),this.rightPad=$0(n),this.padWidth=a,this.preserveShort=p}getPadWidth(e){return Math.min(this.padWidth<0?e-1:this.padWidth,e-1)}getNumNGrams(e,i){const s=this.getPadWidth(i);return Math.max(0,e+2*s-i+1)}createNGrams(e,i,s,n,a,p){for(let _=0;_<a;++_){const g=this.getPadWidth(p),y=Math.max(0,g-_),b=Math.max(0,g-(a-(_+1))),v=p-(y+b),S=i+(y>0?0:_-g);let M=0;M+=y*this.leftPad.length;for(let G=0;G<v;++G)M+=e[S+G].length;M+=b*this.rightPad.length,M+=(y+b+v-1)*this.separator.length,s[n+_]=new Uint8Array(M);const L=s[n+_];let N=0;const k=G=>G.forEach(H=>L[N++]=H);for(let G=0;G<y;++G)k(this.leftPad),k(this.separator);for(let G=0;G<v-1;++G)k(e[S+G]),k(this.separator);if(v>0){k(e[S+v-1]);for(let G=0;G<b;++G)k(this.separator),k(this.rightPad)}else{for(let G=0;G<b-1;++G)k(this.rightPad),k(this.separator);k(this.rightPad)}}}compute(e,i){const s=e.length,n=i.length;if(n>0){let g=i[0];if(g!==0)throw new Error("First split value must be 0, got "+g);for(let y=1;y<n;++y){let b=i[y]>=g;if(b=b&&i[y]<=s,!b)throw new Error("Invalid split value "+i[y]+", must be in ["+g+", "+s+"]");g=i[y]}if(g!==s)throw new Error("Last split value must be data size. Expected "+s+", got "+g)}const a=n-1,p=bt("int32",n);if(s===0||n===0){const g=new Array(s);for(let y=0;y<=a;++y)p[y]=0;return[g,p]}p[0]=0;for(let g=1;g<=a;++g){const y=i[g]-i[g-1];let b=0;this.nGramWidths.forEach(v=>{b+=this.getNumNGrams(y,v)}),this.preserveShort&&y>0&&b===0&&(b=1),p[g]=p[g-1]+b}const _=new Array(p[a]);for(let g=0;g<a;++g){const y=i[g];let b=p[g];if(this.nGramWidths.forEach(v=>{const S=i[g+1]-i[g],M=this.getNumNGrams(S,v);this.createNGrams(e,y,_,b,M,v),b+=M}),this.preserveShort&&b===p[g]){const v=i[g+1]-i[g];if(v===0)continue;const S=v+2*this.padWidth,M=1;this.createNGrams(e,y,_,b,M,S)}}return[_,p]}}function qk(l,e,i,s,n,a,p,_){return new jk(i,s,n,a,p,_).compute(l,e)}function Zk(l,e,i,s){if(!l.length)return;if(e.length===0){for(let a=0;a<l.length;++a)s.push(l.subarray(a,a+1));return}if(e.length===1){const a=e[0];let p=l.indexOf(a);for(;p!==-1;){const _=l.subarray(0,p);(!i||_.length!==0)&&s.push(_),l=l.subarray(p+1),p=l.indexOf(a)}(!i||l.length!==0)&&s.push(l);return}let n=0;for(let a=0;a<l.length+1;a++)if(a===l.length||e.indexOf(l[a])!==-1){const p=l.subarray(n,a);(!i||p.length!==0)&&s.push(p),n=a+1}}function Qk(l,e,i){const s=l.length,n=[];let a=0,p=0;const _=new Array(s);for(let S=0;S<s;++S){const M=n.length;Zk(l[S],e,i,n);const F=n.length-M;_[S]=F,a+=F,p=Math.max(p,F)}const g=bt("int32",a*2),y=new Array(a),b=[s,p];let v=0;for(let S=0;S<s;++S)for(let M=0;M<_[S];++M)g[v*2]=S,g[v*2+1]=M,y[v]=n[v],++v;return[g,y,b]}function $k(l,e){const i=bt("int32",l.length);for(let s=0;s<l.length;++s)i[s]=oP(l[s]).modulo(e).getLowBitsUnsigned();return i}const Yv=vs((l,e)=>l-e),Jk=hm((l,e,i,s)=>({real:l-i,imag:e-s})),eU=_a(dd,Yv,Jk),tU={kernelName:dd,backendName:"cpu",kernelFunc:eU};function Kv(l,e){const i=new Array(l.rank);for(let n=0;n<i.length;n++)i[n]=l.shape[n]*e[n];const s=Jr(i,l.dtype);for(let n=0;n<s.values.length;++n){const a=s.indexToLoc(n),p=new Array(l.rank);for(let g=0;g<p.length;g++)p[g]=a[g]%l.shape[g];const _=l.locToIndex(p);s.values[n]=l.values[_]}return s}const Ih=(l,e)=>{const i=e.value-l.value;return i===0?l.index-e.index:i};function jv(l,e,i=0,s=l.length-1){for(;s>i;){if(s-i>600){const _=s-i+1,g=e-i+1,y=Math.log(_),b=.5*Math.exp(2*y/3),v=.5*Math.sqrt(y*b*(_-b)/_)*Math.sign(g-_/2),S=Math.max(i,Math.floor(e-g*b/_+v)),M=Math.min(s,Math.floor(e+(_-g)*b/_+v));jv(l,e,S,M)}const n=l[e];let a=i,p=s;for(Si(l,i,e),Ih(l[s],n)>0&&Si(l,i,s);a<p;){for(Si(l,a,p),a++,p--;Ih(l[a],n)<0;)a=a+1;for(;Ih(l[p],n)>0;)p=p-1}Ih(l[i],n)===0?Si(l,i,p):(p=p+1,Si(l,p,s)),p<=e&&(i=p+1),e<=p&&(s=p-1)}}function iU(l,e,i,s,n){const a=e[e.length-1],[p,_]=[l.length/a,a],g=ut(i,p*s),y=ut("int32",p*s);for(let v=0;v<p;v++){const S=v*_,M=l.subarray(S,S+_);let F=new Array(M.length);M.forEach((G,H)=>F[H]={value:G,index:H}),s<F.length&&(jv(F,s),F=F.slice(0,s)),n&&F.sort(Ih);const L=v*s,N=g.subarray(L,L+s),k=y.subarray(L,L+s);for(let G=0;G<s;G++)N[G]=F[G].value,k[G]=F[G].index}const b=e.slice();return b[b.length-1]=s,[Jr(b,i,g),Jr(b,"int32",y)]}function rU(l,e,i,s){const n=jt(e,i)[0],a=[1,i[0],1];for(let F=0;F<n;F++)a[0]*=i[F];a[1]=i[n];for(let F=n+1;F<i.length;F++)a[2]*=i[F];const p=new Map,_=new Int32Array(i[n]),g=new Wl(a,s,l),y=[],b=a[0]===1&&a[2]===1;for(let F=0;F<i[n];F++){let L;if(b)L=l[F].toString();else{const k=[];for(let G=0;G<a[0];G++)for(let H=0;H<a[2];H++)k.push(g.get(G,F,H));L=k.join(",")}const N=p.get(L);if(N!=null)_[F]=N;else{const k=p.size;p.set(L,k),_[F]=k,y.push(F)}}const v=a.slice();v[1]=p.size;const S=new Wl(v,s);y.forEach((F,L)=>{for(let N=0;N<a[0];N++)for(let k=0;k<a[2];k++)S.set(g.get(N,F,k),N,L,k)});const M=i.slice();return M[n]=v[1],{outputValues:S.values,outputShape:M,indices:_}}var sU=Object.freeze({__proto__:null,addImpl:Cv,bincountImpl:j3,bincountReduceImpl:q3,bitwiseAndImpl:Z3,castImpl:Av,ceilImpl:Q3,concatImpl:Iv,equalImpl:$3,expImpl:J3,expm1Impl:ek,floorDivImpl:rk,floorImpl:Sv,gatherNdImpl:sk,gatherV2Impl:Mv,greaterEqualImpl:Pv,greaterImpl:nk,lessEqualImpl:wv,lessImpl:Ov,linSpaceImpl:uk,logImpl:dk,maxImpl:Dv,maximumImpl:Fv,minimumImpl:Lv,multiplyImpl:um,negImpl:Nv,notEqualImpl:Ek,prodImpl:Ck,raggedGatherImpl:wk,raggedRangeImpl:Dk,raggedTensorToTensorImpl:Fk,rangeImpl:Gv,rsqrtImpl:Lk,scatterImpl:Nk,sigmoidImpl:Bk,simpleAbsImpl:Ev,sliceImpl:zv,sparseFillEmptyRowsImpl:Vk,sparseReshapeImpl:Gk,sparseSegmentReductionImpl:Wk,sqrtImpl:zk,squaredDifferenceImpl:Yk,staticRegexReplaceImpl:Kk,stridedSliceImpl:Xv,stringNGramsImpl:qk,stringSplitImpl:Qk,stringToHashBucketFastImpl:$k,subImpl:Yv,tileImpl:Kv,topKImpl:iU,transposeImpl:dm,uniqueImpl:rU});const{addImpl:nU,bincountImpl:NX,bincountReduceImpl:BX,bitwiseAndImpl:kX,castImpl:aU,ceilImpl:UX,concatImpl:oU,equalImpl:VX,expImpl:GX,expm1Impl:WX,floorImpl:xU,gatherNdImpl:zX,gatherV2Impl:lU,greaterImpl:HX,greaterEqualImpl:cU,lessImpl:hU,lessEqualImpl:uU,linSpaceImpl:XX,logImpl:YX,maxImpl:dU,maximumImpl:fU,minimumImpl:pU,multiplyImpl:mU,negImpl:_U,notEqualImpl:gU,prodImpl:KX,raggedGatherImpl:jX,raggedRangeImpl:qX,raggedTensorToTensorImpl:ZX,rangeImpl:yU,rsqrtImpl:QX,scatterImpl:$X,sigmoidImpl:bU,simpleAbsImpl:qv,sliceImpl:vU,sparseFillEmptyRowsImpl:JX,sparseReshapeImpl:eY,sparseSegmentReductionImpl:tY,sqrtImpl:TU,staticRegexReplaceImpl:iY,stridedSliceImpl:EU,stringNGramsImpl:rY,stringSplitImpl:sY,stringToHashBucketFastImpl:nY,subImpl:AU,tileImpl:CU,topKImpl:aY,transposeImpl:pm,uniqueImpl:oY}=sU;function Zv(l,e){return["x","y","z","w","u","v"].slice(0,e).map(i=>l+"."+i)}function lx(l,e){return e===1?[l]:Zv(l,e)}function RU(l,e){if(l===1)return"rc";let i="";for(let s=0;s<l;s++)i+=e[s],s<l-1&&(i+=",");return i}class IU{constructor(e){if(this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.outputShape=e,this.rank=e.length,this.enableShapeUniforms=An(this.outputShape.length),this.rank===0)this.userCode=`
        void main() {
          setOutput(vec4(getA(), 0., 0., 0.));
        }
      `;else{const i=lx("rc",this.rank),s=En(this.rank),n=this.getOutOfBoundsCondition(i),a=this.getSetup(i),p=this.getOutput(i);this.userCode=`
        void main() {
          `+s+` rc = getOutputCoords();

          if(`+n+`) {
            setOutput(vec4(0));
          } else {
            `+a+`

            setOutput(vec4(`+p+`));
          }
        }
      `}}getSourceCoordsArr(e){const i=[];for(let s=0;s<=1;s++)for(let n=0;n<=1;n++){let a=(s===0?"r":"rp1")+", "+(n===0?"c":"cp1");for(let p=2;p<this.rank;p++)a=e[e.length-1-p]+","+a;i.push(a)}return i}getOutOfBoundsCondition(e){if(this.rank===1)return"rc > "+(this.enableShapeUniforms?"outShape":this.outputShape[0]);let i="";for(let s=this.rank-2;s<this.rank;s++)i+=e[s]+" >= "+(this.enableShapeUniforms?"outShape["+s+"]":this.outputShape[s]),s<this.rank-1&&(i+="||");return i}getSetup(e){if(this.rank===1)return"";const i=e.slice(-2),s=this.enableShapeUniforms?"outShape["+this.rank+" - 1]":this.outputShape[this.rank-1],n=this.enableShapeUniforms?"outShape["+this.rank+" - 2]":this.outputShape[this.rank-2];return`
      int r = `+i[0]+`;
      int c = `+i[1]+`;
      int rp1 = r + 1;
      int cp1 = c + 1;

      bool cEdge = cp1 >= `+s+`;
      bool rEdge = rp1 >= `+n+`;
    `}getOutput(e){const i=this.getSourceCoordsArr(e);return this.rank===1?"getA(rc), (rc + 1 >= "+(this.enableShapeUniforms?"outShape":this.outputShape[0])+" ? 0. : getA(rc + 1)), 0, 0":"getA("+i[0]+`),
            cEdge ? 0. : getA(`+i[1]+`),
            rEdge ? 0. : getA(`+i[2]+`),
            rEdge || cEdge ? 0. : getA(`+i[3]+")"}}class Qv{constructor(e,i){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.customUniforms=[{name:"inputShape",type:"ivec3"}],this.outputShape=e,this.enableShapeUniforms=An(this.outputShape.length);let s="";for(let n=0;n<4;n++){let a="thisRC = rc;";n%2===1&&(a+="thisRC.z += 1;"),n>1&&(a+="thisRC.y += 1;"),s+=`
        `+a+`
        `+(n>0?"if(thisRC.y < rows && thisRC.z < cols){":"")+`
          int flatIndex = getFlatIndex(thisRC);

          ivec3 inputRC = inputCoordsFromReshapedOutCoords(flatIndex);
          vec2 inputRCInnerDims = vec2(float(inputRC.y),float(inputRC.z));

          result[`+n+`] =
            getChannel(getA(inputRC.x, inputRC.y, inputRC.z), inputRCInnerDims);
        `+(n>0?"}":"")+`
      `}this.userCode=`
      `+SU(i,this.enableShapeUniforms)+`
      `+(this.enableShapeUniforms?om():am(e))+`

      void main() {
        ivec3 rc = getOutputCoords();

        vec4 result = vec4(0.);

        ivec3 thisRC;
        int rows = `+(this.enableShapeUniforms?"outShape[1]":e[1])+`;
        int cols = `+(this.enableShapeUniforms?"outShape[2]":e[2])+`;

        `+s+`

        setOutput(result);
      }
    `}}function SU(l,e){return`
    ivec3 inputCoordsFromReshapedOutCoords(int index) {
      `+(e?DB(["r","c","d"],"inputShape"):al(["r","c","d"],l))+`
      return ivec3(r, c, d);
    }
  `}class MU{constructor(e){this.gpgpu=e,this.numUsedTextures=0,this.numFreeTextures=0,this._numBytesAllocated=0,this._numBytesFree=0,this.freeTextures={},this.usedTextures={},this.logEnabled=!1}acquireTexture(e,i,s){const n=Jv(i,s),a=eT(e,n,s);a in this.freeTextures||(this.freeTextures[a]=[]),a in this.usedTextures||(this.usedTextures[a]=[]);const p=$v(e,n,this.gpgpu.gl,this.gpgpu.textureConfig,s);if(this.freeTextures[a].length>0){this.numFreeTextures--,this.numUsedTextures++,this._numBytesFree-=p,this.log();const g=this.freeTextures[a].pop();return this.usedTextures[a].push(g),g}let _;return n===$s.PACKED_2X2_FLOAT32?_=this.gpgpu.createPackedMatrixTexture(e[0],e[1]):n===$s.PACKED_2X2_FLOAT16?_=this.gpgpu.createFloat16PackedMatrixTexture(e[0],e[1]):n===$s.UNPACKED_FLOAT32?_=this.gpgpu.createFloat32MatrixTexture(e[0],e[1]):n===$s.UNPACKED_FLOAT16?_=this.gpgpu.createFloat16MatrixTexture(e[0],e[1]):n===$s.PACKED_4X1_UNSIGNED_BYTE&&(_=this.gpgpu.createUnsignedBytesMatrixTexture(e[0],e[1])),this.usedTextures[a].push(_),this.numUsedTextures++,this._numBytesAllocated+=p,this.log(),_}releaseTexture(e,i,s,n){if(this.freeTextures==null)return;const a=Jv(s,n),p=eT(i,a,n);p in this.freeTextures||(this.freeTextures[p]=[]);const _=$v(i,a,this.gpgpu.gl,this.gpgpu.textureConfig,n),g=Ue().getNumber("WEBGL_DELETE_TEXTURE_THRESHOLD");g!==-1&&this._numBytesAllocated>g?(this.gpgpu.deleteMatrixTexture(e.texture),this._numBytesAllocated-=_):(this.freeTextures[p].push(e),this.numFreeTextures++,this._numBytesFree+=_),this.numUsedTextures--;const y=this.usedTextures[p],b=y&&y.indexOf(e);if(b==null||b<0)throw new Error("Cannot release a texture that was never provided by this texture manager");y[b]=y[y.length-1],y.pop(),this.log()}log(){if(!this.logEnabled)return;const e=this.numFreeTextures+this.numUsedTextures;console.log("Free/Used",this.numFreeTextures+" / "+this.numUsedTextures,"("+e+")");const i=this._numBytesFree/this._numBytesAllocated;console.log("Bytes allocated: "+this._numBytesAllocated),console.log("Bytes unused: "+this._numBytesFree+" ("+Math.round(100*i)+"%)")}get numBytesAllocated(){return this._numBytesAllocated}get numBytesFree(){return this._numBytesFree}getNumUsedTextures(){return this.numUsedTextures}getNumFreeTextures(){return this.numFreeTextures}dispose(){if(this.freeTextures!=null){for(const e in this.freeTextures)this.freeTextures[e].forEach(i=>{this.gpgpu.deleteMatrixTexture(i.texture)});for(const e in this.usedTextures)this.usedTextures[e].forEach(i=>{this.gpgpu.deleteMatrixTexture(i.texture)});this.freeTextures=null,this.usedTextures=null,this.numUsedTextures=0,this.numFreeTextures=0,this._numBytesAllocated=0,this._numBytesFree=0}}}function PU(l,e){const i=l;if(e===i.R32F)return 4;if(e===i.R16F)return 2;if(e===i.RGBA32F||e===l.RGBA)return 16;if(e===i.RGBA16F)return 8;if(e===i.RGBA8)return 4;throw new Error("Unknown internal format "+e)}function $v(l,e,i,s,n){const a=OU(e,s);let p;if(n){const[g,y]=ic(l[0],l[1]);p=g*y}else{const[g,y]=Eh(l[0],l[1]);p=g*y}const _=PU(i,a);return p*_}function OU(l,e){switch(l){case $s.PACKED_2X2_FLOAT32:return vv(e);case $s.PACKED_2X2_FLOAT16:return Tv(e);case $s.UNPACKED_FLOAT32:return gv(e);case $s.UNPACKED_FLOAT16:return yv(e);case $s.PACKED_4X1_UNSIGNED_BYTE:return bv(e);default:throw new Error("Unknown physical texture type "+l)}}function wU(l){return Ue().getBool("WEBGL_RENDER_FLOAT32_ENABLED")?l?$s.PACKED_2X2_FLOAT32:$s.UNPACKED_FLOAT32:l?$s.PACKED_2X2_FLOAT16:$s.UNPACKED_FLOAT16}function Jv(l,e){if(l===ma.UPLOAD)return $s.PACKED_2X2_FLOAT32;if(l===ma.RENDER||l==null)return wU(e);if(l===ma.DOWNLOAD||l===ma.PIXELS)return $s.PACKED_4X1_UNSIGNED_BYTE;throw new Error("Unknown logical texture type "+l)}function eT(l,e,i){return l[0]+"_"+l[1]+"_"+e+"_"+i}class y0{constructor(e,i){this.variableNames=["A"],this.outputShape=e,this.enableShapeUniforms=An(this.outputShape.length),this.userCode=`
      float unaryOperation(float x) {
        `+i+`
      }

      void main() {
        float x = getAAtOutCoords();
        float y = unaryOperation(x);

        setOutput(y);
      }
    `}}const Sh="if (isnan(x)) return x;",DU="return x;",tT="return abs(x);",FU="return (x >= 0.0) ? x : (exp(x) - 1.0);",LU=Sh+`
  return (x < 0.0) ? 0.0 : x;
`,NU=Sh+`
  return (x < 0.0) ? 0.0 : min(6.0, x);
`,cx="return x;",BU="return 1.0 / (1.0 + exp(-1.0 * x));",kU="return x;",UU=`
  vec4 result;

  result.r = (x.r >= 0.0) ? x.r : (exp(x.r) - 1.0);
  result.g = (x.g >= 0.0) ? x.g : (exp(x.g) - 1.0);
  result.b = (x.b >= 0.0) ? x.b : (exp(x.b) - 1.0);
  result.a = (x.a >= 0.0) ? x.a : (exp(x.a) - 1.0);

  return result;
`,VU=`
  vec4 result = x * vec4(greaterThanEqual(x, vec4(0.0)));
  bvec4 isNaN = isnan(x);

  result.r = isNaN.r ? x.r : result.r;
  result.g = isNaN.g ? x.g : result.g;
  result.b = isNaN.b ? x.b : result.b;
  result.a = isNaN.a ? x.a : result.a;

  return result;
`,GU=`
  vec4 result = min(x, vec4(6.)) * vec4(greaterThanEqual(x, vec4(0.0)));
  bvec4 isNaN = isnan(x);

  result.r = isNaN.r ? x.r : result.r;
  result.g = isNaN.g ? x.g : result.g;
  result.b = isNaN.b ? x.b : result.b;
  result.a = isNaN.a ? x.a : result.a;

  return result;
`,WU="return 1.0 / (1.0 + exp(-1.0 * x));";class hx{constructor(e,i){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e,this.enableShapeUniforms=An(this.outputShape.length),this.userCode=`
      vec4 unaryOperation(vec4 x) {
        `+i+`
      }

      void main() {
        vec4 x = getAAtOutCoords();
        vec4 y = unaryOperation(x);

        setOutput(y);
      }
    `}}class zU{constructor(e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1,this.outputShape=e,this.enableShapeUniforms=An(this.outputShape.length);const i=e.length,s=lx("rc",i),n=En(i),a=RU(i,s),p=s.slice(-2),_=i<=1?"rc":"vec2("+p.join(",")+")";this.userCode=`
      void main() {
        `+n+` rc = getOutputCoords();
        vec4 packedInput = getA(`+a+`);

        setOutput(getChannel(packedInput, `+_+`));
      }
    `}}const HU=bb,XU=1e-7,YU=1e-4,mm={};function KU(l){return l in mm||(mm[l]={}),mm[l]}const jU=Ue().getNumber("CPU_HANDOFF_SIZE_THRESHOLD"),qU=600;function ZU(){return Ue().global.screen==null?1024:Ue().global.screen.height*Ue().global.screen.width*window.devicePixelRatio*qU/1024/1024}class ll extends ni{nextDataId(){return ll.nextDataId++}constructor(e){if(super(),this.pendingRead=new WeakMap,this.pendingDisposal=new WeakSet,this.dataRefCount=new WeakMap,this.numBytesInGPU=0,this.uploadWaitMs=0,this.downloadWaitMs=0,this.lastGlFlushTime=0,this.warnedAboutMemory=!1,this.pendingDeletes=0,this.disposed=!1,!Ue().getBool("HAS_WEBGL"))throw new Error("WebGL is not supported on this device");let i;if(e!=null){if(e instanceof lm)i=e;else{const s=go(Ue().getNumber("WEBGL_VERSION"),e);i=new lm(s)}this.binaryCache={},this.gpgpuCreatedLocally=!1}else{const s=go(Ue().getNumber("WEBGL_VERSION"));i=new lm(s),this.binaryCache=KU(Ue().getNumber("WEBGL_VERSION")),this.gpgpuCreatedLocally=!0}this.gpgpu=i,this.canvas=this.gpgpu.gl.canvas,this.textureManager=new MU(this.gpgpu),this.numMBBeforeWarning=ZU(),this.texData=new _t(this,Va())}numDataIds(){return this.texData.numDataIds()-this.pendingDeletes}writeTexture(e,i,s,n,a,p){const _=this.makeTensorInfo(i,s),g=this.texData.get(_.dataId);g.isPacked=!1,g.texture={texture:e,texShape:[n,a]},g.texShape=[n,a];const y=Yd(i),b=new _v(y,!1,p),v=this.runWebGLProgram(b,[_],s,[[n,a]]);return v.shape=i,g.texture=null,this.disposeIntermediateTensorInfo(_),v.dataId}write(e,i,s){if((Ue().getBool("WEBGL_CHECK_NUMERICAL_PROBLEMS")||Ue().getBool("DEBUG"))&&this.checkNumericalProblems(e),s==="complex64"&&e!=null)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");const n={id:this.nextDataId()};return this.texData.set(n,{shape:i,dtype:s,values:e,usage:ma.UPLOAD,refCount:1}),n}refCount(e){return this.texData.has(e)?this.texData.get(e).refCount:0}incRef(e){const i=this.texData.get(e);i.refCount++}decRef(e){if(this.texData.has(e)){const i=this.texData.get(e);i.refCount--}}move(e,i,s,n,a){if(Ue().getBool("DEBUG")&&this.checkNumericalProblems(i),n==="complex64")throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");this.texData.set(e,{shape:s,dtype:n,values:i,usage:ma.UPLOAD,refCount:a})}disposeIntermediateTensorInfo(e){this.disposeData(e.dataId)}readSync(e){const i=this.texData.get(e),{values:s,dtype:n,complexTensorInfos:a,slice:p,shape:_,isPacked:g}=i;if(p!=null){let S;g?S=new hx(_,cx):S=new y0(_,cx);const M=this.runWebGLProgram(S,[{dataId:e,shape:_,dtype:n}],n),F=this.readSync(M.dataId);return this.disposeIntermediateTensorInfo(M),F}if(s!=null)return this.convertAndCacheOnCPU(e);if(n==="string")return s;const y=this.activeTimers!=null;let b;y&&(b=pa());let v;if(n==="complex64"){const S=this.readSync(a.real.dataId),M=this.readSync(a.imag.dataId);v=ec(S,M)}else v=this.getValuesFromTexture(e);return y&&(this.downloadWaitMs+=pa()-b),this.convertAndCacheOnCPU(e,v)}async read(e){if(this.pendingRead.has(e)){const F=this.pendingRead.get(e);return new Promise(L=>F.push(L))}const i=this.texData.get(e),{values:s,shape:n,slice:a,dtype:p,complexTensorInfos:_,isPacked:g}=i;if(a!=null){let F;g?F=new hx(n,cx):F=new y0(n,cx);const L=this.runWebGLProgram(F,[{dataId:e,shape:n,dtype:p}],p),N=this.read(L.dataId);return this.disposeIntermediateTensorInfo(L),N}if(s!=null)return this.convertAndCacheOnCPU(e);if(Ue().getBool("DEBUG")&&!Ue().getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")&&Ue().getNumber("WEBGL_VERSION")===2)throw new Error("tensor.data() with WEBGL_DOWNLOAD_FLOAT_ENABLED=false and WEBGL_VERSION=2 not yet supported.");let y=null,b;if(p!=="complex64"&&Ue().get("WEBGL_BUFFER_SUPPORTED")){b=this.decode(e);const F=this.texData.get(b.dataId);y=this.gpgpu.createBufferFromTexture(F.texture.texture,...zd(n))}this.pendingRead.set(e,[]),p!=="complex64"&&await this.gpgpu.createAndWaitForFence();let v;if(p==="complex64"){const F=await Promise.all([this.read(_.real.dataId),this.read(_.imag.dataId)]),L=F[0],N=F[1];v=ec(L,N)}else if(y==null)v=this.getValuesFromTexture(e);else{const F=Je(n);v=this.gpgpu.downloadFloat32MatrixFromBuffer(y,F)}if(b!=null&&this.disposeIntermediateTensorInfo(b),y!=null){const F=this.gpgpu.gl;Xt(F,()=>F.deleteBuffer(y))}const S=this.convertAndCacheOnCPU(e,v),M=this.pendingRead.get(e);return this.pendingRead.delete(e),M.forEach(F=>F(S)),this.pendingDisposal.has(e)&&(this.pendingDisposal.delete(e),this.disposeData(e)&&Va().removeDataId(e,this),this.pendingDeletes--),S}readToGPU(e,i={}){const s=this.texData.get(e),{values:n,shape:a,slice:p,dtype:_,isPacked:g,texture:y}=s;if(_==="complex64")throw new Error("Does not support reading texture for complex64 dtype.");if(p!=null){let M;g?M=new hx(a,cx):M=new y0(a,cx);const F=this.runWebGLProgram(M,[{dataId:e,shape:a,dtype:_}],_),L=this.readToGPU(F,i);return this.disposeIntermediateTensorInfo(F),L}if(y==null)throw n!=null?new Error("Data is not on GPU but on CPU."):new Error("There is no data on GPU or CPU.");const b=this.decode(e,i.customTexShape),v=Va().makeTensorFromTensorInfo(b),S=this.texData.get(b.dataId);return Object.assign({tensorRef:v},S.texture)}bufferSync(e){const i=this.readSync(e.dataId);if(e.dtype==="string")try{const s=i.map(n=>Gl(n));return Jr(e.shape,e.dtype,s)}catch{throw new Error("Failed to decode encoded string bytes into utf-8")}return Jr(e.shape,e.dtype,i)}checkNumericalProblems(e){if(e!=null)for(let i=0;i<e.length;i++){const s=e[i];if(!aB(s))throw Ue().getBool("WEBGL_RENDER_FLOAT32_CAPABLE")?Error("The value "+s+" cannot be represented with your current settings. Consider enabling float32 rendering: 'tf.env().set('WEBGL_RENDER_FLOAT32_ENABLED', true);'"):Error("The value "+s+" cannot be represented on this device.")}}getValuesFromTexture(e){const{shape:i,dtype:s,isPacked:n}=this.texData.get(e),a=Je(i);if(Ue().getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")){const S=this.decode(e),M=this.texData.get(S.dataId),F=this.gpgpu.downloadMatrixFromPackedTexture(M.texture.texture,...zd(i)).subarray(0,a);return this.disposeIntermediateTensorInfo(S),F}const p=Ue().getBool("WEBGL_PACK")&&n===!0,_=p?Yd(i):i,g=p?new T3(_):new v3(_),y=this.runWebGLProgram(g,[{shape:_,dtype:s,dataId:e}],"float32"),b=this.texData.get(y.dataId),v=this.gpgpu.downloadByteEncodedFloatMatrixFromOutputTexture(b.texture.texture,b.texShape[0],b.texShape[1]).subarray(0,a);return this.disposeIntermediateTensorInfo(y),v}timerAvailable(){return Ue().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0}time(e){const i=this.activeTimers,s=[];let n=!1;this.programTimersStack==null?(this.programTimersStack=s,n=!0):this.activeTimers.push(s),this.activeTimers=s,e();const a=Qx(this.activeTimers.map(g=>g.query)).filter(g=>g!=null),p=Qx(this.activeTimers.map(g=>g.name)).filter(g=>g!=null);this.activeTimers=i,n&&(this.programTimersStack=null);const _={uploadWaitMs:this.uploadWaitMs,downloadWaitMs:this.downloadWaitMs,kernelMs:null,wallMs:null};return(async()=>{if(Ue().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0){const g=await Promise.all(a);_.kernelMs=zi(g),_.getExtraProfileInfo=()=>g.map((y,b)=>({name:p[b],ms:y})).map(y=>y.name+": "+y.ms).join(", ")}else _.kernelMs={error:"WebGL query timers are not supported in this environment."};return this.uploadWaitMs=0,this.downloadWaitMs=0,_})()}memory(){return{unreliable:!1,numBytesInGPU:this.numBytesInGPU,numBytesInGPUAllocated:this.textureManager.numBytesAllocated,numBytesInGPUFree:this.textureManager.numBytesFree}}startTimer(){return Ue().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?this.gpgpu.beginQuery():{startMs:pa(),endMs:null}}endTimer(e){return Ue().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?(this.gpgpu.endQuery(),e):(e.endMs=pa(),e)}async getQueryTime(e){if(Ue().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0)return this.gpgpu.waitForQueryAndGetTime(e);const i=e;return i.endMs-i.startMs}disposeData(e,i=!1){if(this.pendingDisposal.has(e))return!1;if(!this.texData.has(e))return!0;if(i?this.texData.get(e).refCount=0:this.texData.get(e).refCount--,!i&&this.texData.get(e).refCount>0)return!1;if(this.pendingRead.has(e))return this.pendingDisposal.add(e),this.pendingDeletes++,!1;this.releaseGPUData(e);const{complexTensorInfos:s}=this.texData.get(e);return s!=null&&(this.disposeData(s.real.dataId,i),this.disposeData(s.imag.dataId,i)),this.texData.delete(e),!0}releaseGPUData(e){const{texture:i,dtype:s,texShape:n,usage:a,isPacked:p,slice:_}=this.texData.get(e),g=_&&_.origDataId||e,y=this.dataRefCount.get(g);y>1?this.dataRefCount.set(g,y-1):(this.dataRefCount.delete(g),i!=null&&(this.numBytesInGPU-=this.computeBytes(n,s),this.textureManager.releaseTexture(i,n,a,p)));const b=this.texData.get(e);b.texture=null,b.texShape=null,b.isPacked=!1,b.slice=null}getTexture(e){return this.uploadToGPU(e),this.texData.get(e).texture.texture}getDataInfo(e){return this.texData.get(e)}shouldExecuteOnCPU(e,i=jU){return Ue().getBool("WEBGL_CPU_FORWARD")&&e.every(s=>this.texData.get(s.dataId).texture==null&&Je(s.shape)<i)}getGPGPUContext(){return this.gpgpu}where(e){l0("tf.where() in webgl locks the UI thread. Call tf.whereAsync() instead");const i=e.dataSync();return HU(e.shape,i)}packedUnaryOp(e,i,s){const n=new hx(e.shape,i),a=this.compileAndRun(n,[e],s);return Va().makeTensorFromTensorInfo(a)}abs(e){if(this.shouldExecuteOnCPU([e])&&e.dtype!=="complex64"){const n=qv(this.texData.get(e.dataId).values);return this.makeOutput(e.shape,e.dtype,n)}if(Ue().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,tT,e.dtype);const i=new y0(e.shape,tT),s=this.compileAndRun(i,[e]);return Va().makeTensorFromTensorInfo(s)}makeTensorInfo(e,i,s){let n;if(i==="string"&&s!=null&&s.length>0&&yr(s[0])){const a=s.map(p=>$0(p));n=this.write(a,e,i)}else n=this.write(s,e,i);return this.texData.get(n).usage=null,{dataId:n,shape:e,dtype:i}}makeOutput(e,i,s){return Va().makeTensorFromTensorInfo(this.makeTensorInfo(e,i,s),this)}unpackTensor(e){const i=new zU(e.shape);return this.runWebGLProgram(i,[e],e.dtype)}packTensor(e){const i=new IU(e.shape),s=!0;return this.runWebGLProgram(i,[e],e.dtype,null,s)}packedReshape(e,i){const s=[rc(e.shape),...sc(e.shape)],n={dtype:e.dtype,shape:s,dataId:e.dataId},a=[rc(i),...sc(i)],p=new Qv(a,s),_=!0,g=[s],y=this.runWebGLProgram(p,[n],e.dtype,g,_);return{dataId:y.dataId,shape:i,dtype:y.dtype}}decode(e,i){const s=this.texData.get(e),{isPacked:n,shape:a,dtype:p}=s;if(i!=null){const S=Je(a),M=i[0]*i[1]*4;Te(S<=M,()=>"customTexShape is too small. Row * Column * 4 should be equal or larger than the size of the tensor data.")}const _=Yd(a);let g;n?g=new b3(_):g=new y3(_);const y=!0,b=[i??zd(_)],v=this.runWebGLProgram(g,[{shape:_,dtype:p,dataId:e}],p,b,y,i);return{dtype:p,shape:a,dataId:v.dataId}}runWebGLProgram(e,i,s,n,a=!1,p){const _=this.makeTensorInfo(e.outputShape,s),g=this.texData.get(_.dataId);if(e.packedOutput&&(g.isPacked=!0),e.outPackingScheme===Th.DENSE){const k=p??zd(e.outputShape);g.texShape=k.map(G=>G*2)}if(e.outTexUsage!=null&&(g.usage=e.outTexUsage),Je(_.shape)===0)return g.values=ut(_.dtype,0),_;const y=[],b=i.map(k=>{if(k.dtype==="complex64")throw new Error("GPGPUProgram does not support complex64 input. For complex64 dtypes, please separate the program into real and imaginary parts.");let G=this.texData.get(k.dataId);if(G.texture==null){if(!e.packedInputs&&Je(k.shape)<=Ue().getNumber("WEBGL_SIZE_UPLOAD_UNIFORM"))return{shape:k.shape,texData:null,isUniform:!0,uniformValues:G.values};e.packedInputs&&(G.isPacked=!0,G.shape=k.shape)}if(this.uploadToGPU(k.dataId),!!G.isPacked!=!!e.packedInputs)k=G.isPacked?this.unpackTensor(k):this.packTensor(k),y.push(k),G=this.texData.get(k.dataId);else if(G.isPacked&&!jd(G.shape,k.shape)){const H=k,z=k.shape;k.shape=G.shape,k=this.packedReshape(k,z),y.push(k),G=this.texData.get(k.dataId),H.shape=z}return{shape:k.shape,texData:G,isUniform:!1}});this.uploadToGPU(_.dataId);const v={shape:_.shape,texData:g,isUniform:!1},S=g3(e,b,v),M=this.getAndSaveBinary(S,()=>m3(this.gpgpu,e,b,v)),F=this.activeTimers!=null;let L;F&&(L=this.startTimer()),Ue().get("ENGINE_COMPILE_ONLY")||_3(this.gpgpu,M,b,v,n),y.forEach(k=>this.disposeIntermediateTensorInfo(k)),F&&(L=this.endTimer(L),this.activeTimers.push({name:e.constructor.name,query:this.getQueryTime(L)}));const N=Ue().getNumber("WEBGL_FLUSH_THRESHOLD");if(N>0){const k=pa();k-this.lastGlFlushTime>N&&(this.gpgpu.gl.flush(),this.lastGlFlushTime=k)}if(!Ue().getBool("WEBGL_LAZILY_UNPACK")&&g.isPacked&&a===!1){const k=this.unpackTensor(_);return this.disposeIntermediateTensorInfo(_),k}return _}compileAndRun(e,i,s,n,a=!1){return s=s||i[0].dtype,this.runWebGLProgram(e,i,s,n,a)}getAndSaveBinary(e,i){return e in this.binaryCache||(this.binaryCache[e]=i()),this.binaryCache[e]}getTextureManager(){return this.textureManager}dispose(){this.disposed||(Ue().getBool("IS_TEST")||Object.keys(this.binaryCache).forEach(e=>{this.gpgpu.deleteProgram(this.binaryCache[e].webGLProgram),delete this.binaryCache[e]}),this.textureManager.dispose(),this.canvas!=null&&typeof HTMLCanvasElement<"u"&&this.canvas instanceof HTMLCanvasElement?this.canvas.remove():this.canvas=null,this.gpgpuCreatedLocally&&(this.gpgpu.program=null,this.gpgpu.dispose()),this.disposed=!0)}floatPrecision(){return this.floatPrecisionValue==null&&(this.floatPrecisionValue=zr(()=>{if(!Ue().get("WEBGL_RENDER_FLOAT32_ENABLED")){const e=Ue().getBool("DEBUG");Ue().set("DEBUG",!1);const i=this.abs(p0(1e-8)).dataSync()[0];if(Ue().set("DEBUG",e),i>0)return 32}return 16})),this.floatPrecisionValue}epsilon(){return this.floatPrecision()===32?XU:YU}uploadToGPU(e){const i=this.texData.get(e),{shape:s,dtype:n,values:a,texture:p,usage:_,isPacked:g}=i;if(p!=null)return;const y=this.activeTimers!=null;let b;y&&(b=pa());let v=i.texShape;if(v==null&&(v=AB(s,g),i.texShape=v),a!=null){const S=Yd(s);let M,F=v[1],L=v[0];const N=a instanceof Uint8Array||a instanceof Uint8ClampedArray;(g||!N)&&([F,L]=ic(v[0],v[1])),g?M=new A3(S,N):M=new _v(S,N);const k=N?[L,F]:v,G=this.makeTensorInfo(k,n),H=this.texData.get(G.dataId);N?H.usage=ma.PIXELS:H.usage=ma.UPLOAD,H.texShape=k,this.gpgpu.uploadDenseMatrixToTexture(this.getTexture(G.dataId),F,L,a);const z=[[L,F]],W=!0,Y=this.runWebGLProgram(M,[G],n,z,W),Z=this.texData.get(Y.dataId);i.texShape=Z.texShape,i.isPacked=Z.isPacked,i.usage=Z.usage,Ue().get("ENGINE_COMPILE_ONLY")?this.disposeData(Y.dataId):(i.texture=Z.texture,i.values=null,this.texData.delete(Y.dataId)),this.disposeIntermediateTensorInfo(G),y&&(this.uploadWaitMs+=pa()-b)}else{const S=this.acquireTexture(v,_,n,g);i.texture=S}}convertAndCacheOnCPU(e,i){const s=this.texData.get(e),{dtype:n}=s;return i!=null&&(s.values=QU(i,n)),s.values}acquireTexture(e,i,s,n){if(this.numBytesInGPU+=this.computeBytes(e,s),!this.warnedAboutMemory&&this.numBytesInGPU>this.numMBBeforeWarning*1024*1024){const a=(this.numBytesInGPU/1024/1024).toFixed(2);this.warnedAboutMemory=!0,console.warn("High memory usage in GPU: "+a+" MB, most likely due to a memory leak")}return this.textureManager.acquireTexture(e,i,n)}computeBytes(e,i){return e[0]*e[1]*Pi(i)}checkCompileCompletion(){for(const[,e]of Object.entries(this.binaryCache))this.checkCompletion_(e)}async checkCompileCompletionAsync(){const e=[];if(this.gpgpu.parallelCompilationExtension){for(const[,i]of Object.entries(this.binaryCache))e.push(this.checkCompletionAsync_(i));return Promise.all(e)}else{for(const[,i]of Object.entries(this.binaryCache)){const s=new Promise(n=>{try{this.checkCompletion_(i),n(!0)}catch(a){throw a}});e.push(s)}return Promise.all(e)}}async checkCompletionAsync_(e){return this.gpgpu.gl.getProgramParameter(e.webGLProgram,this.gpgpu.parallelCompilationExtension.COMPLETION_STATUS_KHR)?this.checkCompletion_(e):(await jF(),this.checkCompletionAsync_(e))}checkCompletion_(e){if(this.gpgpu.gl.getProgramParameter(e.webGLProgram,this.gpgpu.gl.LINK_STATUS)===!1)throw console.log(this.gpgpu.gl.getProgramInfoLog(e.webGLProgram)),this.gpgpu.gl.getShaderParameter(e.fragmentShader,this.gpgpu.gl.COMPILE_STATUS)===!1?(av(e.source,this.gpgpu.gl.getShaderInfoLog(e.fragmentShader)),new Error("Failed to compile fragment shader.")):new Error("Failed to link vertex and fragment shaders.");return!0}getUniformLocations(){for(const e of Object.values(this.binaryCache)){this.gpgpu.buildVao(e.webGLProgram);const{variablesLocations:i,customUniformLocations:s,infLoc:n,nanLoc:a,outShapeLocation:p,outShapeStridesLocation:_,outTexShapeLocation:g}=pv(this.gpgpu,e.program,e.webGLProgram);e.variablesLocations=i,e.customUniformLocations=s,e.infLoc=n,e.nanLoc=a,e.outShapeLocation=p,e.outShapeStridesLocation=_,e.outTexShapeLocation=g}}createTensorFromGPUData(e,i,s){e.channels=e.channels||"RGBA";const{texture:n,height:a,width:p,channels:_}=e,g=Va().backend;if(!g.gpgpu.gl.isTexture(n))throw new Error("The texture is invalid. Also, please make sure the texture and the TFJS WebGL backend are using the same canvas. If you want to use your own custom canvas, you have to create and use the custom TFJS WebGL backend created from the canvas through 'new tf.MathBackendWebGL(customCanvas)'.");const y=g.writeTexture(n,i,s,a,p,_);return Va().makeTensorFromDataId(y,i,s,g)}}ll.nextDataId=0;function QU(l,e){if(e==="float32"||e==="complex64")return l;if(e==="int32"||e==="bool"){const i=e==="int32"?new Int32Array(l.length):new Uint8Array(l.length);for(let s=0;s<i.length;++s)i[s]=Math.round(l[s]);return i}else throw new Error("Unknown dtype "+e)}vy()&&Yy("webgl",()=>new ll,2);const iT="return abs(x);";function $U(l){const{inputs:e,backend:i}=l,{x:s}=e;if(i.shouldExecuteOnCPU([s])&&s.dtype!=="complex64"){const a=i.texData.get(s.dataId),p=qv(a.values);return i.makeTensorInfo(s.shape,s.dtype,p)}let n;return Ue().getBool("WEBGL_PACK_UNARY_OPERATIONS")?n=new hx(s.shape,iT):n=new y0(s.shape,iT),i.runWebGLProgram(n,[s],s.dtype)}const JU={kernelName:gt,backendName:"webgl",kernelFunc:$U},_m=`
  if (isnan(a)) return a;
  if (isnan(b)) return b;
`;class $d{constructor(e,i,s){this.variableNames=["A","B"],this.outputShape=is(i,s),this.enableShapeUniforms=An(this.outputShape.length),this.userCode=`
      float binaryOperation(float a, float b) {
        `+e+`
      }

      void main() {
        float a = getAAtOutCoords();
        float b = getBAtOutCoords();
        setOutput(binaryOperation(a, b));
      }
    `}}const lc=`
  result.r = isNaN.r ? NAN : result.r;
  result.g = isNaN.g ? NAN : result.g;
  result.b = isNaN.b ? NAN : result.b;
  result.a = isNaN.a ? NAN : result.a;
`;class gm{constructor(e,i,s,n=!1){this.variableNames=["A","B"],this.supportsBroadcasting=!0,this.packedInputs=!0,this.packedOutput=!0,this.outputShape=is(i,s);const a=this.outputShape.length;this.enableShapeUniforms=An(a);let p="";if(n)if(a===0||Je(this.outputShape)===1)p=`
          result.y = 0.;
          result.z = 0.;
          result.w = 0.;
        `;else if(p=`
          `+En(a)+` coords = getOutputCoords();
        `,a===1)this.enableShapeUniforms?p+=`
            result.y = (coords + 1) >= outShape ? 0. : result.y;
            result.z = 0.;
            result.w = 0.;
          `:p+=`
            result.y = (coords + 1) >= `+this.outputShape[0]+` ? 0. : result.y;
            result.z = 0.;
            result.w = 0.;
          `;else{const _=lx("coords",a);this.enableShapeUniforms?p+=`
            bool nextRowOutOfBounds =
              (`+_[a-2]+" + 1) >= outShape["+a+` - 2];
            bool nextColOutOfBounds =
              (`+_[a-1]+" + 1) >= outShape["+a+` - 1];
            result.y = nextColOutOfBounds ? 0. : result.y;
            result.z = nextRowOutOfBounds ? 0. : result.z;
            result.w = nextColOutOfBounds || nextRowOutOfBounds ? 0. : result.w;
          `:p+=`
            bool nextRowOutOfBounds =
              (`+_[a-2]+" + 1) >= "+this.outputShape[a-2]+`;
            bool nextColOutOfBounds =
              (`+_[a-1]+" + 1) >= "+this.outputShape[a-1]+`;
            result.y = nextColOutOfBounds ? 0. : result.y;
            result.z = nextRowOutOfBounds ? 0. : result.z;
            result.w = nextColOutOfBounds || nextRowOutOfBounds ? 0. : result.w;
          `}this.userCode=`
      vec4 binaryOperation(vec4 a, vec4 b) {
        `+e+`
      }

      void main() {
        vec4 a = getAAtOutCoords();
        vec4 b = getBAtOutCoords();

        vec4 result = binaryOperation(a, b);
        `+p+`

        setOutput(result);
      }
    `}}function Xa(l){const{inputs:e,backend:i}=l,{x:s}=e;return i.incRef(s.dataId),{dataId:s.dataId,shape:s.shape,dtype:s.dtype}}const e4={kernelName:Ju,backendName:"webgl",kernelFunc:Xa};function Mh(l){const{inputs:e,backend:i}=l,{real:s,imag:n}=e,a=i.makeTensorInfo(s.shape,"complex64"),p=i.texData.get(a.dataId),_=Xa({inputs:{x:s},backend:i}),g=Xa({inputs:{x:n},backend:i});return p.complexTensorInfos={real:_,imag:g},a}const t4="return (a < 0.) ? b * a : a;",i4=`
  vec4 aLessThanZero = vec4(lessThan(a, vec4(0.)));
  return (aLessThanZero * (b * a)) + ((vec4(1.0) - aLessThanZero) * a);
`,rT="return (a < 0.) ? b * a : a;",sT=`
  vec4 aLessThanZero = vec4(lessThan(a, vec4(0.)));
  return (aLessThanZero * (b * a)) + ((vec4(1.0) - aLessThanZero) * a);
`;function r4(l){const{inputs:e,backend:i}=l,{x:s,alpha:n}=e,a=Ue().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new gm(sT,s.shape,n.shape):new $d(rT,s.shape,n.shape);return i.runWebGLProgram(a,[s,n],"float32")}const s4={kernelName:Af,backendName:"webgl",kernelFunc:r4},ym="if (isnan(x)) return x;";function ux({opSnippet:l,packedOpSnippet:e,cpuKernelImpl:i,dtype:s}){return({inputs:n,backend:a})=>{const{x:p}=n,_=a,g=s||p.dtype;if(_.shouldExecuteOnCPU([p])&&i!=null){const v=_.texData.get(p.dataId),S=i(v.values,g);return _.makeTensorInfo(p.shape,g,S)}const y=Ue().getBool("WEBGL_PACK_UNARY_OPERATIONS")&&e!=null;let b;return y?b=new hx(p.shape,e):b=new y0(p.shape,l),_.runWebGLProgram(b,[p],g)}}function ga({opSnippet:l,packedOpSnippet:e,checkOutOfBounds:i=!1,supportsComplex:s=!1,cpuKernelImpl:n,dtype:a}){return({inputs:p,backend:_})=>{const{a:g,b:y}=p,b=_;if(s&&g.dtype==="complex64"){const F=b.texData.get(g.dataId),L=b.texData.get(y.dataId),[N,k]=[[F.complexTensorInfos.real,L.complexTensorInfos.real],[F.complexTensorInfos.imag,L.complexTensorInfos.imag]].map(H=>{const[z,W]=H,Y={dataId:z.dataId,dtype:z.dtype,shape:g.shape},Z={dataId:W.dataId,dtype:W.dtype,shape:y.shape},Q=new $d(l,g.shape,y.shape);return b.runWebGLProgram(Q,[Y,Z],Do(z.dtype,W.dtype))}),G=Mh({inputs:{real:N,imag:k},backend:b});return b.disposeIntermediateTensorInfo(N),b.disposeIntermediateTensorInfo(k),G}const v=a||Do(g.dtype,y.dtype);if((g.dtype==="string"||y.dtype==="string"||b.shouldExecuteOnCPU([g,y]))&&n!=null){const F=b.texData.get(g.dataId).values,L=b.texData.get(y.dataId).values,N=g.dtype==="string"?nx(F):F,k=g.dtype==="string"?nx(L):L,[G,H]=n(g.shape,y.shape,N,k,v),z=b.makeTensorInfo(H,v),W=b.texData.get(z.dataId);return W.values=G,z}const S=Ue().getBool("WEBGL_PACK_BINARY_OPERATIONS")&&e!=null;let M;return S?M=new gm(e,g.shape,y.shape,i):M=new $d(l,g.shape,y.shape),b.runWebGLProgram(M,[g,y],v)}}function Ph(l,e=!1){if(l==="linear")return e?kU:DU;if(l==="relu")return e?VU:LU;if(l==="elu")return e?UU:FU;if(l==="relu6")return e?GU:NU;if(l==="prelu")return e?sT:rT;if(l==="leakyrelu")return e?i4:t4;if(l==="sigmoid")return e?WU:BU;throw new Error("Activation "+l+" has not been implemented for the WebGL backend.")}const nT="return a + b;",n4=ga({opSnippet:nT,packedOpSnippet:nT,supportsComplex:!0,cpuKernelImpl:nU}),a4={kernelName:Yx,backendName:"webgl",kernelFunc:n4};class o4{constructor(e,i){this.outputShape=[],this.outputShape=e,this.variableNames=i.map((a,p)=>"T"+p);const s=[];this.variableNames.forEach(a=>{s.push("float v"+a+" = get"+a+"AtOutCoords();")});const n=this.variableNames.map(a=>"v"+a).join(" + ");this.userCode=`
      void main() {
        `+s.join(`
        `)+`

        float result = `+n+`;
        setOutput(result);
      }
    `}}class x4{constructor(e,i){this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e,this.variableNames=i.map((a,p)=>"T"+p);const s=[];this.variableNames.forEach(a=>{s.push("vec4 v"+a+" = get"+a+"AtOutCoords();")});const n=this.variableNames.map(a=>"v"+a).join(" + ");this.userCode=`
      void main() {
        `+s.join(`
        `)+`

        vec4 result = `+n+`;
        setOutput(result);
      }
    `}}function Jd(l){const{inputs:e,backend:i}=l,s=e;if(s.length===1)return Xa({inputs:{x:s[0]},backend:i});if(s.length>Ue().getNumber("WEBGL_MAX_TEXTURES_IN_SHADER")){const _=Math.floor(s.length/2),g=Jd({inputs:s.slice(0,_),backend:i}),y=Jd({inputs:s.slice(_),backend:i});return Jd({inputs:[g,y],backend:i})}const n=s.map(_=>_.dtype).reduce((_,g)=>Do(_,g)),a=s.map(_=>_.shape),p=Ue().getBool("WEBGL_PACK")?new x4(s[0].shape,a):new o4(s[0].shape,a);return i.runWebGLProgram(p,s,n)}const l4={kernelName:Xu,backendName:"webgl",kernelFunc:Jd},c4=_m+`
  return atan(a, b);
`,h4=`
  vec4 result = atan(a, b);
  bvec4 isNaNA = isnan(a);
  bvec4 isNaNB = isnan(b);
  bvec4 isNaN = bvec4(isNaNA.x || isNaNB.x, isNaNA.y || isNaNB.y, isNaNA.z || isNaNB.z, isNaNA.w || isNaNB.w);
  `+lc+`
  return result;
`,u4=ga({opSnippet:c4,packedOpSnippet:h4}),d4={kernelName:Yu,backendName:"webgl",kernelFunc:u4};class aT{constructor(e,i,s,n=!1,a=!1){if(this.variableNames=["x"],i==="avg"&&s)throw new Error("Cannot compute positions for average pool.");const p=e.filterWidth,_=e.strideHeight,g=e.strideWidth,y=e.dilationHeight,b=e.dilationWidth,v=e.effectiveFilterHeight,S=e.effectiveFilterWidth,M=e.padInfo.top,F=e.padInfo.left;this.outputShape=e.outShape;const L=i==="avg",N="((batch  * "+e.inHeight+" + xR) * "+e.inWidth+" + xC) * "+e.inChannels+" + d",k="(xR * "+e.inWidth+" + xC) * "+e.inChannels+" + d";let G="0.0";if(L||(G="-1.0 / 1e-20"),s){const Q=">=";this.userCode=`
        const ivec2 strides = ivec2(`+_+", "+g+`);
        const ivec2 pads = ivec2(`+M+", "+F+`);

        void main() {
          ivec4 coords = getOutputCoords();
          int batch = coords[0];
          int d = coords[3];

          ivec2 xRCCorner = coords.yz * strides - pads;
          int xRCorner = xRCCorner.x;
          int xCCorner = xRCCorner.y;

          // max/min x(?, ?, d) to get y(yR, yC, d).
          // ? = to be determined
          float minMaxValue = 0.0;
          float minMaxValueFound = 0.0;
          int minMaxPosition = 0;
          float avgValue = 0.0;

          for (int wR = 0; wR < `+v+`;
              wR += `+y+`) {
            int xR = xRCorner + wR;

            if (xR < 0 || xR >= `+e.inHeight+`) {
              continue;
            }

            for (int wC = 0; wC < `+S+`;
                wC += `+b+`) {
              int xC = xCCorner + wC;

              if (xC < 0 || xC >= `+e.inWidth+`) {
                continue;
              }

              float value = getX(batch, xR, xC, d);

              // If a min / max value has already been found, use it. If not,
              // use the current value.
              float currMinMaxValue = mix(
                  value, minMaxValue, minMaxValueFound);
              if (value `+Q+` currMinMaxValue) {
                minMaxValue = value;
                minMaxValueFound = 1.0;
                minMaxPosition = `+(n?a?N:k:"wR * "+S+" + wC")+`;
              }
            }
          }
          setOutput(float(minMaxPosition));
        }
      `;return}const H="max";let z=i+"("+i+"("+i+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";i==="avg"&&(z="avgValue / max(count, 1.0)");const W=Math.floor(p/4)*4,Y=p%4,Z=`
      if (`+L+`) {
        avgValue += dot(values, ones);
      } else {
        minMaxValue = `+H+`(values, minMaxValue);
      }
    `;this.userCode=`
      const ivec2 strides = ivec2(`+_+", "+g+`);
      const ivec2 pads = ivec2(`+M+", "+F+`);
      const float initializationValue = `+G+`;
      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);

      float count = 0.0;

      float getValue(int batch, int xR, int xC, int d) {
        if (xC < 0 || xC >= `+e.inWidth+`) {
          return initializationValue;
        }
        count += 1.0;
        return getX(batch, xR, xC, d);
      }

      void main() {
        ivec4 coords = getOutputCoords();
        int batch = coords[0];
        int d = coords[3];

        ivec2 xRCCorner = coords.yz * strides - pads;
        int xRCorner = xRCCorner.x;
        int xCCorner = xRCCorner.y;

        // max/min x(?, ?, d) to get y(yR, yC, d).
        // ? = to be determined
        vec4 minMaxValue = vec4(`+G+`);
        float avgValue = 0.0;
        count = 0.0;

        for (int wR = 0; wR < `+v+`;
            wR += `+y+`) {
          int xR = xRCorner + wR;

          if (xR < 0 || xR >= `+e.inHeight+`) {
            continue;
          }

          for (int wC = 0; wC < `+W+`; wC += 4) {
            int xC = xCCorner + wC * `+b+`;

            vec4 values = vec4(
              getValue(batch, xR, xC, d),
              getValue(batch, xR, xC + `+b+`, d),
              getValue(batch, xR, xC + 2 * `+b+`, d),
              getValue(batch, xR, xC + 3 * `+b+`, d)
            );

            `+Z+`
          }

          int xC = xCCorner + `+W+`;
          if (`+(Y===1)+`) {
            vec4 values = vec4(
              getValue(batch, xR, xC, d),
              initializationValue,
              initializationValue,
              initializationValue
            );

            `+Z+`
          } else if (`+(Y===2)+`) {
            vec4 values = vec4(
              getValue(batch, xR, xC, d),
              getValue(batch, xR, xC + `+b+`, d),
              initializationValue,
              initializationValue
            );

            `+Z+`
          } else if (`+(Y===3)+`) {
            vec4 values = vec4(
              getValue(batch, xR, xC, d),
              getValue(batch, xR, xC + `+b+`, d),
              getValue(batch, xR, xC + 2 * `+b+`, d),
              initializationValue
            );

            `+Z+`
          }
        }
        setOutput(`+z+`);
      }
    `}}function f4(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e;cv(n,"avgPool");const{filterSize:a,strides:p,pad:_,dimRoundingMode:g}=s,y=1;Te(ta(p,y),()=>"Error in avgPool: Either strides or dilations must be 1. Got strides "+p+" and dilations '"+y+"'");const b=jl(n.shape,a,p,y,_,g);if(b.filterWidth===1&&b.filterHeight===1&&qt(b.inShape,b.outShape))return Xa({inputs:{x:n},backend:i});const v=new aT(b,"avg",!1);return i.runWebGLProgram(v,[n],"float32")}const p4={kernelName:of,backendName:"webgl",kernelFunc:f4};class oT{constructor(e,i,s,n=!1,a=!1,p=!1,_=null,g=!1,y=!1){this.variableNames=["matrixA","matrixB"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=s,this.enableShapeUniforms=An(this.outputShape.length);const b=n?e[1]:e[2],v=Math.ceil(b/2),S=n?"i * 2, rc.y":"rc.y, i * 2",M=a?"rc.z, i * 2":"i * 2, rc.z",F=n?["a.xxyy","a.zzww"]:["a.xxzz","a.yyww"],L=a?["b.xzxz","b.ywyw"]:["b.xyxy","b.zwzw"];let N="",k="";_&&(g?N=`vec4 activation(vec4 a) {
          vec4 b = getPreluActivationWeightsAtOutCoords();
          `+_+`
        }`:y?N=`vec4 activation(vec4 a) {
          vec4 b = getLeakyreluAlphaAtOutCoords();
          `+_+`
        }`:N=`vec4 activation(vec4 x) {
          `+_+`
        }`,k="result = activation(result);");const G=p?"result += getBiasAtOutCoords();":"";p&&this.variableNames.push("bias"),g&&this.variableNames.push("preluActivationWeights"),y&&this.variableNames.push("leakyreluAlpha");let H="rc.x",z="rc.x";e[0]<i[0]?H="imod(rc.x, "+e[0]+")":i[0]<e[0]&&(z="imod(rc.x, "+i[0]+")"),this.userCode=`
      `+N+`
      // Don't use uniform for sharedDimensionPacked for performance.
      const float sharedDimension = `+v+`.0;

      vec4 dot2x2ARowBCol(ivec3 rc) {
        vec4 result = vec4(0);
        int batchA = `+H+`;
        int batchB = `+z+`;
        for (int i = 0; i < `+v+`; i++) {
          vec4 a = getMatrixA(batchA, `+S+`);
          vec4 b = getMatrixB(batchB, `+M+`);

          // These swizzled products need to be separately added.
          // See: https://github.com/tensorflow/tfjs/issues/1735
          result += (`+F[0]+" * "+L[0]+`);
          result += (`+F[1]+" * "+L[1]+`);
        }
        return result;
      }

      void main() {
        ivec3 rc = getOutputCoords();
        vec4 result = dot2x2ARowBCol(rc);

        `+G+`

        `+k+`

        setOutput(result);
      }
    `}}const xT={REAL:"return areal * breal - aimag * bimag;",IMAG:"return areal * bimag + aimag * breal;"};class lT{constructor(e,i,s){this.variableNames=["AReal","AImag","BReal","BImag"],this.outputShape=is(i,s),this.userCode=`
      float binaryOpComplex(
          float areal, float aimag, float breal, float bimag) {
        `+e+`
      }

      void main() {
        float areal = getARealAtOutCoords();
        float aimag = getAImagAtOutCoords();
        float breal = getBRealAtOutCoords();
        float bimag = getBImagAtOutCoords();
        setOutput(binaryOpComplex(areal, aimag, breal, bimag));
      }
    `}}const cT="return a * b;";function hT(l){const{inputs:e,backend:i}=l,{a:s,b:n}=e,a=Do(s.dtype,n.dtype);if(s.dtype==="complex64"){const _=i.texData.get(s.dataId),g=i.texData.get(n.dataId),y=new lT(xT.REAL,s.shape,n.shape),b=new lT(xT.IMAG,s.shape,n.shape),v=[{dataId:_.complexTensorInfos.real.dataId,dtype:_.complexTensorInfos.real.dtype,shape:s.shape},{dataId:_.complexTensorInfos.imag.dataId,dtype:_.complexTensorInfos.imag.dtype,shape:s.shape},{dataId:g.complexTensorInfos.real.dataId,dtype:g.complexTensorInfos.real.dtype,shape:n.shape},{dataId:g.complexTensorInfos.imag.dataId,dtype:g.complexTensorInfos.imag.dtype,shape:n.shape}],S=i.runWebGLProgram(y,v,"float32"),M=i.runWebGLProgram(b,v,"float32"),F=Mh({inputs:{real:S,imag:M},backend:i});return i.disposeIntermediateTensorInfo(S),i.disposeIntermediateTensorInfo(M),F}if(i.shouldExecuteOnCPU([s,n])){const _=i.texData.get(s.dataId),g=i.texData.get(n.dataId),[y,b]=mU(s.shape,n.shape,_.values,g.values,a),v=i.makeTensorInfo(b,a),S=i.texData.get(v.dataId);return S.values=y,v}let p;return Ue().getBool("WEBGL_PACK_BINARY_OPERATIONS")?p=new gm(cT,s.shape,n.shape):p=new $d(cT,s.shape,n.shape),i.runWebGLProgram(p,[s,n],a)}const m4={kernelName:ad,backendName:"webgl",kernelFunc:hT};function _4(l,e,i){const s=[rc(l.shape),...sc(l.shape)],n={dtype:l.dtype,shape:s,dataId:l.dataId},a=[rc(e),...sc(e)],p=new Qv(a,s),_=!0,g=[s],y=i.runWebGLProgram(p,[n],l.dtype,g,_);return{dataId:y.dataId,shape:e,dtype:y.dtype}}function Qi(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{shape:a}=s,p=i,_=Je(n.shape),g=Xi(a,_),y=Je(g);Te(_===y,()=>"The new shape ("+g+") has "+y+" elements and the old shape ("+n.shape+") has "+_+" elements. The new shape and old shape must have the same number of elements.");const b=p.texData.get(n.dataId);return b.isPacked&&!jd(n.shape,g)&&!(b.texture!==null&&jd(b.shape,g))?_4(n,g,p):(p.incRef(n.dataId),{dataId:n.dataId,shape:g,dtype:n.dtype})}const g4={kernelName:Rf,backendName:"webgl",kernelFunc:Qi};class uT{constructor(e,i){this.variableNames=["x"];const{windowSize:s,batchSize:n,inSize:a,outSize:p}=e;this.outputShape=[n,p];const _=Math.floor(s/4)*4,g=s%4;let y="sumValue += dot(values, ones);";if(i!=null){const v=1/i;y="sumValue += dot(values * "+(nr(v)?v.toPrecision(2):v)+", ones);"}let b="";a%s>0&&(b=`
        if (inIdx < 0 || inIdx >= `+a+`) {
          return 0.0;
        }
      `),this.userCode=`
      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);

      float getValue(int batch, int inIdx) {
        `+b+`
        return getX(batch, inIdx);
      }

      void main() {
        ivec2 coords = getOutputCoords();
        int batch = coords[0];
        int outIdx = coords[1];
        int inOffset = outIdx * `+s+`;

        float sumValue = 0.0;

        for (int i = 0; i < `+_+`; i += 4) {
          int inIdx = inOffset + i;
          vec4 values = vec4(
            getValue(batch, inIdx),
            getValue(batch, inIdx + 1),
            getValue(batch, inIdx + 2),
            getValue(batch, inIdx + 3)
          );

          `+y+`
        }

        int inIdx = inOffset + `+_+`;
        if (`+(g===1)+`) {
          vec4 values = vec4(getValue(batch, inIdx), 0.0, 0.0, 0.0);

          `+y+`
        } else if (`+(g===2)+`) {
          vec4 values = vec4(
            getValue(batch, inIdx),
            getValue(batch, inIdx + 1), 0.0, 0.0);

          `+y+`
        } else if (`+(g===3)+`) {
          vec4 values = vec4(
            getValue(batch, inIdx),
            getValue(batch, inIdx + 1),
            getValue(batch, inIdx + 2), 0.0);

          `+y+`
        }
        setOutput(sumValue);
      }
    `}}class y4{constructor(e,i){this.variableNames=["x"];const{windowSize:s,batchSize:n,inSize:a,outSize:p}=e;this.outputShape=[n,p];let _="0.0",g="";i==="prod"?_="1.0":i==="min"?(_="1.0 / 1e-20",g="min"):i==="max"&&(_="-1.0 / 1e-20",g="max");let y=i+"("+i+"("+i+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";i==="sum"?y="sumValue":i==="prod"?y="prodValue":i==="all"?y="allValue":i==="any"&&(y="anyValue");const b=Math.floor(s/4)*4,v=s%4;let S=`
      if (`+(i==="sum")+`) {
        sumValue += dot(values, ones);
      } else if (`+(i==="prod")+`) {
        vec2 tmp = vec2(values[0], values[1]) * vec2(values[2], values[3]);
        prodValue *= tmp[0] * tmp[1];
      } else {
        minMaxValue = `+g+`(values, minMaxValue);
        if (`+(i==="min")+" || "+(i==="max")+`) {
          minMaxValue = `+g+`(values, minMaxValue);
          bvec4 isNaN = isnan(values);
          if (isNaN.r || isNaN.g || isNaN.b || isNaN.a) {
            minMaxValue = vec4(NAN);
          }
        }
      }
    `,M="vec4";i==="all"?(_="1.0",S=`
        bool reducedAllValue = all(values);
        float floatedReducedAllValue = float(reducedAllValue);
        allValue = float(allValue >= 1.0 && floatedReducedAllValue >= 1.0);
      `,M="bvec4"):i==="any"&&(_="0.0",S=`
        bool reducedAnyValue = any(values);
        float floatedReducedAnyValue = float(reducedAnyValue);
        anyValue = float(anyValue >= 1.0 || floatedReducedAnyValue >= 1.0);
      `,M="bvec4");let F="";a%s>0&&(F=`
        if (inIdx < 0 || inIdx >= `+a+`) {
          return initializationValue;
        }
      `),this.userCode=`
      const float initializationValue = `+_+`;
      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);

      float getValue(int batch, int inIdx) {
        `+F+`
        return getX(batch, inIdx);
      }

      void main() {
        ivec2 coords = getOutputCoords();
        int batch = coords[0];
        int outIdx = coords[1];
        int inOffset = outIdx * `+s+`;

        vec4 minMaxValue = vec4(`+_+`);
        float prodValue = 1.0;
        float sumValue = 0.0;
        float allValue = 1.0;
        float anyValue = 0.0;

        for (int i = 0; i < `+b+`; i += 4) {
          int inIdx = inOffset + i;
          `+M+" values = "+M+`(
            getValue(batch, inIdx),
            getValue(batch, inIdx + 1),
            getValue(batch, inIdx + 2),
            getValue(batch, inIdx + 3)
          );

          `+S+`
        }

        int inIdx = inOffset + `+b+`;
        if (`+(v===1)+`) {
          `+M+" values = "+M+`(
            getValue(batch, inIdx),
            initializationValue,
            initializationValue,
            initializationValue
          );

          `+S+`
        } else if (`+(v===2)+`) {
          `+M+" values = "+M+`(
            getValue(batch, inIdx),
            getValue(batch, inIdx + 1),
            initializationValue,
            initializationValue
          );

          `+S+`
        } else if (`+(v===3)+`) {
          `+M+" values = "+M+`(
            getValue(batch, inIdx),
            getValue(batch, inIdx + 1),
            getValue(batch, inIdx + 2),
            initializationValue
          );

          `+S+`
        }
        setOutput(`+y+`);
      }
    `}}function b4(l){const e=[];for(;e.length===0||e[e.length-1].outSize!==1;){const i=e.length?e[e.length-1].outSize:l[1],s=Sb(i);e.push({inSize:i,windowSize:s,outSize:Math.ceil(i/s)})}return e}function e2(l,e,i,s){const n=b4(l.shape);let a=l;for(let p=0;p<n.length;p++){const{inSize:_,windowSize:g,outSize:y}=n[p];let b,v;i==="mean"?b=p===0?new uT({windowSize:g,inSize:_,batchSize:l.shape[0],outSize:y},_):new uT({windowSize:g,inSize:_,batchSize:l.shape[0],outSize:y}):b=new y4({windowSize:g,inSize:_,batchSize:l.shape[0],outSize:y},i),v=a,a=s.runWebGLProgram(b,[a],e),v.dataId!==l.dataId&&s.disposeIntermediateTensorInfo(v)}return a}class v4{constructor(e,i){this.variableNames=["A"];const s=new Array(e.length);for(let p=0;p<s.length;p++)s[p]=e[i[p]];this.outputShape=s,this.rank=s.length;const n=En(this.rank),a=T4(i);this.userCode=`
    void main() {
      `+n+` resRC = getOutputCoords();
      setOutput(getA(`+a+`));
    }
    `}}function T4(l){const e=l.length;if(e>6)throw Error("Transpose for rank "+e+" is not yet supported");const i=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u","resRC.v"],s=new Array(e);for(let n=0;n<l.length;n++)s[l[n]]=i[n];return s.join()}class E4{constructor(e,i){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0;const s=new Array(e.length);for(let b=0;b<s.length;b++)s[b]=e[i[b]];if(this.outputShape=s,this.rank=s.length,this.rank>6)throw Error("Packed transpose for rank "+this.rank+" is not yet supported.");const n=En(this.rank),a=Zv("rc",this.rank),p=new Array(this.rank);for(let b=0;b<i.length;b++)p[i[b]]=a[b];const _="vec2("+p.slice(-2).join()+")",g="++"+a[this.rank-1]+" < "+s[this.rank-1],y="getChannel(getA("+p.join()+"), "+_+")";this.userCode=`
    void main() {
      `+n+` rc = getOutputCoords();
      vec4 result = vec4(0.);
      result[0] = `+y+`;
      if(`+g+`) {
        result[1] = `+y+`;
      }
      --`+a[this.rank-1]+`;
      if(++`+a[this.rank-2]+" < "+s[this.rank-2]+`) {
        result[2] = `+y+`;
        if(`+g+`) {
          result[3] = `+y+`;
        }
      }
      setOutput(result);
    }
    `}}function t2(l,e,i){const s=Ue().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new E4(l.shape,e):new v4(l.shape,e);return i.runWebGLProgram(s,[l],l.dtype)}function A4(l,e,i,s){const n=e,a=l.shape.length,p=jt(n,l.shape);let _=p;const g=rx(_,a),y=g!=null;let b=l;y&&(b=t2(l,g,s),_=sx(_.length,a)),ix("sum",_,a);const[v,S]=Fo(b.shape,_);let M=v;i&&(M=f0(v,p));const F=Je(S),L=Je(l.shape)/F,N=Qi({inputs:{x:b},attrs:{shape:[L,F]},backend:s}),k=bP(l.dtype),G=e2(N,k,"sum",s),H=Qi({inputs:{x:G},attrs:{shape:M},backend:s});return s.disposeIntermediateTensorInfo(N),s.disposeIntermediateTensorInfo(G),y&&s.disposeIntermediateTensorInfo(b),H}function dT(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{axis:a,keepDims:p}=s;return A4(n,a,p,i)}const C4={kernelName:Mf,backendName:"webgl",kernelFunc:dT};function i2(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{perm:a}=s,p=i,_=n.shape.length,g=new Array(_);for(let b=0;b<g.length;b++)g[b]=n.shape[a[b]];let y;if(p.shouldExecuteOnCPU([n])){const b=p.texData.get(n.dataId).values,v=pm(b,n.shape,n.dtype,a,g);y=p.makeTensorInfo(g,n.dtype);const S=p.texData.get(y.dataId);S.values=v}else y=t2(n,a,p);return y}const R4={kernelName:ih,backendName:"webgl",kernelFunc:i2},fT=1e3;function r2({a:l,b:e,transposeA:i,transposeB:s,backend:n,bias:a=null,preluActivationWeights:p=null,leakyreluAlpha:_=0,activation:g=null}){const y=l.shape.length,b=e.shape.length,v=i?l.shape[y-2]:l.shape[y-1],S=s?e.shape[b-1]:e.shape[b-2],M=i?l.shape[y-1]:l.shape[y-2],F=s?e.shape[b-2]:e.shape[b-1],L=l.shape.slice(0,-2),N=e.shape.slice(0,-2),k=Je(L),G=Je(N),H=is(l.shape.slice(0,-2),e.shape.slice(0,-2)).concat([M,F]);Te(v===S,()=>"Error in matMul: inner shapes ("+v+") and ("+S+") of Tensors with shapes "+l.shape+" and "+e.shape+" and transposeA="+i+" and transposeB="+s+" must match.");const z=i?[k,v,M]:[k,M,v],W=s?[G,F,S]:[G,S,F],Y=Qi({inputs:{x:l},backend:n,attrs:{shape:z}}),Z=Qi({inputs:{x:e},backend:n,attrs:{shape:W}}),Q=[Y,Z],se=Math.max(k,G),$=i?Y.shape[1]:Y.shape[2],oe=a!=null,ue=p!=null,de=g==="leakyrelu",ye=g!=null?Ph(g,!0):null,_e=oe||ue||de||ye!=null;let we;if((M===1||F===1)&&$>fT&&_e===!1){let Ee=Y,We=Z;i&&(Ee=i2({inputs:{x:Y},backend:n,attrs:{perm:[0,2,1]}}),Q.push(Ee)),s&&(We=i2({inputs:{x:Z},backend:n,attrs:{perm:[0,2,1]}}),Q.push(We));const et=F!==1,ke=F===1;let $e=Ee;et&&($e=Qi({inputs:{x:Ee},backend:n,attrs:{shape:[se,$,1]}}),Q.push($e));const pt=F===1?2:1;let Xe=We;ke&&(Xe=Qi({inputs:{x:We},backend:n,attrs:{shape:[se,1,$]}}),Q.push(Xe));const Tt=hT({inputs:{a:$e,b:Xe},backend:n});we=dT({inputs:{x:Tt},backend:n,attrs:{axis:pt,keepDims:!0}}),Q.push(Tt)}else{const Ee=Do(l.dtype,e.dtype),We=new oT(z,W,[se,M,F],i,s,oe,ye,ue,de),et=[Y,Z];if(a!=null&&et.push(a),ue&&et.push(p),de){const ke=n.makeTensorInfo([],"float32",rh(_,"float32"));et.push(ke),Q.push(ke)}we=n.runWebGLProgram(We,et,Ee)}const Pe=Qi({inputs:{x:we},backend:n,attrs:{shape:H}});Q.push(we);for(const Ee of Q)n.disposeIntermediateTensorInfo(Ee);return Pe}function I4(l){const{inputs:e,backend:i,attrs:s}=l,{a:n,b:a}=e,{transposeA:p,transposeB:_}=s;return r2({a:n,b:a,transposeA:p,transposeB:_,backend:i})}const S4={kernelName:xf,backendName:"webgl",kernelFunc:I4},M4="return float(a != b);",P4=ga({opSnippet:M4,cpuKernelImpl:gU,dtype:"bool"});function bm(l){const{inputs:e,backend:i}=l,{input:s}=e,n=i.texData.get(s.dataId);return Xa({inputs:{x:n.complexTensorInfos.real},backend:i})}const O4="return float(int(x));";function w4(l,e){const i=new y0(l.shape,O4),s=e.runWebGLProgram(i,[l],"int32");return{dataId:s.dataId,shape:s.shape,dtype:s.dtype}}function vm(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{dtype:a}=s;if(a==="complex64"){if(n.dtype==="complex64")return Xa({inputs:{x:n},backend:i});const p=Lo(n.shape),_=vm({inputs:{x:n},backend:i,attrs:{dtype:"float32"}}),g=Mh({inputs:{real:_,imag:p},backend:i});return p.dispose(),i.disposeIntermediateTensorInfo(_),g}if(n.dtype==="complex64"){const p=bm({inputs:{input:n},backend:i}),_=vm({inputs:{x:p},backend:i,attrs:{dtype:a}});return i.disposeIntermediateTensorInfo(p),_}if(!Zi(n.dtype,a)){const p=Xa({inputs:{x:n},backend:i});return{dataId:p.dataId,shape:p.shape,dtype:a}}if(i.shouldExecuteOnCPU([n])){const p=i.texData.get(n.dataId).values,[_,g,y]=aU(p,n.shape,n.dtype,a);return i.makeTensorInfo(_,g,y)}if(a==="int32")return w4(n,i);if(a==="bool"){const p=i.makeTensorInfo([],"bool",ut("bool",1)),_=P4({inputs:{a:n,b:p},backend:i});return i.disposeIntermediateTensorInfo(p),_}throw new Error("Error in Cast: failed to cast "+n.dtype+" to "+a)}const D4={kernelName:Ku,backendName:"webgl",kernelFunc:vm};class F4{constructor(e){this.variableNames=["A"],this.customUniforms=[{name:"minVal",type:"float"},{name:"maxVal",type:"float"}],this.outputShape=e,this.userCode=`

      void main() {
        float value = getAAtOutCoords();
        if (isnan(value)) {
          setOutput(value);
          return;
        }

        setOutput(clamp(value, minVal, maxVal));
      }
    `}}class L4{constructor(e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.customUniforms=[{name:"minVal",type:"float"},{name:"maxVal",type:"float"}],this.outputShape=e,this.userCode=`
      void main() {
        vec4 value = getAAtOutCoords();

        if (any(isnan(value))) {
          setOutput(value);
          return;
        }

        setOutput(clamp(value, vec4(minVal), vec4(maxVal)));
      }
    `}}function N4(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{clipValueMin:a,clipValueMax:p}=s;let _;Ue().getBool("WEBGL_PACK_CLIP")?_=new L4(n.shape):_=new F4(n.shape);const g=[[a],[p]];return i.runWebGLProgram(_,[n],n.dtype,g)}const B4={kernelName:ju,backendName:"webgl",kernelFunc:N4};class k4{constructor(e){this.outputShape=[],this.outputShape=Bo(e,1),this.variableNames=e.map((p,_)=>"T"+_);const i=new Array(e.length-1);i[0]=e[0][1];for(let p=1;p<i.length;p++)i[p]=i[p-1]+e[p][1];const s=["if (yC < "+i[0]+") setOutput(getT0(yR, yC));"];for(let p=1;p<i.length;p++){const _=i[p-1];s.push("else if (yC < "+i[p]+") setOutput(getT"+p+"(yR, yC-"+_+"));")}const n=i.length,a=i[i.length-1];s.push("else setOutput(getT"+n+"(yR, yC-"+a+"));"),this.userCode=`
      void main() {
        ivec2 coords = getOutputCoords();
        int yR = coords.x;
        int yC = coords.y;

        `+s.join(`
        `)+`
      }
    `}}class U4{constructor(e,i){this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[],this.outputShape=Bo(e,i);const s=this.outputShape,n=s.length,a=En(n),p=lx("coords",n),_=["x","y","z","w","u","v"].slice(0,n);this.variableNames=e.map((L,N)=>"T"+N);const g=new Array(e.length-1);g[0]=e[0][i];for(let L=1;L<g.length;L++)g[L]=g[L-1]+e[L][i];const y=_[i],b=_.slice(-2),v=_.join();let S="if ("+y+" < "+g[0]+`) {
        return getChannel(
            getT0(`+v+"), vec2("+b.join()+`));
        }`;for(let L=1;L<g.length;L++){const N=g[L-1];S+=`
        if (`+y+" < "+g[L]+"  && "+y+" >= "+g[L-1]+`) {
          return getChannel(
            getT`+L+"("+s2(_,y,N)+`),
            vec2(`+s2(b,y,N)+`));
        }`}const M=g.length,F=g[g.length-1];S+=`
        return getChannel(
          getT`+M+"("+s2(_,y,F)+`),
          vec2(`+s2(b,y,F)+"));",this.userCode=`
      float getValue(`+_.map(L=>"int "+L)+`) {
        `+S+`
      }

      void main() {
        `+a+` coords = getOutputCoords();
        vec4 result = vec4(getValue(`+p+`), 0., 0., 0.);

        `+p[n-1]+" = "+p[n-1]+` + 1;
        if (`+p[n-1]+" < "+s[n-1]+`) {
          result.g = getValue(`+p+`);
        }

        `+p[n-2]+" = "+p[n-2]+` + 1;
        if (`+p[n-2]+" < "+s[n-2]+`) {
          result.a = getValue(`+p+`);
        }

        `+p[n-1]+" = "+p[n-1]+` - 1;
        if (`+p[n-2]+" < "+s[n-2]+` &&
            `+p[n-1]+" < "+s[n-1]+`) {
          result.b = getValue(`+p+`);
        }
        setOutput(result);
      }
    `}}function s2(l,e,i){const s=l.indexOf(e);return l.map((n,a)=>a===s?n+" - "+i:n).join()}function pT(l){const{inputs:e,backend:i}=l,{input:s}=e,n=i.texData.get(s.dataId);return Xa({inputs:{x:n.complexTensorInfos.imag},backend:i})}function Oh(l,e,i){const s=l[0].dtype;if(s==="complex64"){const M=l.map(G=>bm({inputs:{input:G},backend:i})),F=l.map(G=>pT({inputs:{input:G},backend:i})),L=Oh(M,e,i),N=Oh(F,e,i),k=Mh({inputs:{real:L,imag:N},backend:i});return M.forEach(G=>i.disposeIntermediateTensorInfo(G)),F.forEach(G=>i.disposeIntermediateTensorInfo(G)),i.disposeIntermediateTensorInfo(L),i.disposeIntermediateTensorInfo(N),k}let n=i.shouldExecuteOnCPU(l);if(s==="string"&&(n=!0),n){const M=l.map(z=>{const W=[-1,Je(z.shape.slice(e))];return Qi({inputs:{x:z},backend:i,attrs:{shape:W}})}),F=M.map(z=>({vals:i.readSync(z.dataId),shape:z.shape})),L=Bo(M.map(z=>z.shape),1),N=M[0].shape[0]===1,k=oU(F,L,s,N),G=Bo(l.map(z=>z.shape),e),H=i.makeTensorInfo(G,s,k);return M.forEach(z=>i.disposeIntermediateTensorInfo(z)),H}const a=l.filter(M=>Je(M.shape)>0),p=Ue().getBool("WEBGL_PACK_ARRAY_OPERATIONS")&&a[0].shape.length>1;if(a.length===1){const M=p?new y0(l[0].shape,cx):new hx(l[0].shape,cx);return i.runWebGLProgram(M,l,s)}const _=Ue().getNumber("WEBGL_MAX_TEXTURES_IN_SHADER");if(a.length>_){const M=[];for(let L=0;L<a.length;L+=_){const N=a.slice(L,L+_);M.push(Oh(N,e,i))}const F=Oh(M,e,i);for(const L of M)i.disposeIntermediateTensorInfo(L);return F}if(p){const M=new U4(a.map(F=>F.shape),e);return i.runWebGLProgram(M,a,s)}const{tensors2D:g,outShape:y}=V4(a,e,i),b=new k4(g.map(M=>M.shape)),v=i.runWebGLProgram(b,g,s);g.forEach(M=>i.disposeIntermediateTensorInfo(M));const S=Qi({inputs:{x:v},attrs:{shape:y},backend:i});return i.disposeIntermediateTensorInfo(v),S}function V4(l,e,i){const s=Bo(l.map(n=>n.shape),e);return{tensors2D:l.map(n=>Qi({inputs:{x:n},attrs:{shape:[-1,Je(n.shape.slice(e))]},backend:i})),outShape:s}}function mT(l){const{inputs:e,backend:i,attrs:s}=l,{axis:n}=s,a=jt(n,e[0].shape)[0],p=e.map(y=>y.shape);Op(p,a);const _=Bo(e.map(y=>y.shape),a);if(Je(_)===0)return i.makeTensorInfo(_,e[0].dtype,[]);const g=e.filter(y=>Je(y.shape)>0);return g.length===1?Xa({inputs:{x:g[0]},backend:i}):Oh(g,a,i)}const G4={kernelName:lf,backendName:"webgl",kernelFunc:mT};class _T{constructor(e,i=!1,s=null,n=!1,a=!1){this.variableNames=["x","W"],this.outputShape=e.outShape;const p=e.padInfo.top,_=e.padInfo.left,g=e.strideHeight,y=e.strideWidth,b=e.dilationHeight,v=e.dilationWidth,S=e.filterHeight,M=e.filterWidth,F=Math.floor(e.inChannels/4)*4,L=e.inChannels%4,N=e.dataFormat==="channelsLast",k=N?1:2,G=N?2:3,H=N?3:1;let z="",W="";s&&(n?z=`float activation(float a) {
          float b = getPreluActivationWeightsAtOutCoords();
          `+s+`
        }`:a?z=`float activation(float a) {
          float b = getLeakyreluAlphaAtOutCoords();
          `+s+`
        }`:z=`
          float activation(float x) {
            `+s+`
          }
        `,W="result = activation(result);");const Y=i?"result += getBiasAtOutCoords();":"";i&&this.variableNames.push("bias"),n&&this.variableNames.push("preluActivationWeights"),a&&this.variableNames.push("leakyreluAlpha"),this.userCode=`
      `+z+`

      const ivec2 strides = ivec2(`+g+", "+y+`);
      const ivec2 pads = ivec2(`+p+", "+_+`);

      void main() {
        ivec4 coords = getOutputCoords();
        int batch = coords[0];
        int d2 = coords[`+H+`];

        ivec2 xRCCorner =
            ivec2(coords[`+k+"], coords["+G+`]) * strides - pads;
        int xRCorner = xRCCorner.x;
        int xCCorner = xRCCorner.y;

        // Convolve x(?, ?, d1) with w(:, :, d1, d2) to get y(yR, yC, d2).
        // ? = to be determined. : = across all values in that axis.
        float dotProd = 0.0;
        for (int wR = 0; wR < `+S+`; wR++) {
          int xR = xRCorner + wR * `+b+`;

          if (xR < 0 || xR >= `+e.inHeight+`) {
            continue;
          }

          for (int wC = 0; wC < `+M+`; wC++) {
            int xC = xCCorner + wC * `+v+`;

            if (xC < 0 || xC >= `+e.inWidth+`) {
              continue;
            }

            for (int d1 = 0; d1 < `+F+`; d1 += 4) {
              vec4 wValues = vec4(
                getW(wR, wC, d1, d2),
                getW(wR, wC, d1 + 1, d2),
                getW(wR, wC, d1 + 2, d2),
                getW(wR, wC, d1 + 3, d2)
              );

              if (`+N+`) {
                vec4 xValues = vec4(
                  getX(batch, xR, xC, d1),
                  getX(batch, xR, xC, d1 + 1),
                  getX(batch, xR, xC, d1 + 2),
                  getX(batch, xR, xC, d1 + 3)
                );
                dotProd += dot(xValues, wValues);
              } else {
                vec4 xValues = vec4(
                  getX(batch, d1, xR, xC),
                  getX(batch, d1 + 1, xR, xC),
                  getX(batch, d1 + 2, xR, xC),
                  getX(batch, d1 + 3, xR, xC)
                );
                dotProd += dot(xValues, wValues);
              }
            }

            if (`+(L===1)+`) {

              if (`+N+`) {
                dotProd +=
                    getX(batch, xR, xC, `+F+`) *
                    getW(wR, wC, `+F+`, d2);
              } else {
                dotProd +=
                    getX(batch, `+F+`, xR, xC) *
                    getW(wR, wC, `+F+`, d2);
              }

            } else if (`+(L===2)+`) {
              vec2 wValues = vec2(
                getW(wR, wC, `+F+`, d2),
                getW(wR, wC, `+F+` + 1, d2)
              );

              if (`+N+`) {
                vec2 xValues = vec2(
                  getX(batch, xR, xC, `+F+`),
                  getX(batch, xR, xC, `+F+` + 1)
                );
                dotProd += dot(xValues, wValues);
              } else {
                vec2 xValues = vec2(
                  getX(batch, `+F+`, xR, xC),
                  getX(batch, `+F+` + 1, xR, xC)
                );
                dotProd += dot(xValues, wValues);
              }

            } else if (`+(L===3)+`) {
              vec3 wValues = vec3(
                getW(wR, wC, `+F+`, d2),
                getW(wR, wC, `+F+` + 1, d2),
                getW(wR, wC, `+F+` + 2, d2)
              );

              if (`+N+`) {
                vec3 xValues = vec3(
                  getX(batch, xR, xC, `+F+`),
                  getX(batch, xR, xC, `+F+` + 1),
                  getX(batch, xR, xC, `+F+` + 2)
                );
                dotProd += dot(xValues, wValues);
              } else {
                vec3 xValues = vec3(
                  getX(batch, `+F+`, xR, xC),
                  getX(batch, `+F+` + 1, xR, xC),
                  getX(batch, `+F+` + 2, xR, xC)
                );
                dotProd += dot(xValues, wValues);
              }

            }
          }
        }

        float result = dotProd;
        `+Y+`
        `+W+`
        setOutput(result);
      }
    `}}class gT{constructor(e,i=!1,s=null,n=!1,a=!1){this.variableNames=["x","W"],this.packedInputs=!0,this.packedOutput=!0,this.customUniforms=[{name:"pads",type:"ivec2"},{name:"strides",type:"ivec2"},{name:"dilations",type:"ivec2"},{name:"inDims",type:"ivec2"}],this.outputShape=e.outShape,this.enableShapeUniforms=An(this.outputShape.length);const p=e.padInfo.left,_=e.strideWidth,g=e.dilationWidth,y=e.filterHeight,b=e.filterWidth,v=b;let S=`
       int xR; int xC; int xCOffset;
       vec4 wTexel; vec4 previous; vec4 final;`;for(let N=0;N<b;N++)S+=`
           vec4 xTexelC`+N*2+`;
           int xTexelC`+N*2+`Ready;
           vec4 xTexelC`+(N*2+1)+`;
           int xTexelC`+(N*2+1)+`Ready;
           vec4 xC`+N+";";S+=`
     for (int r = 0; r < `+y+`; r++) {
      for (int d1 = 0; d1 < `+e.inChannels+`; d1 += 2) {
       `;for(let N=0;N<b;N++)S+=`
           xTexelC`+N*2+` = vec4(0.0);
           xTexelC`+N*2+`Ready = 0;
           xTexelC`+(N*2+1)+` = vec4(0.0);
           xTexelC`+(N*2+1)+`Ready = 0;
           xC`+N+" = vec4(0.0);";S+=`
         xR = xRCorner + r * dilations[0];
         if (xR >=0 && xR < inDims[0]) {
       `;for(let N=0;N<(v+1)/2;N++){const k=N*2;if(S+=`
           xC = xCCorner + `+k*g+`;
           `,_===1){if(k<b&&(p%2===1?(S+=`
                 xCOffset = xC + 1;
                 if (xCOffset >= 0 && xCOffset < inDims[1] && xTexelC`+k+`Ready == 0) {
                   xTexelC`+k+` = getX(batch, xR, xCOffset, d1);

                   // Need to manually clear unused channels in case
                   // we're reading from recycled texture.
                   if (xCOffset + 1 >= inDims[1]) {
                     xTexelC`+k+`.zw = vec2(0.0);
                   }
                   xTexelC`+k+`Ready = 1;
                 }
               `,g===1&&k>0?S+=`
                 xC`+k+" = vec4(xTexelC"+(k-2)+".zw, xTexelC"+k+`.xy);
                 `:S+=`
                   xCOffset = xC + 1 - 2;

                   if (xCOffset >= 0 && xCOffset < inDims[1]) {
                     previous = getX(batch, xR, xCOffset, d1);

                     // Need to manually clear unused channels in case
                     // we're reading from recycled texture.
                     if (xCOffset + 1 >= inDims[1]) {
                       previous.zw = vec2(0.0);
                     }

                     xC`+k+" = vec4(previous.zw, xTexelC"+k+`.xy);
                   } else {
                     xC`+k+" = vec4(0.0, 0.0, xTexelC"+k+`.xy);
                   }
                   `):S+=`
                 if (xC >= 0 && xC < inDims[1] && xTexelC`+k+`Ready == 0) {
                   xTexelC`+k+` = getX(batch, xR, xC, d1);
                   if (xC + 1 >= inDims[1]) {
                     xTexelC`+k+`.zw = vec2(0.0);
                   }
                   xTexelC`+k+`Ready = 1;
                 }

                 xC`+k+" = xTexelC"+k+`;
                 `,k+1<b)){const G=p%2===0?ui(g):g;g%2===0&&p%2===1||g%2!==0&&p%2!==1?(S+=`
                   xCOffset = xC + imod(pads[1], 2) + `+G+`;

                   if (xCOffset >= 0 && xCOffset < inDims[1] && xTexelC`+(k+1)+`Ready == 0) {
                     xTexelC`+(k+1)+` = getX(batch, xR, xCOffset, d1);

                     // Need to manually clear unused channels in case
                     // we're reading from recycled texture.
                     if (xCOffset + 1 >= inDims[1]) {
                       xTexelC`+(k+1)+`.zw = vec2(0.0);
                     }
                     xTexelC`+(k+1)+`Ready = 1;
                   }
                   `,g>1?S+=`
                     xCOffset -= 2;
                     if (xCOffset >= 0 && xCOffset < inDims[1]) {
                      previous = getX(batch, xR, xCOffset, d1);
                      xC`+(k+1)+" = vec4(previous.zw, xTexelC"+(k+1)+`.xy);
                     } else {
                      xC`+(k+1)+" = vec4(0.0, 0.0, xTexelC"+(k+1)+`.xy);
                     }
                     `:S+=`
                     xC`+(k+1)+" = vec4(xTexelC"+k+".zw, xTexelC"+(k+1)+`.xy);
                     `):G===1?S+=`
                     xC`+(k+1)+" = xTexelC"+k+`;
                     `:S+=`
                     xCOffset = xC + `+G+`;

                     if (xCOffset >= 0 && xCOffset < inDims[1] && xTexelC`+(k+1)+`Ready == 0) {
                       xTexelC`+(k+1)+` = getX(batch, xR, xCOffset, d1);
                       if (xCOffset + 1 >= inDims[1]) {
                         xTexelC`+(k+1)+`.zw = vec2(0.0);
                       }
                       xTexelC`+(k+1)+`Ready = 1;
                     }

                     xC`+(k+1)+" = xTexelC"+(k+1)+`;
                     `}}else k<b&&(p%2===1?(S+=`
                 xCOffset = xC + 1 - strides[1];
                 if(xCOffset >= 0 && xCOffset < inDims[1] && xTexelC`+k+`Ready == 0) {
                   xTexelC`+k+` = getX(batch, xR, xCOffset, d1);
                   // Need to manually clear unused channels in case
                   // we're reading from recycled texture.
                   if (xCOffset + 1 >= inDims[1]) {
                     xTexelC`+k+`.zw = vec2(0.0);
                   }
                   xTexelC`+k+`Ready = 1;
                 }

                 if(xC + 1 >= 0 && xC + 1 < inDims[1] && xTexelC`+(k+1)+`Ready == 0) {
                   xTexelC`+(k+1)+` = getX(batch, xR, xC + 1, d1);
                   // Need to manually clear unused channels in case
                   // we're reading from recycled texture.
                   if (xC + 2 >= inDims[1]) {
                     xTexelC`+(k+1)+`.zw = vec2(0.0);
                   }
                   xTexelC`+(k+1)+`Ready = 1;
                 }

                 xC`+k+" = vec4(xTexelC"+k+".zw, xTexelC"+(k+1)+`.zw);
               `,k+1<b&&(S+=`
                   final = vec4(0.0);
                   xCOffset = xC + 1 + strides[1];
                   if(xCOffset >= 0 && xCOffset < inDims[1]) {
                     final = getX(batch, xR, xCOffset, d1);
                   }
                   xC`+(k+1)+" = vec4(xTexelC"+(k+1)+`.xy, final.xy);
                 `)):(S+=`
                 if(xC >= 0 && xC < inDims[1] && xTexelC`+k+`Ready == 0) {
                   xTexelC`+k+` = getX(batch, xR, xC, d1);
                   if (xC + 1 >= inDims[1]) {
                     xTexelC`+k+`.zw = vec2(0.0);
                   }
                   xTexelC`+k+`Ready = 1;
                 }

                 xCOffset = xC + strides[1];
                 if(xCOffset >= 0 && xCOffset < inDims[1] && xTexelC`+(k+1)+`Ready == 0) {
                   xTexelC`+(k+1)+` = getX(batch, xR, xCOffset, d1);
                   if (xCOffset + 1 >= inDims[1]) {
                     xTexelC`+(k+1)+`.zw = vec2(0.);
                   }
                   xTexelC`+(k+1)+`Ready = 1;
                 }

                 xC`+k+` = vec4(
                   xTexelC`+k+".xy, xTexelC"+(k+1)+`.xy);
               `,k+1<b&&(S+=`
                   xC`+(k+1)+" = vec4(xTexelC"+k+".zw, xTexelC"+(k+1)+`.zw);
                 `)));k<b&&(S+=`
             wTexel = getW(r, `+k+`, d1, d2);
             dotProd += xC`+k+`.xxzz * vec4(wTexel.xy, wTexel.xy);
             if(d1 + 1 < `+e.inChannels+`) {
               dotProd += xC`+k+`.yyww * vec4(wTexel.zw, wTexel.zw);
             }
           `,k+1<b&&(S+=`
               wTexel = getW(r, `+(k+1)+`, d1, d2);
               dotProd += xC`+(k+1)+`.xxzz * vec4(wTexel.xy, wTexel.xy);
               if(d1 + 1 < `+e.inChannels+`) {
                 dotProd += xC`+(k+1)+`.yyww * vec4(wTexel.zw, wTexel.zw);
               }
             `))}S+=`
     }
   `,S+=`
     }
   `,S+=`
     }
   `;let M="",F="";s&&(n?M=`vec4 activation(vec4 a) {
           vec4 b = getPreluActivationWeightsAtOutCoords();
           `+s+`
         }`:a?M=`vec4 activation(vec4 a) {
           vec4 b = getLeakyreluAlphaAtOutCoords();
           `+s+`
         }`:M=`vec4 activation(vec4 x) {
           `+s+`
         }`,F="result = activation(result);");const L=i?"result += getBiasAtOutCoords();":"";i&&this.variableNames.push("bias"),n&&this.variableNames.push("preluActivationWeights"),a&&this.variableNames.push("leakyreluAlpha"),this.userCode=`
       `+M+`

       void main() {
         ivec4 coords = getOutputCoords();
         int batch = coords.x;
         ivec2 xRCCorner = coords.yz * strides - pads;
         int d2 = coords.w;
         int xRCorner = xRCCorner.x;
         int xCCorner = xRCCorner.y;

         //intialize dotProd with a small epsilon seems to reduce GPU accuracy loss.
         vec4 dotProd = vec4(0.000000000000001);

         `+S+`

         vec4 result = dotProd - vec4(0.000000000000001);
         `+L+`
         `+F+`
         setOutput(result);
       }
     `}}class W4{constructor(e,i){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.customUniforms=[{name:"inputShape",type:"ivec4"},{name:"pad",type:"ivec2"},{name:"stride",type:"ivec2"},{name:"dilation",type:"ivec2"},{name:"inChannels",type:"int"},{name:"itemsPerBlockRow",type:"int"},{name:"outWidth",type:"int"}],this.outputShape=e,this.enableShapeUniforms=An(this.outputShape.length);const{dataFormat:s}=i,n=Tn(),a=s==="channelsLast",p=a?1:2,_=a?2:3,g=this.enableShapeUniforms?"if(blockIndex < outShape[2] && pos < outShape[1]) {":"if(blockIndex < "+e[2]+" && pos < "+e[1]+") {";let y="";for(let b=0;b<=1;b++)for(let v=0;v<=1;v++)y+=`
          blockIndex = rc.z + `+v+`;
          pos = rc.y + `+b+`;

          `+g+`
            offsetY = int(blockIndex / outWidth) * stride[0] - pad[0];
            d0 = offsetY + dilation[0] * (pos / itemsPerBlockRow);

            if(d0 < inputShape[`+p+`] && d0 >= 0) {
              // Use custom imod instead mod. On Intel GPU, mod may generate
              // unexpected value.
              // https://github.com/tensorflow/tfjs/issues/5447
              offsetX = imod(blockIndex, outWidth) * stride[1] - pad[1];
              d1 = offsetX + dilation[1] * (imod(pos, itemsPerBlockRow) /
                  inChannels);

              if(d1 < inputShape[`+_+`] && d1 >= 0) {

                ch = imod(pos, inChannels);

                if (`+a+`) {
                  innerDims = vec2(d1, ch);
                  result[`+(b*2+v)+`] = getChannel(
                    getA(rc.x, d0, int(innerDims.x),
                    int(innerDims.y)), innerDims);
                } else {
                  innerDims = vec2(d0, d1);
                  result[`+(b*2+v)+`] = getChannel(
                    getA(rc.x, ch, int(innerDims.x),
                    int(innerDims.y)), innerDims);
                }
              }
            }
          }
        `;this.userCode=`
      void main() {
        ivec3 rc = getOutputCoords();

        vec4 result = vec4(0);

        int blockIndex, pos, offsetY, d0, offsetX, d1, ch;
        vec2 innerDims;

        `+y+`

        `+n.output+` = result;
      }
    `}}function n2(l,e){const i=l.length;return i>=3?e?[...l.slice(0,-3),l[i-3]*l[i-2],l[i-1]]:[...l.slice(0,-3),l[i-3],l[i-2]*l[i-1]]:!e&&i===1&&l[0]>1?[l[0],1]:null}function yT({x:l,filter:e,convInfo:i,backend:s,bias:n=null,preluActivationWeights:a=null,leakyreluAlpha:p=0,activation:_=null}){const g=l.shape,y=s.texData.get(l.dataId),b=i.inChannels,v=g[0]*g[1]*g[2],S=i.outChannels,M=i.dataFormat==="channelsLast",F=!1,L=!1;let N;const k=[];if(a!=null){const G=n2(a.shape,M);G!=null&&(a=Qi({inputs:{x:a},backend:s,attrs:{shape:G}}),k.push(a))}if(n!=null){const G=n2(n.shape,M);G!=null&&(n=Qi({inputs:{x:n},backend:s,attrs:{shape:G}}),k.push(n))}if(!((v===1||S===1)&&b>fT)&&y.isPacked&&M&&y.texture!=null&&g[2]%2!==0&&qt(y.shape.slice(-3),g.slice(-3))){const G=g[0]*g[1]*(g[2]+1),H={dataId:l.dataId,shape:[1,G,i.inChannels],dtype:l.dtype},z=y.shape;y.shape=y.shape.slice(),y.shape[y.shape.length-2]++,Te(jd(y.shape,H.shape),()=>"packed reshape "+y.shape+" to "+H.shape+" isn't free");const W=Qi({inputs:{x:e},backend:s,attrs:{shape:[1,i.inChannels,i.outChannels]}});k.push(W);const Y=r2({a:H,b:W,backend:s,transposeA:F,transposeB:L,bias:n,activation:_,preluActivationWeights:a,leakyreluAlpha:p}),Z=s.texData.get(Y.dataId);Te(Z.isPacked,()=>"batchMatMul result is expected to be packed"),y.shape=z,Z.shape=i.outShape,N=Xa({inputs:{x:Y},backend:s}),N.shape=i.outShape,k.push(Y)}else{const G=i.outHeight*i.outWidth,H=Qi({inputs:{x:l},backend:s,attrs:{shape:M?[i.batchSize,G,i.inChannels]:[i.batchSize,i.inChannels,G]}}),z=Qi({inputs:{x:e},backend:s,attrs:{shape:[1,i.inChannels,i.outChannels]}}),W=r2({a:M?H:z,b:M?z:H,transposeA:!M,transposeB:L,backend:s,bias:n,activation:_,preluActivationWeights:a,leakyreluAlpha:p});N=Qi({inputs:{x:W},backend:s,attrs:{shape:i.outShape}}),k.push(H),k.push(z),k.push(W)}for(const G of k)s.disposeIntermediateTensorInfo(G);return N}function bT({x:l,filter:e,convInfo:i,backend:s,bias:n=null,preluActivationWeights:a=null,leakyreluAlpha:p=0,activation:_=null}){const{filterWidth:g,filterHeight:y,inChannels:b,outWidth:v,outHeight:S,dataFormat:M}=i,F=M==="channelsLast",L=g*y*b,N=S*v,k=[i.batchSize,L,N],G=!0,H=!1,z=[];if(a!=null){const Ee=n2(a.shape,F);Ee!=null&&(a=Qi({inputs:{x:a},backend:s,attrs:{shape:Ee}}),z.push(a))}if(n!=null){const Ee=n2(n.shape,F);Ee!=null&&(n=Qi({inputs:{x:n},backend:s,attrs:{shape:Ee}}),z.push(n))}const W=Qi({inputs:{x:e},backend:s,attrs:{shape:[1,L,Je(e.shape)/L]}});z.push(W);const Y=new W4(k,i),Z=[l.shape,[i.padInfo.top,i.padInfo.left],[i.strideHeight,i.strideWidth],[i.dilationHeight,i.dilationWidth],[i.inChannels],[i.filterWidth*i.inChannels],[i.outWidth]],Q=s.runWebGLProgram(Y,[l],"float32",Z),se=Qi({inputs:{x:Q},backend:s,attrs:{shape:k}});z.push(Q),z.push(se);const $=n!=null,oe=a!=null,ue=_==="leakyrelu",de=_?Ph(_,!0):null,ye=new oT(F?se.shape:W.shape,F?W.shape:se.shape,F?[i.batchSize,N,i.outChannels]:[i.batchSize,i.outChannels,N],G,H,$,de,oe,ue),_e=F?[se,W]:[W,se];if(n&&_e.push(n),oe&&_e.push(a),ue){const Ee=s.makeTensorInfo([],"float32",rh(p,"float32"));_e.push(Ee),z.push(Ee)}const we=s.runWebGLProgram(ye,_e,"float32"),Pe=Qi({inputs:{x:we},backend:s,attrs:{shape:i.outShape}});z.push(we);for(const Ee of z)s.disposeIntermediateTensorInfo(Ee);return Pe}function z4(l){const{inputs:e,backend:i,attrs:s}=l,{x:n,filter:a}=e,{strides:p,pad:_,dataFormat:g,dilations:y,dimRoundingMode:b}=s,v=dh(g),S=mo(n.shape,a.shape,p,y,_,b,!1,v);let M;if(S.filterHeight===1&&S.filterWidth===1&&S.dilationHeight===1&&S.dilationWidth===1&&S.strideHeight===1&&S.strideWidth===1&&(S.padInfo.type==="SAME"||S.padInfo.type==="VALID"))M=yT({x:n,filter:a,convInfo:S,backend:i});else if(S.strideWidth<=2&&v==="channelsLast"&&Ue().getBool("WEBGL_EXP_CONV")){const L=new gT(S),N=[[S.padInfo.top,S.padInfo.left],[S.strideHeight,S.strideWidth],[S.dilationHeight,S.dilationWidth],[S.inHeight,S.inWidth]];M=i.runWebGLProgram(L,[n,a],"float32",N)}else if(Ue().getBool("WEBGL_CONV_IM2COL"))M=bT({x:n,filter:a,convInfo:S,backend:i});else{const L=new _T(S);M=i.runWebGLProgram(L,[n,a],"float32")}const F=Qi({inputs:{x:M},backend:i,attrs:{shape:S.outShape}});return i.disposeIntermediateTensorInfo(M),F}const H4={kernelName:cf,backendName:"webgl",kernelFunc:z4},X4=ym+`
  return cos(x);
`,Y4=`
  vec4 result = cos(x);
  bvec4 isNaN = isnan(x);
  `+lc+`
  return result;
`,K4=ux({opSnippet:X4,packedOpSnippet:Y4}),j4={kernelName:qu,backendName:"webgl",kernelFunc:K4};class q4{constructor(e,i,s,n,a){this.variableNames=["Image","Boxes","BoxInd"],this.outputShape=[];const[p,_,g,y]=e,[b]=i,[v,S]=s;this.outputShape=[b,v,S,y];const M=n==="bilinear"?1:0,[F,L]=[_-1+".0",g-1+".0"],[N,k,G]=v>1?[""+(_-1)/(v-1),"(y2-y1) * height_ratio","y1*"+F+" + float(y)*(height_scale)"]:["0.0","0.0","0.5 * (y1+y2) * "+F],[H,z,W]=S>1?[""+(g-1)/(S-1),"(x2-x1) * width_ratio","x1*"+L+" + float(x)*(width_scale)"]:["0.0","0.0","0.5 * (x1+x2) * "+L];this.userCode=`
      const float height_ratio = float(`+N+`);
      const float width_ratio = float(`+H+`);
      void main() {
        ivec4 coords = getOutputCoords();
        int b = coords[0];
        int y = coords[1];
        int x = coords[2];
        int d = coords[3];

        // get box vals
        float y1 = getBoxes(b,0);
        float x1 = getBoxes(b,1);
        float y2 = getBoxes(b,2);
        float x2 = getBoxes(b,3);

        // get image in batch index
        int bInd = round(getBoxInd(b));
        if(bInd < 0 || bInd >= `+p+`) {
          return;
        }

        float height_scale = `+k+`;
        float width_scale = `+z+`;

        float in_y = `+G+`;
        if( in_y < 0.0 || in_y > `+F+` ) {
          setOutput(float(`+a+`));
          return;
        }
        float in_x = `+W+`;
        if( in_x < 0.0 || in_x > `+L+` ) {
          setOutput(float(`+a+`));
          return;
        }

        vec2 sourceFracIndexCR = vec2(in_x,in_y);
        if(`+M+` == 1) {
          // Compute the four integer indices.
          ivec2 sourceFloorCR = ivec2(sourceFracIndexCR);
          ivec2 sourceCeilCR = ivec2(ceil(sourceFracIndexCR));

          float topLeft = getImage(b, sourceFloorCR.y, sourceFloorCR.x, d);
          float bottomLeft = getImage(b, sourceCeilCR.y, sourceFloorCR.x, d);
          float topRight = getImage(b, sourceFloorCR.y, sourceCeilCR.x, d);
          float bottomRight = getImage(b, sourceCeilCR.y, sourceCeilCR.x, d);

          vec2 fracCR = sourceFracIndexCR - vec2(sourceFloorCR);

          float top = topLeft + (topRight - topLeft) * fracCR.x;
          float bottom = bottomLeft + (bottomRight - bottomLeft) * fracCR.x;
          float newValue = top + (bottom - top) * fracCR.y;
          setOutput(newValue);
        } else {
          // Compute the coordinators of nearest neighbor point.
          ivec2 sourceNearestCR = ivec2(floor(
            sourceFracIndexCR + vec2(0.5,0.5)));
          float newValue = getImage(b, sourceNearestCR.y, sourceNearestCR.x, d);
          setOutput(newValue);
        }
      }
    `}}const Z4=l=>{const{inputs:e,backend:i,attrs:s}=l,{image:n,boxes:a,boxInd:p}=e,{cropSize:_,method:g,extrapolationValue:y}=s,b=new q4(n.shape,a.shape,_,g,y);return i.runWebGLProgram(b,[n,a,p],"float32")},Q4={kernelName:hf,backendName:"webgl",kernelFunc:Z4};class $4{constructor(e,i,s){this.variableNames=["x"],this.outputShape=[],this.outputShape=e,this.blockSize=i,this.dataFormat=s,this.userCode=`
    void main() {
      ivec4 coords = getOutputCoords();
      int b = coords[0];
      int h = `+this.getHeightCoordString()+`;
      int w = `+this.getWidthCoordString()+`;
      int d = `+this.getDepthCoordString()+`;

      int in_h = h / `+i+`;
      int offset_h = imod(h, `+i+`);
      int in_w = w / `+i+`;
      int offset_w = imod(w, `+i+`);
      int offset_d = (offset_h * `+i+` + offset_w) *
        `+this.getOutputDepthSize()+`;
      int in_d = d + offset_d;

      float result = `+this.getInputSamplingString()+`;
      setOutput(result);
    }
  `}getHeightCoordString(){return this.dataFormat==="NHWC"?"coords[1]":"coords[2]"}getWidthCoordString(){return this.dataFormat==="NHWC"?"coords[2]":"coords[3]"}getDepthCoordString(){return this.dataFormat==="NHWC"?"coords[3]":"coords[1]"}getOutputDepthSize(){return this.dataFormat==="NHWC"?this.outputShape[3]:this.outputShape[1]}getInputSamplingString(){return this.dataFormat==="NHWC"?"getX(b, in_h, in_w, in_d)":"getX(b, in_d, in_h, in_w)"}}function J4(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{blockSize:a,dataFormat:p}=s,_=n.shape[0],g=p==="NHWC"?n.shape[1]:n.shape[2],y=p==="NHWC"?n.shape[2]:n.shape[3],b=p==="NHWC"?n.shape[3]:n.shape[1],v=g*a,S=y*a,M=b/(a*a),F=p==="NHWC"?[_,v,S,M]:[_,M,v,S],L=new $4(F,a,p);return i.runWebGLProgram(L,[n],n.dtype)}const eV={kernelName:uf,backendName:"webgl",kernelFunc:J4};class vT{constructor(e,i=!1,s=null,n=!1,a=!1){this.variableNames=["x","W"],this.customUniforms=[{name:"pads",type:"ivec2"},{name:"strides",type:"ivec2"},{name:"dilations",type:"ivec2"},{name:"inDims",type:"ivec2"}],this.outputShape=e.outShape,this.enableShapeUniforms=An(this.outputShape.length);const p=e.filterHeight,_=e.filterWidth,g=e.outChannels/e.inChannels;let y="",b="";s&&(n?y=`float activation(float a) {
          float b = getPreluActivationWeightsAtOutCoords();
          `+s+`
        }`:a?y=`float activation(float a) {
          float b = getLeakyreluAlphaAtOutCoords();
          `+s+`
        }`:y=`
          float activation(float x) {
            `+s+`
          }
        `,b="result = activation(result);");const v=i?"result += getBiasAtOutCoords();":"";i&&this.variableNames.push("bias"),n&&this.variableNames.push("preluActivationWeights"),a&&this.variableNames.push("leakyreluAlpha"),this.userCode=`
      `+y+`

      void main() {
        ivec4 coords = getOutputCoords();
        int batch = coords.x;
        ivec2 xRCCorner = coords.yz * strides - pads;
        int d2 = coords.w;
        int d1 = d2 / `+g+`;
        int q = d2 - d1 * `+g+`;

        int xRCorner = xRCCorner.x;
        int xCCorner = xRCCorner.y;

        // Convolve x(?, ?, d1) with w(:, :, d1, q) to get y(yR, yC, d2).
        // ? = to be determined. : = across all values in that axis.
        float dotProd = 0.0;
        // TO DO(dsmilkov): Flatten the two for loops and vec4 the operations.
        for (int wR = 0; wR < `+p+`; wR++) {
          int xR = xRCorner + wR * dilations[0];

          if (xR < 0 || xR >= inDims[0]) {
            continue;
          }

          for (int wC = 0; wC < `+_+`; wC++) {
            int xC = xCCorner + wC * dilations[1];

            if (xC < 0 || xC >= inDims[1]) {
              continue;
            }

            float xVal = getX(batch, xR, xC, d1);
            float wVal = getW(wR, wC, d1, q);
            dotProd += xVal * wVal;
          }
        }

        float result = dotProd;
        `+v+`
        `+b+`
        setOutput(result);
      }
    `}}class TT{constructor(e,i=!1,s=null,n=!1,a=!1){this.variableNames=["x","W"],this.packedInputs=!0,this.packedOutput=!0,this.customUniforms=[{name:"pads",type:"ivec2"},{name:"strides",type:"ivec2"},{name:"dilations",type:"ivec2"},{name:"inDims",type:"ivec2"}],this.outputShape=e.outShape,this.enableShapeUniforms=An(this.outputShape.length);const p=e.outChannels/e.inChannels,_=e.padInfo.left,g=e.strideWidth,y=e.dilationWidth,b=e.filterHeight,v=e.filterWidth,S=v;let M=`
      int xR; int xC; int xCOffset;
      vec4 wTexel; vec4 previous; vec4 final;`;for(let k=0;k<v;k++)M+=`
          vec4 xTexelC`+k*2+`;
          int xTexelC`+k*2+`Ready;
          vec4 xTexelC`+(k*2+1)+`;
          int xTexelC`+(k*2+1)+`Ready;
          vec4 xC`+k+";";M+=`
    for (int r = 0; r < `+b+`; r++) {
      `;for(let k=0;k<v;k++)M+=`
          xTexelC`+k*2+` = vec4(0.0);
          xTexelC`+k*2+`Ready = 0;
          xTexelC`+(k*2+1)+` = vec4(0.0);
          xTexelC`+(k*2+1)+`Ready = 0;
          xC`+k+" = vec4(0.0);";M+=`
        xR = xRCorner + r * dilations[0];
        if (xR >=0 && xR < inDims[0]) {
      `;for(let k=0;k<(S+1)/2;k++){const G=k*2;if(M+=`
          xC = xCCorner + `+G*y+`;
          `,g===1){if(G<v&&(_%2===1?(M+=`
                xCOffset = xC + 1;
                if (xCOffset >= 0 && xCOffset < inDims[1] && xTexelC`+G+`Ready == 0) {
                  xTexelC`+G+` = getX(batch, xR, xCOffset, d1);

                  // Need to manually clear unused channels in case
                  // we're reading from recycled texture.
                  if (xCOffset + 1 >= inDims[1]) {
                    xTexelC`+G+`.zw = vec2(0.0);
                  }
                  xTexelC`+G+`Ready = 1;
                }
              `,y===1&&G>0?M+=`
                xC`+G+" = vec4(xTexelC"+(G-2)+".zw, xTexelC"+G+`.xy);
                `:M+=`
                  xCOffset = xC + 1 - 2;

                  if (xCOffset >= 0 && xCOffset < inDims[1]) {
                    previous = getX(batch, xR, xCOffset, d1);

                    // Need to manually clear unused channels in case
                    // we're reading from recycled texture.
                    if (xCOffset + 1 >= inDims[1]) {
                      previous.zw = vec2(0.0);
                    }

                    xC`+G+" = vec4(previous.zw, xTexelC"+G+`.xy);
                  } else {
                    xC`+G+" = vec4(0.0, 0.0, xTexelC"+G+`.xy);
                  }
                  `):M+=`
                if (xC >= 0 && xC < inDims[1] && xTexelC`+G+`Ready == 0) {
                  xTexelC`+G+` = getX(batch, xR, xC, d1);
                  if (xC + 1 >= inDims[1]) {
                    xTexelC`+G+`.zw = vec2(0.0);
                  }
                  xTexelC`+G+`Ready = 1;
                }

                xC`+G+" = xTexelC"+G+`;
                `,G+1<v)){const H=_%2===0?ui(y):y;y%2===0&&_%2===1||y%2!==0&&_%2!==1?(M+=`
                  xCOffset = xC + imod(pads[1], 2) + `+H+`;

                  if (xCOffset >= 0 && xCOffset < inDims[1] && xTexelC`+(G+1)+`Ready == 0) {
                    xTexelC`+(G+1)+` = getX(batch, xR, xCOffset, d1);

                    // Need to manually clear unused channels in case
                    // we're reading from recycled texture.
                    if (xCOffset + 1 >= inDims[1]) {
                      xTexelC`+(G+1)+`.zw = vec2(0.0);
                    }
                    xTexelC`+(G+1)+`Ready = 1;
                  }
                  `,y>1?M+=`
                    xCOffset -= 2;
                    if (xCOffset >= 0 && xCOffset < inDims[1]) {
                     previous = getX(batch, xR, xCOffset, d1);
                     xC`+(G+1)+" = vec4(previous.zw, xTexelC"+(G+1)+`.xy);
                    } else {
                     xC`+(G+1)+" = vec4(0.0, 0.0, xTexelC"+(G+1)+`.xy);
                    }
                    `:M+=`
                    xC`+(G+1)+" = vec4(xTexelC"+G+".zw, xTexelC"+(G+1)+`.xy);
                    `):H===1?M+=`
                    xC`+(G+1)+" = xTexelC"+G+`;
                    `:M+=`
                    xCOffset = xC + `+H+`;

                    if (xCOffset >= 0 && xCOffset < inDims[1] && xTexelC`+(G+1)+`Ready == 0) {
                      xTexelC`+(G+1)+` = getX(batch, xR, xCOffset, d1);
                      if (xCOffset + 1 >= inDims[1]) {
                        xTexelC`+(G+1)+`.zw = vec2(0.0);
                      }
                      xTexelC`+(G+1)+`Ready = 1;
                    }

                    xC`+(G+1)+" = xTexelC"+(G+1)+`;
                    `}}else G<v&&(_%2===1?(M+=`
                xCOffset = xC + 1 - strides[1];
                if(xCOffset >= 0 && xCOffset < inDims[1] && xTexelC`+G+`Ready == 0) {
                  xTexelC`+G+` = getX(batch, xR, xCOffset, d1);
                  // Need to manually clear unused channels in case
                  // we're reading from recycled texture.
                  if (xCOffset + 1 >= inDims[1]) {
                    xTexelC`+G+`.zw = vec2(0.0);
                  }
                  xTexelC`+G+`Ready = 1;
                }

                if(xC + 1 >= 0 && xC + 1 < inDims[1] && xTexelC`+(G+1)+`Ready == 0) {
                  xTexelC`+(G+1)+` = getX(batch, xR, xC + 1, d1);
                  // Need to manually clear unused channels in case
                  // we're reading from recycled texture.
                  if (xC + 2 >= inDims[1]) {
                    xTexelC`+(G+1)+`.zw = vec2(0.0);
                  }
                  xTexelC`+(G+1)+`Ready = 1;
                }

                xC`+G+" = vec4(xTexelC"+G+".zw, xTexelC"+(G+1)+`.zw);
              `,G+1<v&&(M+=`
                  final = vec4(0.0);
                  xCOffset = xC + 1 + strides[1];
                  if(xCOffset >= 0 && xCOffset < inDims[1]) {
                    final = getX(batch, xR, xCOffset, d1);
                  }
                  xC`+(G+1)+" = vec4(xTexelC"+(G+1)+`.xy, final.xy);
                `)):(M+=`
                if(xC >= 0 && xC < inDims[1] && xTexelC`+G+`Ready == 0) {
                  xTexelC`+G+` = getX(batch, xR, xC, d1);
                  if (xC + 1 >= inDims[1]) {
                    xTexelC`+G+`.zw = vec2(0.0);
                  }
                  xTexelC`+G+`Ready = 1;
                }

                xCOffset = xC + strides[1];
                if(xCOffset >= 0 && xCOffset < inDims[1] && xTexelC`+(G+1)+`Ready == 0) {
                  xTexelC`+(G+1)+` = getX(batch, xR, xCOffset, d1);
                  if (xCOffset + 1 >= inDims[1]) {
                    xTexelC`+(G+1)+`.zw = vec2(0.);
                  }
                  xTexelC`+(G+1)+`Ready = 1;
                }

                xC`+G+` = vec4(
                  xTexelC`+G+".xy, xTexelC"+(G+1)+`.xy);
              `,G+1<v&&(M+=`
                  xC`+(G+1)+" = vec4(xTexelC"+G+".zw, xTexelC"+(G+1)+`.zw);
                `)));G<v&&(M+=`
            wTexel = getW(r, `+G+`, d1, q);
            dotProd += xC`+G+` * vec4(wTexel.xz, wTexel.xz);
          `,G+1<v&&(M+=`
              wTexel = getW(r, `+(G+1)+`, d1, q);
              dotProd += xC`+(G+1)+` * vec4(wTexel.xz, wTexel.xz);
            `))}M+=`
    }
  `,M+=`
      }
    `;let F="",L="";s&&(n?F=`vec4 activation(vec4 a) {
          vec4 b = getPreluActivationWeightsAtOutCoords();
          `+s+`
        }`:a?F=`vec4 activation(vec4 a) {
          vec4 b = getLeakyreluAlphaAtOutCoords();
          `+s+`
        }`:F=`vec4 activation(vec4 x) {
          `+s+`
        }`,L="result = activation(result);");const N=i?"result += getBiasAtOutCoords();":"";i&&this.variableNames.push("bias"),n&&this.variableNames.push("preluActivationWeights"),a&&this.variableNames.push("leakyreluAlpha"),this.userCode=`
      `+F+`

      void main() {
        ivec4 coords = getOutputCoords();
        int batch = coords.x;
        ivec2 xRCCorner = coords.yz * strides - pads;
        int d2 = coords.w;
        int d1 = d2 / `+p+`;
        int q = d2 - d1 * `+p+`;
        int xRCorner = xRCCorner.x;
        int xCCorner = xRCCorner.y;

        //intialize dotProd with a small epsilon seems to reduce GPU accuracy loss.
        vec4 dotProd = vec4(0.000000000000001);

        `+M+`

        vec4 result = dotProd - vec4(0.000000000000001);
        `+N+`
        `+L+`
        setOutput(result);
      }
    `}}function tV(l){const{inputs:e,backend:i,attrs:s}=l,{x:n,filter:a}=e,{strides:p,pad:_,dilations:g,dimRoundingMode:y}=s;let b=g;b==null&&(b=[1,1]),Te(ta(p,b),()=>"Error in depthwiseConv2d: Either strides or dilations must be 1. Got strides "+p+" and dilations '"+b+"'");const v=mo(n.shape,a.shape,p,b,_,y,!0);let S;Ue().getBool("WEBGL_PACK_DEPTHWISECONV")&&v.strideWidth<=2&&v.outChannels/v.inChannels===1?S=new TT(v):S=new vT(v);const M=[[v.padInfo.top,v.padInfo.left],[v.strideHeight,v.strideWidth],[v.dilationHeight,v.dilationWidth],[v.inHeight,v.inWidth]];return i.runWebGLProgram(S,[n,a],"float32",M)}const iV={kernelName:df,backendName:"webgl",kernelFunc:tV};function Tm(l){const{inputs:e,attrs:i,backend:s}=l,{dim:n}=i,{input:a}=e,p=a.shape.length,_=a.shape.slice();let g=n;return n<0&&(Te(-(p+1)<=n,()=>"Axis must be in the interval ["+-(p+1)+", "+p+"]"),g=p+n+1),_.splice(g,0,1),Qi({inputs:{x:a},backend:s,attrs:{shape:_}})}const rV={kernelName:ff,backendName:"webgl",kernelFunc:Tm};class sV{constructor(e,i){this.outputShape=[],this.customUniforms=[{name:"value",type:"float"}],this.variableNames=["x"],this.outputShape=e,this.userCode=`
      void main() {
        // Input can be obtained from uniform value.
        setOutput(value);
      }
    `}}function Em(l){const{backend:e,attrs:i}=l,{shape:s,value:n}=i;let{dtype:a}=i;if(a=a||ar(n),a==="string"){const p=bt(a,Je(s));return p.fill(n),e.makeTensorInfo(s,a,p)}else{const p=new sV(s,n),_=[[n]];return e.runWebGLProgram(p,[],a,_)}}const nV={kernelName:pf,backendName:"webgl",kernelFunc:Em},ET="return floor(x);",aV=ux({opSnippet:ET,packedOpSnippet:ET,cpuKernelImpl:xU}),oV={kernelName:Qu,backendName:"webgl",kernelFunc:aV};class xV{constructor(e){this.variableNames=["A"];const i=Tn(),[s,n]=e;this.outputShape=e,this.userCode=`
      void main() {
        ivec3 coords = getOutputCoords();
        int texR = coords[0];
        int texC = coords[1];
        int depth = coords[2];
        vec2 uv = (vec2(texC, texR) + halfCR) / vec2(`+n+".0, "+s+`.0);

        vec4 values = `+i.texture2D+`(A, uv);
        float value;
        if (depth == 0) {
          value = values.r;
        } else if (depth == 1) {
          value = values.g;
        } else if (depth == 2) {
          value = values.b;
        } else if (depth == 3) {
          value = values.a;
        }

        setOutput(floor(value * 255.0 + 0.5));
      }
    `}}class lV{constructor(e){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;const i=Tn(),[s,n]=e;this.outputShape=e,this.userCode=`
      void main() {
        ivec3 coords = getOutputCoords();
        int texR = coords[0];
        int texC = coords[1];
        int depth = coords[2];

        vec4 result = vec4(0.);

        for(int row=0; row<=1; row++) {
          for(int col=0; col<=1; col++) {
            texC = coords[1] + row;
            depth = coords[2] + col;

            vec2 uv = (vec2(texC, texR) + halfCR) /
                       vec2(`+n+".0, "+s+`.0);
            vec4 values = `+i.texture2D+`(A, uv);
            float value;
            if (depth == 0) {
              value = values.r;
            } else if (depth == 1) {
              value = values.g;
            } else if (depth == 2) {
              value = values.b;
            } else if (depth == 3) {
              value = values.a;
            }

            result[row * 2 + col] = floor(value * 255.0 + 0.5);
          }
        }

        `+i.output+` = result;
      }
    `}}const cV={kernelName:Df,backendName:"webgl",kernelFunc:hV};let cc,Am=Ue().getBool("CANVAS2D_WILL_READ_FREQUENTLY_FOR_GPU");function hV(l){const{inputs:e,backend:i,attrs:s}=l;let{pixels:n}=e;const{numChannels:a}=s,p=typeof HTMLVideoElement<"u"&&n instanceof HTMLVideoElement,_=typeof HTMLImageElement<"u"&&n instanceof HTMLImageElement,[g,y]=p?[n.videoWidth,n.videoHeight]:[n.width,n.height],b=[y,g],v=[y,g,a];if(_||p){const L=Ue().getBool("CANVAS2D_WILL_READ_FREQUENTLY_FOR_GPU");(cc==null||L!==Am)&&(Am=L,cc=document.createElement("canvas").getContext("2d",{willReadFrequently:Am})),cc.canvas.width=g,cc.canvas.height=y,cc.drawImage(n,0,0,g,y),n=cc.canvas}const S=i.makeTensorInfo(b,"int32");i.texData.get(S.dataId).usage=ma.PIXELS,i.gpgpu.uploadPixelDataToTexture(i.getTexture(S.dataId),n);const M=Ue().getBool("WEBGL_PACK")?new lV(v):new xV(v),F=i.runWebGLProgram(M,[S],"int32");return i.disposeData(S.dataId),F}function uV(l){const{inputs:e,backend:i,attrs:s}=l,{x:n,filter:a,bias:p,preluActivationWeights:_}=e,{strides:g,pad:y,dataFormat:b,dilations:v,dimRoundingMode:S,activation:M,leakyreluAlpha:F}=s,L=dh(b),N=mo(n.shape,a.shape,g,v,y,S,!1,L);let k;const G=[],H=p!=null,z=_!=null,W=M==="leakyrelu",Y=()=>{const Q=[n,a],se=($,oe)=>{if(oe==="NCHW"&&$.shape.length===1&&$.shape[0]!==1){const ue=Qi({inputs:{x:$},backend:i,attrs:{shape:[$.shape[0],1,1]}});return G.push(ue),ue}return $};if(H&&Q.push(se(p,b)),z&&Q.push(se(_,b)),W){const $=i.makeTensorInfo([],"float32",rh(F,"float32"));Q.push($),G.push($)}return Q};if(N.filterHeight===1&&N.filterWidth===1&&N.dilationHeight===1&&N.dilationWidth===1&&N.strideHeight===1&&N.strideWidth===1&&(N.padInfo.type==="SAME"||N.padInfo.type==="VALID"))k=yT({x:n,filter:a,convInfo:N,backend:i,bias:p,activation:M,preluActivationWeights:_,leakyreluAlpha:F});else if(N.strideWidth<=2&&L==="channelsLast"&&Ue().getBool("WEBGL_EXP_CONV")){const Q=M?Ph(M,!0):null,se=new gT(N,H,Q,z,W),$=[[N.padInfo.top,N.padInfo.left],[N.strideHeight,N.strideWidth],[N.dilationHeight,N.dilationWidth],[N.inHeight,N.inWidth]],oe=Y();k=i.runWebGLProgram(se,oe,"float32",$)}else if(Ue().getBool("WEBGL_CONV_IM2COL"))k=bT({x:n,filter:a,convInfo:N,backend:i,bias:p,activation:M,preluActivationWeights:_,leakyreluAlpha:F});else{const Q=M?Ph(M,!1):null,se=new _T(N,H,Q,z,W),$=Y();k=i.runWebGLProgram(se,$,"float32")}const Z=Qi({inputs:{x:k},backend:i,attrs:{shape:N.outShape}});return G.push(k),G.forEach(Q=>i.disposeIntermediateTensorInfo(Q)),Z}const dV={kernelName:md,backendName:"webgl",kernelFunc:uV};function fV(l){const{inputs:e,backend:i,attrs:s}=l,{x:n,filter:a,bias:p,preluActivationWeights:_}=e,{strides:g,pad:y,dilations:b,dimRoundingMode:v,activation:S,leakyreluAlpha:M}=s,F=[];let L=b;L==null&&(L=[1,1]),Te(ta(g,L),()=>"Error in depthwiseConv2d: Either strides or dilations must be 1. Got strides "+g+" and dilations '"+L+"'");const N=mo(n.shape,a.shape,g,L,y,v,!0),k=Ue().getBool("WEBGL_PACK_DEPTHWISECONV")&&N.strideWidth<=2&&N.outChannels/N.inChannels===1,G=S?Ph(S,k):null,H=[n,a],z=p!=null,W=_!=null,Y=S==="leakyrelu";if(z&&H.push(p),W&&H.push(_),Y){const $=i.makeTensorInfo([],"float32",rh(M,"float32"));H.push($),F.push($)}let Z;k?Z=new TT(N,z,G,W,Y):Z=new vT(N,z,G,W,Y);const Q=[[N.padInfo.top,N.padInfo.left],[N.strideHeight,N.strideWidth],[N.dilationHeight,N.dilationWidth],[N.inHeight,N.inWidth]],se=i.runWebGLProgram(Z,H,"float32",Q);return F.forEach($=>i.disposeIntermediateTensorInfo($)),se}const pV={kernelName:_d,backendName:"webgl",kernelFunc:fV};class mV{constructor(e,i){this.variableNames=["A","indices"],this.outputShape=i,this.rank=i.length;const s=En(this.rank),n=_V(e);this.userCode=`
      void main() {
        `+s+` resRC = getOutputCoords();
        int index = int(getIndices(resRC.x, resRC.z));
        float inBounds = (index >= 0) && (index < `+e[2]+`) ? 1.0 : 0.0;
        setOutput(inBounds * getA(`+n+`));
      }
    `}}function _V(l,e){const i=["resRC.x","resRC.y","resRC.z","resRC.w"],s=[];for(let n=0;n<l.length;n++)n===2?s.push("index"):s.push(""+i[n]);return s.join()}function gV(l){const{inputs:e,backend:i,attrs:s}=l,{x:n,indices:a}=e,{axis:p,batchDims:_}=s,g=jt(p,n.shape)[0];if(Ue().get("DEBUG")){const G=i.readSync(a.dataId),H=n.shape[g];for(let z=0;z<G.length;++z){const W=G[z];Te(W<=H-1&&W>=0,()=>"GatherV2: the index value "+W+" is not in [0, "+(H-1)+"]")}}const y=Np(n,a,g,_),b=Je(a.shape),v=[],S=Qi({inputs:{x:n},backend:i,attrs:{shape:[y.batchSize,y.outerSize,y.dimSize,y.sliceSize]}}),M=Qi({inputs:{x:a},backend:i,attrs:{shape:[y.batchSize,b/y.batchSize]}});v.push(S),v.push(M);const F=[y.batchSize,y.outerSize,b/y.batchSize,y.sliceSize];if(i.shouldExecuteOnCPU([n,a])||n.dtype==="string"){const G=i.bufferSync(M),H=i.bufferSync(S),z=lU(H,G,F);return v.forEach(W=>i.disposeIntermediateTensorInfo(W)),i.makeTensorInfo(y.outputShape,z.dtype,z.values)}const L=new mV(S.shape,F),N=i.runWebGLProgram(L,[S,M],S.dtype);v.push(N);const k=Qi({inputs:{x:N},backend:i,attrs:{shape:y.outputShape}});return v.forEach(G=>i.disposeIntermediateTensorInfo(G)),k}const yV={kernelName:mf,backendName:"webgl",kernelFunc:gV},bV="return float(a >= b);",vV=`
  return vec4(greaterThanEqual(a, b));
`,TV=ga({opSnippet:bV,packedOpSnippet:vV,dtype:"bool",cpuKernelImpl:cU}),EV={kernelName:$u,backendName:"webgl",kernelFunc:TV},AV="return float(a < b);",CV=`
  return vec4(lessThan(a, b));
`,RV=ga({opSnippet:AV,packedOpSnippet:CV,cpuKernelImpl:hU,dtype:"bool"}),IV={kernelName:ed,backendName:"webgl",kernelFunc:RV},SV="return float(a <= b);",MV=`
  return vec4(lessThanEqual(a, b));
`,PV=ga({opSnippet:SV,packedOpSnippet:MV,cpuKernelImpl:uU,dtype:"bool"}),OV={kernelName:td,backendName:"webgl",kernelFunc:PV},wV="return float(a >= 1.0 && b >= 1.0);",DV=`
  return vec4(
    vec4(greaterThanEqual(a, vec4(1.0))) *
    vec4(greaterThanEqual(b, vec4(1.0))));
`,FV=ga({opSnippet:wV,packedOpSnippet:DV,dtype:"bool"}),LV={kernelName:id,backendName:"webgl",kernelFunc:FV},NV="return float(a >= 1.0 || b >= 1.0);",BV=`
  return min(
    vec4(greaterThanEqual(a, vec4(1.0))) +
    vec4(greaterThanEqual(b, vec4(1.0))),
    vec4(1.0));
`,kV=ga({opSnippet:NV,packedOpSnippet:BV,dtype:"bool"}),UV={kernelName:rd,backendName:"webgl",kernelFunc:kV};function VV(l,e,i,s){const n=Je(e),a=Je(l.shape)/n,p=Qi({inputs:{x:l},attrs:{shape:[a,n]},backend:s}),_=e2(p,l.dtype,"max",s),g=Qi({inputs:{x:_},attrs:{shape:i},backend:s});return s.disposeIntermediateTensorInfo(p),s.disposeIntermediateTensorInfo(_),g}function GV(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{reductionIndices:a,keepDims:p}=s,_=n.shape.length,g=jt(a,n.shape);let y=g;const b=rx(y,_),v=b!=null,S=i.shouldExecuteOnCPU([n]);let M=n;if(v){if(S){const G=i.texData.get(M.dataId).values,H=new Array(_);for(let Y=0;Y<H.length;Y++)H[Y]=n.shape[b[Y]];const z=pm(G,n.shape,n.dtype,b,H);M=i.makeTensorInfo(H,n.dtype);const W=i.texData.get(M.dataId);W.values=z}else M=t2(n,b,i);y=sx(y.length,_)}ix("max",y,_);const[F,L]=Fo(M.shape,y);let N=F;p&&(N=f0(F,g));let k;if(S){const G=i.texData.get(M.dataId).values,H=dU(G,Je(L),N,n.dtype);k=i.makeTensorInfo(N,n.dtype);const z=i.texData.get(k.dataId);z.values=H}else k=VV(M,L,N,i);return v&&i.disposeIntermediateTensorInfo(M),k}const WV={kernelName:_f,backendName:"webgl",kernelFunc:GV};function zV(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e;cv(n,"maxPool");const{filterSize:a,strides:p,pad:_,dimRoundingMode:g}=s,y=1;Te(ta(p,y),()=>"Error in maxPool: Either strides or dilations must be 1. Got strides "+p+" and dilations '"+y+"'");const b=jl(n.shape,a,p,y,_,g);if(b.filterWidth===1&&b.filterHeight===1&&qt(b.inShape,b.outShape))return Xa({inputs:{x:n},backend:i});const v=new aT(b,"max",!1);return i.runWebGLProgram(v,[n],n.dtype)}const HV={kernelName:gf,backendName:"webgl",kernelFunc:zV},XV=_m+`
  return max(a, b);
`,YV=`
  vec4 result = vec4(max(a, b));
  bvec4 isNaNA = isnan(a);
  bvec4 isNaNB = isnan(b);
  bvec4 isNaN = bvec4(isNaNA.x || isNaNB.x, isNaNA.y || isNaNB.y, isNaNA.z || isNaNB.z, isNaNA.w || isNaNB.w);
  `+lc+`
  return result;
`,KV=ga({opSnippet:XV,packedOpSnippet:YV,cpuKernelImpl:fU}),jV={kernelName:sd,backendName:"webgl",kernelFunc:KV};function qV(l,e,i,s){const n=Je(e),a=Je(l.shape)/n,p=Qi({inputs:{x:l},attrs:{shape:[a,n]},backend:s}),_=e2(p,"float32","mean",s),g=Qi({inputs:{x:_},attrs:{shape:i},backend:s});return s.disposeIntermediateTensorInfo(p),s.disposeIntermediateTensorInfo(_),g}const ZV={kernelName:yf,backendName:"webgl",kernelFunc:({inputs:l,attrs:e,backend:i})=>{const{x:s}=l,{keepDims:n,axis:a}=e,p=i,_=s.shape.length,g=jt(a,s.shape);let y=g;const b=rx(y,_),v=b!=null,S=p.shouldExecuteOnCPU([s]),M=[];let F=s;if(v){if(S){const H=p.texData.get(F.dataId).values,z=new Array(_);for(let Z=0;Z<z.length;Z++)z[Z]=s.shape[b[Z]];const W=pm(H,s.shape,s.dtype,b,z);F=p.makeTensorInfo(z,s.dtype);const Y=p.texData.get(F.dataId);Y.values=W}else F=t2(s,b,p);M.push(F),y=sx(y.length,_)}ix("sum",y,_);const[L,N]=Fo(F.shape,y);let k=L;n&&(k=f0(L,g));const G=qV(F,N,k,p);for(const H of M)p.disposeIntermediateTensorInfo(H);return G}};function QV(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{axis:a,keepDims:p}=s,_=n.shape.length,g=jt(a,n.shape);let y=g;const b=rx(y,_);let v=n;b!=null&&(v=i2({inputs:{x:n},backend:i,attrs:{perm:b}}),y=sx(y.length,n.shape.length)),ix("min",y,_);const[S,M]=Fo(v.shape,y),F=Je(M),L=Qi({inputs:{x:v},backend:i,attrs:{shape:[-1,F]}}),N=e2(L,L.dtype,"min",i);let k;if(p){const G=f0(S,g);k=Qi({inputs:{x:N},backend:i,attrs:{shape:G}})}else k=Qi({inputs:{x:N},backend:i,attrs:{shape:S}});return i.disposeIntermediateTensorInfo(L),i.disposeIntermediateTensorInfo(N),b!=null&&i.disposeIntermediateTensorInfo(v),k}const $V={kernelName:bf,backendName:"webgl",kernelFunc:QV},JV=_m+`
  return min(a, b);
`,e5=`
  vec4 result = vec4(min(a, b));
  bvec4 isNaNA = isnan(a);
  bvec4 isNaNB = isnan(b);
  bvec4 isNaN = bvec4(isNaNA.x || isNaNB.x, isNaNA.y || isNaNB.y, isNaNA.z || isNaNB.z, isNaNA.w || isNaNB.w);
  `+lc+`
  return result;
`,t5=ga({opSnippet:JV,packedOpSnippet:e5,cpuKernelImpl:pU}),i5={kernelName:nd,backendName:"webgl",kernelFunc:t5},r5=Sh+`
  return -x;
`,s5=`
  vec4 result = -x;
  bvec4 isNaN = isnan(x);

  result.r = isNaN.r ? x.r : result.r;
  result.g = isNaN.g ? x.g : result.g;
  result.b = isNaN.b ? x.b : result.b;
  result.a = isNaN.a ? x.a : result.a;

  return result;
`;function n5(l){const{inputs:e,backend:i}=l,{x:s}=e;if(i.shouldExecuteOnCPU([s])){const a=i.texData.get(s.dataId),[p,_]=_U(a.values,s.shape,s.dtype);return i.makeTensorInfo(_,s.dtype,p)}let n;return Ue().getBool("WEBGL_PACK_UNARY_OPERATIONS")?n=new hx(s.shape,s5):n=new y0(s.shape,r5),i.runWebGLProgram(n,[s],s.dtype)}const a5={kernelName:vf,backendName:"webgl",kernelFunc:n5};function o5(l){const{inputs:e,backend:i,attrs:s}=l,{axis:n}=s;if(e.length===1)return Tm({inputs:{input:e[0]},backend:i,attrs:{dim:n}});const a=e[0].shape,p=e[0].dtype;e.forEach(b=>{yi(a,b.shape,"All tensors passed to stack must have matching shapes"),Te(p===b.dtype,()=>"All tensors passed to stack must have matching dtypes")});const _=[],g=e.map(b=>{const v=Tm({inputs:{input:b},backend:i,attrs:{dim:n}});return _.push(v),v}),y=mT({inputs:g,backend:i,attrs:{axis:n}});return _.forEach(b=>i.disposeIntermediateTensorInfo(b)),y}const x5={kernelName:Tf,backendName:"webgl",kernelFunc:o5};class l5{constructor(e,i,s){this.variableNames=["x"],this.customUniforms=[{name:"value",type:"float"}],this.outputShape=i.map((y,b)=>y[0]+e[b]+y[1]);const n=e.length,a=En(n),p=i.map(y=>y[0]).join(","),_=i.map((y,b)=>y[0]+e[b]).join(","),g=["coords[0]","coords[1]","coords[2]","coords[3]"].slice(0,n);if(n===1){this.userCode=`
        int start = `+p+`;
        int end = `+_+`;

        void main() {
          int outC = getOutputCoords();
          if (outC < start || outC >= end) {
            setOutput(value);
          } else {
            setOutput(getX(outC - start));
          }
        }
      `;return}this.userCode=`
      `+a+" start = "+a+"("+p+`);
      `+a+" end = "+a+"("+_+`);

      void main() {
        `+a+` outC = getOutputCoords();
        if (any(lessThan(outC, start)) || any(greaterThanEqual(outC, end))) {
          setOutput(value);
        } else {
          `+a+` coords = outC - start;
          setOutput(getX(`+g+`));
        }
      }
    `}}class c5{constructor(e,i,s){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0,this.customUniforms=[{name:"value",type:"float"}],this.outputShape=i.map((L,N)=>L[0]+e[N]+L[1]);const n=e.length,a=En(n),p=i.map(L=>L[0]).join(","),_=i.map((L,N)=>L[0]+e[N]).join(","),g=lx("rc",n),y=lx("source",n),b=g[n-1]+" < "+this.outputShape[n-1],v=n===1?"source":"vec2("+y.slice(-2).join()+")",S=[a+" rc = outputLoc;",g[n-1]+` += 1;
       if(`+b+`) {
      `,n===1?"":`}
       rc = outputLoc;
       `+g[n-2]+` += 1;
       if(`+g[n-2]+" < "+this.outputShape[n-2]+") {",n===1?"":"  "+g[n-1]+` += 1;
         if(`+b+") {"],M=n===1?"rc < start || rc >= end":"any(lessThan(rc, start)) || any(greaterThanEqual(rc, end))";let F="";for(let L=0,N=n===1?2:4;L<N;L++)F+=`
        `+S[L]+`
        if (`+M+`) {
          result[`+L+`] = float(value);
        } else {
          `+a+` source = rc - start;
          result[`+L+"] = getChannel(getX("+y.join()+"), "+v+`);
        }
      `;F+=n===1?"} ":"}}",this.userCode=`
      const `+a+" start = "+a+"("+p+`);
      const `+a+" end = "+a+"("+_+`);

      void main() {
        `+a+` outputLoc = getOutputCoords();
        vec4 result = vec4(0.);
        `+F+`
        setOutput(result);
      }
    `}}const h5=l=>{const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{paddings:a,constantValue:p}=s;if(Je(n.shape)===0){const y=a.map((b,v)=>b[0]+n.shape[v]+b[1]);return Em({backend:i,attrs:{shape:y,value:p,dtype:n.dtype}})}const _=Ue().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new c5(n.shape,a,p):new l5(n.shape,a,p),g=[[p]];return i.runWebGLProgram(_,[n],n.dtype,g)},u5={kernelName:Ef,backendName:"webgl",kernelFunc:h5},d5=`
  if(a < 0.0 && floor(b) < b){
    return NAN;
  }
  if (b == 0.0) {
    return 1.0;
  }
  return (round(mod(b, 2.0)) != 1) ?
      pow(abs(a), b) : sign(a) * pow(abs(a), b);
`,f5=`
  // isModRound1 has 1 for components with round(mod(b, 2.0)) == 1, 0 otherwise.
  vec4 isModRound1 = vec4(equal(round(mod(b, 2.0)), ivec4(1)));
  vec4 multiplier = sign(a) * isModRound1 + (vec4(1.0) - isModRound1);
  vec4 result = multiplier * pow(abs(a), b);

  // Ensure that a^0 = 1, including 0^0 = 1 as this correspond to TF and JS
  bvec4 isExpZero = equal(b, vec4(0.0));
  result.r = isExpZero.r ? 1.0 : result.r;
  result.g = isExpZero.g ? 1.0 : result.g;
  result.b = isExpZero.b ? 1.0 : result.b;
  result.a = isExpZero.a ? 1.0 : result.a;

  bvec4 isNaN1 = lessThan(a, vec4(0.0));
  bvec4 isNaN2 = lessThan(floor(b), b);
  bvec4 isNaN = bvec4(isNaN1.x && isNaN2.x, isNaN1.y && isNaN2.y, isNaN1.z && isNaN2.z, isNaN1.w && isNaN2.w);
  `+lc+`
  return result;
`,p5=ga({opSnippet:d5,packedOpSnippet:f5}),m5={kernelName:od,backendName:"webgl",kernelFunc:p5},_5=l=>{const{backend:e,attrs:i}=l,{start:s,stop:n,step:a,dtype:p}=i,_=yU(s,n,a,p);return e.makeTensorInfo([_.length],p,_)},g5={kernelName:Cf,backendName:"webgl",kernelFunc:_5},y5=`
if (a == b) {
  return 1.0;
};
return a / b;`,b5=`
  // vec4 one = vec4(equal(a, b));
  // return one + (vec4(1.0) - one) * a / b;
  vec4 result = a / b;
  if(a.x == b.x) {
    result.x = 1.;
  }
  if(a.y == b.y) {
    result.y = 1.;
  }
  if(a.z == b.z) {
    result.z = 1.;
  }
  if(a.w == b.w) {
    result.w = 1.;
  }

  return result;
`,v5=ga({opSnippet:y5,packedOpSnippet:b5,checkOutOfBounds:!0}),T5={kernelName:Zu,backendName:"webgl",kernelFunc:v5},E5=Sh+`
  return (x < 0.0) ? 0.0 : x;
`,A5=`
  vec4 result = x * vec4(greaterThanEqual(x, vec4(0.0)));
  bvec4 isNaN = isnan(x);

  result.r = isNaN.r ? x.r : result.r;
  result.g = isNaN.g ? x.g : result.g;
  result.b = isNaN.b ? x.b : result.b;
  result.a = isNaN.a ? x.a : result.a;

  return result;
`,C5=ux({opSnippet:E5,packedOpSnippet:A5}),R5={kernelName:xd,backendName:"webgl",kernelFunc:C5},I5=Sh+`
  return (x < 0.0) ? 0.0 : min(6.0, x);
`,S5=`
  vec4 result = min(x, vec4(6.)) * vec4(greaterThanEqual(x, vec4(0.0)));
  bvec4 isNaN = isnan(x);

  result.r = isNaN.r ? x.r : result.r;
  result.g = isNaN.g ? x.g : result.g;
  result.b = isNaN.b ? x.b : result.b;
  result.a = isNaN.a ? x.a : result.a;

  return result;
`,M5=ux({opSnippet:I5,packedOpSnippet:S5}),P5={kernelName:ld,backendName:"webgl",kernelFunc:M5};class O5{constructor(e,i,s,n,a){this.variableNames=["A"],this.outputShape=[];const[p,_,g,y]=e;this.outputShape=[p,i,s,y];const b=[n&&i>1?_-1:_,n&&s>1?g-1:g],v=[n&&i>1?i-1:i,n&&s>1?s-1:s];let S;a?S="(vec2(yRC) + vec2(0.5)) * effectiveInputOverOutputRatioRC - vec2(0.5)":S="vec2(yRC) * effectiveInputOverOutputRatioRC",this.userCode=`
      const vec2 effectiveInputOverOutputRatioRC = vec2(
          `+b[0]/v[0]+`,
          `+b[1]/v[1]+`);
      const vec2 inputShapeRC = vec2(`+_+".0, "+g+`.0);

      void main() {
        ivec4 coords = getOutputCoords();
        int b = coords[0];
        int d = coords[3];
        ivec2 yRC = coords.yz;

        // Fractional source index.
        vec2 sourceFracIndexRC = `+S+`;

        // Compute the four integer indices.
        ivec2 sourceFloorRC = ivec2(max(sourceFracIndexRC, vec2(0.0)));
        ivec2 sourceCeilRC = ivec2(
          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));

        float topLeft = getA(b, sourceFloorRC.x, sourceFloorRC.y, d);
        float bottomLeft = getA(b, sourceCeilRC.x, sourceFloorRC.y, d);
        float topRight = getA(b, sourceFloorRC.x, sourceCeilRC.y, d);
        float bottomRight = getA(b, sourceCeilRC.x, sourceCeilRC.y, d);

        vec2 fracRC = sourceFracIndexRC - vec2(sourceFloorRC);

        float top = topLeft + (topRight - topLeft) * fracRC.y;
        float bottom = bottomLeft + (bottomRight - bottomLeft) * fracRC.y;
        float newValue = top + (bottom - top) * fracRC.x;

        setOutput(newValue);
      }
    `}}class w5{constructor(e,i,s,n,a){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[];const[p,_,g,y]=e;this.outputShape=[p,i,s,y];const b=[n&&i>1?_-1:_,n&&s>1?g-1:g],v=[n&&i>1?i-1:i,n&&s>1?s-1:s];let S;a?S="(vec3(yRC) + vec3(0.5)) * effectiveInputOverOutputRatioRC - vec3(0.5)":S="vec3(yRC) * effectiveInputOverOutputRatioRC",this.userCode=`
      const vec3 effectiveInputOverOutputRatioRC = vec3(
          `+b[0]/v[0]+`,
          `+b[1]/v[1]+`,
          `+b[1]/v[1]+`);
      const vec3 inputShapeRC = vec3(`+_+".0, "+g+`.0,
                                     `+g+`.0);

      float getAValue(int b, int r, int c, int d) {
        return getChannel(getA(b, r, c, d), vec2(c, d));
      }

      void main() {
        ivec4 coords = getOutputCoords();
        int b = coords[0];
        int d = coords[3];
        // Calculate values for next column in yRC.z.
        ivec3 yRC = coords.yzz + ivec3(0, 0, 1);

        // Fractional source index.
        vec3 sourceFracIndexRC = `+S+`;

        // Compute the four integer indices.
        ivec3 sourceFloorRC = ivec3(max(sourceFracIndexRC, vec3(0.0)));
        ivec3 sourceCeilRC = ivec3(
          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));

        // Should we calculate next column and row elements in 2x2 packed cell.
        bool hasNextCol = d < `+(y-1)+`;
        bool hasNextRow = coords.z < `+(s-1)+`;

        // In parallel, construct four corners for all four components in
        // packed 2x2 cell.
        vec4 topLeft = vec4(
          getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d),
          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d + 1)
                     : 0.0,
          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d)
                     : 0.0,
          (hasNextRow && hasNextCol) ?
            getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d + 1) : 0.0);

        vec4 bottomLeft = vec4(
          getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d),
          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d + 1)
                     : 0.0,
          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d)
                     : 0.0,
          (hasNextRow && hasNextCol) ?
            getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d + 1) : 0.0);

        vec4 topRight = vec4(
          getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d),
          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d + 1)
                     : 0.0,
          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d)
                     : 0.0,
          (hasNextRow && hasNextCol) ?
            getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d + 1) : 0.0);

        vec4 bottomRight = vec4(
          getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d),
          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d + 1)
                     : 0.0,
          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d)
                     : 0.0,
          (hasNextRow && hasNextCol) ?
            getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d + 1) : 0.0);

        vec3 fracRC = sourceFracIndexRC - vec3(sourceFloorRC);

        vec4 top = mix(topLeft, topRight, fracRC.yyzz);
        vec4 bottom = mix(bottomLeft, bottomRight, fracRC.yyzz);
        vec4 newValue = mix(top, bottom, fracRC.x);

        setOutput(newValue);
      }
    `}}function D5(l){const{inputs:e,backend:i,attrs:s}=l,{images:n}=e,{alignCorners:a,halfPixelCenters:p,size:_}=s,[g,y]=_,b=Ue().getBool("WEBGL_PACK_IMAGE_OPERATIONS")?new w5(n.shape,g,y,a,p):new O5(n.shape,g,y,a,p);return i.runWebGLProgram(b,[n],"float32")}const F5={kernelName:If,backendName:"webgl",kernelFunc:D5};class L5{constructor(e,i){this.variableNames=["Image"],this.outputShape=[],this.customUniforms=[{name:"params",type:"vec4"}];const s=e[1],n=e[2];this.outputShape=e;let a="";typeof i=="number"?a="float outputValue = "+i.toFixed(2)+";":a=`
        vec3 fill = vec3(`+i.join(",")+`);
        float outputValue = fill[coords[3]];`,this.userCode=`
        void main() {
          ivec4 coords = getOutputCoords();
          int x = coords[2];
          int y = coords[1];
          float coordXFloat = (float(x) - params[0]) * params[3] -
            (float(y) - params[1]) * params[2];
          float coordYFloat = (float(x) - params[0]) * params[2] +
            (float(y) - params[1]) * params[3];
          int coordX = int(round(coordXFloat + params[0]));
          int coordY = int(round(coordYFloat + params[1]));
          `+a+`
          if(coordX >= 0 && coordX < `+n+" && coordY >= 0 && coordY < "+s+`) {
            outputValue = getImage(coords[0], coordY, coordX, coords[3]);
          }
          setOutput(outputValue);
        }
    `}}const N5={kernelName:Ff,backendName:"webgl",kernelFunc:({inputs:l,attrs:e,backend:i})=>{const{image:s}=l,{radians:n,fillValue:a,center:p}=e,_=i,g=new L5(s.shape,a),[y,b]=Dp(p,s.shape[1],s.shape[2]),v=[[y,b,Math.sin(n),Math.cos(n)]];return _.runWebGLProgram(g,[s],s.dtype,v)}},B5=ym+`
  return 1.0 / (1.0 + exp(-1.0 * x));
`,k5=`
  vec4 result = 1.0 / (1.0 + exp(-1.0 * x));
  bvec4 isNaN = isnan(x);

  result.r = isNaN.r ? x.r : result.r;
  result.g = isNaN.g ? x.g : result.g;
  result.b = isNaN.b ? x.b : result.b;
  result.a = isNaN.a ? x.a : result.a;

  return result;
`,U5=ux({opSnippet:B5,packedOpSnippet:k5,cpuKernelImpl:bU}),V5={kernelName:hd,backendName:"webgl",kernelFunc:U5},G5=ym+`
  return sin(x);
`,W5=`
  vec4 result = sin(x);
  bvec4 isNaN = isnan(x);
  `+lc+`
  return result;
`,z5=ux({opSnippet:G5,packedOpSnippet:W5}),H5={kernelName:cd,backendName:"webgl",kernelFunc:z5};class X5{constructor(e){this.variableNames=["source"],this.outputShape=e,this.rank=e.length;const i=En(this.rank);this.customUniforms=[{name:"start",arrayIndex:this.rank,type:"int"}];const s=Y5(this.rank);let n;const a=e.map((p,_)=>"sourceLoc."+Cm[_]+" = start["+_+"] + coords."+Cm[_]+";");n=`
        `+i+` sourceLoc;
        `+i+` coords = getOutputCoords();
        `+a.join(`
`)+`
      `,this.userCode=`
      void main() {
        `+n+`
        setOutput(getSource(`+s+`));
      }
    `}}const Cm=["x","y","z","w","u","v"];function Y5(l){if(l===1)return"sourceLoc";if(l<=6)return Cm.slice(0,l).map(e=>"sourceLoc."+e).join(",");throw Error("Slicing for rank "+l+" is not yet supported")}class K5{constructor(e){this.variableNames=["source"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e,this.rank=e.length,this.customUniforms=[{name:"start",arrayIndex:this.rank,type:"int"}];const i=En(this.rank),s=lx("coords",this.rank),n=lx("sourceLoc",this.rank),a=this.rank===1?"sourceLoc":"vec2("+n.slice(-2).join()+")",p="getChannel(getSource("+n.join()+"), "+a+")",_=`
      result.x = `+p+`;
      if (++`+s[this.rank-1]+" < "+e[this.rank-1]+`) {
        ++`+n[this.rank-1]+`;
        result.y = `+p+`;
        --`+n[this.rank-1]+`;
      }
    `,g=this.rank===1?"":`
      --`+s[this.rank-1]+`;
      if (++`+s[this.rank-2]+" < "+e[this.rank-2]+`) {
        ++`+n[this.rank-2]+`;
        result.z = `+p+`;
        if (++`+s[this.rank-1]+" < "+e[this.rank-1]+`) {
          ++`+n[this.rank-1]+`;
          result.w = `+p+`;
        }
      }
    `,y=this.rank<=4?`sourceLoc = coords +
            `+i+"("+e.map((b,v)=>"start["+v+"]").join()+");":e.map((b,v)=>n[v]+" = "+s[v]+" + start["+v+"];").join(`
`);this.userCode=`
      void main() {
        `+i+` coords = getOutputCoords();
        `+i+` sourceLoc;
        `+y+`
        vec4 result = vec4(0.);
        `+_+`
        `+g+`
        setOutput(result);
      }
    `}}function j5(l,e,i,s){const n=s.texData.get(l.dataId),a=s.makeTensorInfo(i,l.dtype),p=s.texData.get(a.dataId);Object.assign(p,n),p.refCount=1,p.shape=i,p.dtype=l.dtype;let _=cp(e,Ni(l.shape));n.slice&&(_+=n.slice.flatOffset),p.slice={flatOffset:_,origDataId:n.slice&&n.slice.origDataId||l.dataId};const g=s.dataRefCount.get(p.slice.origDataId)||1;return s.dataRefCount.set(p.slice.origDataId,g+1),a}function AT(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{begin:a,size:p}=s,[_,g]=hp(n,a,p);if(op(n,_,g),Je(g)===0)return i.makeTensorInfo(g,n.dtype,[]);if(i.shouldExecuteOnCPU([n])||n.dtype==="string"){const v=i.texData.get(n.dataId),S=vU(v.values,_,g,n.shape,n.dtype);return i.makeTensorInfo(g,n.dtype,S)}const{isPacked:y}=i.texData.get(n.dataId),b=lp(n.shape,_,g);if(y||!b){const v=Ue().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new K5(g):new X5(g),S=[_];return i.runWebGLProgram(v,[n],n.dtype,S)}return i.uploadToGPU(n.dataId),j5(n,_,g,i)}const q5={kernelName:Sf,backendName:"webgl",kernelFunc:AT},CT="return sqrt(x);",Z5=ux({opSnippet:CT,packedOpSnippet:CT,cpuKernelImpl:TU}),Q5={kernelName:ud,backendName:"webgl",kernelFunc:Z5},$5="return x * x;",J5=ux({opSnippet:$5}),eG={kernelName:Yg,backendName:"webgl",kernelFunc:J5};class tG{constructor(e,i,s){this.variableNames=["x"],this.outputShape=s;const n=s.length,a=En(s.length),p=En(s.length);let _="";if(n===1)_="coords * strides + begin";else{let g=0;_=s.map((y,b)=>(g++,s.length===1?"coords * strides["+b+"] + begin["+b+"]":"coords["+(g-1)+"] * strides["+b+"] + begin["+b+"]")).join(",")}this.userCode=`
      `+a+" begin = "+a+"("+e+`);
      `+a+" strides = "+a+"("+i+`);

      void main() {
        `+p+` coords = getOutputCoords();
        setOutput(getX(`+_+`));
      }
    `}}function iG(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{begin:a,end:p,strides:_,beginMask:g,endMask:y,ellipsisMask:b,newAxisMask:v,shrinkAxisMask:S}=s,{finalShapeSparse:M,finalShape:F,isIdentity:L,sliceDim0:N,isSimpleSlice:k,begin:G,end:H,strides:z}=up(n.shape,a,p,_,g,y,b,v,S);let W;if(L)W=Qi({inputs:{x:n},backend:i,attrs:{shape:F}});else if(N||k){Te(n.shape.length>=1,()=>"Input must have rank at least 1, got: "+n.shape.length);const Z=xp(G,H,z),Q=AT({inputs:{x:n},backend:i,attrs:{begin:G,size:Z}});W=Qi({inputs:{x:Q},backend:i,attrs:{shape:F}}),i.disposeIntermediateTensorInfo(Q)}else if(i.shouldExecuteOnCPU([n])){const Z=i.readSync(n.dataId),Q=Jr(n.shape,n.dtype,Z),se=EU(M,Q,z,G);W=i.makeTensorInfo(F,n.dtype,se.values)}else{const Z=new tG(G,z,M);W=i.runWebGLProgram(Z,[n],n.dtype)}const Y=Qi({inputs:{x:W},backend:i,attrs:{shape:F}});return i.disposeIntermediateTensorInfo(W),Y}const rG={kernelName:Pf,backendName:"webgl",kernelFunc:iG},RT="return a - b;",sG=ga({opSnippet:RT,packedOpSnippet:RT,supportsComplex:!0,cpuKernelImpl:AU}),nG={kernelName:dd,backendName:"webgl",kernelFunc:sG};class aG{constructor(e,i){this.variableNames=["A"];const s=new Array(e.length);for(let p=0;p<s.length;p++)s[p]=e[p]*i[p];this.outputShape=s,this.rank=s.length;const n=En(this.rank),a=oG(e);this.userCode=`
      void main() {
        `+n+` resRC = getOutputCoords();
        setOutput(getA(`+a+`));
      }
    `}}function oG(l){const e=l.length;if(e>5)throw Error("Tile for rank "+e+" is not yet supported");if(e===1)return"imod(resRC, "+l[0]+")";const i=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u"],s=[];for(let n=0;n<l.length;n++)s.push("imod("+i[n]+", "+l[n]+")");return s.join()}function xG(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{reps:a}=s;if(n.dtype==="string"||n.shape.length>5){const _=i.readSync(n.dataId),g=n.dtype==="string"?_.map(v=>Gl(v)):_,y=Jr(n.shape,n.dtype,g),b=CU(y,a);return i.makeTensorInfo(b.shape,b.dtype,b.values)}const p=new aG(n.shape,a);return i.runWebGLProgram(p,[n],n.dtype)}const lG={kernelName:fd,backendName:"webgl",kernelFunc:xG};class cG{constructor(e,i,s,n,a,p){this.variableNames=["Image","Transforms"],this.outputShape=p;const _=s==="nearest"?1:2;let g;switch(n){case"constant":g=1;break;case"reflect":g=2;break;case"wrap":g=3;break;case"nearest":g=4;break;default:g=1;break}this.userCode=`
            float mapCoord(float outCoord, float len) {
              float inCoord = outCoord;
              if(`+g+` == 2) {
                if (inCoord < 0.0) {
                  if (len <= 1.0) {
                    inCoord = 0.0;
                  } else {
                    float sz2 = 2.0 * len;
                    if (inCoord < sz2) {
                      inCoord = sz2 * float(int(float(-inCoord / sz2))) +
                      inCoord;
                    }
                    inCoord = inCoord < -len ? inCoord + sz2 : -inCoord - 1.0;
                  }
                } else if (inCoord > len - 1.0) {
                  if (len <= 1.0) {
                    inCoord = 0.0;
                  } else {
                    float sz2 = 2.0 * len;
                    inCoord -= sz2 * float(int(float(inCoord / sz2)));
                    if (inCoord >= len) {
                      inCoord = sz2 - inCoord - 1.0;
                    }
                  }
                }
                return clamp(inCoord, 0.0, len - 1.0);
              } else if (`+g+` == 3) {
                if (inCoord < 0.0) {
                  if (len <= 1.0) {
                    inCoord = 0.0;
                  } else {
                    float sz = len - 1.0;
                    inCoord += len * (float(int(float(-inCoord / sz))) + 1.0);
                  }
                } else if (inCoord > len - 1.0) {
                  if (len <= 1.0) {
                    inCoord = 0.0;
                  } else {
                    float sz = len - 1.0;
                    inCoord -= len * float(int(float(inCoord / sz)));
                  }
                }
                return clamp(inCoord, 0.0, len - 1.0);
              } else if (`+g+` == 4) {
                return clamp(outCoord, 0.0, len - 1.0);
              } else {
                return outCoord;
              }
            }

            float readWithFillValue(int batch, int coordY, int coordX,
              int channel) {
              float outputValue;
              if (0 <= coordY && coordY < `+e+" && 0 <= coordX && coordX < "+i+`) {
                  outputValue = getImage(batch, coordY, coordX, channel);
              } else {
                outputValue = float(`+a+`);
              }
              return outputValue;
            }

            void main() {
              ivec4 coords = getOutputCoords();
              float outputValue;
              int batch = coords[0];
              int x = coords[2];
              int y = coords[1];
              int channel = coords[3];
              float xf = float(x);
              float yf = float(y);
              float a1 = getTransforms(batch, 0);
              float a2 = getTransforms(batch, 1);
              float a3 = getTransforms(batch, 2);
              float b1 = getTransforms(batch, 3);
              float b2 = getTransforms(batch, 4);
              float b3 = getTransforms(batch, 5);
              float c1 = getTransforms(batch, 6);
              float c2 = getTransforms(batch, 7);
              float projection = c1 * xf + c2 * yf + 1.0;
              if (projection == 0.0) {
                outputValue = float(`+a+`);
              } else {
                float inX = (a1 * xf + a2 * yf + a3) / projection;
                float inY = (b1 * xf + b2 * yf + b3) / projection;
                float mapX = mapCoord(inX, float(`+i+`));
                float mapY = mapCoord(inY, float(`+e+`));

                if (`+_+` == 1) {
                  int coordY = int(round(mapY));
                  int coordX = int(round(mapX));
                  outputValue = readWithFillValue(batch, coordY, coordX,
                    channel);
                } else {
                  float yFloor = floor(mapY);
                  float xFloor = floor(mapX);
                  float yCeil = yFloor + 1.0;
                  float xCeil = xFloor + 1.0;
                  float valueYFloor = (xCeil - mapX) *
                  readWithFillValue(batch, int(yFloor), int(xFloor), channel) +
                  (mapX - xFloor) *
                  readWithFillValue(batch, int(yFloor), int(xCeil), channel);
                  float valueYCeil = (xCeil - mapX) *
                  readWithFillValue(batch, int(yCeil), int(xFloor), channel) +
                  (mapX - xFloor) *
                  readWithFillValue(batch, int(yCeil), int(xCeil), channel);
                  outputValue = (yCeil - mapY) * valueYFloor +
                  (mapY - yFloor) * valueYCeil;
                }
              }
              setOutput(outputValue);
            }
        `}}function hG(l){const{inputs:e,backend:i,attrs:s}=l,{image:n,transforms:a}=e,{interpolation:p,fillMode:_,fillValue:g,outputShape:y}=s,[b,v,S,M]=n.shape,[F,L]=y??[v,S],N=[b,F,L,M],k=new cG(v,S,p,_,g,N);return i.runWebGLProgram(k,[n,a],"float32")}const uG={kernelName:Of,backendName:"webgl",kernelFunc:hG};function Rm(l){const{inputs:e,backend:i}=l,{x:s}=e;if(s.dtype==="complex64"){const n=bm({inputs:{input:s},backend:i}),a=Rm({inputs:{x:n},backend:i}),p=pT({inputs:{input:s},backend:i}),_=Rm({inputs:{x:p},backend:i}),g=Mh({inputs:{real:a,imag:_},backend:i});return i.disposeIntermediateTensorInfo(n),i.disposeIntermediateTensorInfo(a),i.disposeIntermediateTensorInfo(p),i.disposeIntermediateTensorInfo(_),g}else return Em({attrs:{shape:s.shape,dtype:s.dtype,value:s.dtype==="string"?"":0},backend:i})}const dG={kernelName:wf,backendName:"webgl",kernelFunc:Rm};function fG(l){const{inputs:e,backend:i,attrs:s}=l,{a:n,b:a,bias:p,preluActivationWeights:_}=e,{transposeA:g,transposeB:y,activation:b,leakyreluAlpha:v}=s;return r2({a:n,b:a,transposeA:g,transposeB:y,backend:i,bias:p,preluActivationWeights:_,leakyreluAlpha:v,activation:b})}const pG={kernelName:pd,backendName:"webgl",kernelFunc:fG},mG=bb;class a2 extends ni{nextDataId(){return a2.nextDataId++}constructor(){super(),this.blockSize=48,this.firstUse=!0,this.data=new _t(this,Va())}write(e,i,s){this.firstUse&&(this.firstUse=!1,Ue().get("IS_NODE")&&l0(`
============================
Hi, looks like you are running TensorFlow.js in Node.js. To speed things up dramatically, install our node backend, visit https://github.com/tensorflow/tfjs-node for more details. 
============================`));const n={id:this.nextDataId()};return this.data.set(n,{values:e,dtype:s,refCount:1}),n}makeTensorInfo(e,i,s){let n;if(i==="string"&&s!=null&&s.length>0&&yr(s[0])){const a=s.map(p=>$0(p));n=this.write(a,e,i)}else n=this.write(s,e,i);return{dataId:n,shape:e,dtype:i}}refCount(e){return this.data.has(e)?this.data.get(e).refCount:0}incRef(e){const i=this.data.get(e);i.refCount++}decRef(e){if(this.data.has(e)){const i=this.data.get(e);i.refCount--}}move(e,i,s,n,a){this.data.set(e,{values:i,dtype:n,refCount:a})}numDataIds(){return this.data.numDataIds()}async read(e){return this.readSync(e)}readSync(e){const{dtype:i,complexTensorInfos:s}=this.data.get(e);if(i==="complex64"){const n=this.readSync(s.real.dataId),a=this.readSync(s.imag.dataId);return ec(n,a)}return La(this.data.get(e).values,i)}bufferSync(e){const i=this.readSync(e.dataId);if(e.dtype==="string")try{const s=i.map(n=>Gl(n));return Jr(e.shape,e.dtype,s)}catch{throw new Error("Failed to decode encoded string bytes into utf-8")}return Jr(e.shape,e.dtype,i)}makeOutput(e,i,s){return Va().makeTensorFromTensorInfo(this.makeTensorInfo(i,s,e),this)}disposeData(e,i=!1){if(this.data.has(e)){if(this.data.get(e).refCount--,!i&&this.data.get(e).refCount>0)return!1;const{complexTensorInfos:s}=this.data.get(e);s!=null&&(this.disposeData(s.real.dataId,!0),this.disposeData(s.imag.dataId,!0)),this.data.delete(e)}return!0}disposeIntermediateTensorInfo(e){this.disposeData(e.dataId)}async time(e){const i=pa();return e(),{kernelMs:pa()-i}}memory(){return{unreliable:!0,reasons:["The reported memory is an upper bound. Due to automatic garbage collection, the true allocated memory may be less."]}}where(e){es([e],"where");const i=this.readSync(e.dataId);return mG(e.shape,i)}dispose(){}floatPrecision(){return 32}epsilon(){return super.epsilon()}}a2.nextDataId=0,Yy("cpu",()=>new a2,1);function _G(l){const{inputs:e,backend:i}=l,s=e;es(e,"addN");const n=s.map(_=>i.data.get(_.dataId).values),a=Jr(s[0].shape,s[0].dtype),p=a.values;for(let _=0;_<s.length;_++){const g=n[_];for(let y=0;y<p.length;y++)p[y]+=g[y]}return i.makeTensorInfo(a.shape,a.dtype,a.values)}const gG={kernelName:Xu,backendName:"cpu",kernelFunc:_G},yG=vs((l,e)=>Math.atan2(l,e)),bG=_a(Yu,yG),vG={kernelName:Yu,backendName:"cpu",kernelFunc:bG};function IT(l,e,i,s,n,a){const p=n.strideHeight,_=n.strideWidth,g=n.dilationHeight,y=n.dilationWidth,b=n.effectiveFilterHeight,v=n.effectiveFilterWidth,S=n.padInfo.top,M=n.padInfo.left,F=a==="max"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,L=Jr(n.outShape,i),N=L.values,k=n.outShape[1]*n.outShape[2]*n.outShape[3],G=n.outShape[2]*n.outShape[3],H=n.outShape[3];for(let z=0;z<n.batchSize;++z){const W=z*k,Y=z*s[0];for(let Z=0;Z<n.inChannels;++Z)for(let Q=0;Q<n.outHeight;++Q){const se=Q*p-S,$=Math.max(0,se),oe=Math.min(n.inHeight,b+se),ue=W+Q*G;for(let de=0;de<n.outWidth;++de){const ye=de*_-M,_e=Math.max(0,ye),we=Math.min(n.inWidth,v+ye);let Pe=F,Ee=0,We=0;for(let ke=$;ke<oe;ke+=g){const $e=Y+ke*s[1];for(let pt=_e;pt<we;pt+=y){const Xe=$e+pt*s[2],Tt=l[Xe+Z];a==="max"&&Tt>Pe?Pe=Tt:a==="avg"&&(Ee+=Tt,We++)}if(isNaN(Pe))break}const et=ue+de*H+Z;N[et]=a==="avg"?Ee/We:Pe}}}return L}function TG(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e;es(n,"avgPool");const{filterSize:a,strides:p,pad:_,dimRoundingMode:g}=s,y=1;Te(ta(p,y),()=>"Error in avgPool: Either strides or dilations must be 1. Got strides "+p+" and dilations '"+y+"'");const b=jl(n.shape,a,p,y,_,g);let v;if(b.filterWidth===1&&b.filterHeight===1&&qt(b.inShape,b.outShape))v=ox({inputs:{x:n},backend:i});else{const S=i.data.get(n.dataId).values,M=Ni(n.shape),F=IT(S,n.shape,n.dtype,M,b,"avg");v=i.makeTensorInfo(b.outShape,n.dtype,F.values)}return v}const EG={kernelName:of,backendName:"cpu",kernelFunc:TG};function ya(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{shape:a}=s,p=Je(n.shape),_=Xi(a,p),g=Je(_);Te(p===g,()=>"The new shape ("+_+") has "+g+" elements and the old shape ("+n.shape+") has "+p+" elements. The new shape and old shape must have the same number of elements."),i.incRef(n.dataId);const y=i.data.get(n.dataId);if(y.complexTensorInfos!=null){const b=y.complexTensorInfos.real,v=y.complexTensorInfos.imag;b.shape=_,v.shape=_}return{dataId:n.dataId,shape:_,dtype:n.dtype}}const AG={kernelName:Rf,backendName:"cpu",kernelFunc:ya};function ST(l){const{inputs:e,backend:i,attrs:s}=l,{a:n,b:a}=e,{transposeA:p,transposeB:_}=s;es([n,a],"matMul");const g=n.shape.length,y=a.shape.length,b=p?n.shape[g-2]:n.shape[g-1],v=_?a.shape[y-1]:a.shape[y-2],S=p?n.shape[g-1]:n.shape[g-2],M=_?a.shape[y-2]:a.shape[y-1],F=n.shape.slice(0,-2),L=a.shape.slice(0,-2),N=Je(F),k=Je(L),G=is(n.shape.slice(0,-2),a.shape.slice(0,-2)).concat([S,M]);Te(b===v,()=>"Error in matMul: inner shapes ("+b+") and ("+v+") of Tensors with shapes "+n.shape+" and "+a.shape+" and transposeA="+p+" and transposeB="+_+" must match.");const H=p?[N,b,S]:[N,S,b],z=_?[k,M,v]:[k,v,M],W=ya({inputs:{x:n},backend:i,attrs:{shape:H}}),Y=ya({inputs:{x:a},backend:i,attrs:{shape:z}}),Z=p?W.shape[1]:W.shape[2],Q=p?W.shape[2]:W.shape[1],se=_?Y.shape[1]:Y.shape[2],$=Math.max(N,k),oe=i.data.get(W.dataId).values,ue=i.data.get(Y.dataId).values,de=Ni(W.shape),ye=Ni(Y.shape),[_e,we,Pe]=p?[de[0],1,de[1]]:[de[0],de[1],1],[Ee,We,et]=_?[1,ye[1],ye[0]]:[ye[1],1,ye[0]],ke=Q*se,$e=Jr([$,Q,se],W.dtype),pt=$e.values,Xe=i.blockSize;for(let Tt=0;Tt<$;Tt++){const fi=Tt%N,li=Tt%k;for(let Ot=0;Ot<Q;Ot+=Xe){const Gt=Math.min(Ot+Xe,Q);for(let bi=0;bi<se;bi+=Xe){const si=Math.min(bi+Xe,se);for(let oi=0;oi<Z;oi+=Xe){const ci=Math.min(oi+Xe,Z);for(let Li=Ot;Li<Gt;Li++)for(let hi=bi;hi<si;hi++){let mi=0;for(let cr=oi;cr<ci;cr++){const Ui=oe[fi*_e+Li*we+cr*Pe],Ii=ue[cr*Ee+hi*We+li*et];mi+=Ui*Ii}pt[Tt*ke+(Li*se+hi)]+=mi}}}}}return i.disposeIntermediateTensorInfo(W),i.disposeIntermediateTensorInfo(Y),i.makeTensorInfo(G,$e.dtype,$e.values)}const CG={kernelName:xf,backendName:"cpu",kernelFunc:ST},RG=xx(ju,(l,e)=>{const i=e;return l>i.clipValueMax?i.clipValueMax:l<i.clipValueMin?i.clipValueMin:l}),IG={kernelName:ju,backendName:"cpu",kernelFunc:RG};function MT(l){const{inputs:e,backend:i}=l,{input:s}=e,n=i.data.get(s.dataId).complexTensorInfos.imag,a=i.data.get(n.dataId).values;return i.makeTensorInfo(n.shape,n.dtype,a)}function o2(l){const{inputs:e,backend:i,attrs:s}=l,{axis:n}=s,a=jt(n,e[0].shape)[0],p=e.map(L=>L.shape);Op(p,a);let _=Bo(e.map(L=>L.shape),a);if(Je(_)===0)return i.makeTensorInfo(_,e[0].dtype,[]);const g=e.filter(L=>Je(L.shape)>0);if(g.length===1)return ox({inputs:{x:g[0]},backend:i});if(g[0].dtype==="complex64"){const L=g.map(z=>cm({inputs:{input:z},backend:i})),N=g.map(z=>MT({inputs:{input:z},backend:i})),k=o2({inputs:L,backend:i,attrs:{axis:a}}),G=o2({inputs:N,backend:i,attrs:{axis:a}}),H=Ch({inputs:{real:k,imag:G},backend:i});return L.forEach(z=>i.disposeIntermediateTensorInfo(z)),N.forEach(z=>i.disposeIntermediateTensorInfo(z)),i.disposeIntermediateTensorInfo(k),i.disposeIntermediateTensorInfo(G),H}const y=g.map(L=>{const N=[-1,Je(L.shape.slice(a))];return ya({inputs:{x:L},backend:i,attrs:{shape:N}})}),b=y.map(L=>({vals:i.data.get(L.dataId).values,shape:L.shape}));_=Bo(y.map(L=>L.shape),1);const v=y[0].shape[0]===1,S=Iv(b,_,e[0].dtype,v),M=Bo(g.map(L=>L.shape),a),F=i.makeTensorInfo(M,e[0].dtype,S);return y.forEach(L=>i.disposeIntermediateTensorInfo(L)),F}const SG={kernelName:lf,backendName:"cpu",kernelFunc:o2};function PT(l){const{inputs:e,backend:i,attrs:s}=l,{x:n,filter:a}=e,{strides:p,pad:_,dataFormat:g,dilations:y,dimRoundingMode:b}=s;es([n,a],"conv2d");const v=dh(g),S=mo(n.shape,a.shape,p,y,_,b,!1,v),M=S.filterHeight,F=S.filterWidth,L=S.dilationHeight,N=S.dilationWidth,k=S.padInfo.left,G=S.padInfo.top,H=S.dataFormat==="channelsLast",z=new Wl(S.outShape,n.dtype),W=Ni(n.shape),Y=Ni(a.shape),Z=W[0],Q=H?W[1]:W[2],se=H?W[2]:1,$=H?1:W[1],oe=z.strides[0],ue=H?z.strides[1]:z.strides[2],de=H?z.strides[2]:1,ye=H?1:z.strides[1],_e=i.data.get(n.dataId).values,we=i.data.get(a.dataId).values,Pe=z.values;for(let Ee=0;Ee<S.batchSize;++Ee){const We=Ee*Z,et=Ee*oe;for(let ke=0;ke<S.outHeight;++ke){const $e=et+ke*ue,pt=ke*S.strideHeight-G;for(let Xe=0;Xe<M;++Xe){const Tt=pt+Xe*L;if(Tt<0||Tt>=S.inHeight)continue;const fi=Xe*Y[0],li=We+Tt*Q;for(let Ot=0;Ot<S.outWidth;++Ot){const Gt=$e+Ot*de,bi=Ot*S.strideWidth-k;for(let si=0;si<F;++si){const oi=bi+si*N;if(oi<0||oi>=S.inWidth)continue;const ci=fi+si*Y[1],Li=li+oi*se;let hi=ci;for(let mi=0;mi<S.inChannels;++mi){const cr=_e[Li+mi*$];for(let Ui=0;Ui<S.outChannels;++Ui)Pe[Gt+Ui*ye]+=cr*we[hi+Ui];hi+=S.outChannels}}}}}}return i.makeTensorInfo(z.shape,z.dtype,Pe)}const MG={kernelName:cf,backendName:"cpu",kernelFunc:PT},PG=xx(qu,l=>Math.cos(l)),OG={kernelName:qu,backendName:"cpu",kernelFunc:PG};function wG(l){const{inputs:e,backend:i,attrs:s}=l,{image:n,boxes:a,boxInd:p}=e,{cropSize:_,method:g,extrapolationValue:y}=s,[b,v,S,M]=n.shape,F=a.shape[0],[L,N]=_,k=Jr([F,L,N,M],"float32"),G=i.data.get(a.dataId).values,H=i.data.get(p.dataId).values,z=i.data.get(n.dataId).values,W=Ni(n.shape),Y=Ni(k.shape);for(let Z=0;Z<F;Z++){const Q=Z*4,se=G[Q],$=G[Q+1],oe=G[Q+2],ue=G[Q+3],de=H[Z];if(de>=b)continue;const ye=L>1?(oe-se)*(v-1)/(L-1):0,_e=N>1?(ue-$)*(S-1)/(N-1):0;for(let we=0;we<L;we++){const Pe=L>1?se*(v-1)+we*ye:.5*(se+oe)*(v-1);if(Pe<0||Pe>v-1){for(let Ee=0;Ee<N;Ee++)for(let We=0;We<M;We++){const et=We+Ee*Y[2]+we*Y[1]+Z*Y[0];k.values[et]=y}continue}if(g==="bilinear"){const Ee=Math.floor(Pe),We=Math.ceil(Pe),et=Pe-Ee;for(let ke=0;ke<N;ke++){const $e=N>1?$*(S-1)+ke*_e:.5*($+ue)*(S-1);if($e<0||$e>S-1){for(let fi=0;fi<M;fi++){const li=fi+ke*Y[2]+we*Y[1]+Z*Y[0];k.values[li]=y}continue}const pt=Math.floor($e),Xe=Math.ceil($e),Tt=$e-pt;for(let fi=0;fi<M;fi++){let li=fi+pt*W[2]+Ee*W[1]+de*W[0];const Ot=z[li];li=fi+Xe*W[2]+Ee*W[1]+de*W[0];const Gt=z[li];li=fi+pt*W[2]+We*W[1]+de*W[0];const bi=z[li];li=fi+Xe*W[2]+We*W[1]+de*W[0];const si=z[li],oi=Ot+(Gt-Ot)*Tt,ci=bi+(si-bi)*Tt;li=fi+ke*Y[2]+we*Y[1]+Z*Y[0],k.values[li]=oi+(ci-oi)*et}}}else for(let Ee=0;Ee<N;++Ee){const We=N>1?$*(S-1)+Ee*_e:.5*($+ue)*(S-1);if(We<0||We>S-1){for(let $e=0;$e<M;$e++){const pt=$e+Ee*Y[2]+we*Y[1]+Z*Y[0];k.values[pt]=y}continue}const et=Math.round(We),ke=Math.round(Pe);for(let $e=0;$e<M;$e++){const pt=$e+et*W[2]+ke*W[1]+de*W[0],Xe=$e+Ee*Y[2]+we*Y[1]+Z*Y[0];k.values[Xe]=z[pt]}}}}return i.makeTensorInfo(k.shape,k.dtype,k.values)}const DG={kernelName:hf,backendName:"cpu",kernelFunc:wG};function FG(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{blockSize:a,dataFormat:p}=s;Te(p==="NHWC",()=>"Only NHWC dataFormat supported on CPU for depthToSpace. Got "+p);const _=n.shape[0],g=n.shape[1],y=n.shape[2],b=n.shape[3],v=g*a,S=y*a,M=b/(a*a),F=i.data.get(n.dataId).values,L=new Float32Array(_*v*S*M);let N=0;for(let k=0;k<_;++k)for(let G=0;G<v;++G){const H=Math.floor(G/a),z=G%a;for(let W=0;W<S;++W){const Y=Math.floor(W/a),Z=W%a,Q=(z*a+Z)*M;for(let se=0;se<M;++se){const $=se+Q+b*(Y+y*(H+g*k));L[N++]=F[$]}}}return i.makeTensorInfo([_,v,S,M],n.dtype,L)}const LG={kernelName:uf,backendName:"cpu",kernelFunc:FG};function OT(l){const{inputs:e,backend:i,attrs:s}=l,{x:n,filter:a}=e,{strides:p,pad:_,dilations:g,dimRoundingMode:y}=s;es([n,a],"depthwiseConv2DNative");const b=Ni(n.shape),v=Ni(a.shape);let S=g;S==null&&(S=[1,1]),Te(ta(p,S),()=>"Error in depthwiseConv2d: Either strides or dilations must be 1. Got strides "+p+" and dilations '"+S+"'");const M=mo(n.shape,a.shape,p,S,_,y,!0),{filterHeight:F,filterWidth:L,dilationHeight:N,dilationWidth:k,padInfo:G}=M,H=G.left,z=G.top,W=M.outChannels/M.inChannels,Y=new Wl(M.outShape,n.dtype),Z=i.data.get(n.dataId).values,Q=i.data.get(a.dataId).values,se=Y.values;for(let $=0;$<M.batchSize;++$){const oe=$*b[0],ue=$*Y.strides[0];for(let de=0;de<M.outHeight;++de){const ye=ue+de*Y.strides[1],_e=de*M.strideHeight-z;for(let we=0;we<F;++we){const Pe=_e+we*N;if(Pe<0||Pe>=M.inHeight)continue;const Ee=we*v[0],We=oe+Pe*b[1];for(let et=0;et<M.outWidth;++et){const ke=ye+et*Y.strides[2],$e=et*M.strideWidth-H;for(let pt=0;pt<L;++pt){const Xe=$e+pt*k;if(Xe<0||Xe>=M.inWidth)continue;const Tt=Ee+pt*v[1],fi=We+Xe*M.inChannels;let li=ke,Ot=Tt;for(let Gt=0;Gt<M.inChannels;++Gt){const bi=Z[fi+Gt];for(let si=0;si<W;++si)se[li+si]+=bi*Q[Ot+si];li+=W,Ot+=W}}}}}}return i.makeTensorInfo(Y.shape,Y.dtype,Y.values)}const NG={kernelName:df,backendName:"cpu",kernelFunc:OT};function Im(l){const{inputs:e,backend:i,attrs:s}=l,{input:n}=e,{dim:a}=s,p=n.shape.length,_=n.shape.slice();let g=a;return a<0&&(Te(-(p+1)<=a,()=>"Axis must be in the interval ["+-(p+1)+", "+p+"]"),g=p+a+1),_.splice(g,0,1),ya({inputs:{x:n},backend:i,attrs:{shape:_}})}const BG={kernelName:ff,backendName:"cpu",kernelFunc:Im};function wT(l){const{backend:e,attrs:i}=l,{shape:s,value:n,dtype:a}=i,p=a||ar(n),_=bt(p,Je(s));return UG(_,n,p),e.makeTensorInfo(s,p,_)}const kG={kernelName:pf,backendName:"cpu",kernelFunc:wT};function UG(l,e,i){l.fill(e)}const VG=xx(Xg,l=>l>=0?l:Math.exp(l)-1);function GG(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{alpha:a}=s;es([n],"leakyRelu");const p=Je(n.shape),_=i.data.get(n.dataId).values,g=ut("float32",p);for(let y=0;y<_.length;y++)g[y]=_[y]<0?a*_[y]:_[y];return i.makeTensorInfo(n.shape,"float32",g)}const WG=vs((l,e)=>l<0?e*l:l);function DT(l){const{inputs:e,backend:i}=l,{x:s,alpha:n}=e;es([s,n],"prelu");const a=i.data.get(s.dataId).values,p=i.data.get(n.dataId).values,[_,g]=WG(s.shape,n.shape,a,p,"float32");return i.makeTensorInfo(g,"float32",_)}const zG={kernelName:Af,backendName:"cpu",kernelFunc:DT},FT=xx(xd,l=>Math.max(0,l)),HG={kernelName:xd,backendName:"cpu",kernelFunc:FT},LT=xx(ld,l=>Math.min(Math.max(0,l),6)),XG={kernelName:ld,backendName:"cpu",kernelFunc:LT};function x2(l,e,i,s,n){if(i==="linear")return ox({inputs:{x:e},backend:l});if(i==="relu")return FT({inputs:{x:e},backend:l});if(i==="elu")return VG({inputs:{x:e},backend:l});if(i==="relu6")return LT({inputs:{x:e},backend:l});if(i==="prelu")return DT({inputs:{x:e,alpha:s},backend:l});if(i==="leakyrelu")return GG({inputs:{x:e},backend:l,attrs:{alpha:n}});if(i==="sigmoid")return Wv({inputs:{x:e},backend:l});throw new Error("Activation "+i+" has not been implemented for the CPU backend.")}function YG(l){const{inputs:e,backend:i,attrs:s}=l,{x:n,filter:a,bias:p,preluActivationWeights:_}=e,{strides:g,pad:y,dataFormat:b,dilations:v,dimRoundingMode:S,activation:M,leakyreluAlpha:F}=s;let L=PT({inputs:{x:n,filter:a},backend:i,attrs:{strides:g,pad:y,dataFormat:b,dilations:v,dimRoundingMode:S}});if(p){const N=L;if(b==="NCHW"&&p.shape.length===1&&p.shape[0]!==1){const k=ya({inputs:{x:p},backend:i,attrs:{shape:[p.shape[0],1,1]}});L=Rh({inputs:{a:L,b:k},backend:i}),i.disposeIntermediateTensorInfo(k)}else L=Rh({inputs:{a:L,b:p},backend:i});i.disposeIntermediateTensorInfo(N)}if(M){const N=L;if(b==="NCHW"&&M==="prelu"&&_.shape.length===1&&_.shape[0]!==1){const k=ya({inputs:{x:_},backend:i,attrs:{shape:[_.shape[0],1,1]}});L=x2(i,L,M,k,F),i.disposeIntermediateTensorInfo(k)}else L=x2(i,L,M,_,F);i.disposeIntermediateTensorInfo(N)}return L}const KG={kernelName:md,backendName:"cpu",kernelFunc:YG};function jG(l){const{inputs:e,backend:i,attrs:s}=l,{x:n,filter:a,bias:p,preluActivationWeights:_}=e,{strides:g,pad:y,dataFormat:b,dilations:v,dimRoundingMode:S,activation:M,leakyreluAlpha:F}=s;let L=OT({inputs:{x:n,filter:a},backend:i,attrs:{strides:g,pad:y,dataFormat:b,dilations:v,dimRoundingMode:S}});if(p){const N=L;L=Rh({inputs:{a:L,b:p},backend:i}),i.disposeIntermediateTensorInfo(N)}if(M){const N=L;L=x2(i,L,M,_,F),i.disposeIntermediateTensorInfo(N)}return L}const qG={kernelName:_d,backendName:"cpu",kernelFunc:jG};function ZG(l){const{inputs:e,backend:i,attrs:s}=l,{x:n,indices:a}=e,{axis:p,batchDims:_}=s;es([n,a],"gatherV2");const g=jt(p,n.shape)[0],y=i.data.get(a.dataId).values,b=n.shape[g];for(let z=0;z<y.length;++z){const W=y[z];Te(W<=b-1&&W>=0,()=>"GatherV2: the index value "+W+" is not in [0, "+(b-1)+"]")}let v=_;_==null&&(v=0);const S=Je(a.shape),M=Np(n,a,g,v),F=ya({inputs:{x:n},backend:i,attrs:{shape:[M.batchSize,M.outerSize,M.dimSize,M.sliceSize]}}),L=ya({inputs:{x:a},backend:i,attrs:{shape:[M.batchSize,S/M.batchSize]}}),N=[M.batchSize,M.outerSize,S/M.batchSize,M.sliceSize],k=i.bufferSync(L),G=i.bufferSync(F),H=Mv(G,k,N);return i.disposeIntermediateTensorInfo(F),i.disposeIntermediateTensorInfo(L),i.makeTensorInfo(M.outputShape,H.dtype,H.values)}const QG={kernelName:mf,backendName:"cpu",kernelFunc:ZG},$G=vs((l,e)=>l&&e),JG=_a(id,$G,null,"bool"),e6={kernelName:id,backendName:"cpu",kernelFunc:JG},t6=vs((l,e)=>l||e),i6=_a(rd,t6,null,"bool"),r6={kernelName:rd,backendName:"cpu",kernelFunc:i6};function s6(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{reductionIndices:a,keepDims:p}=s,_=i;let g=n.shape;const y=g.length,b=jt(a,g);let v=b;const S=rx(v,y);let M=_.data.get(n.dataId).values;if(S!=null){const z=new Array(y);for(let W=0;W<z.length;W++)z[W]=g[S[W]];M=dm(M,g,n.dtype,S,z),v=sx(v.length,y),g=z}es(n,"max"),ix("max",v,y);const[F,L]=Fo(g,v),N=Je(L),k=Dv(M,N,F,n.dtype),G=_.write(k,F,n.dtype);let H=F;return p&&(H=f0(F,b)),{dataId:G,shape:H,dtype:n.dtype}}const n6={kernelName:_f,backendName:"cpu",kernelFunc:s6};function a6(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e;es(n,"maxPool");const{filterSize:a,strides:p,pad:_,dimRoundingMode:g}=s,y=1;Te(ta(p,y),()=>"Error in maxPool: Either strides or dilations must be 1. Got strides "+p+" and dilations '"+y+"'");const b=jl(n.shape,a,p,y,_,g);let v;if(b.filterWidth===1&&b.filterHeight===1&&qt(b.inShape,b.outShape))v=ox({inputs:{x:n},backend:i});else{const S=i.data.get(n.dataId).values,M=Ni(n.shape),F=IT(S,n.shape,n.dtype,M,b,"max");v=i.makeTensorInfo(b.outShape,n.dtype,F.values)}return v}const o6={kernelName:gf,backendName:"cpu",kernelFunc:a6},x6=vs((l,e)=>l/e),NT=_a(Zu,x6),l6={kernelName:Zu,backendName:"cpu",kernelFunc:NT};function BT(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{axis:a,keepDims:p}=s;es(n,"sum");let _;n.dtype==="bool"?_=xl({inputs:{x:n},backend:i,attrs:{dtype:"int32"}}):_=ox({inputs:{x:n},backend:i});const g=_.shape.length,y=jt(a,_.shape),b=rx(y,g);let v=y,S=_;b!=null&&(S=fm({inputs:{x:_},backend:i,attrs:{perm:b}}),v=sx(v.length,g)),ix("sum",v,S.shape.length);const[M,F]=Fo(S.shape,v),L=Do(S.dtype,"int32");let N=Zd(i,M,L);const k=Je(F),G=i.data.get(N.dataId).values,H=i.data.get(S.dataId).values;for(let z=0;z<G.length;++z){const W=z*k;let Y=0;for(let Z=0;Z<k;++Z)Y+=H[W+Z];G[z]=Y}if(p){const z=f0(N.shape,y),W=N;N=ya({inputs:{x:N},backend:i,attrs:{shape:z}}),i.disposeIntermediateTensorInfo(W)}return i.disposeIntermediateTensorInfo(_),b!=null&&i.disposeIntermediateTensorInfo(S),N}const c6={kernelName:Mf,backendName:"cpu",kernelFunc:BT};function h6(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{axis:a,keepDims:p}=s,_=jt(a,n.shape),g=Fo(n.shape,_)[1],y=Je(g),b=[],v=i.makeTensorInfo([],"float32",new Float32Array([y]));b.push(v);const S=xl({inputs:{x:n},backend:i,attrs:{dtype:"float32"}});b.push(S);const M=NT({inputs:{a:S,b:v},backend:i});b.push(M);const F=BT({inputs:{x:M},backend:i,attrs:{axis:a,keepDims:p}});return b.forEach(L=>i.disposeIntermediateTensorInfo(L)),F}const u6={kernelName:yf,backendName:"cpu",kernelFunc:h6};function d6(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{axis:a,keepDims:p}=s;es(n,"min");const _=jt(a,n.shape);let g=_;const y=rx(g,n.shape.length);let b=n;y!=null&&(b=fm({inputs:{x:n},backend:i,attrs:{perm:y}}),g=sx(g.length,n.shape.length)),ix("min",g,b.shape.length);const[v,S]=Fo(b.shape,g),M=Je(S),F=ze(Je(v),b.dtype),L=i.data.get(b.dataId).values;for(let k=0;k<F.length;++k){const G=k*M;let H=L[G];for(let z=0;z<M;++z){const W=L[G+z];(Number.isNaN(W)||W<H)&&(H=W)}F[k]=H}y!=null&&i.disposeIntermediateTensorInfo(b);const N=i.makeTensorInfo(v,b.dtype,F);if(p){const k=f0(v,_),G=ya({inputs:{x:N},backend:i,attrs:{shape:k}});return i.disposeIntermediateTensorInfo(N),G}return N}const f6={kernelName:bf,backendName:"cpu",kernelFunc:d6};function p6(l){const{inputs:e,backend:i,attrs:s}=l,{axis:n}=s;if(e.length===1)return Im({inputs:{input:e[0]},backend:i,attrs:{dim:n}});const a=e[0].shape,p=e[0].dtype;e.forEach(b=>{yi(a,b.shape,"All tensors passed to stack must have matching shapes"),Te(p===b.dtype,()=>"All tensors passed to stack must have matching dtypes")});const _=[],g=e.map(b=>{const v=Im({inputs:{input:b},backend:i,attrs:{dim:n}});return _.push(v),v}),y=o2({inputs:g,backend:i,attrs:{axis:n}});return _.forEach(b=>i.disposeIntermediateTensorInfo(b)),y}const m6={kernelName:Tf,backendName:"cpu",kernelFunc:p6};function _6(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{paddings:a,constantValue:p}=s;es(n,"pad");const _=a.map((k,G)=>k[0]+n.shape[G]+k[1]),g=a.map(k=>k[0]),y=i.data.get(n.dataId).values,b=Je(n.shape),v=n.shape.length,S=Ni(n.shape),M=Je(_),F=_.length,L=Ni(_),N=ut(n.dtype,M);p!==0&&N.fill(p);for(let k=0;k<b;k++){const G=Ri(k,v,S).map((z,W)=>z+g[W]),H=vt(G,F,L);N[H]=y[k]}return{dataId:i.write(N,_,n.dtype),shape:_,dtype:n.dtype}}const g6={kernelName:Ef,backendName:"cpu",kernelFunc:_6},y6=vs((l,e)=>Math.pow(l,e)),b6=_a(od,y6),v6={kernelName:od,backendName:"cpu",kernelFunc:b6};function T6(l){const{backend:e,attrs:i}=l,{start:s,stop:n,dtype:a,step:p}=i,_=Gv(s,n,p,a);return e.makeTensorInfo([_.length],a,_)}const E6={kernelName:Cf,backendName:"cpu",kernelFunc:T6};function A6(l){const{inputs:e,backend:i,attrs:s}=l,{images:n}=e,{alignCorners:a,halfPixelCenters:p,size:_}=s;es(n,"resizeBilinear");const g=Ni(n.shape),[y,b]=_,[v,S,M,F]=n.shape,L=i.data.get(n.dataId).values,N=new Float32Array(Je([v,y,b,F])),k=[a&&y>1?S-1:S,a&&b>1?M-1:M],G=[a&&y>1?y-1:y,a&&b>1?b-1:b];let H=0;const z=k[0]/G[0],W=k[1]/G[1];for(let Y=0;Y<v;Y++)for(let Z=0;Z<y;Z++){let Q;p?Q=z*(Z+.5)-.5:Q=z*Z;const se=Math.max(0,Math.floor(Q)),$=Q-se,oe=Math.min(S-1,Math.ceil(Q)),ue=Y*g[0]+se*g[1],de=Y*g[0]+oe*g[1];for(let ye=0;ye<b;ye++){let _e;p?_e=W*(ye+.5)-.5:_e=W*ye;const we=Math.max(0,Math.floor(_e)),Pe=_e-we,Ee=Math.min(M-1,Math.ceil(_e)),We=ue+we*g[2],et=de+we*g[2],ke=ue+Ee*g[2],$e=de+Ee*g[2];for(let pt=0;pt<F;pt++){const Xe=L[We+pt],Tt=L[et+pt],fi=L[ke+pt],li=L[$e+pt],Ot=Xe+(fi-Xe)*Pe,Gt=Tt+(li-Tt)*Pe,bi=Ot+(Gt-Ot)*$;N[H++]=bi}}}return i.makeTensorInfo([v,y,b,F],"float32",N)}const C6={kernelName:If,backendName:"cpu",kernelFunc:A6},R6={kernelName:Ff,backendName:"cpu",kernelFunc:({inputs:l,attrs:e,backend:i})=>{const{image:s}=l,{radians:n,fillValue:a,center:p}=e,_=i,g=ut(s.dtype,Je(s.shape)),[y,b,v,S]=s.shape,[M,F]=Dp(p,b,v),L=255,N=Math.sin(n),k=Math.cos(n),G=_.data.get(s.dataId).values;for(let H=0;H<y;H++){const z=H*v*b*S;for(let W=0;W<b;W++){const Y=W*(v*S);for(let Z=0;Z<v;Z++){const Q=Z*S;for(let se=0;se<S;se++){const $=[y,W,Z,se],oe=$[2],ue=$[1];let de=(oe-M)*k-(ue-F)*N,ye=(oe-M)*N+(ue-F)*k;de=Math.round(de+M),ye=Math.round(ye+F);let _e=a;if(typeof a!="number"&&(se===3?_e=L:_e=a[se]),de>=0&&de<v&&ye>=0&&ye<b){const Pe=ye*(v*S),Ee=de*S,We=z+Pe+Ee+se;_e=G[We]}const we=z+Y+Q+se;g[we]=_e}}}}return{dataId:_.write(g,s.shape,s.dtype),shape:s.shape,dtype:s.dtype}}},I6=xx(cd,l=>Math.sin(l)),S6={kernelName:cd,backendName:"cpu",kernelFunc:I6},M6={kernelName:Yg,backendName:"cpu",kernelFunc:({inputs:l,backend:e})=>{const{x:i}=l,s=e;es(i,"square");const n=s.data.get(i.dataId).values,a=new Float32Array(n.length);for(let p=0;p<n.length;++p){const _=n[p];a[p]=_*_}return{dataId:s.write(a,i.shape,i.dtype),shape:i.shape,dtype:i.dtype}}};function P6(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{begin:a,end:p,strides:_,beginMask:g,endMask:y,ellipsisMask:b,newAxisMask:v,shrinkAxisMask:S}=s;es(n,"stridedSlice");const{finalShapeSparse:M,finalShape:F,isIdentity:L,sliceDim0:N,isSimpleSlice:k,begin:G,end:H,strides:z}=up(n.shape,a,p,_,g,y,b,v,S);let W;if(L)W=ya({inputs:{x:n},backend:i,attrs:{shape:F}});else if(N||k){Te(n.shape.length>=1,()=>"Input must have rank at least 1, got: "+n.shape.length);const Y=xp(G,H,z),Z=Hv({inputs:{x:n},backend:i,attrs:{begin:G,size:Y}});W=ya({inputs:{x:Z},backend:i,attrs:{shape:F}}),i.disposeIntermediateTensorInfo(Z)}else{const Y=i.bufferSync(n),Z=Xv(M,Y,z,G);W=i.makeTensorInfo(F,Z.dtype,Z.values)}return W}const O6={kernelName:Pf,backendName:"cpu",kernelFunc:P6};function w6(l){const{inputs:e,backend:i,attrs:s}=l,{x:n}=e,{reps:a}=s;es(n,"tile");const p=Kv(i.bufferSync(n),a);return i.makeTensorInfo(p.shape,p.dtype,p.values)}const D6={kernelName:fd,backendName:"cpu",kernelFunc:w6};function F6(l){const{inputs:e,attrs:i,backend:s}=l,{image:n,transforms:a}=e,{interpolation:p,fillMode:_,fillValue:g,outputShape:y}=i,[b,v,S,M]=n.shape,[F,L]=y??[v,S],N=[b,F,L,M],k=Ni(n.shape),G=k[0],H=k[1],z=k[2],W=Ni(N),Y=W[0],Z=W[1],Q=W[2],se=ut(n.dtype,Je(N));se.fill(g);const $=s.data.get(n.dataId).values,oe=s.data.get(a.dataId).values;for(let ue=0;ue<b;++ue){const de=a.shape[0]===1?oe:oe.subarray(ue*8,ue*8+8);for(let ye=0;ye<F;++ye)for(let _e=0;_e<L;++_e)for(let we=0;we<M;++we){let Pe;const Ee=de[6]*_e+de[7]*ye+1;if(Ee===0)continue;const We=(de[0]*_e+de[1]*ye+de[2])/Ee,et=(de[3]*_e+de[4]*ye+de[5])/Ee,ke=kT(We,S,_),$e=kT(et,v,_);switch(p){case"nearest":Pe=V6($,v,S,G,H,z,ue,$e,ke,we,g);break;case"bilinear":Pe=G6($,v,S,G,H,z,ue,$e,ke,we,g);break;default:throw new Error("Error in Transform: Expect 'nearest' or 'bilinear', but got "+p)}const pt=ue*Y+ye*Z+_e*Q+we;se[pt]=Pe}return s.makeTensorInfo(N,n.dtype,se)}return{dataId:s.write(se,N,n.dtype),shape:n.shape,dtype:n.dtype}}const L6={kernelName:Of,backendName:"cpu",kernelFunc:F6};function kT(l,e,i){switch(i){case"reflect":return N6(l,e);case"wrap":return B6(l,e);case"nearest":return U6(l,e);case"constant":default:return k6(l)}}function N6(l,e){let i=l;if(i<0)if(e<=1)i=0;else{const s=2*e;i<s&&(i=s*Math.trunc(-i/s)+i),i=i<-e?i+s:-i-1}else if(i>e-1)if(e<=1)i=0;else{const s=2*e;i-=s*Math.trunc(i/s),i>=e&&(i=s-i-1)}return kt(0,i,e-1)}function B6(l,e){let i=l;if(i<0)if(e<=1)i=0;else{const s=e-1;i+=e*(Math.trunc(-i/s)+1)}else if(i>e-1)if(e<=1)i=0;else{const s=e-1;i-=e*Math.trunc(i/s)}return kt(0,i,e-1)}function k6(l,e){return l}function U6(l,e){return kt(0,l,e-1)}function wh(l,e,i,s,n,a,p,_,g,y,b){const v=p*s+_*n+g*a+y;return 0<=_&&_<e&&0<=g&&g<i?l[v]:b}function V6(l,e,i,s,n,a,p,_,g,y,b){const v=Math.round(_),S=Math.round(g);return wh(l,e,i,s,n,a,p,v,S,y,b)}function G6(l,e,i,s,n,a,p,_,g,y,b){const v=Math.floor(_),S=Math.floor(g),M=v+1,F=S+1,L=(F-g)*wh(l,e,i,s,n,a,p,v,S,y,b)+(g-S)*wh(l,e,i,s,n,a,p,v,F,y,b),N=(F-g)*wh(l,e,i,s,n,a,p,M,S,y,b)+(g-S)*wh(l,e,i,s,n,a,p,M,F,y,b);return(M-_)*L+(_-v)*N}function Sm(l){const{inputs:e,backend:i}=l,{x:s}=e;if(s.dtype==="string")throw new Error("zerosLike is not supported for string tensors");if(s.dtype==="complex64"){const n=cm({inputs:{input:s},backend:i}),a=Sm({inputs:{x:n},backend:i}),p=MT({inputs:{input:s},backend:i}),_=Sm({inputs:{x:p},backend:i}),g=Ch({inputs:{real:a,imag:_},backend:i});return i.disposeIntermediateTensorInfo(n),i.disposeIntermediateTensorInfo(a),i.disposeIntermediateTensorInfo(p),i.disposeIntermediateTensorInfo(_),g}else return wT({backend:i,attrs:{shape:s.shape,value:0,dtype:s.dtype}})}const W6={kernelName:wf,backendName:"cpu",kernelFunc:Sm};function z6(l){const{inputs:e,backend:i,attrs:s}=l,{a:n,b:a,bias:p,preluActivationWeights:_}=e,{transposeA:g,transposeB:y,activation:b,leakyreluAlpha:v}=s;let S,M,F;const L=[];S=ST({inputs:{a:n,b:a},attrs:{transposeA:g,transposeB:y},backend:i}),p&&(M=Rh({inputs:{a:S,b:p},backend:i}),L.push(S),S=M),b&&(F=x2(i,S,b,_,v),L.push(S),S=F);for(const N of L)i.disposeIntermediateTensorInfo(N);return S}const H6={kernelName:pd,backendName:"cpu",kernelFunc:z6};ht(JU),ht(a4),ht(l4),ht(d4),ht(p4),ht(S4),ht(D4),ht(B4),ht(G4),ht(H4),ht(j4),ht(Q4),ht(eV),ht(iV),ht(rV),ht(nV),ht(oV),ht(cV),ht(dV),ht(pV),ht(yV),ht(EV),ht(e4),ht(IV),ht(OV),ht(LV),ht(UV),ht(WV),ht(HV),ht(jV),ht(ZV),ht($V),ht(i5),ht(m4),ht(a5),ht(x5),ht(u5),ht(m5),ht(s4),ht(g5),ht(T5),ht(R5),ht(P5),ht(g4),ht(F5),ht(N5),ht(V5),ht(H5),ht(q5),ht(Q5),ht(eG),ht(rG),ht(nG),ht(C4),ht(lG),ht(uG),ht(R4),ht(dG),ht(pG),ht(z3),ht(K3),ht(gG),ht(vG),ht(EG),ht(CG),ht(X3),ht(IG),ht(SG),ht(MG),ht(OG),ht(DG),ht(LG),ht(NG),ht(BG),ht(kG),ht(ik),ht(KG),ht(qG),ht(QG),ht(ok),ht(H3),ht(lk),ht(hk),ht(e6),ht(r6),ht(n6),ht(o6),ht(pk),ht(u6),ht(f6),ht(_k),ht(bk),ht(Tk),ht(m6),ht(g6),ht(v6),ht(zG),ht(E6),ht(l6),ht(HG),ht(XG),ht(AG),ht(C6),ht(R6),ht(kk),ht(S6),ht(Uk),ht(Xk),ht(M6),ht(O6),ht(tU),ht(c6),ht(D6),ht(L6),ht(Ak),ht(W6),ht(H6);var X6=Object.defineProperty,Y6=(l,e,i)=>e in l?X6(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,sa=(l,e,i)=>(Y6(l,typeof e!="symbol"?e+"":e,i),i);class K6{constructor(){sa(this,"bodyDetector"),sa(this,"poseDetector"),sa(this,"poseModule"),sa(this,"poseAligner"),sa(this,"bodyTracks",[]),sa(this,"poseFilters",[]),sa(this,"angle",15/180*Math.PI),sa(this,"ratio",1920/1080),sa(this,"near",1),sa(this,"poseScore",.6),sa(this,"alignScore",.9),sa(this,"alignVisibility",.9),sa(this,"skipCount",2),sa(this,"skipMax",2)}async process(e,i){var s,n;if(this.bodyTracks.length<1&&this.skipCount<this.skipMax)return this.skipCount++,[];this.skipCount=0;const a=zr(()=>{const S=kn(np(e,3),"float32"),M=ia(us(S,255*.5),1);return yh(M,0)}),[p,_]=[a.shape[1],a.shape[2]];if(this.bodyTracks.length===0){const S=await((s=this.bodyDetector)==null?void 0:s.process(a))||[];this.bodyTracks=S.map(M=>({center:M.points[0],top:M.points[1]})),this.bodyTracks.forEach(()=>this.poseFilters.push(new GL))}const g=this.bodyTracks.length>0?await((n=this.poseDetector)==null?void 0:n.process(a,this.bodyTracks))||[]:[];g.forEach((S,M)=>{var F;if((F=this.poseAligner)==null||F.alignPoints(S.keypoints),i===void 0)return;const L=_/p,N=S.top[0]-S.center[0],k=(S.top[1]-S.center[1])/L,G=Math.sqrt(N*N+k*k)*2*(1+L)*.5;g[M]=this.poseFilters[M].filter(S,i,1/G)}),a.dispose();let y=[],b=[],v=[];for(let S=0;S<this.bodyTracks.length;S++){const M={center:[this.bodyTracks[S].center[0]*_,this.bodyTracks[S].center[1]*p],top:[this.bodyTracks[S].top[0]*_,this.bodyTracks[S].top[1]*p]};let F={center:[g[S].center[0]*_,g[S].center[1]*p],top:[g[S].top[0]*_,g[S].top[1]*p]};const L=[M,F].map(N=>{const{center:k,top:G}=N,H=[G[0]-k[0],G[1]-k[1]],z=Math.sqrt(H[0]*H[0]+H[1]*H[1]);return[[k[0]-z,k[1]-z],[k[0]+z,k[1]+z]]});Kb(L[0],L[1])>.5&&g[S].score>this.poseScore&&(y.push({center:[...g[S].center],top:[...g[S].top]}),b.push(this.poseFilters[S]),v.push(g[S]))}return this.bodyTracks=y,this.poseFilters=b,v}setCamera(e,i,s=1){var n;this.angle=e,this.ratio=i,this.near=s,(n=this.poseAligner)==null||n.setCamera(e,i,s)}async init(e,i="./",s=!1,n=!1,a="webgl"){const p=await Vp({locateFile:S=>i+S});p.Loader.prototype.promisify=function(S,...M){return S.call(this,...M),new Promise(F=>{const L=setInterval(()=>{if(this.ready)return clearInterval(L),F(this.status)},5)})},p.Loader.prototype.load=function(S){return this.promisify(this.loadAsync,S,s)},p.Loader.prototype.remove=function(S){return this.promisify(this.removeAsync,S)},p.DictLoader.prototype.loadDict=function(S){return this.promisify(this.loadDictAsync,e,S)};const _=new p.ParseLoader(i);if(s||(await _.remove("pose.wasm"),await _.remove("poseutils.wasm")),!await _.loadDict(["pose.wasm","poseutils.wasm"])||!await _.load("pose.wasm")||!_.parse())return;Ue().set("WEBGL_USE_SHAPES_UNIFORMS",!0),rp(),await sp(a);const g={weightUrlConverter:async S=>S,fetchFunc:async S=>{const M=new Blob([_.file(S)]);return fetch(URL.createObjectURL(M))}},y=await tc("bodymodel.def",g),b=await tc("posemodel.def",g);if(this.bodyDetector=new FL(y),this.poseDetector=new BL(b,n),!await _.load("poseutils.wasm"))return;const v=await zL({wasmBinary:_.data()});_.delete(),v.PoseAligner.prototype.alignPoints=function(S){const M=new v.VectorFloat,F=new v.VectorFloat,L=new v.VectorFloat,N=new v.VectorFloat;S.forEach(G=>{M.push_back(G.pixel[0]),M.push_back(G.pixel[1]),M.push_back(G.pixel[2]),F.push_back(G.metric[0]),F.push_back(G.metric[1]),F.push_back(G.metric[2]),L.push_back(G.score),N.push_back(G.visibility)});const k=this.align(M,F,L,N);S.forEach((G,H)=>{G.metric=[k.get(H*3),k.get(H*3+1),k.get(H*3+2)]}),M.delete(),F.delete(),L.delete(),N.delete(),k.delete()},this.poseModule=v,this.poseAligner=new this.poseModule.PoseAligner,this.poseAligner.setThresh(this.alignScore,this.alignVisibility)}reset(){this.bodyTracks=[],this.poseFilters=[],this.skipCount=this.skipMax}async prepare(){var e,i;Ue().set("ENGINE_COMPILE_ONLY",!0),await((e=this.bodyDetector)==null?void 0:e.prepare()),await((i=this.poseDetector)==null?void 0:i.prepare());const s=Rd();s instanceof ll&&(s.checkCompileCompletion(),s.getUniformLocations()),Ue().set("ENGINE_COMPILE_ONLY",!1)}dispose(){var e,i,s;this.reset(),(e=this.bodyDetector)==null||e.dispose(),(i=this.poseDetector)==null||i.dispose(),(s=this.poseAligner)==null||s.delete()}}var j6=Object.defineProperty,UT=Object.getOwnPropertySymbols,q6=Object.prototype.hasOwnProperty,Z6=Object.prototype.propertyIsEnumerable,Mm=(l,e,i)=>e in l?j6(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,Q6=(l,e)=>{for(var i in e||(e={}))q6.call(e,i)&&Mm(l,i,e[i]);if(UT)for(var i of UT(e))Z6.call(e,i)&&Mm(l,i,e[i]);return l},b0=(l,e,i)=>(Mm(l,typeof e!="symbol"?e+"":e,i),i);class $6{constructor(e){this.model=e,b0(this,"modelSize"),b0(this,"modelRatio"),b0(this,"anchors"),b0(this,"anchorsData"),b0(this,"size"),b0(this,"facesMax",3),b0(this,"iouThresh",.3),b0(this,"scoreThresh",.5),b0(this,"keypointCount",6),this.model=e,this.modelSize=e.inputs[0].shape?{width:e.inputs[0].shape[2],height:e.inputs[0].shape[1]}:{width:128,height:128},this.modelRatio=this.modelSize.width/this.modelSize.height,this.anchorsData=this.buildAnchors(this.modelSize),this.anchors=Mp(this.anchorsData),this.size=qs([this.modelSize.width,this.modelSize.height])}async process(e,i){let s={x:0,y:0};const[n,a,p]=zr(()=>{const L={width:e.shape[2],height:e.shape[1]},N=L.width/L.height;let k=Q6({},L),G={x:0,y:0};N>this.modelRatio?(k.height=L.width/this.modelRatio,G.y=Math.floor((k.height-L.height)*.5),s.y=G.y/k.height):N<this.modelRatio&&(k.width=L.height*this.modelRatio,G.x=Math.floor((k.width-L.width)*.5),s.x=G.x/k.width);const H=wd(e,[[0,0],[G.y,G.y],[G.x,G.x],[0,0]],0),z=No.resizeBilinear(H,[this.modelSize.height,this.modelSize.width]),W=ds(this.model.execute(z,"objects")),Y=Or(W,[0,0],[-1,1]),Z=ds(fh(Y)),Q=this.decodeBoxes(W,this.anchors,this.size);return[W,Q,Z]}),_=await No.nonMaxSuppressionAsync(a,p,this.facesMax,this.iouThresh,this.scoreThresh),g=await _.data();_.dispose();const y=[];for(let L=0;L<g.length;L++){const N=g[L];y.push({box:Or(a,[N,0],[1,-1]),score:Or(p,N,1),anchorI:N,points:i?Or(n,[N,5],[1,-1]):void 0})}const b=await Promise.all(y.map(async L=>{var N,k;const G=await L.box.data(),H=await L.score.data(),z=await((N=L.points)==null?void 0:N.data());return L.box.dispose(),L.score.dispose(),(k=L.points)==null||k.dispose(),{box:G,score:H[0],anchorI:L.anchorI,points:z}})),v={width:1-2*s.x,height:1-2*s.y};s.x/=v.width,s.y/=v.height;const S=this.modelSize.width*v.width,M=this.modelSize.height*v.height,F=[];for(let L=0;L<b.length;L++){const N=b[L].box,k=this.anchorsData[b[L].anchorI],G=b[L].points,H=[];for(let z=0;z<this.keypointCount&&G;z++)H.push({x:(G[z*2+0]+k[0])/S-s.x,y:(G[z*2+1]+k[1])/M-s.y});F.push({rect:{xy:{x:N[0]/S-s.x,y:N[1]/M-s.y},size:{width:(N[2]-N[0])/S,height:(N[3]-N[1])/M}},score:b[L].score,keypoints:G&&H})}return n.dispose(),a.dispose(),p.dispose(),F}decodeBoxes(e,i,s){const n=Or(e,[0,1],[-1,2]),a=Hr(n,i),p=Or(e,[0,3],[-1,2]),_=us(p,2),g=ia(a,_),y=Hr(a,_);return ph([g,y],1)}buildAnchors(e){const i=[8,16],s=[2,6],n=[];for(let a=0;a<i.length;a++){const p=i[a],_=Math.floor((e.height+p-1)/p),g=Math.floor((e.width+p-1)/p),y=s[a];for(let b=0;b<_;b++){const v=p*(b+.5);for(let S=0;S<g;S++){const M=p*(S+.5);for(let F=0;F<y;F++)n.push([M,v])}}}return n}async prepare(){const{width:e,height:i}=this.modelSize,s=Lo([1,i,e,3]),n=this.model.execute(s,"objects");await n.data(),s.dispose(),n.dispose()}dispose(){this.model.dispose(),this.anchors.dispose()}}var Pm=(l=>(l[l.EyeR=0]="EyeR",l[l.EyeL=1]="EyeL",l[l.Nose=2]="Nose",l[l.Mouth=3]="Mouth",l[l.EarR=4]="EarR",l[l.EarL=5]="EarL",l))(Pm||{}),J6=Object.defineProperty,e8=Object.defineProperties,t8=Object.getOwnPropertyDescriptors,VT=Object.getOwnPropertySymbols,i8=Object.prototype.hasOwnProperty,r8=Object.prototype.propertyIsEnumerable,Om=(l,e,i)=>e in l?J6(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,s8=(l,e)=>{for(var i in e||(e={}))i8.call(e,i)&&Om(l,i,e[i]);if(VT)for(var i of VT(e))r8.call(e,i)&&Om(l,i,e[i]);return l},n8=(l,e)=>e8(l,t8(e)),l2=(l,e,i)=>(Om(l,typeof e!="symbol"?e+"":e,i),i);class a8{constructor(e){this.model=e,l2(this,"modelSize"),l2(this,"modelHighP"),l2(this,"boxFactor",1.5),l2(this,"symmetryPoints",[13,168]),this.model=e,this.modelSize=e.inputs[0].shape?{width:e.inputs[0].shape[2],height:e.inputs[0].shape[1]}:{width:192,height:192},this.modelHighP=this.model.outputs.length===7}async process(e,i){const s=i.map(_=>{const{xy:g,size:y}=_.rect,b={width:y.width*this.boxFactor,height:y.height*this.boxFactor},v={x:g.x+y.width/2,y:g.y+y.height/2},S={xy:{x:v.x-b.width/2,y:v.y-b.height/2},size:b};return n8(s8({},_),{rect:S})}),[n,a]=[e.shape[1],e.shape[2]],{modelSize:p}=this;return zr(()=>s.map(_=>{const g=Math.atan2((_.symmetry[1].x-_.symmetry[0].x)*a,(_.symmetry[0].y-_.symmetry[1].y)*n),{xy:y,size:b}=_.rect,v=[y.x+b.width/2,y.y+b.height/2],S=[y.y*n,y.x*a,(y.y+b.height)*n,(y.x+b.width)*a],M=this.rotatedRect(e,S,g,p),F=this.modelHighP?["output_mesh_identity","output_faceflag","output_lips","Identity_1:0","Identity_5:0","Identity_2:0","Identity_6:0"]:["output_mesh","output_faceflag"],[L,N,k,G,H,z,W]=this.model.execute(M,F),Y=L.dataSync(),Z=N.dataSync()[0];let Q=[];for(let Ee=0;Ee<Y.length/3;Ee++)Q.push([Y[Ee*3+0],Y[Ee*3+1],Y[Ee*3+2]]);if(k){const Ee=k.dataSync();wm(Q,Ee,o8)}if(G&&H){const Ee=G.dataSync(),We=H.dataSync();wm(Q,Ee,x8),wm(Q,We,l8)}if(z&&W){const Ee=z.dataSync(),We=W.dataSync(),et=[33,7,163,144,145,153,154,155,133,246,161,160,159,158,157,173].map($e=>Q[$e]),ke=[263,249,390,373,374,380,381,382,362,466,388,387,386,385,384,398].map($e=>Q[$e]);for(let $e=0;$e<Ee.length/2;$e++){const pt=[Ee[$e*2+0],Ee[$e*2+1]];Q.push([pt[0],pt[1],GT(pt,et)])}for(let $e=0;$e<We.length/2;$e++){const pt=[We[$e*2+0],We[$e*2+1]];Q.push([pt[0],pt[1],GT(pt,ke)])}}const se=[b.width*a/p.width,b.height*n/p.height],$=Q.map(Ee=>[(Ee[0]-p.width/2)*se[0],(Ee[1]-p.height/2)*se[1],Ee[2]*se[0]]),oe=Math.sin(g),ue=Math.cos(g),de=$.map(Ee=>[(Ee[0]*ue-Ee[1]*oe)/a+v[0],(Ee[0]*oe+Ee[1]*ue)/n+v[1],Ee[2]/a]),ye=$.map(Ee=>Ee[0]),_e=$.map(Ee=>Ee[1]),we=[Math.min(...ye)/a,Math.min(..._e)/n],Pe=[Math.max(...ye)/a,Math.max(..._e)/n];return{keypoints:de,score:Z,rect:[we[0]+v[0],we[1]+v[1],Pe[0]-we[0],Pe[1]-we[1]]}}))}rotatedRect(e,i,s,n){const[a,p]=[i[2]-i[0],i[3]-i[1]],[_,g]=[(i[2]+i[0])*.5,(i[3]+i[1])*.5],[y,b]=[a/n.height,p/n.width],[v,S]=[Math.cos(s),Math.sin(s)],M=[v*b,-S*y,(-v*p+S*a)*.5+g,S*b,v*y,(-S*p-v*a)*.5+_,0,0];return No.transform(e,[M],"bilinear","constant",0,[n.height,n.width])}async prepare(){const{width:e,height:i}=this.modelSize,s=Lo([1,i,e,3]),n=this.model.execute(s);await Promise.all(n.map(async a=>{await a.data(),a.dispose()})),s.dispose()}dispose(){this.model.dispose()}}function xY(l,e){return l.keypoints.forEach(i=>{i[0]*=e,i[1]*=e,i[2]*=e}),l.rect.forEach(i=>{}),l}function wm(l,e,i){for(let s=0;s<i.length;s++)l[i[s]][0]=e[s*2+0],l[i[s]][1]=e[s*2+1]}function GT(l,e){let i=0,s=Number.MAX_VALUE;for(let n=0;n<e.length;n++){const a=[e[n][0]-l[0],e[n][1]-l[1]],p=a[0]*a[0]+a[1]*a[1];p<s&&(s=p,i=n)}return e[i][2]}const o8=null,x8=null,l8=null;var c8=(()=>{var l=typeof document<"u"&&document.currentScript?document.currentScript.src:void 0;return function(e){e=e||{};var i=typeof e<"u"?e:{},s,n;i.ready=new Promise(function(ne,re){s=ne,n=re});var a=Object.assign({},i),p=!0,_="";function g(ne){return i.locateFile?i.locateFile(ne,_):_+ne}var y;typeof document<"u"&&document.currentScript&&(_=document.currentScript.src),l&&(_=l),_.indexOf("blob:")!==0?_=_.substr(0,_.replace(/[?#].*/,"").lastIndexOf("/")+1):_="",i.print||console.log.bind(console);var b=i.printErr||console.warn.bind(console);Object.assign(i,a),a=null,i.arguments&&i.arguments,i.thisProgram&&i.thisProgram,i.quit&&i.quit;var v;i.wasmBinary&&(v=i.wasmBinary),i.noExitRuntime,typeof WebAssembly!="object"&&mi("no native wasm support detected");var S,M=!1;function F(ne,re){ne||mi(re)}var L=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function N(ne,re,ce){for(var me=re+ce,Se=re;ne[Se]&&!(Se>=me);)++Se;if(Se-re>16&&ne.buffer&&L)return L.decode(ne.subarray(re,Se));for(var Fe="";re<Se;){var Ne=ne[re++];if(!(Ne&128)){Fe+=String.fromCharCode(Ne);continue}var De=ne[re++]&63;if((Ne&224)==192){Fe+=String.fromCharCode((Ne&31)<<6|De);continue}var it=ne[re++]&63;if((Ne&240)==224?Ne=(Ne&15)<<12|De<<6|it:Ne=(Ne&7)<<18|De<<12|it<<6|ne[re++]&63,Ne<65536)Fe+=String.fromCharCode(Ne);else{var mt=Ne-65536;Fe+=String.fromCharCode(55296|mt>>10,56320|mt&1023)}}return Fe}function k(ne,re){return ne?N(ye,ne,re):""}function G(ne,re,ce,me){if(!(me>0))return 0;for(var Se=ce,Fe=ce+me-1,Ne=0;Ne<ne.length;++Ne){var De=ne.charCodeAt(Ne);if(De>=55296&&De<=57343){var it=ne.charCodeAt(++Ne);De=65536+((De&1023)<<10)|it&1023}if(De<=127){if(ce>=Fe)break;re[ce++]=De}else if(De<=2047){if(ce+1>=Fe)break;re[ce++]=192|De>>6,re[ce++]=128|De&63}else if(De<=65535){if(ce+2>=Fe)break;re[ce++]=224|De>>12,re[ce++]=128|De>>6&63,re[ce++]=128|De&63}else{if(ce+3>=Fe)break;re[ce++]=240|De>>18,re[ce++]=128|De>>12&63,re[ce++]=128|De>>6&63,re[ce++]=128|De&63}}return re[ce]=0,ce-Se}function H(ne,re,ce){return G(ne,ye,re,ce)}function z(ne){for(var re=0,ce=0;ce<ne.length;++ce){var me=ne.charCodeAt(ce);me>=55296&&me<=57343&&(me=65536+((me&1023)<<10)|ne.charCodeAt(++ce)&1023),me<=127?++re:me<=2047?re+=2:me<=65535?re+=3:re+=4}return re}var W=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0;function Y(ne,re){for(var ce=ne,me=ce>>1,Se=me+re/2;!(me>=Se)&&we[me];)++me;if(ce=me<<1,ce-ne>32&&W)return W.decode(ye.subarray(ne,ce));for(var Fe="",Ne=0;!(Ne>=re/2);++Ne){var De=_e[ne+Ne*2>>1];if(De==0)break;Fe+=String.fromCharCode(De)}return Fe}function Z(ne,re,ce){if(ce===void 0&&(ce=2147483647),ce<2)return 0;ce-=2;for(var me=re,Se=ce<ne.length*2?ce/2:ne.length,Fe=0;Fe<Se;++Fe){var Ne=ne.charCodeAt(Fe);_e[re>>1]=Ne,re+=2}return _e[re>>1]=0,re-me}function Q(ne){return ne.length*2}function se(ne,re){for(var ce=0,me="";!(ce>=re/4);){var Se=Pe[ne+ce*4>>2];if(Se==0)break;if(++ce,Se>=65536){var Fe=Se-65536;me+=String.fromCharCode(55296|Fe>>10,56320|Fe&1023)}else me+=String.fromCharCode(Se)}return me}function $(ne,re,ce){if(ce===void 0&&(ce=2147483647),ce<4)return 0;for(var me=re,Se=me+ce-4,Fe=0;Fe<ne.length;++Fe){var Ne=ne.charCodeAt(Fe);if(Ne>=55296&&Ne<=57343){var De=ne.charCodeAt(++Fe);Ne=65536+((Ne&1023)<<10)|De&1023}if(Pe[re>>2]=Ne,re+=4,re+4>Se)break}return Pe[re>>2]=0,re-me}function oe(ne){for(var re=0,ce=0;ce<ne.length;++ce){var me=ne.charCodeAt(ce);me>=55296&&me<=57343&&++ce,re+=4}return re}var ue,de,ye,_e,we,Pe,Ee,We,et;function ke(ne){ue=ne,i.HEAP8=de=new Int8Array(ne),i.HEAP16=_e=new Int16Array(ne),i.HEAP32=Pe=new Int32Array(ne),i.HEAPU8=ye=new Uint8Array(ne),i.HEAPU16=we=new Uint16Array(ne),i.HEAPU32=Ee=new Uint32Array(ne),i.HEAPF32=We=new Float32Array(ne),i.HEAPF64=et=new Float64Array(ne)}i.INITIAL_MEMORY;var $e,pt=[],Xe=[],Tt=[];function fi(){if(i.preRun)for(typeof i.preRun=="function"&&(i.preRun=[i.preRun]);i.preRun.length;)Gt(i.preRun.shift());Zn(pt)}function li(){Zn(Xe)}function Ot(){if(i.postRun)for(typeof i.postRun=="function"&&(i.postRun=[i.postRun]);i.postRun.length;)si(i.postRun.shift());Zn(Tt)}function Gt(ne){pt.unshift(ne)}function bi(ne){Xe.unshift(ne)}function si(ne){Tt.unshift(ne)}var oi=0,ci=null;function Li(ne){oi++,i.monitorRunDependencies&&i.monitorRunDependencies(oi)}function hi(ne){if(oi--,i.monitorRunDependencies&&i.monitorRunDependencies(oi),oi==0&&ci){var re=ci;ci=null,re()}}function mi(ne){i.onAbort&&i.onAbort(ne),ne="Aborted("+ne+")",b(ne),M=!0,ne+=". Build with -sASSERTIONS for more info.";var re=new WebAssembly.RuntimeError(ne);throw n(re),re}var cr="data:application/octet-stream;base64,";function Ui(ne){return ne.startsWith(cr)}var Ii;Ii="faceutils.wasm",Ui(Ii)||(Ii=g(Ii));function Cr(ne){try{if(ne==Ii&&v)return new Uint8Array(v);throw"both async and sync fetching of the wasm failed"}catch(re){mi(re)}}function an(){return!v&&p&&typeof fetch=="function"?fetch(Ii,{credentials:"same-origin"}).then(function(ne){if(!ne.ok)throw"failed to load wasm binary file at '"+Ii+"'";return ne.arrayBuffer()}).catch(function(){return Cr(Ii)}):Promise.resolve().then(function(){return Cr(Ii)})}function un(){var ne={a:Jc};function re(Ne,De){var it=Ne.exports;i.asm=it,S=i.asm.B,ke(S.buffer),$e=i.asm.F,bi(i.asm.C),hi()}Li();function ce(Ne){re(Ne.instance)}function me(Ne){return an().then(function(De){return WebAssembly.instantiate(De,ne)}).then(function(De){return De}).then(Ne,function(De){b("failed to asynchronously prepare wasm: "+De),mi(De)})}function Se(){return!v&&typeof WebAssembly.instantiateStreaming=="function"&&!Ui(Ii)&&typeof fetch=="function"?fetch(Ii,{credentials:"same-origin"}).then(function(Ne){var De=WebAssembly.instantiateStreaming(Ne,ne);return De.then(ce,function(it){return b("wasm streaming compile failed: "+it),b("falling back to ArrayBuffer instantiation"),me(ce)})}):me(ce)}if(i.instantiateWasm)try{var Fe=i.instantiateWasm(ne,re);return Fe}catch(Ne){return b("Module.instantiateWasm callback failed with error: "+Ne),!1}return Se().catch(n),{}}function Zn(ne){for(;ne.length>0;){var re=ne.shift();if(typeof re=="function"){re(i);continue}var ce=re.func;typeof ce=="number"?re.arg===void 0?Yr(ce)():Yr(ce)(re.arg):ce(re.arg===void 0?null:re.arg)}}var On=[];function Yr(ne){var re=On[ne];return re||(ne>=On.length&&(On.length=ne+1),On[ne]=re=$e.get(ne)),re}function eo(ne){return n0(ne+24)+24}function $o(ne){this.excPtr=ne,this.ptr=ne-24,this.set_type=function(re){Ee[this.ptr+4>>2]=re},this.get_type=function(){return Ee[this.ptr+4>>2]},this.set_destructor=function(re){Ee[this.ptr+8>>2]=re},this.get_destructor=function(){return Ee[this.ptr+8>>2]},this.set_refcount=function(re){Pe[this.ptr>>2]=re},this.set_caught=function(re){re=re?1:0,de[this.ptr+12>>0]=re},this.get_caught=function(){return de[this.ptr+12>>0]!=0},this.set_rethrown=function(re){re=re?1:0,de[this.ptr+13>>0]=re},this.get_rethrown=function(){return de[this.ptr+13>>0]!=0},this.init=function(re,ce){this.set_adjusted_ptr(0),this.set_type(re),this.set_destructor(ce),this.set_refcount(0),this.set_caught(!1),this.set_rethrown(!1)},this.add_ref=function(){var re=Pe[this.ptr>>2];Pe[this.ptr>>2]=re+1},this.release_ref=function(){var re=Pe[this.ptr>>2];return Pe[this.ptr>>2]=re-1,re===1},this.set_adjusted_ptr=function(re){Ee[this.ptr+16>>2]=re},this.get_adjusted_ptr=function(){return Ee[this.ptr+16>>2]},this.get_exception_ptr=function(){var re=le(this.get_type());if(re)return Ee[this.excPtr>>2];var ce=this.get_adjusted_ptr();return ce!==0?ce:this.excPtr}}function Jo(ne,re,ce){var me=new $o(ne);throw me.init(re,ce),ne}var dn={};function wn(ne){for(;ne.length;){var re=ne.pop(),ce=ne.pop();ce(re)}}function Wr(ne){return this.fromWireType(Ee[ne>>2])}var fn={},zs={},Qn={},k0=48,U0=57;function to(ne){if(ne===void 0)return"_unknown";ne=ne.replace(/[^a-zA-Z0-9_]/g,"$");var re=ne.charCodeAt(0);return re>=k0&&re<=U0?"_"+ne:ne}function V0(ne,re){return ne=to(ne),function(){return re.apply(this,arguments)}}function io(ne,re){var ce=V0(re,function(me){this.name=re,this.message=me;var Se=new Error(me).stack;Se!==void 0&&(this.stack=this.toString()+`
`+Se.replace(/^Error(:[^\n]*)?\n/,""))});return ce.prototype=Object.create(ne.prototype),ce.prototype.constructor=ce,ce.prototype.toString=function(){return this.message===void 0?this.name:this.name+": "+this.message},ce}var Kr=void 0;function Hs(ne){throw new Kr(ne)}function Sr(ne,re,ce){ne.forEach(function(De){Qn[De]=re});function me(De){var it=ce(De);it.length!==ne.length&&Hs("Mismatched type converter count");for(var mt=0;mt<ne.length;++mt)Rs(ne[mt],it[mt])}var Se=new Array(re.length),Fe=[],Ne=0;re.forEach((De,it)=>{zs.hasOwnProperty(De)?Se[it]=zs[De]:(Fe.push(De),fn.hasOwnProperty(De)||(fn[De]=[]),fn[De].push(()=>{Se[it]=zs[De],++Ne,Ne===Fe.length&&me(Se)}))}),Fe.length===0&&me(Se)}function e0(ne){var re=dn[ne];delete dn[ne];var ce=re.elements,me=ce.length,Se=ce.map(function(De){return De.getterReturnType}).concat(ce.map(function(De){return De.setterArgumentType})),Fe=re.rawConstructor,Ne=re.rawDestructor;Sr([ne],Se,function(De){return ce.forEach((it,mt)=>{var Dt=De[mt],Wt=it.getter,Di=it.getterContext,Hi=De[mt+me],fr=it.setter,Gi=it.setterContext;it.read=ls=>Dt.fromWireType(Wt(Di,ls)),it.write=(ls,ms)=>{var mn=[];fr(Gi,ls,Hi.toWireType(mn,ms)),wn(mn)}}),[{name:re.name,fromWireType:function(it){for(var mt=new Array(me),Dt=0;Dt<me;++Dt)mt[Dt]=ce[Dt].read(it);return Ne(it),mt},toWireType:function(it,mt){if(me!==mt.length)throw new TypeError("Incorrect number of tuple elements for "+re.name+": expected="+me+", actual="+mt.length);for(var Dt=Fe(),Wt=0;Wt<me;++Wt)ce[Wt].write(Dt,mt[Wt]);return it!==null&&it.push(Ne,Dt),Dt},argPackAdvance:8,readValueFromPointer:Wr,destructorFunction:Ne}]})}var ro={};function Ro(ne){var re=ro[ne];delete ro[ne];var ce=re.rawConstructor,me=re.rawDestructor,Se=re.fields,Fe=Se.map(Ne=>Ne.getterReturnType).concat(Se.map(Ne=>Ne.setterArgumentType));Sr([ne],Fe,Ne=>{var De={};return Se.forEach((it,mt)=>{var Dt=it.fieldName,Wt=Ne[mt],Di=it.getter,Hi=it.getterContext,fr=Ne[mt+Se.length],Gi=it.setter,ls=it.setterContext;De[Dt]={read:ms=>Wt.fromWireType(Di(Hi,ms)),write:(ms,mn)=>{var ts=[];Gi(ls,ms,fr.toWireType(ts,mn)),wn(ts)}}}),[{name:re.name,fromWireType:function(it){var mt={};for(var Dt in De)mt[Dt]=De[Dt].read(it);return me(it),mt},toWireType:function(it,mt){for(var Dt in De)if(!(Dt in mt))throw new TypeError('Missing field:  "'+Dt+'"');var Wt=ce();for(Dt in De)De[Dt].write(Wt,mt[Dt]);return it!==null&&it.push(me,Wt),Wt},argPackAdvance:8,readValueFromPointer:Wr,destructorFunction:me}]})}function t0(ne,re,ce,me,Se){}function so(ne){switch(ne){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+ne)}}function xs(){for(var ne=new Array(256),re=0;re<256;++re)ne[re]=String.fromCharCode(re);on=ne}var on=void 0;function Rt(ne){for(var re="",ce=ne;ye[ce];)re+=on[ye[ce++]];return re}var ps=void 0;function Vi(ne){throw new ps(ne)}function Rs(ne,re,ce={}){if(!("argPackAdvance"in re))throw new TypeError("registerType registeredInstance requires argPackAdvance");var me=re.name;if(ne||Vi('type "'+me+'" must have a positive integer typeid pointer'),zs.hasOwnProperty(ne)){if(ce.ignoreDuplicateRegistrations)return;Vi("Cannot register type '"+me+"' twice")}if(zs[ne]=re,delete Qn[ne],fn.hasOwnProperty(ne)){var Se=fn[ne];delete fn[ne],Se.forEach(Fe=>Fe())}}function Ls(ne,re,ce,me,Se){var Fe=so(ce);re=Rt(re),Rs(ne,{name:re,fromWireType:function(Ne){return!!Ne},toWireType:function(Ne,De){return De?me:Se},argPackAdvance:8,readValueFromPointer:function(Ne){var De;if(ce===1)De=de;else if(ce===2)De=_e;else if(ce===4)De=Pe;else throw new TypeError("Unknown boolean type size: "+re);return this.fromWireType(De[Ne>>Fe])},destructorFunction:null})}function da(ne){if(!(this instanceof xo)||!(ne instanceof xo))return!1;for(var re=this.$$.ptrType.registeredClass,ce=this.$$.ptr,me=ne.$$.ptrType.registeredClass,Se=ne.$$.ptr;re.baseClass;)ce=re.upcast(ce),re=re.baseClass;for(;me.baseClass;)Se=me.upcast(Se),me=me.baseClass;return re===me&&ce===Se}function Io(ne){return{count:ne.count,deleteScheduled:ne.deleteScheduled,preservePointerOnDelete:ne.preservePointerOnDelete,ptr:ne.ptr,ptrType:ne.ptrType,smartPtr:ne.smartPtr,smartPtrType:ne.smartPtrType}}function Nx(ne){function re(ce){return ce.$$.ptrType.registeredClass.name}Vi(re(ne)+" instance already deleted")}var G0=!1;function W0(ne){}function Sl(ne){ne.smartPtr?ne.smartPtrType.rawDestructor(ne.smartPtr):ne.ptrType.registeredClass.rawDestructor(ne.ptr)}function Ml(ne){ne.count.value-=1;var re=ne.count.value===0;re&&Sl(ne)}function Pl(ne,re,ce){if(re===ce)return ne;if(ce.baseClass===void 0)return null;var me=Pl(ne,re,ce.baseClass);return me===null?null:ce.downcast(me)}var Ol={};function i0(){return Object.keys(z0).length}function wl(){var ne=[];for(var re in z0)z0.hasOwnProperty(re)&&ne.push(z0[re]);return ne}var Ia=[];function So(){for(;Ia.length;){var ne=Ia.pop();ne.$$.deleteScheduled=!1,ne.delete()}}var Mo=void 0;function Sa(ne){Mo=ne,Ia.length&&Mo&&Mo(So)}function bu(){i.getInheritedInstanceCount=i0,i.getLiveInheritedInstances=wl,i.flushPendingDeletes=So,i.setDelayFunction=Sa}var z0={};function no(ne,re){for(re===void 0&&Vi("ptr should not be undefined");ne.baseClass;)re=ne.upcast(re),ne=ne.baseClass;return re}function vu(ne,re){return re=no(ne,re),z0[re]}function ao(ne,re){(!re.ptrType||!re.ptr)&&Hs("makeClassHandle requires ptr and ptrType");var ce=!!re.smartPtrType,me=!!re.smartPtr;return ce!==me&&Hs("Both smartPtrType and smartPtr must be specified"),re.count={value:1},H0(Object.create(ne,{$$:{value:re}}))}function Bx(ne){var re=this.getPointee(ne);if(!re)return this.destructor(ne),null;var ce=vu(this.registeredClass,re);if(ce!==void 0){if(ce.$$.count.value===0)return ce.$$.ptr=re,ce.$$.smartPtr=ne,ce.clone();var me=ce.clone();return this.destructor(ne),me}function Se(){return this.isSmartPointer?ao(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:re,smartPtrType:this,smartPtr:ne}):ao(this.registeredClass.instancePrototype,{ptrType:this,ptr:ne})}var Fe=this.registeredClass.getActualType(re),Ne=Ol[Fe];if(!Ne)return Se.call(this);var De;this.isConst?De=Ne.constPointerType:De=Ne.pointerType;var it=Pl(re,this.registeredClass,De.registeredClass);return it===null?Se.call(this):this.isSmartPointer?ao(De.registeredClass.instancePrototype,{ptrType:De,ptr:it,smartPtrType:this,smartPtr:ne}):ao(De.registeredClass.instancePrototype,{ptrType:De,ptr:it})}function H0(ne){return typeof FinalizationRegistry>"u"?(H0=re=>re,ne):(G0=new FinalizationRegistry(re=>{Ml(re.$$)}),H0=re=>{var ce=re.$$,me=!!ce.smartPtr;if(me){var Se={$$:ce};G0.register(re,Se,re)}return re},W0=re=>G0.unregister(re),H0(ne))}function X0(){if(this.$$.ptr||Nx(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var ne=H0(Object.create(Object.getPrototypeOf(this),{$$:{value:Io(this.$$)}}));return ne.$$.count.value+=1,ne.$$.deleteScheduled=!1,ne}function Tu(){this.$$.ptr||Nx(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&Vi("Object already scheduled for deletion"),W0(this),Ml(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0)}function Eu(){return!this.$$.ptr}function oo(){return this.$$.ptr||Nx(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&Vi("Object already scheduled for deletion"),Ia.push(this),Ia.length===1&&Mo&&Mo(So),this.$$.deleteScheduled=!0,this}function Xc(){xo.prototype.isAliasOf=da,xo.prototype.clone=X0,xo.prototype.delete=Tu,xo.prototype.isDeleted=Eu,xo.prototype.deleteLater=oo}function xo(){}function Ma(ne,re,ce){if(ne[re].overloadTable===void 0){var me=ne[re];ne[re]=function(){return ne[re].overloadTable.hasOwnProperty(arguments.length)||Vi("Function '"+ce+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+ne[re].overloadTable+")!"),ne[re].overloadTable[arguments.length].apply(this,arguments)},ne[re].overloadTable=[],ne[re].overloadTable[me.argCount]=me}}function Y0(ne,re,ce){i.hasOwnProperty(ne)?((ce===void 0||i[ne].overloadTable!==void 0&&i[ne].overloadTable[ce]!==void 0)&&Vi("Cannot register public name '"+ne+"' twice"),Ma(i,ne,ne),i.hasOwnProperty(ce)&&Vi("Cannot register multiple overloads of a function with the same number of arguments ("+ce+")!"),i[ne].overloadTable[ce]=re):(i[ne]=re,ce!==void 0&&(i[ne].numArguments=ce))}function Au(ne,re,ce,me,Se,Fe,Ne,De){this.name=ne,this.constructor=re,this.instancePrototype=ce,this.rawDestructor=me,this.baseClass=Se,this.getActualType=Fe,this.upcast=Ne,this.downcast=De,this.pureVirtualFunctions=[]}function kx(ne,re,ce){for(;re!==ce;)re.upcast||Vi("Expected null or instance of "+ce.name+", got an instance of "+re.name),ne=re.upcast(ne),re=re.baseClass;return ne}function Ux(ne,re){if(re===null)return this.isReference&&Vi("null is not a valid "+this.name),0;re.$$||Vi('Cannot pass "'+Nl(re)+'" as a '+this.name),re.$$.ptr||Vi("Cannot pass deleted object as a pointer of type "+this.name);var ce=re.$$.ptrType.registeredClass,me=kx(re.$$.ptr,ce,this.registeredClass);return me}function Cu(ne,re){var ce;if(re===null)return this.isReference&&Vi("null is not a valid "+this.name),this.isSmartPointer?(ce=this.rawConstructor(),ne!==null&&ne.push(this.rawDestructor,ce),ce):0;re.$$||Vi('Cannot pass "'+Nl(re)+'" as a '+this.name),re.$$.ptr||Vi("Cannot pass deleted object as a pointer of type "+this.name),!this.isConst&&re.$$.ptrType.isConst&&Vi("Cannot convert argument of type "+(re.$$.smartPtrType?re.$$.smartPtrType.name:re.$$.ptrType.name)+" to parameter type "+this.name);var me=re.$$.ptrType.registeredClass;if(ce=kx(re.$$.ptr,me,this.registeredClass),this.isSmartPointer)switch(re.$$.smartPtr===void 0&&Vi("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:re.$$.smartPtrType===this?ce=re.$$.smartPtr:Vi("Cannot convert argument of type "+(re.$$.smartPtrType?re.$$.smartPtrType.name:re.$$.ptrType.name)+" to parameter type "+this.name);break;case 1:ce=re.$$.smartPtr;break;case 2:if(re.$$.smartPtrType===this)ce=re.$$.smartPtr;else{var Se=re.clone();ce=this.rawShare(ce,s0.toHandle(function(){Se.delete()})),ne!==null&&ne.push(this.rawDestructor,ce)}break;default:Vi("Unsupporting sharing policy")}return ce}function Ru(ne,re){if(re===null)return this.isReference&&Vi("null is not a valid "+this.name),0;re.$$||Vi('Cannot pass "'+Nl(re)+'" as a '+this.name),re.$$.ptr||Vi("Cannot pass deleted object as a pointer of type "+this.name),re.$$.ptrType.isConst&&Vi("Cannot convert argument of type "+re.$$.ptrType.name+" to parameter type "+this.name);var ce=re.$$.ptrType.registeredClass,me=kx(re.$$.ptr,ce,this.registeredClass);return me}function Iu(ne){return this.rawGetPointee&&(ne=this.rawGetPointee(ne)),ne}function Vx(ne){this.rawDestructor&&this.rawDestructor(ne)}function Pa(ne){ne!==null&&ne.delete()}function Su(){Oa.prototype.getPointee=Iu,Oa.prototype.destructor=Vx,Oa.prototype.argPackAdvance=8,Oa.prototype.readValueFromPointer=Wr,Oa.prototype.deleteObject=Pa,Oa.prototype.fromWireType=Bx}function Oa(ne,re,ce,me,Se,Fe,Ne,De,it,mt,Dt){this.name=ne,this.registeredClass=re,this.isReference=ce,this.isConst=me,this.isSmartPointer=Se,this.pointeeType=Fe,this.sharingPolicy=Ne,this.rawGetPointee=De,this.rawConstructor=it,this.rawShare=mt,this.rawDestructor=Dt,!Se&&re.baseClass===void 0?me?(this.toWireType=Ux,this.destructorFunction=null):(this.toWireType=Ru,this.destructorFunction=null):this.toWireType=Cu}function Mu(ne,re,ce){i.hasOwnProperty(ne)||Hs("Replacing nonexistant public symbol"),i[ne].overloadTable!==void 0&&ce!==void 0?i[ne].overloadTable[ce]=re:(i[ne]=re,i[ne].argCount=ce)}function wa(ne,re,ce){var me=i["dynCall_"+ne];return ce&&ce.length?me.apply(null,[re].concat(ce)):me.call(null,re)}function Dn(ne,re,ce){return ne.includes("j")?wa(ne,re,ce):Yr(re).apply(null,ce)}function Yc(ne,re){var ce=[];return function(){return ce.length=0,Object.assign(ce,arguments),Dn(ne,re,ce)}}function Is(ne,re){ne=Rt(ne);function ce(){return ne.includes("j")?Yc(ne,re):Yr(re)}var me=ce();return typeof me!="function"&&Vi("unknown function pointer with signature "+ne+": "+re),me}var r0=void 0;function Da(ne){var re=he(ne),ce=Rt(re);return Nn(re),ce}function Po(ne,re){var ce=[],me={};function Se(Fe){if(!me[Fe]&&!zs[Fe]){if(Qn[Fe]){Qn[Fe].forEach(Se);return}ce.push(Fe),me[Fe]=!0}}throw re.forEach(Se),new r0(ne+": "+ce.map(Da).join([", "]))}function Kc(ne,re,ce,me,Se,Fe,Ne,De,it,mt,Dt,Wt,Di){Dt=Rt(Dt),Fe=Is(Se,Fe),De&&(De=Is(Ne,De)),mt&&(mt=Is(it,mt)),Di=Is(Wt,Di);var Hi=to(Dt);Y0(Hi,function(){Po("Cannot construct "+Dt+" due to unbound types",[me])}),Sr([ne,re,ce],me?[me]:[],function(fr){fr=fr[0];var Gi,ls;me?(Gi=fr.registeredClass,ls=Gi.instancePrototype):ls=xo.prototype;var ms=V0(Hi,function(){if(Object.getPrototypeOf(this)!==mn)throw new ps("Use 'new' to construct "+Dt);if(ts.constructor_body===void 0)throw new ps(Dt+" has no accessible constructor");var a0=ts.constructor_body[arguments.length];if(a0===void 0)throw new ps("Tried to invoke ctor of "+Dt+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(ts.constructor_body).toString()+") parameters instead!");return a0.apply(this,arguments)}),mn=Object.create(ls,{constructor:{value:ms}});ms.prototype=mn;var ts=new Au(Dt,ms,mn,Di,Gi,Fe,De,mt),Hu=new Oa(Dt,ts,!0,!1,!1),tf=new Oa(Dt+"*",ts,!1,!1,!1),rf=new Oa(Dt+" const*",ts,!1,!0,!1);return Ol[ne]={pointerType:tf,constPointerType:rf},Mu(Hi,ms),[Hu,tf,rf]})}function Oo(ne,re){for(var ce=[],me=0;me<ne;me++)ce.push(Pe[(re>>2)+me]);return ce}function Pu(ne,re,ce,me,Se,Fe){F(re>0);var Ne=Oo(re,ce);Se=Is(me,Se),Sr([],[ne],function(De){De=De[0];var it="constructor "+De.name;if(De.registeredClass.constructor_body===void 0&&(De.registeredClass.constructor_body=[]),De.registeredClass.constructor_body[re-1]!==void 0)throw new ps("Cannot register multiple constructors with identical number of parameters ("+(re-1)+") for class '"+De.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return De.registeredClass.constructor_body[re-1]=()=>{Po("Cannot construct "+De.name+" due to unbound types",Ne)},Sr([],Ne,function(mt){return mt.splice(1,0,null),De.registeredClass.constructor_body[re-1]=Gx(it,mt,null,Se,Fe),[]}),[]})}function Gx(ne,re,ce,me,Se){var Fe=re.length;Fe<2&&Vi("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var Ne=re[1]!==null&&ce!==null,De=!1,it=1;it<re.length;++it)if(re[it]!==null&&re[it].destructorFunction===void 0){De=!0;break}var mt=re[0].name!=="void",Dt=Fe-2,Wt=new Array(Dt),Di=[],Hi=[];return function(){arguments.length!==Dt&&Vi("function "+ne+" called with "+arguments.length+" arguments, expected "+Dt+" args!"),Hi.length=0;var fr;Di.length=Ne?2:1,Di[0]=Se,Ne&&(fr=re[1].toWireType(Hi,this),Di[1]=fr);for(var Gi=0;Gi<Dt;++Gi)Wt[Gi]=re[Gi+2].toWireType(Hi,arguments[Gi]),Di.push(Wt[Gi]);var ls=me.apply(null,Di);function ms(mn){if(De)wn(Hi);else for(var ts=Ne?1:2;ts<re.length;ts++){var Hu=ts===1?fr:Wt[ts-2];re[ts].destructorFunction!==null&&re[ts].destructorFunction(Hu)}if(mt)return re[0].fromWireType(mn)}return ms(ls)}}function Dl(ne,re,ce,me,Se,Fe,Ne,De){var it=Oo(ce,me);re=Rt(re),Fe=Is(Se,Fe),Sr([],[ne],function(mt){mt=mt[0];var Dt=mt.name+"."+re;re.startsWith("@@")&&(re=Symbol[re.substring(2)]),De&&mt.registeredClass.pureVirtualFunctions.push(re);function Wt(){Po("Cannot call "+Dt+" due to unbound types",it)}var Di=mt.registeredClass.instancePrototype,Hi=Di[re];return Hi===void 0||Hi.overloadTable===void 0&&Hi.className!==mt.name&&Hi.argCount===ce-2?(Wt.argCount=ce-2,Wt.className=mt.name,Di[re]=Wt):(Ma(Di,re,Dt),Di[re].overloadTable[ce-2]=Wt),Sr([],it,function(fr){var Gi=Gx(Dt,fr,mt,Fe,Ne);return Di[re].overloadTable===void 0?(Gi.argCount=ce-2,Di[re]=Gi):Di[re].overloadTable[ce-2]=Gi,[]}),[]})}function Wx(ne,re,ce){return ne instanceof Object||Vi(ce+' with invalid "this": '+ne),ne instanceof re.registeredClass.constructor||Vi(ce+' incompatible with "this" of type '+ne.constructor.name),ne.$$.ptr||Vi("cannot call emscripten binding method "+ce+" on deleted object"),kx(ne.$$.ptr,ne.$$.ptrType.registeredClass,re.registeredClass)}function Fn(ne,re,ce,me,Se,Fe,Ne,De,it,mt){re=Rt(re),Se=Is(me,Se),Sr([],[ne],function(Dt){Dt=Dt[0];var Wt=Dt.name+"."+re,Di={get:function(){Po("Cannot access "+Wt+" due to unbound types",[ce,Ne])},enumerable:!0,configurable:!0};return it?Di.set=()=>{Po("Cannot access "+Wt+" due to unbound types",[ce,Ne])}:Di.set=Hi=>{Vi(Wt+" is a read-only property")},Object.defineProperty(Dt.registeredClass.instancePrototype,re,Di),Sr([],it?[ce,Ne]:[ce],function(Hi){var fr=Hi[0],Gi={get:function(){var ms=Wx(this,Dt,Wt+" getter");return fr.fromWireType(Se(Fe,ms))},enumerable:!0};if(it){it=Is(De,it);var ls=Hi[1];Gi.set=function(ms){var mn=Wx(this,Dt,Wt+" setter"),ts=[];it(mt,mn,ls.toWireType(ts,ms)),wn(ts)}}return Object.defineProperty(Dt.registeredClass.instancePrototype,re,Gi),[]}),[]})}var zx=[],Ln=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function jc(ne){ne>4&&--Ln[ne].refcount===0&&(Ln[ne]=void 0,zx.push(ne))}function Fl(){for(var ne=0,re=5;re<Ln.length;++re)Ln[re]!==void 0&&++ne;return ne}function xn(){for(var ne=5;ne<Ln.length;++ne)if(Ln[ne]!==void 0)return Ln[ne];return null}function Ll(){i.count_emval_handles=Fl,i.get_first_emval=xn}var s0={toValue:ne=>(ne||Vi("Cannot use deleted val. handle = "+ne),Ln[ne].value),toHandle:ne=>{switch(ne){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:{var re=zx.length?zx.pop():Ln.length;return Ln[re]={refcount:1,value:ne},re}}}};function Ou(ne,re){re=Rt(re),Rs(ne,{name:re,fromWireType:function(ce){var me=s0.toValue(ce);return jc(ce),me},toWireType:function(ce,me){return s0.toHandle(me)},argPackAdvance:8,readValueFromPointer:Wr,destructorFunction:null})}function Nl(ne){if(ne===null)return"null";var re=typeof ne;return re==="object"||re==="array"||re==="function"?ne.toString():""+ne}function pn(ne,re){switch(re){case 2:return function(ce){return this.fromWireType(We[ce>>2])};case 3:return function(ce){return this.fromWireType(et[ce>>3])};default:throw new TypeError("Unknown float type: "+ne)}}function wu(ne,re,ce){var me=so(ce);re=Rt(re),Rs(ne,{name:re,fromWireType:function(Se){return Se},toWireType:function(Se,Fe){return Fe},argPackAdvance:8,readValueFromPointer:pn(re,me),destructorFunction:null})}function Bl(ne,re,ce){switch(re){case 0:return ce?function(me){return de[me]}:function(me){return ye[me]};case 1:return ce?function(me){return _e[me>>1]}:function(me){return we[me>>1]};case 2:return ce?function(me){return Pe[me>>2]}:function(me){return Ee[me>>2]};default:throw new TypeError("Unknown integer type: "+ne)}}function Du(ne,re,ce,me,Se){re=Rt(re);var Fe=so(ce),Ne=Wt=>Wt;if(me===0){var De=32-8*ce;Ne=Wt=>Wt<<De>>>De}var it=re.includes("unsigned"),mt=(Wt,Di)=>{},Dt;it?Dt=function(Wt,Di){return mt(Di,this.name),Di>>>0}:Dt=function(Wt,Di){return mt(Di,this.name),Di},Rs(ne,{name:re,fromWireType:Ne,toWireType:Dt,argPackAdvance:8,readValueFromPointer:Bl(re,Fe,me!==0),destructorFunction:null})}function Fu(ne,re,ce){var me=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],Se=me[re];function Fe(Ne){Ne=Ne>>2;var De=Ee,it=De[Ne],mt=De[Ne+1];return new Se(ue,mt,it)}ce=Rt(ce),Rs(ne,{name:ce,fromWireType:Fe,argPackAdvance:8,readValueFromPointer:Fe},{ignoreDuplicateRegistrations:!0})}function Lu(ne,re){re=Rt(re);var ce=re==="std::string";Rs(ne,{name:re,fromWireType:function(me){var Se=Ee[me>>2],Fe;if(ce)for(var Ne=me+4,De=0;De<=Se;++De){var it=me+4+De;if(De==Se||ye[it]==0){var mt=it-Ne,Dt=k(Ne,mt);Fe===void 0?Fe=Dt:(Fe+=String.fromCharCode(0),Fe+=Dt),Ne=it+1}}else{for(var Wt=new Array(Se),De=0;De<Se;++De)Wt[De]=String.fromCharCode(ye[me+4+De]);Fe=Wt.join("")}return Nn(me),Fe},toWireType:function(me,Se){Se instanceof ArrayBuffer&&(Se=new Uint8Array(Se));var Fe,Ne=typeof Se=="string";Ne||Se instanceof Uint8Array||Se instanceof Uint8ClampedArray||Se instanceof Int8Array||Vi("Cannot pass non-string to std::string"),ce&&Ne?Fe=()=>z(Se):Fe=()=>Se.length;var De=Fe(),it=n0(4+De+1);if(Ee[it>>2]=De,ce&&Ne)H(Se,it+4,De+1);else if(Ne)for(var mt=0;mt<De;++mt){var Dt=Se.charCodeAt(mt);Dt>255&&(Nn(it),Vi("String has UTF-16 code units that do not fit in 8 bits")),ye[it+4+mt]=Dt}else for(var mt=0;mt<De;++mt)ye[it+4+mt]=Se[mt];return me!==null&&me.push(Nn,it),it},argPackAdvance:8,readValueFromPointer:Wr,destructorFunction:function(me){Nn(me)}})}function Nu(ne,re,ce){ce=Rt(ce);var me,Se,Fe,Ne,De;re===2?(me=Y,Se=Z,Ne=Q,Fe=()=>we,De=1):re===4&&(me=se,Se=$,Ne=oe,Fe=()=>Ee,De=2),Rs(ne,{name:ce,fromWireType:function(it){for(var mt=Ee[it>>2],Dt=Fe(),Wt,Di=it+4,Hi=0;Hi<=mt;++Hi){var fr=it+4+Hi*re;if(Hi==mt||Dt[fr>>De]==0){var Gi=fr-Di,ls=me(Di,Gi);Wt===void 0?Wt=ls:(Wt+=String.fromCharCode(0),Wt+=ls),Di=fr+re}}return Nn(it),Wt},toWireType:function(it,mt){typeof mt!="string"&&Vi("Cannot pass non-string to C++ string type "+ce);var Dt=Ne(mt),Wt=n0(4+Dt+re);return Ee[Wt>>2]=Dt>>De,Se(mt,Wt+4,Dt+re),it!==null&&it.push(Nn,Wt),Wt},argPackAdvance:8,readValueFromPointer:Wr,destructorFunction:function(it){Nn(it)}})}function Bu(ne,re,ce,me,Se,Fe){dn[ne]={name:Rt(re),rawConstructor:Is(ce,me),rawDestructor:Is(Se,Fe),elements:[]}}function ku(ne,re,ce,me,Se,Fe,Ne,De,it){dn[ne].elements.push({getterReturnType:re,getter:Is(ce,me),getterContext:Se,setterArgumentType:Fe,setter:Is(Ne,De),setterContext:it})}function Uu(ne,re,ce,me,Se,Fe){ro[ne]={name:Rt(re),rawConstructor:Is(ce,me),rawDestructor:Is(Se,Fe),fields:[]}}function Vu(ne,re,ce,me,Se,Fe,Ne,De,it,mt){ro[ne].fields.push({fieldName:Rt(re),getterReturnType:ce,getter:Is(me,Se),getterContext:Fe,setterArgumentType:Ne,setter:Is(De,it),setterContext:mt})}function Gu(ne,re){re=Rt(re),Rs(ne,{isVoid:!0,name:re,argPackAdvance:0,fromWireType:function(){},toWireType:function(ce,me){}})}function qc(ne){ne>4&&(Ln[ne].refcount+=1)}function Wu(ne,re){var ce=zs[ne];return ce===void 0&&Vi(re+" has unknown type "+Da(ne)),ce}function zu(ne,re){ne=Wu(ne,"_emval_take_value");var ce=ne.readValueFromPointer(re);return s0.toHandle(ce)}function Zc(){mi("")}function Qc(ne,re,ce){ye.copyWithin(ne,re,re+ce)}function Fa(){return 2147483648}function Hx(ne){try{return S.grow(ne-ue.byteLength+65535>>>16),ke(S.buffer),1}catch{}}function $c(ne){var re=ye.length;ne=ne>>>0;var ce=Fa();if(ne>ce)return!1;let me=(it,mt)=>it+(mt-it%mt)%mt;for(var Se=1;Se<=4;Se*=2){var Fe=re*(1+.2/Se);Fe=Math.min(Fe,ne+100663296);var Ne=Math.min(ce,me(Math.max(ne,Fe),65536)),De=Hx(Ne);if(De)return!0}return!1}Kr=i.InternalError=io(Error,"InternalError"),xs(),ps=i.BindingError=io(Error,"BindingError"),Xc(),bu(),Su(),r0=i.UnboundTypeError=io(Error,"UnboundTypeError"),Ll();var Jc={b:eo,a:Jo,i:e0,x:Ro,q:t0,v:Ls,m:Kc,h:Pu,c:Dl,g:Fn,u:Ou,o:wu,f:Du,d:Fu,n:Lu,k:Nu,j:Bu,e:ku,y:Uu,l:Vu,w:Gu,z:jc,A:qc,p:zu,r:Zc,t:Qc,s:$c};un(),i.___wasm_call_ctors=function(){return(i.___wasm_call_ctors=i.asm.C).apply(null,arguments)};var Nn=i._free=function(){return(Nn=i._free=i.asm.D).apply(null,arguments)},n0=i._malloc=function(){return(n0=i._malloc=i.asm.E).apply(null,arguments)},he=i.___getTypeName=function(){return(he=i.___getTypeName=i.asm.G).apply(null,arguments)};i.___embind_register_native_and_builtin_types=function(){return(i.___embind_register_native_and_builtin_types=i.asm.H).apply(null,arguments)};var le=i.___cxa_is_pointer_type=function(){return(le=i.___cxa_is_pointer_type=i.asm.I).apply(null,arguments)},ve;ci=function ne(){ve||Ge(),ve||(ci=ne)};function Ge(ne){if(oi>0||(fi(),oi>0))return;function re(){ve||(ve=!0,i.calledRun=!0,!M&&(li(),s(i),i.onRuntimeInitialized&&i.onRuntimeInitialized(),Ot()))}i.setStatus?(i.setStatus("Running..."),setTimeout(function(){setTimeout(function(){i.setStatus("")},1),re()},1)):re()}if(i.run=Ge,i.preInit)for(typeof i.preInit=="function"&&(i.preInit=[i.preInit]);i.preInit.length>0;)i.preInit.pop()();return Ge(),e.ready}})(),h8=Object.defineProperty,u8=(l,e,i)=>e in l?h8(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,cl=(l,e,i)=>(u8(l,typeof e!="symbol"?e+"":e,i),i);class lY{constructor(){cl(this,"faceDetector"),cl(this,"meshDetector"),cl(this,"faceModule"),cl(this,"faceAligner"),cl(this,"faceTracks",[]),cl(this,"faceFilters",[]),cl(this,"meshScore",.9)}async process(e,i){var s,n,a,p;const _=zr(()=>{const M=kn(np(e,3),"float32"),F=ia(us(M,255*.5),1);return yh(F,0)});let g=[];this.faceTracks.length===0&&(g=await((s=this.faceDetector)==null?void 0:s.process(_,!0))||[],g.forEach(M=>{if(!M.keypoints)return;const{xy:F,size:L}=M.rect,N=F.y+L.height/2,k=L.height*1.3;this.faceTracks.push({rect:{xy:{x:F.x,y:N-k/2},size:{width:L.width,height:k}},symmetry:[M.keypoints[Pm.Mouth],M.keypoints[Pm.Nose]]}),this.faceFilters.push(new this.faceModule.FaceFilter({minCutOff:1,minCutOffD:2,beta:30},{minCutOff:1,minCutOffD:2,beta:30},1))}));const y=this.faceTracks.length>0?await((n=this.meshDetector)==null?void 0:n.process(_,this.faceTracks))||[]:[];_.dispose();const b=[],v=[],S=[];for(let M=0;M<this.faceTracks.length;M++){const F=y[M],{rect:L}=F,N={xy:{x:L[0],y:L[1]},size:{width:L[2],height:L[3]}},k=[F.keypoints[((a=this.meshDetector)==null?void 0:a.symmetryPoints[0])||0],F.keypoints[((p=this.meshDetector)==null?void 0:p.symmetryPoints[1])||0]];if(WL(this.faceTracks[M].rect,N)>.5&&F.score>this.meshScore){if(S.push(F),b.push({rect:N,symmetry:[{x:k[0][0],y:k[0][1]},{x:k[1][0],y:k[1][1]}]}),i===void 0)continue;const[G,H]=[_.shape[1],_.shape[2]],{width:z,height:W}=this.faceTracks[M].rect.size,Y=(z+W*H/G)*.5;this.faceFilters[M].smoothFilter(F,i,1/Y),F.keypoints=this.faceFilters[M].smoothPixel(),v.push(this.faceFilters[M])}else this.faceFilters[M].delete()}return this.faceTracks=b,this.faceFilters=v,S}align(e){var i;const s=new this.faceModule.VectorFloat;return e.flat().forEach(n=>s.push_back(n)),(i=this.faceAligner)==null||i.align(s),s.delete(),this.alignTransform()}alignTransform(){if(!this.faceAligner)return;const e=this.faceAligner.rotation,i=this.faceAligner.translation,s=this.faceAligner.scale,n=this.faceAligner.shapeScale;return{rotation:[e[0],e[1],e[2],e[3]],translation:[i[0],i[1],i[2]],scale:s,shapeScale:[n[0],n[1],n[2]]}}metricPoints(){if(!this.faceAligner)return;let e=[];const i=this.faceAligner.metricPoints();for(let s=0;s<i.size();s+=3)e.push([i.get(s+0),i.get(s+1),i.get(s+2)]);return i.delete(),e}referencePoints(){if(!this.faceAligner)return;let e=[];const i=this.faceAligner.referencePoints();for(let s=0;s<i.size();s+=3)e.push([i.get(s+0),i.get(s+1),i.get(s+2)]);return i.delete(),e}backprojPoints(){if(!this.faceAligner)return;let e=[];const i=this.faceAligner.backprojPoints();for(let s=0;s<i.size();s+=3)e.push([i.get(s+0),i.get(s+1),i.get(s+2)]);return i.delete(),e}setCamera(e,i,s){var n;(n=this.faceAligner)==null||n.setCamera(e,i,s)}async init(e,i="./",s=!1,n=!1,a="webgl"){const p=await Vp({locateFile:F=>i+F});p.Loader.prototype.promisify=function(F,...L){return F.call(this,...L),new Promise(N=>{const k=setInterval(()=>{if(this.ready)return clearInterval(k),N(this.status)},5)})},p.Loader.prototype.load=function(F){return this.promisify(this.loadAsync,F,s)},p.Loader.prototype.remove=function(F){return this.promisify(this.removeAsync,F)},p.DictLoader.prototype.loadDict=function(F){return this.promisify(this.loadDictAsync,e,F)};const _=new p.ParseLoader(i),[g,y]=n?["faceext.wasm","meshextmodel.def"]:["face.wasm","meshmodel.def"];if(s||(await _.remove(g),await _.remove("faceutils.wasm")),!await _.loadDict([g,"faceutils.wasm"])||!await _.load(g)||!_.parse())return;Ue().set("WEBGL_USE_SHAPES_UNIFORMS",!0),rp(),await sp(a);const b={weightUrlConverter:async F=>F,fetchFunc:async F=>{const L=new Blob([_.file(F)]);return fetch(URL.createObjectURL(L))}},v=await tc("facemodel.def",b),S=await tc(y,b);if(this.faceDetector=new $6(v),this.meshDetector=new a8(S),!await _.load("faceutils.wasm"))return;const M=await c8({wasmBinary:_.data()});_.delete(),M.FaceFilter.prototype.smoothFilter=function(F,L){const N=new M.VectorFloat,k=new M.VectorFloat;F.keypoints.flat().forEach(G=>N.push_back(G)),F.rect.forEach(G=>k.push_back(G)),this.filter(N,k,F.score,L,1),N.delete(),k.delete()},M.FaceFilter.prototype.smoothPixel=function(){let F=[];const L=this.pixel();for(let N=0;N<L.size();N+=3)F.push([L.get(N+0),L.get(N+1),L.get(N+2)]);return L.delete(),F},this.faceModule=M,this.faceAligner=new this.faceModule.FaceAligner}reset(){this.faceFilters.forEach(e=>e.delete()),this.faceFilters=[],this.faceTracks=[]}async prepare(){var e,i;Ue().set("ENGINE_COMPILE_ONLY",!0),await((e=this.faceDetector)==null?void 0:e.prepare()),await((i=this.meshDetector)==null?void 0:i.prepare());const s=Rd();s instanceof ll&&(s.checkCompileCompletion(),s.getUniformLocations()),Ue().set("ENGINE_COMPILE_ONLY",!1)}dispose(){var e,i,s;this.reset(),(e=this.faceDetector)==null||e.dispose(),(i=this.meshDetector)==null||i.dispose(),(s=this.faceAligner)==null||s.delete()}}var d8=Object.defineProperty,WT=Object.getOwnPropertySymbols,f8=Object.prototype.hasOwnProperty,p8=Object.prototype.propertyIsEnumerable,Dm=(l,e,i)=>e in l?d8(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,m8=(l,e)=>{for(var i in e||(e={}))f8.call(e,i)&&Dm(l,i,e[i]);if(WT)for(var i of WT(e))p8.call(e,i)&&Dm(l,i,e[i]);return l},dx=(l,e,i)=>(Dm(l,typeof e!="symbol"?e+"":e,i),i);class _8{constructor(e){this.model=e,dx(this,"modelSize"),dx(this,"modelRatio"),dx(this,"anchorsX"),dx(this,"anchorsY"),dx(this,"anchorsData"),dx(this,"handsMax",1),dx(this,"iouThresh",.3),dx(this,"scoreThresh",.45),this.model=e,this.modelSize=e.inputs[0].shape?{width:e.inputs[0].shape[2],height:e.inputs[0].shape[1]}:{width:192,height:192},this.modelRatio=this.modelSize.width/this.modelSize.height,this.anchorsData=this.buildAnchors(this.modelSize),this.anchorsX=qs(this.anchorsData.map(i=>i.x)),this.anchorsY=qs(this.anchorsData.map(i=>i.y))}async process(e){let i={x:0,y:0};const[s,n]=zr(()=>{const y={width:e.shape[2],height:e.shape[1]},b=y.width/y.height;let v=m8({},y),S={x:0,y:0};b>this.modelRatio?(v.height=e.shape[2]/this.modelRatio,S.y=Math.floor((v.height-e.shape[1])*.5),i.y=S.y/v.height):b<this.modelRatio&&(v.width=e.shape[1]*this.modelRatio,S.x=Math.floor((v.width-e.shape[2])*.5),i.x=S.x/v.width);const M=wd(e,[[0,0],[S.y,S.y],[S.x,S.x],[0,0]],0),F=No.resizeBilinear(M,[this.modelSize.height,this.modelSize.width]),L=this.model.execute(F,"palm"),N=ds(Or(L,[0,0,1],[1,-1,-1])),k=ds(Or(L,[0,0,0],[1,-1,1])),G=fh(ob(k,-100,100));return[this.decodeBoxes(N,[this.anchorsX,this.anchorsY],this.modelSize),G]}),a=await s.data(),p=await n.data();let _=[];for(let y=0;y<p.length;y++){if(p[y]<this.scoreThresh)continue;const b=a[y*18+2]-a[y*18+0],v=a[y*18+3]-a[y*18+1];b<0||v<0||_.push({box:[[a[y*18+0],a[y*18+1]],[a[y*18+2],a[y*18+3]]],points:[[a[y*18+4],a[y*18+5]],[a[y*18+6],a[y*18+7]],[a[y*18+8],a[y*18+9]],[a[y*18+10],a[y*18+11]],[a[y*18+12],a[y*18+13]],[a[y*18+14],a[y*18+15]],[a[y*18+16],a[y*18+17]]],score:p[y]})}if(s.dispose(),n.dispose(),_.length<1)return[];if(_.length>1){const y=Mp(_.map(F=>[F.box[0][1],F.box[0][0],F.box[1][1],F.box[1][0]])),b=qs(_.map(F=>F.score)),v=await No.nonMaxSuppressionAsync(y,b,this.handsMax,this.iouThresh,this.scoreThresh),S=await v.data();v.dispose();const M=[];for(let F=0;F<S.length;F++)M.push(_[S[F]]);_=M}if(_.length<1)return[];const g={width:1-2*i.x,height:1-2*i.y};return _.map(y=>({points:y.points.map(b=>[(b[0]-i.x)/g.width,(b[1]-i.y)/g.height]),box:y.box.map(b=>[(b[0]-i.x)/g.width,(b[1]-i.y)/g.height]),score:y.score}))}decodeBoxes(e,i,s){let n=ds(Or(e,[0,0],[-1,1])),a=ds(Or(e,[0,1],[-1,1])),p=ds(Or(e,[0,2],[-1,1])),_=ds(Or(e,[0,3],[-1,1]));n=Hr(us(n,s.width),i[0]),a=Hr(us(a,s.height),i[1]),p=us(p,s.width*2),_=us(_,s.height*2);const g=ti(ia(n,p),[2016,1]),y=ti(ia(a,_),[2016,1]),b=ti(Hr(n,p),[2016,1]),v=ti(Hr(a,_),[2016,1]);let S=ph([g,y,b,v],1);for(let M=0;M<7;M++){let F=ds(Or(e,[0,4+M*2],[-1,1])),L=ds(Or(e,[0,4+M*2+1],[-1,1]));F=ti(Hr(us(F,s.width),i[0]),[2016,1]),L=ti(Hr(us(L,s.height),i[1]),[2016,1]),S=ph([S,F,L],1)}return S}buildAnchors(e){const i=[8,16,16,16],s=[];let n=0;for(;n<4;){let a=0,p=n;for(;p<i.length&&i[p]===i[n];)a+=2,p++;const _=i[n],g=Math.ceil(e.height/_),y=Math.ceil(e.width/_);for(let b=0;b<g;++b)for(let v=0;v<y;++v)for(let S=0;S<a;++S)s.push({x:(v+.5)/y,y:(b+.5)/g});n=p}return s}async prepare(){const{width:e,height:i}=this.modelSize,s=Lo([1,i,e,3]),n=this.model.execute(s,"palm");await n.data(),s.dispose(),n.dispose()}dispose(){this.model.dispose(),this.anchorsX.dispose(),this.anchorsY.dispose()}}var g8=Object.defineProperty,y8=(l,e,i)=>e in l?g8(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,Vo=(l,e,i)=>(y8(l,typeof e!="symbol"?e+"":e,i),i);class b8{constructor(e,i=!0){this.model=e,this.wrist=i,Vo(this,"modelSize"),Vo(this,"modelRatio"),Vo(this,"backend"),Vo(this,"localMax"),Vo(this,"localMaxSize",{width:256,height:256}),Vo(this,"circlePoints",[]),Vo(this,"colorWeights",[.5,1,.8]),Vo(this,"colorThresh",.05),Vo(this,"edgeThresh",.003),Vo(this,"edgeStop",.01),this.model=e,this.modelSize=e.inputs[0].shape?{width:e.inputs[0].shape[2],height:e.inputs[0].shape[1]}:{width:224,height:224},this.modelRatio=this.modelSize.width/this.modelSize.height,this.buildCircle(31)}async process(e,i){const[s,n]=[e.shape[1],e.shape[2]],{modelSize:a,modelRatio:p,localMaxSize:_}=this;return i.map(g=>{const y=[g.start[0]*n,g.start[1]*s],b=[g.end[0]*n,g.end[1]*s];let[v,S]=[b[0]-y[0],y[1]-b[1]];const M=Math.sqrt(v**2+S**2);v/=M,S/=M;const F=Math.atan2(v,S),L=[.5*(g.box[0][0]+g.box[1][0])*n,.5*(g.box[0][1]+g.box[1][1])*s];let N=.5*(g.box[1][0]-g.box[0][0])*n,k=.5*(g.box[1][1]-g.box[0][1])*s;const G=N/k/p;G>1?N*=G:k/=G;const H=[L[1]-k,L[0]-N,L[1]+k,L[0]+N],z=zr(()=>this.rotatedRect(e,H,F,!1,a)),W=["Identity_2:0","Identity_1:0","Identity:0","Identity_3:0"],[Y,Z,Q,se]=this.model.execute(z,W),$=Y.dataSync(),oe=se.dataSync(),ue=Z.dataSync()[0],de=2*Q.dataSync()[0]-1;let ye=[];for(let Xe=0;Xe<21;Xe++)ye.push([$[3*Xe+0]/a.width,$[3*Xe+1]/a.height,$[3*Xe+2]/a.width/.4]);const _e=[ye[0][0],ye[0][1]];let we=_e[0],Pe=_e[1];we=(we-.5)*2*N,Pe=(Pe-.5)*2*k,_e[0]=we*S-Pe*v+L[0],_e[1]=we*v+Pe*S+L[1];const Ee=[_e[1]-k,_e[0]-N,_e[1]+k,_e[0]+N],We=this.wrist?zr(()=>this.rotatedRect(e,Ee,F,!0,_)):void 0;let et=[],ke=[];const $e=We?zr(()=>{const Xe=ds(We,[0]),Tt=po(Xe,[[.299,-.14713,.615],[.587,-.28886,-.51499],[.114,.436,-.10001]]),fi=[[[[-.25],[-.25],[-.25]],[[0],[0],[0]],[[.25],[.25],[.25]]],[[[-.5],[-.5],[-.5]],[[0],[0],[0]],[[.5],[.5],[.5]]],[[[-.25],[-.25],[-.25]],[[0],[0],[0]],[[.25],[.25],[.25]]]],li=[[[[-.25],[-.25],[-.25]],[[-.5],[-.5],[-.5]],[[-.25],[-.25],[-.25]]],[[[0],[0],[0]],[[0],[0],[0]],[[0],[0],[0]]],[[[.25],[.25],[.25]],[[.5],[.5],[.5]],[[.25],[.25],[.25]]]],Ot=Md(Tt,fi,1,"same"),Gt=Md(Tt,li,1,"same"),bi=vn(gh(Ot),2,!0),si=vn(gh(Gt),2,!0),oi=vn(js(Ot,Gt),2,!0),ci=Hr(bi,si),Li=yp(Hr(gh(ia(bi,si)),js(gh(oi),4))),hi=js(Hr(ci,Li),.5);let mi=fw([ia(hi,si),oi],2);mi=us(mi,Od(mi,2,!0));let cr=Li;if(this.backend&&this.localMax){const dn=this.backend.compileAndRun(this.localMax,[cr,mi]);cr=Va().makeTensorFromTensorInfo(dn)}const Ui=js(mp(Tt,4,4,"valid"),this.colorWeights),Ii=Ui.shape,Cr=[Ii[0]/2,Ii[1]/2],an=ti(Ui,[Ii[0],Ii[1],1,3]),un=Sp(Ui,[Cr[0]-3,Cr[1]-4,0],[7,9,3]),Zn=_h(Od(ia(an,ti(un,[-1,3])),3,!1),2,!0),On=Sp(Ui,[Cr[0]-4,8,0],[2,8,3]),Yr=Sp(Ui,[Cr[0]-4,Ii[1]-16,0],[2,8,3]),eo=Zl([ti(On,[-1,3]),ti(Yr,[-1,3])],0),$o=_h(Od(ia(an,eo),3,!1),2,!0),Jo=_D(rD(fb(Zn,$o),fb(Zn,[this.colorThresh])),9,"max","same");return{yuv:Tt,rgb:Xe,edgeVal:cr,edgeXY:mi,fg:Jo}}):void 0,pt=$e?zr(()=>{const Xe=bp($e.edgeVal,4,4,"valid");let Tt=mp($e.edgeXY,4,4,"valid");Tt=us(Tt,Od(Tt,2,!0));const fi=Xe.dataSync(),li=Tt.dataSync(),Ot=$e.fg.dataSync(),Gt=this.circlePoints.map(hi=>this.evaluateLine([64/2,64/2],hi,fi,li,Ot));let bi=0,si=0,oi=-1;for(let hi=0;hi<Gt.length;hi++){const mi=Gt[hi].strengthL;for(let cr=hi;cr<hi+12&&cr<Gt.length;cr++){const Ui=mi+Gt[cr].strengthR;Ui>=oi&&(oi=Ui,bi=hi,si=cr)}}et.push([...this.circlePoints[Math.round(.5*(bi+si))]]);const ci=Gt[bi].anchorsL.map(hi=>[hi[0],hi[1]]),Li=Gt[si].anchorsR.map(hi=>[hi[0],hi[1]]);et.push(...ci),et.push(...Li),ke.push(this.fitLine(ci)),ke.push(this.fitLine(Li))}):void 0;return z.dispose(),Y.dispose(),se.dispose(),Z.dispose(),Q.dispose(),We?.dispose(),$e?.yuv.dispose(),$e?.rgb.dispose(),$e?.edgeVal.dispose(),$e?.edgeXY.dispose(),{points:ye,metricData:oe,score:ue,handedness:de,radiusX:N,radiusY:k,angle:F,anchors:et,lines:ke,center:L,wristCenter:_e,wristDebug:pt}}).map((g,y)=>{const{points:b,metricData:v,score:S,handedness:M,radiusX:F,radiusY:L,angle:N,anchors:k,lines:G,center:H,wristCenter:z,wristDebug:W}=g,Y=b.map((oe,ue)=>({pixel:oe,metric:[v[3*ue+0],v[3*ue+1],v[3*ue+2]]}));Y.forEach(oe=>{oe.pixel[0]=(oe.pixel[0]-.5)*2*F,oe.pixel[1]=(oe.pixel[1]-.5)*2*L,oe.pixel[2]*=2*F});const Z=Math.sin(N),Q=Math.cos(N);Y.forEach(oe=>{const ue=oe.pixel[0],de=oe.pixel[1];oe.pixel[0]=(ue*Q-de*Z+H[0])/n,oe.pixel[1]=(ue*Z+de*Q+H[1])/s,oe.pixel[2]/=n;const ye=oe.metric[0],_e=oe.metric[1];oe.metric[0]=ye*Q-_e*Z,oe.metric[1]=ye*Z+_e*Q});const se=this.circlePoints.map(oe=>[oe[0]/64,oe[1]/64]);k.forEach(oe=>{oe[0]=(oe[0]+.5)/64,oe[1]=(oe[1]+.5)/64}),k.forEach(oe=>{const ue=(oe[0]-.5)*2*F,de=(oe[1]-.5)*2*L;oe[0]=(ue*Q-de*Z+z[0])/n,oe[1]=(ue*Z+de*Q+z[1])/s}),G.forEach(oe=>{oe.point[0]=(oe.point[0]+.5)/64,oe.point[1]=(oe.point[1]+.5)/64});const $=this.normalizeLines(G[0],G[1],[.5,.5]);return $.forEach(oe=>{const ue=(oe.point[0]-.5)*2*F,de=(oe.point[1]-.5)*2*L;oe.point[0]=(ue*Q-de*Z+z[0])/n,oe.point[1]=(ue*Z+de*Q+z[1])/s;const ye=oe.vector[0],_e=oe.vector[1];oe.vector[0]=ye*Q-_e*Z,oe.vector[1]=ye*Z+_e*Q}),{keypoints:Y,score:S,handedness:M,wrist:{lines:$},debug:{box:i[y],anchors:k,circle:se,tensors:W}}})}evaluateLine(e,i,s,n,a){const p=[i[0]-e[0],i[1]-e[1]],_=this.buildLine(p[0],p[1]).slice(0,24),g=_.map(H=>[H[1],-H[0]]),y=Math.sqrt(p[0]**2+p[1]**2);p[0]/=y,p[1]/=y;const b=[p[1],-p[0]];_.forEach(H=>{H[0]+=e[0],H[1]+=e[1]});let v=[],S=[];const M=new Array(16).fill(0),F=new Array(16).fill(0);for(let H=6;H<_.length;H++){const z=_[H];let W=2,Y=[0,0],Z=-1,Q=-1,se=[0,0];for(W=2;W<16;W++){Y=[z[0]+g[W][0],z[1]+g[W][1]];const $=Y[1]*64+Y[0];if(a[$]<.5)break;if(s[$]<this.edgeThresh)continue;const oe=n[2*$],ue=n[2*$+1];if(!(Math.abs(oe*b[0]+ue*b[1])<.95)){if(s[$]>this.edgeStop){Q=W,se=Y,Z=s[$];break}s[$]>Z&&(Q=W,se=Y,Z=s[$])}}for(Q<16&&Q>3&&(v.push([...se,Q]),M[Q]++),W=2,Z=-1,Q=-1,se=[0,0],W=2;W<16;W++){Y=[z[0]-g[W][0],z[1]-g[W][1]];const $=Y[1]*64+Y[0];if(a[$]<.5)break;if(s[$]<this.edgeThresh)continue;const oe=n[2*$],ue=n[2*$+1];if(!(Math.abs(oe*b[0]+ue*b[1])<.95)){if(s[$]>this.edgeStop){Q=W,se=Y,Z=s[$];break}s[$]>Z&&(Q=W,se=Y,Z=s[$])}}Q<16&&Q>3&&(S.push([...se,Q]),F[Q]++)}let L=0,N=0,k=0,G=0;for(let H=1;H<16;H++){const z=.5*M[H-1]+M[H]+.5*M[H+1],W=.5*F[H-1]+F[H]+.5*F[H+1];z>L&&(L=z,k=H),W>N&&(N=W,G=H)}return v=v.filter(H=>Math.abs(H[2]-k)<=1),S=S.filter(H=>Math.abs(H[2]-G)<=1),{anchorsL:v,anchorsR:S,strengthL:L,strengthR:N}}fitLine(e){const i=e.reduce((_,g)=>[_[0]+g[0],_[1]+g[1]],[0,0]);i[0]/=e.length,i[1]/=e.length;const s=e.reduce((_,g)=>{const y=[g[0]-i[0],g[1]-i[1]];return[_[0]+y[0]**2-y[1]**2,_[1]+2*y[0]*y[1]]},[0,0]),n=Math.sqrt(s[0]**2+s[1]**2),a=[Math.sqrt(.5*(n+s[0])),Math.sqrt(.5*(n-s[0]))],p=Math.sqrt(a[0]**2+a[1]**2);return a[0]/=p,a[1]/=p,s[1]<0&&(a[0]=-a[0]),{point:i,vector:a}}normalizeLines(e,i,s){const n=(ue,de)=>[ue[0]+de[0],ue[1]+de[1],ue[2]+de[2]],a=(ue,de)=>[ue[0]-de[0],ue[1]-de[1],ue[2]-de[2]],p=(ue,de)=>[ue[1]*de[2]-ue[2]*de[1],ue[2]*de[0]-ue[0]*de[2],ue[0]*de[1]-ue[1]*de[0]],_=(ue,de,ye)=>[ue[0]+(de[0]-ue[0])*ye,ue[1]+(de[1]-ue[1])*ye,ue[2]+(de[2]-ue[2])*ye],g=(ue,de)=>[ue[0]*de,ue[1]*de,ue[2]*de],y=(ue,de)=>ue[0]*de[0]+ue[1]*de[1]+ue[2]*de[2],b=ue=>[ue[0]/ue[2],ue[1]/ue[2],1],v=[...e.point,1],S=[...i.point,1],M=[...e.vector,0],F=[...i.vector,0],L=_(M,F,.5),N=[L[1],-L[0],0],k=p(v,n(v,M)),G=p(S,n(S,F)),H=p(v,n(v,N)),z=b(p(H,G)),W=_(v,z,.5),Y=[...s,1],Z=n(W,g(L,y(L,a(Y,W)))),Q=n(Z,g(L,.15)),se=p(Q,n(Q,N)),$=b(p(k,se)),oe=b(p(G,se));return[{point:[$[0],$[1]],vector:e.vector},{point:[oe[0],oe[1]],vector:i.vector},{point:Q,vector:L}]}buildLine(e,i){let[s,n]=[Math.abs(e),Math.abs(i)],a=!1;s<n&&([s,n]=[n,s],a=!0);let p=[],_=0,g=0,y=2*n,b=y-s;for(;_<s-2;_++)p.push([_,g]),b+=y,b>=0&&(g++,b-=2*s);return a&&(p=p.map(v=>[v[1],v[0]])),e<0&&p.forEach(v=>{v[0]*=-1}),i<0&&p.forEach(v=>{v[1]*=-1}),p}buildCircle(e){let i=e,s=0,n=3-2*e;for(;s<i;)this.circlePoints.push([i,s]),s++,n>0?(i--,n=n+4*(s-i)+10):n=n+4*s+6;s--;for(let a=s;a>=0;a--){const p=this.circlePoints[a];this.circlePoints.push([p[1],p[0]])}for(let a=2*s;a>=0;a--){const p=this.circlePoints[a];this.circlePoints.push([-p[0],p[1]])}this.circlePoints.forEach(a=>{a[0]+=32,a[1]+=32})}rotatedRect(e,i,s,n,a){const[p,_]=[i[2]-i[0],i[3]-i[1]],[g,y]=[(i[2]+i[0])*.5,(i[3]+i[1])*.5],[b,v]=[p/a.height,_/a.width],[S,M]=[Math.cos(s),Math.sin(s)],F=[S*v,-M*b,(-S*_+M*p)*.5+y,M*v,S*b,(-M*_-S*p)*.5+g,0,0];return No.transform(e,[F],"bilinear",n?"reflect":"constant",0,[a.height,a.width])}async prepare(){const{width:e,height:i}=this.modelSize,s=Lo([1,i,e,3]),n=this.model.execute(s);if(await Promise.all(n.map(async a=>{await a.data(),a.dispose()})),s.dispose(),vO()==="webgl"){const{width:a,height:p}=this.localMaxSize;this.backend=Rd(),this.localMax={variableNames:["val","dir"],outputShape:[p,a,1],userCode:`
                    void main() {
                        ivec3 c = getOutputCoords();
                        float dx = getDir(c[0], c[1], 0);
                        float dy = getDir(c[0], c[1], 1);
                        vec2 d = vec2(dx, dy) / max(abs(dx), abs(dy));
                        vec2 cf = vec2(c[1], c[0]);
                        float v0 = getVal(round(cf.y - 2.0 * d.y),
                                          round(cf.x - 2.0 * d.x), 0);
                        float v1 = getVal(round(cf.y - d.y),
                                          round(cf.x - d.x), 0);
                        float v2 = getVal(round(cf.y), round(cf.x), 0);
                        float v3 = getVal(round(cf.x + d.y),
                                          round(cf.x + d.x), 0);
                        float v4 = getVal(round(cf.y + 2.0 * d.y),
                                          round(cf.x + 2.0 * d.x), 0);
                        float vmax = max(max(v0, v1), max(v3, v4));
                        setOutput(v2 >= vmax ? v2 : 0.0);
                    }
            `};const _=Lo([p,a,1]),g=this.backend.compileAndRun(this.localMax,[_,_]),y=Va().makeTensorFromTensorInfo(g);_.dispose(),y.dispose()}}async dispose(){var e;(e=this.model)==null||e.dispose()}}var v8=Object.defineProperty,T8=(l,e,i)=>e in l?v8(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,v0=(l,e,i)=>(T8(l,typeof e!="symbol"?e+"":e,i),i);class E8{constructor(){v0(this,"freq",30),v0(this,"pixelParams",{minCutOff:2,minCutOffD:4,beta:50}),v0(this,"metricParams",{minCutOff:.1,minCutOffD:1,beta:20}),v0(this,"scoreCutOff",1),v0(this,"visibilityCutOff",1),v0(this,"raw"),v0(this,"smooth"),v0(this,"der"),v0(this,"time",0)}filter(e,i,s=1){if(this.time>=i)return e;if(this.time!==0&&(this.freq=1/(i-this.time)),this.time=i,!this.raw||!this.smooth||!this.der)return this.raw=this.clonePose(e),this.smooth=this.clonePose(e),this.der={keypoints:e.keypoints.map(()=>({pixel:[0,0,0],metric:[0,0,0]})),score:0,handedness:.5,wrist:{lines:e.wrist.lines.map(()=>({point:[0,0],vector:[0,0]}))}},this.clonePose(this.smooth);const n=[...this.smooth.keypoints[0].pixel];this.filterKeypoints(e.keypoints,this.raw.keypoints,this.der.keypoints,this.smooth.keypoints,s);const a=[...this.smooth.keypoints[0].pixel],{raw:p,smooth:_,der:g}=this;for(let b=0;b<e.wrist.lines.length;b++){const v=e.wrist.lines[b],S=p.wrist.lines[b],M=g.wrist.lines[b],F=_.wrist.lines[b];if(isNaN(F.point[0])||isNaN(F.point[0])||isNaN(F.vector[0])||isNaN(F.vector[0])){F.point=[...v.point],F.vector=[...v.vector];continue}if(isNaN(v.point[0])||isNaN(v.point[0])||isNaN(v.vector[0])||isNaN(v.vector[0])){F.point[0]+=a[0]-n[0],F.point[1]+=a[1]-n[1];continue}this.filterCoord2D(v.point,S.point,M.point,F.point,s,{minCutOff:.5,minCutOffD:4,beta:75}),this.filterCoord2D(v.vector,S.vector,M.vector,F.vector,s,{minCutOff:.1,minCutOffD:.5,beta:10});const L=Math.sqrt(F.vector[0]**2+F.vector[1]**2);F.vector[0]/=L,F.vector[1]/=L}const y=this.alpha(this.scoreCutOff);return this.smooth.score=this.smooth.score+y*(e.score-this.smooth.score),this.smooth.debug=e.debug&&{box:{box:[[...e.debug.box.box[0]],[...e.debug.box.box[1]]],points:e.debug.box.points.map(b=>[...b]),start:[...e.debug.box.start],end:[...e.debug.box.end]},circle:e.debug.circle,anchors:e.debug.anchors,tensors:e.debug.tensors},this.clonePose(this.smooth)}filterKeypoints(e,i,s,n,a){for(let p=0;p<e.length;p++)this.filterCoord3D(e[p].pixel,i[p].pixel,s[p].pixel,n[p].pixel,a,this.pixelParams),this.filterCoord3D(e[p].metric,i[p].metric,s[p].metric,n[p].metric,a,this.metricParams)}filterCoord3D(e,i,s,n,a,p){const _=[(e[0]-n[0])*a*this.freq,(e[1]-n[1])*a*this.freq,(e[2]-n[2])*a*this.freq],g=this.alpha(p.minCutOffD);s[0]=s[0]+g*(_[0]-s[0]),s[1]=s[1]+g*(_[1]-s[1]),s[2]=s[2]+g*(_[2]-s[2]);const y=[this.alpha(p.minCutOff+p.beta*Math.abs(s[0])),this.alpha(p.minCutOff+p.beta*Math.abs(s[1])),this.alpha(p.minCutOff+p.beta*Math.abs(s[2]))];n[0]=n[0]+y[0]*(e[0]-n[0]),n[1]=n[1]+y[1]*(e[1]-n[1]),n[2]=n[2]+y[2]*(e[2]-n[2]),i[0]=e[0],i[1]=e[1],i[2]=e[2]}filterCoord2D(e,i,s,n,a,p){const _=[(e[0]-n[0])*a*this.freq,(e[1]-n[1])*a*this.freq],g=this.alpha(p.minCutOffD);s[0]=s[0]+g*(_[0]-s[0]),s[1]=s[1]+g*(_[1]-s[1]);const y=[this.alpha(p.minCutOff+p.beta*Math.abs(s[0])),this.alpha(p.minCutOff+p.beta*Math.abs(s[1]))];n[0]=n[0]+y[0]*(e[0]-n[0]),n[1]=n[1]+y[1]*(e[1]-n[1]),i[0]=e[0],i[1]=e[1]}reset(){delete this.raw,delete this.smooth,delete this.der}alpha(e){return 1/(1+this.freq/(2*Math.PI*e))}clonePose(e){return{keypoints:e.keypoints.map(i=>({pixel:[...i.pixel],metric:[...i.metric]})),score:e.score,handedness:e.handedness,wrist:{lines:e.wrist.lines.map(i=>({point:[...i.point],vector:[...i.vector]}))},debug:e.debug&&{box:{box:[[...e.debug.box.box[0]],[...e.debug.box.box[1]]],points:e.debug.box.points.map(i=>[...i]),start:[...e.debug.box.start],end:[...e.debug.box.end]},circle:e.debug.circle.map(i=>[...i]),anchors:e.debug.anchors.map(i=>[...i]),tensors:e.debug.tensors}}}}var zT={};(function(l){var e=l;typeof c0<"u"&&(c0.numeric=e),e.version="1.2.6",e.bench=function(i,s){var n,a,p,_;for(typeof s>"u"&&(s=15),p=.5,n=new Date;;){for(p*=2,_=p;_>3;_-=4)i(),i(),i(),i();for(;_>0;)i(),_--;if(a=new Date,a-n>s)break}for(_=p;_>3;_-=4)i(),i(),i(),i();for(;_>0;)i(),_--;return a=new Date,1e3*(3*p-1)/(a-n)},e._myIndexOf=function(i){var s=this.length,n;for(n=0;n<s;++n)if(this[n]===i)return n;return-1},e.myIndexOf=Array.prototype.indexOf?Array.prototype.indexOf:e._myIndexOf,e.Function=Function,e.precision=4,e.largeArray=50,e.prettyPrint=function(i){function s(p){if(p===0)return"0";if(isNaN(p))return"NaN";if(p<0)return"-"+s(-p);if(isFinite(p)){var _=Math.floor(Math.log(p)/Math.log(10)),g=p/Math.pow(10,_),y=g.toPrecision(e.precision);return parseFloat(y)===10&&(_++,g=1,y=g.toPrecision(e.precision)),parseFloat(y).toString()+"e"+_.toString()}return"Infinity"}var n=[];function a(p){var _;if(typeof p>"u")return n.push(Array(e.precision+8).join(" ")),!1;if(typeof p=="string")return n.push('"'+p+'"'),!1;if(typeof p=="boolean")return n.push(p.toString()),!1;if(typeof p=="number"){var g=s(p),y=p.toPrecision(e.precision),b=parseFloat(p.toString()).toString(),v=[g,y,b,parseFloat(y).toString(),parseFloat(b).toString()];for(_=1;_<v.length;_++)v[_].length<g.length&&(g=v[_]);return n.push(Array(e.precision+8-g.length).join(" ")+g),!1}if(p===null)return n.push("null"),!1;if(typeof p=="function"){n.push(p.toString());var S=!1;for(_ in p)p.hasOwnProperty(_)&&(S?n.push(`,
`):n.push(`
{`),S=!0,n.push(_),n.push(`: 
`),a(p[_]));return S&&n.push(`}
`),!0}if(p instanceof Array){if(p.length>e.largeArray)return n.push("...Large Array..."),!0;var S=!1;for(n.push("["),_=0;_<p.length;_++)_>0&&(n.push(","),S&&n.push(`
 `)),S=a(p[_]);return n.push("]"),!0}n.push("{");var S=!1;for(_ in p)p.hasOwnProperty(_)&&(S&&n.push(`,
`),S=!0,n.push(_),n.push(`: 
`),a(p[_]));return n.push("}"),!0}return a(i),n.join("")},e.parseDate=function(i){function s(n){if(typeof n=="string")return Date.parse(n.replace(/-/g,"/"));if(!(n instanceof Array))throw new Error("parseDate: parameter must be arrays of strings");var a=[],p;for(p=0;p<n.length;p++)a[p]=s(n[p]);return a}return s(i)},e.parseFloat=function(i){function s(n){if(typeof n=="string")return parseFloat(n);if(!(n instanceof Array))throw new Error("parseFloat: parameter must be arrays of strings");var a=[],p;for(p=0;p<n.length;p++)a[p]=s(n[p]);return a}return s(i)},e.parseCSV=function(i){var s=i.split(`
`),n,a,p=[],_=/(([^'",]*)|('[^']*')|("[^"]*")),/g,g=/^\s*(([+-]?[0-9]+(\.[0-9]*)?(e[+-]?[0-9]+)?)|([+-]?[0-9]*(\.[0-9]+)?(e[+-]?[0-9]+)?))\s*$/,y=function(M){return M.substr(0,M.length-1)},b=0;for(a=0;a<s.length;a++){var v=(s[a]+",").match(_),S;if(v.length>0){for(p[b]=[],n=0;n<v.length;n++)S=y(v[n]),g.test(S)?p[b][n]=parseFloat(S):p[b][n]=S;b++}}return p},e.toCSV=function(i){var s=e.dim(i),n,a,p,_,g;for(p=s[0],s[1],g=[],n=0;n<p;n++){for(_=[],a=0;a<p;a++)_[a]=i[n][a].toString();g[n]=_.join(", ")}return g.join(`
`)+`
`},e.getURL=function(i){var s=new XMLHttpRequest;return s.open("GET",i,!1),s.send(),s},e.imageURL=function(i){function s(G){var H=G.length,z,W,Y,Z,Q,se,$,oe,ue="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",de="";for(z=0;z<H;z+=3)W=G[z],Y=G[z+1],Z=G[z+2],Q=W>>2,se=((W&3)<<4)+(Y>>4),$=((Y&15)<<2)+(Z>>6),oe=Z&63,z+1>=H?$=oe=64:z+2>=H&&(oe=64),de+=ue.charAt(Q)+ue.charAt(se)+ue.charAt($)+ue.charAt(oe);return de}function n(G,H,z){typeof H>"u"&&(H=0),typeof z>"u"&&(z=G.length);var W=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117],Y=-1,Z=0;G.length;var Q;for(Q=H;Q<z;Q++)Z=(Y^G[Q])&255,Y=Y>>>8^W[Z];return Y^-1}var a=i[0].length,p=i[0][0].length,_,g,y,b,v,S,M,F,L,N,k=[137,80,78,71,13,10,26,10,0,0,0,13,73,72,68,82,p>>24&255,p>>16&255,p>>8&255,p&255,a>>24&255,a>>16&255,a>>8&255,a&255,8,2,0,0,0,-1,-2,-3,-4,-5,-6,-7,-8,73,68,65,84,8,29];for(N=n(k,12,29),k[29]=N>>24&255,k[30]=N>>16&255,k[31]=N>>8&255,k[32]=N&255,_=1,g=0,M=0;M<a;M++){for(M<a-1?k.push(0):k.push(1),v=3*p+1+(M===0)&255,S=3*p+1+(M===0)>>8&255,k.push(v),k.push(S),k.push(~v&255),k.push(~S&255),M===0&&k.push(0),F=0;F<p;F++)for(y=0;y<3;y++)v=i[y][M][F],v>255?v=255:v<0?v=0:v=Math.round(v),_=(_+v)%65521,g=(g+_)%65521,k.push(v);k.push(0)}return L=(g<<16)+_,k.push(L>>24&255),k.push(L>>16&255),k.push(L>>8&255),k.push(L&255),b=k.length-41,k[33]=b>>24&255,k[34]=b>>16&255,k[35]=b>>8&255,k[36]=b&255,N=n(k,37),k.push(N>>24&255),k.push(N>>16&255),k.push(N>>8&255),k.push(N&255),k.push(0),k.push(0),k.push(0),k.push(0),k.push(73),k.push(69),k.push(78),k.push(68),k.push(174),k.push(66),k.push(96),k.push(130),"data:image/png;base64,"+s(k)},e._dim=function(i){for(var s=[];typeof i=="object";)s.push(i.length),i=i[0];return s},e.dim=function(i){var s,n;return typeof i=="object"?(s=i[0],typeof s=="object"?(n=s[0],typeof n=="object"?e._dim(i):[i.length,s.length]):[i.length]):[]},e.mapreduce=function(i,s){return Function("x","accum","_s","_k",'if(typeof accum === "undefined") accum = '+s+`;
if(typeof x === "number") { var xi = x; `+i+`; return accum; }
if(typeof _s === "undefined") _s = numeric.dim(x);
if(typeof _k === "undefined") _k = 0;
var _n = _s[_k];
var i,xi;
if(_k < _s.length-1) {
    for(i=_n-1;i>=0;i--) {
        accum = arguments.callee(x[i],accum,_s,_k+1);
    }    return accum;
}
for(i=_n-1;i>=1;i-=2) { 
    xi = x[i];
    `+i+`;
    xi = x[i-1];
    `+i+`;
}
if(i === 0) {
    xi = x[i];
    `+i+`
}
return accum;`)},e.mapreduce2=function(i,s){return Function("x",`var n = x.length;
var i,xi;
`+s+`;
for(i=n-1;i!==-1;--i) { 
    xi = x[i];
    `+i+`;
}
return accum;`)},e.same=function i(s,n){var a,p;if(!(s instanceof Array)||!(n instanceof Array)||(p=s.length,p!==n.length))return!1;for(a=0;a<p;a++)if(s[a]!==n[a])if(typeof s[a]=="object"){if(!i(s[a],n[a]))return!1}else return!1;return!0},e.rep=function(i,s,n){typeof n>"u"&&(n=0);var a=i[n],p=Array(a),_;if(n===i.length-1){for(_=a-2;_>=0;_-=2)p[_+1]=s,p[_]=s;return _===-1&&(p[0]=s),p}for(_=a-1;_>=0;_--)p[_]=e.rep(i,s,n+1);return p},e.dotMMsmall=function(i,s){var n,a,p,_,g,y,b,v,S,M,F;for(_=i.length,g=s.length,y=s[0].length,b=Array(_),n=_-1;n>=0;n--){for(v=Array(y),S=i[n],p=y-1;p>=0;p--){for(M=S[g-1]*s[g-1][p],a=g-2;a>=1;a-=2)F=a-1,M+=S[a]*s[a][p]+S[F]*s[F][p];a===0&&(M+=S[0]*s[0][p]),v[p]=M}b[n]=v}return b},e._getCol=function(i,s,n){var a=i.length,p;for(p=a-1;p>0;--p)n[p]=i[p][s],--p,n[p]=i[p][s];p===0&&(n[0]=i[0][s])},e.dotMMbig=function(i,s){var n=e._getCol,a=s.length,p=Array(a),_=i.length,g=s[0].length,y=new Array(_),b,v=e.dotVV,S,M;for(--a,--_,S=_;S!==-1;--S)y[S]=Array(g);for(--g,S=g;S!==-1;--S)for(n(s,S,p),M=_;M!==-1;--M)b=i[M],y[M][S]=v(b,p);return y},e.dotMV=function(i,s){var n=i.length;s.length;var a,p=Array(n),_=e.dotVV;for(a=n-1;a>=0;a--)p[a]=_(i[a],s);return p},e.dotVM=function(i,s){var n,a,p,_,g,y,b;for(p=i.length,_=s[0].length,g=Array(_),a=_-1;a>=0;a--){for(y=i[p-1]*s[p-1][a],n=p-2;n>=1;n-=2)b=n-1,y+=i[n]*s[n][a]+i[b]*s[b][a];n===0&&(y+=i[0]*s[0][a]),g[a]=y}return g},e.dotVV=function(i,s){var n,a=i.length,p,_=i[a-1]*s[a-1];for(n=a-2;n>=1;n-=2)p=n-1,_+=i[n]*s[n]+i[p]*s[p];return n===0&&(_+=i[0]*s[0]),_},e.dot=function(i,s){var n=e.dim;switch(n(i).length*1e3+n(s).length){case 2002:return s.length<10?e.dotMMsmall(i,s):e.dotMMbig(i,s);case 2001:return e.dotMV(i,s);case 1002:return e.dotVM(i,s);case 1001:return e.dotVV(i,s);case 1e3:return e.mulVS(i,s);case 1:return e.mulSV(i,s);case 0:return i*s;default:throw new Error("numeric.dot only works on vectors and matrices")}},e.diag=function(i){var s,n,a,p=i.length,_=Array(p),g;for(s=p-1;s>=0;s--){for(g=Array(p),n=s+2,a=p-1;a>=n;a-=2)g[a]=0,g[a-1]=0;for(a>s&&(g[a]=0),g[s]=i[s],a=s-1;a>=1;a-=2)g[a]=0,g[a-1]=0;a===0&&(g[0]=0),_[s]=g}return _},e.getDiag=function(i){var s=Math.min(i.length,i[0].length),n,a=Array(s);for(n=s-1;n>=1;--n)a[n]=i[n][n],--n,a[n]=i[n][n];return n===0&&(a[0]=i[0][0]),a},e.identity=function(i){return e.diag(e.rep([i],1))},e.pointwise=function(i,s,n){typeof n>"u"&&(n="");var a=[],p,_=/\[i\]$/,g,y="",b=!1;for(p=0;p<i.length;p++)_.test(i[p])?(g=i[p].substring(0,i[p].length-3),y=g):g=i[p],g==="ret"&&(b=!0),a.push(g);return a[i.length]="_s",a[i.length+1]="_k",a[i.length+2]='if(typeof _s === "undefined") _s = numeric.dim('+y+`);
if(typeof _k === "undefined") _k = 0;
var _n = _s[_k];
var i`+(b?"":", ret = Array(_n)")+`;
if(_k < _s.length-1) {
    for(i=_n-1;i>=0;i--) ret[i] = arguments.callee(`+i.join(",")+`,_s,_k+1);
    return ret;
}
`+n+`
for(i=_n-1;i!==-1;--i) {
    `+s+`
}
return ret;`,Function.apply(null,a)},e.pointwise2=function(i,s,n){typeof n>"u"&&(n="");var a=[],p,_=/\[i\]$/,g,y="",b=!1;for(p=0;p<i.length;p++)_.test(i[p])?(g=i[p].substring(0,i[p].length-3),y=g):g=i[p],g==="ret"&&(b=!0),a.push(g);return a[i.length]="var _n = "+y+`.length;
var i`+(b?"":", ret = Array(_n)")+`;
`+n+`
for(i=_n-1;i!==-1;--i) {
`+s+`
}
return ret;`,Function.apply(null,a)},e._biforeach=function i(s,n,a,p,_){if(p===a.length-1){_(s,n);return}var g,y=a[p];for(g=y-1;g>=0;g--)i(typeof s=="object"?s[g]:s,typeof n=="object"?n[g]:n,a,p+1,_)},e._biforeach2=function i(s,n,a,p,_){if(p===a.length-1)return _(s,n);var g,y=a[p],b=Array(y);for(g=y-1;g>=0;--g)b[g]=i(typeof s=="object"?s[g]:s,typeof n=="object"?n[g]:n,a,p+1,_);return b},e._foreach=function i(s,n,a,p){if(a===n.length-1){p(s);return}var _,g=n[a];for(_=g-1;_>=0;_--)i(s[_],n,a+1,p)},e._foreach2=function i(s,n,a,p){if(a===n.length-1)return p(s);var _,g=n[a],y=Array(g);for(_=g-1;_>=0;_--)y[_]=i(s[_],n,a+1,p);return y},e.ops2={add:"+",sub:"-",mul:"*",div:"/",mod:"%",and:"&&",or:"||",eq:"===",neq:"!==",lt:"<",gt:">",leq:"<=",geq:">=",band:"&",bor:"|",bxor:"^",lshift:"<<",rshift:">>",rrshift:">>>"},e.opseq={addeq:"+=",subeq:"-=",muleq:"*=",diveq:"/=",modeq:"%=",lshifteq:"<<=",rshifteq:">>=",rrshifteq:">>>=",bandeq:"&=",boreq:"|=",bxoreq:"^="},e.mathfuns=["abs","acos","asin","atan","ceil","cos","exp","floor","log","round","sin","sqrt","tan","isNaN","isFinite"],e.mathfuns2=["atan2","pow","max","min"],e.ops1={neg:"-",not:"!",bnot:"~",clone:""},e.mapreducers={any:["if(xi) return true;","var accum = false;"],all:["if(!xi) return false;","var accum = true;"],sum:["accum += xi;","var accum = 0;"],prod:["accum *= xi;","var accum = 1;"],norm2Squared:["accum += xi*xi;","var accum = 0;"],norminf:["accum = max(accum,abs(xi));","var accum = 0, max = Math.max, abs = Math.abs;"],norm1:["accum += abs(xi)","var accum = 0, abs = Math.abs;"],sup:["accum = max(accum,xi);","var accum = -Infinity, max = Math.max;"],inf:["accum = min(accum,xi);","var accum = Infinity, min = Math.min;"]},function(){var i,s;for(i=0;i<e.mathfuns2.length;++i)s=e.mathfuns2[i],e.ops2[s]=s;for(i in e.ops2)if(e.ops2.hasOwnProperty(i)){s=e.ops2[i];var n,a,p="";e.myIndexOf.call(e.mathfuns2,i)!==-1?(p="var "+s+" = Math."+s+`;
`,n=function(_,g,y){return _+" = "+s+"("+g+","+y+")"},a=function(_,g){return _+" = "+s+"("+_+","+g+")"}):(n=function(_,g,y){return _+" = "+g+" "+s+" "+y},e.opseq.hasOwnProperty(i+"eq")?a=function(_,g){return _+" "+s+"= "+g}:a=function(_,g){return _+" = "+_+" "+s+" "+g}),e[i+"VV"]=e.pointwise2(["x[i]","y[i]"],n("ret[i]","x[i]","y[i]"),p),e[i+"SV"]=e.pointwise2(["x","y[i]"],n("ret[i]","x","y[i]"),p),e[i+"VS"]=e.pointwise2(["x[i]","y"],n("ret[i]","x[i]","y"),p),e[i]=Function(`var n = arguments.length, i, x = arguments[0], y;
var VV = numeric.`+i+"VV, VS = numeric."+i+"VS, SV = numeric."+i+`SV;
var dim = numeric.dim;
for(i=1;i!==n;++i) { 
  y = arguments[i];
  if(typeof x === "object") {
      if(typeof y === "object") x = numeric._biforeach2(x,y,dim(x),0,VV);
      else x = numeric._biforeach2(x,y,dim(x),0,VS);
  } else if(typeof y === "object") x = numeric._biforeach2(x,y,dim(y),0,SV);
  else `+a("x","y")+`
}
return x;
`),e[s]=e[i],e[i+"eqV"]=e.pointwise2(["ret[i]","x[i]"],a("ret[i]","x[i]"),p),e[i+"eqS"]=e.pointwise2(["ret[i]","x"],a("ret[i]","x"),p),e[i+"eq"]=Function(`var n = arguments.length, i, x = arguments[0], y;
var V = numeric.`+i+"eqV, S = numeric."+i+`eqS
var s = numeric.dim(x);
for(i=1;i!==n;++i) { 
  y = arguments[i];
  if(typeof y === "object") numeric._biforeach(x,y,s,0,V);
  else numeric._biforeach(x,y,s,0,S);
}
return x;
`)}for(i=0;i<e.mathfuns2.length;++i)s=e.mathfuns2[i],delete e.ops2[s];for(i=0;i<e.mathfuns.length;++i)s=e.mathfuns[i],e.ops1[s]=s;for(i in e.ops1)e.ops1.hasOwnProperty(i)&&(p="",s=e.ops1[i],e.myIndexOf.call(e.mathfuns,i)!==-1&&Math.hasOwnProperty(s)&&(p="var "+s+" = Math."+s+`;
`),e[i+"eqV"]=e.pointwise2(["ret[i]"],"ret[i] = "+s+"(ret[i]);",p),e[i+"eq"]=Function("x",'if(typeof x !== "object") return '+s+`x
var i;
var V = numeric.`+i+`eqV;
var s = numeric.dim(x);
numeric._foreach(x,s,0,V);
return x;
`),e[i+"V"]=e.pointwise2(["x[i]"],"ret[i] = "+s+"(x[i]);",p),e[i]=Function("x",'if(typeof x !== "object") return '+s+`(x)
var i;
var V = numeric.`+i+`V;
var s = numeric.dim(x);
return numeric._foreach2(x,s,0,V);
`));for(i=0;i<e.mathfuns.length;++i)s=e.mathfuns[i],delete e.ops1[s];for(i in e.mapreducers)e.mapreducers.hasOwnProperty(i)&&(s=e.mapreducers[i],e[i+"V"]=e.mapreduce2(s[0],s[1]),e[i]=Function("x","s","k",s[1]+`if(typeof x !== "object") {    xi = x;
`+s[0]+`;
    return accum;
}if(typeof s === "undefined") s = numeric.dim(x);
if(typeof k === "undefined") k = 0;
if(k === s.length-1) return numeric.`+i+`V(x);
var xi;
var n = x.length, i;
for(i=n-1;i!==-1;--i) {
   xi = arguments.callee(x[i]);
`+s[0]+`;
}
return accum;
`))}(),e.truncVV=e.pointwise(["x[i]","y[i]"],"ret[i] = round(x[i]/y[i])*y[i];","var round = Math.round;"),e.truncVS=e.pointwise(["x[i]","y"],"ret[i] = round(x[i]/y)*y;","var round = Math.round;"),e.truncSV=e.pointwise(["x","y[i]"],"ret[i] = round(x/y[i])*y[i];","var round = Math.round;"),e.trunc=function(i,s){return typeof i=="object"?typeof s=="object"?e.truncVV(i,s):e.truncVS(i,s):typeof s=="object"?e.truncSV(i,s):Math.round(i/s)*s},e.inv=function(N){var s=e.dim(N),n=Math.abs,a=s[0],p=s[1],_=e.clone(N),g,y,b=e.identity(a),v,S,M,F,L,N;for(F=0;F<p;++F){var k=-1,G=-1;for(M=F;M!==a;++M)L=n(_[M][F]),L>G&&(k=M,G=L);for(y=_[k],_[k]=_[F],_[F]=y,S=b[k],b[k]=b[F],b[F]=S,N=y[F],L=F;L!==p;++L)y[L]/=N;for(L=p-1;L!==-1;--L)S[L]/=N;for(M=a-1;M!==-1;--M)if(M!==F){for(g=_[M],v=b[M],N=g[F],L=F+1;L!==p;++L)g[L]-=y[L]*N;for(L=p-1;L>0;--L)v[L]-=S[L]*N,--L,v[L]-=S[L]*N;L===0&&(v[0]-=S[0]*N)}}return b},e.det=function(i){var s=e.dim(i);if(s.length!==2||s[0]!==s[1])throw new Error("numeric: det() only works on square matrices");var n=s[0],a=1,p,_,g,y=e.clone(i),b,v,S,M,F;for(_=0;_<n-1;_++){for(g=_,p=_+1;p<n;p++)Math.abs(y[p][_])>Math.abs(y[g][_])&&(g=p);for(g!==_&&(M=y[g],y[g]=y[_],y[_]=M,a*=-1),b=y[_],p=_+1;p<n;p++){for(v=y[p],S=v[_]/b[_],g=_+1;g<n-1;g+=2)F=g+1,v[g]-=b[g]*S,v[F]-=b[F]*S;g!==n&&(v[g]-=b[g]*S)}if(b[_]===0)return 0;a*=b[_]}return a*y[_][_]},e.transpose=function(i){var s,n,a=i.length,p=i[0].length,_=Array(p),g,y,b;for(n=0;n<p;n++)_[n]=Array(a);for(s=a-1;s>=1;s-=2){for(y=i[s],g=i[s-1],n=p-1;n>=1;--n)b=_[n],b[s]=y[n],b[s-1]=g[n],--n,b=_[n],b[s]=y[n],b[s-1]=g[n];n===0&&(b=_[0],b[s]=y[0],b[s-1]=g[0])}if(s===0){for(g=i[0],n=p-1;n>=1;--n)_[n][0]=g[n],--n,_[n][0]=g[n];n===0&&(_[0][0]=g[0])}return _},e.negtranspose=function(i){var s,n,a=i.length,p=i[0].length,_=Array(p),g,y,b;for(n=0;n<p;n++)_[n]=Array(a);for(s=a-1;s>=1;s-=2){for(y=i[s],g=i[s-1],n=p-1;n>=1;--n)b=_[n],b[s]=-y[n],b[s-1]=-g[n],--n,b=_[n],b[s]=-y[n],b[s-1]=-g[n];n===0&&(b=_[0],b[s]=-y[0],b[s-1]=-g[0])}if(s===0){for(g=i[0],n=p-1;n>=1;--n)_[n][0]=-g[n],--n,_[n][0]=-g[n];n===0&&(_[0][0]=-g[0])}return _},e._random=function i(s,n){var a,p=s[n],_=Array(p),g;if(n===s.length-1){for(g=Math.random,a=p-1;a>=1;a-=2)_[a]=g(),_[a-1]=g();return a===0&&(_[0]=g()),_}for(a=p-1;a>=0;a--)_[a]=i(s,n+1);return _},e.random=function(i){return e._random(i,0)},e.norm2=function(i){return Math.sqrt(e.norm2Squared(i))},e.linspace=function(i,s,n){if(typeof n>"u"&&(n=Math.max(Math.round(s-i)+1,1)),n<2)return n===1?[i]:[];var a,p=Array(n);for(n--,a=n;a>=0;a--)p[a]=(a*s+(n-a)*i)/n;return p},e.getBlock=function(i,s,n){var a=e.dim(i);function p(_,g){var y,b=s[g],v=n[g]-b,S=Array(v);if(g===a.length-1){for(y=v;y>=0;y--)S[y]=_[y+b];return S}for(y=v;y>=0;y--)S[y]=p(_[y+b],g+1);return S}return p(i,0)},e.setBlock=function(i,s,n,a){var p=e.dim(i);function _(g,y,b){var v,S=s[b],M=n[b]-S;if(b===p.length-1)for(v=M;v>=0;v--)g[v+S]=y[v];for(v=M;v>=0;v--)_(g[v+S],y[v],b+1)}return _(i,a,0),i},e.getRange=function(i,s,n){var a=s.length,p=n.length,_,g,y=Array(a),b,v;for(_=a-1;_!==-1;--_)for(y[_]=Array(p),b=y[_],v=i[s[_]],g=p-1;g!==-1;--g)b[g]=v[n[g]];return y},e.blockMatrix=function(i){var s=e.dim(i);if(s.length<4)return e.blockMatrix([i]);var n=s[0],a=s[1],p,_,g,y,b;for(p=0,_=0,g=0;g<n;++g)p+=i[g][0].length;for(y=0;y<a;++y)_+=i[0][y][0].length;var v=Array(p);for(g=0;g<p;++g)v[g]=Array(_);var S=0,M,F,L,N,k;for(g=0;g<n;++g){for(M=_,y=a-1;y!==-1;--y)for(b=i[g][y],M-=b[0].length,L=b.length-1;L!==-1;--L)for(k=b[L],F=v[S+L],N=k.length-1;N!==-1;--N)F[M+N]=k[N];S+=i[g][0].length}return v},e.tensor=function(i,s){if(typeof i=="number"||typeof s=="number")return e.mul(i,s);var n=e.dim(i),a=e.dim(s);if(n.length!==1||a.length!==1)throw new Error("numeric: tensor product is only defined for vectors");var p=n[0],_=a[0],g=Array(p),y,b,v,S;for(b=p-1;b>=0;b--){for(y=Array(_),S=i[b],v=_-1;v>=3;--v)y[v]=S*s[v],--v,y[v]=S*s[v],--v,y[v]=S*s[v],--v,y[v]=S*s[v];for(;v>=0;)y[v]=S*s[v],--v;g[b]=y}return g},e.T=function(i,s){this.x=i,this.y=s},e.t=function(i,s){return new e.T(i,s)},e.Tbinop=function(i,s,n,a,p){if(e.indexOf,typeof p!="string"){var _;p="";for(_ in e)e.hasOwnProperty(_)&&(i.indexOf(_)>=0||s.indexOf(_)>=0||n.indexOf(_)>=0||a.indexOf(_)>=0)&&_.length>1&&(p+="var "+_+" = numeric."+_+`;
`)}return Function(["y"],`var x = this;
if(!(y instanceof numeric.T)) { y = new numeric.T(y); }
`+p+`
if(x.y) {  if(y.y) {    return new numeric.T(`+a+`);
  }
  return new numeric.T(`+n+`);
}
if(y.y) {
  return new numeric.T(`+s+`);
}
return new numeric.T(`+i+`);
`)},e.T.prototype.add=e.Tbinop("add(x.x,y.x)","add(x.x,y.x),y.y","add(x.x,y.x),x.y","add(x.x,y.x),add(x.y,y.y)"),e.T.prototype.sub=e.Tbinop("sub(x.x,y.x)","sub(x.x,y.x),neg(y.y)","sub(x.x,y.x),x.y","sub(x.x,y.x),sub(x.y,y.y)"),e.T.prototype.mul=e.Tbinop("mul(x.x,y.x)","mul(x.x,y.x),mul(x.x,y.y)","mul(x.x,y.x),mul(x.y,y.x)","sub(mul(x.x,y.x),mul(x.y,y.y)),add(mul(x.x,y.y),mul(x.y,y.x))"),e.T.prototype.reciprocal=function(){var i=e.mul,s=e.div;if(this.y){var n=e.add(i(this.x,this.x),i(this.y,this.y));return new e.T(s(this.x,n),s(e.neg(this.y),n))}return new vt(s(1,this.x))},e.T.prototype.div=function(i){if(i instanceof e.T||(i=new e.T(i)),i.y)return this.mul(i.reciprocal());var s=e.div;return this.y?new e.T(s(this.x,i.x),s(this.y,i.x)):new e.T(s(this.x,i.x))},e.T.prototype.dot=e.Tbinop("dot(x.x,y.x)","dot(x.x,y.x),dot(x.x,y.y)","dot(x.x,y.x),dot(x.y,y.x)","sub(dot(x.x,y.x),dot(x.y,y.y)),add(dot(x.x,y.y),dot(x.y,y.x))"),e.T.prototype.transpose=function(){var i=e.transpose,s=this.x,n=this.y;return n?new e.T(i(s),i(n)):new e.T(i(s))},e.T.prototype.transjugate=function(){var i=e.transpose,s=this.x,n=this.y;return n?new e.T(i(s),e.negtranspose(n)):new e.T(i(s))},e.Tunop=function(i,s,n){return typeof n!="string"&&(n=""),Function(`var x = this;
`+n+`
if(x.y) {  `+s+`;
}
`+i+`;
`)},e.T.prototype.exp=e.Tunop("return new numeric.T(ex)","return new numeric.T(mul(cos(x.y),ex),mul(sin(x.y),ex))","var ex = numeric.exp(x.x), cos = numeric.cos, sin = numeric.sin, mul = numeric.mul;"),e.T.prototype.conj=e.Tunop("return new numeric.T(x.x);","return new numeric.T(x.x,numeric.neg(x.y));"),e.T.prototype.neg=e.Tunop("return new numeric.T(neg(x.x));","return new numeric.T(neg(x.x),neg(x.y));","var neg = numeric.neg;"),e.T.prototype.sin=e.Tunop("return new numeric.T(numeric.sin(x.x))","return x.exp().sub(x.neg().exp()).div(new numeric.T(0,2));"),e.T.prototype.cos=e.Tunop("return new numeric.T(numeric.cos(x.x))","return x.exp().add(x.neg().exp()).div(2);"),e.T.prototype.abs=e.Tunop("return new numeric.T(numeric.abs(x.x));","return new numeric.T(numeric.sqrt(numeric.add(mul(x.x,x.x),mul(x.y,x.y))));","var mul = numeric.mul;"),e.T.prototype.log=e.Tunop("return new numeric.T(numeric.log(x.x));",`var theta = new numeric.T(numeric.atan2(x.y,x.x)), r = x.abs();
return new numeric.T(numeric.log(r.x),theta.x);`),e.T.prototype.norm2=e.Tunop("return numeric.norm2(x.x);",`var f = numeric.norm2Squared;
return Math.sqrt(f(x.x)+f(x.y));`),e.T.prototype.inv=function(){var i=this;if(typeof i.y>"u")return new e.T(e.inv(i.x));var s=i.x.length,N,k,G,n=e.identity(s),a=e.rep([s,s],0),p=e.clone(i.x),_=e.clone(i.y),g,y,b,v,S,M,F,L,N,k,G,H,z,W,Y,Z,Q,se;for(N=0;N<s;N++){for(W=p[N][N],Y=_[N][N],H=W*W+Y*Y,G=N,k=N+1;k<s;k++)W=p[k][N],Y=_[k][N],z=W*W+Y*Y,z>H&&(G=k,H=z);for(G!==N&&(se=p[N],p[N]=p[G],p[G]=se,se=_[N],_[N]=_[G],_[G]=se,se=n[N],n[N]=n[G],n[G]=se,se=a[N],a[N]=a[G],a[G]=se),g=p[N],y=_[N],S=n[N],M=a[N],W=g[N],Y=y[N],k=N+1;k<s;k++)Z=g[k],Q=y[k],g[k]=(Z*W+Q*Y)/H,y[k]=(Q*W-Z*Y)/H;for(k=0;k<s;k++)Z=S[k],Q=M[k],S[k]=(Z*W+Q*Y)/H,M[k]=(Q*W-Z*Y)/H;for(k=N+1;k<s;k++){for(b=p[k],v=_[k],F=n[k],L=a[k],W=b[N],Y=v[N],G=N+1;G<s;G++)Z=g[G],Q=y[G],b[G]-=Z*W-Q*Y,v[G]-=Q*W+Z*Y;for(G=0;G<s;G++)Z=S[G],Q=M[G],F[G]-=Z*W-Q*Y,L[G]-=Q*W+Z*Y}}for(N=s-1;N>0;N--)for(S=n[N],M=a[N],k=N-1;k>=0;k--)for(F=n[k],L=a[k],W=p[k][N],Y=_[k][N],G=s-1;G>=0;G--)Z=S[G],Q=M[G],F[G]-=W*Z-Y*Q,L[G]-=W*Q+Y*Z;return new e.T(n,a)},e.T.prototype.get=function(i){var s=this.x,n=this.y,a=0,p,_=i.length;if(n){for(;a<_;)p=i[a],s=s[p],n=n[p],a++;return new e.T(s,n)}for(;a<_;)p=i[a],s=s[p],a++;return new e.T(s)},e.T.prototype.set=function(i,s){var n=this.x,a=this.y,p=0,_,g=i.length,y=s.x,b=s.y;if(g===0)return b?this.y=b:a&&(this.y=void 0),this.x=n,this;if(b){for(a||(a=e.rep(e.dim(n),0),this.y=a);p<g-1;)_=i[p],n=n[_],a=a[_],p++;return _=i[p],n[_]=y,a[_]=b,this}if(a){for(;p<g-1;)_=i[p],n=n[_],a=a[_],p++;return _=i[p],n[_]=y,y instanceof Array?a[_]=e.rep(e.dim(y),0):a[_]=0,this}for(;p<g-1;)_=i[p],n=n[_],p++;return _=i[p],n[_]=y,this},e.T.prototype.getRows=function(i,s){var n=s-i+1,a,p=Array(n),_,g=this.x,y=this.y;for(a=i;a<=s;a++)p[a-i]=g[a];if(y){for(_=Array(n),a=i;a<=s;a++)_[a-i]=y[a];return new e.T(p,_)}return new e.T(p)},e.T.prototype.setRows=function(i,s,n){var a,p=this.x,_=this.y,g=n.x,y=n.y;for(a=i;a<=s;a++)p[a]=g[a-i];if(y)for(_||(_=e.rep(e.dim(p),0),this.y=_),a=i;a<=s;a++)_[a]=y[a-i];else if(_)for(a=i;a<=s;a++)_[a]=e.rep([g[a-i].length],0);return this},e.T.prototype.getRow=function(i){var s=this.x,n=this.y;return n?new e.T(s[i],n[i]):new e.T(s[i])},e.T.prototype.setRow=function(i,s){var n=this.x,a=this.y,p=s.x,_=s.y;return n[i]=p,_?(a||(a=e.rep(e.dim(n),0),this.y=a),a[i]=_):a&&(a=e.rep([p.length],0)),this},e.T.prototype.getBlock=function(i,s){var n=this.x,a=this.y,p=e.getBlock;return a?new e.T(p(n,i,s),p(a,i,s)):new e.T(p(n,i,s))},e.T.prototype.setBlock=function(i,s,n){n instanceof e.T||(n=new e.T(n));var a=this.x,p=this.y,_=e.setBlock,g=n.x,y=n.y;if(y)return p||(this.y=e.rep(e.dim(this),0),p=this.y),_(a,i,s,g),_(p,i,s,y),this;_(a,i,s,g),p&&_(p,i,s,e.rep(e.dim(g),0))},e.T.rep=function(i,s){var n=e.T;s instanceof n||(s=new n(s));var a=s.x,p=s.y,_=e.rep;return p?new n(_(i,a),_(i,p)):new n(_(i,a))},e.T.diag=function(i){i instanceof e.T||(i=new e.T(i));var s=i.x,n=i.y,a=e.diag;return n?new e.T(a(s),a(n)):new e.T(a(s))},e.T.eig=function(){if(this.y)throw new Error("eig: not implemented for complex matrices.");return e.eig(this.x)},e.T.identity=function(i){return new e.T(e.identity(i))},e.T.prototype.getDiag=function(){var i=e,s=this.x,n=this.y;return n?new i.T(i.getDiag(s),i.getDiag(n)):new i.T(i.getDiag(s))},e.house=function(i){var s=e.clone(i),n=i[0]>=0?1:-1,a=n*e.norm2(i);s[0]+=a;var p=e.norm2(s);if(p===0)throw new Error("eig: internal error");return e.div(s,p)},e.toUpperHessenberg=function(i){var s=e.dim(i);if(s.length!==2||s[0]!==s[1])throw new Error("numeric: toUpperHessenberg() only works on square matrices");var n=s[0],a,p,_,g,y,b=e.clone(i),v,S,M,F,L=e.identity(n),N;for(p=0;p<n-2;p++){for(g=Array(n-p-1),a=p+1;a<n;a++)g[a-p-1]=b[a][p];if(e.norm2(g)>0){for(y=e.house(g),v=e.getBlock(b,[p+1,p],[n-1,n-1]),S=e.tensor(y,e.dot(y,v)),a=p+1;a<n;a++)for(M=b[a],F=S[a-p-1],_=p;_<n;_++)M[_]-=2*F[_-p];for(v=e.getBlock(b,[0,p+1],[n-1,n-1]),S=e.tensor(e.dot(v,y),y),a=0;a<n;a++)for(M=b[a],F=S[a],_=p+1;_<n;_++)M[_]-=2*F[_-p-1];for(v=Array(n-p-1),a=p+1;a<n;a++)v[a-p-1]=L[a];for(S=e.tensor(y,e.dot(y,v)),a=p+1;a<n;a++)for(N=L[a],F=S[a-p-1],_=0;_<n;_++)N[_]-=2*F[_]}}return{H:b,Q:L}},e.epsilon=2220446049250313e-31,e.QRFrancis=function(i,s){typeof s>"u"&&(s=1e4),i=e.clone(i),e.clone(i);var n=e.dim(i),a=n[0],p,_,g,y,b,v,S,M,F,L=e.identity(a),N,k,G,H,z,W,Y,Z,Q;if(a<3)return{Q:L,B:[[0,a-1]]};var se=e.epsilon;for(Q=0;Q<s;Q++){for(Y=0;Y<a-1;Y++)if(Math.abs(i[Y+1][Y])<se*(Math.abs(i[Y][Y])+Math.abs(i[Y+1][Y+1]))){var $=e.QRFrancis(e.getBlock(i,[0,0],[Y,Y]),s),oe=e.QRFrancis(e.getBlock(i,[Y+1,Y+1],[a-1,a-1]),s);for(G=Array(Y+1),W=0;W<=Y;W++)G[W]=L[W];for(H=e.dot($.Q,G),W=0;W<=Y;W++)L[W]=H[W];for(G=Array(a-Y-1),W=Y+1;W<a;W++)G[W-Y-1]=L[W];for(H=e.dot(oe.Q,G),W=Y+1;W<a;W++)L[W]=H[W-Y-1];return{Q:L,B:$.B.concat(e.add(oe.B,Y+1))}}if(g=i[a-2][a-2],y=i[a-2][a-1],b=i[a-1][a-2],v=i[a-1][a-1],M=g+v,S=g*v-y*b,F=e.getBlock(i,[0,0],[2,2]),M*M>=4*S){var ue,de;ue=.5*(M+Math.sqrt(M*M-4*S)),de=.5*(M-Math.sqrt(M*M-4*S)),F=e.add(e.sub(e.dot(F,F),e.mul(F,ue+de)),e.diag(e.rep([3],ue*de)))}else F=e.add(e.sub(e.dot(F,F),e.mul(F,M)),e.diag(e.rep([3],S)));for(p=[F[0][0],F[1][0],F[2][0]],_=e.house(p),G=[i[0],i[1],i[2]],H=e.tensor(_,e.dot(_,G)),W=0;W<3;W++)for(k=i[W],z=H[W],Z=0;Z<a;Z++)k[Z]-=2*z[Z];for(G=e.getBlock(i,[0,0],[a-1,2]),H=e.tensor(e.dot(G,_),_),W=0;W<a;W++)for(k=i[W],z=H[W],Z=0;Z<3;Z++)k[Z]-=2*z[Z];for(G=[L[0],L[1],L[2]],H=e.tensor(_,e.dot(_,G)),W=0;W<3;W++)for(N=L[W],z=H[W],Z=0;Z<a;Z++)N[Z]-=2*z[Z];var ye;for(Y=0;Y<a-2;Y++){for(Z=Y;Z<=Y+1;Z++)if(Math.abs(i[Z+1][Z])<se*(Math.abs(i[Z][Z])+Math.abs(i[Z+1][Z+1]))){var $=e.QRFrancis(e.getBlock(i,[0,0],[Z,Z]),s),oe=e.QRFrancis(e.getBlock(i,[Z+1,Z+1],[a-1,a-1]),s);for(G=Array(Z+1),W=0;W<=Z;W++)G[W]=L[W];for(H=e.dot($.Q,G),W=0;W<=Z;W++)L[W]=H[W];for(G=Array(a-Z-1),W=Z+1;W<a;W++)G[W-Z-1]=L[W];for(H=e.dot(oe.Q,G),W=Z+1;W<a;W++)L[W]=H[W-Z-1];return{Q:L,B:$.B.concat(e.add(oe.B,Z+1))}}for(ye=Math.min(a-1,Y+3),p=Array(ye-Y),W=Y+1;W<=ye;W++)p[W-Y-1]=i[W][Y];for(_=e.house(p),G=e.getBlock(i,[Y+1,Y],[ye,a-1]),H=e.tensor(_,e.dot(_,G)),W=Y+1;W<=ye;W++)for(k=i[W],z=H[W-Y-1],Z=Y;Z<a;Z++)k[Z]-=2*z[Z-Y];for(G=e.getBlock(i,[0,Y+1],[a-1,ye]),H=e.tensor(e.dot(G,_),_),W=0;W<a;W++)for(k=i[W],z=H[W],Z=Y+1;Z<=ye;Z++)k[Z]-=2*z[Z-Y-1];for(G=Array(ye-Y),W=Y+1;W<=ye;W++)G[W-Y-1]=L[W];for(H=e.tensor(_,e.dot(_,G)),W=Y+1;W<=ye;W++)for(N=L[W],z=H[W-Y-1],Z=0;Z<a;Z++)N[Z]-=2*z[Z]}}throw new Error("numeric: eigenvalue iteration does not converge -- increase maxiter?")},e.eig=function(i,s){var n=e.toUpperHessenberg(i),a=e.QRFrancis(n.H,s),p=e.T,ye=i.length,_,g,y=a.B,b=e.dot(a.Q,e.dot(n.H,e.transpose(a.Q))),v=new p(e.dot(a.Q,n.Q)),S,M=y.length,F,L,N,k,G,H,z,W,Y,Z,Q,se,$,oe,ue=Math.sqrt;for(g=0;g<M;g++)if(_=y[g][0],_!==y[g][1]){if(F=_+1,L=b[_][_],N=b[_][F],k=b[F][_],G=b[F][F],N===0&&k===0)continue;H=-L-G,z=L*G-N*k,W=H*H-4*z,W>=0?(H<0?Y=-.5*(H-ue(W)):Y=-.5*(H+ue(W)),$=(L-Y)*(L-Y)+N*N,oe=k*k+(G-Y)*(G-Y),$>oe?($=ue($),Q=(L-Y)/$,se=N/$):(oe=ue(oe),Q=k/oe,se=(G-Y)/oe),S=new p([[se,-Q],[Q,se]]),v.setRows(_,F,S.dot(v.getRows(_,F)))):(Y=-.5*H,Z=.5*ue(-W),$=(L-Y)*(L-Y)+N*N,oe=k*k+(G-Y)*(G-Y),$>oe?($=ue($+Z*Z),Q=(L-Y)/$,se=N/$,Y=0,Z/=$):(oe=ue(oe+Z*Z),Q=k/oe,se=(G-Y)/oe,Y=Z/oe,Z=0),S=new p([[se,-Q],[Q,se]],[[Y,Z],[Z,-Y]]),v.setRows(_,F,S.dot(v.getRows(_,F))))}var de=v.dot(i).dot(v.transjugate()),ye=i.length,_e=e.T.identity(ye);for(F=0;F<ye;F++)if(F>0)for(g=F-1;g>=0;g--){var we=de.get([g,g]),Pe=de.get([F,F]);if(e.neq(we.x,Pe.x)||e.neq(we.y,Pe.y))Y=de.getRow(g).getBlock([g],[F-1]),Z=_e.getRow(F).getBlock([g],[F-1]),_e.set([F,g],de.get([g,F]).neg().sub(Y.dot(Z)).div(we.sub(Pe)));else{_e.setRow(F,_e.getRow(g));continue}}for(F=0;F<ye;F++)Y=_e.getRow(F),_e.setRow(F,Y.div(Y.norm2()));return _e=_e.transpose(),_e=v.transjugate().dot(_e),{lambda:de.getDiag(),E:_e}},e.ccsSparse=function(i){var s=i.length,g,n,a,p,_=[];for(a=s-1;a!==-1;--a){n=i[a];for(p in n){for(p=parseInt(p);p>=_.length;)_[_.length]=0;n[p]!==0&&_[p]++}}var g=_.length,y=Array(g+1);for(y[0]=0,a=0;a<g;++a)y[a+1]=y[a]+_[a];var b=Array(y[g]),v=Array(y[g]);for(a=s-1;a!==-1;--a){n=i[a];for(p in n)n[p]!==0&&(_[p]--,b[y[p]+_[p]]=a,v[y[p]+_[p]]=n[p])}return[y,b,v]},e.ccsFull=function(i){var s=i[0],n=i[1],a=i[2],p=e.ccsDim(i),_=p[0],g=p[1],y,b,v,S,M=e.rep([_,g],0);for(y=0;y<g;y++)for(v=s[y],S=s[y+1],b=v;b<S;++b)M[n[b]][y]=a[b];return M},e.ccsTSolve=function(i,s,n,a,p){var _=i[0],g=i[1],y=i[2],b=_.length-1,v=Math.max,S=0;typeof a>"u"&&(n=e.rep([b],0)),typeof a>"u"&&(a=e.linspace(0,n.length-1)),typeof p>"u"&&(p=[]);function M(W){var Y;if(n[W]===0){for(n[W]=1,Y=_[W];Y<_[W+1];++Y)M(g[Y]);p[S]=W,++S}}var F,L,N,k,G,H,z;for(F=a.length-1;F!==-1;--F)M(a[F]);for(p.length=S,F=p.length-1;F!==-1;--F)n[p[F]]=0;for(F=a.length-1;F!==-1;--F)L=a[F],n[L]=s[L];for(F=p.length-1;F!==-1;--F){for(L=p[F],N=_[L],k=v(_[L+1],N),G=N;G!==k;++G)if(g[G]===L){n[L]/=y[G];break}for(z=n[L],G=N;G!==k;++G)H=g[G],H!==L&&(n[H]-=z*y[G])}return n},e.ccsDFS=function(i){this.k=Array(i),this.k1=Array(i),this.j=Array(i)},e.ccsDFS.prototype.dfs=function(i,s,n,a,p,_){var g=0,y,b=p.length,v=this.k,S=this.k1,M=this.j,F,L;if(a[i]===0)for(a[i]=1,M[0]=i,v[0]=F=s[i],S[0]=L=s[i+1];;)if(F>=L){if(p[b]=M[g],g===0)return;++b,--g,F=v[g],L=S[g]}else y=_[n[F]],a[y]===0?(a[y]=1,v[g]=F,++g,M[g]=y,F=s[y],S[g]=L=s[y+1]):++F},e.ccsLPSolve=function(i,s,n,a,p,_,g){var y=i[0],b=i[1],v=i[2];y.length-1;var S=s[0],M=s[1],F=s[2],L,N,k,G,H,z,W,Y,Z;for(N=S[p],k=S[p+1],a.length=0,L=N;L<k;++L)g.dfs(_[M[L]],y,b,n,a,_);for(L=a.length-1;L!==-1;--L)n[a[L]]=0;for(L=N;L!==k;++L)G=_[M[L]],n[G]=F[L];for(L=a.length-1;L!==-1;--L){for(G=a[L],H=y[G],z=y[G+1],W=H;W<z;++W)if(_[b[W]]===G){n[G]/=v[W];break}for(Z=n[G],W=H;W<z;++W)Y=_[b[W]],Y!==G&&(n[Y]-=Z*v[W])}return n},e.ccsLUP1=function(i,s){var n=i[0].length-1,a=[e.rep([n+1],0),[],[]],p=[e.rep([n+1],0),[],[]],_=a[0],g=a[1],y=a[2],b=p[0],v=p[1],S=p[2],M=e.rep([n],0),F=e.rep([n],0),L,N,k,G,H,z,W,Y=e.ccsLPSolve,Z=Math.abs,Q=e.linspace(0,n-1),se=e.linspace(0,n-1),$=new e.ccsDFS(n);for(typeof s>"u"&&(s=1),L=0;L<n;++L){for(Y(a,i,M,F,L,se,$),G=-1,H=-1,N=F.length-1;N!==-1;--N)k=F[N],!(k<=L)&&(z=Z(M[k]),z>G&&(H=k,G=z));for(Z(M[L])<s*G&&(N=Q[L],G=Q[H],Q[L]=G,se[G]=L,Q[H]=N,se[N]=H,G=M[L],M[L]=M[H],M[H]=G),G=_[L],H=b[L],W=M[L],g[G]=Q[L],y[G]=1,++G,N=F.length-1;N!==-1;--N)k=F[N],z=M[k],F[N]=0,M[k]=0,k<=L?(v[H]=k,S[H]=z,++H):(g[G]=Q[k],y[G]=z/W,++G);_[L+1]=G,b[L+1]=H}for(N=g.length-1;N!==-1;--N)g[N]=se[g[N]];return{L:a,U:p,P:Q,Pinv:se}},e.ccsDFS0=function(i){this.k=Array(i),this.k1=Array(i),this.j=Array(i)},e.ccsDFS0.prototype.dfs=function(i,s,n,a,p,_,g){var y=0,b,v=p.length,S=this.k,M=this.k1,F=this.j,L,N;if(a[i]===0)for(a[i]=1,F[0]=i,S[0]=L=s[_[i]],M[0]=N=s[_[i]+1];;){if(isNaN(L))throw new Error("Ow!");if(L>=N){if(p[v]=_[F[y]],y===0)return;++v,--y,L=S[y],N=M[y]}else b=n[L],a[b]===0?(a[b]=1,S[y]=L,++y,F[y]=b,b=_[b],L=s[b],M[y]=N=s[b+1]):++L}},e.ccsLPSolve0=function(i,s,n,a,p,_,g,y){var b=i[0],v=i[1],S=i[2];b.length-1;var M=s[0],F=s[1],L=s[2],N,k,G,H,z,W,Y,Z,Q;for(k=M[p],G=M[p+1],a.length=0,N=k;N<G;++N)y.dfs(F[N],b,v,n,a,_,g);for(N=a.length-1;N!==-1;--N)H=a[N],n[g[H]]=0;for(N=k;N!==G;++N)H=F[N],n[H]=L[N];for(N=a.length-1;N!==-1;--N){for(H=a[N],Z=g[H],z=b[H],W=b[H+1],Y=z;Y<W;++Y)if(v[Y]===Z){n[Z]/=S[Y];break}for(Q=n[Z],Y=z;Y<W;++Y)n[v[Y]]-=Q*S[Y];n[Z]=Q}},e.ccsLUP0=function(i,s){var n=i[0].length-1,a=[e.rep([n+1],0),[],[]],p=[e.rep([n+1],0),[],[]],_=a[0],g=a[1],y=a[2],b=p[0],v=p[1],S=p[2],M=e.rep([n],0),F=e.rep([n],0),L,N,k,G,H,z,W,Y=e.ccsLPSolve0,Z=Math.abs,Q=e.linspace(0,n-1),se=e.linspace(0,n-1),$=new e.ccsDFS0(n);for(typeof s>"u"&&(s=1),L=0;L<n;++L){for(Y(a,i,M,F,L,se,Q,$),G=-1,H=-1,N=F.length-1;N!==-1;--N)k=F[N],!(k<=L)&&(z=Z(M[Q[k]]),z>G&&(H=k,G=z));for(Z(M[Q[L]])<s*G&&(N=Q[L],G=Q[H],Q[L]=G,se[G]=L,Q[H]=N,se[N]=H),G=_[L],H=b[L],W=M[Q[L]],g[G]=Q[L],y[G]=1,++G,N=F.length-1;N!==-1;--N)k=F[N],z=M[Q[k]],F[N]=0,M[Q[k]]=0,k<=L?(v[H]=k,S[H]=z,++H):(g[G]=Q[k],y[G]=z/W,++G);_[L+1]=G,b[L+1]=H}for(N=g.length-1;N!==-1;--N)g[N]=se[g[N]];return{L:a,U:p,P:Q,Pinv:se}},e.ccsLUP=e.ccsLUP0,e.ccsDim=function(i){return[e.sup(i[1])+1,i[0].length-1]},e.ccsGetBlock=function(i,s,n){var a=e.ccsDim(i),p=a[0],_=a[1];typeof s>"u"?s=e.linspace(0,p-1):typeof s=="number"&&(s=[s]),typeof n>"u"?n=e.linspace(0,_-1):typeof n=="number"&&(n=[n]);var g,y=s.length,b,v=n.length,S,M,F,L=e.rep([_],0),N=[],k=[],G=[L,N,k],H=i[0],z=i[1],W=i[2],Y=e.rep([p],0),Z=0,Q=e.rep([p],0);for(b=0;b<v;++b){M=n[b];var se=H[M],$=H[M+1];for(g=se;g<$;++g)S=z[g],Q[S]=1,Y[S]=W[g];for(g=0;g<y;++g)F=s[g],Q[F]&&(N[Z]=g,k[Z]=Y[s[g]],++Z);for(g=se;g<$;++g)S=z[g],Q[S]=0;L[b+1]=Z}return G},e.ccsDot=function(i,s){var n=i[0],a=i[1],p=i[2],_=s[0],g=s[1],y=s[2],b=e.ccsDim(i),v=e.ccsDim(s),S=b[0];b[1];var M=v[1],F=e.rep([S],0),L=e.rep([S],0),N=Array(S),k=e.rep([M],0),G=[],H=[],z=[k,G,H],W,Y,Z,Q,se,$,oe,ue,de,ye,_e;for(Z=0;Z!==M;++Z){for(Q=_[Z],se=_[Z+1],de=0,Y=Q;Y<se;++Y)for(ye=g[Y],_e=y[Y],$=n[ye],oe=n[ye+1],W=$;W<oe;++W)ue=a[W],L[ue]===0&&(N[de]=ue,L[ue]=1,de=de+1),F[ue]=F[ue]+p[W]*_e;for(Q=k[Z],se=Q+de,k[Z+1]=se,Y=de-1;Y!==-1;--Y)_e=Q+Y,W=N[Y],G[_e]=W,H[_e]=F[W],L[W]=0,F[W]=0;k[Z+1]=k[Z]+de}return z},e.ccsLUPSolve=function(i,s){var n=i.L,a=i.U;i.P;var p=s[0],_=!1;typeof p!="object"&&(s=[[0,s.length],e.linspace(0,s.length-1),s],p=s[0],_=!0);var g=s[1],y=s[2],b=n[0].length-1,v=p.length-1,S=e.rep([b],0),M=Array(b),F=e.rep([b],0),L=Array(b),N=e.rep([v+1],0),k=[],G=[],H=e.ccsTSolve,z,W,Y,Z,Q,se,$=0;for(z=0;z<v;++z){for(Q=0,Y=p[z],Z=p[z+1],W=Y;W<Z;++W)se=i.Pinv[g[W]],L[Q]=se,F[se]=y[W],++Q;for(L.length=Q,H(n,F,S,L,M),W=L.length-1;W!==-1;--W)F[L[W]]=0;if(H(a,S,F,M,L),_)return F;for(W=M.length-1;W!==-1;--W)S[M[W]]=0;for(W=L.length-1;W!==-1;--W)se=L[W],k[$]=se,G[$]=F[se],F[se]=0,++$;N[z+1]=$}return[N,k,G]},e.ccsbinop=function(i,s){return typeof s>"u"&&(s=""),Function("X","Y",`var Xi = X[0], Xj = X[1], Xv = X[2];
var Yi = Y[0], Yj = Y[1], Yv = Y[2];
var n = Xi.length-1,m = Math.max(numeric.sup(Xj),numeric.sup(Yj))+1;
var Zi = numeric.rep([n+1],0), Zj = [], Zv = [];
var x = numeric.rep([m],0),y = numeric.rep([m],0);
var xk,yk,zk;
var i,j,j0,j1,k,p=0;
`+s+`for(i=0;i<n;++i) {
  j0 = Xi[i]; j1 = Xi[i+1];
  for(j=j0;j!==j1;++j) {
    k = Xj[j];
    x[k] = 1;
    Zj[p] = k;
    ++p;
  }
  j0 = Yi[i]; j1 = Yi[i+1];
  for(j=j0;j!==j1;++j) {
    k = Yj[j];
    y[k] = Yv[j];
    if(x[k] === 0) {
      Zj[p] = k;
      ++p;
    }
  }
  Zi[i+1] = p;
  j0 = Xi[i]; j1 = Xi[i+1];
  for(j=j0;j!==j1;++j) x[Xj[j]] = Xv[j];
  j0 = Zi[i]; j1 = Zi[i+1];
  for(j=j0;j!==j1;++j) {
    k = Zj[j];
    xk = x[k];
    yk = y[k];
`+i+`
    Zv[j] = zk;
  }
  j0 = Xi[i]; j1 = Xi[i+1];
  for(j=j0;j!==j1;++j) x[Xj[j]] = 0;
  j0 = Yi[i]; j1 = Yi[i+1];
  for(j=j0;j!==j1;++j) y[Yj[j]] = 0;
}
return [Zi,Zj,Zv];`)},e.ccsScatter=function(i){var s=i[0],n=i[1],a=i[2],p=e.sup(n)+1,_=s.length,g=e.rep([p],0),y=Array(_),b=Array(_),v=e.rep([p],0),S;for(S=0;S<_;++S)v[n[S]]++;for(S=0;S<p;++S)g[S+1]=g[S]+v[S];var M=g.slice(0),F,L;for(S=0;S<_;++S)L=n[S],F=M[L],y[F]=s[S],b[F]=a[S],M[L]=M[L]+1;return[g,y,b]},e.ccsGather=function(i){var s=i[0],n=i[1],a=i[2],p=s.length-1,_=n.length,g=Array(_),y=Array(_),b=Array(_),v,S,M,F,L;for(L=0,v=0;v<p;++v)for(M=s[v],F=s[v+1],S=M;S!==F;++S)y[L]=v,g[L]=n[S],b[L]=a[S],++L;return[g,y,b]},e.sdim=function i(s,n,a){if(typeof n>"u"&&(n=[]),typeof s!="object")return n;typeof a>"u"&&(a=0),a in n||(n[a]=0),s.length>n[a]&&(n[a]=s.length);var p;for(p in s)s.hasOwnProperty(p)&&i(s[p],n,a+1);return n},e.sclone=function i(s,n,a){typeof n>"u"&&(n=0),typeof a>"u"&&(a=e.sdim(s).length);var p,_=Array(s.length);if(n===a-1){for(p in s)s.hasOwnProperty(p)&&(_[p]=s[p]);return _}for(p in s)s.hasOwnProperty(p)&&(_[p]=i(s[p],n+1,a));return _},e.sdiag=function(i){var s=i.length,n,a=Array(s),p;for(n=s-1;n>=1;n-=2)p=n-1,a[n]=[],a[n][n]=i[n],a[p]=[],a[p][p]=i[p];return n===0&&(a[0]=[],a[0][0]=i[n]),a},e.sidentity=function(i){return e.sdiag(e.rep([i],1))},e.stranspose=function(i){var s=[];i.length;var n,a,p;for(n in i)if(i.hasOwnProperty(n)){p=i[n];for(a in p)p.hasOwnProperty(a)&&(typeof s[a]!="object"&&(s[a]=[]),s[a][n]=p[a])}return s},e.sLUP=function(i,s){throw new Error("The function numeric.sLUP had a bug in it and has been removed. Please use the new numeric.ccsLUP function instead.")},e.sdotMM=function(i,s){var n=i.length;s.length;var a=e.stranspose(s),p=a.length,_,g,y,b,v,S,M=Array(n),F;for(y=n-1;y>=0;y--){for(F=[],_=i[y],v=p-1;v>=0;v--){S=0,g=a[v];for(b in _)_.hasOwnProperty(b)&&b in g&&(S+=_[b]*g[b]);S&&(F[v]=S)}M[y]=F}return M},e.sdotMV=function(i,s){var n=i.length,a,p,_,g=Array(n),y;for(p=n-1;p>=0;p--){a=i[p],y=0;for(_ in a)a.hasOwnProperty(_)&&s[_]&&(y+=a[_]*s[_]);y&&(g[p]=y)}return g},e.sdotVM=function(i,s){var n,a,p,_,g=[];for(n in i)if(i.hasOwnProperty(n)){p=s[n],_=i[n];for(a in p)p.hasOwnProperty(a)&&(g[a]||(g[a]=0),g[a]+=_*p[a])}return g},e.sdotVV=function(i,s){var n,a=0;for(n in i)i[n]&&s[n]&&(a+=i[n]*s[n]);return a},e.sdot=function(i,s){var n=e.sdim(i).length,a=e.sdim(s).length,p=n*1e3+a;switch(p){case 0:return i*s;case 1001:return e.sdotVV(i,s);case 2001:return e.sdotMV(i,s);case 1002:return e.sdotVM(i,s);case 2002:return e.sdotMM(i,s);default:throw new Error("numeric.sdot not implemented for tensors of order "+n+" and "+a)}},e.sscatter=function(i){var s=i[0].length,n,a,p,_=i.length,g=[],y;for(a=s-1;a>=0;--a)if(i[_-1][a]){for(y=g,p=0;p<_-2;p++)n=i[p][a],y[n]||(y[n]=[]),y=y[n];y[i[p][a]]=i[p+1][a]}return g},e.sgather=function i(s,n,a){typeof n>"u"&&(n=[]),typeof a>"u"&&(a=[]);var p,_,g;p=a.length;for(_ in s)if(s.hasOwnProperty(_))if(a[p]=parseInt(_),g=s[_],typeof g=="number"){if(g){if(n.length===0)for(_=p+1;_>=0;--_)n[_]=[];for(_=p;_>=0;--_)n[_].push(a[_]);n[p+1].push(g)}}else i(g,n,a);return a.length>p&&a.pop(),n},e.cLU=function(i){var s=i[0],n=i[1],a=i[2],$=s.length,p=0,_,g,y,b,v,S;for(_=0;_<$;_++)s[_]>p&&(p=s[_]);p++;var M=Array(p),F=Array(p),L=e.rep([p],1/0),N=e.rep([p],-1/0),z,W,k;for(y=0;y<$;y++)_=s[y],g=n[y],g<L[_]&&(L[_]=g),g>N[_]&&(N[_]=g);for(_=0;_<p-1;_++)N[_]>N[_+1]&&(N[_+1]=N[_]);for(_=p-1;_>=1;_--)L[_]<L[_-1]&&(L[_-1]=L[_]);var G=0,H=0;for(_=0;_<p;_++)F[_]=e.rep([N[_]-L[_]+1],0),M[_]=e.rep([_-L[_]],0),G+=_-L[_]+1,H+=N[_]-_+1;for(y=0;y<$;y++)_=s[y],F[_][n[y]-L[_]]=a[y];for(_=0;_<p-1;_++)for(b=_-L[_],z=F[_],g=_+1;L[g]<=_&&g<p;g++)if(v=_-L[g],S=N[_]-_,W=F[g],k=W[v]/z[b],k){for(y=1;y<=S;y++)W[y+v]-=k*z[y+b];M[g][_-L[g]]=k}var z=[],W=[],Y=[],Z=[],Q=[],se=[],$,oe,ue;for($=0,oe=0,_=0;_<p;_++){for(b=L[_],v=N[_],ue=F[_],g=_;g<=v;g++)ue[g-b]&&(z[$]=_,W[$]=g,Y[$]=ue[g-b],$++);for(ue=M[_],g=b;g<_;g++)ue[g-b]&&(Z[oe]=_,Q[oe]=g,se[oe]=ue[g-b],oe++);Z[oe]=_,Q[oe]=_,se[oe]=1,oe++}return{U:[z,W,Y],L:[Z,Q,se]}},e.cLUsolve=function(i,s){var n=i.L,a=i.U,p=e.clone(s),_=n[0],g=n[1],y=n[2],b=a[0],v=a[1],S=a[2],M=b.length;_.length;var F=p.length,L,N;for(N=0,L=0;L<F;L++){for(;g[N]<L;)p[L]-=y[N]*p[g[N]],N++;N++}for(N=M-1,L=F-1;L>=0;L--){for(;v[N]>L;)p[L]-=S[N]*p[v[N]],N--;p[L]/=S[N],N--}return p},e.cgrid=function(i,s){typeof i=="number"&&(i=[i,i]);var n=e.rep(i,-1),a,p,_;if(typeof s!="function")switch(s){case"L":s=function(g,y){return g>=i[0]/2||y<i[1]/2};break;default:s=function(g,y){return!0};break}for(_=0,a=1;a<i[0]-1;a++)for(p=1;p<i[1]-1;p++)s(a,p)&&(n[a][p]=_,_++);return n},e.cdelsq=function(i){var s=[[-1,0],[0,-1],[0,1],[1,0]],n=e.dim(i),a=n[0],p=n[1],_,g,y,b,v,S=[],M=[],F=[];for(_=1;_<a-1;_++)for(g=1;g<p-1;g++)if(!(i[_][g]<0)){for(y=0;y<4;y++)b=_+s[y][0],v=g+s[y][1],!(i[b][v]<0)&&(S.push(i[_][g]),M.push(i[b][v]),F.push(-1));S.push(i[_][g]),M.push(i[_][g]),F.push(4)}return[S,M,F]},e.cdotMV=function(i,s){var n,a=i[0],p=i[1],_=i[2],g,y=a.length,b;for(b=0,g=0;g<y;g++)a[g]>b&&(b=a[g]);for(b++,n=e.rep([b],0),g=0;g<y;g++)n[a[g]]+=_[g]*s[p[g]];return n},e.Spline=function(i,s,n,a,p){this.x=i,this.yl=s,this.yr=n,this.kl=a,this.kr=p},e.Spline.prototype._at=function(y,s){var n=this.x,a=this.yl,p=this.yr,_=this.kl,g=this.kr,y,b,v,S,M=e.add,F=e.sub,L=e.mul;b=F(L(_[s],n[s+1]-n[s]),F(p[s+1],a[s])),v=M(L(g[s+1],n[s]-n[s+1]),F(p[s+1],a[s])),S=(y-n[s])/(n[s+1]-n[s]);var N=S*(1-S);return M(M(M(L(1-S,a[s]),L(S,p[s+1])),L(b,N*(1-S))),L(v,N*S))},e.Spline.prototype.at=function(i){if(typeof i=="number"){var s=this.x,g=s.length,n,a,p,_=Math.floor;for(n=0,a=g-1;a-n>1;)p=_((n+a)/2),s[p]<=i?n=p:a=p;return this._at(i,n)}var g=i.length,y,b=Array(g);for(y=g-1;y!==-1;--y)b[y]=this.at(i[y]);return b},e.Spline.prototype.diff=function(){var i=this.x,s=this.yl,n=this.yr,a=this.kl,p=this.kr,_=s.length,g,y,b,v=a,S=p,M=Array(_),F=Array(_),L=e.add,N=e.mul,k=e.div,G=e.sub;for(g=_-1;g!==-1;--g)y=i[g+1]-i[g],b=G(n[g+1],s[g]),M[g]=k(L(N(b,6),N(a[g],-4*y),N(p[g+1],-2*y)),y*y),F[g+1]=k(L(N(b,-6),N(a[g],2*y),N(p[g+1],4*y)),y*y);return new e.Spline(i,v,S,M,F)},e.Spline.prototype.roots=function(){function i(et){return et*et}var k=[],s=this.x,n=this.yl,a=this.yr,p=this.kl,_=this.kr;typeof n[0]=="number"&&(n=[n],a=[a],p=[p],_=[_]);var g=n.length,y=s.length-1,b,v,S,M,F,L,N,k=Array(g),G,H,z,W,Y,Z,Q,se,$,oe,ue,de,ye,_e,we,Pe,Ee=Math.sqrt;for(b=0;b!==g;++b){for(M=n[b],F=a[b],L=p[b],N=_[b],G=[],v=0;v!==y;v++){for(v>0&&F[v]*M[v]<0&&G.push(s[v]),$=s[v+1]-s[v],s[v],W=M[v],Y=F[v+1],H=L[v]/$,z=N[v+1]/$,se=i(H-z+3*(W-Y))+12*z*W,Z=z+3*W+2*H-3*Y,Q=3*(z+H+2*(W-Y)),se<=0?(ue=Z/Q,ue>s[v]&&ue<s[v+1]?oe=[s[v],ue,s[v+1]]:oe=[s[v],s[v+1]]):(ue=(Z-Ee(se))/Q,de=(Z+Ee(se))/Q,oe=[s[v]],ue>s[v]&&ue<s[v+1]&&oe.push(ue),de>s[v]&&de<s[v+1]&&oe.push(de),oe.push(s[v+1])),_e=oe[0],ue=this._at(_e,v),S=0;S<oe.length-1;S++){if(we=oe[S+1],de=this._at(we,v),ue===0){G.push(_e),_e=we,ue=de;continue}if(de===0||ue*de>0){_e=we,ue=de;continue}for(var We=0;Pe=(ue*we-de*_e)/(ue-de),!(Pe<=_e||Pe>=we);)if(ye=this._at(Pe,v),ye*de>0)we=Pe,de=ye,We===-1&&(ue*=.5),We=-1;else if(ye*ue>0)_e=Pe,ue=ye,We===1&&(de*=.5),We=1;else break;G.push(Pe),_e=oe[S+1],ue=this._at(_e,v)}de===0&&G.push(we)}k[b]=G}return typeof this.yl[0]=="number"?k[0]:k},e.spline=function(i,s,n,a){var p=i.length,_=[],g=[],y=[],b,v=e.sub,S=e.mul,M=e.add;for(b=p-2;b>=0;b--)g[b]=i[b+1]-i[b],y[b]=v(s[b+1],s[b]);(typeof n=="string"||typeof a=="string")&&(n=a="periodic");var F=[[],[],[]];switch(typeof n){case"undefined":_[0]=S(3/(g[0]*g[0]),y[0]),F[0].push(0,0),F[1].push(0,1),F[2].push(2/g[0],1/g[0]);break;case"string":_[0]=M(S(3/(g[p-2]*g[p-2]),y[p-2]),S(3/(g[0]*g[0]),y[0])),F[0].push(0,0,0),F[1].push(p-2,0,1),F[2].push(1/g[p-2],2/g[p-2]+2/g[0],1/g[0]);break;default:_[0]=n,F[0].push(0),F[1].push(0),F[2].push(1);break}for(b=1;b<p-1;b++)_[b]=M(S(3/(g[b-1]*g[b-1]),y[b-1]),S(3/(g[b]*g[b]),y[b])),F[0].push(b,b,b),F[1].push(b-1,b,b+1),F[2].push(1/g[b-1],2/g[b-1]+2/g[b],1/g[b]);switch(typeof a){case"undefined":_[p-1]=S(3/(g[p-2]*g[p-2]),y[p-2]),F[0].push(p-1,p-1),F[1].push(p-2,p-1),F[2].push(1/g[p-2],2/g[p-2]);break;case"string":F[1][F[1].length-1]=0;break;default:_[p-1]=a,F[0].push(p-1),F[1].push(p-1),F[2].push(1);break}typeof _[0]!="number"?_=e.transpose(_):_=[_];var L=Array(_.length);if(typeof n=="string")for(b=L.length-1;b!==-1;--b)L[b]=e.ccsLUPSolve(e.ccsLUP(e.ccsScatter(F)),_[b]),L[b][p-1]=L[b][0];else for(b=L.length-1;b!==-1;--b)L[b]=e.cLUsolve(e.cLU(F),_[b]);return typeof s[0]=="number"?L=L[0]:L=e.transpose(L),new e.Spline(i,s,s,L,L)},e.fftpow2=function i(s,n){var a=s.length;if(a!==1){var p=Math.cos,_=Math.sin,g,y,b=Array(a/2),v=Array(a/2),S=Array(a/2),M=Array(a/2);for(y=a/2,g=a-1;g!==-1;--g)--y,S[y]=s[g],M[y]=n[g],--g,b[y]=s[g],v[y]=n[g];i(b,v),i(S,M),y=a/2;var F,L=-6.283185307179586/a,N,k;for(g=a-1;g!==-1;--g)--y,y===-1&&(y=a/2-1),F=L*g,N=p(F),k=_(F),s[g]=b[y]+N*S[y]-k*M[y],n[g]=v[y]+N*M[y]+k*S[y]}},e._ifftpow2=function i(s,n){var a=s.length;if(a!==1){var p=Math.cos,_=Math.sin,g,y,b=Array(a/2),v=Array(a/2),S=Array(a/2),M=Array(a/2);for(y=a/2,g=a-1;g!==-1;--g)--y,S[y]=s[g],M[y]=n[g],--g,b[y]=s[g],v[y]=n[g];i(b,v),i(S,M),y=a/2;var F,L=6.283185307179586/a,N,k;for(g=a-1;g!==-1;--g)--y,y===-1&&(y=a/2-1),F=L*g,N=p(F),k=_(F),s[g]=b[y]+N*S[y]-k*M[y],n[g]=v[y]+N*M[y]+k*S[y]}},e.ifftpow2=function(i,s){e._ifftpow2(i,s),e.diveq(i,i.length),e.diveq(s,s.length)},e.convpow2=function(i,s,n,a){e.fftpow2(i,s),e.fftpow2(n,a);var p,_=i.length,g,y,b,v;for(p=_-1;p!==-1;--p)g=i[p],b=s[p],y=n[p],v=a[p],i[p]=g*y-b*v,s[p]=g*v+b*y;e.ifftpow2(i,s)},e.T.prototype.fft=function(){var i=this.x,s=this.y,n=i.length,a=Math.log,p=a(2),_=Math.ceil(a(2*n-1)/p),g=Math.pow(2,_),y=e.rep([g],0),b=e.rep([g],0),v=Math.cos,S=Math.sin,M,F=-3.141592653589793/n,L,N=e.rep([g],0),k=e.rep([g],0);for(M=0;M<n;M++)N[M]=i[M];if(typeof s<"u")for(M=0;M<n;M++)k[M]=s[M];for(y[0]=1,M=1;M<=g/2;M++)L=F*M*M,y[M]=v(L),b[M]=S(L),y[g-M]=v(L),b[g-M]=S(L);var G=new e.T(N,k),H=new e.T(y,b);return G=G.mul(H),e.convpow2(G.x,G.y,e.clone(H.x),e.neg(H.y)),G=G.mul(H),G.x.length=n,G.y.length=n,G},e.T.prototype.ifft=function(){var i=this.x,s=this.y,n=i.length,a=Math.log,p=a(2),_=Math.ceil(a(2*n-1)/p),g=Math.pow(2,_),y=e.rep([g],0),b=e.rep([g],0),v=Math.cos,S=Math.sin,M,F=3.141592653589793/n,L,N=e.rep([g],0),k=e.rep([g],0);for(M=0;M<n;M++)N[M]=i[M];if(typeof s<"u")for(M=0;M<n;M++)k[M]=s[M];for(y[0]=1,M=1;M<=g/2;M++)L=F*M*M,y[M]=v(L),b[M]=S(L),y[g-M]=v(L),b[g-M]=S(L);var G=new e.T(N,k),H=new e.T(y,b);return G=G.mul(H),e.convpow2(G.x,G.y,e.clone(H.x),e.neg(H.y)),G=G.mul(H),G.x.length=n,G.y.length=n,G.div(n)},e.gradient=function(i,s){var n=s.length,a=i(s);if(isNaN(a))throw new Error("gradient: f(x) is a NaN!");var S=Math.max,p,_=e.clone(s),g,y,b=Array(n);e.div,e.sub;var v,S=Math.max,M=.001,F=Math.abs,L=Math.min,N,k,G,H=0,z,W,Y;for(p=0;p<n;p++)for(var Z=S(1e-6*a,1e-8);;){if(++H,H>20)throw new Error("Numerical gradient fails");if(_[p]=s[p]+Z,g=i(_),_[p]=s[p]-Z,y=i(_),_[p]=s[p],isNaN(g)||isNaN(y)){Z/=16;continue}if(b[p]=(g-y)/(2*Z),N=s[p]-Z,k=s[p],G=s[p]+Z,z=(g-a)/Z,W=(a-y)/Z,Y=S(F(b[p]),F(a),F(g),F(y),F(N),F(k),F(G),1e-8),v=L(S(F(z-b[p]),F(W-b[p]),F(z-W))/Y,Z/Y),v>M)Z/=16;else break}return b},e.uncmin=function(i,s,n,a,p,_,g){var y=e.gradient;typeof g>"u"&&(g={}),typeof n>"u"&&(n=1e-8),typeof a>"u"&&(a=function($e){return y(i,$e)}),typeof p>"u"&&(p=1e3),s=e.clone(s);var b=s.length,v=i(s),S,M;if(isNaN(v))throw new Error("uncmin: f(x0) is a NaN!");var F=Math.max,L=e.norm2;n=F(n,e.epsilon);var N,k,G,H=g.Hinv||e.identity(b),z=e.dot;e.inv;var W=e.sub,Y=e.add,Z=e.tensor,Q=e.div,se=e.mul,$=e.all,oe=e.isFinite,ue=e.neg,de=0,ye,_e,we,Pe,Ee,We,et,ke="";for(k=a(s);de<p;){if(typeof _=="function"&&_(de,s,v,k,H)){ke="Callback returned true";break}if(!$(oe(k))){ke="Gradient has Infinity or NaN";break}if(N=ue(z(H,k)),!$(oe(N))){ke="Search direction has Infinity or NaN";break}if(et=L(N),et<n){ke="Newton step smaller than tol";break}for(We=1,M=z(k,N),_e=s;de<p&&!(We*et<n);){if(ye=se(N,We),_e=Y(s,ye),S=i(_e),S-v>=.1*We*M||isNaN(S)){We*=.5,++de;continue}break}if(We*et<n){ke="Line search step size smaller than tol";break}if(de===p){ke="maxit reached during line search";break}G=a(_e),we=W(G,k),Ee=z(we,ye),Pe=z(H,we),H=W(Y(H,se((Ee+z(we,Pe))/(Ee*Ee),Z(ye,ye))),Q(Y(Z(Pe,ye),Z(ye,Pe)),Ee)),s=_e,v=S,k=G,++de}return{solution:s,f:v,gradient:k,invHessian:H,iterations:de,message:ke}},e.Dopri=function(i,s,n,a,p,_,g){this.x=i,this.y=s,this.f=n,this.ymid=a,this.iterations=p,this.events=g,this.message=_},e.Dopri.prototype._at=function(N,s){function n(se){return se*se}var a=this,p=a.x,_=a.y,g=a.f,y=a.ymid;p.length;var b,v,S,M,F,L,N,k,G=.5,H=e.add,z=e.mul,W=e.sub,Y,Z,Q;return b=p[s],v=p[s+1],M=_[s],F=_[s+1],k=v-b,S=b+G*k,L=y[s],Y=W(g[s],z(M,1/(b-S)+2/(b-v))),Z=W(g[s+1],z(F,1/(v-S)+2/(v-b))),Q=[n(N-v)*(N-S)/n(b-v)/(b-S),n(N-b)*n(N-v)/n(b-S)/n(v-S),n(N-b)*(N-S)/n(v-b)/(v-S),(N-b)*n(N-v)*(N-S)/n(b-v)/(b-S),(N-v)*n(N-b)*(N-S)/n(b-v)/(v-S)],H(H(H(H(z(M,Q[0]),z(L,Q[1])),z(F,Q[2])),z(Y,Q[3])),z(Z,Q[4]))},e.Dopri.prototype.at=function(i){var s,n,a,p=Math.floor;if(typeof i!="number"){var _=i.length,g=Array(_);for(s=_-1;s!==-1;--s)g[s]=this.at(i[s]);return g}var y=this.x;for(s=0,n=y.length-1;n-s>1;)a=p(.5*(s+n)),y[a]<=i?s=a:n=a;return this._at(i,s)},e.dopri=function(i,s,n,a,p,_,g){typeof p>"u"&&(p=1e-6),typeof _>"u"&&(_=1e3);var y=[i],b=[n],v=[a(i,n)],S,M,F,L,N,k,G=[],H=1/5,z=[3/40,9/40],W=[44/45,-56/15,32/9],Y=[19372/6561,-25360/2187,64448/6561,-212/729],Z=[9017/3168,-355/33,46732/5247,49/176,-5103/18656],Q=[35/384,0,500/1113,125/192,-2187/6784,11/84],se=[.5*6025192743/30085553152,0,.5*51252292925/65400821598,.5*-2691868925/45128329728,.5*187940372067/1594534317056,.5*-1776094331/19743644256,.5*11237099/235043384],$=[1/5,3/10,4/5,8/9,1,1],oe=[-71/57600,0,71/16695,-71/1920,17253/339200,-22/525,1/40],ue=0,de,ye,_e=(s-i)/10,we=0,Pe=e.add,Ee=e.mul,We,et,ke=Math.min,$e=Math.abs,pt=e.norminf,Xe=Math.pow,Tt=e.any,fi=e.lt,li=e.and;e.sub;var Ot,Gt,bi,si=new e.Dopri(y,b,v,G,-1,"");for(typeof g=="function"&&(Ot=g(i,n));i<s&&we<_;){if(++we,i+_e>s&&(_e=s-i),S=a(i+$[0]*_e,Pe(n,Ee(H*_e,v[ue]))),M=a(i+$[1]*_e,Pe(Pe(n,Ee(z[0]*_e,v[ue])),Ee(z[1]*_e,S))),F=a(i+$[2]*_e,Pe(Pe(Pe(n,Ee(W[0]*_e,v[ue])),Ee(W[1]*_e,S)),Ee(W[2]*_e,M))),L=a(i+$[3]*_e,Pe(Pe(Pe(Pe(n,Ee(Y[0]*_e,v[ue])),Ee(Y[1]*_e,S)),Ee(Y[2]*_e,M)),Ee(Y[3]*_e,F))),N=a(i+$[4]*_e,Pe(Pe(Pe(Pe(Pe(n,Ee(Z[0]*_e,v[ue])),Ee(Z[1]*_e,S)),Ee(Z[2]*_e,M)),Ee(Z[3]*_e,F)),Ee(Z[4]*_e,L))),We=Pe(Pe(Pe(Pe(Pe(n,Ee(v[ue],_e*Q[0])),Ee(M,_e*Q[2])),Ee(F,_e*Q[3])),Ee(L,_e*Q[4])),Ee(N,_e*Q[5])),k=a(i+_e,We),de=Pe(Pe(Pe(Pe(Pe(Ee(v[ue],_e*oe[0]),Ee(M,_e*oe[2])),Ee(F,_e*oe[3])),Ee(L,_e*oe[4])),Ee(N,_e*oe[5])),Ee(k,_e*oe[6])),typeof de=="number"?et=$e(de):et=pt(de),et>p){if(_e=.2*_e*Xe(p/et,.25),i+_e===i){si.msg="Step size became too small";break}continue}if(G[ue]=Pe(Pe(Pe(Pe(Pe(Pe(n,Ee(v[ue],_e*se[0])),Ee(M,_e*se[2])),Ee(F,_e*se[3])),Ee(L,_e*se[4])),Ee(N,_e*se[5])),Ee(k,_e*se[6])),++ue,y[ue]=i+_e,b[ue]=We,v[ue]=k,typeof g=="function"){var oi,ci=i,Li=i+.5*_e,hi;if(Gt=g(Li,G[ue-1]),bi=li(fi(Ot,0),fi(0,Gt)),Tt(bi)||(ci=Li,Li=i+_e,Ot=Gt,Gt=g(Li,We),bi=li(fi(Ot,0),fi(0,Gt))),Tt(bi)){for(var mi,cr,Ui=0,Ii=1,Cr=1;;){if(typeof Ot=="number")hi=(Cr*Gt*ci-Ii*Ot*Li)/(Cr*Gt-Ii*Ot);else for(hi=Li,ye=Ot.length-1;ye!==-1;--ye)Ot[ye]<0&&Gt[ye]>0&&(hi=ke(hi,(Cr*Gt[ye]*ci-Ii*Ot[ye]*Li)/(Cr*Gt[ye]-Ii*Ot[ye])));if(hi<=ci||hi>=Li)break;oi=si._at(hi,ue-1),cr=g(hi,oi),mi=li(fi(Ot,0),fi(0,cr)),Tt(mi)?(Li=hi,Gt=cr,bi=mi,Cr=1,Ui===-1?Ii*=.5:Ii=1,Ui=-1):(ci=hi,Ot=cr,Ii=1,Ui===1?Cr*=.5:Cr=1,Ui=1)}return We=si._at(.5*(i+hi),ue-1),si.f[ue]=a(hi,oi),si.x[ue]=hi,si.y[ue]=oi,si.ymid[ue-1]=We,si.events=bi,si.iterations=we,si}}i+=_e,n=We,Ot=Gt,_e=ke(.8*_e*Xe(p/et,.25),4*_e)}return si.iterations=we,si},e.LU=function(i,s){s=s||!1;var n=Math.abs,a,p,_,g,y,b,v,S,M,F=i.length,L=F-1,N=new Array(F);for(s||(i=e.clone(i)),_=0;_<F;++_){for(v=_,b=i[_],M=n(b[_]),p=_+1;p<F;++p)g=n(i[p][_]),M<g&&(M=g,v=p);for(N[_]=v,v!=_&&(i[_]=i[v],i[v]=b,b=i[_]),y=b[_],a=_+1;a<F;++a)i[a][_]/=y;for(a=_+1;a<F;++a){for(S=i[a],p=_+1;p<L;++p)S[p]-=S[_]*b[p],++p,S[p]-=S[_]*b[p];p===L&&(S[p]-=S[_]*b[p])}}return{LU:i,P:N}},e.LUsolve=function(i,s){var n,a,p=i.LU,_=p.length,g=e.clone(s),y=i.P,b,v,S;for(n=_-1;n!==-1;--n)g[n]=s[n];for(n=0;n<_;++n)for(b=y[n],y[n]!==n&&(S=g[n],g[n]=g[b],g[b]=S),v=p[n],a=0;a<n;++a)g[n]-=g[a]*v[a];for(n=_-1;n>=0;--n){for(v=p[n],a=n+1;a<_;++a)g[n]-=g[a]*v[a];g[n]/=v[n]}return g},e.solve=function(i,s,n){return e.LUsolve(e.LU(i,n),s)},e.echelonize=function(i){var s=e.dim(i),n=s[0],a=s[1],p=e.identity(n),_=Array(n),g,y,b,v,S,M,F,L,N=Math.abs,k=e.diveq;for(i=e.clone(i),g=0;g<n;++g){for(b=0,S=i[g],M=p[g],y=1;y<a;++y)N(S[b])<N(S[y])&&(b=y);for(_[g]=b,k(M,S[b]),k(S,S[b]),y=0;y<n;++y)if(y!==g){for(F=i[y],L=F[b],v=a-1;v!==-1;--v)F[v]-=S[v]*L;for(F=p[y],v=n-1;v!==-1;--v)F[v]-=M[v]*L}}return{I:p,A:i,P:_}},e.__solveLP=function(i,s,n,a,p,_,g){var y=e.sum;e.log;var b=e.mul,v=e.sub,S=e.dot,M=e.div,F=e.add,L=i.length,N=n.length,k,G=!1,H=0,z=1;e.transpose(s),e.svd;var W=e.transpose;e.leq;var Y=Math.sqrt,Z=Math.abs;e.muleq,e.norminf,e.any;var Q=Math.min,se=e.all,$=e.gt,oe=Array(L),ue=Array(N);e.rep([N],1);var de,ye=e.solve,_e=v(n,S(s,_)),we,Pe=S(i,i),Ee;for(we=H;we<p;++we){var We,et;for(We=N-1;We!==-1;--We)ue[We]=M(s[We],_e[We]);var ke=W(ue);for(We=L-1;We!==-1;--We)oe[We]=y(ke[We]);z=.25*Z(Pe/S(i,oe));var $e=100*Y(Pe/S(oe,oe));for((!isFinite(z)||z>$e)&&(z=$e),Ee=F(i,b(z,oe)),de=S(ke,ue),We=L-1;We!==-1;--We)de[We][We]+=1;et=ye(de,M(Ee,z),!0);var pt=M(_e,S(s,et)),Xe=1;for(We=N-1;We!==-1;--We)pt[We]<0&&(Xe=Q(Xe,-.999*pt[We]));if(k=v(_,b(et,Xe)),_e=v(n,S(s,k)),!se($(_e,0)))return{solution:_,message:"",iterations:we};if(_=k,z<a)return{solution:k,message:"",iterations:we};if(g){var Tt=S(i,Ee),fi=S(s,Ee);for(G=!0,We=N-1;We!==-1;--We)if(Tt*fi[We]<0){G=!1;break}}else _[L-1]>=0?G=!1:G=!0;if(G)return{solution:k,message:"Unbounded",iterations:we}}return{solution:_,message:"maximum iteration count exceeded",iterations:we}},e._solveLP=function(i,s,n,a,p){var _=i.length,g=n.length,L;e.sum,e.log,e.mul;var y=e.sub,b=e.dot;e.div,e.add;var v=e.rep([_],0).concat([1]),S=e.rep([g,1],-1),M=e.blockMatrix([[s,S]]),F=n,L=e.rep([_],0).concat(Math.max(0,e.sup(e.neg(n)))+1),N=e.__solveLP(v,M,F,a,p,L,!1),k=e.clone(N.solution);k.length=_;var G=e.inf(y(n,b(s,k)));if(G<0)return{solution:NaN,message:"Infeasible",iterations:N.iterations};var H=e.__solveLP(i,s,n,a,p-N.iterations,k,!0);return H.iterations+=N.iterations,H},e.solveLP=function(i,s,n,a,p,_,g){if(typeof g>"u"&&(g=1e3),typeof _>"u"&&(_=e.epsilon),typeof a>"u")return e._solveLP(i,s,n,_,g);var y=a.length,b=a[0].length,v=s.length,S=e.echelonize(a),M=e.rep([b],0),F=S.P,L=[],N;for(N=F.length-1;N!==-1;--N)M[F[N]]=1;for(N=b-1;N!==-1;--N)M[N]===0&&L.push(N);var k=e.getRange,G=e.linspace(0,y-1),H=e.linspace(0,v-1),z=k(a,G,L),W=k(s,H,F),Y=k(s,H,L),Z=e.dot,Q=e.sub,se=Z(W,S.I),$=Q(Y,Z(se,z)),oe=Q(n,Z(se,p)),ue=Array(F.length),de=Array(L.length);for(N=F.length-1;N!==-1;--N)ue[N]=i[F[N]];for(N=L.length-1;N!==-1;--N)de[N]=i[L[N]];var ye=Q(de,Z(ue,Z(S.I,z))),_e=e._solveLP(ye,$,oe,_,g),we=_e.solution;if(we!==we)return _e;var Pe=Z(S.I,Q(p,Z(z,we))),Ee=Array(i.length);for(N=F.length-1;N!==-1;--N)Ee[F[N]]=Pe[N];for(N=L.length-1;N!==-1;--N)Ee[L[N]]=we[N];return{solution:Ee,message:_e.message,iterations:_e.iterations}},e.MPStoLP=function(i){i instanceof String&&i.split(`
`);var s=0,n=["Initial state","NAME","ROWS","COLUMNS","RHS","BOUNDS","ENDATA"],a=i.length,p,_,g,y=0,b={},v=[],S=0,M={},F=0,L,N=[],k=[],G=[];function H(Q){throw new Error("MPStoLP: "+Q+`
Line `+p+": "+i[p]+`
Current state: `+n[s]+`
`)}for(p=0;p<a;++p){g=i[p];var z=g.match(/\S*/g),W=[];for(_=0;_<z.length;++_)z[_]!==""&&W.push(z[_]);if(W.length!==0){for(_=0;_<n.length&&g.substr(0,n[_].length)!==n[_];++_);if(_<n.length){if(s=_,_===1&&(L=W[1]),_===6)return{name:L,c:N,A:e.transpose(k),b:G,rows:b,vars:M};continue}switch(s){case 0:case 1:H("Unexpected line");case 2:switch(W[0]){case"N":y===0?y=W[1]:H("Two or more N rows");break;case"L":b[W[1]]=S,v[S]=1,G[S]=0,++S;break;case"G":b[W[1]]=S,v[S]=-1,G[S]=0,++S;break;case"E":b[W[1]]=S,v[S]=0,G[S]=0,++S;break;default:H("Parse error "+e.prettyPrint(W))}break;case 3:M.hasOwnProperty(W[0])||(M[W[0]]=F,N[F]=0,k[F]=e.rep([S],0),++F);var Y=M[W[0]];for(_=1;_<W.length;_+=2){if(W[_]===y){N[Y]=parseFloat(W[_+1]);continue}var Z=b[W[_]];k[Y][Z]=(v[Z]<0?-1:1)*parseFloat(W[_+1])}break;case 4:for(_=1;_<W.length;_+=2)G[b[W[_]]]=(v[b[W[_]]]<0?-1:1)*parseFloat(W[_+1]);break;case 5:break;case 6:H("Internal error")}}}H("Reached end of file without ENDATA")},e.seedrandom={pow:Math.pow,random:Math.random},function(i,s,n,a,p,_,g){s.seedrandom=function(M,F){var L=[],N;return M=v(b(F?[M,i]:arguments.length?M:[new Date().getTime(),i,window],3),L),N=new y(L),v(N.S,i),s.random=function(){for(var k=N.g(a),G=g,H=0;k<p;)k=(k+H)*n,G*=n,H=N.g(1);for(;k>=_;)k/=2,G/=2,H>>>=1;return(k+H)/G},M};function y(M){var F,L,N=this,k=M.length,G=0,H=N.i=N.j=N.m=0;for(N.S=[],N.c=[],k||(M=[k++]);G<n;)N.S[G]=G++;for(G=0;G<n;G++)F=N.S[G],H=S(H+F+M[G%k]),L=N.S[H],N.S[G]=L,N.S[H]=F;N.g=function(z){var W=N.S,Y=S(N.i+1),Z=W[Y],Q=S(N.j+Z),se=W[Q];W[Y]=se,W[Q]=Z;for(var $=W[S(Z+se)];--z;)Y=S(Y+1),Z=W[Y],Q=S(Q+Z),se=W[Q],W[Y]=se,W[Q]=Z,$=$*n+W[S(Z+se)];return N.i=Y,N.j=Q,$},N.g(n)}function b(M,F,L,N,k){if(L=[],k=typeof M,F&&k=="object"){for(N in M)if(N.indexOf("S")<5)try{L.push(b(M[N],F-1))}catch{}}return L.length?L:M+(k!="string"?"\0":"")}function v(M,F,L,N){for(M+="",L=0,N=0;N<M.length;N++)F[S(N)]=S((L^=F[S(N)]*19)+M.charCodeAt(N));M="";for(N in F)M+=String.fromCharCode(F[N]);return M}function S(M){return M&n-1}g=s.pow(n,a),p=s.pow(2,p),_=p*2,v(s.random(),i)}([],e.seedrandom,256,6,52),function(i){function s(b){if(typeof b!="object")return b;var v=[],S,M=b.length;for(S=0;S<M;S++)v[S+1]=s(b[S]);return v}function n(b){if(typeof b!="object")return b;var v=[],S,M=b.length;for(S=1;S<M;S++)v[S-1]=n(b[S]);return v}function a(b,v,S){var M,F,L,N,k;for(L=1;L<=S;L=L+1){for(b[L][L]=1/b[L][L],k=-b[L][L],M=1;M<L;M=M+1)b[M][L]=k*b[M][L];if(N=L+1,S<N)break;for(F=N;F<=S;F=F+1)for(k=b[L][F],b[L][F]=0,M=1;M<=L;M=M+1)b[M][F]=b[M][F]+k*b[M][L]}}function p(b,v,S,M){var F,L,N,k;for(L=1;L<=S;L=L+1){for(k=0,F=1;F<L;F=F+1)k=k+b[F][L]*M[F];M[L]=(M[L]-k)/b[L][L]}for(N=1;N<=S;N=N+1)for(L=S+1-N,M[L]=M[L]/b[L][L],k=-M[L],F=1;F<L;F=F+1)M[F]=M[F]+k*b[F][L]}function _(b,v,S,M){var F,L,N,k,G,H;for(L=1;L<=S;L=L+1){if(M[1]=L,H=0,N=L-1,N<1){if(H=b[L][L]-H,H<=0)break;b[L][L]=Math.sqrt(H)}else{for(k=1;k<=N;k=k+1){for(G=b[k][L],F=1;F<k;F=F+1)G=G-b[F][L]*b[F][k];G=G/b[k][k],b[k][L]=G,H=H+G*G}if(H=b[L][L]-H,H<=0)break;b[L][L]=Math.sqrt(H)}M[1]=0}}function g(b,v,S,M,F,L,N,k,G,H,z,W,Y,Z,Q,se){var $,oe,ue,de,ye,_e,we,Pe,Ee,We,et,ke,$e,pt,Xe,Tt,fi,li,Ot,Gt,bi,si,oi,ci,Li,hi,mi;$e=Math.min(M,H),ue=2*M+$e*($e+5)/2+2*H+1,ci=1e-60;do ci=ci+ci,Li=1+.1*ci,hi=1+.2*ci;while(Li<=1||hi<=1);for($=1;$<=M;$=$+1)Q[$]=v[$];for($=M+1;$<=ue;$=$+1)Q[$]=0;for($=1;$<=H;$=$+1)W[$]=0;if(ye=[],se[1]===0){if(_(b,S,M,ye),ye[1]!==0){se[1]=2;return}p(b,S,M,v),a(b,S,M)}else{for(oe=1;oe<=M;oe=oe+1)for(F[oe]=0,$=1;$<=oe;$=$+1)F[oe]=F[oe]+b[$][oe]*v[$];for(oe=1;oe<=M;oe=oe+1)for(v[oe]=0,$=oe;$<=M;$=$+1)v[oe]=v[oe]+b[oe][$]*F[$]}for(L[1]=0,oe=1;oe<=M;oe=oe+1)for(F[oe]=v[oe],L[1]=L[1]+Q[oe]*F[oe],Q[oe]=0,$=oe+1;$<=M;$=$+1)b[$][oe]=0;for(L[1]=-L[1]/2,se[1]=0,we=M,Pe=we+M,et=Pe+$e,Ee=et+$e+1,We=Ee+$e*($e+1)/2,pt=We+H,$=1;$<=H;$=$+1){for(Tt=0,oe=1;oe<=M;oe=oe+1)Tt=Tt+N[oe][$]*N[oe][$];Q[pt+$]=Math.sqrt(Tt)}Y=0,Z[1]=0,Z[2]=0;function cr(){for(Z[1]=Z[1]+1,ue=We,$=1;$<=H;$=$+1){for(ue=ue+1,Tt=-k[$],oe=1;oe<=M;oe=oe+1)Tt=Tt+N[oe][$]*F[oe];if(Math.abs(Tt)<ci&&(Tt=0),$>z)Q[ue]=Tt;else if(Q[ue]=-Math.abs(Tt),Tt>0){for(oe=1;oe<=M;oe=oe+1)N[oe][$]=-N[oe][$];k[$]=-k[$]}}for($=1;$<=Y;$=$+1)Q[We+W[$]]=0;for(ke=0,Xe=0,$=1;$<=H;$=$+1)Q[We+$]<Xe*Q[pt+$]&&(ke=$,Xe=Q[We+$]/Q[pt+$]);return ke===0?999:0}function Ui(){for($=1;$<=M;$=$+1){for(Tt=0,oe=1;oe<=M;oe=oe+1)Tt=Tt+b[oe][$]*N[oe][ke];Q[$]=Tt}for(de=we,$=1;$<=M;$=$+1)Q[de+$]=0;for(oe=Y+1;oe<=M;oe=oe+1)for($=1;$<=M;$=$+1)Q[de+$]=Q[de+$]+b[$][oe]*Q[oe];for(si=!0,$=Y;$>=1;$=$-1){for(Tt=Q[$],ue=Ee+$*($+3)/2,de=ue-$,oe=$+1;oe<=Y;oe=oe+1)Tt=Tt-Q[ue]*Q[Pe+oe],ue=ue+oe;if(Tt=Tt/Q[de],Q[Pe+$]=Tt,W[$]<z||Tt<0)break;si=!1,_e=$}if(!si)for(fi=Q[et+_e]/Q[Pe+_e],$=1;$<=Y&&!(W[$]<z||Q[Pe+$]<0);$=$+1)Xe=Q[et+$]/Q[Pe+$],Xe<fi&&(fi=Xe,_e=$);for(Tt=0,$=we+1;$<=we+M;$=$+1)Tt=Tt+Q[$]*Q[$];if(Math.abs(Tt)<=ci){if(si)return se[1]=1,999;for($=1;$<=Y;$=$+1)Q[et+$]=Q[et+$]-fi*Q[Pe+$];return Q[et+Y+1]=Q[et+Y+1]+fi,700}else{for(Tt=0,$=1;$<=M;$=$+1)Tt=Tt+Q[we+$]*N[$][ke];for(li=-Q[We+ke]/Tt,oi=!0,si||fi<li&&(li=fi,oi=!1),$=1;$<=M;$=$+1)F[$]=F[$]+li*Q[we+$],Math.abs(F[$])<ci&&(F[$]=0);for(L[1]=L[1]+li*Tt*(li/2+Q[et+Y+1]),$=1;$<=Y;$=$+1)Q[et+$]=Q[et+$]-li*Q[Pe+$];if(Q[et+Y+1]=Q[et+Y+1]+li,oi){for(Y=Y+1,W[Y]=ke,ue=Ee+(Y-1)*Y/2+1,$=1;$<=Y-1;$=$+1)Q[ue]=Q[$],ue=ue+1;if(Y===M)Q[ue]=Q[M];else{for($=M;$>=Y+1&&!(Q[$]===0||(Ot=Math.max(Math.abs(Q[$-1]),Math.abs(Q[$])),Gt=Math.min(Math.abs(Q[$-1]),Math.abs(Q[$])),Q[$-1]>=0?Xe=Math.abs(Ot*Math.sqrt(1+Gt*Gt/(Ot*Ot))):Xe=-Math.abs(Ot*Math.sqrt(1+Gt*Gt/(Ot*Ot))),Ot=Q[$-1]/Xe,Gt=Q[$]/Xe,Ot===1));$=$-1)if(Ot===0)for(Q[$-1]=Gt*Xe,oe=1;oe<=M;oe=oe+1)Xe=b[oe][$-1],b[oe][$-1]=b[oe][$],b[oe][$]=Xe;else for(Q[$-1]=Xe,bi=Gt/(1+Ot),oe=1;oe<=M;oe=oe+1)Xe=Ot*b[oe][$-1]+Gt*b[oe][$],b[oe][$]=bi*(b[oe][$-1]+Xe)-b[oe][$],b[oe][$-1]=Xe;Q[ue]=Q[Y]}}else{for(Tt=-k[ke],oe=1;oe<=M;oe=oe+1)Tt=Tt+F[oe]*N[oe][ke];if(ke>z)Q[We+ke]=Tt;else if(Q[We+ke]=-Math.abs(Tt),Tt>0){for(oe=1;oe<=M;oe=oe+1)N[oe][ke]=-N[oe][ke];k[ke]=-k[ke]}return 700}}return 0}function Ii(){if(ue=Ee+_e*(_e+1)/2+1,de=ue+_e,Q[de]===0||(Ot=Math.max(Math.abs(Q[de-1]),Math.abs(Q[de])),Gt=Math.min(Math.abs(Q[de-1]),Math.abs(Q[de])),Q[de-1]>=0?Xe=Math.abs(Ot*Math.sqrt(1+Gt*Gt/(Ot*Ot))):Xe=-Math.abs(Ot*Math.sqrt(1+Gt*Gt/(Ot*Ot))),Ot=Q[de-1]/Xe,Gt=Q[de]/Xe,Ot===1))return 798;if(Ot===0){for($=_e+1;$<=Y;$=$+1)Xe=Q[de-1],Q[de-1]=Q[de],Q[de]=Xe,de=de+$;for($=1;$<=M;$=$+1)Xe=b[$][_e],b[$][_e]=b[$][_e+1],b[$][_e+1]=Xe}else{for(bi=Gt/(1+Ot),$=_e+1;$<=Y;$=$+1)Xe=Ot*Q[de-1]+Gt*Q[de],Q[de]=bi*(Q[de-1]+Xe)-Q[de],Q[de-1]=Xe,de=de+$;for($=1;$<=M;$=$+1)Xe=Ot*b[$][_e]+Gt*b[$][_e+1],b[$][_e+1]=bi*(b[$][_e]+Xe)-b[$][_e+1],b[$][_e]=Xe}return 0}function Cr(){for(de=ue-_e,$=1;$<=_e;$=$+1)Q[de]=Q[ue],ue=ue+1,de=de+1;return Q[et+_e]=Q[et+_e+1],W[_e]=W[_e+1],_e=_e+1,_e<Y?797:0}function an(){return Q[et+Y]=Q[et+Y+1],Q[et+Y+1]=0,W[Y]=0,Y=Y-1,Z[2]=Z[2]+1,0}for(mi=0;;){if(mi=cr(),mi===999)return;for(;mi=Ui(),mi!==0;){if(mi===999)return;if(mi===700)if(_e===Y)an();else{for(;Ii(),mi=Cr(),mi===797;);an()}}}}function y(b,v,S,M,F,L){b=s(b),v=s(v),S=s(S);var N,k,G,H,z,W=[],Y=[],Z=[],Q=[],se=[],$;if(F=F||0,L=L?s(L):[void 0,0],M=M?s(M):[],k=b.length-1,G=S[1].length-1,!M)for(N=1;N<=G;N=N+1)M[N]=0;for(N=1;N<=G;N=N+1)Y[N]=0;for(H=0,z=Math.min(k,G),N=1;N<=k;N=N+1)Z[N]=0;for(W[1]=0,N=1;N<=2*k+z*(z+5)/2+2*G+1;N=N+1)Q[N]=0;for(N=1;N<=2;N=N+1)se[N]=0;return g(b,v,k,k,Z,W,S,M,k,G,F,Y,H,se,Q,L),$="",L[1]===1&&($="constraints are inconsistent, no solution!"),L[1]===2&&($="matrix D in quadratic function is not positive definite!"),{solution:n(Z),value:n(W),unconstrained_solution:n(v),iterations:n(se),iact:n(Y),message:$}}i.solveQP=y}(e),e.svd=function(i){var s,n=e.epsilon,a=1e-64/n,p=50,_=0,g=0,y=0,b=0,v=0,S=e.clone(i),M=S.length,F=S[0].length;if(M<F)throw"Need more rows than columns";var L=new Array(F),N=new Array(F);for(g=0;g<F;g++)L[g]=N[g]=0;var k=e.rep([F,F],0);function G(de,ye){return de=Math.abs(de),ye=Math.abs(ye),de>ye?de*Math.sqrt(1+ye*ye/de/de):ye==0?de:ye*Math.sqrt(1+de*de/ye/ye)}var H=0,z=0,W=0,Y=0,Z=0,Q=0,se=0;for(g=0;g<F;g++){for(L[g]=z,se=0,v=g+1,y=g;y<M;y++)se+=S[y][g]*S[y][g];if(se<=a)z=0;else for(H=S[g][g],z=Math.sqrt(se),H>=0&&(z=-z),W=H*z-se,S[g][g]=H-z,y=v;y<F;y++){for(se=0,b=g;b<M;b++)se+=S[b][g]*S[b][y];for(H=se/W,b=g;b<M;b++)S[b][y]+=H*S[b][g]}for(N[g]=z,se=0,y=v;y<F;y++)se=se+S[g][y]*S[g][y];if(se<=a)z=0;else{for(H=S[g][g+1],z=Math.sqrt(se),H>=0&&(z=-z),W=H*z-se,S[g][g+1]=H-z,y=v;y<F;y++)L[y]=S[g][y]/W;for(y=v;y<M;y++){for(se=0,b=v;b<F;b++)se+=S[y][b]*S[g][b];for(b=v;b<F;b++)S[y][b]+=se*L[b]}}Z=Math.abs(N[g])+Math.abs(L[g]),Z>Y&&(Y=Z)}for(g=F-1;g!=-1;g+=-1){if(z!=0){for(W=z*S[g][g+1],y=v;y<F;y++)k[y][g]=S[g][y]/W;for(y=v;y<F;y++){for(se=0,b=v;b<F;b++)se+=S[g][b]*k[b][y];for(b=v;b<F;b++)k[b][y]+=se*k[b][g]}}for(y=v;y<F;y++)k[g][y]=0,k[y][g]=0;k[g][g]=1,z=L[g],v=g}for(g=F-1;g!=-1;g+=-1){for(v=g+1,z=N[g],y=v;y<F;y++)S[g][y]=0;if(z!=0){for(W=S[g][g]*z,y=v;y<F;y++){for(se=0,b=v;b<M;b++)se+=S[b][g]*S[b][y];for(H=se/W,b=g;b<M;b++)S[b][y]+=H*S[b][g]}for(y=g;y<M;y++)S[y][g]=S[y][g]/z}else for(y=g;y<M;y++)S[y][g]=0;S[g][g]+=1}for(n=n*Y,b=F-1;b!=-1;b+=-1)for(var $=0;$<p;$++){var oe=!1;for(v=b;v!=-1;v+=-1){if(Math.abs(L[v])<=n){oe=!0;break}if(Math.abs(N[v-1])<=n)break}if(!oe){_=0,se=1;var ue=v-1;for(g=v;g<b+1&&(H=se*L[g],L[g]=_*L[g],!(Math.abs(H)<=n));g++)for(z=N[g],W=G(H,z),N[g]=W,_=z/W,se=-H/W,y=0;y<M;y++)Z=S[y][ue],Q=S[y][g],S[y][ue]=Z*_+Q*se,S[y][g]=-Z*se+Q*_}if(Q=N[b],v==b){if(Q<0)for(N[b]=-Q,y=0;y<F;y++)k[y][b]=-k[y][b];break}if($>=p-1)throw"Error: no convergence.";for(Y=N[v],Z=N[b-1],z=L[b-1],W=L[b],H=((Z-Q)*(Z+Q)+(z-W)*(z+W))/(2*W*Z),z=G(H,1),H<0?H=((Y-Q)*(Y+Q)+W*(Z/(H-z)-W))/Y:H=((Y-Q)*(Y+Q)+W*(Z/(H+z)-W))/Y,_=1,se=1,g=v+1;g<b+1;g++){for(z=L[g],Z=N[g],W=se*z,z=_*z,Q=G(H,W),L[g-1]=Q,_=H/Q,se=W/Q,H=Y*_+z*se,z=-Y*se+z*_,W=Z*se,Z=Z*_,y=0;y<F;y++)Y=k[y][g-1],Q=k[y][g],k[y][g-1]=Y*_+Q*se,k[y][g]=-Y*se+Q*_;for(Q=G(H,W),N[g-1]=Q,_=H/Q,se=W/Q,H=_*z+se*Z,Y=-se*z+_*Z,y=0;y<M;y++)Z=S[y][g-1],Q=S[y][g],S[y][g-1]=Z*_+Q*se,S[y][g]=-Z*se+Q*_}L[v]=0,L[b]=H,N[b]=Y}for(g=0;g<N.length;g++)N[g]<n&&(N[g]=0);for(g=0;g<F;g++)for(y=g-1;y>=0;y--)if(N[y]<N[g]){for(_=N[y],N[y]=N[g],N[g]=_,b=0;b<S.length;b++)s=S[b][g],S[b][g]=S[b][y],S[b][y]=s;for(b=0;b<k.length;b++)s=k[b][g],k[b][g]=k[b][y],k[b][y]=s;g=y}return{U:S,S:N,V:k}}})(zT);var A8=Object.defineProperty,C8=(l,e,i)=>e in l?A8(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,fx=(l,e,i)=>(C8(l,typeof e!="symbol"?e+"":e,i),i);class cY{constructor(){fx(this,"palmDetector"),fx(this,"handDetector"),fx(this,"handTracks",[]),fx(this,"handFilters",[]),fx(this,"angle",10/180*Math.PI),fx(this,"ratio",1920/1080),fx(this,"near",1),fx(this,"handScore",.55)}async process(e,i){var s,n;const a=zr(()=>{const F=kn(np(e,3),"float32"),L=us(F,255);return yh(L,0)}),[p,_]=[a.shape[1],a.shape[2]],g=(F,L)=>{const N=[F[0]*_,F[1]*p],k=[L[0]*_,L[1]*p];let[G,H]=[k[0]-N[0],N[1]-k[1]];const z=Math.sqrt(G**2+H**2);return G/=z,H/=z,[G,H]},y=(F,L,N,k,G,H)=>{const z=[.5*(F[0][0]+F[1][0])*_,.5*(F[0][1]+F[1][1])*p],W={width:(F[1][0]-F[0][0])*_,height:(F[1][1]-F[0][1])*p},[Y,Z]=g(L,N),Q=[G*W.width,H*W.height];z[0]+=Q[0]*Z-Q[1]*Y,z[1]+=Q[0]*Y+Q[1]*Z,z[0]/=_,z[1]/=p;const se=.5*k*Math.max(W.width,W.height);let $=se/_,oe=se/p;return[[z[0]-$,z[1]-oe],[z[0]+$,z[1]+oe]]};if(this.handTracks.length===0){const F=await((s=this.palmDetector)==null?void 0:s.process(a))||[];this.handTracks=F.map(L=>({box:y(L.box,L.points[0],L.points[2],2.6,0,-.5),points:L.points,start:L.points[0],end:L.points[2]})),this.handTracks.forEach(()=>this.handFilters.push(new E8))}const b=this.handTracks.length>0?await((n=this.handDetector)==null?void 0:n.process(a,this.handTracks))||[]:[];b.forEach((F,L)=>{if(i===void 0)return;const N=_/p,k=this.handTracks[L].box[1][0]-this.handTracks[L].box[0][0],G=(this.handTracks[L].box[1][1]-this.handTracks[L].box[0][1])/N,H=Math.sqrt(k*k+G*G)*(1+N);b[L]=this.handFilters[L].filter(F,i,1/H)}),a.dispose();const v=[],S=[],M=[];for(let F=0;F<b.length;F++){const L=b[F],{keypoints:N,score:k}=L;if(k<this.handScore)continue;const G=[N[0].pixel[0],N[0].pixel[1]],H=[N[5].pixel[0],N[5].pixel[1]],z=[N[10].pixel[0],N[10].pixel[1]],W=[N[14].pixel[0],N[14].pixel[1]],Y=[.25*H[0]+.5*z[0]+.25*W[0],.25*H[1]+.5*z[1]+.25*W[1]],[Z,Q]=g(G,Y),[se,$]=[-Z,Q],oe=[...N.slice(0,4),...N.slice(5,7),...N.slice(9,11),...N.slice(13,15),...N.slice(17,19)].map(et=>[et.pixel[0],et.pixel[1]]),ue=[[10,10],[-10,-10]];for(let et=0;et<oe.length;et++)ue[0][0]=Math.min(ue[0][0],oe[et][0]),ue[0][1]=Math.min(ue[0][1],oe[et][1]),ue[1][0]=Math.max(ue[1][0],oe[et][0]),ue[1][1]=Math.max(ue[1][1],oe[et][1]);const de=[(ue[0][0]+ue[1][0])*.5,(ue[0][1]+ue[1][1])*.5],ye=[[10,10],[-10,-10]];for(let et=0;et<oe.length;et++){const ke=[(oe[et][0]-de[0])*_,(oe[et][1]-de[1])*p],$e=[$*ke[0]-se*ke[1],se*ke[0]+$*ke[1]];ye[0][0]=Math.min(ye[0][0],$e[0]),ye[0][1]=Math.min(ye[0][1],$e[1]),ye[1][0]=Math.max(ye[1][0],$e[0]),ye[1][1]=Math.max(ye[1][1],$e[1])}const _e=[(ye[0][0]+ye[1][0])*.5,(ye[0][1]+ye[1][1])*.5],we=[(Q*_e[0]-Z*_e[1])/_+de[0],(Z*_e[0]+Q*_e[1])/p+de[1]],Pe=.5*(ye[1][0]-ye[0][0])/_,Ee=.5*(ye[1][1]-ye[0][1])/p,We=y([[we[0]-Pe,de[1]-Ee],[we[0]+Pe,de[1]+Ee]],G,Y,2,0,-.1);Kb(We,this.handTracks[F].box)<.5||(this.align(b[F].keypoints),v.push({box:We,start:G,end:Y,points:[]}),S.push(this.handFilters[F]),M.push(b[F]))}return this.handTracks=v,this.handFilters=S,M}align(e){const i=2*Math.tan(.5*this.angle),s=this.ratio*i,n=e.map(y=>{const b=[(y.pixel[0]-.5)*s,(y.pixel[1]-.5)*i],v=[...y.metric];return{pixel:b,world:v}}),a=[];n.forEach(y=>{a.push([0,1,-y.pixel[1],y.world[1]-y.pixel[1]*y.world[2]],[-1,0,y.pixel[0],y.pixel[0]*y.world[2]-y.world[0]])});const{V:p}=zT.svd(a),_=p[3][3],g=[p[0][3]/_,p[1][3]/_,p[2][3]/_];e.forEach(y=>{y.metric[0]+=g[0],y.metric[1]+=g[1],y.metric[2]+=g[2]}),e.forEach(y=>{const b=[(y.pixel[0]-.5)*s,(y.pixel[1]-.5)*i],v=y.metric;v[0]=b[0]*v[2],v[1]=b[1]*v[2],y.metric[1]=-y.metric[1],y.metric[2]=-y.metric[2]})}setCamera(e,i,s=1){this.angle=e,this.ratio=i,this.near=s}async init(e,i="./",s=!1,n="webgl"){const a=await Vp({locateFile:b=>i+b});a.Loader.prototype.promisify=function(b,...v){return b.call(this,...v),new Promise(S=>{const M=setInterval(()=>{if(this.ready)return clearInterval(M),S(this.status)},5)})},a.Loader.prototype.load=function(b){return this.promisify(this.loadAsync,b,s)},a.Loader.prototype.remove=function(b){return this.promisify(this.removeAsync,b)},a.DictLoader.prototype.loadDict=function(b){return this.promisify(this.loadDictAsync,e,b)};const p=new a.ParseLoader(i);if(s||await p.remove("hand.wasm"),!await p.loadDict(["hand.wasm"])||!await p.load("hand.wasm")||!p.parse())return;Ue().set("WEBGL_USE_SHAPES_UNIFORMS",!0),rp(),await sp(n);const _={weightUrlConverter:async b=>b,fetchFunc:async b=>{const v=new Blob([p.file(b)]);return fetch(URL.createObjectURL(v))}},g=await tc("palmmodel.def",_),y=await tc("handmodel.def",_);this.palmDetector=new _8(g),this.handDetector=new b8(y)}reset(){this.handTracks=[],this.handFilters=[]}async prepare(){var e,i;Ue().set("ENGINE_COMPILE_ONLY",!0),await((e=this.palmDetector)==null?void 0:e.prepare()),await((i=this.handDetector)==null?void 0:i.prepare());const s=Rd();s instanceof ll&&(s.checkCompileCompletion(),s.getUniformLocations()),Ue().set("ENGINE_COMPILE_ONLY",!1)}dispose(){var e;this.reset(),(e=this.palmDetector)==null||e.dispose()}}const hY={lipsUpperOuter:[61,185,40,39,37,0,267,269,270,409,291],lipsLowerOuter:[146,91,181,84,17,314,405,321,375,291],lipsUpperInner:[78,191,80,81,82,13,312,311,310,415,308],lipsLowerInner:[78,95,88,178,87,14,317,402,318,324,308],rightEyeUpper0:[246,161,160,159,158,157,173],rightEyeLower0:[33,7,163,144,145,153,154,155,133],rightEyeUpper1:[247,30,29,27,28,56,190],rightEyeLower1:[130,25,110,24,23,22,26,112,243],rightEyebrowUpper:[156,70,63,105,66,107,55],rightEyebrowLower:[124,46,53,52,65],rightEyeIris:[473,474,475,476,477],leftEyeUpper0:[466,388,387,386,385,384,398],leftEyeLower0:[263,249,390,373,374,380,381,382,362],leftEyeUpper1:[467,260,259,257,258,286,414],leftEyeLower1:[359,255,339,254,253,252,256,341,463],leftEyebrowUpper:[383,300,293,334,296,336,285],leftEyebrowLower:[353,276,283,282,295],leftEyeIris:[468,469,470,471,472]},uY=null,dY=null,fY=null;var R8=Object.defineProperty,I8=(l,e,i)=>e in l?R8(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,HT=(l,e,i)=>(I8(l,typeof e!="symbol"?e+"":e,i),i);class pY{constructor(){HT(this,"canvas"),HT(this,"context",null),this.canvas=document.createElement("canvas"),this.canvas.id="engeenee.meancolor",this.canvas.hidden=!0,this.canvas.width=1,this.canvas.height=1,this.context=this.canvas.getContext("2d",{alpha:!1,desynchronized:!0})}mean(e){if(!this.context)return;this.context.drawImage(e,0,0,1,1);const i=this.context.getImageData(0,0,1,1);return[i.data[0],i.data[1],i.data[2]]}brightness(e){const i=this.mean(e);return i?(.2989*i[0]+.587*i[1]+.1141*i[2])/255:void 0}dispose(){this.context=null,this.canvas&&document.removeChild(this.canvas),delete this.canvas}}var S8=fa(187);class Dh extends S8.EventEmitter{}var M8=Object.defineProperty,XT=Object.getOwnPropertySymbols,P8=Object.prototype.hasOwnProperty,O8=Object.prototype.propertyIsEnumerable,Fm=(l,e,i)=>e in l?M8(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,YT=(l,e)=>{for(var i in e||(e={}))P8.call(e,i)&&Fm(l,i,e[i]);if(XT)for(var i of XT(e))O8.call(e,i)&&Fm(l,i,e[i]);return l},hc=(l,e,i)=>(Fm(l,typeof e!="symbol"?e+"":e,i),i);class KT{constructor(e="canvas"){hc(this,"size",{width:0,height:0}),hc(this,"canvas"),hc(this,"context",null),this.canvas=document.createElement("canvas"),this.canvas.id="engeenee.capture."+e,this.canvas.hidden=!0,this.context=this.canvas.getContext("2d",{alpha:!1})}capture(e){const{context:i}=this;if(!i)return!1;const{width:s,height:n}=this.size;return i.drawImage(e,0,0,s,n),!0}data(){const{context:e}=this;if(!e)return;const{width:i,height:s}=this.size;return e.getImageData(0,0,i,s)}setSize(e){this.size=YT({},e),this.canvas.width=e.width,this.canvas.height=e.height}fill(){const{context:e}=this;e&&(e.fillStyle="rgba(255, 255, 255, 1)",e.fillRect(0,0,this.size.width,this.size.height))}dispose(){this.context=null,this.canvas.remove()}}class w8 extends Dh{constructor(){super(),hc(this,"buffer",new KT("capture")),hc(this,"captureTime",0),hc(this,"timer")}async setup(e){const i=e&&(s=>typeof s!="string"&&"size"in s)(e)&&e.size||{width:1920,height:1080};return this.updateSize(i),this.buffer.fill(),!0}dispose(){this.reset(),this.buffer.dispose()}async start(){this.captureTime=0,this.timer=Date.now()}pause(){}reset(){this.pause(),delete this.timer}capture(){return this.timer===void 0?!1:(this.captureTime=(Date.now()-this.timer)*1e3,!0)}size(){return YT({},this.buffer.size)}ratio(){const e=this.buffer.size;return e.width/e.height}updateSize(e){this.buffer.setSize(e),this.emit("resize",this.buffer.size)}}var D8=Object.defineProperty,F8=(l,e,i)=>e in l?D8(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,jT=(l,e,i)=>(F8(l,typeof e!="symbol"?e+"":e,i),i);class qT extends w8{constructor(){super(),jT(this,"videoRef"),jT(this,"timeShift",0),this.videoRef=document.createElement("video"),this.videoRef.id="engeenee.capture.source",this.videoRef.muted=!0,this.videoRef.loop=!0,this.videoRef.playsInline=!0}async setup(e){const i=_=>typeof _=="string"||"getVideoTracks"in _,s=_=>"video"in _,n=_=>{if(!_)return{video:!0,audio:!1};if(s(_))return _;const g=_.size;return{video:{facingMode:_.rear?"environment":"user",width:g?.width,height:g?.height,frameRate:_.fps},audio:!1}},a=e!==void 0&&i(e)?e:await navigator.mediaDevices.getUserMedia(n(e)).catch(()=>{});if(!a)return!1;const{videoRef:p}=this;return new Promise(_=>{p.onloadedmetadata=()=>{this.updateSize({width:p.videoWidth,height:p.videoHeight}),p.onresize=()=>{this.updateSize({width:p.videoWidth,height:p.videoHeight})},p.onseeked=()=>{this.timeShift=this.captureTime,this.captureTime=0},_(!0)},typeof a=="string"?p.src=a:p.srcObject=a})}dispose(){super.dispose(),this.videoRef.remove()}async start(){this.captureTime=0,this.timeShift=0,(this.videoRef.srcObject||this.videoRef.src)&&await this.videoRef.play()}pause(){this.videoRef.pause()}reset(){this.pause(),this.videoRef.srcObject&&(this.videoRef.srcObject.getTracks().forEach(e=>e.stop()),this.videoRef.srcObject=null)}capture(){const{videoRef:e,buffer:i}=this,s=e.currentTime+this.timeShift;return s<=this.captureTime?!1:(this.captureTime=s,i.capture(e))}}var L8=Object.defineProperty,N8=(l,e,i)=>e in l?L8(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,Js=(l,e,i)=>(N8(l,typeof e!="symbol"?e+"":e,i),i);class B8 extends Dh{constructor(e,i,s=qT){super(),this.engineParams=i,Js(this,"processor"),Js(this,"renderers",[]),Js(this,"video"),Js(this,"videoRatio",1920/1080),Js(this,"streamCanvas"),Js(this,"streamSize",{width:1920,height:1080}),Js(this,"processCanvas"),Js(this,"processSize",{width:1920,height:1080}),Js(this,"resizeBuffer"),Js(this,"resizeEnabled",!1),Js(this,"loopState",!1),Js(this,"loopId"),Js(this,"init",async n=>{const a=await this.setupProcessor(n);return this.emit("init",a),a}),Js(this,"setup",async n=>{this.pause();const a=await this.setupVideo(n);return this.emit("setup",a),a}),Js(this,"start",async()=>{await this.video.start(),this.loopState=!0,this.emit("start"),this.enqueue()}),Js(this,"pause",()=>{this.loopState=!1,this.loopId&&(window.cancelAnimationFrame(this.loopId),delete this.loopId),this.video.pause(),this.emit("pause")}),Js(this,"reset",()=>{this.pause(),this.video.reset(),delete this.streamCanvas,delete this.processCanvas,this.processor.reset()}),Js(this,"iterate",async()=>{var n;const{video:a,streamCanvas:p,processCanvas:_}=this;if(!a.capture()||!p||!_)return this.enqueue();this.resizeEnabled&&((n=this.resizeBuffer)==null||n.capture(a.buffer.canvas));const g=await this.processor.process(_,a.captureTime);g&&await Promise.all(this.renderers.map(y=>y.update(g,p))),this.enqueue()}),this.processor=typeof e=="function"?new e:e,this.video=typeof s=="function"?new s:s,this.video.on("resize",this.resizeVideo.bind(this))}async addRenderer(e){this.renderers.push(e),await e.load(),e.setupVideo(this.video.size(),this.video.ratio()),e.setupCamera(this.processor.cameraRatio,this.processor.cameraAngle)}removeRenderer(e){const{renderers:i}=this,s=i.indexOf(e);s<0||(i[s].dispose(),i.slice(s,1))}enqueue(){this.loopId=this.loopState?window.requestAnimationFrame(this.iterate):void 0}async setupProcessor(e){var i;const s=this.resizeEnabled&&((i=this.resizeBuffer)==null?void 0:i.size)||this.video.size();return this.processor.init(e,s,this.video.ratio())}async setupVideo(e){return this.video.reset(),await this.video.setup(e)?(this.setupSize(this.video.size()),!0):!1}async setupSize(e){var i,s;const{width:n,height:a}=e;this.videoRatio=n/a;const p=Math.max(n,a),_=((i=this.engineParams)==null?void 0:i.max)||this.processor.optimalSize;if(this.resizeEnabled=!1,_<p){this.resizeEnabled=!0;const g=p/_;this.resizeBuffer||(this.resizeBuffer=new KT("resize")),this.resizeBuffer.setSize({width:n/g,height:a/g})}this.resizeEnabled&&this.resizeBuffer?(this.processCanvas=this.resizeBuffer.canvas,this.processSize=this.resizeBuffer.size):(this.processCanvas=this.video.buffer.canvas,this.processSize=this.video.size()),((s=this.engineParams)==null?void 0:s.orig)!==!1?(this.streamCanvas=this.video.buffer.canvas,this.streamSize=this.video.size()):(this.streamCanvas=this.processCanvas,this.streamSize=this.streamSize)}resizeVideo(e){this.setupSize(e),this.processor.setupVideo(this.processSize,this.videoRatio),this.renderers.forEach(i=>i.setupVideo(this.streamSize,this.videoRatio)),this.renderers.forEach(i=>i.setupCamera(this.processor.cameraRatio,this.processor.cameraAngle))}}var k8=Object.defineProperty,ZT=Object.getOwnPropertySymbols,U8=Object.prototype.hasOwnProperty,V8=Object.prototype.propertyIsEnumerable,Lm=(l,e,i)=>e in l?k8(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,G8=(l,e)=>{for(var i in e||(e={}))U8.call(e,i)&&Lm(l,i,e[i]);if(ZT)for(var i of ZT(e))V8.call(e,i)&&Lm(l,i,e[i]);return l},uc=(l,e,i)=>(Lm(l,typeof e!="symbol"?e+"":e,i),i);class W8 extends Dh{constructor(){super(),uc(this,"params",{}),uc(this,"videoSize",{width:1920,height:1080}),uc(this,"videoRatio",this.videoSize.width/this.videoSize.height),uc(this,"optimalSize",1024),uc(this,"cameraRatio",this.videoRatio),uc(this,"cameraAngle",60/180*Math.PI)}async process(e,i){return{}}async init(e,i,s){return this.params=e,!s&&i&&(s=i.width/i.height),this.setupVideo(i||this.videoSize,s||this.videoRatio),this.emit("init",!0),!0}reset(){this.emit("reset")}dispose(){}setupVideo(e,i){i=i||e.width/e.height,this.videoSize=G8({},e),this.videoRatio=i,this.cameraRatio=i}}var z8=Object.defineProperty,H8=(l,e,i)=>e in l?z8(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,px=(l,e,i)=>(H8(l,typeof e!="symbol"?e+"":e,i),i);class X8 extends Dh{constructor(e,i="crop",s=1,n=!1,a=1){super(),this.container=e,this.mode=i,this.layerCount=s,this.mirror=n,this.aspectRatio=a,px(this,"layers",[]),px(this,"pads"),px(this,"padsSize",[1,1]),px(this,"observer"),px(this,"setAspectRatio",p=>{this.aspectRatio=p,this.updateSizes(this.container.clientWidth/this.container.clientHeight)}),px(this,"setMirror",p=>{this.mirror=p,this.layers.forEach(_=>{_.style.transform=p?"scaleX(-1)":""})}),px(this,"updateSizes",p=>{let _=1,g=1;p>this.aspectRatio?this.mode==="crop"?g=p/this.aspectRatio:_=this.aspectRatio/p:this.mode==="crop"?_=this.aspectRatio/p:g=p/this.aspectRatio;const y=(1-_)/2,b=(1-g)/2,v=_*100+"%",S=g*100+"%",M=y*100+"%",F=b*100+"%";for(const L of this.layers)L.style.width=v,L.style.height=S,L.style.left=M,L.style.top=F;if(this.pads){this.padsSize=y>0?[y,1]:[1,b];const L=10,{clientWidth:N,clientHeight:k}=this.container,G=[2*L/N,2*L/k],H=(this.padsSize[0]+2*G[0])*100+"%",z=(this.padsSize[1]+2*G[1])*100+"%";this.pads[0].style.width=H,this.pads[0].style.height=z,this.pads[1].style.width=H,this.pads[1].style.height=z;const W=-G[0]*100+"%",Y=-G[1]*100+"%";this.pads[0].style.top=Y,this.pads[1].style.bottom=Y,this.pads[0].style.left="unset",this.pads[0].style.right="unset",this.pads[1].style.left="unset",this.pads[1].style.right="unset",this.pads[this.mirror?1:0].style.left=W,this.pads[this.mirror?0:1].style.right=W;const Z=y>0?this.mirror?"":"scaleX(-1)":"scaleY(-1) "+(this.mirror?"scaleX(-1)":"");this.pads[0].style.transform=Z,this.pads[1].style.transform=Z;const Q="blur("+L+"px)";this.pads[0].style.filter=Q,this.pads[1].style.filter=Q}this.emit("resize")}),px(this,"handleResize",p=>{if(p.length<1)return;const _=p[0].contentRect;this.updateSizes(_.width/_.height)});for(let p=0;p<s;p++){const _=document.createElement("canvas");_.id="engeenee.canvas.layer"+p,_.style.position="absolute",_.style.zIndex=-10*(s-p)+"",this.mirror&&(_.style.transform="scaleX(-1)"),this.container.appendChild(_),this.layers.push(_)}if(this.mode==="pad"){this.pads=[document.createElement("canvas"),document.createElement("canvas")];const p=-10*(this.layerCount+1)+"";for(let _=0;_<2;_++)this.pads[_].id="engeenee.canvas.pad"+_,this.pads[_].style.position="absolute",this.pads[_].style.zIndex=p,this.container.appendChild(this.pads[_])}this.setAspectRatio(a),this.observer=new ResizeObserver(this.handleResize),this.observer.observe(this.container),this.container.style.overflow="hidden"}}var Y8=Object.defineProperty,QT=Object.getOwnPropertySymbols,K8=Object.prototype.hasOwnProperty,j8=Object.prototype.propertyIsEnumerable,Nm=(l,e,i)=>e in l?Y8(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,q8=(l,e)=>{for(var i in e||(e={}))K8.call(e,i)&&Nm(l,i,e[i]);if(QT)for(var i of QT(e))j8.call(e,i)&&Nm(l,i,e[i]);return l},Fh=(l,e,i)=>(Nm(l,typeof e!="symbol"?e+"":e,i),i);class Z8 extends Dh{constructor(){super(),Fh(this,"loaded",!1),Fh(this,"videoSize",{width:1920,height:1080}),Fh(this,"videoRatio",this.videoSize.width/this.videoSize.height),Fh(this,"cameraRatio",this.videoRatio),Fh(this,"cameraAngle",60/180*Math.PI)}async load(){this.loaded||(this.loaded=!0,this.emit("load"))}unload(){this.loaded&&(this.loaded=!1)}async update(e,i){this.loaded&&(this.updateVideo(i),this.updateScene(),this.emit("render"))}updateVideo(e){}updateScene(){}dispose(){this.unload()}setupVideo(e,i){this.videoSize=q8({},e),this.videoRatio=i||e.width/e.height,this.emit("resize",this.videoSize,this.videoRatio)}setupCamera(e,i){this.cameraRatio=e,this.cameraAngle=i}}var Q8=Object.defineProperty,$8=(l,e,i)=>e in l?Q8(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,J8=(l,e,i)=>($8(l,typeof e!="symbol"?e+"":e,i),i);class e7 extends Z8{constructor(){super(...arguments),J8(this,"plugins",[])}async load(){if(!this.loaded)return await Promise.all(this.plugins.map(e=>e.load(this))),super.load()}unload(){this.plugins.forEach(e=>e.unload()),super.unload()}async update(e,i){if(this.loaded)return await this.updatePlugins(e,i),super.update(e,i)}async updatePlugins(e,i){for(let s of this.plugins)s.loaded&&await s.update(e,i)}dispose(){this.plugins.forEach(e=>e.dispose()),this.plugins=[],super.dispose()}async addPlugin(e){this.loaded&&!e.loaded&&await e.load(this),this.plugins.push(e)}removePlugin(e){const{plugins:i}=this,s=i.indexOf(e);s<0||(i[s].dispose(),i.splice(s,1))}removeAllPlugins(){this.plugins.forEach(e=>e.dispose()),this.plugins=[]}setupVideo(e,i){super.setupVideo(e,i),this.plugins.forEach(s=>s.setupVideo(e))}setupCamera(e,i){super.setupCamera(e,i),this.plugins.forEach(s=>s.setupCamera(e,i))}}var t7=Object.defineProperty,i7=(l,e,i)=>e in l?t7(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,Bm=(l,e,i)=>(i7(l,typeof e!="symbol"?e+"":e,i),i);class km extends e7{constructor(e){super(),Bm(this,"canvas"),Bm(this,"padCtx",[null,null]),Bm(this,"setupPadding",()=>{if(!this.canvas.pads)return;const{width:i,height:s}=this.videoSize,{padsSize:n}=this.canvas,a=i*n[0]/(n[0]<.5?1-2*n[0]:1),p=s*n[1]/(n[1]<.5?1-2*n[1]:1);this.canvas.pads[0].width=a,this.canvas.pads[0].height=p,this.canvas.pads[1].width=a,this.canvas.pads[1].height=p}),this.canvas=new X8(e.container,e.mode,e.layerCount,e.mirror,e.aspectRatio),this.canvas.pads&&(this.padCtx=[this.canvas.pads[0].getContext("2d"),this.canvas.pads[1].getContext("2d")],this.canvas.addListener("resize",this.setupPadding))}updateVideo(e){super.updateVideo(e),this.updatePads(e)}setupVideo(e,i){super.setupVideo(e,i),this.canvas.setAspectRatio(this.videoRatio)}setMirror(e){this.canvas.setMirror(e)}updatePads(e){if(!this.padCtx[0]||!this.padCtx[1]||!this.canvas.pads)return;const{videoSize:{width:i,height:s}}=this,{width:n,height:a}=this.canvas.pads[0];this.padCtx[0].clearRect(0,0,n,a),this.padCtx[0].drawImage(e,0,0,n,a,0,0,n,a),this.padCtx[1].clearRect(0,0,n,a),this.padCtx[1].drawImage(e,i-n,s-a,n,a,0,0,n,a)}}var r7=Object.defineProperty,s7=(l,e,i)=>e in l?r7(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,n7=(l,e,i)=>(s7(l,typeof e!="symbol"?e+"":e,i),i);class a7 extends null{constructor(e){super(e),n7(this,"videoCtx",null);const i=this.canvas.layers[0];this.videoCtx=i.getContext("2d")}updateVideo(e){const{videoCtx:i}=this;if(!i)return;const{width:s,height:n}=this.videoSize;i.clearRect(0,0,s,n),i.drawImage(e,0,0),super.updateVideo(e)}setupVideo(e,i){super.setupVideo(e,i);const{width:s,height:n}=this.videoSize;this.canvas.layers[0].width=s,this.canvas.layers[0].height=n}}var o7=Object.defineProperty,x7=(l,e,i)=>e in l?o7(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,l7=(l,e,i)=>(x7(l,typeof e!="symbol"?e+"":e,i),i);class $T{constructor(e,i={width:1920,height:1080},s=!1,n=!1){this.gl=e,this.size=i,this.grayscale=s,this.linear=n,l7(this,"buffer",null),this.resize(i)}update(e){const{gl:i,size:{width:s,height:n}}=this,a=i.getParameter(i.TEXTURE_BINDING_2D),p=i.getParameter(i.UNPACK_FLIP_Y_WEBGL);i.bindTexture(i.TEXTURE_2D,this.buffer),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),e instanceof Uint8Array?i.texSubImage2D(i.TEXTURE_2D,0,0,0,s,n,this.grayscale?i.RED:i.RGBA,i.UNSIGNED_BYTE,e):i.texSubImage2D(i.TEXTURE_2D,0,0,0,s,n,this.grayscale?i.RED:i.RGBA,i.UNSIGNED_BYTE,e),i.bindTexture(i.TEXTURE_2D,a),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,p)}resize(e){if(e.width===this.size.width&&e.height===this.size.height&&this.buffer)return!0;const{gl:i}=this;if(i.deleteTexture(this.buffer),this.buffer=null,(e.width>0||e.height>0)&&(this.buffer=i.createTexture()),!this.buffer)return!1;const s=this.linear?i.LINEAR:i.NEAREST,n=i.getParameter(i.TEXTURE_BINDING_2D),a=i.getParameter(i.UNPACK_FLIP_Y_WEBGL);return i.bindTexture(i.TEXTURE_2D,this.buffer),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,s),this.size={width:e.width,height:e.height},i.texStorage2D(i.TEXTURE_2D,1,this.grayscale?i.R8:i.RGBA8,e.width,e.height),i.bindTexture(i.TEXTURE_2D,n),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,a),!0}dispose(){this.gl.deleteTexture(this.buffer),this.buffer=null}texture(){return this.buffer}valid(){return!!this.buffer}}var c7=Object.defineProperty,JT=Object.getOwnPropertySymbols,h7=Object.prototype.hasOwnProperty,u7=Object.prototype.propertyIsEnumerable,Um=(l,e,i)=>e in l?c7(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,eE=(l,e)=>{for(var i in e||(e={}))h7.call(e,i)&&Um(l,i,e[i]);if(JT)for(var i of JT(e))u7.call(e,i)&&Um(l,i,e[i]);return l},mx=(l,e,i)=>(Um(l,typeof e!="symbol"?e+"":e,i),i);class tE{constructor(e,i={width:1920,height:1080},s=["image"],n={size:"2f",flip:"1f"},a=f7,p=d7,_=!1){this.gl=e,this.size=i,this.inputs=s,this.uniforms=n,mx(this,"vertShader",null),mx(this,"fragShader",null),mx(this,"shaderProgram",null),mx(this,"vertBuffer",null),mx(this,"vertAttrs",null),mx(this,"uniformsLoc",{}),mx(this,"frameBuffer",null),mx(this,"output"),a.includes("uniform vec2 size;")&&!n.size&&(n.size="2f"),p.includes("uniform float flip;")&&!n.flip&&(n.flip="1f"),this.output=new $T(e,i,!1,_),this.compile(a,p),this.resize(i)}process(e,i={}){const{gl:s,output:n}=this;if(!s||!n||e.length!==this.inputs.length)return;const a=this.save(s);s.bindFramebuffer(s.FRAMEBUFFER,this.frameBuffer),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,n.texture(),0),i=eE({flip:[-1]},i),this.prepare(s,e,i),s.drawArrays(s.TRIANGLES,0,6),this.restore(s,a)}render(e,i={}){const{gl:s,output:n}=this;if(!s||!n||e.length!==this.inputs.length)return;const a=this.save(s);s.bindFramebuffer(s.FRAMEBUFFER,null),i=eE({flip:[1]},i),this.prepare(s,e,i),s.drawArrays(s.TRIANGLES,0,6),this.restore(s,a)}resize(e){var i;const{gl:s}=this;this.size={width:e.width,height:e.height},(i=this.output)==null||i.resize(e);const n=s.getParameter(s.CURRENT_PROGRAM);s.useProgram(this.shaderProgram),this.uniformsLoc.size&&s.uniform2f(this.uniformsLoc.size,e.width,e.height),s.useProgram(n)}dispose(){var e;const{gl:i}=this;i.deleteBuffer(this.vertBuffer),this.vertBuffer=null,i.deleteFramebuffer(this.frameBuffer),this.frameBuffer=null,i.deleteShader(this.vertShader),this.vertShader=null,i.deleteShader(this.fragShader),this.fragShader=null,i.deleteProgram(this.shaderProgram),this.shaderProgram=null,(e=this.output)==null||e.dispose(),delete this.output}program(){return this.shaderProgram}compile(e,i){const{gl:s}=this,n=this.save(s);if(this.vertBuffer=s.createBuffer(),this.vertAttrs=s.createVertexArray(),this.frameBuffer=s.createFramebuffer(),!this.vertBuffer||!this.frameBuffer||!this.vertAttrs){s.deleteBuffer(this.vertBuffer),this.vertBuffer=null,s.deleteFramebuffer(this.frameBuffer),this.frameBuffer=null,s.deleteVertexArray(this.vertAttrs),this.vertAttrs=null;return}if(this.vertShader=s.createShader(s.VERTEX_SHADER),this.fragShader=s.createShader(s.FRAGMENT_SHADER),this.shaderProgram=s.createProgram(),!this.vertShader||!this.fragShader||!this.shaderProgram){s.deleteBuffer(this.vertBuffer),this.vertBuffer=null,s.deleteFramebuffer(this.frameBuffer),this.frameBuffer=null,s.deleteShader(this.vertShader),this.vertShader=null,s.deleteShader(this.fragShader),this.fragShader=null,s.deleteProgram(this.shaderProgram),this.shaderProgram=null;return}s.shaderSource(this.vertShader,i),s.shaderSource(this.fragShader,e),s.compileShader(this.vertShader),s.compileShader(this.fragShader),s.attachShader(this.shaderProgram,this.vertShader),s.attachShader(this.shaderProgram,this.fragShader),s.linkProgram(this.shaderProgram),s.useProgram(this.shaderProgram),s.bindBuffer(s.ARRAY_BUFFER,this.vertBuffer),s.bufferData(s.ARRAY_BUFFER,new Float32Array([-1,-1,1,1,-1,1,-1,-1,1,-1,1,1]),s.STATIC_DRAW),s.bindVertexArray(this.vertAttrs);const a=s.getAttribLocation(this.shaderProgram,"position");s.vertexAttribPointer(a,2,s.FLOAT,!1,0,0),s.enableVertexAttribArray(a),this.uniformsLoc={};for(let p in this.uniforms)this.uniformsLoc[p]=s.getUniformLocation(this.shaderProgram,p);for(let p=0;p<this.inputs.length;p++)s.uniform1i(s.getUniformLocation(this.shaderProgram,this.inputs[p]),p);this.restore(s,n)}prepare(e,i,s={}){const{size:{width:n,height:a}}=this;for(let p=0;p<i.length;p++)e.activeTexture(e.TEXTURE0+p),e.bindTexture(e.TEXTURE_2D,i[p]);e.useProgram(this.shaderProgram),e.bindVertexArray(this.vertAttrs);for(let p in s)switch(this.uniforms[p]){case"1f":this.uniformsLoc[p]&&s[p].length===1&&e.uniform1f(this.uniformsLoc[p],s[p][0]);break;case"2f":this.uniformsLoc[p]&&s[p].length===2&&e.uniform2f(this.uniformsLoc[p],s[p][0],s[p][1]);break;case"3f":this.uniformsLoc[p]&&s[p].length===3&&e.uniform3f(this.uniformsLoc[p],s[p][0],s[p][1],s[p][2]);break;case"4f":this.uniformsLoc[p]&&s[p].length===4&&e.uniform4f(this.uniformsLoc[p],s[p][0],s[p][1],s[p][2],s[p][3]);break}e.disable(e.CULL_FACE),e.colorMask(!0,!0,!0,!0),e.viewport(0,0,n,a),e.scissor(0,0,n,a)}save(e){return{program:e.getParameter(e.CURRENT_PROGRAM),arrayBuffer:e.getParameter(e.ARRAY_BUFFER_BINDING),framebuffer:e.getParameter(e.FRAMEBUFFER_BINDING),vertexArray:e.getParameter(e.VERTEX_ARRAY_BINDING),viewport:e.getParameter(e.VIEWPORT),scissor:e.getParameter(e.SCISSOR_BOX),colorMask:e.getParameter(e.COLOR_WRITEMASK),cullFace:e.getParameter(e.CULL_FACE),activeTexture:e.getParameter(e.ACTIVE_TEXTURE),textures:this.inputs.map((i,s)=>(e.activeTexture(e.TEXTURE0+s),e.getParameter(e.TEXTURE_BINDING_2D)))}}restore(e,i){e.useProgram(i.program),e.bindBuffer(e.ARRAY_BUFFER,i.arrayBuffer),e.bindFramebuffer(e.FRAMEBUFFER,i.framebuffer),e.bindVertexArray(i.vertexArray),e.viewport(i.viewport[0],i.viewport[1],i.viewport[2],i.viewport[3]),e.scissor(i.scissor[0],i.scissor[1],i.scissor[2],i.scissor[3]),e.colorMask(i.colorMask[0],i.colorMask[1],i.colorMask[2],i.colorMask[3]);for(let s=0;s<i.textures.length;s++)e.activeTexture(e.TEXTURE0+s),e.bindTexture(e.TEXTURE_2D,i.textures[s]);e.activeTexture(i.activeTexture),i.cullFace?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE)}}const d7=`
    attribute vec2 position;
    varying vec2 coords;
    uniform float flip;
    void main() {
        coords = (vec2(position.x, -position.y) + 1.0) * 0.5;
        gl_Position = vec4(position.x, position.y * flip, 0, 1.0);
    }
`,f7=`
    precision mediump float;
    varying vec2 coords;
    uniform vec2 size;
    uniform sampler2D image;
    void main() {
        gl_FragColor = texture2D(image, coords);
    }
`;var p7=Object.defineProperty,m7=(l,e,i)=>e in l?p7(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,c2=(l,e,i)=>(m7(l,typeof e!="symbol"?e+"":e,i),i);class Vm extends km{constructor(e){super(e),c2(this,"shaderCtx",null),c2(this,"shader"),c2(this,"input"),c2(this,"current",null);const i=this.canvas.layers[0];this.shaderCtx=i.getContext("webgl2",{alpha:!0,preserveDrawingBuffer:!0})}async load(){const{shaderCtx:e,videoSize:i}=this;if(e)return this.shader=new tE(e,i),this.input=new $T(e,i),super.load()}unload(){var e,i;(e=this.input)==null||e.dispose(),delete this.input,(i=this.shader)==null||i.dispose(),delete this.shader,super.unload()}async update(e,i){if(!this.loaded)return;const{input:s}=this,n=s?.texture();if(!(!s||!n))return s?.update(i),this.current=n,super.update(e,i)}updateVideo(e){this.shader&&(this.shader.render([this.current]),super.updateVideo(e))}setupVideo(e,i){var s,n;super.setupVideo(e,i);const{width:a,height:p}=this.videoSize;this.canvas.layers[0].width=a,this.canvas.layers[0].height=p,(s=this.input)==null||s.resize({width:a,height:p}),(n=this.shader)==null||n.resize({width:a,height:p})}}var _7=Object.defineProperty,g7=(l,e,i)=>e in l?_7(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,y7=(l,e,i)=>(g7(l,typeof e!="symbol"?e+"":e,i),i);class iE extends Vm{constructor(){super(...arguments),y7(this,"scene")}dispose(){delete this.scene,super.dispose()}}var b7=Object.defineProperty,v7=(l,e,i)=>e in l?b7(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,rE=(l,e,i)=>(v7(l,typeof e!="symbol"?e+"":e,i),i);class T7{constructor(){rE(this,"renderer"),rE(this,"loaded",!1)}async load(e){this.loaded||(this.renderer=e,this.loaded=!0)}unload(){this.loaded&&(this.loaded=!1)}async update(e,i){this.loaded}dispose(){this.unload()}setupVideo(e){}setupCamera(e,i){}}var E7=Object.defineProperty,A7=(l,e,i)=>e in l?E7(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,C7=(l,e,i)=>(A7(l,typeof e!="symbol"?e+"":e,i),i);class mY extends null{constructor(){super(...arguments),C7(this,"videoCtx")}async load(e){if(!(this.loaded||!(e instanceof a7)||!e.videoCtx))return this.videoCtx=e.videoCtx,super.load(e)}unload(){this.loaded&&(delete this.videoCtx,super.unload())}}var R7=Object.defineProperty,sE=Object.getOwnPropertySymbols,I7=Object.prototype.hasOwnProperty,S7=Object.prototype.propertyIsEnumerable,Gm=(l,e,i)=>e in l?R7(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,M7=(l,e)=>{for(var i in e||(e={}))I7.call(e,i)&&Gm(l,i,e[i]);if(sE)for(var i of sE(e))S7.call(e,i)&&Gm(l,i,e[i]);return l},nE=(l,e,i)=>(Gm(l,typeof e!="symbol"?e+"":e,i),i);class _Y extends null{constructor(e,i,s,n){super(),this.inputs=e,this.uniforms=i,this.fragSrc=s,this.vertSrc=n,nE(this,"shader"),nE(this,"size",{width:0,height:0})}async load(e){if(!(this.loaded||!(e instanceof Vm)||!e.shaderCtx))return this.shader=new tE(e.shaderCtx,this.size,this.inputs,this.uniforms,this.fragSrc,this.vertSrc),super.load(e)}unload(){var e;this.loaded&&((e=this.shader)==null||e.dispose(),delete this.shader,super.unload())}async update(e,i){var s,n;const{renderer:a}=this;if(!this.loaded||!(a instanceof Vm)||!a.current)return;const p=await this.process(e,a.current)&&((n=(s=this.shader)==null?void 0:s.output)==null?void 0:n.texture());p&&(a.current=p)}async process(e,i){var s;return(s=this.shader)==null||s.process([i]),!0}setupVideo(e){var i;this.size=M7({},e),(i=this.shader)==null||i.resize(e)}}var P7=Object.defineProperty,O7=(l,e,i)=>e in l?P7(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,w7=(l,e,i)=>(O7(l,typeof e!="symbol"?e+"":e,i),i);class D7 extends T7{constructor(){super(...arguments),w7(this,"scene")}async load(e){if(!(this.loaded||!(e instanceof iE)||!e.scene))return this.scene=e.scene,super.load(e)}unload(){this.loaded&&(delete this.scene,super.unload())}}class gY{constructor(e,i=!1,s="video",n){this.renderer=e,this.mirror=i,this.sizeMode=s,this.sizeMax=n}async snapshot(){return new Promise(e=>{this.renderer.once("render",()=>{const{renderer:i}=this,{layers:s}=i.canvas;let{width:n,height:a}=i.canvas.layers[0];this.sizeMode==="max"?(n=Math.max(...s.map(y=>y.width)),a=Math.max(...s.map(y=>y.height))):this.sizeMode==="min"&&(n=Math.min(...s.map(y=>y.width)),a=Math.min(...s.map(y=>y.height)));const p=document.createElement("canvas");p.id="engeenee.snapshot",p.hidden=!0,p.width=n,p.height=a;const _=p.getContext("2d",{alpha:!0});if(!_)return;this.mirror&&(_.translate(n,0),_.scale(-1,1)),s.forEach(y=>_.drawImage(y,0,0,n,a));const g=_.getImageData(0,0,n,a);p.remove(),e(g)})})}async snapshotLayers(){return new Promise(e=>{this.renderer.once("render",()=>{const i=document.createElement("canvas");i.id="engeenee.snapshot",i.hidden=!0;const s=i.getContext("2d",{alpha:!0});if(!s)return;const n=this.renderer.canvas.layers.map(a=>{const{width:p,height:_}=a;return i.width=p,i.height=_,s.resetTransform(),this.mirror&&(s.translate(p,0),s.scale(-1,1)),s.drawImage(a,0,0),s.getImageData(0,0,p,_)});i.remove(),e(n)})})}}var F7=Object.defineProperty,L7=(l,e,i)=>e in l?F7(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,dc=(l,e,i)=>(L7(l,typeof e!="symbol"?e+"":e,i),i);class N7{constructor(e,i="video/webm",s=!1,n="video",a,p){this.renderer=e,this.type=i,this.mirror=s,this.sizeMode=n,this.sizeMax=a,this.bitRate=p,dc(this,"canvas"),dc(this,"context",null),dc(this,"stream"),dc(this,"recorder"),dc(this,"records",[]),dc(this,"frame",()=>{var _;const{renderer:g,context:y,stream:b}=this,{width:v,height:S}=this.canvas;!b||!y||(g.canvas.layers.map(M=>y.drawImage(M,0,0,v,S)),(_=b.getVideoTracks()[0])==null||_.requestFrame())}),this.canvas=document.createElement("canvas"),this.canvas.id="engeenee.record",this.canvas.hidden=!0,this.context=this.canvas.getContext("2d",{alpha:!1})}start(){const{canvas:e,context:i,renderer:s}=this;if(!e||!i)return!1;const{layers:n}=s.canvas;let{width:a,height:p}=n[0];this.sizeMode==="max"?(a=Math.max(...n.map(g=>g.width)),p=Math.max(...n.map(g=>g.height))):this.sizeMode==="min"&&(a=Math.min(...n.map(g=>g.width)),p=Math.min(...n.map(g=>g.height)));const _=Math.max(a,p);if(this.sizeMax&&_>this.sizeMax){const g=this.sizeMax/_;a*=g,p*=g}return e.width=a,e.height=p,i.resetTransform(),this.mirror&&(i.translate(a,0),i.scale(-1,1)),s.on("render",this.frame),this.records=[],this.stream=e.captureStream(0),this.recorder=new MediaRecorder(this.stream,{mimeType:this.type,videoBitsPerSecond:this.bitRate}),this.recorder.ondataavailable=g=>this.records.push(g.data),this.recorder.start(),!0}async stop(){const{recorder:e}=this;if(!(!e||e.state!="recording"))return new Promise(i=>{e.onstop=()=>{var s;i(new Blob(this.records,{type:this.type})),this.records=[],(s=this.stream)==null||s.getVideoTracks().forEach(n=>n.stop()),this.renderer.removeListener("render",this.frame),delete this.stream,delete this.recorder},e.stop()})}dispose(){this.canvas.remove()}}var B7=Object.defineProperty,k7=(l,e,i)=>e in l?B7(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,Wm=(l,e,i)=>(k7(l,typeof e!="symbol"?e+"":e,i),i);class yY{constructor(e,i=0,s="video/webm",n){this.renderer=e,this.layer=i,this.type=s,this.bitRate=n,Wm(this,"stream"),Wm(this,"recorder"),Wm(this,"records",[])}start(){const{renderer:e}=this,i=e.canvas.layers[this.layer];return this.records=[],this.stream=i.captureStream(),this.recorder=new MediaRecorder(this.stream,{mimeType:this.type,videoBitsPerSecond:this.bitRate}),this.recorder.ondataavailable=s=>this.records.push(s.data),this.recorder.start(),!0}async stop(){const{recorder:e}=this;if(!(!e||e.state!="recording"))return new Promise(i=>{e.onstop=()=>{var s;i(new Blob(this.records,{type:this.type})),this.records=[],(s=this.stream)==null||s.getVideoTracks().forEach(n=>n.stop()),delete this.stream,delete this.recorder},e.stop()})}}var U7=Object.defineProperty,V7=(l,e,i)=>e in l?U7(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,h2=(l,e,i)=>(V7(l,typeof e!="symbol"?e+"":e,i),i);class bY{constructor(e,i=!1,s="video",n){this.renderer=e,this.mirror=i,this.sizeMode=s,this.sizeMax=n,h2(this,"canvas"),h2(this,"context",null),h2(this,"stream"),h2(this,"render",()=>{const{canvas:a,context:p}=this;!a||!p||this.renderer.canvas.layers.map(_=>p.drawImage(_,0,0,a.width,a.height))}),this.canvas=document.createElement("canvas"),this.canvas.id="engeenee.record",this.canvas.hidden=!0,this.mirror&&(this.canvas.style.transform="scaleX(-1)"),this.context=this.canvas.getContext("2d",{alpha:!1})}start(){const{canvas:e,context:i,renderer:s}=this;if(!e||!i)return!1;const{layers:n}=s.canvas;let{width:a,height:p}=n[0];this.sizeMode==="max"?(a=Math.max(...n.map(g=>g.width)),p=Math.max(...n.map(g=>g.height))):this.sizeMode==="min"&&(a=Math.min(...n.map(g=>g.width)),p=Math.min(...n.map(g=>g.height)));const _=Math.max(a,p);if(this.sizeMax&&_>this.sizeMax){const g=this.sizeMax/_;a*=g,p*=g}return e.width=a,e.height=p,i.resetTransform(),this.mirror&&(i.translate(a,0),i.scale(-1,1)),this.renderer.on("render",this.render),this.stream=e.captureStream(),!0}pause(){this.renderer.removeListener("render",this.render)}mediaStream(){return this.stream}}var G7=Object.defineProperty,W7=(l,e,i)=>e in l?G7(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,aE=(l,e,i)=>(W7(l,typeof e!="symbol"?e+"":e,i),i);class z7 extends null{constructor(){super(...arguments),aE(this,"faceTracker",new C),aE(this,"cameraAngleBase",10/180*Math.PI)}async init(e,i,s){return await this.faceTracker.init(e.token,e.root,e.cache,e.highp),await this.faceTracker.prepare(),super.init(e,i,s)}reset(){this.faceTracker.reset(),super.reset()}dispose(){this.faceTracker.dispose()}async process(e,i){return{faces:(await this.faceTracker.process(e,i)).map(s=>{const n=s&&this.params.transform?this.faceTracker.align(s.keypoints):void 0,a=n&&this.params.metric?this.faceTracker.metricPoints():void 0,p=n&&this.params.backproj?this.faceTracker.backprojPoints():void 0;return{mesh:s,transform:n,metric:a,backproj:p}})}}setupVideo(e,i){super.setupVideo(e,i),this.cameraAngle=this.cameraRatio>=1?this.cameraAngleBase:2*Math.atan(Math.tan(.5*this.cameraAngleBase)/this.cameraRatio),this.faceTracker.setCamera(this.cameraAngle,this.cameraRatio,1),this.faceTracker.reset()}}class vY extends null{constructor(e,i=q){super(z7,e,i)}}var H7=Object.defineProperty,X7=(l,e,i)=>e in l?H7(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,oE=(l,e,i)=>(X7(l,typeof e!="symbol"?e+"":e,i),i);class Y7 extends W8{constructor(){super(),oE(this,"poseTracker",new K6),oE(this,"cameraAngleBase",15/180*Math.PI);const e=/iPhone|iPad|iPod/i.test(navigator.userAgent);this.optimalSize=e?512:1024}async init(e,i,s){return await this.poseTracker.init(e.token,e.root,e.cache,e.mask),await this.poseTracker.prepare(),super.init(e,i,s)}reset(){return this.poseTracker.reset(),super.reset()}dispose(){this.poseTracker.dispose()}async process(e,i){return{poses:(await this.poseTracker.process(e,i)).map(s=>({points:j7.reduce((n,a,p)=>(n[a]=s.keypoints[p],n),{}),score:s.score,mask:s.mask,timestamp:i,debug:s.debug}))}}setupVideo(e,i){super.setupVideo(e,i),this.cameraAngle=this.cameraRatio>=1?this.cameraAngleBase:2*Math.atan(Math.tan(.5*this.cameraAngleBase)/this.cameraRatio),this.poseTracker.setCamera(this.cameraAngle,this.cameraRatio,1),this.poseTracker.reset()}}class K7 extends B8{constructor(e,i=qT){super(Y7,e,i)}}const j7=["nose","eyeInnerL","eyeL","eyeOutterL","eyeInnerR","eyeR","eyeOutterR","earL","earR","mouthL","mouthR","shoulderL","shoulderR","elbowL","elbowR","wristL","wristR","pinkyL","pinkyR","indexL","indexR","thumbL","thumbR","hipL","hipR","kneeL","kneeR","ankleL","ankleR","heelL","heelR","footIndexL","footIndexR"];var q7=Object.defineProperty,Z7=(l,e,i)=>e in l?q7(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,xE=(l,e,i)=>(Z7(l,typeof e!="symbol"?e+"":e,i),i);class Q7 extends null{constructor(){super(...arguments),xE(this,"handTracker",new V),xE(this,"cameraAngleBase",10/180*Math.PI)}async init(e,i,s){return await this.handTracker.init(e.token,e.root,e.cache),await this.handTracker.prepare(),super.init(e,i,s)}reset(){this.handTracker.reset(),super.reset()}dispose(){this.handTracker.dispose()}async process(e,i){return{hands:(await this.handTracker.process(e,i)).map(s=>({points:s.keypoints,score:s.score,handedness:s.handedness,wrist:s.wrist}))}}setupVideo(e,i){super.setupVideo(e,i),this.cameraAngle=this.cameraRatio>=1?this.cameraAngleBase:2*Math.atan(Math.tan(.5*this.cameraAngleBase)/this.cameraRatio),this.handTracker.setCamera(this.cameraAngle,this.cameraRatio,1),this.handTracker.reset()}}class TY extends null{constructor(e,i=q){super(Q7,e,i)}}class $7{constructor(e,i=!1,s,n){this.initialize(e,i,s,n)}initialize(e,i=!1,s,n){return this.mask=e,this.skipNextObservers=i,this.target=s,this.currentTarget=n,this}}class J7{constructor(e,i,s=null){this.callback=e,this.mask=i,this.scope=s,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1}}class Re{static FromPromise(e,i){const s=new Re;return e.then(n=>{s.notifyObservers(n)}).catch(n=>{if(i)i.notifyObservers(n);else throw n}),s}get observers(){return this._observers}constructor(e,i=!1){this.notifyIfTriggered=i,this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._hasNotified=!1,this._eventState=new $7(0),e&&(this._onObserverAdded=e)}add(e,i=-1,s=!1,n=null,a=!1){if(!e)return null;const p=new J7(e,i,n);return p.unregisterOnNextCall=a,s?this._observers.unshift(p):this._observers.push(p),this._onObserverAdded&&this._onObserverAdded(p),this._hasNotified&&this.notifyIfTriggered&&this._lastNotifiedValue!==void 0&&this.notifyObserver(p,this._lastNotifiedValue),p}addOnce(e){return this.add(e,void 0,void 0,void 0,!0)}remove(e){return e&&this._observers.indexOf(e)!==-1?(this._deferUnregister(e),!0):!1}removeCallback(e,i){for(let s=0;s<this._observers.length;s++){const n=this._observers[s];if(!n._willBeUnregistered&&n.callback===e&&(!i||i===n.scope))return this._deferUnregister(n),!0}return!1}_deferUnregister(e){e._willBeUnregistered||(this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout(()=>{this._remove(e)},0))}_remove(e,i=!0){if(!e)return!1;const s=this._observers.indexOf(e);return s!==-1?(i&&this._numObserversMarkedAsDeleted--,this._observers.splice(s,1),!0):!1}makeObserverTopPriority(e){this._remove(e,!1),this._observers.unshift(e)}makeObserverBottomPriority(e){this._remove(e,!1),this._observers.push(e)}notifyObservers(e,i=-1,s,n,a){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=e),!this._observers.length)return!0;const p=this._eventState;p.mask=i,p.target=s,p.currentTarget=n,p.skipNextObservers=!1,p.lastReturnValue=e,p.userInfo=a;for(const _ of this._observers)if(!_._willBeUnregistered&&(_.mask&i&&(_.unregisterOnNextCall&&this._deferUnregister(_),_.scope?p.lastReturnValue=_.callback.apply(_.scope,[e,p]):p.lastReturnValue=_.callback(e,p)),p.skipNextObservers))return!1;return!0}notifyObserver(e,i,s=-1){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=i),e._willBeUnregistered)return;const n=this._eventState;n.mask=s,n.skipNextObservers=!1,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(i,n)}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){this._observers.length=0,this._onObserverAdded=null,this._numObserversMarkedAsDeleted=0,this.cleanLastNotifiedState()}cleanLastNotifiedState(){this._hasNotified=!1,this._lastNotifiedValue=void 0}clone(){const e=new Re;return e._observers=this._observers.slice(0),e}hasSpecificMask(e=-1){for(const i of this._observers)if(i.mask&e||i.mask===e)return!0;return!1}}class e9{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(e=1,i=1,s=1,n=1,a=2,p=0){return this._cachedWrapU=e,this._cachedWrapV=i,this._cachedWrapR=s,this._cachedAnisotropicFilteringLevel=n,this.samplingMode=a,this._comparisonFunction=p,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}}var or;(function(l){l[l.Unknown=0]="Unknown",l[l.Url=1]="Url",l[l.Temp=2]="Temp",l[l.Raw=3]="Raw",l[l.Dynamic=4]="Dynamic",l[l.RenderTarget=5]="RenderTarget",l[l.MultiRenderTarget=6]="MultiRenderTarget",l[l.Cube=7]="Cube",l[l.CubeRaw=8]="CubeRaw",l[l.CubePrefiltered=9]="CubePrefiltered",l[l.Raw3D=10]="Raw3D",l[l.Raw2DArray=11]="Raw2DArray",l[l.DepthStencil=12]="DepthStencil",l[l.CubeRawRGBD=13]="CubeRawRGBD",l[l.Depth=14]="Depth"})(or||(or={}));class Bs extends e9{get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e}get uniqueId(){return this._uniqueId}_setUniqueId(e){this._uniqueId=e}getEngine(){return this._engine}get source(){return this._source}constructor(e,i,s=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new Re,this.onErrorObservable=new Re,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=or.Unknown,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._engine=e,this._source=i,this._uniqueId=Bs._Counter++,s||(this._hardwareTexture=e._createHardwareTexture())}incrementReferences(){this._references++}updateSize(e,i,s=1){this._engine.updateTextureDimensions(this,e,i,s),this.width=e,this.height=i,this.depth=s,this.baseWidth=e,this.baseHeight=i,this.baseDepth=s,this._size=e*i*s}_rebuild(){var e;if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){const s=this.onRebuildCallback(this),n=a=>{a._swapAndDie(this,!1),this.isReady=s.isReady};s.isAsync?s.proxy.then(n):n(s.proxy);return}let i;switch(this.source){case or.Temp:break;case or.Url:i=this._engine.createTexture((e=this._originalUrl)!==null&&e!==void 0?e:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,s=>{s._swapAndDie(this,!1),this.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer);return;case or.Raw:i=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,void 0,this._useSRGBBuffer),i._swapAndDie(this,!1),this.isReady=!0;break;case or.Raw3D:i=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),i._swapAndDie(this,!1),this.isReady=!0;break;case or.Raw2DArray:i=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),i._swapAndDie(this,!1),this.isReady=!0;break;case or.Dynamic:i=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),i._swapAndDie(this,!1),this._engine.updateDynamicTexture(this,this._engine.getRenderingCanvas(),this.invertY,void 0,void 0,!0);break;case or.Cube:i=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,()=>{i._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer);return;case or.CubeRaw:i=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),i._swapAndDie(this,!1),this.isReady=!0;break;case or.CubeRawRGBD:return;case or.CubePrefiltered:i=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,s=>{s&&s._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension),i._sphericalPolynomial=this._sphericalPolynomial;return}}_swapAndDie(e,i=!0){var s;(s=this._hardwareTexture)===null||s===void 0||s.setUsage(e._source,this.generateMipMaps,this.isCube,this.width,this.height),e._hardwareTexture=this._hardwareTexture,i&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);const n=this._engine.getLoadedTexturesCache();let a=n.indexOf(this);a!==-1&&n.splice(a,1),a=n.indexOf(e),a===-1&&n.push(e)}dispose(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._references===0&&(this._engine._releaseTexture(this),this._hardwareTexture=null)}}Bs._Counter=0;function Ts(){return typeof window<"u"}function zm(){return typeof navigator<"u"}function Lh(){return typeof document<"u"}function Hm(l){let e="",i=l.firstChild;for(;i;)i.nodeType===3&&(e+=i.textContent),i=i.nextSibling;return e}const Xm={IsWindowObjectExist:Ts,IsNavigatorAvailable:zm,IsDocumentAvailable:Lh,GetDOMTextContent:Hm};class Zt{static get LastCreatedEngine(){return this.Instances.length===0?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}}Zt.Instances=new Array,Zt.OnEnginesDisposedObservable=new Re,Zt._LastCreatedScene=null,Zt.UseFallbackTexture=!0,Zt.FallbackTexture="";function xi(l){return`${l} needs to be imported before as it contains a side-effect required by your code.`}class Ie{static _CheckLimit(e,i){let s=Ie._LogLimitOutputs[e];return s?s.current++:(s={limit:i,current:1},Ie._LogLimitOutputs[e]=s),s.current<=s.limit}static _GenerateLimitMessage(e,i=1){var s;const n=Ie._LogLimitOutputs[e];if(!n||!Ie.MessageLimitReached)return;const a=this._Levels[i];n.current===n.limit&&Ie[a.name](Ie.MessageLimitReached.replace(/%LIMIT%/g,""+n.limit).replace(/%TYPE%/g,(s=a.name)!==null&&s!==void 0?s:""))}static _AddLogEntry(e){Ie._LogCache=e+Ie._LogCache,Ie.OnNewCacheEntry&&Ie.OnNewCacheEntry(e)}static _FormatMessage(e){const i=n=>n<10?"0"+n:""+n,s=new Date;return"["+i(s.getHours())+":"+i(s.getMinutes())+":"+i(s.getSeconds())+"]: "+e}static _LogDisabled(e,i){}static _LogEnabled(e=1,i,s){if(s!==void 0&&!Ie._CheckLimit(i,s))return;const n=Ie._FormatMessage(i),a=this._Levels[e];a.logFunc&&a.logFunc("BJS - "+n);const p=`<div style='color:${a.color}'>${n}</div><br>`;Ie._AddLogEntry(p),Ie._GenerateLimitMessage(i,e)}static get LogCache(){return Ie._LogCache}static ClearLogCache(){Ie._LogCache="",Ie._LogLimitOutputs={},Ie.errorsCount=0}static set LogLevels(e){Ie.Log=Ie._LogDisabled,Ie.Warn=Ie._LogDisabled,Ie.Error=Ie._LogDisabled,[Ie.MessageLogLevel,Ie.WarningLogLevel,Ie.ErrorLogLevel].forEach(i=>{if((e&i)===i){const s=this._Levels[i];Ie[s.name]=Ie._LogEnabled.bind(Ie,i)}})}}Ie.NoneLogLevel=0,Ie.MessageLogLevel=1,Ie.WarningLogLevel=2,Ie.ErrorLogLevel=4,Ie.AllLogLevel=7,Ie.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.",Ie._LogCache="",Ie._LogLimitOutputs={},Ie._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}],Ie.errorsCount=0,Ie.Log=Ie._LogEnabled.bind(Ie,Ie.MessageLogLevel),Ie.Warn=Ie._LogEnabled.bind(Ie,Ie.WarningLogLevel),Ie.Error=Ie._LogEnabled.bind(Ie,Ie.ErrorLogLevel);const t9="attribute",i9="varying";class Nh{constructor(){this.children=[]}isValid(e){return!0}process(e,i){var s,n,a,p,_,g;let y="";if(this.line){let b=this.line;const v=i.processor;if(v){v.lineProcessor&&(b=v.lineProcessor(b,i.isFragment,i.processingContext));const S=(n=(s=i.processor)===null||s===void 0?void 0:s.attributeKeywordName)!==null&&n!==void 0?n:t9,M=i.isFragment&&((a=i.processor)===null||a===void 0?void 0:a.varyingFragmentKeywordName)?(p=i.processor)===null||p===void 0?void 0:p.varyingFragmentKeywordName:!i.isFragment&&((_=i.processor)===null||_===void 0?void 0:_.varyingVertexKeywordName)?(g=i.processor)===null||g===void 0?void 0:g.varyingVertexKeywordName:i9;!i.isFragment&&v.attributeProcessor&&this.line.startsWith(S)?b=v.attributeProcessor(this.line,e,i.processingContext):v.varyingProcessor&&this.line.startsWith(M)?b=v.varyingProcessor(this.line,i.isFragment,e,i.processingContext):v.uniformProcessor&&v.uniformRegexp&&v.uniformRegexp.test(this.line)?i.lookForClosingBracketForUniformBuffer||(b=v.uniformProcessor(this.line,i.isFragment,e,i.processingContext)):v.uniformBufferProcessor&&v.uniformBufferRegexp&&v.uniformBufferRegexp.test(this.line)?i.lookForClosingBracketForUniformBuffer||(b=v.uniformBufferProcessor(this.line,i.isFragment,i.processingContext),i.lookForClosingBracketForUniformBuffer=!0):v.textureProcessor&&v.textureRegexp&&v.textureRegexp.test(this.line)?b=v.textureProcessor(this.line,i.isFragment,e,i.processingContext):(v.uniformProcessor||v.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!i.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?v.uniformProcessor&&(b=v.uniformProcessor(this.line,i.isFragment,e,i.processingContext)):v.uniformBufferProcessor&&(b=v.uniformBufferProcessor(this.line,i.isFragment,i.processingContext),i.lookForClosingBracketForUniformBuffer=!0)),i.lookForClosingBracketForUniformBuffer&&this.line.indexOf("}")!==-1&&(i.lookForClosingBracketForUniformBuffer=!1,v.endOfUniformBufferProcessor&&(b=v.endOfUniformBufferProcessor(this.line,i.isFragment,i.processingContext)))}y+=b+`\r
`}return this.children.forEach(b=>{y+=b.process(e,i)}),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),y}}class r9{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(const i of e){if(i[0]==="#"){this._lines.push(i);continue}if(i.trim().startsWith("//")){this._lines.push(i);continue}const s=i.split(";");for(let n=0;n<s.length;n++){let a=s[n];a=a.trim(),a&&this._lines.push(a+(n!==s.length-1?";":""))}}}}class Ym extends Nh{process(e,i){for(let s=0;s<this.children.length;s++){const n=this.children[s];if(n.isValid(e))return n.process(e,i)}return""}}class s9 extends Nh{isValid(e){return this.testExpression.isTrue(e)}}class Cn{isTrue(e){return!0}static postfixToInfix(e){const i=[];for(const s of e)if(Cn._OperatorPriority[s]===void 0)i.push(s);else{const n=i[i.length-1],a=i[i.length-2];i.length-=2,i.push(`(${a}${s}${n})`)}return i[i.length-1]}static infixToPostfix(e){const i=[];let s=-1;const n=()=>{y=y.trim(),y!==""&&(i.push(y),y="")},a=b=>{s<Cn._Stack.length-1&&(Cn._Stack[++s]=b)},p=()=>Cn._Stack[s],_=()=>s===-1?"!!INVALID EXPRESSION!!":Cn._Stack[s--];let g=0,y="";for(;g<e.length;){const b=e.charAt(g),v=g<e.length-1?e.substr(g,2):"";if(b==="(")y="",a(b);else if(b===")"){for(n();s!==-1&&p()!=="(";)i.push(_());_()}else if(Cn._OperatorPriority[v]>1){for(n();s!==-1&&Cn._OperatorPriority[p()]>=Cn._OperatorPriority[v];)i.push(_());a(v),g++}else y+=b;g++}for(n();s!==-1;)p()==="("?_():i.push(_());return i}}Cn._OperatorPriority={")":0,"(":1,"||":2,"&&":3},Cn._Stack=["","","","","","","","","","","","","","","","","","","",""];class u2 extends Cn{constructor(e,i=!1){super(),this.define=e,this.not=i}isTrue(e){let i=e[this.define]!==void 0;return this.not&&(i=!i),i}}class n9 extends Cn{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}class a9 extends Cn{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}class o9 extends Cn{constructor(e,i,s){super(),this.define=e,this.operand=i,this.testValue=s}isTrue(e){let i=e[this.define];i===void 0&&(i=this.define);let s=!1;const n=parseInt(i),a=parseInt(this.testValue);switch(this.operand){case">":s=n>a;break;case"<":s=n<a;break;case"<=":s=n<=a;break;case">=":s=n>=a;break;case"==":s=n===a;break}return s}}var ks;(function(l){l[l.GLSL=0]="GLSL",l[l.WGSL=1]="WGSL"})(ks||(ks={}));const x9=/defined\s*?\((.+?)\)/g,Km=/defined\s*?\[(.+?)\]/g,lE=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g;class hl{static Initialize(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)}static Process(e,i,s,n){var a;!((a=i.processor)===null||a===void 0)&&a.preProcessShaderCode&&(e=i.processor.preProcessShaderCode(e,i.isFragment)),this._ProcessIncludes(e,i,p=>{i.processCodeAfterIncludes&&(p=i.processCodeAfterIncludes(i.isFragment?"fragment":"vertex",p));const _=this._ProcessShaderConversion(p,i,n);s(_,p)})}static PreProcess(e,i,s,n){var a;!((a=i.processor)===null||a===void 0)&&a.preProcessShaderCode&&(e=i.processor.preProcessShaderCode(e,i.isFragment)),this._ProcessIncludes(e,i,p=>{i.processCodeAfterIncludes&&(p=i.processCodeAfterIncludes(i.isFragment?"fragment":"vertex",p));const _=this._ApplyPreProcessing(p,i,n);s(_,p)})}static Finalize(e,i,s){return!s.processor||!s.processor.finalizeShaders?{vertexCode:e,fragmentCode:i}:s.processor.finalizeShaders(e,i,s.processingContext)}static _ProcessPrecision(e,i){var s;if(!((s=i.processor)===null||s===void 0)&&s.noPrecision)return e;const n=i.shouldUseHighPrecisionShader;return e.indexOf("precision highp float")===-1?n?e=`precision highp float;
`+e:e=`precision mediump float;
`+e:n||(e=e.replace("precision highp float","precision mediump float")),e}static _ExtractOperation(e){const s=/defined\((.+)\)/.exec(e);if(s&&s.length)return new u2(s[1].trim(),e[0]==="!");const n=["==",">=","<=","<",">"];let a="",p=0;for(a of n)if(p=e.indexOf(a),p>-1)break;if(p===-1)return new u2(e);const _=e.substring(0,p).trim(),g=e.substring(p+a.length).trim();return new o9(_,a,g)}static _BuildSubExpression(e){e=e.replace(x9,"defined[$1]");const i=Cn.infixToPostfix(e),s=[];for(const a of i)if(a!=="||"&&a!=="&&")s.push(a);else if(s.length>=2){let p=s[s.length-1],_=s[s.length-2];s.length-=2;const g=a=="&&"?new a9:new n9;typeof p=="string"&&(p=p.replace(Km,"defined($1)")),typeof _=="string"&&(_=_.replace(Km,"defined($1)")),g.leftOperand=typeof _=="string"?this._ExtractOperation(_):_,g.rightOperand=typeof p=="string"?this._ExtractOperation(p):p,s.push(g)}let n=s[s.length-1];return typeof n=="string"&&(n=n.replace(Km,"defined($1)")),typeof n=="string"?this._ExtractOperation(n):n}static _BuildExpression(e,i){const s=new s9,n=e.substring(0,i);let a=e.substring(i);return a=a.substring(0,(a.indexOf("//")+1||a.length+1)-1).trim(),n==="#ifdef"?s.testExpression=new u2(a):n==="#ifndef"?s.testExpression=new u2(a,!0):s.testExpression=this._BuildSubExpression(a),s}static _MoveCursorWithinIf(e,i,s){let n=e.currentLine;for(;this._MoveCursor(e,s);){n=e.currentLine;const a=n.substring(0,5).toLowerCase();if(a==="#else"){const p=new Nh;i.children.push(p),this._MoveCursor(e,p);return}else if(a==="#elif"){const p=this._BuildExpression(n,5);i.children.push(p),s=p}}}static _MoveCursor(e,i){for(;e.canRead;){e.lineIndex++;const s=e.currentLine,a=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/.exec(s);if(a&&a.length)switch(a[0]){case"#ifdef":{const _=new Ym;i.children.push(_);const g=this._BuildExpression(s,6);_.children.push(g),this._MoveCursorWithinIf(e,_,g);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{const _=new Ym;i.children.push(_);const g=this._BuildExpression(s,7);_.children.push(g),this._MoveCursorWithinIf(e,_,g);break}case"#if":{const _=new Ym,g=this._BuildExpression(s,3);i.children.push(_),_.children.push(g),this._MoveCursorWithinIf(e,_,g);break}}else{const p=new Nh;if(p.line=s,i.children.push(p),s[0]==="#"&&s[1]==="d"){const _=s.replace(";","").split(" ");p.additionalDefineKey=_[1],_.length===3&&(p.additionalDefineValue=_[2])}}}return!1}static _EvaluatePreProcessors(e,i,s){const n=new Nh,a=new r9;return a.lineIndex=-1,a.lines=e.split(`
`),this._MoveCursor(a,n),n.process(i,s)}static _PreparePreProcessors(e,i){var s;const n=e.defines,a={};for(const p of n){const g=p.replace("#define","").replace(";","").trim().split(" ");a[g[0]]=g.length>1?g[1]:""}return((s=e.processor)===null||s===void 0?void 0:s.shaderLanguage)===ks.GLSL&&(a.GL_ES="true"),a.__VERSION__=e.version,a[e.platformName]="true",i._getGlobalDefines(a),a}static _ProcessShaderConversion(e,i,s){let n=this._ProcessPrecision(e,i);if(!i.processor||i.processor.shaderLanguage===ks.GLSL&&n.indexOf("#version 3")!==-1&&(n=n.replace("#version 300 es",""),!i.processor.parseGLES3))return n;const a=i.defines,p=this._PreparePreProcessors(i,s);return i.processor.preProcessor&&(n=i.processor.preProcessor(n,a,i.isFragment,i.processingContext)),n=this._EvaluatePreProcessors(n,p,i),i.processor.postProcessor&&(n=i.processor.postProcessor(n,a,i.isFragment,i.processingContext,s)),s._features.needShaderCodeInlining&&(n=s.inlineShaderCode(n)),n}static _ApplyPreProcessing(e,i,s){var n,a;let p=e;const _=i.defines,g=this._PreparePreProcessors(i,s);return!((n=i.processor)===null||n===void 0)&&n.preProcessor&&(p=i.processor.preProcessor(p,_,i.isFragment,i.processingContext)),p=this._EvaluatePreProcessors(p,g,i),!((a=i.processor)===null||a===void 0)&&a.postProcessor&&(p=i.processor.postProcessor(p,_,i.isFragment,i.processingContext,s)),s._features.needShaderCodeInlining&&(p=s.inlineShaderCode(p)),p}static _ProcessIncludes(e,i,s){let n=lE.exec(e),a=new String(e),p=!1;for(;n!=null;){let _=n[1];if(_.indexOf("__decl__")!==-1&&(_=_.replace(/__decl__/,""),i.supportsUniformBuffers&&(_=_.replace(/Vertex/,"Ubo"),_=_.replace(/Fragment/,"Ubo")),_=_+"Declaration"),i.includesShadersStore[_]){let g=i.includesShadersStore[_];if(n[2]){const y=n[3].split(",");for(let b=0;b<y.length;b+=2){const v=new RegExp(y[b],"g"),S=y[b+1];g=g.replace(v,S)}}if(n[4]){const y=n[5];if(y.indexOf("..")!==-1){const b=y.split(".."),v=parseInt(b[0]);let S=parseInt(b[1]),M=g.slice(0);g="",isNaN(S)&&(S=i.indexParameters[b[1]]);for(let F=v;F<S;F++)i.supportsUniformBuffers||(M=M.replace(/light\{X\}.(\w*)/g,(L,N)=>N+"{X}")),g+=M.replace(/\{X\}/g,F.toString())+`
`}else i.supportsUniformBuffers||(g=g.replace(/light\{X\}.(\w*)/g,(b,v)=>v+"{X}")),g=g.replace(/\{X\}/g,y)}a=a.replace(n[0],g),p=p||g.indexOf("#include<")>=0||g.indexOf("#include <")>=0}else{const g=i.shadersRepository+"ShadersInclude/"+_+".fx";hl._FileToolsLoadFile(g,y=>{i.includesShadersStore[_]=y,this._ProcessIncludes(a,i,s)});return}n=lE.exec(e)}p?this._ProcessIncludes(a.toString(),i,s):s(a)}static _FileToolsLoadFile(e,i,s,n,a,p){throw xi("FileTools")}}class Ye{static GetShadersRepository(e=ks.GLSL){return e===ks.GLSL?Ye.ShadersRepository:Ye.ShadersRepositoryWGSL}static GetShadersStore(e=ks.GLSL){return e===ks.GLSL?Ye.ShadersStore:Ye.ShadersStoreWGSL}static GetIncludesShadersStore(e=ks.GLSL){return e===ks.GLSL?Ye.IncludesShadersStore:Ye.IncludesShadersStoreWGSL}}Ye.ShadersRepository="src/Shaders/",Ye.ShadersStore={},Ye.IncludesShadersStore={},Ye.ShadersRepositoryWGSL="src/ShadersWGSL/",Ye.ShadersStoreWGSL={},Ye.IncludesShadersStoreWGSL={};class ir{static get ShadersRepository(){return Ye.ShadersRepository}static set ShadersRepository(e){Ye.ShadersRepository=e}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new Re),this._onBindObservable}constructor(e,i,s,n=null,a,p=null,_=null,g=null,y=null,b,v="",S=ks.GLSL){var M,F,L;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new Re,this.onErrorObservable=new Re,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!1,this._wasPreviouslyUsingInstances=null,this._isDisposed=!1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this.name=e,this._key=v;let N,k=null;if(i.attributes){const Q=i;if(this._engine=s,this._attributesNames=Q.attributes,this._uniformsNames=Q.uniformsNames.concat(Q.samplers),this._samplerList=Q.samplers.slice(),this.defines=Q.defines,this.onError=Q.onError,this.onCompiled=Q.onCompiled,this._fallbacks=Q.fallbacks,this._indexParameters=Q.indexParameters,this._transformFeedbackVaryings=Q.transformFeedbackVaryings||null,this._multiTarget=!!Q.multiTarget,this._shaderLanguage=(M=Q.shaderLanguage)!==null&&M!==void 0?M:ks.GLSL,Q.uniformBuffersNames){this._uniformBuffersNamesList=Q.uniformBuffersNames.slice();for(let se=0;se<Q.uniformBuffersNames.length;se++)this._uniformBuffersNames[Q.uniformBuffersNames[se]]=se}k=(F=Q.processFinalCode)!==null&&F!==void 0?F:null,N=(L=Q.processCodeAfterIncludes)!==null&&L!==void 0?L:void 0}else this._engine=a,this.defines=p??"",this._uniformsNames=s.concat(n),this._samplerList=n?n.slice():[],this._attributesNames=i,this._uniformBuffersNamesList=[],this._shaderLanguage=S,this.onError=y,this.onCompiled=g,this._indexParameters=b,this._fallbacks=_;this._attributeLocationByName={},this.uniqueId=ir._UniqueIdSeed++;let G,H;const z=Ts()?this._engine.getHostDocument():null;e.vertexSource?G="source:"+e.vertexSource:e.vertexElement?(G=z?z.getElementById(e.vertexElement):null,G||(G=e.vertexElement)):G=e.vertex||e,e.fragmentSource?H="source:"+e.fragmentSource:e.fragmentElement?(H=z?z.getElementById(e.fragmentElement):null,H||(H=e.fragmentElement)):H=e.fragment||e,this._processingContext=this._engine._getShaderProcessingContext(this._shaderLanguage);let W={defines:this.defines.split(`
`),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:Ye.GetShadersRepository(this._shaderLanguage),includesShadersStore:Ye.GetIncludesShadersStore(this._shaderLanguage),version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:N};const Y=[void 0,void 0],Z=()=>{if(Y[0]&&Y[1]){W.isFragment=!0;const[Q,se]=Y;hl.Process(se,W,($,oe)=>{this._fragmentSourceCodeBeforeMigration=oe,k&&($=k("fragment",$));const ue=hl.Finalize(Q,$,W);W=null,this._useFinalCode(ue.vertexCode,ue.fragmentCode,e)},this._engine)}};this._loadShader(G,"Vertex","",Q=>{hl.Initialize(W),hl.Process(Q,W,(se,$)=>{this._rawVertexSourceCode=Q,this._vertexSourceCodeBeforeMigration=$,k&&(se=k("vertex",se)),Y[0]=se,Z()},this._engine)}),this._loadShader(H,"Fragment","Pixel",Q=>{this._rawFragmentSourceCode=Q,Y[1]=Q,Z()})}_useFinalCode(e,i,s){if(s){const n=s.vertexElement||s.vertex||s.spectorName||s,a=s.fragmentElement||s.fragment||s.spectorName||s;this._vertexSourceCode=(this._shaderLanguage===ks.WGSL?"//":"")+"#define SHADER_NAME vertex:"+n+`
`+e,this._fragmentSourceCode=(this._shaderLanguage===ks.WGSL?"//":"")+"#define SHADER_NAME fragment:"+a+`
`+i}else this._vertexSourceCode=e,this._fragmentSourceCode=i;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}executeWhenCompiled(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(i=>{e(i)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16)}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(i){this._processCompilationErrors(i,e);return}this._isDisposed||setTimeout(()=>{this._checkIsReady(e)},16)}_loadShader(e,i,s,n){if(typeof HTMLElement<"u"&&e instanceof HTMLElement){const _=Hm(e);n(_);return}if(e.substr(0,7)==="source:"){n(e.substr(7));return}if(e.substr(0,7)==="base64:"){const _=window.atob(e.substr(7));n(_);return}const a=Ye.GetShadersStore(this._shaderLanguage);if(a[e+i+"Shader"]){n(a[e+i+"Shader"]);return}if(s&&a[e+s+"Shader"]){n(a[e+s+"Shader"]);return}let p;e[0]==="."||e[0]==="/"||e.indexOf("http")>-1?p=e:p=Ye.GetShadersRepository(this._shaderLanguage)+e,this._engine._loadFile(p+"."+i.toLowerCase()+".fx",n)}get vertexSourceCode(){var e,i;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:(i=(e=this._pipelineContext)===null||e===void 0?void 0:e._getVertexShaderCode())!==null&&i!==void 0?i:this._vertexSourceCode}get fragmentSourceCode(){var e,i;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:(i=(e=this._pipelineContext)===null||e===void 0?void 0:e._getFragmentShaderCode())!==null&&i!==void 0?i:this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}_rebuildProgram(e,i,s,n){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=i,this.onError=(a,p)=>{n&&n(p)},this.onCompiled=()=>{const a=this.getEngine().scenes;if(a)for(let p=0;p<a.length;p++)a[p].markAllMaterialsAsDirty(63);this._pipelineContext._handlesSpectorRebuildCallback(s)},this._fallbacks=null,this._prepareEffect()}_prepareEffect(){const e=this._attributesNames,i=this.defines,s=this._pipelineContext;this._isReady=!1;try{const n=this._engine;this._pipelineContext=n.createPipelineContext(this._processingContext),this._pipelineContext._name=this._key;const a=this._rebuildProgram.bind(this);this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?n._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,this._rawVertexSourceCode,this._rawFragmentSourceCode,a,null,this._transformFeedbackVaryings,this._key):n._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,this._rawVertexSourceCode,this._rawFragmentSourceCode,a,i,this._transformFeedbackVaryings,this._key),n._executeWhenRenderingStateIsCompiled(this._pipelineContext,()=>{if(this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,e,this._attributes),e)for(let p=0;p<e.length;p++){const _=e[p];this._attributeLocationByName[_]=this._attributes[p]}n.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),s&&this.getEngine()._deletePipelineContext(s)}),this._pipelineContext.isAsync&&this._checkIsReady(s)}catch(n){this._processCompilationErrors(n,s)}}_getShaderCodeAndErrorLine(e,i,s){const n=s?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/;let a=null;if(i&&e){const p=i.match(n);if(p&&p.length===2){const _=parseInt(p[1]),g=e.split(`
`,-1);g.length>=_&&(a=`Offending line [${_}] in ${s?"fragment":"vertex"} code: ${g[_-1]}`)}}return[e,a]}_processCompilationErrors(e,i=null){var s,n,a;this._compilationError=e.message;const p=this._attributesNames,_=this._fallbacks;if(Ie.Error("Unable to compile effect:"),Ie.Error("Uniforms: "+this._uniformsNames.map(function(y){return" "+y})),Ie.Error("Attributes: "+p.map(function(y){return" "+y})),Ie.Error(`Defines:\r
`+this.defines),ir.LogShaderCodeOnCompilationError){let y=null,b=null,v=null;!((s=this._pipelineContext)===null||s===void 0)&&s._getVertexShaderCode()&&([v,y]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),v&&(Ie.Error("Vertex code:"),Ie.Error(v))),!((n=this._pipelineContext)===null||n===void 0)&&n._getFragmentShaderCode()&&([v,b]=this._getShaderCodeAndErrorLine((a=this._pipelineContext)===null||a===void 0?void 0:a._getFragmentShaderCode(),this._compilationError,!0),v&&(Ie.Error("Fragment code:"),Ie.Error(v))),y&&Ie.Error(y),b&&Ie.Error(b)}Ie.Error("Error: "+this._compilationError);const g=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)};i&&(this._pipelineContext=i,this._isReady=!0,g()),_?(this._pipelineContext=null,_.hasMoreFallbacks?(this._allFallbacksProcessed=!1,Ie.Error("Trying next fallback."),this.defines=_.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,g(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,i||g())}get isSupported(){return this._compilationError===""}_bindTexture(e,i){this._engine._bindTexture(this._samplers[e],i,e)}setTexture(e,i){this._engine.setTexture(this._samplers[e],this._uniforms[e],i,e)}setDepthStencilTexture(e,i){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],i,e)}setTextureArray(e,i){const s=e+"Ex";if(this._samplerList.indexOf(s+"0")===-1){const n=this._samplerList.indexOf(e);for(let p=1;p<i.length;p++){const _=s+(p-1).toString();this._samplerList.splice(n+p,0,_)}let a=0;for(const p of this._samplerList)this._samplers[p]=a,a+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],i,e)}setTextureFromPostProcess(e,i){this._engine.setTextureFromPostProcess(this._samplers[e],i,e)}setTextureFromPostProcessOutput(e,i){this._engine.setTextureFromPostProcessOutput(this._samplers[e],i,e)}bindUniformBuffer(e,i){const s=this._uniformBuffersNames[i];s===void 0||ir._BaseCache[s]===e&&this._engine._features.useUBOBindingCache||(ir._BaseCache[s]=e,this._engine.bindUniformBufferBase(e,s,i))}bindUniformBlock(e,i){this._engine.bindUniformBlock(this._pipelineContext,e,i)}setInt(e,i){return this._pipelineContext.setInt(e,i),this}setInt2(e,i,s){return this._pipelineContext.setInt2(e,i,s),this}setInt3(e,i,s,n){return this._pipelineContext.setInt3(e,i,s,n),this}setInt4(e,i,s,n,a){return this._pipelineContext.setInt4(e,i,s,n,a),this}setIntArray(e,i){return this._pipelineContext.setIntArray(e,i),this}setIntArray2(e,i){return this._pipelineContext.setIntArray2(e,i),this}setIntArray3(e,i){return this._pipelineContext.setIntArray3(e,i),this}setIntArray4(e,i){return this._pipelineContext.setIntArray4(e,i),this}setUInt(e,i){return this._pipelineContext.setInt(e,i),this}setUInt2(e,i,s){return this._pipelineContext.setInt2(e,i,s),this}setUInt3(e,i,s,n){return this._pipelineContext.setInt3(e,i,s,n),this}setUInt4(e,i,s,n,a){return this._pipelineContext.setInt4(e,i,s,n,a),this}setUIntArray(e,i){return this._pipelineContext.setUIntArray(e,i),this}setUIntArray2(e,i){return this._pipelineContext.setUIntArray2(e,i),this}setUIntArray3(e,i){return this._pipelineContext.setUIntArray3(e,i),this}setUIntArray4(e,i){return this._pipelineContext.setUIntArray4(e,i),this}setFloatArray(e,i){return this._pipelineContext.setArray(e,i),this}setFloatArray2(e,i){return this._pipelineContext.setArray2(e,i),this}setFloatArray3(e,i){return this._pipelineContext.setArray3(e,i),this}setFloatArray4(e,i){return this._pipelineContext.setArray4(e,i),this}setArray(e,i){return this._pipelineContext.setArray(e,i),this}setArray2(e,i){return this._pipelineContext.setArray2(e,i),this}setArray3(e,i){return this._pipelineContext.setArray3(e,i),this}setArray4(e,i){return this._pipelineContext.setArray4(e,i),this}setMatrices(e,i){return this._pipelineContext.setMatrices(e,i),this}setMatrix(e,i){return this._pipelineContext.setMatrix(e,i),this}setMatrix3x3(e,i){return this._pipelineContext.setMatrix3x3(e,i),this}setMatrix2x2(e,i){return this._pipelineContext.setMatrix2x2(e,i),this}setFloat(e,i){return this._pipelineContext.setFloat(e,i),this}setBool(e,i){return this._pipelineContext.setInt(e,i?1:0),this}setVector2(e,i){return this._pipelineContext.setVector2(e,i),this}setFloat2(e,i,s){return this._pipelineContext.setFloat2(e,i,s),this}setVector3(e,i){return this._pipelineContext.setVector3(e,i),this}setFloat3(e,i,s,n){return this._pipelineContext.setFloat3(e,i,s,n),this}setVector4(e,i){return this._pipelineContext.setVector4(e,i),this}setQuaternion(e,i){return this._pipelineContext.setQuaternion(e,i),this}setFloat4(e,i,s,n,a){return this._pipelineContext.setFloat4(e,i,s,n,a),this}setColor3(e,i){return this._pipelineContext.setColor3(e,i),this}setColor4(e,i,s){return this._pipelineContext.setColor4(e,i,s),this}setDirectColor4(e,i){return this._pipelineContext.setDirectColor4(e,i),this}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseEffect(this),this._isDisposed=!0}static RegisterShader(e,i,s,n=ks.GLSL){i&&(Ye.GetShadersStore(n)[`${e}PixelShader`]=i),s&&(Ye.GetShadersStore(n)[`${e}VertexShader`]=s)}static ResetCache(){ir._BaseCache={}}}ir.LogShaderCodeOnCompilationError=!0,ir._UniqueIdSeed=0,ir._BaseCache={},ir.ShadersStore=Ye.ShadersStore,ir.IncludesShadersStore=Ye.IncludesShadersStore;class l9{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){!this.isDirty||(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}}class T0{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=T0.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=T0.KEEP,this.opDepthFail=T0.KEEP,this.opStencilDepthPass=T0.REPLACE}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e}}T0.ALWAYS=519,T0.KEEP=7680,T0.REPLACE=7681;class c9{constructor(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._alphaBlend}set alphaBlend(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,i,s,n){this._blendConstants[0]===e&&this._blendConstants[1]===i&&this._blendConstants[2]===s&&this._blendConstants[3]===n||(this._blendConstants[0]=e,this._blendConstants[1]=i,this._blendConstants[2]=s,this._blendConstants[3]=n,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,i,s,n){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===i&&this._blendFunctionParameters[2]===s&&this._blendFunctionParameters[3]===n||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=i,this._blendFunctionParameters[2]=s,this._blendFunctionParameters[3]=n,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,i){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===i||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=i,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e){!this.isDirty||(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))}}class h9{constructor(){this.shaderLanguage=ks.GLSL}postProcessor(e,i,s,n,a){if(!a.getCaps().drawBuffersExtension){const p=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(p,"")}return e}}class u9{constructor(){this.shaderLanguage=ks.GLSL}attributeProcessor(e){return e.replace("attribute","in")}varyingProcessor(e,i){return e.replace("varying",i?"in":"out")}postProcessor(e,i,s){const n=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,a=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(a,""),e=e.replace(/texture2D\s*\(/g,"texture("),s)e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(n?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(");else if(i.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;return e}}class Bh{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=Bh._Counter++}}Bh._Counter=0;class kh extends Bh{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}class d9{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null}get isAsync(){return this.isParallelCompiled}get isReady(){return this.program?this.isParallelCompiled?this.engine._isRenderingStateCompiled(this):!0:!1}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}_fillEffectInformation(e,i,s,n,a,p,_,g){const y=this.engine;if(y.supportsUniformBuffers)for(const S in i)e.bindUniformBlock(S,i[S]);this.engine.getUniforms(this,s).forEach((S,M)=>{n[s[M]]=S}),this._uniforms=n;let v;for(v=0;v<a.length;v++)e.getUniform(a[v])==null&&(a.splice(v,1),v--);a.forEach((S,M)=>{p[S]=M});for(const S of y.getAttributes(this,_))g.push(S)}dispose(){this._uniforms={}}_cacheMatrix(e,i){const s=this._valueCache[e],n=i.updateFlag;return s!==void 0&&s===n?!1:(this._valueCache[e]=n,!0)}_cacheFloat2(e,i,s){let n=this._valueCache[e];if(!n||n.length!==2)return n=[i,s],this._valueCache[e]=n,!0;let a=!1;return n[0]!==i&&(n[0]=i,a=!0),n[1]!==s&&(n[1]=s,a=!0),a}_cacheFloat3(e,i,s,n){let a=this._valueCache[e];if(!a||a.length!==3)return a=[i,s,n],this._valueCache[e]=a,!0;let p=!1;return a[0]!==i&&(a[0]=i,p=!0),a[1]!==s&&(a[1]=s,p=!0),a[2]!==n&&(a[2]=n,p=!0),p}_cacheFloat4(e,i,s,n,a){let p=this._valueCache[e];if(!p||p.length!==4)return p=[i,s,n,a],this._valueCache[e]=p,!0;let _=!1;return p[0]!==i&&(p[0]=i,_=!0),p[1]!==s&&(p[1]=s,_=!0),p[2]!==n&&(p[2]=n,_=!0),p[3]!==a&&(p[3]=a,_=!0),_}setInt(e,i){const s=this._valueCache[e];s!==void 0&&s===i||this.engine.setInt(this._uniforms[e],i)&&(this._valueCache[e]=i)}setInt2(e,i,s){this._cacheFloat2(e,i,s)&&(this.engine.setInt2(this._uniforms[e],i,s)||(this._valueCache[e]=null))}setInt3(e,i,s,n){this._cacheFloat3(e,i,s,n)&&(this.engine.setInt3(this._uniforms[e],i,s,n)||(this._valueCache[e]=null))}setInt4(e,i,s,n,a){this._cacheFloat4(e,i,s,n,a)&&(this.engine.setInt4(this._uniforms[e],i,s,n,a)||(this._valueCache[e]=null))}setIntArray(e,i){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],i)}setIntArray2(e,i){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],i)}setIntArray3(e,i){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],i)}setIntArray4(e,i){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],i)}setUInt(e,i){const s=this._valueCache[e];s!==void 0&&s===i||this.engine.setUInt(this._uniforms[e],i)&&(this._valueCache[e]=i)}setUInt2(e,i,s){this._cacheFloat2(e,i,s)&&(this.engine.setUInt2(this._uniforms[e],i,s)||(this._valueCache[e]=null))}setUInt3(e,i,s,n){this._cacheFloat3(e,i,s,n)&&(this.engine.setUInt3(this._uniforms[e],i,s,n)||(this._valueCache[e]=null))}setUInt4(e,i,s,n,a){this._cacheFloat4(e,i,s,n,a)&&(this.engine.setUInt4(this._uniforms[e],i,s,n,a)||(this._valueCache[e]=null))}setUIntArray(e,i){this._valueCache[e]=null,this.engine.setUIntArray(this._uniforms[e],i)}setUIntArray2(e,i){this._valueCache[e]=null,this.engine.setUIntArray2(this._uniforms[e],i)}setUIntArray3(e,i){this._valueCache[e]=null,this.engine.setUIntArray3(this._uniforms[e],i)}setUIntArray4(e,i){this._valueCache[e]=null,this.engine.setUIntArray4(this._uniforms[e],i)}setArray(e,i){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],i)}setArray2(e,i){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],i)}setArray3(e,i){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],i)}setArray4(e,i){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],i)}setMatrices(e,i){!i||(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],i))}setMatrix(e,i){this._cacheMatrix(e,i)&&(this.engine.setMatrices(this._uniforms[e],i.toArray())||(this._valueCache[e]=null))}setMatrix3x3(e,i){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],i)}setMatrix2x2(e,i){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],i)}setFloat(e,i){const s=this._valueCache[e];s!==void 0&&s===i||this.engine.setFloat(this._uniforms[e],i)&&(this._valueCache[e]=i)}setVector2(e,i){this._cacheFloat2(e,i.x,i.y)&&(this.engine.setFloat2(this._uniforms[e],i.x,i.y)||(this._valueCache[e]=null))}setFloat2(e,i,s){this._cacheFloat2(e,i,s)&&(this.engine.setFloat2(this._uniforms[e],i,s)||(this._valueCache[e]=null))}setVector3(e,i){this._cacheFloat3(e,i.x,i.y,i.z)&&(this.engine.setFloat3(this._uniforms[e],i.x,i.y,i.z)||(this._valueCache[e]=null))}setFloat3(e,i,s,n){this._cacheFloat3(e,i,s,n)&&(this.engine.setFloat3(this._uniforms[e],i,s,n)||(this._valueCache[e]=null))}setVector4(e,i){this._cacheFloat4(e,i.x,i.y,i.z,i.w)&&(this.engine.setFloat4(this._uniforms[e],i.x,i.y,i.z,i.w)||(this._valueCache[e]=null))}setQuaternion(e,i){this._cacheFloat4(e,i.x,i.y,i.z,i.w)&&(this.engine.setFloat4(this._uniforms[e],i.x,i.y,i.z,i.w)||(this._valueCache[e]=null))}setFloat4(e,i,s,n,a){this._cacheFloat4(e,i,s,n,a)&&(this.engine.setFloat4(this._uniforms[e],i,s,n,a)||(this._valueCache[e]=null))}setColor3(e,i){this._cacheFloat3(e,i.r,i.g,i.b)&&(this.engine.setFloat3(this._uniforms[e],i.r,i.g,i.b)||(this._valueCache[e]=null))}setColor4(e,i,s){this._cacheFloat4(e,i.r,i.g,i.b,s)&&(this.engine.setFloat4(this._uniforms[e],i.r,i.g,i.b,s)||(this._valueCache[e]=null))}setDirectColor4(e,i){this._cacheFloat4(e,i.r,i.g,i.b,i.a)&&(this.engine.setFloat4(this._uniforms[e],i.r,i.g,i.b,i.a)||(this._valueCache[e]=null))}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}class Es{static SetMatrixPrecision(e){if(Es.MatrixTrackPrecisionChange=!1,e&&!Es.MatrixUse64Bits&&Es.MatrixTrackedMatrices)for(let i=0;i<Es.MatrixTrackedMatrices.length;++i){const s=Es.MatrixTrackedMatrices[i],n=s._m;s._m=new Array(16);for(let a=0;a<16;++a)s._m[a]=n[a]}Es.MatrixUse64Bits=e,Es.MatrixCurrentType=Es.MatrixUse64Bits?Array:Float32Array,Es.MatrixTrackedMatrices=null}}Es.MatrixUse64Bits=!1,Es.MatrixTrackPrecisionChange=!0,Es.MatrixCurrentType=Float32Array,Es.MatrixTrackedMatrices=[];class jm{get underlyingResource(){return this._webGLTexture}constructor(e=null,i){if(this._MSAARenderBuffers=null,this._context=i,!e&&(e=i.createTexture(),!e))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(e){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(e)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null}}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}class ul{static IsWrapper(e){return e.getPipelineContext===void 0}static GetEffect(e){return e.getPipelineContext===void 0?e.effect:e}constructor(e,i=!0){this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),i&&(this.materialContext=e.createMaterialContext())}setEffect(e,i,s=!0){var n;this.effect=e,i!==void 0&&(this.defines=i),s&&((n=this.drawContext)===null||n===void 0||n.reset())}dispose(){var e;(e=this.drawContext)===null||e===void 0||e.dispose()}}class f9{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}reset(){var e;this.stencilMaterial=void 0,(e=this.stencilGlobal)===null||e===void 0||e.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){var i;if(!e)return;const s=!this.useStencilGlobalOnly&&!!(!((i=this.stencilMaterial)===null||i===void 0)&&i.enabled);this.enabled=s?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=s?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=s?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=s?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=s?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=s?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=s?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=s?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}}class na{static get Now(){return Xm.IsWindowObjectExist()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}class p9{}class Yt{static get NpmPackage(){return"babylonjs@5.57.1"}static get Version(){return"5.57.1"}get description(){let e=this.name+this.webGLVersion;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}get isDisposed(){return this._isDisposed}static get ShadersRepository(){return ir.ShadersRepository}static set ShadersRepository(e){ir.ShadersRepository=e}_getShaderProcessor(e){return this._shaderProcessor}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,e?this._depthCullingState.depthFunc=518:this._depthCullingState.depthFunc=515)}get frameId(){return this._frameId}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}getCreationOptions(){return this._creationOptions}get _shouldUseHighPrecisionShader(){return!!(this._caps.highPrecisionShaderSupported&&this._highPrecisionShadersAllowed)}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get activeRenderLoops(){return this._activeRenderLoops}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}get currentViewport(){return this._cachedViewport}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){const e=new Uint8Array(4),i=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(i,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get isWebGPU(){return this._isWebGPU}get shaderPlatformName(){return this._shaderPlatformName}get snapshotRendering(){return!1}set snapshotRendering(e){}get snapshotRenderingMode(){return this._snapshotRenderingMode}set snapshotRenderingMode(e){this._snapshotRenderingMode=e}snapshotRenderingReset(){this.snapshotRendering=!1}static _CreateCanvas(e,i){if(typeof document>"u")return new OffscreenCanvas(e,i);const s=document.createElement("canvas");return s.width=e,s.height=i,s}createCanvas(e,i){return Yt._CreateCanvas(e,i)}createCanvasImage(){return document.createElement("img")}constructor(e,i,s,n){var a,p,_,g,y,b,v,S,M,F,L;this._name="WebGL",this._isDisposed=!1,this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=null,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this.disableUniformBuffers=!1,this.onDisposeObservable=new Re,this._frameId=0,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this.onContextLostObservable=new Re,this.onContextRestoredObservable=new Re,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new l9,this._stencilStateComposer=new f9,this._stencilState=new T0,this._alphaState=new c9,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=new Array,this._renderTargetWrapperCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._activeRequests=new Array,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new Re,this._isWebGPU=!1,this._snapshotRenderingMode=0,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},this.startTime=na.Now;let N=null;s=s||{},this._creationOptions=s,this.adaptToDeviceRatio=n??!1,this._stencilStateComposer.stencilGlobal=this._stencilState,Es.SetMatrixPrecision(!!s.useHighPrecisionMatrix),s.antialias=i??s.antialias,s.deterministicLockstep=(a=s.deterministicLockstep)!==null&&a!==void 0?a:!1,s.lockstepMaxSteps=(p=s.lockstepMaxSteps)!==null&&p!==void 0?p:4,s.timeStep=(_=s.timeStep)!==null&&_!==void 0?_:1/60,s.audioEngine=(g=s.audioEngine)!==null&&g!==void 0?g:!0,s.stencil=(y=s.stencil)!==null&&y!==void 0?y:!0,this._audioContext=(v=(b=s.audioEngineOptions)===null||b===void 0?void 0:b.audioContext)!==null&&v!==void 0?v:null,this._audioDestination=(M=(S=s.audioEngineOptions)===null||S===void 0?void 0:S.audioDestination)!==null&&M!==void 0?M:null,this.premultipliedAlpha=(F=s.premultipliedAlpha)!==null&&F!==void 0?F:!0,this.useExactSrgbConversions=(L=s.useExactSrgbConversions)!==null&&L!==void 0?L:!1,this._doNotHandleContextLost=!!s.doNotHandleContextLost,this._isStencilEnable=!!s.stencil,n=n||s.adaptToDeviceRatio||!1;const k=Ts()&&window.devicePixelRatio||1,G=s.limitDeviceRatio||k;if(this._hardwareScalingLevel=n?1/Math.min(G,k):1,this._lastDevicePixelRatio=k,!e)return;if(e.getContext){if(N=e,this._renderingCanvas=N,s.preserveDrawingBuffer===void 0&&(s.preserveDrawingBuffer=!1),s.xrCompatible===void 0&&(s.xrCompatible=!0),navigator&&navigator.userAgent){this._setupMobileChecks();const z=navigator.userAgent;for(const W of Yt.ExceptionList){const Y=W.key,Z=W.targets;if(new RegExp(Y).test(z)){if(W.capture&&W.captureConstraint){const se=W.capture,$=W.captureConstraint,ue=new RegExp(se).exec(z);if(ue&&ue.length>0&&parseInt(ue[ue.length-1])>=$)continue}for(const se of Z)switch(se){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":s.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1;break}}}}if(this._doNotHandleContextLost||(this._onContextLost=z=>{z.preventDefault(),this._contextWasLost=!0,Ie.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(this._initGLContext.bind(this))},N.addEventListener("webglcontextlost",this._onContextLost,!1),N.addEventListener("webglcontextrestored",this._onContextRestored,!1),s.powerPreference=s.powerPreference||"high-performance"),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._badDesktopOS&&(s.xrCompatible=!1),!s.disableWebGL2Support)try{this._gl=N.getContext("webgl2",s)||N.getContext("experimental-webgl2",s),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch{}if(!this._gl){if(!N)throw new Error("The provided canvas is null or undefined.");try{this._gl=N.getContext("webgl",s)||N.getContext("experimental-webgl",s)}catch{throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const z=this._gl.getContextAttributes();z&&(s.stencil=z.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),s.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=s.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let z=0;z<this._caps.maxVertexAttribs;z++)this._currentBufferPointers[z]=new p9;this._shaderProcessor=this.webGLVersion>1?new u9:new h9,this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);const H=`Babylon.js v${Yt.Version}`;console.log(H+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",H)}_setupMobileChecks(){!(navigator&&navigator.userAgent)||(this._checkForMobile=()=>{const e=navigator.userAgent;this.hostInformation.isMobile=e.indexOf("Mobile")!==-1||e.indexOf("Mac")!==-1&&Lh()&&"ontouchend"in document},this._checkForMobile(),Ts()&&window.addEventListener("resize",this._checkForMobile))}_restoreEngineAfterContextLost(e){setTimeout(async()=>{var i;this._dummyFramebuffer=null;const s=this._depthCullingState.depthTest,n=this._depthCullingState.depthFunc,a=this._depthCullingState.depthMask,p=this._stencilState.stencilTest;await e(),this.wipeCaches(!0),this._rebuildEffects(),(i=this._rebuildComputeEffects)===null||i===void 0||i.call(this),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(!0),this._depthCullingState.depthTest=s,this._depthCullingState.depthFunc=n,this._depthCullingState.depthMask=a,this._stencilState.stencilTest=p,Ie.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1},0)}_sharedInit(e){this._renderingCanvas=e}_getShaderProcessingContext(e){return null}_rebuildInternalTextures(){const e=this._internalTexturesCache.slice();for(const i of e)i._rebuild()}_rebuildRenderTargetWrappers(){const e=this._renderTargetWrapperCache.slice();for(const i of e)i._rebuild()}_rebuildEffects(){for(const e in this._compiledEffects){const i=this._compiledEffects[e];i._pipelineContext=null,i._wasPreviouslyReady=!1,i._prepareEffect()}ir.ResetCache()}areAllEffectsReady(){for(const e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_rebuildBuffers(){for(const e of this._uniformBuffers)e._rebuild();for(const e of this._storageBuffers)e._rebuild()}_initGLContext(){var e;this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null,maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:this._webGLVersion!==1,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1},this._glVersion=this._gl.getParameter(this._gl.VERSION);const i=this._gl.getExtension("WEBGL_debug_renderer_info");if(i!=null&&(this._glRenderer=this._gl.getParameter(i.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(i.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=((e=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT))!==null&&e!==void 0?e:0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._maxMSAASamplesOverride!==null?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES);else{const s=this._gl.getExtension("WEBGL_draw_buffers");if(s!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=s.drawBuffersWEBGL.bind(s),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let n=0;n<16;n++)this._gl["COLOR_ATTACHMENT"+n+"_WEBGL"]=s["COLOR_ATTACHMENT"+n+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const s=this._gl.getExtension("WEBGL_depth_texture");s!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=s.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const s=this._gl.getExtension("OES_vertex_array_object");s!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=s.createVertexArrayOES.bind(s),this._gl.bindVertexArray=s.bindVertexArrayOES.bind(s),this._gl.deleteVertexArray=s.deleteVertexArrayOES.bind(s))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const s=this._gl.getExtension("ANGLE_instanced_arrays");s!=null?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=s.drawArraysInstancedANGLE.bind(s),this._gl.drawElementsInstanced=s.drawElementsInstancedANGLE.bind(s),this._gl.vertexAttribDivisor=s.vertexAttribDivisorANGLE.bind(s)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const s=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),n=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);s&&n&&(this._caps.highPrecisionShaderSupported=s.precision!==0&&n.precision!==0)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const s=this._gl.getExtension("EXT_blend_minmax");s!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=s.MAX_EXT,this._gl.MIN=s.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0;else{const s=this._gl.getExtension("EXT_sRGB");s!=null&&(this._caps.supportSRGBBuffers=!0,this._gl.SRGB=s.SRGB_EXT,this._gl.SRGB8=s.SRGB_ALPHA_EXT,this._gl.SRGB8_ALPHA8=s.SRGB_ALPHA_EXT)}this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!!(this._creationOptions&&this._creationOptions.forceSRGBBufferSupportState)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let s=0;s<this._maxSimultaneousTextures;s++)this._nextFreeTextureSlots.push(s);this._glRenderer==="Mali-G72"&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}get isStencilEnable(){return this._isStencilEnable}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}resetTextureCache(){for(const e in this._boundTexturesCache)!Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)||(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}getLoadedTexturesCache(){return this._internalTexturesCache}getCaps(){return this._caps}stopRenderLoop(e){if(!e){this._activeRenderLoops.length=0;return}const i=this._activeRenderLoops.indexOf(e);i>=0&&this._activeRenderLoops.splice(i,1)}_renderLoop(){if(!this._contextWasLost){let e=!0;if((this._isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e){this.beginFrame();for(let i=0;i<this._activeRenderLoops.length;i++){const s=this._activeRenderLoops[i];s()}this.endFrame()}}this._activeRenderLoops.length>0?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}getHostWindow(){return Ts()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}_queueNewFrame(e,i){return Yt.QueueNewFrame(e,i)}runRenderLoop(e){this._activeRenderLoops.indexOf(e)===-1&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=this._renderLoop.bind(this),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}clear(e,i,s,n=!1){const a=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=a;let p=0;i&&e&&(this._gl.clearColor(e.r,e.g,e.b,e.a!==void 0?e.a:1),p|=this._gl.COLOR_BUFFER_BIT),s&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),p|=this._gl.DEPTH_BUFFER_BIT),n&&(this._gl.clearStencil(0),p|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(p)}_viewport(e,i,s,n){(e!==this._viewportCached.x||i!==this._viewportCached.y||s!==this._viewportCached.z||n!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=i,this._viewportCached.z=s,this._viewportCached.w=n,this._gl.viewport(e,i,s,n))}setViewport(e,i,s){const n=i||this.getRenderWidth(),a=s||this.getRenderHeight(),p=e.x||0,_=e.y||0;this._cachedViewport=e,this._viewport(p*n,_*a,n*e.width,a*e.height)}beginFrame(){}endFrame(){this._badOS&&this.flushFramebuffer(),this._frameId++}resize(e=!1){let i,s;if(this.adaptToDeviceRatio){const n=Ts()&&window.devicePixelRatio||1,a=this._lastDevicePixelRatio/n;this._lastDevicePixelRatio=n,this._hardwareScalingLevel*=a}Ts()?(i=this._renderingCanvas?this._renderingCanvas.clientWidth||this._renderingCanvas.width:window.innerWidth,s=this._renderingCanvas?this._renderingCanvas.clientHeight||this._renderingCanvas.height:window.innerHeight):(i=this._renderingCanvas?this._renderingCanvas.width:100,s=this._renderingCanvas?this._renderingCanvas.height:100),this.setSize(i/this._hardwareScalingLevel,s/this._hardwareScalingLevel,e)}setSize(e,i,s=!1){return!this._renderingCanvas||(e=e|0,i=i|0,!s&&this._renderingCanvas.width===e&&this._renderingCanvas.height===i)?!1:(this._renderingCanvas.width=e,this._renderingCanvas.height=i,!0)}bindFramebuffer(e,i=0,s,n,a,p=0,_=0){var g,y,b,v,S;const M=e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(M._MSAAFramebuffer?M._MSAAFramebuffer:M._framebuffer);const F=this._gl;e.isMulti||(e.is2DArray?F.framebufferTextureLayer(F.FRAMEBUFFER,F.COLOR_ATTACHMENT0,(g=e.texture._hardwareTexture)===null||g===void 0?void 0:g.underlyingResource,p,_):e.isCube&&F.framebufferTexture2D(F.FRAMEBUFFER,F.COLOR_ATTACHMENT0,F.TEXTURE_CUBE_MAP_POSITIVE_X+i,(y=e.texture._hardwareTexture)===null||y===void 0?void 0:y.underlyingResource,p));const L=e._depthStencilTexture;if(L){const N=e._depthStencilTextureWithStencil?F.DEPTH_STENCIL_ATTACHMENT:F.DEPTH_ATTACHMENT;e.is2DArray?F.framebufferTextureLayer(F.FRAMEBUFFER,N,(b=L._hardwareTexture)===null||b===void 0?void 0:b.underlyingResource,p,_):e.isCube?F.framebufferTexture2D(F.FRAMEBUFFER,N,F.TEXTURE_CUBE_MAP_POSITIVE_X+i,(v=L._hardwareTexture)===null||v===void 0?void 0:v.underlyingResource,p):F.framebufferTexture2D(F.FRAMEBUFFER,N,F.TEXTURE_2D,(S=L._hardwareTexture)===null||S===void 0?void 0:S.underlyingResource,p)}this._cachedViewport&&!a?this.setViewport(this._cachedViewport,s,n):(s||(s=e.width,p&&(s=s/Math.pow(2,p))),n||(n=e.height,p&&(n=n/Math.pow(2,p))),this._viewport(0,0,s,n)),this.wipeCaches()}setState(e,i=0,s,n=!1,a,p,_=0){var g,y;(this._depthCullingState.cull!==e||s)&&(this._depthCullingState.cull=e);const b=!((y=(g=this.cullBackFaces)!==null&&g!==void 0?g:a)!==null&&y!==void 0)||y?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==b||s)&&(this._depthCullingState.cullFace=b),this.setZOffset(i),this.setZOffsetUnits(_);const v=n?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==v||s)&&(this._depthCullingState.frontFace=v),this._stencilStateComposer.stencilMaterial=p}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}getZOffset(){const e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}getZOffsetUnits(){const e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentFramebuffer===null}generateMipmaps(e){this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)}unBindFramebuffer(e,i=!1,s){var n;const a=e;this._currentRenderTarget=null;const p=this._gl;if(a._MSAAFramebuffer){if(e.isMulti){this.unBindMultiColorAttachmentFramebuffer(e,i,s);return}p.bindFramebuffer(p.READ_FRAMEBUFFER,a._MSAAFramebuffer),p.bindFramebuffer(p.DRAW_FRAMEBUFFER,a._framebuffer),p.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,p.COLOR_BUFFER_BIT,p.NEAREST)}((n=e.texture)===null||n===void 0?void 0:n.generateMipMaps)&&!i&&!e.isCube&&this.generateMipmaps(e.texture),s&&(a._MSAAFramebuffer&&this._bindUnboundFramebuffer(a._framebuffer),s()),this._bindUnboundFramebuffer(null)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,i){const s=this._gl.createBuffer();if(!s)throw new Error("Unable to create vertex buffer");const n=new kh(s);return this.bindArrayBuffer(n),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),i):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,i),this._resetVertexBufferBinding(),n.references=1,n}createDynamicVertexBuffer(e){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,i){const s=this._gl.createBuffer(),n=new kh(s);if(!s)throw new Error("Unable to create index buffer");this.bindIndexBuffer(n);const a=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,a,i?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),n.references=1,n.is32Bits=a.BYTES_PER_ELEMENT===4,n}_normalizeIndexData(e){if(e.BYTES_PER_ELEMENT===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let s=0;s<e.length;s++)if(e[s]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,i,s){const n=e.program,a=this._gl.getUniformBlockIndex(n,i);this._gl.uniformBlockBinding(n,a,s)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,i){(this._vaoRecordInProgress||this._currentBoundBuffer[i]!==e)&&(this._gl.bindBuffer(i,e?e.underlyingResource:null),this._currentBoundBuffer[i]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,i,s,n,a,p,_){const g=this._currentBufferPointers[i];if(!g)return;let y=!1;g.active?(g.buffer!==e&&(g.buffer=e,y=!0),g.size!==s&&(g.size=s,y=!0),g.type!==n&&(g.type=n,y=!0),g.normalized!==a&&(g.normalized=a,y=!0),g.stride!==p&&(g.stride=p,y=!0),g.offset!==_&&(g.offset=_,y=!0)):(y=!0,g.active=!0,g.index=i,g.size=s,g.type=n,g.normalized=a,g.stride=p,g.offset=_,g.buffer=e),(y||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),n===this._gl.UNSIGNED_INT||n===this._gl.INT?this._gl.vertexAttribIPointer(i,s,n,p,_):this._gl.vertexAttribPointer(i,s,n,a,p,_))}_bindIndexBufferWithCache(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,i,s){const n=i.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let a=0;a<n.length;a++){const p=i.getAttributeLocation(a);if(p>=0){const _=n[a];let g=null;if(s&&(g=s[_]),g||(g=e[_]),!g)continue;this._gl.enableVertexAttribArray(p),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[p]=!0);const y=g.getBuffer();y&&(this._vertexAttribPointer(y,p,g.getSize(),g.type,g.normalized,g.byteStride,g.byteOffset),g.getIsInstanced()&&(this._gl.vertexAttribDivisor(p,g.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(p),this._currentInstanceBuffers.push(y))))}}}recordVertexArrayObject(e,i,s,n){const a=this._gl.createVertexArray();if(!a)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(a),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,s,n),this.bindIndexBuffer(i),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),a}bindVertexArrayObject(e,i){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=i!=null&&i.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,i,s,n,a){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==a){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=a;const p=a.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let _=0;for(let g=0;g<p;g++)if(g<s.length){const y=a.getAttributeLocation(g);y>=0&&(this._gl.enableVertexAttribArray(y),this._vertexAttribArraysEnabled[y]=!0,this._vertexAttribPointer(e,y,s[g],this._gl.FLOAT,!1,n,_)),_+=s[g]*4}}this._bindIndexBufferWithCache(i)}_unbindVertexArrayObject(){!this._cachedVertexArrayObject||(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,i,s,n){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==s)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=s,this._bindVertexBuffersAttributes(e,s,n)),this._bindIndexBufferWithCache(i)}unbindInstanceAttributes(){let e;for(let i=0,s=this._currentInstanceLocations.length;i<s;i++){const n=this._currentInstanceBuffers[i];e!=n&&n.references&&(e=n,this.bindArrayBuffer(n));const a=this._currentInstanceLocations[i];this._gl.vertexAttribDivisor(a,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,i,s){if(this.bindArrayBuffer(e),i&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,i),s[0].index!==void 0)this.bindInstancesBuffer(e,s,!0);else for(let n=0;n<4;n++){const a=s[n];this._vertexAttribArraysEnabled[a]||(this._gl.enableVertexAttribArray(a),this._vertexAttribArraysEnabled[a]=!0),this._vertexAttribPointer(e,a,4,this._gl.FLOAT,!1,64,n*16),this._gl.vertexAttribDivisor(a,1),this._currentInstanceLocations.push(a),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,i,s=!0){this.bindArrayBuffer(e);let n=0;if(s)for(let a=0;a<i.length;a++)n+=i[a].attributeSize*4;for(let a=0;a<i.length;a++){const p=i[a];p.index===void 0&&(p.index=this._currentEffect.getAttributeLocationByName(p.attributeName)),!(p.index<0)&&(this._vertexAttribArraysEnabled[p.index]||(this._gl.enableVertexAttribArray(p.index),this._vertexAttribArraysEnabled[p.index]=!0),this._vertexAttribPointer(e,p.index,p.attributeSize,p.attributeType||this._gl.FLOAT,p.normalized||!1,n,p.offset),this._gl.vertexAttribDivisor(p.index,p.divisor===void 0?1:p.divisor),this._currentInstanceLocations.push(p.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;const i=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(i)}disableInstanceAttribute(e){let i=!1,s;for(;(s=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(s,1),this._currentInstanceBuffers.splice(s,1),i=!0,s=this._currentInstanceLocations.indexOf(e);i&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,i,s,n){this.drawElementsType(e?0:1,i,s,n)}drawPointClouds(e,i,s){this.drawArraysType(2,e,i,s)}drawUnIndexed(e,i,s,n){this.drawArraysType(e?0:1,i,s,n)}drawElementsType(e,i,s,n){this.applyStates(),this._reportDrawCall();const a=this._drawMode(e),p=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,_=this._uintIndicesCurrentlySet?4:2;n?this._gl.drawElementsInstanced(a,s,p,i*_,n):this._gl.drawElements(a,s,p,i*_)}drawArraysType(e,i,s,n){this.applyStates(),this._reportDrawCall();const a=this._drawMode(e);n?this._gl.drawArraysInstanced(a,i,s,n):this._gl.drawArrays(a,i,s)}_drawMode(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}}_reportDrawCall(){}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];const i=e.getPipelineContext();i&&this._deletePipelineContext(i)}_deletePipelineContext(e){const i=e;i&&i.program&&(i.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(i.program))}_getGlobalDefines(e){if(e){this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS;return}else{let i="";return this.isNDCHalfZRange&&(i+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(i&&(i+=`
`),i+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(i&&(i+=`
`),i+="#define USE_EXACT_SRGB_CONVERSIONS"),i}}createEffect(e,i,s,n,a,p,_,g,y,b=ks.GLSL){var v;const S=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,M=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,F=this._getGlobalDefines();let L=(v=a??i.defines)!==null&&v!==void 0?v:"";F&&(L+=F);const N=S+"+"+M+"@"+L;if(this._compiledEffects[N]){const G=this._compiledEffects[N];return _&&G.isReady()&&_(G),G}const k=new ir(e,i,s,n,this,a,p,_,g,y,N,b);return this._compiledEffects[N]=k,k}static _ConcatenateShader(e,i,s=""){return s+(i?i+`
`:"")+e}_compileShader(e,i,s,n){return this._compileRawShader(Yt._ConcatenateShader(e,s,n),i)}_compileRawShader(e,i){const s=this._gl,n=s.createShader(i==="vertex"?s.VERTEX_SHADER:s.FRAGMENT_SHADER);if(!n){let a=s.NO_ERROR,p=s.NO_ERROR;for(;(p=s.getError())!==s.NO_ERROR;)a=p;throw new Error(`Something went wrong while creating a gl ${i} shader object. gl error=${a}, gl isContextLost=${s.isContextLost()}, _contextWasLost=${this._contextWasLost}`)}return s.shaderSource(n,e),s.compileShader(n),n}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,i,s,n,a=null){n=n||this._gl;const p=this._compileRawShader(i,"vertex"),_=this._compileRawShader(s,"fragment");return this._createShaderProgram(e,p,_,n,a)}createShaderProgram(e,i,s,n,a,p=null){a=a||this._gl;const _=this._webGLVersion>1?`#version 300 es
#define WEBGL2 
`:"",g=this._compileShader(i,"vertex",n,_),y=this._compileShader(s,"fragment",n,_);return this._createShaderProgram(e,g,y,a,p)}inlineShaderCode(e){return e}createPipelineContext(e){const i=new d9;return i.engine=this,this._caps.parallelShaderCompile&&(i.isParallelCompiled=!0),i}createMaterialContext(){}createDrawContext(){}_createShaderProgram(e,i,s,n,a=null){const p=n.createProgram();if(e.program=p,!p)throw new Error("Unable to create program");return n.attachShader(p,i),n.attachShader(p,s),n.linkProgram(p),e.context=n,e.vertexShader=i,e.fragmentShader=s,e.isParallelCompiled||this._finalizePipelineContext(e),p}_finalizePipelineContext(e){const i=e.context,s=e.vertexShader,n=e.fragmentShader,a=e.program;if(!i.getProgramParameter(a,i.LINK_STATUS)){if(!this._gl.getShaderParameter(s,this._gl.COMPILE_STATUS)){const g=this._gl.getShaderInfoLog(s);if(g)throw e.vertexCompilationError=g,new Error("VERTEX SHADER "+g)}if(!this._gl.getShaderParameter(n,this._gl.COMPILE_STATUS)){const g=this._gl.getShaderInfoLog(n);if(g)throw e.fragmentCompilationError=g,new Error("FRAGMENT SHADER "+g)}const _=i.getProgramInfoLog(a);if(_)throw e.programLinkError=_,new Error(_)}if(this.validateShaderPrograms&&(i.validateProgram(a),!i.getProgramParameter(a,i.VALIDATE_STATUS))){const g=i.getProgramInfoLog(a);if(g)throw e.programValidationError=g,new Error(g)}i.deleteShader(s),i.deleteShader(n),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0)}_preparePipelineContext(e,i,s,n,a,p,_,g,y,b){const v=e;n?v.program=this.createRawShaderProgram(v,i,s,void 0,y):v.program=this.createShaderProgram(v,i,s,g,void 0,y),v.program.__SPECTOR_rebuildProgram=_}_isRenderingStateCompiled(e){const i=e;return this._gl.getProgramParameter(i.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)?(this._finalizePipelineContext(i),!0):!1}_executeWhenRenderingStateIsCompiled(e,i){const s=e;if(!s.isParallelCompiled){i();return}const n=s.onCompiled;n?s.onCompiled=()=>{n(),i()}:s.onCompiled=i}getUniforms(e,i){const s=new Array,n=e;for(let a=0;a<i.length;a++)s.push(this._gl.getUniformLocation(n.program,i[a]));return s}getAttributes(e,i){const s=[],n=e;for(let a=0;a<i.length;a++)try{s.push(this._gl.getAttribLocation(n.program,i[a]))}catch{s.push(-1)}return s}enableEffect(e){e=e!==null&&ul.IsWrapper(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,e=e,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,i){return e?(this._gl.uniform1i(e,i),!0):!1}setInt2(e,i,s){return e?(this._gl.uniform2i(e,i,s),!0):!1}setInt3(e,i,s,n){return e?(this._gl.uniform3i(e,i,s,n),!0):!1}setInt4(e,i,s,n,a){return e?(this._gl.uniform4i(e,i,s,n,a),!0):!1}setIntArray(e,i){return e?(this._gl.uniform1iv(e,i),!0):!1}setIntArray2(e,i){return!e||i.length%2!==0?!1:(this._gl.uniform2iv(e,i),!0)}setIntArray3(e,i){return!e||i.length%3!==0?!1:(this._gl.uniform3iv(e,i),!0)}setIntArray4(e,i){return!e||i.length%4!==0?!1:(this._gl.uniform4iv(e,i),!0)}setUInt(e,i){return e?(this._gl.uniform1ui(e,i),!0):!1}setUInt2(e,i,s){return e?(this._gl.uniform2ui(e,i,s),!0):!1}setUInt3(e,i,s,n){return e?(this._gl.uniform3ui(e,i,s,n),!0):!1}setUInt4(e,i,s,n,a){return e?(this._gl.uniform4ui(e,i,s,n,a),!0):!1}setUIntArray(e,i){return e?(this._gl.uniform1uiv(e,i),!0):!1}setUIntArray2(e,i){return!e||i.length%2!==0?!1:(this._gl.uniform2uiv(e,i),!0)}setUIntArray3(e,i){return!e||i.length%3!==0?!1:(this._gl.uniform3uiv(e,i),!0)}setUIntArray4(e,i){return!e||i.length%4!==0?!1:(this._gl.uniform4uiv(e,i),!0)}setArray(e,i){return!e||i.length<1?!1:(this._gl.uniform1fv(e,i),!0)}setArray2(e,i){return!e||i.length%2!==0?!1:(this._gl.uniform2fv(e,i),!0)}setArray3(e,i){return!e||i.length%3!==0?!1:(this._gl.uniform3fv(e,i),!0)}setArray4(e,i){return!e||i.length%4!==0?!1:(this._gl.uniform4fv(e,i),!0)}setMatrices(e,i){return e?(this._gl.uniformMatrix4fv(e,!1,i),!0):!1}setMatrix3x3(e,i){return e?(this._gl.uniformMatrix3fv(e,!1,i),!0):!1}setMatrix2x2(e,i){return e?(this._gl.uniformMatrix2fv(e,!1,i),!0):!1}setFloat(e,i){return e?(this._gl.uniform1f(e,i),!0):!1}setFloat2(e,i,s){return e?(this._gl.uniform2f(e,i,s),!0):!1}setFloat3(e,i,s,n){return e?(this._gl.uniform3f(e,i,s,n),!0):!1}setFloat4(e,i,s,n,a){return e?(this._gl.uniform4f(e,i,s,n,a),!0):!1}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}clearInternalTexturesCache(){this._internalTexturesCache.length=0}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,i){const s=this._gl;let n=s.NEAREST,a=s.NEAREST;switch(e){case 11:n=s.LINEAR,i?a=s.LINEAR_MIPMAP_NEAREST:a=s.LINEAR;break;case 3:n=s.LINEAR,i?a=s.LINEAR_MIPMAP_LINEAR:a=s.LINEAR;break;case 8:n=s.NEAREST,i?a=s.NEAREST_MIPMAP_LINEAR:a=s.NEAREST;break;case 4:n=s.NEAREST,i?a=s.NEAREST_MIPMAP_NEAREST:a=s.NEAREST;break;case 5:n=s.NEAREST,i?a=s.LINEAR_MIPMAP_NEAREST:a=s.LINEAR;break;case 6:n=s.NEAREST,i?a=s.LINEAR_MIPMAP_LINEAR:a=s.LINEAR;break;case 7:n=s.NEAREST,a=s.LINEAR;break;case 1:n=s.NEAREST,a=s.NEAREST;break;case 9:n=s.LINEAR,i?a=s.NEAREST_MIPMAP_NEAREST:a=s.NEAREST;break;case 10:n=s.LINEAR,i?a=s.NEAREST_MIPMAP_LINEAR:a=s.NEAREST;break;case 2:n=s.LINEAR,a=s.LINEAR;break;case 12:n=s.LINEAR,a=s.NEAREST;break}return{min:a,mag:n}}_createTexture(){const e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new jm(this._createTexture(),this._gl)}_createInternalTexture(e,i,s=!0,n=or.Unknown){var a;let p=!1,_=0,g=3,y=5,b=!1,v=1,S;i!==void 0&&typeof i=="object"?(p=!!i.generateMipMaps,_=i.type===void 0?0:i.type,g=i.samplingMode===void 0?3:i.samplingMode,y=i.format===void 0?5:i.format,b=i.useSRGBBuffer===void 0?!1:i.useSRGBBuffer,v=(a=i.samples)!==null&&a!==void 0?a:1,S=i.label):p=!!i,b&&(b=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(_===1&&!this._caps.textureFloatLinearFiltering||_===2&&!this._caps.textureHalfFloatLinearFiltering)&&(g=1),_===1&&!this._caps.textureFloat&&(_=0,Ie.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const M=this._gl,F=new Bs(this,n),L=e.width||e,N=e.height||e,k=e.layers||0,G=this._getSamplingParameters(g,p),H=k!==0?M.TEXTURE_2D_ARRAY:M.TEXTURE_2D,z=this._getRGBABufferInternalSizedFormat(_,y,b),W=this._getInternalFormat(y),Y=this._getWebGLTextureType(_);return this._bindTextureDirectly(H,F),k!==0?(F.is2DArray=!0,M.texImage3D(H,0,z,L,N,k,0,W,Y,null)):M.texImage2D(H,0,z,L,N,0,W,Y,null),M.texParameteri(H,M.TEXTURE_MAG_FILTER,G.mag),M.texParameteri(H,M.TEXTURE_MIN_FILTER,G.min),M.texParameteri(H,M.TEXTURE_WRAP_S,M.CLAMP_TO_EDGE),M.texParameteri(H,M.TEXTURE_WRAP_T,M.CLAMP_TO_EDGE),p&&this._gl.generateMipmap(H),this._bindTextureDirectly(H,null),F._useSRGBBuffer=b,F.baseWidth=L,F.baseHeight=N,F.width=L,F.height=N,F.depth=k,F.isReady=!0,F.samples=v,F.generateMipMaps=p,F.samplingMode=g,F.type=_,F.format=y,F.label=S,this._internalTexturesCache.push(F),F}_getUseSRGBBuffer(e,i){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||i)}_createTextureBase(e,i,s,n,a=3,p=null,_=null,g,y,b=null,v=null,S=null,M=null,F,L,N){e=e||"";const k=e.substr(0,5)==="data:",G=e.substr(0,5)==="blob:",H=k&&e.indexOf(";base64,")!==-1,z=v||new Bs(this,or.Url);z!==v&&(z.label=e.substring(0,60));const W=e;this._transformTextureUrl&&!H&&!v&&!b&&(e=this._transformTextureUrl(e)),W!==e&&(z._originalUrl=W);const Y=e.lastIndexOf(".");let Z=M||(Y>-1?e.substring(Y).toLowerCase():""),Q=null;Z.indexOf("?")>-1&&(Z=Z.split("?")[0]);for(const ue of Yt._TextureLoaders)if(ue.canLoad(Z,F)){Q=ue;break}n&&n.addPendingData(z),z.url=e,z.generateMipMaps=!i,z.samplingMode=a,z.invertY=s,z._useSRGBBuffer=this._getUseSRGBBuffer(!!N,i),this._doNotHandleContextLost||(z._buffer=b);let $=null;p&&!v&&($=z.onLoadedObservable.add(p)),v||this._internalTexturesCache.push(z);const oe=(ue,de)=>{n&&n.removePendingData(z),e===W?($&&z.onLoadedObservable.remove($),Zt.UseFallbackTexture&&this._createTextureBase(Zt.FallbackTexture,i,z.invertY,n,a,null,_,g,y,b,z),ue=(ue||"Unknown error")+(Zt.UseFallbackTexture?" - Fallback texture was used":""),z.onErrorObservable.notifyObservers({message:ue,exception:de}),_&&_(ue,de)):(Ie.Warn(`Failed to load ${e}, falling back to ${W}`),this._createTextureBase(W,i,z.invertY,n,a,p,_,g,y,b,z,S,M,F,L,N))};if(Q){const ue=de=>{Q.loadData(de,z,(ye,_e,we,Pe,Ee,We)=>{We?oe("TextureLoader failed to load data"):g(z,Z,n,{width:ye,height:_e},z.invertY,!we,Pe,()=>(Ee(),!1),a)},L)};b?b instanceof ArrayBuffer?ue(new Uint8Array(b)):ArrayBuffer.isView(b)?ue(b):_&&_("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,de=>ue(new Uint8Array(de)),void 0,n?n.offlineProvider:void 0,!0,(de,ye)=>{oe("Unable to load "+(de&&de.responseURL,ye))})}else{const ue=de=>{G&&!this._doNotHandleContextLost&&(z._buffer=de),g(z,Z,n,de,z.invertY,i,!1,y,a)};!k||H?b&&(typeof b.decoding=="string"||b.close)?ue(b):Yt._FileToolsLoadImage(e,ue,oe,n?n.offlineProvider:null,F,z.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):typeof b=="string"||b instanceof ArrayBuffer||ArrayBuffer.isView(b)||b instanceof Blob?Yt._FileToolsLoadImage(b,ue,oe,n?n.offlineProvider:null,F,z.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):b&&ue(b)}return z}createTexture(e,i,s,n,a=3,p=null,_=null,g=null,y=null,b=null,v=null,S,M,F,L){return this._createTextureBase(e,i,s,n,a,p,_,this._prepareWebGLTexture.bind(this),(N,k,G,H,z,W)=>{const Y=this._gl,Z=G.width===N&&G.height===k,Q=b?this._getInternalFormat(b,z._useSRGBBuffer):H===".jpg"&&!z._useSRGBBuffer?Y.RGB:z._useSRGBBuffer?Y.SRGB8_ALPHA8:Y.RGBA;let se=b?this._getInternalFormat(b):H===".jpg"&&!z._useSRGBBuffer?Y.RGB:Y.RGBA;if(z._useSRGBBuffer&&this.webGLVersion===1&&(se=Q),Z)return Y.texImage2D(Y.TEXTURE_2D,0,Q,se,Y.UNSIGNED_BYTE,G),!1;const $=this._caps.maxTextureSize;if(G.width>$||G.height>$||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=N,this._workingCanvas.height=k,this._workingContext.drawImage(G,0,0,G.width,G.height,0,0,N,k),Y.texImage2D(Y.TEXTURE_2D,0,Q,se,Y.UNSIGNED_BYTE,this._workingCanvas),z.width=N,z.height=k),!1;{const oe=new Bs(this,or.Temp);this._bindTextureDirectly(Y.TEXTURE_2D,oe,!0),Y.texImage2D(Y.TEXTURE_2D,0,Q,se,Y.UNSIGNED_BYTE,G),this._rescaleTexture(oe,z,n,Q,()=>{this._releaseTexture(oe),this._bindTextureDirectly(Y.TEXTURE_2D,z,!0),W()})}return!0},g,y,b,v,S,M,L)}static _FileToolsLoadImage(e,i,s,n,a,p){throw xi("FileTools")}_rescaleTexture(e,i,s,n,a){}createRawTexture(e,i,s,n,a,p,_,g=null,y=0,b=0,v=!1){throw xi("Engine.RawTexture")}createRawCubeTexture(e,i,s,n,a,p,_,g=null){throw xi("Engine.RawTexture")}createRawTexture3D(e,i,s,n,a,p,_,g,y=null,b=0){throw xi("Engine.RawTexture")}createRawTexture2DArray(e,i,s,n,a,p,_,g,y=null,b=0){throw xi("Engine.RawTexture")}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,i,s=!1){const n=this._getTextureTarget(i),a=this._getSamplingParameters(e,i.useMipMaps||s);this._setTextureParameterInteger(n,this._gl.TEXTURE_MAG_FILTER,a.mag,i),this._setTextureParameterInteger(n,this._gl.TEXTURE_MIN_FILTER,a.min),s&&(i.generateMipMaps=!0,this._gl.generateMipmap(n)),this._bindTextureDirectly(n,null),i.samplingMode=e}updateTextureDimensions(e,i,s,n=1){}updateTextureWrappingMode(e,i,s=null,n=null){const a=this._getTextureTarget(e);i!==null&&(this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(i),e),e._cachedWrapU=i),s!==null&&(this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(s),e),e._cachedWrapV=s),(e.is2DArray||e.is3D)&&n!==null&&(this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(n),e),e._cachedWrapR=n),this._bindTextureDirectly(a,null)}_setupDepthStencilTexture(e,i,s,n,a,p=1){const _=i.width||i,g=i.height||i,y=i.layers||0;e.baseWidth=_,e.baseHeight=g,e.width=_,e.height=g,e.is2DArray=y>0,e.depth=y,e.isReady=!0,e.samples=p,e.generateMipMaps=!1,e.samplingMode=n?2:1,e.type=0,e._comparisonFunction=a;const b=this._gl,v=this._getTextureTarget(e),S=this._getSamplingParameters(e.samplingMode,!1);b.texParameteri(v,b.TEXTURE_MAG_FILTER,S.mag),b.texParameteri(v,b.TEXTURE_MIN_FILTER,S.min),b.texParameteri(v,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(v,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),this.webGLVersion>1&&(a===0?(b.texParameteri(v,b.TEXTURE_COMPARE_FUNC,515),b.texParameteri(v,b.TEXTURE_COMPARE_MODE,b.NONE)):(b.texParameteri(v,b.TEXTURE_COMPARE_FUNC,a),b.texParameteri(v,b.TEXTURE_COMPARE_MODE,b.COMPARE_REF_TO_TEXTURE)))}_uploadCompressedDataToTextureDirectly(e,i,s,n,a,p=0,_=0){const g=this._gl;let y=g.TEXTURE_2D;if(e.isCube&&(y=g.TEXTURE_CUBE_MAP_POSITIVE_X+p),e._useSRGBBuffer)switch(i){case 37492:case 36196:this._caps.etc2?i=g.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?i=g.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:i=g.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:i=g.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?i=g.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?i=g.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?i=g.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}this._gl.compressedTexImage2D(y,_,i,s,n,0,a)}_uploadDataToTextureDirectly(e,i,s=0,n=0,a,p=!1){const _=this._gl,g=this._getWebGLTextureType(e.type),y=this._getInternalFormat(e.format),b=a===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(a,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let v=_.TEXTURE_2D;e.isCube&&(v=_.TEXTURE_CUBE_MAP_POSITIVE_X+s);const S=Math.round(Math.log(e.width)*Math.LOG2E),M=Math.round(Math.log(e.height)*Math.LOG2E),F=p?e.width:Math.pow(2,Math.max(S-n,0)),L=p?e.height:Math.pow(2,Math.max(M-n,0));_.texImage2D(v,n,b,F,L,0,y,g,i)}updateTextureData(e,i,s,n,a,p,_=0,g=0,y=!1){const b=this._gl,v=this._getWebGLTextureType(e.type),S=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let M=b.TEXTURE_2D,F=b.TEXTURE_2D;e.isCube&&(F=b.TEXTURE_CUBE_MAP_POSITIVE_X+_,M=b.TEXTURE_CUBE_MAP),this._bindTextureDirectly(M,e,!0),b.texSubImage2D(F,g,s,n,a,p,S,v,i),y&&this._gl.generateMipmap(F),this._bindTextureDirectly(M,null)}_uploadArrayBufferViewToTexture(e,i,s=0,n=0){const a=this._gl,p=e.isCube?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;this._bindTextureDirectly(p,e,!0),this._uploadDataToTextureDirectly(e,i,s,n),this._bindTextureDirectly(p,null,!0)}_prepareWebGLTextureContinuation(e,i,s,n,a){const p=this._gl;if(!p)return;const _=this._getSamplingParameters(a,!s);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,_.mag),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,_.min),!s&&!n&&p.generateMipmap(p.TEXTURE_2D),this._bindTextureDirectly(p.TEXTURE_2D,null),i&&i.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,i,s,n,a,p,_,g,y=3){const b=this.getCaps().maxTextureSize,v=Math.min(b,this.needPOTTextures?Yt.GetExponentOfTwo(n.width,b):n.width),S=Math.min(b,this.needPOTTextures?Yt.GetExponentOfTwo(n.height,b):n.height),M=this._gl;if(!!M){if(!e._hardwareTexture){s&&s.removePendingData(e);return}this._bindTextureDirectly(M.TEXTURE_2D,e,!0),this._unpackFlipY(a===void 0?!0:!!a),e.baseWidth=n.width,e.baseHeight=n.height,e.width=v,e.height=S,e.isReady=!0,!g(v,S,n,i,e,()=>{this._prepareWebGLTextureContinuation(e,s,p,_,y)})&&this._prepareWebGLTextureContinuation(e,s,p,_,y)}}_setupFramebufferDepthAttachments(e,i,s,n,a=1){const p=this._gl;if(e&&i)return this._createRenderBuffer(s,n,a,p.DEPTH_STENCIL,p.DEPTH24_STENCIL8,p.DEPTH_STENCIL_ATTACHMENT);if(i){let _=p.DEPTH_COMPONENT16;return this._webGLVersion>1&&(_=p.DEPTH_COMPONENT32F),this._createRenderBuffer(s,n,a,_,_,p.DEPTH_ATTACHMENT)}return e?this._createRenderBuffer(s,n,a,p.STENCIL_INDEX8,p.STENCIL_INDEX8,p.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,i,s,n,a,p,_=!0){const y=this._gl.createRenderbuffer();return this._updateRenderBuffer(y,e,i,s,n,a,p,_)}_updateRenderBuffer(e,i,s,n,a,p,_,g=!0){const y=this._gl;return y.bindRenderbuffer(y.RENDERBUFFER,e),n>1&&y.renderbufferStorageMultisample?y.renderbufferStorageMultisample(y.RENDERBUFFER,n,p,i,s):y.renderbufferStorage(y.RENDERBUFFER,a,i,s),y.framebufferRenderbuffer(y.FRAMEBUFFER,_,y.RENDERBUFFER,e),g&&y.bindRenderbuffer(y.RENDERBUFFER,null),e}_releaseTexture(e){var i;this._deleteTexture((i=e._hardwareTexture)===null||i===void 0?void 0:i.underlyingResource),this.unbindAllTextures();const s=this._internalTexturesCache.indexOf(e);s!==-1&&this._internalTexturesCache.splice(s,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_releaseRenderTargetWrapper(e){const i=this._renderTargetWrapperCache.indexOf(e);i!==-1&&this._renderTargetWrapperCache.splice(i,1)}_deleteTexture(e){e&&this._gl.deleteTexture(e)}_setProgram(e){this._currentProgram!==e&&(this._gl.useProgram(e),this._currentProgram=e)}bindSamplers(e){const i=e.getPipelineContext();this._setProgram(i.program);const s=e.getSamplers();for(let n=0;n<s.length;n++){const a=e.getUniform(s[n]);a&&(this._boundUniforms[n]=a)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,i,s=!1,n=!1){var a,p;let _=!1;const g=i&&i._associatedChannel>-1;if(s&&g&&(this._activeChannel=i._associatedChannel),this._boundTexturesCache[this._activeChannel]!==i||n){if(this._activateCurrentTexture(),i&&i.isMultiview)throw console.error(e,i),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,(p=(a=i?._hardwareTexture)===null||a===void 0?void 0:a.underlyingResource)!==null&&p!==void 0?p:null),this._boundTexturesCache[this._activeChannel]=i,i&&(i._associatedChannel=this._activeChannel)}else s&&(_=!0,this._activateCurrentTexture());return g&&!s&&this._bindSamplerUniformToChannel(i._associatedChannel,this._activeChannel),_}_bindTexture(e,i,s){if(e===void 0)return;i&&(i._associatedChannel=e),this._activeChannel=e;const n=i?this._getTextureTarget(i):this._gl.TEXTURE_2D;this._bindTextureDirectly(n,i)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,i,s,n){e!==void 0&&(i&&(this._boundUniforms[e]=i),this._setTexture(e,s))}_bindSamplerUniformToChannel(e,i){const s=this._boundUniforms[e];!s||s._currentState===i||(this._gl.uniform1i(s,i),s._currentState=i)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,i,s=!1,n=!1,a=""){if(!i)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(i.video)this._activeChannel=e,i.update();else if(i.delayLoadState===4)return i.delayLoad(),!1;let p;n?p=i.depthStencilTexture:i.isReady()?p=i.getInternalTexture():i.isCube?p=this.emptyCubeTexture:i.is3D?p=this.emptyTexture3D:i.is2DArray?p=this.emptyTexture2DArray:p=this.emptyTexture,!s&&p&&(p._associatedChannel=e);let _=!0;this._boundTexturesCache[e]===p&&(s||this._bindSamplerUniformToChannel(p._associatedChannel,e),_=!1),this._activeChannel=e;const g=this._getTextureTarget(p);if(_&&this._bindTextureDirectly(g,p,s),p&&!p.isMultiview){if(p.isCube&&p._cachedCoordinatesMode!==i.coordinatesMode){p._cachedCoordinatesMode=i.coordinatesMode;const y=i.coordinatesMode!==3&&i.coordinatesMode!==5?1:0;i.wrapU=y,i.wrapV=y}p._cachedWrapU!==i.wrapU&&(p._cachedWrapU=i.wrapU,this._setTextureParameterInteger(g,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(i.wrapU),p)),p._cachedWrapV!==i.wrapV&&(p._cachedWrapV=i.wrapV,this._setTextureParameterInteger(g,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i.wrapV),p)),p.is3D&&p._cachedWrapR!==i.wrapR&&(p._cachedWrapR=i.wrapR,this._setTextureParameterInteger(g,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(i.wrapR),p)),this._setAnisotropicLevel(g,p,i.anisotropicFilteringLevel)}return!0}setTextureArray(e,i,s,n){if(!(e===void 0||!i)){(!this._textureUnits||this._textureUnits.length!==s.length)&&(this._textureUnits=new Int32Array(s.length));for(let a=0;a<s.length;a++){const p=s[a].getInternalTexture();p?(this._textureUnits[a]=e+a,p._associatedChannel=e+a):this._textureUnits[a]=-1}this._gl.uniform1iv(i,this._textureUnits);for(let a=0;a<s.length;a++)this._setTexture(this._textureUnits[a],s[a],!0)}}_setAnisotropicLevel(e,i,s){const n=this._caps.textureAnisotropicFilterExtension;i.samplingMode!==11&&i.samplingMode!==3&&i.samplingMode!==2&&(s=1),n&&i._cachedAnisotropicFilteringLevel!==s&&(this._setTextureParameterFloat(e,n.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(s,this._caps.maxAnisotropy),i),i._cachedAnisotropicFilteringLevel=s)}_setTextureParameterFloat(e,i,s,n){this._bindTextureDirectly(e,n,!0,!0),this._gl.texParameterf(e,i,s)}_setTextureParameterInteger(e,i,s,n){n&&this._bindTextureDirectly(e,n,!0,!0),this._gl.texParameteri(e,i,s)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(let e=0,i=this._vertexAttribArraysEnabled.length;e<i;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){for(const e in this._compiledEffects){const i=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(i)}this._compiledEffects={}}dispose(){var e;this._isDisposed=!0,this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),(e=this.releaseComputeEffects)===null||e===void 0||e.call(this),this.unbindAllAttributes(),this._boundUniforms={},Ts()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),window.removeEventListener("resize",this._checkForMobile)),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,ir.ResetCache();for(const i of this._activeRequests)i.abort();this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){const i=this._gl;for(;i.getError()!==i.NO_ERROR;);let s=!0;const n=i.createTexture();i.bindTexture(i.TEXTURE_2D,n),i.texImage2D(i.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,i.RGBA,this._getWebGLTextureType(e),null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST);const a=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,a),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,n,0);const p=i.checkFramebufferStatus(i.FRAMEBUFFER);if(s=s&&p===i.FRAMEBUFFER_COMPLETE,s=s&&i.getError()===i.NO_ERROR,s&&(i.clear(i.COLOR_BUFFER_BIT),s=s&&i.getError()===i.NO_ERROR),s){i.bindFramebuffer(i.FRAMEBUFFER,null);const _=i.RGBA,g=i.UNSIGNED_BYTE,y=new Uint8Array(4);i.readPixels(0,0,1,1,_,g,y),s=s&&i.getError()===i.NO_ERROR}for(i.deleteTexture(n),i.deleteFramebuffer(a),i.bindFramebuffer(i.FRAMEBUFFER,null);!s&&i.getError()!==i.NO_ERROR;);return s}_getWebGLTextureType(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,i=!1){let s=i?this._gl.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:s=this._gl.ALPHA;break;case 1:s=this._gl.LUMINANCE;break;case 2:s=this._gl.LUMINANCE_ALPHA;break;case 6:s=this._gl.RED;break;case 7:s=this._gl.RG;break;case 4:s=i?this._gl.SRGB:this._gl.RGB;break;case 5:s=i?this._gl.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:s=this._gl.RED_INTEGER;break;case 9:s=this._gl.RG_INTEGER;break;case 10:s=this._gl.RGB_INTEGER;break;case 11:s=this._gl.RGBA_INTEGER;break}return s}_getRGBABufferInternalSizedFormat(e,i,s=!1){if(this._webGLVersion===1){if(i!==void 0)switch(i){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return s?this._gl.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(i){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(i){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return s?this._gl.SRGB8:this._gl.RGB8;case 5:return s?this._gl.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(i){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(i){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(i){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(i){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(i){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(i){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(i){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return s?this._gl.SRGB8_ALPHA8:this._gl.RGBA8}_getRGBAMultiSampleBufferFormat(e){return e===1?this._gl.RGBA32F:e===2?this._gl.RGBA16F:this._gl.RGBA8}_loadFile(e,i,s,n,a,p){const _=Yt._FileToolsLoadFile(e,i,s,n,a,p);return this._activeRequests.push(_),_.onCompleteObservable.add(g=>{this._activeRequests.splice(this._activeRequests.indexOf(g),1)}),_}static _FileToolsLoadFile(e,i,s,n,a,p){throw xi("FileTools")}readPixels(e,i,s,n,a=!0,p=!0){const _=a?4:3,g=a?this._gl.RGBA:this._gl.RGB,y=new Uint8Array(n*s*_);return p&&this.flushFramebuffer(),this._gl.readPixels(e,i,s,n,g,this._gl.UNSIGNED_BYTE,y),Promise.resolve(y)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{const e=this._CreateCanvas(1,1),i=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=i!=null&&!!window.WebGLRenderingContext}catch{this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(this._HasMajorPerformanceCaveat===null)try{const e=this._CreateCanvas(1,1),i=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!i}catch{this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}static CeilingPOT(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e}static FloorPOT(e){return e=e|e>>1,e=e|e>>2,e=e|e>>4,e=e|e>>8,e=e|e>>16,e-(e>>1)}static NearestPOT(e){const i=Yt.CeilingPOT(e),s=Yt.FloorPOT(e);return i-e>e-s?s:i}static GetExponentOfTwo(e,i,s=2){let n;switch(s){case 1:n=Yt.FloorPOT(e);break;case 2:n=Yt.NearestPOT(e);break;case 3:default:n=Yt.CeilingPOT(e);break}return Math.min(n,i)}static QueueNewFrame(e,i){if(Ts()){const{requestPostAnimationFrame:s,requestAnimationFrame:n}=i||window;if(typeof s=="function")return s(e);if(typeof n=="function")return n(e)}else if(typeof requestAnimationFrame=="function")return requestAnimationFrame(e);return setTimeout(e,16)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:Lh()?document:null}}Yt.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],Yt._TextureLoaders=[],Yt.CollisionsEpsilon=.001,Yt._IsSupported=null,Yt._HasMajorPerformanceCaveat=null;class m9{constructor(e=30){this._enabled=!0,this._rollingFrameTime=new _9(e)}sampleFrame(e=na.Now){if(!!this._enabled){if(this._lastFrameTimeMs!=null){const i=e-this._lastFrameTimeMs;this._rollingFrameTime.add(i)}this._lastFrameTimeMs=e}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const e=this._rollingFrameTime.history(0);return e===0?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class _9{constructor(e){this._samples=new Array(e),this.reset()}add(e){let i;if(this.isSaturated()){const s=this._samples[this._pos];i=s-this.average,this.average-=i/(this._sampleCount-1),this._m2-=i*(s-this.average)}else this._sampleCount++;i=e-this.average,this.average+=i/this._sampleCount,this._m2+=i*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;const i=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(i-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){const i=this._samples.length;return(e%i+i)%i}}class Go{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(e,i){!Go.Enabled||(this._current+=e,i&&this._fetchResult())}beginMonitoring(){!Go.Enabled||(this._startMonitoringTime=na.Now)}endMonitoring(e=!0){if(!Go.Enabled)return;e&&this.fetchNewFrame();const i=na.Now;this._current=i-this._startMonitoringTime,e&&this._fetchResult()}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;const e=na.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}Go.Enabled=!0,Yt.prototype.setAlphaConstants=function(l,e,i,s){this._alphaState.setAlphaBlendConstants(l,e,i,s)},Yt.prototype.setAlphaMode=function(l,e=!1){if(this._alphaMode===l){if(!e){const i=l===0;this.depthCullingState.depthMask!==i&&(this.depthCullingState.depthMask=i)}return}switch(l){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break}e||(this.depthCullingState.depthMask=l===0),this._alphaMode=l},Yt.prototype.getAlphaMode=function(){return this._alphaMode},Yt.prototype.setAlphaEquation=function(l){if(this._alphaEquation!==l){switch(l){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774);break}this._alphaEquation=l}},Yt.prototype.getAlphaEquation=function(){return this._alphaEquation};function g9(l,e,i=!1,s){switch(l){case 3:{const a=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e);return s&&a.set(new Int8Array(s)),a}case 0:{const a=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return s&&a.set(new Uint8Array(s)),a}case 4:{const a=e instanceof ArrayBuffer?new Int16Array(e):new Int16Array(i?e/2:e);return s&&a.set(new Int16Array(s)),a}case 5:case 8:case 9:case 10:case 2:{const a=e instanceof ArrayBuffer?new Uint16Array(e):new Uint16Array(i?e/2:e);return s&&a.set(new Uint16Array(s)),a}case 6:{const a=e instanceof ArrayBuffer?new Int32Array(e):new Int32Array(i?e/4:e);return s&&a.set(new Int32Array(s)),a}case 7:case 11:case 12:case 13:case 14:case 15:{const a=e instanceof ArrayBuffer?new Uint32Array(e):new Uint32Array(i?e/4:e);return s&&a.set(new Uint32Array(s)),a}case 1:{const a=e instanceof ArrayBuffer?new Float32Array(e):new Float32Array(i?e/4:e);return s&&a.set(new Float32Array(s)),a}}const n=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return s&&n.set(new Uint8Array(s)),n}Yt.prototype._readTexturePixelsSync=function(l,e,i,s=-1,n=0,a=null,p=!0,_=!1,g=0,y=0){var b,v;const S=this._gl;if(!S)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const F=S.createFramebuffer();if(!F)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=F}S.bindFramebuffer(S.FRAMEBUFFER,this._dummyFramebuffer),s>-1?S.framebufferTexture2D(S.FRAMEBUFFER,S.COLOR_ATTACHMENT0,S.TEXTURE_CUBE_MAP_POSITIVE_X+s,(b=l._hardwareTexture)===null||b===void 0?void 0:b.underlyingResource,n):S.framebufferTexture2D(S.FRAMEBUFFER,S.COLOR_ATTACHMENT0,S.TEXTURE_2D,(v=l._hardwareTexture)===null||v===void 0?void 0:v.underlyingResource,n);let M=l.type!==void 0?this._getWebGLTextureType(l.type):S.UNSIGNED_BYTE;if(_)a||(a=g9(l.type,4*e*i));else switch(M){case S.UNSIGNED_BYTE:a||(a=new Uint8Array(4*e*i)),M=S.UNSIGNED_BYTE;break;default:a||(a=new Float32Array(4*e*i)),M=S.FLOAT;break}return p&&this.flushFramebuffer(),S.readPixels(g,y,e,i,S.RGBA,M,a),S.bindFramebuffer(S.FRAMEBUFFER,this._currentFramebuffer),a},Yt.prototype._readTexturePixels=function(l,e,i,s=-1,n=0,a=null,p=!0,_=!1,g=0,y=0){return Promise.resolve(this._readTexturePixelsSync(l,e,i,s,n,a,p,_,g,y))},Yt.prototype.updateDynamicIndexBuffer=function(l,e,i=0){this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(l);let s;l.is32Bits?s=e instanceof Uint32Array?e:new Uint32Array(e):s=e instanceof Uint16Array?e:new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,s,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},Yt.prototype.updateDynamicVertexBuffer=function(l,e,i,s){this.bindArrayBuffer(l),i===void 0&&(i=0);const n=e.byteLength||e.length;s===void 0||s>=n&&i===0?e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,new Float32Array(e)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(e).subarray(i,i+s)):(e instanceof ArrayBuffer?e=new Uint8Array(e,i,s):e=new Uint8Array(e.buffer,e.byteOffset+i,s),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)),this._resetVertexBufferBinding()};class Ae extends Yt{static get NpmPackage(){return Yt.NpmPackage}static get Version(){return Yt.Version}static get Instances(){return Zt.Instances}static get LastCreatedEngine(){return Zt.LastCreatedEngine}static get LastCreatedScene(){return Zt.LastCreatedScene}_createImageBitmapFromSource(e,i){return new Promise((n,a)=>{const p=new Image;p.onload=()=>{p.decode().then(()=>{this.createImageBitmap(p,i).then(_=>{n(_)})})},p.onerror=()=>{a(`Error loading image ${p.src}`)},p.src=e})}createImageBitmap(e,i){return createImageBitmap(e,i)}resizeImageBitmap(e,i,s){const a=this.createCanvas(i,s).getContext("2d");if(!a)throw new Error("Unable to get 2d context for resizeImageBitmap");return a.drawImage(e,0,0),a.getImageData(0,0,i,s).data}static MarkAllMaterialsAsDirty(e,i){for(let s=0;s<Ae.Instances.length;s++){const n=Ae.Instances[s];for(let a=0;a<n.scenes.length;a++)n.scenes[a].markAllMaterialsAsDirty(e,i)}}static DefaultLoadingScreenFactory(e){throw xi("LoadingScreen")}get _supportsHardwareTextureRescaling(){return!!Ae._RescalePostProcessFactory}get performanceMonitor(){return this._performanceMonitor}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}getInputElement(){return this._renderingCanvas}constructor(e,i,s,n=!1){if(super(e,i,s,n),this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.scenes=new Array,this._virtualScenes=new Array,this.onNewSceneAddedObservable=new Re,this.postProcesses=new Array,this.isPointerLock=!1,this.onResizeObservable=new Re,this.onCanvasBlurObservable=new Re,this.onCanvasFocusObservable=new Re,this.onCanvasPointerOutObservable=new Re,this.onBeginFrameObservable=new Re,this.customAnimationFrameRequester=null,this.onEndFrameObservable=new Re,this.onBeforeShaderCompilationObservable=new Re,this.onAfterShaderCompilationObservable=new Re,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this._fps=60,this._deltaTime=0,this._drawCalls=new Go,this.canvasTabIndex=1,this.disablePerformanceMonitorInBackground=!1,this._performanceMonitor=new m9,this._compatibilityMode=!0,this.currentRenderPassId=0,this._renderPassNames=["main"],Ae.Instances.push(this),!!e){if(this._features.supportRenderPasses=!0,s=this._creationOptions,e.getContext){const a=e;this._sharedInit(a),this._connectVREvents()}this._prepareVRComponent(),s.autoEnableWebVR&&this.initWebVR()}}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(e){super._sharedInit(e),this._onCanvasFocus=()=>{this.onCanvasFocusObservable.notifyObservers(this)},this._onCanvasBlur=()=>{this.onCanvasBlurObservable.notifyObservers(this)},this._onCanvasContextMenu=s=>{this.disableContextMenu&&s.preventDefault()},e.addEventListener("focus",this._onCanvasFocus),e.addEventListener("blur",this._onCanvasBlur),e.addEventListener("contextmenu",this._onCanvasContextMenu),this._onBlur=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.disable(),this._windowIsBackground=!0},this._onFocus=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.enable(),this._windowIsBackground=!1},this._onCanvasPointerOut=s=>{document.elementFromPoint(s.clientX,s.clientY)!==e&&this.onCanvasPointerOutObservable.notifyObservers(s)};const i=this.getHostWindow();i&&typeof i.addEventListener=="function"&&(i.addEventListener("blur",this._onBlur),i.addEventListener("focus",this._onFocus)),e.addEventListener("pointerout",this._onCanvasPointerOut),this._creationOptions.doNotHandleTouchAction||this._disableTouchAction(),!Ae.audioEngine&&this._creationOptions.audioEngine&&Ae.AudioEngineFactory&&(Ae.audioEngine=Ae.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination())),Lh()&&(this._onFullscreenChange=()=>{this.isFullscreen=!!document.fullscreenElement,this.isFullscreen&&this._pointerLockRequested&&e&&Ae._RequestPointerlock(e)},document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),this._onPointerLockChange=()=>{this.isPointerLock=document.pointerLockElement===e},document.addEventListener("pointerlockchange",this._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,!1)),this.enableOfflineSupport=Ae.OfflineProviderFactory!==void 0,this._deterministicLockstep=!!this._creationOptions.deterministicLockstep,this._lockstepMaxSteps=this._creationOptions.lockstepMaxSteps||0,this._timeStep=this._creationOptions.timeStep||1/60}_verifyPointerLock(){var e;(e=this._onPointerLockChange)===null||e===void 0||e.call(this)}getAspectRatio(e,i=!1){const s=e.viewport;return this.getRenderWidth(i)*s.width/(this.getRenderHeight(i)*s.height)}getScreenAspectRatio(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)}getRenderingCanvasClientRect(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null}getInputElementClientRect(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return this._timeStep*1e3}generateMipMapsForCubemap(e,i=!0){if(e.generateMipMaps){const s=this._gl;this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,e,!0),s.generateMipmap(s.TEXTURE_CUBE_MAP),i&&this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null)}}getDepthWrite(){return this._depthCullingState.depthMask}setDepthWrite(e){this._depthCullingState.depthMask=e}getStencilBuffer(){return this._stencilState.stencilTest}setStencilBuffer(e){this._stencilState.stencilTest=e}getStencilMask(){return this._stencilState.stencilMask}setStencilMask(e){this._stencilState.stencilMask=e}getStencilFunction(){return this._stencilState.stencilFunc}getStencilFunctionReference(){return this._stencilState.stencilFuncRef}getStencilFunctionMask(){return this._stencilState.stencilFuncMask}setStencilFunction(e){this._stencilState.stencilFunc=e}setStencilFunctionReference(e){this._stencilState.stencilFuncRef=e}setStencilFunctionMask(e){this._stencilState.stencilFuncMask=e}getStencilOperationFail(){return this._stencilState.stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilState.stencilOpDepthFail}getStencilOperationPass(){return this._stencilState.stencilOpStencilDepthPass}setStencilOperationFail(e){this._stencilState.stencilOpStencilFail=e}setStencilOperationDepthFail(e){this._stencilState.stencilOpDepthFail=e}setStencilOperationPass(e){this._stencilState.stencilOpStencilDepthPass=e}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}getDepthFunction(){return this._depthCullingState.depthFunc}setDepthFunction(e){this._depthCullingState.depthFunc=e}setDepthFunctionToGreater(){this.setDepthFunction(516)}setDepthFunctionToGreaterOrEqual(){this.setDepthFunction(518)}setDepthFunctionToLess(){this.setDepthFunction(513)}setDepthFunctionToLessOrEqual(){this.setDepthFunction(515)}cacheStencilState(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()}restoreStencilState(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)}setDirectViewport(e,i,s,n){const a=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,i,s,n),a}scissorClear(e,i,s,n,a){this.enableScissor(e,i,s,n),this.clear(a,!0,!0,!0),this.disableScissor()}enableScissor(e,i,s,n){const a=this._gl;a.enable(a.SCISSOR_TEST),a.scissor(e,i,s,n)}disableScissor(){const e=this._gl;e.disable(e.SCISSOR_TEST)}_reportDrawCall(e=1){this._drawCalls.addCount(e,!1)}initWebVR(){throw xi("WebVRCamera")}_prepareVRComponent(){}_connectVREvents(e,i){}_submitVRFrame(){}disableVR(){}isVRPresenting(){return!1}_requestVRFrame(){}_loadFileAsync(e,i,s){return new Promise((n,a)=>{this._loadFile(e,p=>{n(p)},void 0,i,s,(p,_)=>{a(_)})})}getVertexShaderSource(e){const i=this._gl.getAttachedShaders(e);return i?this._gl.getShaderSource(i[0]):null}getFragmentShaderSource(e){const i=this._gl.getAttachedShaders(e);return i?this._gl.getShaderSource(i[1]):null}setDepthStencilTexture(e,i,s,n){e!==void 0&&(i&&(this._boundUniforms[e]=i),!s||!s.depthStencilTexture?this._setTexture(e,null,void 0,void 0,n):this._setTexture(e,s,!1,!0,n))}setTextureFromPostProcess(e,i,s){var n;let a=null;i&&(i._textures.data[i._currentRenderTextureInd]?a=i._textures.data[i._currentRenderTextureInd]:i._forcedOutputTexture&&(a=i._forcedOutputTexture)),this._bindTexture(e,(n=a?.texture)!==null&&n!==void 0?n:null,s)}setTextureFromPostProcessOutput(e,i,s){var n,a;this._bindTexture(e,(a=(n=i?._outputTexture)===null||n===void 0?void 0:n.texture)!==null&&a!==void 0?a:null,s)}_rebuildBuffers(){for(const e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();for(const e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();super._rebuildBuffers()}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++){const i=this._activeRenderLoops[e];i()}}_renderLoop(){if(!this._contextWasLost){let e=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this.isVRPresenting()?this._requestVRFrame():this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}_renderViews(){return!1}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&Ae._RequestFullscreen(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&Ae._ExitFullscreen()}enterPointerlock(){this._renderingCanvas&&Ae._RequestPointerlock(this._renderingCanvas)}exitPointerlock(){Ae._ExitPointerlock()}beginFrame(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),super.beginFrame()}endFrame(){super.endFrame(),this._submitVRFrame(),this.onEndFrameObservable.notifyObservers(this)}resize(e=!1){this.isVRPresenting()||super.resize(e)}setSize(e,i,s=!1){if(!this._renderingCanvas||!super.setSize(e,i,s))return!1;if(this.scenes){for(let n=0;n<this.scenes.length;n++){const a=this.scenes[n];for(let p=0;p<a.cameras.length;p++){const _=a.cameras[p];_._currentRenderId=0}}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}_deletePipelineContext(e){const i=e;i&&i.program&&i.transformFeedback&&(this.deleteTransformFeedback(i.transformFeedback),i.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,i,s,n,a,p=null){a=a||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const _=super.createShaderProgram(e,i,s,n,a,p);return this.onAfterShaderCompilationObservable.notifyObservers(this),_}_createShaderProgram(e,i,s,n,a=null){const p=n.createProgram();if(e.program=p,!p)throw new Error("Unable to create program");if(n.attachShader(p,i),n.attachShader(p,s),this.webGLVersion>1&&a){const _=this.createTransformFeedback();this.bindTransformFeedback(_),this.setTranformFeedbackVaryings(p,a),e.transformFeedback=_}return n.linkProgram(p),this.webGLVersion>1&&a&&this.bindTransformFeedback(null),e.context=n,e.vertexShader=i,e.fragmentShader=s,e.isParallelCompiled||this._finalizePipelineContext(e),p}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e),this.scenes.forEach(i=>{i.postProcesses.forEach(s=>{s._outputTexture===e&&(s._outputTexture=null)}),i.cameras.forEach(s=>{s._postProcesses.forEach(n=>{n&&n._outputTexture===e&&(n._outputTexture=null)})})})}getRenderPassNames(){return this._renderPassNames}getCurrentRenderPassName(){return this._renderPassNames[this.currentRenderPassId]}createRenderPassId(e){const i=++Ae._RenderPassIdCounter;return this._renderPassNames[i]=e??"NONAME",i}releaseRenderPassId(e){this._renderPassNames[e]=void 0;for(let i=0;i<this.scenes.length;++i){const s=this.scenes[i];for(let n=0;n<s.meshes.length;++n){const a=s.meshes[n];if(a.subMeshes)for(let p=0;p<a.subMeshes.length;++p)a.subMeshes[p]._removeDrawWrapper(e)}}}_rescaleTexture(e,i,s,n,a){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const p=this.createRenderTargetTexture({width:i.width,height:i.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&Ae._RescalePostProcessFactory&&(this._rescalePostProcess=Ae._RescalePostProcessFactory(this)),this._rescalePostProcess&&(this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled(()=>{this._rescalePostProcess.onApply=function(g){g._bindTexture("textureSampler",e)};let _=s;_||(_=this.scenes[this.scenes.length-1]),_.postProcessManager.directRender([this._rescalePostProcess],p,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,i,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,n,0,0,i.width,i.height,0),this.unBindFramebuffer(p),p.dispose(),a&&a()}))}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}wrapWebGLTexture(e,i=!1,s=3){const n=new jm(e,this._gl),a=new Bs(this,or.Unknown,!0);return a._hardwareTexture=n,a.isReady=!0,a.useMipMaps=i,this.updateTextureSamplingMode(s,a),a}_uploadImageToTexture(e,i,s=0,n=0){const a=this._gl,p=this._getWebGLTextureType(e.type),_=this._getInternalFormat(e.format),g=this._getRGBABufferInternalSizedFormat(e.type,_),y=e.isCube?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;this._bindTextureDirectly(y,e,!0),this._unpackFlipY(e.invertY);let b=a.TEXTURE_2D;e.isCube&&(b=a.TEXTURE_CUBE_MAP_POSITIVE_X+s),a.texImage2D(b,n,g,_,p,i),this._bindTextureDirectly(y,null,!0)}updateTextureComparisonFunction(e,i){if(this.webGLVersion===1){Ie.Error("WebGL 1 does not support texture comparison.");return}const s=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),i===0?(s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_COMPARE_FUNC,515),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_COMPARE_MODE,s.NONE)):(s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_COMPARE_FUNC,i),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_COMPARE_MODE,s.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),i===0?(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_FUNC,515),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_MODE,s.NONE)):(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_FUNC,i),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_MODE,s.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=i}createInstancesBuffer(e){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create instance buffer");const s=new kh(i);return s.capacity=e,this.bindArrayBuffer(s),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),s.references=1,s}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}_clientWaitAsync(e,i=0,s=10){const n=this._gl;return new Promise((a,p)=>{const _=()=>{const g=n.clientWaitSync(e,i,0);if(g==n.WAIT_FAILED){p();return}if(g==n.TIMEOUT_EXPIRED){setTimeout(_,s);return}a()};_()})}_readPixelsAsync(e,i,s,n,a,p,_){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const g=this._gl,y=g.createBuffer();g.bindBuffer(g.PIXEL_PACK_BUFFER,y),g.bufferData(g.PIXEL_PACK_BUFFER,_.byteLength,g.STREAM_READ),g.readPixels(e,i,s,n,a,p,0),g.bindBuffer(g.PIXEL_PACK_BUFFER,null);const b=g.fenceSync(g.SYNC_GPU_COMMANDS_COMPLETE,0);return b?(g.flush(),this._clientWaitAsync(b,0,10).then(()=>(g.deleteSync(b),g.bindBuffer(g.PIXEL_PACK_BUFFER,y),g.getBufferSubData(g.PIXEL_PACK_BUFFER,0,_),g.bindBuffer(g.PIXEL_PACK_BUFFER,null),g.deleteBuffer(y),_))):null}dispose(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();Zt.Instances.length===1&&Ae.audioEngine&&(Ae.audioEngine.dispose(),Ae.audioEngine=null),this.disableVR();const e=this.getHostWindow();e&&typeof e.removeEventListener=="function"&&(e.removeEventListener("blur",this._onBlur),e.removeEventListener("focus",this._onFocus)),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut),this._renderingCanvas.removeEventListener("contextmenu",this._onCanvasContextMenu)),Lh()&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange)),super.dispose();const i=Zt.Instances.indexOf(this);i>=0&&Zt.Instances.splice(i,1),Ae.Instances.length||(Zt.OnEnginesDisposedObservable.notifyObservers(this),Zt.OnEnginesDisposedObservable.clear()),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}_disableTouchAction(){!this._renderingCanvas||!this._renderingCanvas.setAttribute||(this._renderingCanvas.setAttribute("touch-action","none"),this._renderingCanvas.style.touchAction="none",this._renderingCanvas.style.webkitTapHighlightColor="transparent")}displayLoadingUI(){if(!Ts())return;const e=this.loadingScreen;e&&e.displayLoadingUI()}hideLoadingUI(){if(!Ts())return;const e=this._loadingScreen;e&&e.hideLoadingUI()}get loadingScreen(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=Ae.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen}set loadingScreen(e){this._loadingScreen=e}set loadingUIText(e){this.loadingScreen.loadingUIText=e}set loadingUIBackgroundColor(e){this.loadingScreen.loadingUIBackgroundColor=e}createVideoElement(e){return document.createElement("video")}static _RequestPointerlock(e){if(e.requestPointerLock){const i=e.requestPointerLock();i instanceof Promise?i.then(()=>{e.focus()}).catch(()=>{}):e.focus()}}static _ExitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}static _RequestFullscreen(e){const i=e.requestFullscreen||e.webkitRequestFullscreen;!i||i.call(e)}static _ExitFullscreen(){const e=document;document.exitFullscreen?document.exitFullscreen():e.webkitCancelFullScreen&&e.webkitCancelFullScreen()}getFontOffset(e){const i=document.createElement("span");i.innerHTML="Hg",i.setAttribute("style",`font: ${e} !important`);const s=document.createElement("div");s.style.display="inline-block",s.style.width="1px",s.style.height="0px",s.style.verticalAlign="bottom";const n=document.createElement("div");n.style.whiteSpace="nowrap",n.appendChild(i),n.appendChild(s),document.body.appendChild(n);let a=0,p=0;try{p=s.getBoundingClientRect().top-i.getBoundingClientRect().top,s.style.verticalAlign="baseline",a=s.getBoundingClientRect().top-i.getBoundingClientRect().top}finally{document.body.removeChild(n)}return{ascent:a,height:p,descent:p-a}}}Ae.ALPHA_DISABLE=0,Ae.ALPHA_ADD=1,Ae.ALPHA_COMBINE=2,Ae.ALPHA_SUBTRACT=3,Ae.ALPHA_MULTIPLY=4,Ae.ALPHA_MAXIMIZED=5,Ae.ALPHA_ONEONE=6,Ae.ALPHA_PREMULTIPLIED=7,Ae.ALPHA_PREMULTIPLIED_PORTERDUFF=8,Ae.ALPHA_INTERPOLATE=9,Ae.ALPHA_SCREENMODE=10,Ae.DELAYLOADSTATE_NONE=0,Ae.DELAYLOADSTATE_LOADED=1,Ae.DELAYLOADSTATE_LOADING=2,Ae.DELAYLOADSTATE_NOTLOADED=4,Ae.NEVER=512,Ae.ALWAYS=519,Ae.LESS=513,Ae.EQUAL=514,Ae.LEQUAL=515,Ae.GREATER=516,Ae.GEQUAL=518,Ae.NOTEQUAL=517,Ae.KEEP=7680,Ae.REPLACE=7681,Ae.INCR=7682,Ae.DECR=7683,Ae.INVERT=5386,Ae.INCR_WRAP=34055,Ae.DECR_WRAP=34056,Ae.TEXTURE_CLAMP_ADDRESSMODE=0,Ae.TEXTURE_WRAP_ADDRESSMODE=1,Ae.TEXTURE_MIRROR_ADDRESSMODE=2,Ae.TEXTUREFORMAT_ALPHA=0,Ae.TEXTUREFORMAT_LUMINANCE=1,Ae.TEXTUREFORMAT_LUMINANCE_ALPHA=2,Ae.TEXTUREFORMAT_RGB=4,Ae.TEXTUREFORMAT_RGBA=5,Ae.TEXTUREFORMAT_RED=6,Ae.TEXTUREFORMAT_R=6,Ae.TEXTUREFORMAT_RG=7,Ae.TEXTUREFORMAT_RED_INTEGER=8,Ae.TEXTUREFORMAT_R_INTEGER=8,Ae.TEXTUREFORMAT_RG_INTEGER=9,Ae.TEXTUREFORMAT_RGB_INTEGER=10,Ae.TEXTUREFORMAT_RGBA_INTEGER=11,Ae.TEXTURETYPE_UNSIGNED_BYTE=0,Ae.TEXTURETYPE_UNSIGNED_INT=0,Ae.TEXTURETYPE_FLOAT=1,Ae.TEXTURETYPE_HALF_FLOAT=2,Ae.TEXTURETYPE_BYTE=3,Ae.TEXTURETYPE_SHORT=4,Ae.TEXTURETYPE_UNSIGNED_SHORT=5,Ae.TEXTURETYPE_INT=6,Ae.TEXTURETYPE_UNSIGNED_INTEGER=7,Ae.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,Ae.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,Ae.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,Ae.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,Ae.TEXTURETYPE_UNSIGNED_INT_24_8=12,Ae.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,Ae.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,Ae.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,Ae.TEXTURE_NEAREST_SAMPLINGMODE=1,Ae.TEXTURE_BILINEAR_SAMPLINGMODE=2,Ae.TEXTURE_TRILINEAR_SAMPLINGMODE=3,Ae.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,Ae.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,Ae.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,Ae.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,Ae.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,Ae.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,Ae.TEXTURE_NEAREST_LINEAR=7,Ae.TEXTURE_NEAREST_NEAREST=1,Ae.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,Ae.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,Ae.TEXTURE_LINEAR_LINEAR=2,Ae.TEXTURE_LINEAR_NEAREST=12,Ae.TEXTURE_EXPLICIT_MODE=0,Ae.TEXTURE_SPHERICAL_MODE=1,Ae.TEXTURE_PLANAR_MODE=2,Ae.TEXTURE_CUBIC_MODE=3,Ae.TEXTURE_PROJECTION_MODE=4,Ae.TEXTURE_SKYBOX_MODE=5,Ae.TEXTURE_INVCUBIC_MODE=6,Ae.TEXTURE_EQUIRECTANGULAR_MODE=7,Ae.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,Ae.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,Ae.SCALEMODE_FLOOR=1,Ae.SCALEMODE_NEAREST=2,Ae.SCALEMODE_CEILING=3,Ae._RescalePostProcessFactory=null,Ae._RenderPassIdCounter=0;const cE=(l,e)=>!l||l.getClassName&&l.getClassName()==="Mesh"?null:l.getClassName&&l.getClassName()==="SubMesh"?l.clone(e):l.clone?l.clone():null;function y9(l){const e=[];do Object.getOwnPropertyNames(l).forEach(function(i){e.indexOf(i)===-1&&e.push(i)});while(l=Object.getPrototypeOf(l));return e}class Ya{static DeepCopy(e,i,s,n){const a=y9(e);for(const p of a){if(p[0]==="_"&&(!n||n.indexOf(p)===-1)||p.endsWith("Observable")||s&&s.indexOf(p)!==-1)continue;const _=e[p],g=typeof _;if(g!=="function")try{if(g==="object")if(_ instanceof Array){if(i[p]=[],_.length>0)if(typeof _[0]=="object")for(let y=0;y<_.length;y++){const b=cE(_[y],i);i[p].indexOf(b)===-1&&i[p].push(b)}else i[p]=_.slice(0)}else i[p]=cE(_,i);else i[p]=_}catch(y){Ie.Warn(y.message)}}}}function b9(){return typeof _native<"u"&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest}class en{constructor(){this._xhr=b9(),this._requestURL=""}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(const e in en.CustomRequestHeaders){const i=en.CustomRequestHeaders[e];i&&this._xhr.setRequestHeader(e,i)}}_shouldSkipRequestModifications(e){return en.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,i,s){this._xhr.addEventListener(e,i,s)}removeEventListener(e,i,s){this._xhr.removeEventListener(e,i,s)}abort(){this._xhr.abort()}send(e){en.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)}open(e,i){for(const s of en.CustomRequestModifiers){if(this._shouldSkipRequestModifications(i))return;s(this._xhr,i)}return i=i.replace("file:http:","http:"),i=i.replace("file:https:","https:"),this._requestURL=i,this._xhr.open(e,i,!0)}setRequestHeader(e,i){this._xhr.setRequestHeader(e,i)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}}en.CustomRequestHeaders={},en.CustomRequestModifiers=new Array,en.SkipRequestModificationForBabylonCDN=!0;class Uh{}Uh.FilesToLoad={};class v9{static ExponentialBackoff(e=3,i=500){return(s,n,a)=>n.status!==0||a>=e||s.indexOf("file:")!==-1?-1:Math.pow(2,a)*i}}class fc extends Error{}fc._setPrototypeOf=Object.setPrototypeOf||((l,e)=>(l.__proto__=e,l));const _x={MeshInvalidPositionsError:0,UnsupportedTextureError:1e3,GLTFLoaderUnexpectedMagicError:2e3,SceneLoaderError:3e3,LoadFileError:4e3,RequestFileError:4001,ReadFileError:4002};class Wo extends fc{constructor(e,i,s){super(e),this.errorCode=i,this.innerError=s,this.name="RuntimeError",fc._setPrototypeOf(this,Wo.prototype)}}const T9=(l,e)=>l.endsWith(e),E9=(l,e)=>l?l.startsWith(e):!1,hE=l=>{if(typeof TextDecoder<"u")return new TextDecoder().decode(l);let e="";for(let i=0;i<l.byteLength;i++)e+=String.fromCharCode(l[i]);return e},qm=l=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let i="",s,n,a,p,_,g,y,b=0;const v=ArrayBuffer.isView(l)?new Uint8Array(l.buffer,l.byteOffset,l.byteLength):new Uint8Array(l);for(;b<v.length;)s=v[b++],n=b<v.length?v[b++]:Number.NaN,a=b<v.length?v[b++]:Number.NaN,p=s>>2,_=(s&3)<<4|n>>4,g=(n&15)<<2|a>>6,y=a&63,isNaN(n)?g=y=64:isNaN(a)&&(y=64),i+=e.charAt(p)+e.charAt(_)+e.charAt(g)+e.charAt(y);return i},Zm=l=>atob(l),uE=l=>{const e=Zm(l),i=e.length,s=new Uint8Array(new ArrayBuffer(i));for(let n=0;n<i;n++)s[n]=e.charCodeAt(n);return s.buffer},AY={EndsWith:T9,StartsWith:E9,Decode:hE,EncodeArrayBufferToBase64:qm,DecodeBase64ToString:Zm,DecodeBase64ToBinary:uE,PadNumber:(l,e)=>{let i=String(l);for(;i.length<e;)i="0"+i;return i}};class pc{static SetImmediate(e){Ts()&&window.setImmediate?window.setImmediate(e):setTimeout(e,1)}}const dE=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i);class Vh extends Wo{constructor(e,i){super(e,_x.LoadFileError),this.name="LoadFileError",fc._setPrototypeOf(this,Vh.prototype),i instanceof en?this.request=i:this.file=i}}class d2 extends Wo{constructor(e,i){super(e,_x.RequestFileError),this.request=i,this.name="RequestFileError",fc._setPrototypeOf(this,d2.prototype)}}class Qm extends Wo{constructor(e,i){super(e,_x.ReadFileError),this.file=i,this.name="ReadFileError",fc._setPrototypeOf(this,Qm.prototype)}}const Us={DefaultRetryStrategy:v9.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:l=>l},fE=l=>(l=l.replace(/#/gm,"%23"),l),$m=(l,e)=>{if(!(l&&l.indexOf("data:")===0)&&Us.CorsBehavior)if(typeof Us.CorsBehavior=="string"||Us.CorsBehavior instanceof String)e.crossOrigin=Us.CorsBehavior;else{const i=Us.CorsBehavior(l);i&&(e.crossOrigin=i)}},f2=(l,e,i,s,n="",a)=>{var p;let _,g=!1;l instanceof ArrayBuffer||ArrayBuffer.isView(l)?typeof Blob<"u"&&typeof URL<"u"?(_=URL.createObjectURL(new Blob([l],{type:n})),g=!0):_=`data:${n};base64,`+qm(l):l instanceof Blob?(_=URL.createObjectURL(l),g=!0):(_=fE(l),_=Us.PreprocessUrl(l));const y=Zt.LastCreatedEngine,b=Y=>{if(i){const Z=_||l.toString();i(`Error while trying to load image: ${Z.indexOf("http")===0||Z.length<=128?Z:Z.slice(0,128)+"..."}`,Y)}};if(typeof Image>"u"||((p=y?._features.forceBitmapOverHTMLImageElement)!==null&&p!==void 0?p:!1))return gx(_,Y=>{y.createImageBitmap(new Blob([Y],{type:n}),{premultiplyAlpha:"none",...a}).then(Z=>{e(Z),g&&URL.revokeObjectURL(_)}).catch(Z=>{i&&i("Error while trying to load image: "+l,Z)})},void 0,s||void 0,!0,(Y,Z)=>{b(Z)}),null;const v=new Image;$m(_,v);const S=[],M=()=>{S.forEach(Y=>{Y.target.addEventListener(Y.name,Y.handler)})},F=()=>{S.forEach(Y=>{Y.target.removeEventListener(Y.name,Y.handler)}),S.length=0},L=()=>{F(),e(v),g&&v.src&&URL.revokeObjectURL(v.src)},N=Y=>{F(),b(Y),g&&v.src&&URL.revokeObjectURL(v.src)},k=Y=>{if(Y.blockedURI!==v.src)return;F();const Z=new Error(`CSP violation of policy ${Y.effectiveDirective} ${Y.blockedURI}. Current policy is ${Y.originalPolicy}`);Zt.UseFallbackTexture=!1,b(Z),g&&v.src&&URL.revokeObjectURL(v.src),v.src=""};S.push({target:v,name:"load",handler:L}),S.push({target:v,name:"error",handler:N}),S.push({target:document,name:"securitypolicyviolation",handler:k}),M();const G=_.substring(0,5)==="blob:",H=_.substring(0,5)==="data:",z=()=>{G||H?v.src=_:gx(_,(Y,Z,Q)=>{const se=!n&&Q?Q:n,$=new Blob([Y],{type:se}),oe=URL.createObjectURL($);g=!0,v.src=oe},void 0,s||void 0,!0,(Y,Z)=>{b(Z)})},W=()=>{s&&s.loadImage(_,v)};if(!G&&!H&&s&&s.enableTexturesOffline)s.open(W,z);else{if(_.indexOf("file:")!==-1){const Y=decodeURIComponent(_.substring(5).toLowerCase());if(Uh.FilesToLoad[Y]&&typeof URL<"u"){try{let Z;try{Z=URL.createObjectURL(Uh.FilesToLoad[Y])}catch{Z=URL.createObjectURL(Uh.FilesToLoad[Y])}v.src=Z,g=!0}catch{v.src=""}return v}}z()}return v},Gh=(l,e,i,s,n)=>{const a=new FileReader,p={onCompleteObservable:new Re,abort:()=>a.abort()};return a.onloadend=()=>p.onCompleteObservable.notifyObservers(p),n&&(a.onerror=()=>{n(new Qm(`Unable to read ${l.name}`,l))}),a.onload=_=>{e(_.target.result)},i&&(a.onprogress=i),s?a.readAsArrayBuffer(l):a.readAsText(l),p},gx=(l,e,i,s,n,a,p)=>{if(l.name)return Gh(l,e,i,n,a?b=>{a(void 0,b)}:void 0);const _=l;if(_.indexOf("file:")!==-1){let b=decodeURIComponent(_.substring(5).toLowerCase());b.indexOf("./")===0&&(b=b.substring(2));const v=Uh.FilesToLoad[b];if(v)return Gh(v,e,i,n,a?S=>a(void 0,new Vh(S.message,S.file)):void 0)}const{match:g,type:y}=A9(_);if(g){const b={onCompleteObservable:new Re,abort:()=>()=>{}};try{const v=n?Wh(_):mE(_);e(v,void 0,y)}catch(v){a?a(void 0,v):Ie.Error(v.message||"Failed to parse the Data URL")}return pc.SetImmediate(()=>{b.onCompleteObservable.notifyObservers(b)}),b}return Jm(_,(b,v)=>{e(b,v?.responseURL,v?.getResponseHeader("content-type"))},i,s,n,a?b=>{a(b.request,new Vh(b.message,b.request))}:void 0,p)},Jm=(l,e,i,s,n,a,p)=>{l=fE(l),l=Us.PreprocessUrl(l);const _=Us.BaseUrl+l;let g=!1;const y={onCompleteObservable:new Re,abort:()=>g=!0},b=()=>{let v=new en,S=null,M;const F=()=>{!v||(i&&v.removeEventListener("progress",i),M&&v.removeEventListener("readystatechange",M),v.removeEventListener("loadend",L))};let L=()=>{F(),y.onCompleteObservable.notifyObservers(y),y.onCompleteObservable.clear(),i=void 0,M=null,L=null,a=void 0,p=void 0,e=void 0};y.abort=()=>{g=!0,L&&L(),v&&v.readyState!==(XMLHttpRequest.DONE||4)&&v.abort(),S!==null&&(clearTimeout(S),S=null),v=null};const N=G=>{const H=G.message||"Unknown error";a&&v?a(new d2(H,v)):Ie.Error(H)},k=G=>{if(!!v){if(v.open("GET",_),p)try{p(v)}catch(H){N(H);return}n&&(v.responseType="arraybuffer"),i&&v.addEventListener("progress",i),L&&v.addEventListener("loadend",L),M=()=>{if(!(g||!v)&&v.readyState===(XMLHttpRequest.DONE||4)){if(M&&v.removeEventListener("readystatechange",M),v.status>=200&&v.status<300||v.status===0&&(!Ts()||pE())){try{e&&e(n?v.response:v.responseText,v)}catch(W){N(W)}return}const H=Us.DefaultRetryStrategy;if(H){const W=H(_,v,G);if(W!==-1){F(),v=new en,S=setTimeout(()=>k(G+1),W);return}}const z=new d2("Error status: "+v.status+" "+v.statusText+" - Unable to load "+_,v);a&&a(z)}},v.addEventListener("readystatechange",M),v.send()}};k(0)};if(s&&s.enableSceneOffline){const v=M=>{M&&M.status>400?a&&a(M):b()},S=()=>{s&&s.loadFile(Us.BaseUrl+l,M=>{!g&&e&&e(M),y.onCompleteObservable.notifyObservers(y)},i?M=>{!g&&i&&i(M)}:void 0,v,n)};s.open(S,v)}else b();return y},pE=()=>typeof location<"u"&&location.protocol==="file:",p2=l=>dE.test(l),A9=l=>{const e=dE.exec(l);if(e===null||e.length===0)return{match:!1,type:""};{const i=e[0].replace("data:","").replace("base64,","");return{match:!0,type:i}}};function Wh(l){return uE(l.split(",")[1])}const mE=l=>Zm(l.split(",")[1]);(()=>{Yt._FileToolsLoadImage=f2,Yt._FileToolsLoadFile=gx,hl._FileToolsLoadFile=gx})();let zh;((l,e,i,s,n,a,p,_,g,y)=>{zh={DecodeBase64UrlToBinary:l,DecodeBase64UrlToString:e,DefaultRetryStrategy:i.DefaultRetryStrategy,BaseUrl:i.BaseUrl,CorsBehavior:i.CorsBehavior,PreprocessUrl:i.PreprocessUrl,IsBase64DataUrl:s,IsFileURL:n,LoadFile:a,LoadImage:p,ReadFile:_,RequestFile:g,SetCorsBehavior:y},Object.defineProperty(zh,"DefaultRetryStrategy",{get:function(){return i.DefaultRetryStrategy},set:function(b){i.DefaultRetryStrategy=b}}),Object.defineProperty(zh,"BaseUrl",{get:function(){return i.BaseUrl},set:function(b){i.BaseUrl=b}}),Object.defineProperty(zh,"PreprocessUrl",{get:function(){return i.PreprocessUrl},set:function(b){i.PreprocessUrl=b}}),Object.defineProperty(zh,"CorsBehavior",{get:function(){return i.CorsBehavior},set:function(b){i.CorsBehavior=b}})})(Wh,mE,Us,p2,pE,gx,f2,Gh,Jm,$m);const _E={};function ur(l,e){_E[l]=e}function Ka(l){return _E[l]}class Hh{static Instantiate(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];const i=Ka(e);if(i)return i;Ie.Warn(e+" not found, you may have missed an import.");const s=e.split(".");let n=window||this;for(let a=0,p=s.length;a<p;a++)n=n[s[a]];return typeof n!="function"?null:n}}Hh.RegisteredExternalClasses={};function m2(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,l=>{const e=Math.random()*16|0;return(l==="x"?e:e&3|8).toString(16)})}const IY={RandomId:m2};class Le{static get BaseUrl(){return Us.BaseUrl}static set BaseUrl(e){Us.BaseUrl=e}static get DefaultRetryStrategy(){return Us.DefaultRetryStrategy}static set DefaultRetryStrategy(e){Us.DefaultRetryStrategy=e}static get CorsBehavior(){return Us.CorsBehavior}static set CorsBehavior(e){Us.CorsBehavior=e}static get UseFallbackTexture(){return Zt.UseFallbackTexture}static set UseFallbackTexture(e){Zt.UseFallbackTexture=e}static get RegisteredExternalClasses(){return Hh.RegisteredExternalClasses}static set RegisteredExternalClasses(e){Hh.RegisteredExternalClasses=e}static get fallbackTexture(){return Zt.FallbackTexture}static set fallbackTexture(e){Zt.FallbackTexture=e}static FetchToRef(e,i,s,n,a,p){const _=Math.abs(e)*s%s|0,g=Math.abs(i)*n%n|0,y=(_+g*s)*4;p.r=a[y]/255,p.g=a[y+1]/255,p.b=a[y+2]/255,p.a=a[y+3]/255}static Mix(e,i,s){return e*(1-s)+i*s}static Instantiate(e){return Hh.Instantiate(e)}static SetImmediate(e){pc.SetImmediate(e)}static IsExponentOfTwo(e){let i=1;do i*=2;while(i<e);return i===e}static FloatRound(e){return Math.fround?Math.fround(e):(Le._TmpFloatArray[0]=e,Le._TmpFloatArray[0])}static GetFilename(e){const i=e.lastIndexOf("/");return i<0?e:e.substring(i+1)}static GetFolderPath(e,i=!1){const s=e.lastIndexOf("/");return s<0?i?e:"":e.substring(0,s+1)}static ToDegrees(e){return e*180/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,i,s=.9){const n=this.ToRadians(e),a=this.ToRadians(i);return this.ToDegrees(Math.atan2((1-s)*Math.sin(a)+s*Math.sin(n),(1-s)*Math.cos(a)+s*Math.cos(n)))}static MakeArray(e,i){return i!==!0&&(e===void 0||e==null)?null:Array.isArray(e)?e:[e]}static GetPointerPrefix(e){let i="pointer";return Ts()&&!window.PointerEvent&&(i="mouse"),e._badDesktopOS&&!e._badOS&&!(document&&"ontouchend"in document)&&(i="mouse"),i}static SetCorsBehavior(e,i){$m(e,i)}static SetReferrerPolicyBehavior(e,i){i.referrerPolicy=e}static CleanUrl(e){return e=e.replace(/#/gm,"%23"),e}static get PreprocessUrl(){return Us.PreprocessUrl}static set PreprocessUrl(e){Us.PreprocessUrl=e}static LoadImage(e,i,s,n,a,p){return f2(e,i,s,n,a,p)}static LoadFile(e,i,s,n,a,p){return gx(e,i,s,n,a,p)}static LoadFileAsync(e,i=!0){return new Promise((s,n)=>{gx(e,a=>{s(a)},void 0,void 0,i,(a,p)=>{n(p)})})}static LoadScript(e,i,s,n){if(typeof importScripts=="function"){try{importScripts(e),i()}catch(_){s?.(`Unable to load script '${e}' in worker`,_)}return}else if(!Ts()){s?.(`Cannot load script '${e}' outside of a window or a worker`);return}const a=document.getElementsByTagName("head")[0],p=document.createElement("script");p.setAttribute("type","text/javascript"),p.setAttribute("src",e),n&&(p.id=n),p.onload=()=>{i&&i()},p.onerror=_=>{s&&s(`Unable to load script '${e}'`,_)},a.appendChild(p)}static LoadScriptAsync(e){return new Promise((i,s)=>{this.LoadScript(e,()=>{i()},(n,a)=>{s(a||new Error(n))})})}static ReadFileAsDataURL(e,i,s){const n=new FileReader,a={onCompleteObservable:new Re,abort:()=>n.abort()};return n.onloadend=()=>{a.onCompleteObservable.notifyObservers(a)},n.onload=p=>{i(p.target.result)},n.onprogress=s,n.readAsDataURL(e),a}static ReadFile(e,i,s,n,a){return Gh(e,i,s,n,a)}static FileAsURL(e){const i=new Blob([e]);return window.URL.createObjectURL(i)}static Format(e,i=2){return e.toFixed(i)}static DeepCopy(e,i,s,n){Ya.DeepCopy(e,i,s,n)}static IsEmpty(e){for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i))return!1;return!0}static RegisterTopRootEvents(e,i){for(let s=0;s<i.length;s++){const n=i[s];e.addEventListener(n.name,n.handler,!1);try{window.parent&&window.parent.addEventListener(n.name,n.handler,!1)}catch{}}}static UnregisterTopRootEvents(e,i){for(let s=0;s<i.length;s++){const n=i[s];e.removeEventListener(n.name,n.handler);try{e.parent&&e.parent.removeEventListener(n.name,n.handler)}catch{}}}static async DumpFramebuffer(e,i,s,n,a="image/png",p){throw xi("DumpTools")}static DumpData(e,i,s,n,a="image/png",p,_=!1,g=!1,y){throw xi("DumpTools")}static DumpDataAsync(e,i,s,n="image/png",a,p=!1,_=!1,g){throw xi("DumpTools")}static ToBlob(e,i,s="image/png",n){e.toBlob||(e.toBlob=function(a,p,_){setTimeout(()=>{const g=atob(this.toDataURL(p,_).split(",")[1]),y=g.length,b=new Uint8Array(y);for(let v=0;v<y;v++)b[v]=g.charCodeAt(v);a(new Blob([b]))})}),e.toBlob(function(a){i(a)},s,n)}static DownloadBlob(e,i){if("download"in document.createElement("a")){if(!i){const s=new Date,n=(s.getFullYear()+"-"+(s.getMonth()+1)).slice(2)+"-"+s.getDate()+"_"+s.getHours()+"-"+("0"+s.getMinutes()).slice(-2);i="screenshot_"+n+".png"}Le.Download(e,i)}else if(e&&typeof URL<"u"){const s=URL.createObjectURL(e),n=window.open("");if(!n)return;const a=n.document.createElement("img");a.onload=function(){URL.revokeObjectURL(s)},a.src=s,n.document.body.appendChild(a)}}static EncodeScreenshotCanvasData(e,i,s="image/png",n,a){if(i){const p=e.toDataURL(s,a);i(p)}else this.ToBlob(e,function(p){p&&Le.DownloadBlob(p,n)},s,a)}static Download(e,i){if(typeof URL>"u")return;const s=window.URL.createObjectURL(e),n=document.createElement("a");document.body.appendChild(n),n.style.display="none",n.href=s,n.download=i,n.addEventListener("click",()=>{n.parentElement&&n.parentElement.removeChild(n)}),n.click(),window.URL.revokeObjectURL(s)}static BackCompatCameraNoPreventDefault(e){return typeof e[0]=="boolean"?e[0]:typeof e[1]=="boolean"?e[1]:!1}static CreateScreenshot(e,i,s,n,a="image/png"){throw xi("ScreenshotTools")}static CreateScreenshotAsync(e,i,s,n="image/png"){throw xi("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(e,i,s,n,a="image/png",p=1,_=!1,g){throw xi("ScreenshotTools")}static CreateScreenshotUsingRenderTargetAsync(e,i,s,n="image/png",a=1,p=!1,_){throw xi("ScreenshotTools")}static RandomId(){return m2()}static IsBase64(e){return p2(e)}static DecodeBase64(e){return Wh(e)}static get errorsCount(){return Ie.errorsCount}static Log(e){Ie.Log(e)}static Warn(e){Ie.Warn(e)}static Error(e){Ie.Error(e)}static get LogCache(){return Ie.LogCache}static ClearLogCache(){Ie.ClearLogCache()}static set LogLevels(e){Ie.LogLevels=e}static set PerformanceLogLevel(e){if((e&Le.PerformanceUserMarkLogLevel)===Le.PerformanceUserMarkLogLevel){Le.StartPerformanceCounter=Le._StartUserMark,Le.EndPerformanceCounter=Le._EndUserMark;return}if((e&Le.PerformanceConsoleLogLevel)===Le.PerformanceConsoleLogLevel){Le.StartPerformanceCounter=Le._StartPerformanceConsole,Le.EndPerformanceCounter=Le._EndPerformanceConsole;return}Le.StartPerformanceCounter=Le._StartPerformanceCounterDisabled,Le.EndPerformanceCounter=Le._EndPerformanceCounterDisabled}static _StartPerformanceCounterDisabled(e,i){}static _EndPerformanceCounterDisabled(e,i){}static _StartUserMark(e,i=!0){if(!Le._Performance){if(!Ts())return;Le._Performance=window.performance}!i||!Le._Performance.mark||Le._Performance.mark(e+"-Begin")}static _EndUserMark(e,i=!0){!i||!Le._Performance.mark||(Le._Performance.mark(e+"-End"),Le._Performance.measure(e,e+"-Begin",e+"-End"))}static _StartPerformanceConsole(e,i=!0){!i||(Le._StartUserMark(e,i),console.time&&console.time(e))}static _EndPerformanceConsole(e,i=!0){!i||(Le._EndUserMark(e,i),console.timeEnd(e))}static get Now(){return na.Now}static GetClassName(e,i=!1){let s=null;return!i&&e.getClassName?s=e.getClassName():(e instanceof Object&&(s=(i?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),s||(s=typeof e)),s}static First(e,i){for(const s of e)if(i(s))return s;return null}static getFullClassName(e,i=!1){let s=null,n=null;if(!i&&e.getClassName)s=e.getClassName();else{if(e instanceof Object){const a=i?e:Object.getPrototypeOf(e);s=a.constructor.__bjsclassName__,n=a.constructor.__bjsmoduleName__}s||(s=typeof e)}return s?(n!=null?n+".":"")+s:null}static DelayAsync(e){return new Promise(i=>{setTimeout(()=>{i()},e)})}static IsSafari(){return zm()?/^((?!chrome|android).)*safari/i.test(navigator.userAgent):!1}}Le.UseCustomRequestHeaders=!1,Le.CustomRequestHeaders=en.CustomRequestHeaders,Le._TmpFloatArray=new Float32Array(1),Le.GetDOMTextContent=Hm,Le.GetAbsoluteUrl=typeof document=="object"?l=>{const e=document.createElement("a");return e.href=l,e.href}:typeof URL=="function"&&typeof location=="object"?l=>new URL(l,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")},Le.NoneLogLevel=Ie.NoneLogLevel,Le.MessageLogLevel=Ie.MessageLogLevel,Le.WarningLogLevel=Ie.WarningLogLevel,Le.ErrorLogLevel=Ie.ErrorLogLevel,Le.AllLogLevel=Ie.AllLogLevel,Le.IsWindowObjectExist=Ts,Le.PerformanceNoneLogLevel=0,Le.PerformanceUserMarkLogLevel=1,Le.PerformanceConsoleLogLevel=2,Le.StartPerformanceCounter=Le._StartPerformanceCounterDisabled,Le.EndPerformanceCounter=Le._EndPerformanceCounterDisabled;function SY(l,e){return i=>{i.__bjsclassName__=l,i.__bjsmoduleName__=e??null}}class _2{constructor(e,i,s,n=0){this.iterations=e,this.index=n-1,this._done=!1,this._fn=i,this._successCallback=s}executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}breakLoop(){this._done=!0,this._successCallback()}static Run(e,i,s,n=0){const a=new _2(e,i,s,n);return a.executeNext(),a}static SyncAsyncForLoop(e,i,s,n,a,p=0){return _2.Run(Math.ceil(e/i),_=>{a&&a()?_.breakLoop():setTimeout(()=>{for(let g=0;g<i;++g){const y=_.index*i+g;if(y>=e)break;if(s(y),a&&a()){_.breakLoop();break}}_.executeNext()},p)},n)}}Zt.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";class Ps{constructor(e){this.length=0,this.data=new Array(e),this._id=Ps._GlobalId++}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let i=0;i<this.length;i++)e(this.data[i])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let i=0;i<e.length;i++)this.data[this.length++]=(e.data||e)[i]}}indexOf(e){const i=this.data.indexOf(e);return i>=this.length?-1:i}contains(e){return this.indexOf(e)!==-1}}Ps._GlobalId=0;class dl extends Ps{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId?!1:(this.push(e),!0)}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let i=0;i<e.length;i++){const s=(e.data||e)[i];this.pushNoDuplicate(s)}}}}class gE{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach((i,s)=>this.add(i,s))}get(e){const i=this._data[e];if(i!==void 0)return i}getOrAddWithFactory(e,i){let s=this.get(e);return s!==void 0||(s=i(e),s&&this.add(e,s)),s}getOrAdd(e,i){const s=this.get(e);return s!==void 0?s:(this.add(e,i),i)}contains(e){return this._data[e]!==void 0}add(e,i){return this._data[e]!==void 0?!1:(this._data[e]=i,++this._count,!0)}set(e,i){return this._data[e]===void 0?!1:(this._data[e]=i,!0)}getAndRemove(e){const i=this.get(e);return i!==void 0?(delete this._data[e],--this._count,i):null}remove(e){return this.contains(e)?(delete this._data[e],--this._count,!0):!1}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(const i in this._data){const s=this._data[i];e(i,s)}}first(e){for(const i in this._data){const s=this._data[i],n=e(i,s);if(n)return n}return null}}class fl{static Eval(e,i){return e.match(/\([^()]*\)/g)?e=e.replace(/\([^()]*\)/g,s=>(s=s.slice(1,s.length-1),fl._HandleParenthesisContent(s,i))):e=fl._HandleParenthesisContent(e,i),e==="true"?!0:e==="false"?!1:fl.Eval(e,i)}static _HandleParenthesisContent(e,i){i=i||(a=>a==="true");let s;const n=e.split("||");for(const a in n)if(Object.prototype.hasOwnProperty.call(n,a)){let p=fl._SimplifyNegation(n[a].trim());const _=p.split("&&");if(_.length>1)for(let g=0;g<_.length;++g){const y=fl._SimplifyNegation(_[g].trim());if(y!=="true"&&y!=="false"?y[0]==="!"?s=!i(y.substring(1)):s=i(y):s=y==="true",!s){p="false";break}}if(s||p==="true"){s=!0;break}p!=="true"&&p!=="false"?p[0]==="!"?s=!i(p.substring(1)):s=i(p):s=p==="true"}return s?"true":"false"}static _SimplifyNegation(e){return e=e.replace(/^[\s!]+/,i=>(i=i.replace(/[\s]/g,()=>""),i.length%2?"!":"")),e=e.trim(),e==="!true"?e="false":e==="!false"&&(e="true"),e}}class Bi{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>Bi.HasTags(e),e.addTags=i=>Bi.AddTagsTo(e,i),e.removeTags=i=>Bi.RemoveTagsFrom(e,i),e.matchesTagsQuery=i=>Bi.MatchesQuery(e,i)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;const i=e._tags;for(const s in i)if(Object.prototype.hasOwnProperty.call(i,s))return!0;return!1}static GetTags(e,i=!0){if(!e._tags)return null;if(i){const s=[];for(const n in e._tags)Object.prototype.hasOwnProperty.call(e._tags,n)&&e._tags[n]===!0&&s.push(n);return s.join(" ")}else return e._tags}static AddTagsTo(e,i){if(!i||typeof i!="string")return;i.split(" ").forEach(function(n){Bi._AddTagTo(e,n)})}static _AddTagTo(e,i){i=i.trim(),!(i===""||i==="true"||i==="false")&&(i.match(/[\s]/)||i.match(/^([!]|([|]|[&]){2})/)||(Bi.EnableFor(e),e._tags[i]=!0))}static RemoveTagsFrom(e,i){if(!Bi.HasTags(e))return;const s=i.split(" ");for(const n in s)Bi._RemoveTagFrom(e,s[n])}static _RemoveTagFrom(e,i){delete e._tags[i]}static MatchesQuery(e,i){return i===void 0?!0:i===""?Bi.HasTags(e):fl.Eval(i,s=>Bi.HasTags(e)&&e._tags[s])}}class at{static WithinEpsilon(e,i,s=1401298e-51){return Math.abs(e-i)<=s}static ToHex(e){const i=e.toString(16);return e<=15?("0"+i).toUpperCase():i.toUpperCase()}static Sign(e){return e=+e,e===0||isNaN(e)?e:e>0?1:-1}static Clamp(e,i=0,s=1){return Math.min(s,Math.max(i,e))}static Log2(e){return Math.log(e)*Math.LOG2E}static ILog2(e){if(Math.log2)return Math.floor(Math.log2(e));if(e<0)return NaN;if(e===0)return-1/0;let i=0;if(e<1){for(;e<1;)i++,e=e*2;i=-i}else if(e>1)for(;e>1;)i++,e=Math.floor(e/2);return i}static Repeat(e,i){return e-Math.floor(e/i)*i}static Normalize(e,i,s){return(e-i)/(s-i)}static Denormalize(e,i,s){return e*(s-i)+i}static DeltaAngle(e,i){let s=at.Repeat(i-e,360);return s>180&&(s-=360),s}static PingPong(e,i){const s=at.Repeat(e,i*2);return i-Math.abs(s-i)}static SmoothStep(e,i,s){let n=at.Clamp(s);return n=-2*n*n*n+3*n*n,i*n+e*(1-n)}static MoveTowards(e,i,s){let n=0;return Math.abs(i-e)<=s?n=i:n=e+at.Sign(i-e)*s,n}static MoveTowardsAngle(e,i,s){const n=at.DeltaAngle(e,i);let a=0;return-s<n&&n<s?a=i:(i=e+n,a=at.MoveTowards(e,i,s)),a}static Lerp(e,i,s){return e+(i-e)*s}static LerpAngle(e,i,s){let n=at.Repeat(i-e,360);return n>180&&(n-=360),e+n*at.Clamp(s)}static InverseLerp(e,i,s){let n=0;return e!=i?n=at.Clamp((s-e)/(i-e)):n=0,n}static Hermite(e,i,s,n,a){const p=a*a,_=a*p,g=2*_-3*p+1,y=-2*_+3*p,b=_-2*p+a,v=_-p;return e*g+s*y+i*b+n*v}static Hermite1stDerivative(e,i,s,n,a){const p=a*a;return(p-a)*6*e+(3*p-4*a+1)*i+(-p+a)*6*s+(3*p-2*a)*n}static RandomRange(e,i){return e===i?e:Math.random()*(i-e)+e}static RangeToPercent(e,i,s){return(e-i)/(s-i)}static PercentToRange(e,i,s){return(s-i)*e+i}static NormalizeRadians(e){return e-=at.TwoPi*Math.floor((e+Math.PI)/at.TwoPi),e}static HCF(e,i){const s=e%i;return s===0?i:at.HCF(i,s)}}at.TwoPi=Math.PI*2;const C9=1/2.2,g2=2.2,MY=(1+Math.sqrt(5))/2,rr=.001;class As{static BuildArray(e,i){const s=[];for(let n=0;n<e;++n)s.push(i());return s}static BuildTuple(e,i){return As.BuildArray(e,i)}}function R9(l,e,i){const s=l[e];if(typeof s!="function")return null;const n=function(){const a=l.length,p=n.previous.apply(l,arguments);return i(e,a),p};return s.next=n,n.previous=s,l[e]=n,()=>{const a=n.previous;if(!a)return;const p=n.next;p?(a.next=p,p.previous=a):(a.next=void 0,l[e]=a),n.next=void 0,n.previous=void 0}}const I9=["push","splice","pop","shift","unshift"];function yE(l,e){const i=I9.map(s=>R9(l,s,e));return()=>{i.forEach(s=>{s?.()})}}const Un=l=>parseInt(l.toString().replace(/\W/g,""));class ii{constructor(e=0,i=0){this.x=e,this.y=i}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return"Vector2"}getHashCode(){const e=Un(this.x),i=Un(this.y);let s=e;return s=s*397^i,s}toArray(e,i=0){return e[i]=this.x,e[i+1]=this.y,this}fromArray(e,i=0){return ii.FromArrayToRef(e,i,this),this}asArray(){const e=new Array;return this.toArray(e,0),e}copyFrom(e){return this.x=e.x,this.y=e.y,this}copyFromFloats(e,i){return this.x=e,this.y=i,this}set(e,i){return this.copyFromFloats(e,i)}add(e){return new this.constructor(this.x+e.x,this.y+e.y)}addToRef(e,i){return i.x=this.x+e.x,i.y=this.y+e.y,i}addInPlace(e){return this.x+=e.x,this.y+=e.y,this}addVector3(e){return new this.constructor(this.x+e.x,this.y+e.y)}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y)}subtractToRef(e,i){return i.x=this.x-e.x,i.y=this.y-e.y,i}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y)}multiplyToRef(e,i){return i.x=this.x*e.x,i.y=this.y*e.y,i}multiplyByFloats(e,i){return new this.constructor(this.x*e,this.y*i)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y)}divideToRef(e,i){return i.x=this.x/e.x,i.y=this.y/e.y,i}divideInPlace(e){return this.divideToRef(e,this)}negate(){return new this.constructor(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(e){return e.copyFromFloats(this.x*-1,this.y*-1)}scaleInPlace(e){return this.x*=e,this.y*=e,this}scale(e){const i=new this.constructor(0,0);return this.scaleToRef(e,i),i}scaleToRef(e,i){return i.x=this.x*e,i.y=this.y*e,i}scaleAndAddToRef(e,i){return i.x+=this.x*e,i.y+=this.y*e,i}equals(e){return e&&this.x===e.x&&this.y===e.y}equalsWithEpsilon(e,i=rr){return e&&at.WithinEpsilon(this.x,e.x,i)&&at.WithinEpsilon(this.y,e.y,i)}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}rotateToRef(e,i){const s=Math.cos(e),n=Math.sin(e),a=s*this.x-n*this.y,p=n*this.x+s*this.y;return i.x=a,i.y=p,i}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return ii.NormalizeToRef(this,this),this}clone(){return new this.constructor(this.x,this.y)}static Zero(){return new ii(0,0)}static One(){return new ii(1,1)}static Random(e=0,i=1){return new ii(at.RandomRange(e,i),at.RandomRange(e,i))}static get ZeroReadOnly(){return ii._ZeroReadOnly}static FromArray(e,i=0){return new ii(e[i],e[i+1])}static FromArrayToRef(e,i,s){return s.x=e[i],s.y=e[i+1],s}static CatmullRom(e,i,s,n,a){const p=a*a,_=a*p,g=.5*(2*i.x+(-e.x+s.x)*a+(2*e.x-5*i.x+4*s.x-n.x)*p+(-e.x+3*i.x-3*s.x+n.x)*_),y=.5*(2*i.y+(-e.y+s.y)*a+(2*e.y-5*i.y+4*s.y-n.y)*p+(-e.y+3*i.y-3*s.y+n.y)*_);return new e.constructor(g,y)}static Clamp(e,i,s){let n=e.x;n=n>s.x?s.x:n,n=n<i.x?i.x:n;let a=e.y;return a=a>s.y?s.y:a,a=a<i.y?i.y:a,new e.constructor(n,a)}static Hermite(e,i,s,n,a){const p=a*a,_=a*p,g=2*_-3*p+1,y=-2*_+3*p,b=_-2*p+a,v=_-p,S=e.x*g+s.x*y+i.x*b+n.x*v,M=e.y*g+s.y*y+i.y*b+n.y*v;return new e.constructor(S,M)}static Hermite1stDerivative(e,i,s,n,a){const p=new e.constructor;return this.Hermite1stDerivativeToRef(e,i,s,n,a,p),p}static Hermite1stDerivativeToRef(e,i,s,n,a,p){const _=a*a;return p.x=(_-a)*6*e.x+(3*_-4*a+1)*i.x+(-_+a)*6*s.x+(3*_-2*a)*n.x,p.y=(_-a)*6*e.y+(3*_-4*a+1)*i.y+(-_+a)*6*s.y+(3*_-2*a)*n.y,p}static Lerp(e,i,s){const n=e.x+(i.x-e.x)*s,a=e.y+(i.y-e.y)*s;return new e.constructor(n,a)}static Dot(e,i){return e.x*i.x+e.y*i.y}static Normalize(e){const i=new e.constructor;return this.NormalizeToRef(e,i),i}static NormalizeToRef(e,i){const s=e.length();return s===0||(i.x=e.x/s,i.y=e.y/s),i}static Minimize(e,i){const s=e.x<i.x?e.x:i.x,n=e.y<i.y?e.y:i.y;return new e.constructor(s,n)}static Maximize(e,i){const s=e.x>i.x?e.x:i.x,n=e.y>i.y?e.y:i.y;return new e.constructor(s,n)}static Transform(e,i){const s=new e.constructor;return ii.TransformToRef(e,i,s),s}static TransformToRef(e,i,s){const n=i.m,a=e.x*n[0]+e.y*n[4]+n[12],p=e.x*n[1]+e.y*n[5]+n[13];return s.x=a,s.y=p,s}static PointInTriangle(e,i,s,n){const a=.5*(-s.y*n.x+i.y*(-s.x+n.x)+i.x*(s.y-n.y)+s.x*n.y),p=a<0?-1:1,_=(i.y*n.x-i.x*n.y+(n.y-i.y)*e.x+(i.x-n.x)*e.y)*p,g=(i.x*s.y-i.y*s.x+(i.y-s.y)*e.x+(s.x-i.x)*e.y)*p;return _>0&&g>0&&_+g<2*a*p}static Distance(e,i){return Math.sqrt(ii.DistanceSquared(e,i))}static DistanceSquared(e,i){const s=e.x-i.x,n=e.y-i.y;return s*s+n*n}static Center(e,i){const s=new e.constructor;return ii.CenterToRef(e,i,s)}static CenterToRef(e,i,s){return s.copyFromFloats((e.x+i.x)/2,(e.y+i.y)/2)}static DistanceOfPointFromSegment(e,i,s){const n=ii.DistanceSquared(i,s);if(n===0)return ii.Distance(e,i);const a=s.subtract(i),p=Math.max(0,Math.min(1,ii.Dot(e.subtract(i),a)/n)),_=i.add(a.multiplyByFloats(p,p));return ii.Distance(e,_)}}ii._ZeroReadOnly=ii.Zero();class j{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}constructor(e=0,i=0,s=0){this._isDirty=!0,this._x=e,this._y=i,this._z=s}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return"Vector3"}getHashCode(){const e=Un(this._x),i=Un(this._y),s=Un(this._z);let n=e;return n=n*397^i,n=n*397^s,n}asArray(){const e=[];return this.toArray(e,0),e}toArray(e,i=0){return e[i]=this._x,e[i+1]=this._y,e[i+2]=this._z,this}fromArray(e,i=0){return j.FromArrayToRef(e,i,this),this}toQuaternion(){return Ve.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(e){return this.addInPlaceFromFloats(e._x,e._y,e._z)}addInPlaceFromFloats(e,i,s){return this._x+=e,this._y+=i,this._z+=s,this._isDirty=!0,this}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z)}addToRef(e,i){return i.copyFromFloats(this._x+e._x,this._y+e._y,this._z+e._z)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z)}subtractToRef(e,i){return this.subtractFromFloatsToRef(e._x,e._y,e._z,i)}subtractFromFloats(e,i,s){return new this.constructor(this._x-e,this._y-i,this._z-s)}subtractFromFloatsToRef(e,i,s,n){return n.copyFromFloats(this._x-e,this._y-i,this._z-s)}negate(){return new this.constructor(-this._x,-this._y,-this._z)}negateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}negateToRef(e){return e.copyFromFloats(this._x*-1,this._y*-1,this._z*-1)}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e)}scaleToRef(e,i){return i.copyFromFloats(this._x*e,this._y*e,this._z*e)}getNormalToRef(e){const i=this.length();let s=Math.acos(this.y/i);const n=Math.atan2(this.z,this.x);s>Math.PI/2?s-=Math.PI/2:s+=Math.PI/2;const a=i*Math.sin(s)*Math.cos(n),p=i*Math.cos(s),_=i*Math.sin(s)*Math.sin(n);return e.set(a,p,_),e}applyRotationQuaternionToRef(e,i){const s=e._w*this._x+e._y*this._z-e._z*this._y,n=e._w*this._y+e._z*this._x-e._x*this._z,a=e._w*this._z+e._x*this._y-e._y*this._x,p=-e._x*this._x-e._y*this._y-e._z*this._z;return i._x=s*e._w+p*-e._x+n*-e._z-a*-e._y,i._y=n*e._w+p*-e._y+a*-e._x-s*-e._z,i._z=a*e._w+p*-e._z+s*-e._y-n*-e._x,i._isDirty=!0,i}applyRotationQuaternionInPlace(e){return this.applyRotationQuaternionToRef(e,this)}applyRotationQuaternion(e){return this.applyRotationQuaternionToRef(e,new this.constructor)}scaleAndAddToRef(e,i){return i.addInPlaceFromFloats(this._x*e,this._y*e,this._z*e)}projectOnPlane(e,i){const s=new this.constructor;return this.projectOnPlaneToRef(e,i,s),s}projectOnPlaneToRef(e,i,s){const n=e.normal,a=e.d,p=zt.Vector3[0];this.subtractToRef(i,p),p.normalize();const _=j.Dot(p,n);if(Math.abs(_)<Math.pow(10,-10))s.setAll(1/0);else{const g=-(j.Dot(i,n)+a)/_,y=p.scaleInPlace(g);i.addToRef(y,s)}return s}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}equalsWithEpsilon(e,i=rr){return e&&at.WithinEpsilon(this._x,e._x,i)&&at.WithinEpsilon(this._y,e._y,i)&&at.WithinEpsilon(this._z,e._z,i)}equalsToFloats(e,i,s){return this._x===e&&this._y===i&&this._z===s}multiplyInPlace(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._isDirty=!0,this}multiply(e){return this.multiplyByFloats(e._x,e._y,e._z)}multiplyToRef(e,i){return i.copyFromFloats(this._x*e._x,this._y*e._y,this._z*e._z)}multiplyByFloats(e,i,s){return new this.constructor(this._x*e,this._y*i,this._z*s)}divide(e){return new this.constructor(this._x/e._x,this._y/e._y,this._z/e._z)}divideToRef(e,i){return i.copyFromFloats(this._x/e._x,this._y/e._y,this._z/e._z)}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}minimizeInPlaceFromFloats(e,i,s){return e<this._x&&(this.x=e),i<this._y&&(this.y=i),s<this._z&&(this.z=s),this}maximizeInPlaceFromFloats(e,i,s){return e>this._x&&(this.x=e),i>this._y&&(this.y=i),s>this._z&&(this.z=s),this}isNonUniformWithinEpsilon(e){const i=Math.abs(this._x),s=Math.abs(this._y);if(!at.WithinEpsilon(i,s,e))return!0;const n=Math.abs(this._z);return!at.WithinEpsilon(i,n,e)||!at.WithinEpsilon(s,n,e)}get isNonUniform(){const e=Math.abs(this._x),i=Math.abs(this._y);if(e!==i)return!0;const s=Math.abs(this._z);return e!==s}floor(){return new this.constructor(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))}fract(){return new this.constructor(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z===0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(e){return e=e.toLowerCase(),e==="xyz"?this:(zt.Vector3[0].copyFrom(this),["x","y","z"].forEach((i,s)=>{this[i]=zt.Vector3[0][e[s]]}),this)}rotateByQuaternionToRef(e,i){return e.toRotationMatrix(zt.Matrix[0]),j.TransformCoordinatesToRef(this,zt.Matrix[0],i),i}rotateByQuaternionAroundPointToRef(e,i,s){return this.subtractToRef(i,zt.Vector3[0]),zt.Vector3[0].rotateByQuaternionToRef(e,zt.Vector3[0]),i.addToRef(zt.Vector3[0],s),s}cross(e){const i=new this.constructor;return j.CrossToRef(this,e,i)}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new this.constructor(0,0,0);return this.normalizeToRef(e),e}normalizeToRef(e){const i=this.length();return i===0||i===1?e.copyFromFloats(this._x,this._y,this._z):this.scaleToRef(1/i,e)}clone(){return new this.constructor(this._x,this._y,this._z)}copyFrom(e){return this.copyFromFloats(e._x,e._y,e._z)}copyFromFloats(e,i,s){return this._x=e,this._y=i,this._z=s,this._isDirty=!0,this}set(e,i,s){return this.copyFromFloats(e,i,s)}setAll(e){return this._x=this._y=this._z=e,this._isDirty=!0,this}static GetClipFactor(e,i,s,n){const a=j.Dot(e,s)-n,p=j.Dot(i,s)-n;return a/(a-p)}static GetAngleBetweenVectors(e,i,s){const n=e.normalizeToRef(zt.Vector3[1]),a=i.normalizeToRef(zt.Vector3[2]);let p=j.Dot(n,a);p=at.Clamp(p,-1,1);const _=Math.acos(p),g=zt.Vector3[3];return j.CrossToRef(n,a,g),j.Dot(g,s)>0?isNaN(_)?0:_:isNaN(_)?-Math.PI:-Math.acos(p)}static GetAngleBetweenVectorsOnPlane(e,i,s){zt.Vector3[0].copyFrom(e);const n=zt.Vector3[0];zt.Vector3[1].copyFrom(i);const a=zt.Vector3[1];zt.Vector3[2].copyFrom(s);const p=zt.Vector3[2],_=zt.Vector3[3],g=zt.Vector3[4];n.normalize(),a.normalize(),p.normalize(),j.CrossToRef(p,n,_),j.CrossToRef(_,p,g);const y=Math.atan2(j.Dot(a,_),j.Dot(a,g));return at.NormalizeRadians(y)}static PitchYawRollToMoveBetweenPointsToRef(e,i,s){const n=ge.Vector3[0];return i.subtractToRef(e,n),s._y=Math.atan2(n.x,n.z)||0,s._x=Math.atan2(Math.sqrt(n.x**2+n.z**2),n.y)||0,s._z=0,s._isDirty=!0,s}static PitchYawRollToMoveBetweenPoints(e,i){const s=j.Zero();return j.PitchYawRollToMoveBetweenPointsToRef(e,i,s)}static SlerpToRef(e,i,s,n){s=at.Clamp(s,0,1);const a=zt.Vector3[0],p=zt.Vector3[1];a.copyFrom(e);const _=a.length();a.normalizeFromLength(_),p.copyFrom(i);const g=p.length();p.normalizeFromLength(g);const y=j.Dot(a,p);let b,v;if(y<1-rr){const S=Math.acos(y),M=1/Math.sin(S);b=Math.sin((1-s)*S)*M,v=Math.sin(s*S)*M}else b=1-s,v=s;return a.scaleInPlace(b),p.scaleInPlace(v),n.copyFrom(a).addInPlace(p),n.scaleInPlace(at.Lerp(_,g,s)),n}static SmoothToRef(e,i,s,n,a){return j.SlerpToRef(e,i,n===0?1:s/n,a),a}static FromArray(e,i=0){return new j(e[i],e[i+1],e[i+2])}static FromFloatArray(e,i){return j.FromArray(e,i)}static FromArrayToRef(e,i,s){return s._x=e[i],s._y=e[i+1],s._z=e[i+2],s._isDirty=!0,s}static FromFloatArrayToRef(e,i,s){return j.FromArrayToRef(e,i,s)}static FromFloatsToRef(e,i,s,n){return n.copyFromFloats(e,i,s),n}static Zero(){return new j(0,0,0)}static One(){return new j(1,1,1)}static Up(){return new j(0,1,0)}static get UpReadOnly(){return j._UpReadOnly}static get DownReadOnly(){return j._DownReadOnly}static get RightReadOnly(){return j._RightReadOnly}static get LeftReadOnly(){return j._LeftReadOnly}static get LeftHandedForwardReadOnly(){return j._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return j._RightHandedForwardReadOnly}static get LeftHandedBackwardReadOnly(){return j._LeftHandedBackwardReadOnly}static get RightHandedBackwardReadOnly(){return j._RightHandedBackwardReadOnly}static get ZeroReadOnly(){return j._ZeroReadOnly}static Down(){return new j(0,-1,0)}static Forward(e=!1){return new j(0,0,e?-1:1)}static Backward(e=!1){return new j(0,0,e?1:-1)}static Right(){return new j(1,0,0)}static Left(){return new j(-1,0,0)}static Random(e=0,i=1){return new j(at.RandomRange(e,i),at.RandomRange(e,i),at.RandomRange(e,i))}static TransformCoordinates(e,i){const s=j.Zero();return j.TransformCoordinatesToRef(e,i,s),s}static TransformCoordinatesToRef(e,i,s){return j.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,i,s),s}static TransformCoordinatesFromFloatsToRef(e,i,s,n,a){const p=n.m,_=e*p[0]+i*p[4]+s*p[8]+p[12],g=e*p[1]+i*p[5]+s*p[9]+p[13],y=e*p[2]+i*p[6]+s*p[10]+p[14],b=1/(e*p[3]+i*p[7]+s*p[11]+p[15]);return a._x=_*b,a._y=g*b,a._z=y*b,a._isDirty=!0,a}static TransformNormal(e,i){const s=j.Zero();return j.TransformNormalToRef(e,i,s),s}static TransformNormalToRef(e,i,s){return this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,i,s),s}static TransformNormalFromFloatsToRef(e,i,s,n,a){const p=n.m;return a._x=e*p[0]+i*p[4]+s*p[8],a._y=e*p[1]+i*p[5]+s*p[9],a._z=e*p[2]+i*p[6]+s*p[10],a._isDirty=!0,a}static CatmullRom(e,i,s,n,a){const p=a*a,_=a*p,g=.5*(2*i._x+(-e._x+s._x)*a+(2*e._x-5*i._x+4*s._x-n._x)*p+(-e._x+3*i._x-3*s._x+n._x)*_),y=.5*(2*i._y+(-e._y+s._y)*a+(2*e._y-5*i._y+4*s._y-n._y)*p+(-e._y+3*i._y-3*s._y+n._y)*_),b=.5*(2*i._z+(-e._z+s._z)*a+(2*e._z-5*i._z+4*s._z-n._z)*p+(-e._z+3*i._z-3*s._z+n._z)*_);return new e.constructor(g,y,b)}static Clamp(e,i,s){const n=new e.constructor;return j.ClampToRef(e,i,s,n),n}static ClampToRef(e,i,s,n){let a=e._x;a=a>s._x?s._x:a,a=a<i._x?i._x:a;let p=e._y;p=p>s._y?s._y:p,p=p<i._y?i._y:p;let _=e._z;return _=_>s._z?s._z:_,_=_<i._z?i._z:_,n.copyFromFloats(a,p,_),n}static CheckExtends(e,i,s){i.minimizeInPlace(e),s.maximizeInPlace(e)}static Hermite(e,i,s,n,a){const p=a*a,_=a*p,g=2*_-3*p+1,y=-2*_+3*p,b=_-2*p+a,v=_-p,S=e._x*g+s._x*y+i._x*b+n._x*v,M=e._y*g+s._y*y+i._y*b+n._y*v,F=e._z*g+s._z*y+i._z*b+n._z*v;return new e.constructor(S,M,F)}static Hermite1stDerivative(e,i,s,n,a){const p=new e.constructor;return this.Hermite1stDerivativeToRef(e,i,s,n,a,p),p}static Hermite1stDerivativeToRef(e,i,s,n,a,p){const _=a*a;return p._x=(_-a)*6*e._x+(3*_-4*a+1)*i._x+(-_+a)*6*s._x+(3*_-2*a)*n._x,p._y=(_-a)*6*e._y+(3*_-4*a+1)*i._y+(-_+a)*6*s._y+(3*_-2*a)*n._y,p._z=(_-a)*6*e._z+(3*_-4*a+1)*i._z+(-_+a)*6*s._z+(3*_-2*a)*n._z,p._isDirty=!0,p}static Lerp(e,i,s){const n=new e.constructor(0,0,0);return j.LerpToRef(e,i,s,n),n}static LerpToRef(e,i,s,n){return n._x=e._x+(i._x-e._x)*s,n._y=e._y+(i._y-e._y)*s,n._z=e._z+(i._z-e._z)*s,n._isDirty=!0,n}static Dot(e,i){return e._x*i._x+e._y*i._y+e._z*i._z}static Cross(e,i){const s=new e.constructor;return j.CrossToRef(e,i,s),s}static CrossToRef(e,i,s){const n=e._y*i._z-e._z*i._y,a=e._z*i._x-e._x*i._z,p=e._x*i._y-e._y*i._x;return s.copyFromFloats(n,a,p),s}static Normalize(e){const i=j.Zero();return j.NormalizeToRef(e,i),i}static NormalizeToRef(e,i){return e.normalizeToRef(i),i}static Project(e,i,s,n){const a=new e.constructor;return j.ProjectToRef(e,i,s,n,a),a}static ProjectToRef(e,i,s,n,a){const p=n.width,_=n.height,g=n.x,y=n.y,b=zt.Matrix[1];fe.FromValuesToRef(p/2,0,0,0,0,-_/2,0,0,0,0,.5,0,g+p/2,_/2+y,.5,1,b);const v=zt.Matrix[0];return i.multiplyToRef(s,v),v.multiplyToRef(b,v),j.TransformCoordinatesToRef(e,v,a),a}static Reflect(e,i){return this.ReflectToRef(e,i,new j)}static ReflectToRef(e,i,s){const n=ge.Vector3[0];return n.copyFrom(i).scaleInPlace(2*j.Dot(e,i)),s.copyFrom(e).subtractInPlace(n)}static _UnprojectFromInvertedMatrixToRef(e,i,s){j.TransformCoordinatesToRef(e,i,s);const n=i.m,a=e._x*n[3]+e._y*n[7]+e._z*n[11]+n[15];return at.WithinEpsilon(a,1)&&s.scaleInPlace(1/a),s}static UnprojectFromTransform(e,i,s,n,a){return this.Unproject(e,i,s,n,a,fe.IdentityReadOnly)}static Unproject(e,i,s,n,a,p){const _=new e.constructor;return j.UnprojectToRef(e,i,s,n,a,p,_),_}static UnprojectToRef(e,i,s,n,a,p,_){return j.UnprojectFloatsToRef(e._x,e._y,e._z,i,s,n,a,p,_),_}static UnprojectFloatsToRef(e,i,s,n,a,p,_,g,y){var b;const v=zt.Matrix[0];p.multiplyToRef(_,v),v.multiplyToRef(g,v),v.invert();const S=zt.Vector3[0];return S.x=e/n*2-1,S.y=-(i/a*2-1),!((b=Zt.LastCreatedEngine)===null||b===void 0)&&b.isNDCHalfZRange?S.z=s:S.z=2*s-1,j._UnprojectFromInvertedMatrixToRef(S,v,y),y}static Minimize(e,i){const s=new e.constructor;return s.copyFrom(e),s.minimizeInPlace(i),s}static Maximize(e,i){const s=new e.constructor;return s.copyFrom(e),s.maximizeInPlace(i),s}static Distance(e,i){return Math.sqrt(j.DistanceSquared(e,i))}static DistanceSquared(e,i){const s=e._x-i._x,n=e._y-i._y,a=e._z-i._z;return s*s+n*n+a*a}static ProjectOnTriangleToRef(e,i,s,n,a){const p=zt.Vector3[0],_=zt.Vector3[1],g=zt.Vector3[2],y=zt.Vector3[3],b=zt.Vector3[4];s.subtractToRef(i,p),n.subtractToRef(i,_),n.subtractToRef(s,g);const v=p.length(),S=_.length(),M=g.length();if(v<rr||S<rr||M<rr)return a.copyFrom(i),j.Distance(e,i);e.subtractToRef(i,b),j.CrossToRef(p,_,y);const F=y.length();if(F<rr)return a.copyFrom(i),j.Distance(e,i);y.normalizeFromLength(F);let L=b.length();if(L<rr)return a.copyFrom(i),0;b.normalizeFromLength(L);const N=j.Dot(y,b),k=zt.Vector3[5],G=zt.Vector3[6];k.copyFrom(y).scaleInPlace(-L*N),G.copyFrom(e).addInPlace(k);const H=zt.Vector3[4],z=zt.Vector3[5],W=zt.Vector3[7],Y=zt.Vector3[8];H.copyFrom(p).scaleInPlace(1/v),Y.copyFrom(_).scaleInPlace(1/S),H.addInPlace(Y).scaleInPlace(-1),z.copyFrom(p).scaleInPlace(-1/v),Y.copyFrom(g).scaleInPlace(1/M),z.addInPlace(Y).scaleInPlace(-1),W.copyFrom(g).scaleInPlace(-1/M),Y.copyFrom(_).scaleInPlace(-1/S),W.addInPlace(Y).scaleInPlace(-1);const Z=zt.Vector3[9];let Q;Z.copyFrom(G).subtractInPlace(i),j.CrossToRef(H,Z,Y),Q=j.Dot(Y,y);const se=Q;Z.copyFrom(G).subtractInPlace(s),j.CrossToRef(z,Z,Y),Q=j.Dot(Y,y);const $=Q;Z.copyFrom(G).subtractInPlace(n),j.CrossToRef(W,Z,Y),Q=j.Dot(Y,y);const oe=Q,ue=zt.Vector3[10];let de,ye;se>0&&$<0?(ue.copyFrom(p),de=i,ye=s):$>0&&oe<0?(ue.copyFrom(g),de=s,ye=n):(ue.copyFrom(_).scaleInPlace(-1),de=n,ye=i);const _e=zt.Vector3[9],we=zt.Vector3[4];if(de.subtractToRef(G,Y),ye.subtractToRef(G,_e),j.CrossToRef(Y,_e,we),!(j.Dot(we,y)<0))return a.copyFrom(G),Math.abs(L*N);const Ee=zt.Vector3[5];j.CrossToRef(ue,we,Ee),Ee.normalize();const We=zt.Vector3[9];We.copyFrom(de).subtractInPlace(G);const et=We.length();if(et<rr)return a.copyFrom(de),j.Distance(e,de);We.normalizeFromLength(et);const ke=j.Dot(Ee,We),$e=zt.Vector3[7];$e.copyFrom(G).addInPlace(Ee.scaleInPlace(et*ke)),Y.copyFrom($e).subtractInPlace(de),L=ue.length(),ue.normalizeFromLength(L);let pt=j.Dot(Y,ue)/Math.max(L,rr);return pt=at.Clamp(pt,0,1),$e.copyFrom(de).addInPlace(ue.scaleInPlace(pt*L)),a.copyFrom($e),j.Distance(e,$e)}static Center(e,i){return j.CenterToRef(e,i,j.Zero())}static CenterToRef(e,i,s){return s.copyFromFloats((e._x+i._x)/2,(e._y+i._y)/2,(e._z+i._z)/2)}static RotationFromAxis(e,i,s){const n=new e.constructor;return j.RotationFromAxisToRef(e,i,s,n),n}static RotationFromAxisToRef(e,i,s,n){const a=zt.Quaternion[0];return Ve.RotationQuaternionFromAxisToRef(e,i,s,a),a.toEulerAnglesToRef(n),n}}j._UpReadOnly=j.Up(),j._DownReadOnly=j.Down(),j._LeftHandedForwardReadOnly=j.Forward(!1),j._RightHandedForwardReadOnly=j.Forward(!0),j._LeftHandedBackwardReadOnly=j.Backward(!1),j._RightHandedBackwardReadOnly=j.Backward(!0),j._RightReadOnly=j.Right(),j._LeftReadOnly=j.Left(),j._ZeroReadOnly=j.Zero();class xr{constructor(e=0,i=0,s=0,n=0){this.x=e,this.y=i,this.z=s,this.w=n}toString(){return`{X: ${this.x} Y: ${this.y} Z: ${this.z} W: ${this.w}}`}getClassName(){return"Vector4"}getHashCode(){const e=Un(this.x),i=Un(this.y),s=Un(this.z),n=Un(this.w);let a=e;return a=a*397^i,a=a*397^s,a=a*397^n,a}asArray(){const e=new Array;return this.toArray(e,0),e}toArray(e,i){return i===void 0&&(i=0),e[i]=this.x,e[i+1]=this.y,e[i+2]=this.z,e[i+3]=this.w,this}fromArray(e,i=0){return xr.FromArrayToRef(e,i,this),this}addInPlace(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add(e){return new this.constructor(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addToRef(e,i){return i.x=this.x+e.x,i.y=this.y+e.y,i.z=this.z+e.z,i.w=this.w+e.w,i}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}subtractToRef(e,i){return i.x=this.x-e.x,i.y=this.y-e.y,i.z=this.z-e.z,i.w=this.w-e.w,i}subtractFromFloats(e,i,s,n){return new this.constructor(this.x-e,this.y-i,this.z-s,this.w-n)}subtractFromFloatsToRef(e,i,s,n,a){return a.x=this.x-e,a.y=this.y-i,a.z=this.z-s,a.w=this.w-n,a}negate(){return new this.constructor(-this.x,-this.y,-this.z,-this.w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(e){return e.copyFromFloats(this.x*-1,this.y*-1,this.z*-1,this.w*-1)}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scale(e){return new this.constructor(this.x*e,this.y*e,this.z*e,this.w*e)}scaleToRef(e,i){return i.x=this.x*e,i.y=this.y*e,i.z=this.z*e,i.w=this.w*e,i}scaleAndAddToRef(e,i){return i.x+=this.x*e,i.y+=this.y*e,i.z+=this.z*e,i.w+=this.w*e,i}equals(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsWithEpsilon(e,i=rr){return e&&at.WithinEpsilon(this.x,e.x,i)&&at.WithinEpsilon(this.y,e.y,i)&&at.WithinEpsilon(this.z,e.z,i)&&at.WithinEpsilon(this.w,e.w,i)}equalsToFloats(e,i,s,n){return this.x===e&&this.y===i&&this.z===s&&this.w===n}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)}multiplyToRef(e,i){return i.x=this.x*e.x,i.y=this.y*e.y,i.z=this.z*e.z,i.w=this.w*e.w,i}multiplyByFloats(e,i,s,n){return new this.constructor(this.x*e,this.y*i,this.z*s,this.w*n)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)}divideToRef(e,i){return i.x=this.x/e.x,i.y=this.y/e.y,i.z=this.z/e.z,i.w=this.w/e.w,i}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}maximizeInPlace(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}normalize(){const e=this.length();return e===0?this:this.scaleInPlace(1/e)}toVector3(){return new j(this.x,this.y,this.z)}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}copyFromFloats(e,i,s,n){return this.x=e,this.y=i,this.z=s,this.w=n,this}set(e,i,s,n){return this.copyFromFloats(e,i,s,n)}setAll(e){return this.x=this.y=this.z=this.w=e,this}static FromArray(e,i){return i||(i=0),new xr(e[i],e[i+1],e[i+2],e[i+3])}static FromArrayToRef(e,i,s){return s.x=e[i],s.y=e[i+1],s.z=e[i+2],s.w=e[i+3],s}static FromFloatArrayToRef(e,i,s){return xr.FromArrayToRef(e,i,s),s}static FromFloatsToRef(e,i,s,n,a){return a.x=e,a.y=i,a.z=s,a.w=n,a}static Zero(){return new xr(0,0,0,0)}static One(){return new xr(1,1,1,1)}static Random(e=0,i=1){return new xr(at.RandomRange(e,i),at.RandomRange(e,i),at.RandomRange(e,i),at.RandomRange(e,i))}static get ZeroReadOnly(){return xr._ZeroReadOnly}static Normalize(e){const i=xr.Zero();return xr.NormalizeToRef(e,i),i}static NormalizeToRef(e,i){return i.copyFrom(e),i.normalize(),i}static Minimize(e,i){const s=new e.constructor;return s.copyFrom(e),s.minimizeInPlace(i),s}static Maximize(e,i){const s=new e.constructor;return s.copyFrom(e),s.maximizeInPlace(i),s}static Distance(e,i){return Math.sqrt(xr.DistanceSquared(e,i))}static DistanceSquared(e,i){const s=e.x-i.x,n=e.y-i.y,a=e.z-i.z,p=e.w-i.w;return s*s+n*n+a*a+p*p}static Center(e,i){return xr.CenterToRef(e,i,xr.Zero())}static CenterToRef(e,i,s){return s.copyFromFloats((e.x+i.x)/2,(e.y+i.y)/2,(e.z+i.z)/2,(e.w+i.w)/2)}static TransformCoordinates(e,i){const s=xr.Zero();return xr.TransformCoordinatesToRef(e,i,s),s}static TransformCoordinatesToRef(e,i,s){return xr.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,i,s),s}static TransformCoordinatesFromFloatsToRef(e,i,s,n,a){const p=n.m,_=e*p[0]+i*p[4]+s*p[8]+p[12],g=e*p[1]+i*p[5]+s*p[9]+p[13],y=e*p[2]+i*p[6]+s*p[10]+p[14],b=e*p[3]+i*p[7]+s*p[11]+p[15];return a.x=_,a.y=g,a.z=y,a.w=b,a}static TransformNormal(e,i){const s=new e.constructor;return xr.TransformNormalToRef(e,i,s),s}static TransformNormalToRef(e,i,s){const n=i.m,a=e.x*n[0]+e.y*n[4]+e.z*n[8],p=e.x*n[1]+e.y*n[5]+e.z*n[9],_=e.x*n[2]+e.y*n[6]+e.z*n[10];return s.x=a,s.y=p,s.z=_,s.w=e.w,s}static TransformNormalFromFloatsToRef(e,i,s,n,a,p){const _=a.m;return p.x=e*_[0]+i*_[4]+s*_[8],p.y=e*_[1]+i*_[5]+s*_[9],p.z=e*_[2]+i*_[6]+s*_[10],p.w=n,p}static FromVector3(e,i=0){return new xr(e._x,e._y,e._z,i)}}xr._ZeroReadOnly=xr.Zero();class Ve{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}constructor(e=0,i=0,s=0,n=1){this._isDirty=!0,this._x=e,this._y=i,this._z=s,this._w=n}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Quaternion"}getHashCode(){const e=Un(this._x),i=Un(this._y),s=Un(this._z),n=Un(this._w);let a=e;return a=a*397^i,a=a*397^s,a=a*397^n,a}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,i=0){return e[i]=this._x,e[i+1]=this._y,e[i+2]=this._z,e[i+3]=this._w,this}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}equalsWithEpsilon(e,i=rr){return e&&at.WithinEpsilon(this._x,e._x,i)&&at.WithinEpsilon(this._y,e._y,i)&&at.WithinEpsilon(this._z,e._z,i)&&at.WithinEpsilon(this._w,e._w,i)}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copyFrom(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._w=e._w,this._isDirty=!0,this}copyFromFloats(e,i,s,n){return this._x=e,this._y=i,this._z=s,this._w=n,this._isDirty=!0,this}set(e,i,s,n){return this.copyFromFloats(e,i,s,n)}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,i){return i._x=this._x*e,i._y=this._y*e,i._z=this._z*e,i._w=this._w*e,i._isDirty=!0,i}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._isDirty=!0,this}scaleAndAddToRef(e,i){return i._x+=this._x*e,i._y+=this._y*e,i._z+=this._z*e,i._w+=this._w*e,i._isDirty=!0,i}multiply(e){const i=new this.constructor(0,0,0,1);return this.multiplyToRef(e,i),i}multiplyToRef(e,i){const s=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,n=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,a=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,p=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return i.copyFromFloats(s,n,a,p),i}multiplyInPlace(e){return this.multiplyToRef(e,this),this}conjugateToRef(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),e}conjugateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}conjugate(){return new this.constructor(-this._x,-this._y,-this._z,this._w)}invert(){const e=this.conjugate(),i=this.lengthSquared();return i==0||i==1||e.scaleInPlace(1/i),e}invertInPlace(){this.conjugateInPlace();const e=this.lengthSquared();return e==0||e==1?this:(this.scaleInPlace(1/e),this)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){const e=this.length();if(e===0)return this;const i=1/e;return this.scaleInPlace(i),this}normalizeToNew(){const e=this.length();if(e===0)return this.clone();const i=1/e;return this.scale(i)}toEulerAngles(){const e=j.Zero();return this.toEulerAnglesToRef(e),e}toEulerAnglesToRef(e){const i=this._z,s=this._x,n=this._y,a=this._w,p=n*i-s*a,_=.4999999;if(p<-_)e._y=2*Math.atan2(n,a),e._x=Math.PI/2,e._z=0,e._isDirty=!0;else if(p>_)e._y=2*Math.atan2(n,a),e._x=-Math.PI/2,e._z=0,e._isDirty=!0;else{const g=a*a,y=i*i,b=s*s,v=n*n;e._z=Math.atan2(2*(s*n+i*a),-y-b+v+g),e._x=Math.asin(-2*p),e._y=Math.atan2(2*(i*s+n*a),y-b-v+g),e._isDirty=!0}return e}toRotationMatrix(e){return fe.FromQuaternionToRef(this,e),e}fromRotationMatrix(e){return Ve.FromRotationMatrixToRef(e,this),this}static FromRotationMatrix(e){const i=new Ve;return Ve.FromRotationMatrixToRef(e,i),i}static FromRotationMatrixToRef(e,i){const s=e.m,n=s[0],a=s[4],p=s[8],_=s[1],g=s[5],y=s[9],b=s[2],v=s[6],S=s[10],M=n+g+S;let F;return M>0?(F=.5/Math.sqrt(M+1),i._w=.25/F,i._x=(v-y)*F,i._y=(p-b)*F,i._z=(_-a)*F,i._isDirty=!0):n>g&&n>S?(F=2*Math.sqrt(1+n-g-S),i._w=(v-y)/F,i._x=.25*F,i._y=(a+_)/F,i._z=(p+b)/F,i._isDirty=!0):g>S?(F=2*Math.sqrt(1+g-n-S),i._w=(p-b)/F,i._x=(a+_)/F,i._y=.25*F,i._z=(y+v)/F,i._isDirty=!0):(F=2*Math.sqrt(1+S-n-g),i._w=(_-a)/F,i._x=(p+b)/F,i._y=(y+v)/F,i._z=.25*F,i._isDirty=!0),i}static Dot(e,i){return e._x*i._x+e._y*i._y+e._z*i._z+e._w*i._w}static AreClose(e,i,s=.1){const n=Ve.Dot(e,i);return 1-n*n<=s}static SmoothToRef(e,i,s,n,a){let p=n===0?1:s/n;return p=at.Clamp(p,0,1),Ve.SlerpToRef(e,i,p,a),a}static Zero(){return new Ve(0,0,0,0)}static Inverse(e){return new e.constructor(-e._x,-e._y,-e._z,e._w)}static InverseToRef(e,i){return i.set(-e._x,-e._y,-e._z,e._w),i}static Identity(){return new Ve(0,0,0,1)}static IsIdentity(e){return e&&e._x===0&&e._y===0&&e._z===0&&e._w===1}static RotationAxis(e,i){return Ve.RotationAxisToRef(e,i,new Ve)}static RotationAxisToRef(e,i,s){const n=Math.sin(i/2);return e.normalize(),s._w=Math.cos(i/2),s._x=e._x*n,s._y=e._y*n,s._z=e._z*n,s._isDirty=!0,s}static FromArray(e,i){return i||(i=0),new Ve(e[i],e[i+1],e[i+2],e[i+3])}static FromArrayToRef(e,i,s){return s._x=e[i],s._y=e[i+1],s._z=e[i+2],s._w=e[i+3],s._isDirty=!0,s}static FromEulerAngles(e,i,s){const n=new Ve;return Ve.RotationYawPitchRollToRef(i,e,s,n),n}static FromEulerAnglesToRef(e,i,s,n){return Ve.RotationYawPitchRollToRef(i,e,s,n),n}static FromEulerVector(e){const i=new Ve;return Ve.RotationYawPitchRollToRef(e._y,e._x,e._z,i),i}static FromEulerVectorToRef(e,i){return Ve.RotationYawPitchRollToRef(e._y,e._x,e._z,i),i}static FromUnitVectorsToRef(e,i,s){const n=j.Dot(e,i)+1;return n<rr?Math.abs(e.x)>Math.abs(e.z)?s.set(-e.y,e.x,0,0):s.set(0,-e.z,e.y,0):(j.CrossToRef(e,i,ge.Vector3[0]),s.set(ge.Vector3[0].x,ge.Vector3[0].y,ge.Vector3[0].z,n)),s.normalize()}static RotationYawPitchRoll(e,i,s){const n=new Ve;return Ve.RotationYawPitchRollToRef(e,i,s,n),n}static RotationYawPitchRollToRef(e,i,s,n){const a=s*.5,p=i*.5,_=e*.5,g=Math.sin(a),y=Math.cos(a),b=Math.sin(p),v=Math.cos(p),S=Math.sin(_),M=Math.cos(_);return n._x=M*b*y+S*v*g,n._y=S*v*y-M*b*g,n._z=M*v*g-S*b*y,n._w=M*v*y+S*b*g,n._isDirty=!0,n}static RotationAlphaBetaGamma(e,i,s){const n=new Ve;return Ve.RotationAlphaBetaGammaToRef(e,i,s,n),n}static RotationAlphaBetaGammaToRef(e,i,s,n){const a=(s+e)*.5,p=(s-e)*.5,_=i*.5;return n._x=Math.cos(p)*Math.sin(_),n._y=Math.sin(p)*Math.sin(_),n._z=Math.sin(a)*Math.cos(_),n._w=Math.cos(a)*Math.cos(_),n._isDirty=!0,n}static RotationQuaternionFromAxis(e,i,s){const n=new Ve(0,0,0,0);return Ve.RotationQuaternionFromAxisToRef(e,i,s,n),n}static RotationQuaternionFromAxisToRef(e,i,s,n){const a=zt.Matrix[0];return fe.FromXYZAxesToRef(e.normalize(),i.normalize(),s.normalize(),a),Ve.FromRotationMatrixToRef(a,n),n}static FromLookDirectionLH(e,i){const s=new Ve;return Ve.FromLookDirectionLHToRef(e,i,s),s}static FromLookDirectionLHToRef(e,i,s){const n=zt.Matrix[0];return fe.LookDirectionLHToRef(e,i,n),Ve.FromRotationMatrixToRef(n,s),s}static FromLookDirectionRH(e,i){const s=new Ve;return Ve.FromLookDirectionRHToRef(e,i,s),s}static FromLookDirectionRHToRef(e,i,s){const n=zt.Matrix[0];return fe.LookDirectionRHToRef(e,i,n),Ve.FromRotationMatrixToRef(n,s)}static Slerp(e,i,s){const n=Ve.Identity();return Ve.SlerpToRef(e,i,s,n),n}static SlerpToRef(e,i,s,n){let a,p,_=e._x*i._x+e._y*i._y+e._z*i._z+e._w*i._w,g=!1;if(_<0&&(g=!0,_=-_),_>.999999)p=1-s,a=g?-s:s;else{const y=Math.acos(_),b=1/Math.sin(y);p=Math.sin((1-s)*y)*b,a=g?-Math.sin(s*y)*b:Math.sin(s*y)*b}return n._x=p*e._x+a*i._x,n._y=p*e._y+a*i._y,n._z=p*e._z+a*i._z,n._w=p*e._w+a*i._w,n._isDirty=!0,n}static Hermite(e,i,s,n,a){const p=a*a,_=a*p,g=2*_-3*p+1,y=-2*_+3*p,b=_-2*p+a,v=_-p,S=e._x*g+s._x*y+i._x*b+n._x*v,M=e._y*g+s._y*y+i._y*b+n._y*v,F=e._z*g+s._z*y+i._z*b+n._z*v,L=e._w*g+s._w*y+i._w*b+n._w*v;return new e.constructor(S,M,F,L)}static Hermite1stDerivative(e,i,s,n,a){const p=new e.constructor;return this.Hermite1stDerivativeToRef(e,i,s,n,a,p),p}static Hermite1stDerivativeToRef(e,i,s,n,a,p){const _=a*a;return p._x=(_-a)*6*e._x+(3*_-4*a+1)*i._x+(-_+a)*6*s._x+(3*_-2*a)*n._x,p._y=(_-a)*6*e._y+(3*_-4*a+1)*i._y+(-_+a)*6*s._y+(3*_-2*a)*n._y,p._z=(_-a)*6*e._z+(3*_-4*a+1)*i._z+(-_+a)*6*s._z+(3*_-2*a)*n._z,p._w=(_-a)*6*e._w+(3*_-4*a+1)*i._w+(-_+a)*6*s._w+(3*_-2*a)*n._w,p._isDirty=!0,p}}class fe{static get Use64Bits(){return Es.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=fe._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}_updateIdentityStatus(e,i=!1,s=!1,n=!0){this._isIdentity=e,this._isIdentity3x2=e||s,this._isIdentityDirty=this._isIdentity?!1:i,this._isIdentity3x2Dirty=this._isIdentity3x2?!1:n}constructor(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,Es.MatrixTrackPrecisionChange&&Es.MatrixTrackedMatrices.push(this),this._m=new Es.MatrixCurrentType(16),this.markAsUpdated()}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=!1;const e=this._m;this._isIdentity=e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,this._m[0]!==1||this._m[5]!==1||this._m[15]!==1?this._isIdentity3x2=!1:this._m[1]!==0||this._m[2]!==0||this._m[3]!==0||this._m[4]!==0||this._m[6]!==0||this._m[7]!==0||this._m[8]!==0||this._m[9]!==0||this._m[10]!==0||this._m[11]!==0||this._m[12]!==0||this._m[13]!==0||this._m[14]!==0?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2}determinant(){if(this._isIdentity===!0)return 1;const e=this._m,i=e[0],s=e[1],n=e[2],a=e[3],p=e[4],_=e[5],g=e[6],y=e[7],b=e[8],v=e[9],S=e[10],M=e[11],F=e[12],L=e[13],N=e[14],k=e[15],G=S*k-N*M,H=v*k-L*M,z=v*N-L*S,W=b*k-F*M,Y=b*N-S*F,Z=b*L-F*v,Q=+(_*G-g*H+y*z),se=-(p*G-g*W+y*Y),$=+(p*H-_*W+y*Z),oe=-(p*z-_*Y+g*Z);return i*Q+s*se+n*$+a*oe}toArray(){return this._m}asArray(){return this._m}invert(){return this.invertToRef(this),this}reset(){return fe.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}add(e){const i=new this.constructor;return this.addToRef(e,i),i}addToRef(e,i){const s=this._m,n=i._m,a=e.m;for(let p=0;p<16;p++)n[p]=s[p]+a[p];return i.markAsUpdated(),i}addToSelf(e){const i=this._m,s=e.m;for(let n=0;n<16;n++)i[n]+=s[n];return this.markAsUpdated(),this}invertToRef(e){if(this._isIdentity===!0)return fe.IdentityToRef(e),e;const i=this._m,s=i[0],n=i[1],a=i[2],p=i[3],_=i[4],g=i[5],y=i[6],b=i[7],v=i[8],S=i[9],M=i[10],F=i[11],L=i[12],N=i[13],k=i[14],G=i[15],H=M*G-k*F,z=S*G-N*F,W=S*k-N*M,Y=v*G-L*F,Z=v*k-M*L,Q=v*N-L*S,se=+(g*H-y*z+b*W),$=-(_*H-y*Y+b*Z),oe=+(_*z-g*Y+b*Q),ue=-(_*W-g*Z+y*Q),de=s*se+n*$+a*oe+p*ue;if(de===0)return e.copyFrom(this),e;const ye=1/de,_e=y*G-k*b,we=g*G-N*b,Pe=g*k-N*y,Ee=_*G-L*b,We=_*k-L*y,et=_*N-L*g,ke=y*F-M*b,$e=g*F-S*b,pt=g*M-S*y,Xe=_*F-v*b,Tt=_*M-v*y,fi=_*S-v*g,li=-(n*H-a*z+p*W),Ot=+(s*H-a*Y+p*Z),Gt=-(s*z-n*Y+p*Q),bi=+(s*W-n*Z+a*Q),si=+(n*_e-a*we+p*Pe),oi=-(s*_e-a*Ee+p*We),ci=+(s*we-n*Ee+p*et),Li=-(s*Pe-n*We+a*et),hi=-(n*ke-a*$e+p*pt),mi=+(s*ke-a*Xe+p*Tt),cr=-(s*$e-n*Xe+p*fi),Ui=+(s*pt-n*Tt+a*fi);return fe.FromValuesToRef(se*ye,li*ye,si*ye,hi*ye,$*ye,Ot*ye,oi*ye,mi*ye,oe*ye,Gt*ye,ci*ye,cr*ye,ue*ye,bi*ye,Li*ye,Ui*ye,e),e}addAtIndex(e,i){return this._m[e]+=i,this.markAsUpdated(),this}multiplyAtIndex(e,i){return this._m[e]*=i,this.markAsUpdated(),this}setTranslationFromFloats(e,i,s){return this._m[12]=e,this._m[13]=i,this._m[14]=s,this.markAsUpdated(),this}addTranslationFromFloats(e,i,s){return this._m[12]+=e,this._m[13]+=i,this._m[14]+=s,this.markAsUpdated(),this}setTranslation(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}getTranslation(){return new j(this._m[12],this._m[13],this._m[14])}getTranslationToRef(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],e}removeRotationAndScaling(){const e=this.m;return fe.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1),this}multiply(e){const i=new this.constructor;return this.multiplyToRef(e,i),i}copyFrom(e){e.copyToArray(this._m);const i=e;return this.updateFlag=i.updateFlag,this._updateIdentityStatus(i._isIdentity,i._isIdentityDirty,i._isIdentity3x2,i._isIdentity3x2Dirty),this}copyToArray(e,i=0){const s=this._m;return e[i]=s[0],e[i+1]=s[1],e[i+2]=s[2],e[i+3]=s[3],e[i+4]=s[4],e[i+5]=s[5],e[i+6]=s[6],e[i+7]=s[7],e[i+8]=s[8],e[i+9]=s[9],e[i+10]=s[10],e[i+11]=s[11],e[i+12]=s[12],e[i+13]=s[13],e[i+14]=s[14],e[i+15]=s[15],this}multiplyToRef(e,i){return this._isIdentity?(i.copyFrom(e),i):e._isIdentity?(i.copyFrom(this),i):(this.multiplyToArray(e,i._m,0),i.markAsUpdated(),i)}multiplyToArray(e,i,s){const n=this._m,a=e.m,p=n[0],_=n[1],g=n[2],y=n[3],b=n[4],v=n[5],S=n[6],M=n[7],F=n[8],L=n[9],N=n[10],k=n[11],G=n[12],H=n[13],z=n[14],W=n[15],Y=a[0],Z=a[1],Q=a[2],se=a[3],$=a[4],oe=a[5],ue=a[6],de=a[7],ye=a[8],_e=a[9],we=a[10],Pe=a[11],Ee=a[12],We=a[13],et=a[14],ke=a[15];return i[s]=p*Y+_*$+g*ye+y*Ee,i[s+1]=p*Z+_*oe+g*_e+y*We,i[s+2]=p*Q+_*ue+g*we+y*et,i[s+3]=p*se+_*de+g*Pe+y*ke,i[s+4]=b*Y+v*$+S*ye+M*Ee,i[s+5]=b*Z+v*oe+S*_e+M*We,i[s+6]=b*Q+v*ue+S*we+M*et,i[s+7]=b*se+v*de+S*Pe+M*ke,i[s+8]=F*Y+L*$+N*ye+k*Ee,i[s+9]=F*Z+L*oe+N*_e+k*We,i[s+10]=F*Q+L*ue+N*we+k*et,i[s+11]=F*se+L*de+N*Pe+k*ke,i[s+12]=G*Y+H*$+z*ye+W*Ee,i[s+13]=G*Z+H*oe+z*_e+W*We,i[s+14]=G*Q+H*ue+z*we+W*et,i[s+15]=G*se+H*de+z*Pe+W*ke,this}equals(e){const i=e;if(!i)return!1;if((this._isIdentity||i._isIdentity)&&!this._isIdentityDirty&&!i._isIdentityDirty)return this._isIdentity&&i._isIdentity;const s=this.m,n=i.m;return s[0]===n[0]&&s[1]===n[1]&&s[2]===n[2]&&s[3]===n[3]&&s[4]===n[4]&&s[5]===n[5]&&s[6]===n[6]&&s[7]===n[7]&&s[8]===n[8]&&s[9]===n[9]&&s[10]===n[10]&&s[11]===n[11]&&s[12]===n[12]&&s[13]===n[13]&&s[14]===n[14]&&s[15]===n[15]}clone(){const e=new this.constructor;return e.copyFrom(this),e}getClassName(){return"Matrix"}getHashCode(){let e=Un(this._m[0]);for(let i=1;i<16;i++)e=e*397^Un(this._m[i]);return e}decomposeToTransformNode(e){return e.rotationQuaternion=e.rotationQuaternion||new Ve,this.decompose(e.scaling,e.rotationQuaternion,e.position)}decompose(e,i,s,n){if(this._isIdentity)return s&&s.setAll(0),e&&e.setAll(1),i&&i.copyFromFloats(0,0,0,1),!0;const a=this._m;if(s&&s.copyFromFloats(a[12],a[13],a[14]),e=e||zt.Vector3[0],e.x=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]),e.y=Math.sqrt(a[4]*a[4]+a[5]*a[5]+a[6]*a[6]),e.z=Math.sqrt(a[8]*a[8]+a[9]*a[9]+a[10]*a[10]),n){const p=n.scaling.x<0?-1:1,_=n.scaling.y<0?-1:1,g=n.scaling.z<0?-1:1;e.x*=p,e.y*=_,e.z*=g}else this.determinant()<=0&&(e.y*=-1);if(e._x===0||e._y===0||e._z===0)return i&&i.copyFromFloats(0,0,0,1),!1;if(i){const p=1/e._x,_=1/e._y,g=1/e._z;fe.FromValuesToRef(a[0]*p,a[1]*p,a[2]*p,0,a[4]*_,a[5]*_,a[6]*_,0,a[8]*g,a[9]*g,a[10]*g,0,0,0,0,1,zt.Matrix[0]),Ve.FromRotationMatrixToRef(zt.Matrix[0],i)}return!0}getRow(e){if(e<0||e>3)return null;const i=e*4;return new xr(this._m[i+0],this._m[i+1],this._m[i+2],this._m[i+3])}getRowToRef(e,i){if(e>=0&&e<3){const s=e*4;i.x=this._m[s+0],i.y=this._m[s+1],i.z=this._m[s+2],i.w=this._m[s+3]}return i}setRow(e,i){return this.setRowFromFloats(e,i.x,i.y,i.z,i.w)}transpose(){const e=new this.constructor;return fe.TransposeToRef(this,e),e}transposeToRef(e){return fe.TransposeToRef(this,e),e}setRowFromFloats(e,i,s,n,a){if(e<0||e>3)return this;const p=e*4;return this._m[p+0]=i,this._m[p+1]=s,this._m[p+2]=n,this._m[p+3]=a,this.markAsUpdated(),this}scale(e){const i=new this.constructor;return this.scaleToRef(e,i),i}scaleToRef(e,i){for(let s=0;s<16;s++)i._m[s]=this._m[s]*e;return i.markAsUpdated(),i}scaleAndAddToRef(e,i){for(let s=0;s<16;s++)i._m[s]+=this._m[s]*e;return i.markAsUpdated(),i}toNormalMatrix(e){const i=zt.Matrix[0];this.invertToRef(i),i.transposeToRef(e);const s=e._m;return fe.FromValuesToRef(s[0],s[1],s[2],0,s[4],s[5],s[6],0,s[8],s[9],s[10],0,0,0,0,1,e),e}getRotationMatrix(){const e=new this.constructor;return this.getRotationMatrixToRef(e),e}getRotationMatrixToRef(e){const i=zt.Vector3[0];if(!this.decompose(i))return fe.IdentityToRef(e),e;const s=this._m,n=1/i._x,a=1/i._y,p=1/i._z;return fe.FromValuesToRef(s[0]*n,s[1]*n,s[2]*n,0,s[4]*a,s[5]*a,s[6]*a,0,s[8]*p,s[9]*p,s[10]*p,0,0,0,0,1,e),e}toggleModelMatrixHandInPlace(){const e=this._m;return e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){const e=this._m;return e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated(),this}static FromArray(e,i=0){const s=new fe;return fe.FromArrayToRef(e,i,s),s}static FromArrayToRef(e,i,s){for(let n=0;n<16;n++)s._m[n]=e[n+i];return s.markAsUpdated(),s}static FromFloat32ArrayToRefScaled(e,i,s,n){for(let a=0;a<16;a++)n._m[a]=e[a+i]*s;return n.markAsUpdated(),n}static get IdentityReadOnly(){return fe._IdentityReadOnly}static FromValuesToRef(e,i,s,n,a,p,_,g,y,b,v,S,M,F,L,N,k){const G=k._m;G[0]=e,G[1]=i,G[2]=s,G[3]=n,G[4]=a,G[5]=p,G[6]=_,G[7]=g,G[8]=y,G[9]=b,G[10]=v,G[11]=S,G[12]=M,G[13]=F,G[14]=L,G[15]=N,k.markAsUpdated()}static FromValues(e,i,s,n,a,p,_,g,y,b,v,S,M,F,L,N){const k=new fe,G=k._m;return G[0]=e,G[1]=i,G[2]=s,G[3]=n,G[4]=a,G[5]=p,G[6]=_,G[7]=g,G[8]=y,G[9]=b,G[10]=v,G[11]=S,G[12]=M,G[13]=F,G[14]=L,G[15]=N,k.markAsUpdated(),k}static Compose(e,i,s){const n=new fe;return fe.ComposeToRef(e,i,s,n),n}static ComposeToRef(e,i,s,n){const a=n._m,p=i._x,_=i._y,g=i._z,y=i._w,b=p+p,v=_+_,S=g+g,M=p*b,F=p*v,L=p*S,N=_*v,k=_*S,G=g*S,H=y*b,z=y*v,W=y*S,Y=e._x,Z=e._y,Q=e._z;return a[0]=(1-(N+G))*Y,a[1]=(F+W)*Y,a[2]=(L-z)*Y,a[3]=0,a[4]=(F-W)*Z,a[5]=(1-(M+G))*Z,a[6]=(k+H)*Z,a[7]=0,a[8]=(L+z)*Q,a[9]=(k-H)*Q,a[10]=(1-(M+N))*Q,a[11]=0,a[12]=s._x,a[13]=s._y,a[14]=s._z,a[15]=1,n.markAsUpdated(),n}static Identity(){const e=fe.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(!0),e}static IdentityToRef(e){return fe.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(!0),e}static Zero(){const e=fe.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(!1),e}static RotationX(e){const i=new fe;return fe.RotationXToRef(e,i),i}static Invert(e){const i=new e.constructor;return e.invertToRef(i),i}static RotationXToRef(e,i){const s=Math.sin(e),n=Math.cos(e);return fe.FromValuesToRef(1,0,0,0,0,n,s,0,0,-s,n,0,0,0,0,1,i),i._updateIdentityStatus(n===1&&s===0),i}static RotationY(e){const i=new fe;return fe.RotationYToRef(e,i),i}static RotationYToRef(e,i){const s=Math.sin(e),n=Math.cos(e);return fe.FromValuesToRef(n,0,-s,0,0,1,0,0,s,0,n,0,0,0,0,1,i),i._updateIdentityStatus(n===1&&s===0),i}static RotationZ(e){const i=new fe;return fe.RotationZToRef(e,i),i}static RotationZToRef(e,i){const s=Math.sin(e),n=Math.cos(e);return fe.FromValuesToRef(n,s,0,0,-s,n,0,0,0,0,1,0,0,0,0,1,i),i._updateIdentityStatus(n===1&&s===0),i}static RotationAxis(e,i){const s=new fe;return fe.RotationAxisToRef(e,i,s),s}static RotationAxisToRef(e,i,s){const n=Math.sin(-i),a=Math.cos(-i),p=1-a;e.normalize();const _=s._m;return _[0]=e._x*e._x*p+a,_[1]=e._x*e._y*p-e._z*n,_[2]=e._x*e._z*p+e._y*n,_[3]=0,_[4]=e._y*e._x*p+e._z*n,_[5]=e._y*e._y*p+a,_[6]=e._y*e._z*p-e._x*n,_[7]=0,_[8]=e._z*e._x*p-e._y*n,_[9]=e._z*e._y*p+e._x*n,_[10]=e._z*e._z*p+a,_[11]=0,_[12]=0,_[13]=0,_[14]=0,_[15]=1,s.markAsUpdated(),s}static RotationAlignToRef(e,i,s){const n=j.Dot(i,e),a=s._m;if(n<-1+rr)a[0]=-1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=-1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0;else{const p=j.Cross(i,e),_=1/(1+n);a[0]=p._x*p._x*_+n,a[1]=p._y*p._x*_-p._z,a[2]=p._z*p._x*_+p._y,a[3]=0,a[4]=p._x*p._y*_+p._z,a[5]=p._y*p._y*_+n,a[6]=p._z*p._y*_-p._x,a[7]=0,a[8]=p._x*p._z*_-p._y,a[9]=p._y*p._z*_+p._x,a[10]=p._z*p._z*_+n,a[11]=0}return a[12]=0,a[13]=0,a[14]=0,a[15]=1,s.markAsUpdated(),s}static RotationYawPitchRoll(e,i,s){const n=new fe;return fe.RotationYawPitchRollToRef(e,i,s,n),n}static RotationYawPitchRollToRef(e,i,s,n){return Ve.RotationYawPitchRollToRef(e,i,s,zt.Quaternion[0]),zt.Quaternion[0].toRotationMatrix(n),n}static Scaling(e,i,s){const n=new fe;return fe.ScalingToRef(e,i,s,n),n}static ScalingToRef(e,i,s,n){return fe.FromValuesToRef(e,0,0,0,0,i,0,0,0,0,s,0,0,0,0,1,n),n._updateIdentityStatus(e===1&&i===1&&s===1),n}static Translation(e,i,s){const n=new fe;return fe.TranslationToRef(e,i,s,n),n}static TranslationToRef(e,i,s,n){return fe.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,i,s,1,n),n._updateIdentityStatus(e===0&&i===0&&s===0),n}static Lerp(e,i,s){const n=new e.constructor;return fe.LerpToRef(e,i,s,n),n}static LerpToRef(e,i,s,n){const a=n._m,p=e.m,_=i.m;for(let g=0;g<16;g++)a[g]=p[g]*(1-s)+_[g]*s;return n.markAsUpdated(),n}static DecomposeLerp(e,i,s){const n=new e.constructor;return fe.DecomposeLerpToRef(e,i,s,n),n}static DecomposeLerpToRef(e,i,s,n){const a=zt.Vector3[0],p=zt.Quaternion[0],_=zt.Vector3[1];e.decompose(a,p,_);const g=zt.Vector3[2],y=zt.Quaternion[1],b=zt.Vector3[3];i.decompose(g,y,b);const v=zt.Vector3[4];j.LerpToRef(a,g,s,v);const S=zt.Quaternion[2];Ve.SlerpToRef(p,y,s,S);const M=zt.Vector3[5];return j.LerpToRef(_,b,s,M),fe.ComposeToRef(v,S,M,n),n}static LookAtLH(e,i,s){const n=new fe;return fe.LookAtLHToRef(e,i,s,n),n}static LookAtLHToRef(e,i,s,n){const a=zt.Vector3[0],p=zt.Vector3[1],_=zt.Vector3[2];i.subtractToRef(e,_),_.normalize(),j.CrossToRef(s,_,a);const g=a.lengthSquared();g===0?a.x=1:a.normalizeFromLength(Math.sqrt(g)),j.CrossToRef(_,a,p),p.normalize();const y=-j.Dot(a,e),b=-j.Dot(p,e),v=-j.Dot(_,e);fe.FromValuesToRef(a._x,p._x,_._x,0,a._y,p._y,_._y,0,a._z,p._z,_._z,0,y,b,v,1,n)}static LookAtRH(e,i,s){const n=new fe;return fe.LookAtRHToRef(e,i,s,n),n}static LookAtRHToRef(e,i,s,n){const a=zt.Vector3[0],p=zt.Vector3[1],_=zt.Vector3[2];e.subtractToRef(i,_),_.normalize(),j.CrossToRef(s,_,a);const g=a.lengthSquared();g===0?a.x=1:a.normalizeFromLength(Math.sqrt(g)),j.CrossToRef(_,a,p),p.normalize();const y=-j.Dot(a,e),b=-j.Dot(p,e),v=-j.Dot(_,e);return fe.FromValuesToRef(a._x,p._x,_._x,0,a._y,p._y,_._y,0,a._z,p._z,_._z,0,y,b,v,1,n),n}static LookDirectionLH(e,i){const s=new fe;return fe.LookDirectionLHToRef(e,i,s),s}static LookDirectionLHToRef(e,i,s){const n=zt.Vector3[0];n.copyFrom(e),n.scaleInPlace(-1);const a=zt.Vector3[1];return j.CrossToRef(i,n,a),fe.FromValuesToRef(a._x,a._y,a._z,0,i._x,i._y,i._z,0,n._x,n._y,n._z,0,0,0,0,1,s),s}static LookDirectionRH(e,i){const s=new fe;return fe.LookDirectionRHToRef(e,i,s),s}static LookDirectionRHToRef(e,i,s){const n=zt.Vector3[2];return j.CrossToRef(i,e,n),fe.FromValuesToRef(n._x,n._y,n._z,0,i._x,i._y,i._z,0,e._x,e._y,e._z,0,0,0,0,1,s),s}static OrthoLH(e,i,s,n,a){const p=new fe;return fe.OrthoLHToRef(e,i,s,n,p,a),p}static OrthoLHToRef(e,i,s,n,a,p){const _=s,g=n,y=2/e,b=2/i,v=2/(g-_),S=-(g+_)/(g-_);return fe.FromValuesToRef(y,0,0,0,0,b,0,0,0,0,v,0,0,0,S,1,a),p&&a.multiplyToRef(yx,a),a._updateIdentityStatus(y===1&&b===1&&v===1&&S===0),a}static OrthoOffCenterLH(e,i,s,n,a,p,_){const g=new fe;return fe.OrthoOffCenterLHToRef(e,i,s,n,a,p,g,_),g}static OrthoOffCenterLHToRef(e,i,s,n,a,p,_,g){const y=a,b=p,v=2/(i-e),S=2/(n-s),M=2/(b-y),F=-(b+y)/(b-y),L=(e+i)/(e-i),N=(n+s)/(s-n);return fe.FromValuesToRef(v,0,0,0,0,S,0,0,0,0,M,0,L,N,F,1,_),g&&_.multiplyToRef(yx,_),_.markAsUpdated(),_}static OrthoOffCenterRH(e,i,s,n,a,p,_){const g=new fe;return fe.OrthoOffCenterRHToRef(e,i,s,n,a,p,g,_),g}static OrthoOffCenterRHToRef(e,i,s,n,a,p,_,g){return fe.OrthoOffCenterLHToRef(e,i,s,n,a,p,_,g),_._m[10]*=-1,_}static PerspectiveLH(e,i,s,n,a,p=0){const _=new fe,g=s,y=n,b=2*g/e,v=2*g/i,S=(y+g)/(y-g),M=-2*y*g/(y-g),F=Math.tan(p);return fe.FromValuesToRef(b,0,0,0,0,v,0,F,0,0,S,1,0,0,M,0,_),a&&_.multiplyToRef(yx,_),_._updateIdentityStatus(!1),_}static PerspectiveFovLH(e,i,s,n,a,p=0,_=!1){const g=new fe;return fe.PerspectiveFovLHToRef(e,i,s,n,g,!0,a,p,_),g}static PerspectiveFovLHToRef(e,i,s,n,a,p=!0,_,g=0,y=!1){const b=s,v=n,S=1/Math.tan(e*.5),M=p?S/i:S,F=p?S:S*i,L=y&&b===0?-1:v!==0?(v+b)/(v-b):1,N=y&&b===0?2*v:v!==0?-2*v*b/(v-b):-2*b,k=Math.tan(g);return fe.FromValuesToRef(M,0,0,0,0,F,0,k,0,0,L,1,0,0,N,0,a),_&&a.multiplyToRef(yx,a),a._updateIdentityStatus(!1),a}static PerspectiveFovReverseLHToRef(e,i,s,n,a,p=!0,_,g=0){const y=1/Math.tan(e*.5),b=p?y/i:y,v=p?y:y*i,S=Math.tan(g);return fe.FromValuesToRef(b,0,0,0,0,v,0,S,0,0,-s,1,0,0,1,0,a),_&&a.multiplyToRef(yx,a),a._updateIdentityStatus(!1),a}static PerspectiveFovRH(e,i,s,n,a,p=0,_=!1){const g=new fe;return fe.PerspectiveFovRHToRef(e,i,s,n,g,!0,a,p,_),g}static PerspectiveFovRHToRef(e,i,s,n,a,p=!0,_,g=0,y=!1){const b=s,v=n,S=1/Math.tan(e*.5),M=p?S/i:S,F=p?S:S*i,L=y&&b===0?1:v!==0?-(v+b)/(v-b):-1,N=y&&b===0?2*v:v!==0?-2*v*b/(v-b):-2*b,k=Math.tan(g);return fe.FromValuesToRef(M,0,0,0,0,F,0,k,0,0,L,-1,0,0,N,0,a),_&&a.multiplyToRef(yx,a),a._updateIdentityStatus(!1),a}static PerspectiveFovReverseRHToRef(e,i,s,n,a,p=!0,_,g=0){const y=1/Math.tan(e*.5),b=p?y/i:y,v=p?y:y*i,S=Math.tan(g);return fe.FromValuesToRef(b,0,0,0,0,v,0,S,0,0,-s,-1,0,0,-1,0,a),_&&a.multiplyToRef(yx,a),a._updateIdentityStatus(!1),a}static PerspectiveFovWebVRToRef(e,i,s,n,a=!1,p,_=0){const g=a?-1:1,y=Math.tan(e.upDegrees*Math.PI/180),b=Math.tan(e.downDegrees*Math.PI/180),v=Math.tan(e.leftDegrees*Math.PI/180),S=Math.tan(e.rightDegrees*Math.PI/180),M=2/(v+S),F=2/(y+b),L=Math.tan(_),N=n._m;return N[0]=M,N[1]=N[2]=N[3]=N[4]=0,N[5]=F,N[6]=0,N[7]=L,N[8]=(v-S)*M*.5,N[9]=-((y-b)*F*.5),N[10]=-s/(i-s),N[11]=1*g,N[12]=N[13]=N[15]=0,N[14]=-(2*s*i)/(s-i),p&&n.multiplyToRef(yx,n),n.markAsUpdated(),n}static GetFinalMatrix(e,i,s,n,a,p){const _=e.width,g=e.height,y=e.x,b=e.y,v=fe.FromValues(_/2,0,0,0,0,-g/2,0,0,0,0,p-a,0,y+_/2,g/2+b,a,1),S=new i.constructor;return i.multiplyToRef(s,S),S.multiplyToRef(n,S),S.multiplyToRef(v,S)}static GetAsMatrix2x2(e){const i=e.m,s=[i[0],i[1],i[4],i[5]];return Es.MatrixUse64Bits?s:new Float32Array(s)}static GetAsMatrix3x3(e){const i=e.m,s=[i[0],i[1],i[2],i[4],i[5],i[6],i[8],i[9],i[10]];return Es.MatrixUse64Bits?s:new Float32Array(s)}static Transpose(e){const i=new e.constructor;return fe.TransposeToRef(e,i),i}static TransposeToRef(e,i){const s=i._m,n=e.m;return s[0]=n[0],s[1]=n[4],s[2]=n[8],s[3]=n[12],s[4]=n[1],s[5]=n[5],s[6]=n[9],s[7]=n[13],s[8]=n[2],s[9]=n[6],s[10]=n[10],s[11]=n[14],s[12]=n[3],s[13]=n[7],s[14]=n[11],s[15]=n[15],i.markAsUpdated(),i._updateIdentityStatus(e._isIdentity,e._isIdentityDirty),i}static Reflection(e){const i=new fe;return fe.ReflectionToRef(e,i),i}static ReflectionToRef(e,i){e.normalize();const s=e.normal.x,n=e.normal.y,a=e.normal.z,p=-2*s,_=-2*n,g=-2*a;return fe.FromValuesToRef(p*s+1,_*s,g*s,0,p*n,_*n+1,g*n,0,p*a,_*a,g*a+1,0,p*e.d,_*e.d,g*e.d,1,i),i}static FromXYZAxesToRef(e,i,s,n){return fe.FromValuesToRef(e._x,e._y,e._z,0,i._x,i._y,i._z,0,s._x,s._y,s._z,0,0,0,0,1,n),n}static FromQuaternionToRef(e,i){const s=e._x*e._x,n=e._y*e._y,a=e._z*e._z,p=e._x*e._y,_=e._z*e._w,g=e._z*e._x,y=e._y*e._w,b=e._y*e._z,v=e._x*e._w;return i._m[0]=1-2*(n+a),i._m[1]=2*(p+_),i._m[2]=2*(g-y),i._m[3]=0,i._m[4]=2*(p-_),i._m[5]=1-2*(a+s),i._m[6]=2*(b+v),i._m[7]=0,i._m[8]=2*(g+y),i._m[9]=2*(b-v),i._m[10]=1-2*(n+s),i._m[11]=0,i._m[12]=0,i._m[13]=0,i._m[14]=0,i._m[15]=1,i.markAsUpdated(),i}}fe._UpdateFlagSeed=0,fe._IdentityReadOnly=fe.Identity();class zt{}zt.Vector3=As.BuildTuple(11,j.Zero),zt.Matrix=As.BuildTuple(2,fe.Identity),zt.Quaternion=As.BuildTuple(3,Ve.Zero);class ge{}ge.Vector2=As.BuildTuple(3,ii.Zero),ge.Vector3=As.BuildTuple(13,j.Zero),ge.Vector4=As.BuildTuple(3,xr.Zero),ge.Quaternion=As.BuildTuple(2,Ve.Zero),ge.Matrix=As.BuildTuple(8,fe.Identity),ur("BABYLON.Vector2",ii),ur("BABYLON.Vector3",j),ur("BABYLON.Vector4",xr),ur("BABYLON.Matrix",fe);const yx=fe.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);class Xh{constructor(){this.rootNodes=new Array,this.cameras=new Array,this.lights=new Array,this.meshes=new Array,this.skeletons=new Array,this.particleSystems=new Array,this.animations=[],this.animationGroups=new Array,this.multiMaterials=new Array,this.materials=new Array,this.morphTargetManagers=new Array,this.geometries=new Array,this.transformNodes=new Array,this.actionManagers=new Array,this.textures=new Array,this._environmentTexture=null,this.postProcesses=new Array}static AddParser(e,i){this._BabylonFileParsers[e]=i}static GetParser(e){return this._BabylonFileParsers[e]?this._BabylonFileParsers[e]:null}static AddIndividualParser(e,i){this._IndividualBabylonFileParsers[e]=i}static GetIndividualParser(e){return this._IndividualBabylonFileParsers[e]?this._IndividualBabylonFileParsers[e]:null}static Parse(e,i,s,n){for(const a in this._BabylonFileParsers)Object.prototype.hasOwnProperty.call(this._BabylonFileParsers,a)&&this._BabylonFileParsers[a](e,i,s,n)}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=new Array;return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach(i=>e=e.concat(i.bones)),e}}Xh._BabylonFileParsers={},Xh._IndividualBabylonFileParsers={};var e_=function(l,e){return e_=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,s){i.__proto__=s}||function(i,s){for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&(i[n]=s[n])},e_(l,e)};function PY(l,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");e_(l,e);function i(){this.constructor=l}l.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}var bE=function(){return bE=Object.assign||function(e){for(var i,s=1,n=arguments.length;s<n;s++){i=arguments[s];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])}return e},bE.apply(this,arguments)};function OY(l,e){var i={};for(var s in l)Object.prototype.hasOwnProperty.call(l,s)&&e.indexOf(s)<0&&(i[s]=l[s]);if(l!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,s=Object.getOwnPropertySymbols(l);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(l,s[n])&&(i[s[n]]=l[s[n]]);return i}function J(l,e,i,s){var n=arguments.length,a=n<3?e:s===null?s=Object.getOwnPropertyDescriptor(e,i):s,p;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")a=Reflect.decorate(l,e,i,s);else for(var _=l.length-1;_>=0;_--)(p=l[_])&&(a=(n<3?p(a):n>3?p(e,i,a):p(e,i))||a);return n>3&&a&&Object.defineProperty(e,i,a),a}function wY(l,e){return function(i,s){e(i,s,l)}}function DY(l,e){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(l,e)}function FY(l,e,i,s){function n(a){return a instanceof i?a:new i(function(p){p(a)})}return new(i||(i=Promise))(function(a,p){function _(b){try{y(s.next(b))}catch(v){p(v)}}function g(b){try{y(s.throw(b))}catch(v){p(v)}}function y(b){b.done?a(b.value):n(b.value).then(_,g)}y((s=s.apply(l,e||[])).next())})}function LY(l,e){var i={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},s,n,a,p;return p={next:_(0),throw:_(1),return:_(2)},typeof Symbol=="function"&&(p[Symbol.iterator]=function(){return this}),p;function _(y){return function(b){return g([y,b])}}function g(y){if(s)throw new TypeError("Generator is already executing.");for(;i;)try{if(s=1,n&&(a=y[0]&2?n.return:y[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,y[1])).done)return a;switch(n=0,a&&(y=[y[0]&2,a.value]),y[0]){case 0:case 1:a=y;break;case 4:return i.label++,{value:y[1],done:!1};case 5:i.label++,n=y[1],y=[0];continue;case 7:y=i.ops.pop(),i.trys.pop();continue;default:if(a=i.trys,!(a=a.length>0&&a[a.length-1])&&(y[0]===6||y[0]===2)){i=0;continue}if(y[0]===3&&(!a||y[1]>a[0]&&y[1]<a[3])){i.label=y[1];break}if(y[0]===6&&i.label<a[1]){i.label=a[1],a=y;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(y);break}a[2]&&i.ops.pop(),i.trys.pop();continue}y=e.call(l,i)}catch(b){y=[6,b],n=0}finally{s=a=0}if(y[0]&5)throw y[1];return{value:y[0]?y[1]:void 0,done:!0}}}var vE=Object.create?function(l,e,i,s){s===void 0&&(s=i);var n=Object.getOwnPropertyDescriptor(e,i);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[i]}}),Object.defineProperty(l,s,n)}:function(l,e,i,s){s===void 0&&(s=i),l[s]=e[i]};function NY(l,e){for(var i in l)i!=="default"&&!Object.prototype.hasOwnProperty.call(e,i)&&vE(e,l,i)}function TE(l){var e=typeof Symbol=="function"&&Symbol.iterator,i=e&&l[e],s=0;if(i)return i.call(l);if(l&&typeof l.length=="number")return{next:function(){return l&&s>=l.length&&(l=void 0),{value:l&&l[s++],done:!l}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function S9(l,e){var i=typeof Symbol=="function"&&l[Symbol.iterator];if(!i)return l;var s=i.call(l),n,a=[],p;try{for(;(e===void 0||e-- >0)&&!(n=s.next()).done;)a.push(n.value)}catch(_){p={error:_}}finally{try{n&&!n.done&&(i=s.return)&&i.call(s)}finally{if(p)throw p.error}}return a}function BY(){for(var l=[],e=0;e<arguments.length;e++)l=l.concat(S9(arguments[e]));return l}function kY(){for(var l=0,e=0,i=arguments.length;e<i;e++)l+=arguments[e].length;for(var s=Array(l),n=0,e=0;e<i;e++)for(var a=arguments[e],p=0,_=a.length;p<_;p++,n++)s[n]=a[p];return s}function UY(l,e,i){if(i||arguments.length===2)for(var s=0,n=e.length,a;s<n;s++)(a||!(s in e))&&(a||(a=Array.prototype.slice.call(e,0,s)),a[s]=e[s]);return l.concat(a||Array.prototype.slice.call(e))}function y2(l){return this instanceof y2?(this.v=l,this):new y2(l)}function VY(l,e,i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s=i.apply(l,e||[]),n,a=[];return n={},p("next"),p("throw"),p("return"),n[Symbol.asyncIterator]=function(){return this},n;function p(S){s[S]&&(n[S]=function(M){return new Promise(function(F,L){a.push([S,M,F,L])>1||_(S,M)})})}function _(S,M){try{g(s[S](M))}catch(F){v(a[0][3],F)}}function g(S){S.value instanceof y2?Promise.resolve(S.value.v).then(y,b):v(a[0][2],S)}function y(S){_("next",S)}function b(S){_("throw",S)}function v(S,M){S(M),a.shift(),a.length&&_(a[0][0],a[0][1])}}function GY(l){var e,i;return e={},s("next"),s("throw",function(n){throw n}),s("return"),e[Symbol.iterator]=function(){return this},e;function s(n,a){e[n]=l[n]?function(p){return(i=!i)?{value:y2(l[n](p)),done:n==="return"}:a?a(p):p}:a}}function WY(l){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=l[Symbol.asyncIterator],i;return e?e.call(l):(l=typeof TE=="function"?TE(l):l[Symbol.iterator](),i={},s("next"),s("throw"),s("return"),i[Symbol.asyncIterator]=function(){return this},i);function s(a){i[a]=l[a]&&function(p){return new Promise(function(_,g){p=l[a](p),n(_,g,p.done,p.value)})}}function n(a,p,_,g){Promise.resolve(g).then(function(y){a({value:y,done:_})},p)}}function zY(l,e){return Object.defineProperty?Object.defineProperty(l,"raw",{value:e}):l.raw=e,l}var M9=Object.create?function(l,e){Object.defineProperty(l,"default",{enumerable:!0,value:e})}:function(l,e){l.default=e};function HY(l){if(l&&l.__esModule)return l;var e={};if(l!=null)for(var i in l)i!=="default"&&Object.prototype.hasOwnProperty.call(l,i)&&vE(e,l,i);return M9(e,l),e}function XY(l){return l&&l.__esModule?l:{default:l}}function YY(l,e,i,s){if(i==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?l!==e||!s:!e.has(l))throw new TypeError("Cannot read private member from an object whose class did not declare it");return i==="m"?s:i==="a"?s.call(l):s?s.value:e.get(l)}function KY(l,e,i,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?l!==e||!n:!e.has(l))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(l,i):n?n.value=i:e.set(l,i),i}function jY(l,e){if(e===null||typeof e!="object"&&typeof e!="function")throw new TypeError("Cannot use 'in' operator on non-object");return typeof l=="function"?e===l:l.has(e)}function mc(l){return Math.pow(l,g2)}function _c(l){return l<=.04045?.0773993808*l:Math.pow(.947867299*(l+.055),2.4)}function gc(l){return Math.pow(l,C9)}function yc(l){return l<=.0031308?12.92*l:1.055*Math.pow(l,.41666)-.055}class qe{constructor(e=0,i=0,s=0){this.r=e,this.g=i,this.b=s}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e}toArray(e,i=0){return e[i]=this.r,e[i+1]=this.g,e[i+2]=this.b,this}fromArray(e,i=0){return qe.FromArrayToRef(e,i,this),this}toColor4(e=1){return new pi(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return this.r*.3+this.g*.59+this.b*.11}multiply(e){return new qe(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,i){return i.r=this.r*e.r,i.g=this.g*e.g,i.b=this.b*e.b,this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,i,s){return this.r===e&&this.g===i&&this.b===s}scale(e){return new qe(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,i){return i.r=this.r*e,i.g=this.g*e,i.b=this.b*e,this}scaleAndAddToRef(e,i){return i.r+=this.r*e,i.g+=this.g*e,i.b+=this.b*e,this}clampToRef(e=0,i=1,s){return s.r=at.Clamp(this.r,e,i),s.g=at.Clamp(this.g,e,i),s.b=at.Clamp(this.b,e,i),this}add(e){return new qe(this.r+e.r,this.g+e.g,this.b+e.b)}addToRef(e,i){return i.r=this.r+e.r,i.g=this.g+e.g,i.b=this.b+e.b,this}subtract(e){return new qe(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,i){return i.r=this.r-e.r,i.g=this.g-e.g,i.b=this.b-e.b,this}clone(){return new qe(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,i,s){return this.r=e,this.g=i,this.b=s,this}set(e,i,s){return this.copyFromFloats(e,i,s)}toHexString(){const e=Math.round(this.r*255),i=Math.round(this.g*255),s=Math.round(this.b*255);return"#"+at.ToHex(e)+at.ToHex(i)+at.ToHex(s)}toHSV(){const e=new qe;return this.toHSVToRef(e),e}toHSVToRef(e){const i=this.r,s=this.g,n=this.b,a=Math.max(i,s,n),p=Math.min(i,s,n);let _=0,g=0;const y=a,b=a-p;a!==0&&(g=b/a),a!=p&&(a==i?(_=(s-n)/b,s<n&&(_+=6)):a==s?_=(n-i)/b+2:a==n&&(_=(i-s)/b+4),_*=60),e.r=_,e.g=g,e.b=y}toLinearSpace(e=!1){const i=new qe;return this.toLinearSpaceToRef(i,e),i}toLinearSpaceToRef(e,i=!1){return i?(e.r=_c(this.r),e.g=_c(this.g),e.b=_c(this.b)):(e.r=mc(this.r),e.g=mc(this.g),e.b=mc(this.b)),this}toGammaSpace(e=!1){const i=new qe;return this.toGammaSpaceToRef(i,e),i}toGammaSpaceToRef(e,i=!1){return i?(e.r=yc(this.r),e.g=yc(this.g),e.b=yc(this.b)):(e.r=gc(this.r),e.g=gc(this.g),e.b=gc(this.b)),this}static HSVtoRGBToRef(e,i,s,n){const a=s*i,p=e/60,_=a*(1-Math.abs(p%2-1));let g=0,y=0,b=0;p>=0&&p<=1?(g=a,y=_):p>=1&&p<=2?(g=_,y=a):p>=2&&p<=3?(y=a,b=_):p>=3&&p<=4?(y=_,b=a):p>=4&&p<=5?(g=_,b=a):p>=5&&p<=6&&(g=a,b=_);const v=s-a;n.set(g+v,y+v,b+v)}static FromHSV(e,i,s){const n=new qe(0,0,0);return qe.HSVtoRGBToRef(e,i,s,n),n}static FromHexString(e){if(e.substring(0,1)!=="#"||e.length!==7)return new qe(0,0,0);const i=parseInt(e.substring(1,3),16),s=parseInt(e.substring(3,5),16),n=parseInt(e.substring(5,7),16);return qe.FromInts(i,s,n)}static FromArray(e,i=0){return new qe(e[i],e[i+1],e[i+2])}static FromArrayToRef(e,i=0,s){s.r=e[i],s.g=e[i+1],s.b=e[i+2]}static FromInts(e,i,s){return new qe(e/255,i/255,s/255)}static Lerp(e,i,s){const n=new qe(0,0,0);return qe.LerpToRef(e,i,s,n),n}static LerpToRef(e,i,s,n){n.r=e.r+(i.r-e.r)*s,n.g=e.g+(i.g-e.g)*s,n.b=e.b+(i.b-e.b)*s}static Hermite(e,i,s,n,a){const p=a*a,_=a*p,g=2*_-3*p+1,y=-2*_+3*p,b=_-2*p+a,v=_-p,S=e.r*g+s.r*y+i.r*b+n.r*v,M=e.g*g+s.g*y+i.g*b+n.g*v,F=e.b*g+s.b*y+i.b*b+n.b*v;return new qe(S,M,F)}static Hermite1stDerivative(e,i,s,n,a){const p=qe.Black();return this.Hermite1stDerivativeToRef(e,i,s,n,a,p),p}static Hermite1stDerivativeToRef(e,i,s,n,a,p){const _=a*a;p.r=(_-a)*6*e.r+(3*_-4*a+1)*i.r+(-_+a)*6*s.r+(3*_-2*a)*n.r,p.g=(_-a)*6*e.g+(3*_-4*a+1)*i.g+(-_+a)*6*s.g+(3*_-2*a)*n.g,p.b=(_-a)*6*e.b+(3*_-4*a+1)*i.b+(-_+a)*6*s.b+(3*_-2*a)*n.b}static Red(){return new qe(1,0,0)}static Green(){return new qe(0,1,0)}static Blue(){return new qe(0,0,1)}static Black(){return new qe(0,0,0)}static get BlackReadOnly(){return qe._BlackReadOnly}static White(){return new qe(1,1,1)}static Purple(){return new qe(.5,0,.5)}static Magenta(){return new qe(1,0,1)}static Yellow(){return new qe(1,1,0)}static Gray(){return new qe(.5,.5,.5)}static Teal(){return new qe(0,1,1)}static Random(){return new qe(Math.random(),Math.random(),Math.random())}}qe._BlackReadOnly=qe.Black();class pi{constructor(e=0,i=0,s=0,n=1){this.r=e,this.g=i,this.b=s,this.a=n}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,i=0){return e[i]=this.r,e[i+1]=this.g,e[i+2]=this.b,e[i+3]=this.a,this}fromArray(e,i=0){return pi.FromArrayToRef(e,i,this),this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new pi(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}subtract(e){return new pi(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,i){return i.r=this.r-e.r,i.g=this.g-e.g,i.b=this.b-e.b,i.a=this.a-e.a,this}scale(e){return new pi(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,i){return i.r=this.r*e,i.g=this.g*e,i.b=this.b*e,i.a=this.a*e,this}scaleAndAddToRef(e,i){return i.r+=this.r*e,i.g+=this.g*e,i.b+=this.b*e,i.a+=this.a*e,this}clampToRef(e=0,i=1,s){return s.r=at.Clamp(this.r,e,i),s.g=at.Clamp(this.g,e,i),s.b=at.Clamp(this.b,e,i),s.a=at.Clamp(this.a,e,i),this}multiply(e){return new pi(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,i){return i.r=this.r*e.r,i.g=this.g*e.g,i.b=this.b*e.b,i.a=this.a*e.a,i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e=e*397^(this.a*255|0),e}clone(){return new pi(this.r,this.g,this.b,this.a)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,i,s,n){return this.r=e,this.g=i,this.b=s,this.a=n,this}set(e,i,s,n){return this.copyFromFloats(e,i,s,n)}toHexString(e=!1){const i=Math.round(this.r*255),s=Math.round(this.g*255),n=Math.round(this.b*255);if(e)return"#"+at.ToHex(i)+at.ToHex(s)+at.ToHex(n);const a=Math.round(this.a*255);return"#"+at.ToHex(i)+at.ToHex(s)+at.ToHex(n)+at.ToHex(a)}toLinearSpace(e=!1){const i=new pi;return this.toLinearSpaceToRef(i,e),i}toLinearSpaceToRef(e,i=!1){return i?(e.r=_c(this.r),e.g=_c(this.g),e.b=_c(this.b)):(e.r=mc(this.r),e.g=mc(this.g),e.b=mc(this.b)),e.a=this.a,this}toGammaSpace(e=!1){const i=new pi;return this.toGammaSpaceToRef(i,e),i}toGammaSpaceToRef(e,i=!1){return i?(e.r=yc(this.r),e.g=yc(this.g),e.b=yc(this.b)):(e.r=gc(this.r),e.g=gc(this.g),e.b=gc(this.b)),e.a=this.a,this}static FromHexString(e){if(e.substring(0,1)!=="#"||e.length!==9&&e.length!==7)return new pi(0,0,0,0);const i=parseInt(e.substring(1,3),16),s=parseInt(e.substring(3,5),16),n=parseInt(e.substring(5,7),16),a=e.length===9?parseInt(e.substring(7,9),16):255;return pi.FromInts(i,s,n,a)}static Lerp(e,i,s){const n=new pi(0,0,0,0);return pi.LerpToRef(e,i,s,n),n}static LerpToRef(e,i,s,n){n.r=e.r+(i.r-e.r)*s,n.g=e.g+(i.g-e.g)*s,n.b=e.b+(i.b-e.b)*s,n.a=e.a+(i.a-e.a)*s}static Hermite(e,i,s,n,a){const p=a*a,_=a*p,g=2*_-3*p+1,y=-2*_+3*p,b=_-2*p+a,v=_-p,S=e.r*g+s.r*y+i.r*b+n.r*v,M=e.g*g+s.g*y+i.g*b+n.g*v,F=e.b*g+s.b*y+i.b*b+n.b*v,L=e.a*g+s.a*y+i.a*b+n.a*v;return new pi(S,M,F,L)}static Hermite1stDerivative(e,i,s,n,a){const p=new pi;return this.Hermite1stDerivativeToRef(e,i,s,n,a,p),p}static Hermite1stDerivativeToRef(e,i,s,n,a,p){const _=a*a;p.r=(_-a)*6*e.r+(3*_-4*a+1)*i.r+(-_+a)*6*s.r+(3*_-2*a)*n.r,p.g=(_-a)*6*e.g+(3*_-4*a+1)*i.g+(-_+a)*6*s.g+(3*_-2*a)*n.g,p.b=(_-a)*6*e.b+(3*_-4*a+1)*i.b+(-_+a)*6*s.b+(3*_-2*a)*n.b,p.a=(_-a)*6*e.a+(3*_-4*a+1)*i.a+(-_+a)*6*s.a+(3*_-2*a)*n.a}static FromColor3(e,i=1){return new pi(e.r,e.g,e.b,i)}static FromArray(e,i=0){return new pi(e[i],e[i+1],e[i+2],e[i+3])}static FromArrayToRef(e,i=0,s){s.r=e[i],s.g=e[i+1],s.b=e[i+2],s.a=e[i+3]}static FromInts(e,i,s,n){return new pi(e/255,i/255,s/255,n/255)}static CheckColors4(e,i){if(e.length===i*3){const s=[];for(let n=0;n<e.length;n+=3){const a=n/3*4;s[a]=e[n],s[a+1]=e[n+1],s[a+2]=e[n+2],s[a+3]=1}return s}return e}}class ji{}ji.Color3=As.BuildArray(3,qe.Black),ji.Color4=As.BuildArray(3,()=>new pi(0,0,0,0)),ur("BABYLON.Color3",qe),ur("BABYLON.Color4",pi);const b2={},v2={},EE=function(l,e,i){const s=l();Bi&&Bi.HasTags(e)&&Bi.AddTagsTo(s,Bi.GetTags(e,!0));const n=t_(s);for(const a in n){const p=n[a],_=e[a],g=p.type;if(_!=null&&(a!=="uniqueId"||Kt.AllowLoadingUniqueId))switch(g){case 0:case 6:case 11:s[a]=_;break;case 1:s[a]=i||_.isRenderTarget?_:_.clone();break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:s[a]=i?_:_.clone();break}}return s};function P9(l){const e=l.getClassName();return b2[e]||(b2[e]={}),b2[e]}function t_(l){const e=l.getClassName();if(v2[e])return v2[e];v2[e]={};const i=v2[e];let s=l,n=e;for(;n;){const a=b2[n];for(const g in a)i[g]=a[g];let p,_=!1;do{if(p=Object.getPrototypeOf(s),!p.getClassName){_=!0;break}if(p.getClassName()!==n)break;s=p}while(p);if(_)break;n=p.getClassName(),s=p}return i}function ba(l,e){return(i,s)=>{const n=P9(i);n[s]||(n[s]={type:l,sourceName:e})}}function O9(l,e=null){return(i,s)=>{const n=e||"_"+s;Object.defineProperty(i,s,{get:function(){return this[n]},set:function(a){typeof this.equals=="function"&&this.equals(a)||this[n]!==a&&(this[n]=a,i[l].apply(this))},enumerable:!0,configurable:!0})}}function He(l,e=null){return O9(l,e)}function xe(l){return ba(0,l)}function qi(l){return ba(1,l)}function Vs(l){return ba(2,l)}function Yh(l){return ba(3,l)}function i_(l){return ba(4,l)}function Rn(l){return ba(5,l)}function AE(l){return ba(6,l)}function w9(l){return ba(7,l)}function CE(l){return ba(8,l)}function RE(l){return ba(9,l)}function D9(l){return ba(10,l)}function F9(l){return ba(12,l)}function qY(l){return ba(11,l)}class Kt{static AppendSerializedAnimations(e,i){if(e.animations){i.animations=[];for(let s=0;s<e.animations.length;s++){const n=e.animations[s];i.animations.push(n.serialize())}}}static Serialize(e,i){i||(i={}),Bi&&(i.tags=Bi.GetTags(e));const s=t_(e);for(const n in s){const a=s[n],p=a.sourceName||n,_=a.type,g=e[n];if(g!=null&&(n!=="uniqueId"||Kt.AllowLoadingUniqueId))switch(_){case 0:i[p]=g;break;case 1:i[p]=g.serialize();break;case 2:i[p]=g.asArray();break;case 3:i[p]=g.serialize();break;case 4:i[p]=g.asArray();break;case 5:i[p]=g.asArray();break;case 6:i[p]=g.id;break;case 7:i[p]=g.serialize();break;case 8:i[p]=g.asArray();break;case 9:i[p]=g.serialize();break;case 10:i[p]=g.asArray();break;case 11:i[p]=g.id;break;case 12:i[p]=g.asArray();break}}return i}static ParseProperties(e,i,s,n){n||(n="");const a=t_(i);for(const p in a){const _=a[p],g=e[_.sourceName||p],y=_.type;if(g!=null&&(p!=="uniqueId"||Kt.AllowLoadingUniqueId)){const b=i;switch(y){case 0:b[p]=g;break;case 1:s&&(b[p]=Kt._TextureParser(g,s,n));break;case 2:b[p]=qe.FromArray(g);break;case 3:b[p]=Kt._FresnelParametersParser(g);break;case 4:b[p]=ii.FromArray(g);break;case 5:b[p]=j.FromArray(g);break;case 6:s&&(b[p]=s.getLastMeshById(g));break;case 7:b[p]=Kt._ColorCurvesParser(g);break;case 8:b[p]=pi.FromArray(g);break;case 9:b[p]=Kt._ImageProcessingConfigurationParser(g);break;case 10:b[p]=Ve.FromArray(g);break;case 11:s&&(b[p]=s.getCameraById(g));break;case 12:b[p]=fe.FromArray(g);break}}}}static Parse(e,i,s,n=null){const a=e();return Bi&&Bi.AddTagsTo(a,i.tags),Kt.ParseProperties(i,a,s,n),a}static Clone(e,i){return EE(e,i,!1)}static Instanciate(e,i){return EE(e,i,!0)}}Kt.AllowLoadingUniqueId=!1,Kt._ImageProcessingConfigurationParser=l=>{throw xi("ImageProcessingConfiguration")},Kt._FresnelParametersParser=l=>{throw xi("FresnelParameters")},Kt._ColorCurvesParser=l=>{throw xi("ColorCurves")},Kt._TextureParser=(l,e,i)=>{throw xi("Texture")};function bx(l,e,i,s){const n=i.value;i.value=(...a)=>{let p=n;if(typeof _native<"u"&&_native[e]){const _=_native[e];s?p=(...g)=>s(...g)?_(...g):n(...g):p=_}return l[e]=p,p(...a)}}bx.filter=function(l){return(e,i,s)=>bx(e,i,s,l)};class ja{constructor(e){if(this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e,e)for(const i in e)Object.prototype.hasOwnProperty.call(e,i)&&this._setDefaultValue(i)}get isDirty(){return this._isDirty}markAsProcessed(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1}markAsUnprocessed(){this._isDirty=!0}markAllAsDirty(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._areImageProcessingDirty=!0,this._isDirty=!0}markAsImageProcessingDirty(){this._areImageProcessingDirty=!0,this._isDirty=!0}markAsLightDirty(e=!1){this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0}markAsAttributesDirty(){this._areAttributesDirty=!0,this._isDirty=!0}markAsTexturesDirty(){this._areTexturesDirty=!0,this._isDirty=!0}markAsFresnelDirty(){this._areFresnelDirty=!0,this._isDirty=!0}markAsMiscDirty(){this._areMiscDirty=!0,this._isDirty=!0}markAsPrePassDirty(){this._arePrePassDirty=!0,this._isDirty=!0}rebuild(){this._keys.length=0;for(const e of Object.keys(this))e[0]!=="_"&&this._keys.push(e);if(this._externalProperties)for(const e in this._externalProperties)this._keys.indexOf(e)===-1&&this._keys.push(e)}isEqual(e){if(this._keys.length!==e._keys.length)return!1;for(let i=0;i<this._keys.length;i++){const s=this._keys[i];if(this[s]!==e[s])return!1}return!0}cloneTo(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(let i=0;i<this._keys.length;i++){const s=this._keys[i];e[s]=this[s]}}reset(){this._keys.forEach(e=>this._setDefaultValue(e))}_setDefaultValue(e){var i,s,n,a,p;const _=(n=(s=(i=this._externalProperties)===null||i===void 0?void 0:i[e])===null||s===void 0?void 0:s.type)!==null&&n!==void 0?n:typeof this[e],g=(p=(a=this._externalProperties)===null||a===void 0?void 0:a[e])===null||p===void 0?void 0:p.default;switch(_){case"number":this[e]=g??0;break;case"string":this[e]=g??"";break;default:this[e]=g??!1;break}}toString(){let e="";for(let i=0;i<this._keys.length;i++){const s=this._keys[i],n=this[s];switch(typeof n){case"number":case"string":e+="#define "+s+" "+n+`
`;break;default:n&&(e+="#define "+s+`
`);break}}return e}}class Ar{constructor(){this._dirty=!0,this._tempColor=new pi(0,0,0,0),this._globalCurve=new pi(0,0,0,0),this._highlightsCurve=new pi(0,0,0,0),this._midtonesCurve=new pi(0,0,0,0),this._shadowsCurve=new pi(0,0,0,0),this._positiveCurve=new pi(0,0,0,0),this._negativeCurve=new pi(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,i,s="vCameraColorCurvePositive",n="vCameraColorCurveNeutral",a="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),i&&(i.setFloat4(s,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),i.setFloat4(n,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),i.setFloat4(a,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}static PrepareUniforms(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}_getColorGradingDataToRef(e,i,s,n,a){e!=null&&(e=Ar._Clamp(e,0,360),i=Ar._Clamp(i,-100,100),s=Ar._Clamp(s,-100,100),n=Ar._Clamp(n,-100,100),i=Ar._ApplyColorGradingSliderNonlinear(i),i*=.5,n=Ar._ApplyColorGradingSliderNonlinear(n),i<0&&(i*=-1,e=(e+180)%360),Ar._FromHSBToRef(e,i,50+.25*n,a),a.scaleToRef(2,a),a.a=1+.01*s)}static _ApplyColorGradingSliderNonlinear(e){e/=100;let i=Math.abs(e);return i=Math.pow(i,2),e<0&&(i*=-1),i*=100,i}static _FromHSBToRef(e,i,s,n){let a=Ar._Clamp(e,0,360);const p=Ar._Clamp(i/100,0,1),_=Ar._Clamp(s/100,0,1);if(p===0)n.r=_,n.g=_,n.b=_;else{a/=60;const g=Math.floor(a),y=a-g,b=_*(1-p),v=_*(1-p*y),S=_*(1-p*(1-y));switch(g){case 0:n.r=_,n.g=S,n.b=b;break;case 1:n.r=v,n.g=_,n.b=b;break;case 2:n.r=b,n.g=_,n.b=S;break;case 3:n.r=b,n.g=v,n.b=_;break;case 4:n.r=S,n.g=b,n.b=_;break;default:n.r=_,n.g=b,n.b=v;break}}n.a=1}static _Clamp(e,i,s){return Math.min(Math.max(e,i),s)}clone(){return Kt.Clone(()=>new Ar,this)}serialize(){return Kt.Serialize(this)}static Parse(e){return Kt.Parse(()=>new Ar,e,null,null)}}J([xe()],Ar.prototype,"_globalHue",void 0),J([xe()],Ar.prototype,"_globalDensity",void 0),J([xe()],Ar.prototype,"_globalSaturation",void 0),J([xe()],Ar.prototype,"_globalExposure",void 0),J([xe()],Ar.prototype,"_highlightsHue",void 0),J([xe()],Ar.prototype,"_highlightsDensity",void 0),J([xe()],Ar.prototype,"_highlightsSaturation",void 0),J([xe()],Ar.prototype,"_highlightsExposure",void 0),J([xe()],Ar.prototype,"_midtonesHue",void 0),J([xe()],Ar.prototype,"_midtonesDensity",void 0),J([xe()],Ar.prototype,"_midtonesSaturation",void 0),J([xe()],Ar.prototype,"_midtonesExposure",void 0),Kt._ColorCurvesParser=Ar.Parse;class L9 extends ja{constructor(){super(),this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.EXPOSURE=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}}class Oi{constructor(){this.colorCurves=new Ar,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=Oi.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new pi(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=Oi.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new Re}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}static PrepareUniforms(e,i){i.EXPOSURE&&e.push("exposureLinear"),i.CONTRAST&&e.push("contrast"),i.COLORGRADING&&e.push("colorTransformSettings"),(i.VIGNETTE||i.DITHER)&&e.push("vInverseScreenSize"),i.VIGNETTE&&(e.push("vignetteSettings1"),e.push("vignetteSettings2")),i.COLORCURVES&&Ar.PrepareUniforms(e),i.DITHER&&e.push("ditherIntensity")}static PrepareSamplers(e,i){i.COLORGRADING&&e.push("txColorTransform")}prepareDefines(e,i=!1){if(i!==this.applyByPostProcess||!this._isEnabled){e.VIGNETTE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled;return}switch(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===Oi._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,e.TONEMAPPING=this.toneMappingEnabled,this._toneMappingType){case Oi.TONEMAPPING_ACES:e.TONEMAPPING_ACES=!0;break;default:e.TONEMAPPING_ACES=!1;break}e.CONTRAST=this.contrast!==1,e.EXPOSURE=this.exposure!==1,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,i){if(this._colorCurvesEnabled&&this.colorCurves&&Ar.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){const s=1/e.getEngine().getRenderWidth(),n=1/e.getEngine().getRenderHeight();if(e.setFloat2("vInverseScreenSize",s,n),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){const a=i??n/s;let p=Math.tan(this.vignetteCameraFov*.5),_=p*a;const g=Math.sqrt(_*p);_=Le.Mix(_,g,this.vignetteStretch),p=Le.Mix(p,g,this.vignetteStretch),e.setFloat4("vignetteSettings1",_,p,-_*this.vignetteCenterX,-p*this.vignetteCenterY);const y=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,y)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);const s=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(s-1)/s,.5/s,s,this.colorGradingTexture.level)}}clone(){return Kt.Clone(()=>new Oi,this)}serialize(){return Kt.Serialize(this)}static Parse(e){const i=Kt.Parse(()=>new Oi,e,null,null);return e.vignetteCentreX!==void 0&&(i.vignetteCenterX=e.vignetteCentreX),e.vignetteCentreY!==void 0&&(i.vignetteCenterY=e.vignetteCentreY),i}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}}Oi.TONEMAPPING_STANDARD=0,Oi.TONEMAPPING_ACES=1,Oi._VIGNETTEMODE_MULTIPLY=0,Oi._VIGNETTEMODE_OPAQUE=1,J([w9()],Oi.prototype,"colorCurves",void 0),J([xe()],Oi.prototype,"_colorCurvesEnabled",void 0),J([qi("colorGradingTexture")],Oi.prototype,"_colorGradingTexture",void 0),J([xe()],Oi.prototype,"_colorGradingEnabled",void 0),J([xe()],Oi.prototype,"_colorGradingWithGreenDepth",void 0),J([xe()],Oi.prototype,"_colorGradingBGR",void 0),J([xe()],Oi.prototype,"_exposure",void 0),J([xe()],Oi.prototype,"_toneMappingEnabled",void 0),J([xe()],Oi.prototype,"_toneMappingType",void 0),J([xe()],Oi.prototype,"_contrast",void 0),J([xe()],Oi.prototype,"vignetteStretch",void 0),J([xe()],Oi.prototype,"vignetteCenterX",void 0),J([xe()],Oi.prototype,"vignetteCenterY",void 0),J([xe()],Oi.prototype,"vignetteWeight",void 0),J([CE()],Oi.prototype,"vignetteColor",void 0),J([xe()],Oi.prototype,"vignetteCameraFov",void 0),J([xe()],Oi.prototype,"_vignetteBlendMode",void 0),J([xe()],Oi.prototype,"_vignetteEnabled",void 0),J([xe()],Oi.prototype,"_ditheringEnabled",void 0),J([xe()],Oi.prototype,"_ditheringIntensity",void 0),J([xe()],Oi.prototype,"_skipFinalColorClamp",void 0),J([xe()],Oi.prototype,"_applyByPostProcess",void 0),J([xe()],Oi.prototype,"_isEnabled",void 0),Kt._ImageProcessingConfigurationParser=Oi.Parse,Yt.prototype.createUniformBuffer=function(l){const e=this._gl.createBuffer();if(!e)throw new Error("Unable to create uniform buffer");const i=new kh(e);return this.bindUniformBuffer(i),l instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,l,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(l),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),i.references=1,i},Yt.prototype.createDynamicUniformBuffer=function(l){const e=this._gl.createBuffer();if(!e)throw new Error("Unable to create dynamic uniform buffer");const i=new kh(e);return this.bindUniformBuffer(i),l instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,l,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(l),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),i.references=1,i},Yt.prototype.updateUniformBuffer=function(l,e,i,s){this.bindUniformBuffer(l),i===void 0&&(i=0),s===void 0?e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,e):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,new Float32Array(e)):e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,e.subarray(i,i+s)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(e).subarray(i,i+s)),this.bindUniformBuffer(null)},Yt.prototype.bindUniformBuffer=function(l){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,l?l.underlyingResource:null)},Yt.prototype.bindUniformBufferBase=function(l,e,i){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,e,l?l.underlyingResource:null)},Yt.prototype.bindUniformBlock=function(l,e,i){const s=l.program,n=this._gl.getUniformBlockIndex(s,e);n!==4294967295&&this._gl.uniformBlockBinding(s,n,i)};class At{constructor(e,i,s,n,a=!1){this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||a,this._dynamic=s,this._name=n??"no-name",this._data=i||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return this._dynamic!==void 0}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(e){let i;if(e<=2?i=e:i=4,this._uniformLocationPointer%i!==0){const s=this._uniformLocationPointer;this._uniformLocationPointer+=i-this._uniformLocationPointer%i;const n=this._uniformLocationPointer-s;for(let a=0;a<n;a++)this._data.push(0)}}addUniform(e,i,s=0){if(this._noUBO||this._uniformLocations[e]!==void 0)return;let n;if(s>0){if(i instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;if(this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:i,arraySize:s},i==16)i=i*s;else{const p=(4-i)*s;i=i*s+p}n=[];for(let a=0;a<i;a++)n.push(0)}else{if(i instanceof Array)n=i,i=n.length;else{i=i,n=[];for(let a=0;a<i;a++)n.push(0)}this._fillAlignment(i)}this._uniformSizes[e]=i,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=i;for(let a=0;a<i;a++)this._data.push(n[a]);this._needSync=!0}addMatrix(e,i){this.addUniform(e,Array.prototype.slice.call(i.toArray()))}addFloat2(e,i,s){const n=[i,s];this.addUniform(e,n)}addFloat3(e,i,s,n){const a=[i,s,n];this.addUniform(e,a)}addColor3(e,i){const s=[i.r,i.g,i.b];this.addUniform(e,s)}addColor4(e,i,s){const n=[i.r,i.g,i.b,s];this.addUniform(e,n)}addVector3(e,i){const s=[i.x,i.y,i.z];this.addUniform(e,s)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_rebuild(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData):this._buffer=this._engine.createUniformBuffer(this._bufferData),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}get currentEffect(){return this._currentEffect}_buffersEqual(e,i){for(let s=0;s<e.length;++s)if(e[s]!==i[s])return!1;return!0}_copyBuffer(e,i){for(let s=0;s<e.length;++s)i[s]=e[s]}update(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(At._UpdatedUbosInFrame[this._name]||(At._UpdatedUbosInFrame[this._name]=0),At._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=this._bufferIndex!==0,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,i,s){this._checkNewFrame();let n=this._uniformLocations[e];if(n===void 0){if(this._buffer){Ie.Error("Cannot add an uniform after UBO has been created.");return}this.addUniform(e,s),n=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let a=0;a<s;a++)this._bufferData[n+a]=i[a];else{let a=!1;for(let p=0;p<s;p++)(s===16&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[n+p]!==Le.FloatRound(i[p]))&&(a=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[n+p]=i[p]);this._needSync=this._needSync||a}}updateUniformArray(e,i,s){this._checkNewFrame();const n=this._uniformLocations[e];if(n===void 0){Ie.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");return}this._buffer||this.create();const a=this._uniformArraySizes[e];if(this._dynamic)for(let p=0;p<s;p++)this._bufferData[n+p]=i[p];else{let p=!1,_=0,g=0;for(let y=0;y<s;y++)if(this._bufferData[n+g*4+_]!==Le.FloatRound(i[y])&&(p=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[n+g*4+_]=i[y]),_++,_===a.strideSize){for(;_<4;_++)this._bufferData[n+g*4+_]=0;_=0,g++}this._needSync=this._needSync||p}}_cacheMatrix(e,i){this._checkNewFrame();const s=this._valueCache[e],n=i.updateFlag;return s!==void 0&&s===n?!1:(this._valueCache[e]=n,!0)}_updateMatrix3x3ForUniform(e,i){for(let s=0;s<3;s++)At._TempBuffer[s*4]=i[s*3],At._TempBuffer[s*4+1]=i[s*3+1],At._TempBuffer[s*4+2]=i[s*3+2],At._TempBuffer[s*4+3]=0;this.updateUniform(e,At._TempBuffer,12)}_updateMatrix3x3ForEffect(e,i){this._currentEffect.setMatrix3x3(e,i)}_updateMatrix2x2ForEffect(e,i){this._currentEffect.setMatrix2x2(e,i)}_updateMatrix2x2ForUniform(e,i){for(let s=0;s<2;s++)At._TempBuffer[s*4]=i[s*2],At._TempBuffer[s*4+1]=i[s*2+1],At._TempBuffer[s*4+2]=0,At._TempBuffer[s*4+3]=0;this.updateUniform(e,At._TempBuffer,8)}_updateFloatForEffect(e,i){this._currentEffect.setFloat(e,i)}_updateFloatForUniform(e,i){At._TempBuffer[0]=i,this.updateUniform(e,At._TempBuffer,1)}_updateFloat2ForEffect(e,i,s,n=""){this._currentEffect.setFloat2(e+n,i,s)}_updateFloat2ForUniform(e,i,s){At._TempBuffer[0]=i,At._TempBuffer[1]=s,this.updateUniform(e,At._TempBuffer,2)}_updateFloat3ForEffect(e,i,s,n,a=""){this._currentEffect.setFloat3(e+a,i,s,n)}_updateFloat3ForUniform(e,i,s,n){At._TempBuffer[0]=i,At._TempBuffer[1]=s,At._TempBuffer[2]=n,this.updateUniform(e,At._TempBuffer,3)}_updateFloat4ForEffect(e,i,s,n,a,p=""){this._currentEffect.setFloat4(e+p,i,s,n,a)}_updateFloat4ForUniform(e,i,s,n,a){At._TempBuffer[0]=i,At._TempBuffer[1]=s,At._TempBuffer[2]=n,At._TempBuffer[3]=a,this.updateUniform(e,At._TempBuffer,4)}_updateFloatArrayForEffect(e,i){this._currentEffect.setFloatArray(e,i)}_updateFloatArrayForUniform(e,i){this.updateUniformArray(e,i,i.length)}_updateArrayForEffect(e,i){this._currentEffect.setArray(e,i)}_updateArrayForUniform(e,i){this.updateUniformArray(e,i,i.length)}_updateIntArrayForEffect(e,i){this._currentEffect.setIntArray(e,i)}_updateIntArrayForUniform(e,i){At._TempBufferInt32View.set(i),this.updateUniformArray(e,At._TempBuffer,i.length)}_updateUIntArrayForEffect(e,i){this._currentEffect.setUIntArray(e,i)}_updateUIntArrayForUniform(e,i){At._TempBufferUInt32View.set(i),this.updateUniformArray(e,At._TempBuffer,i.length)}_updateMatrixForEffect(e,i){this._currentEffect.setMatrix(e,i)}_updateMatrixForUniform(e,i){this._cacheMatrix(e,i)&&this.updateUniform(e,i.toArray(),16)}_updateMatricesForEffect(e,i){this._currentEffect.setMatrices(e,i)}_updateMatricesForUniform(e,i){this.updateUniform(e,i,i.length)}_updateVector3ForEffect(e,i){this._currentEffect.setVector3(e,i)}_updateVector3ForUniform(e,i){At._TempBuffer[0]=i.x,At._TempBuffer[1]=i.y,At._TempBuffer[2]=i.z,this.updateUniform(e,At._TempBuffer,3)}_updateVector4ForEffect(e,i){this._currentEffect.setVector4(e,i)}_updateVector4ForUniform(e,i){At._TempBuffer[0]=i.x,At._TempBuffer[1]=i.y,At._TempBuffer[2]=i.z,At._TempBuffer[3]=i.w,this.updateUniform(e,At._TempBuffer,4)}_updateColor3ForEffect(e,i,s=""){this._currentEffect.setColor3(e+s,i)}_updateColor3ForUniform(e,i){At._TempBuffer[0]=i.r,At._TempBuffer[1]=i.g,At._TempBuffer[2]=i.b,this.updateUniform(e,At._TempBuffer,3)}_updateColor4ForEffect(e,i,s,n=""){this._currentEffect.setColor4(e+n,i,s)}_updateDirectColor4ForEffect(e,i,s=""){this._currentEffect.setDirectColor4(e+s,i)}_updateColor4ForUniform(e,i,s){At._TempBuffer[0]=i.r,At._TempBuffer[1]=i.g,At._TempBuffer[2]=i.b,At._TempBuffer[3]=s,this.updateUniform(e,At._TempBuffer,4)}_updateDirectColor4ForUniform(e,i){At._TempBuffer[0]=i.r,At._TempBuffer[1]=i.g,At._TempBuffer[2]=i.b,At._TempBuffer[3]=i.a,this.updateUniform(e,At._TempBuffer,4)}_updateIntForEffect(e,i,s=""){this._currentEffect.setInt(e+s,i)}_updateIntForUniform(e,i){At._TempBufferInt32View[0]=i,this.updateUniform(e,At._TempBuffer,1)}_updateInt2ForEffect(e,i,s,n=""){this._currentEffect.setInt2(e+n,i,s)}_updateInt2ForUniform(e,i,s){At._TempBufferInt32View[0]=i,At._TempBufferInt32View[1]=s,this.updateUniform(e,At._TempBuffer,2)}_updateInt3ForEffect(e,i,s,n,a=""){this._currentEffect.setInt3(e+a,i,s,n)}_updateInt3ForUniform(e,i,s,n){At._TempBufferInt32View[0]=i,At._TempBufferInt32View[1]=s,At._TempBufferInt32View[2]=n,this.updateUniform(e,At._TempBuffer,3)}_updateInt4ForEffect(e,i,s,n,a,p=""){this._currentEffect.setInt4(e+p,i,s,n,a)}_updateInt4ForUniform(e,i,s,n,a){At._TempBufferInt32View[0]=i,At._TempBufferInt32View[1]=s,At._TempBufferInt32View[2]=n,At._TempBufferInt32View[3]=a,this.updateUniform(e,At._TempBuffer,4)}_updateUIntForEffect(e,i,s=""){this._currentEffect.setUInt(e+s,i)}_updateUIntForUniform(e,i){At._TempBufferUInt32View[0]=i,this.updateUniform(e,At._TempBuffer,1)}_updateUInt2ForEffect(e,i,s,n=""){this._currentEffect.setUInt2(e+n,i,s)}_updateUInt2ForUniform(e,i,s){At._TempBufferUInt32View[0]=i,At._TempBufferUInt32View[1]=s,this.updateUniform(e,At._TempBuffer,2)}_updateUInt3ForEffect(e,i,s,n,a=""){this._currentEffect.setUInt3(e+a,i,s,n)}_updateUInt3ForUniform(e,i,s,n){At._TempBufferUInt32View[0]=i,At._TempBufferUInt32View[1]=s,At._TempBufferUInt32View[2]=n,this.updateUniform(e,At._TempBuffer,3)}_updateUInt4ForEffect(e,i,s,n,a,p=""){this._currentEffect.setUInt4(e+p,i,s,n,a)}_updateUInt4ForUniform(e,i,s,n,a){At._TempBufferUInt32View[0]=i,At._TempBufferUInt32View[1]=s,At._TempBufferUInt32View[2]=n,At._TempBufferUInt32View[3]=a,this.updateUniform(e,At._TempBuffer,4)}setTexture(e,i){this._currentEffect.setTexture(e,i)}updateUniformDirectly(e,i){this.updateUniform(e,i,i.length),this.update()}bindToEffect(e,i){this._currentEffect=e,this._currentEffectName=i}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let i=0;i<this._buffers.length;++i)if(this._buffers[i][0]===e)return this._bufferIndex=i,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0;return!1}dispose(){if(this._noUBO)return;const e=this._engine._uniformBuffers,i=e.indexOf(this);if(i!==-1&&(e[i]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let s=0;s<this._buffers.length;++s){const n=this._buffers[s][0];this._engine._releaseBuffer(n)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}}At._UpdatedUbosInFrame={},At._MAX_UNIFORM_SIZE=256,At._TempBuffer=new Float32Array(At._MAX_UNIFORM_SIZE),At._TempBufferInt32View=new Int32Array(At._TempBuffer.buffer),At._TempBufferUInt32View=new Uint32Array(At._TempBuffer.buffer);class bc{constructor(e,i,s,n=0,a=!1,p=!1,_=!1,g){this._isAlreadyOwned=!1,e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=s,this._instanced=p,this._divisor=g||1,i instanceof Bh?(this._data=null,this._buffer=i):(this._data=i,this._buffer=null),this.byteStride=_?n:n*Float32Array.BYTES_PER_ELEMENT,a||this.create()}createVertexBuffer(e,i,s,n,a,p=!1,_){const g=p?i:i*Float32Array.BYTES_PER_ELEMENT,y=n?p?n:n*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new te(this._engine,this,e,this._updatable,!0,y,a===void 0?this._instanced:a,g,s,void 0,void 0,!0,this._divisor||_)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data,e&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e),this._data=e):this._buffer=this._engine.createVertexBuffer(e)))}_rebuild(){this._buffer=null,this.create(this._data)}update(e){this.create(e)}updateDirectly(e,i,s,n=!1){!this._buffer||this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,n?i:i*Float32Array.BYTES_PER_ELEMENT,s?s*this.byteStride:void 0),i===0&&s===void 0?this._data=e:this._data=null)}_increaseReferences(){if(!!this._buffer){if(!this._isAlreadyOwned){this._isAlreadyOwned=!0;return}this._buffer.references++}}dispose(){!this._buffer||this._engine._releaseBuffer(this._buffer)&&(this._buffer=null,this._data=null)}}class te{get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){const i=e!=0;this._instanceDivisor=e,i!==this._instanced&&(this._instanced=i,this._computeHashCode())}constructor(e,i,s,n,a,p,_,g,y,b,v=!1,S=!1,M=1,F=!1){if(i instanceof bc?(this._buffer=i,this._ownsBuffer=F):(this._buffer=new bc(e,i,n,p,a,_,S),this._ownsBuffer=!0),this.uniqueId=te._Counter++,this._kind=s,b==null){const N=this.getData();this.type=te.FLOAT,N instanceof Int8Array?this.type=te.BYTE:N instanceof Uint8Array?this.type=te.UNSIGNED_BYTE:N instanceof Int16Array?this.type=te.SHORT:N instanceof Uint16Array?this.type=te.UNSIGNED_SHORT:N instanceof Int32Array?this.type=te.INT:N instanceof Uint32Array&&(this.type=te.UNSIGNED_INT)}else this.type=b;const L=te.GetTypeByteLength(this.type);S?(this._size=y||(p?p/L:te.DeduceStride(s)),this.byteStride=p||this._buffer.byteStride||this._size*L,this.byteOffset=g||0):(this._size=y||p||te.DeduceStride(s),this.byteStride=p?p*L:this._buffer.byteStride||this._size*L,this.byteOffset=(g||0)*L),this.normalized=v,this._instanced=_!==void 0?_:!1,this._instanceDivisor=_?M:0,this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){!this._buffer||this._buffer._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,i){const s=this.getData();if(!s)return null;const n=this.getSize()*te.GetTypeByteLength(this.type),a=e*this.getSize();if(this.type!==te.FLOAT||this.byteStride!==n){const p=new Float32Array(a);return this.forEach(a,(_,g)=>p[g]=_),p}if(!(s instanceof Array||s instanceof Float32Array)||this.byteOffset!==0||s.length!==a)if(s instanceof Array){const p=this.byteOffset/4;return s.slice(p,p+a)}else{if(s instanceof ArrayBuffer)return new Float32Array(s,this.byteOffset,a);{let p=s.byteOffset+this.byteOffset;if(i){const g=new Float32Array(a),y=new Float32Array(s.buffer,p,a);return g.set(y),g}const _=p%4;return _&&(p=Math.max(0,p-_)),new Float32Array(s.buffer,p,a)}}return i?s.slice():s}getBuffer(){return this._buffer.getBuffer()}getStrideSize(){return this.byteStride/te.GetTypeByteLength(this.type)}getOffset(){return this.byteOffset/te.GetTypeByteLength(this.type)}getSize(e=!1){return e?this._size*te.GetTypeByteLength(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e)}update(e){this._buffer.update(e)}updateDirectly(e,i,s=!1){this._buffer.updateDirectly(e,i,void 0,s)}dispose(){this._ownsBuffer&&this._buffer.dispose()}forEach(e,i){te.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,i)}static DeduceStride(e){switch(e){case te.UVKind:case te.UV2Kind:case te.UV3Kind:case te.UV4Kind:case te.UV5Kind:case te.UV6Kind:return 2;case te.NormalKind:case te.PositionKind:return 3;case te.ColorKind:case te.MatricesIndicesKind:case te.MatricesIndicesExtraKind:case te.MatricesWeightsKind:case te.MatricesWeightsExtraKind:case te.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetTypeByteLength(e){switch(e){case te.BYTE:case te.UNSIGNED_BYTE:return 1;case te.SHORT:case te.UNSIGNED_SHORT:return 2;case te.INT:case te.UNSIGNED_INT:case te.FLOAT:return 4;default:throw new Error(`Invalid type '${e}'`)}}static ForEach(e,i,s,n,a,p,_,g){if(e instanceof Array){let y=i/4;const b=s/4;for(let v=0;v<p;v+=n){for(let S=0;S<n;S++)g(e[y+S],v+S);y+=b}}else{const y=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),b=te.GetTypeByteLength(a);for(let v=0;v<p;v+=n){let S=i;for(let M=0;M<n;M++){const F=te._GetFloatValue(y,a,S,_);g(F,v+M),S+=b}i+=s}}}static _GetFloatValue(e,i,s,n){switch(i){case te.BYTE:{let a=e.getInt8(s);return n&&(a=Math.max(a/127,-1)),a}case te.UNSIGNED_BYTE:{let a=e.getUint8(s);return n&&(a=a/255),a}case te.SHORT:{let a=e.getInt16(s,!0);return n&&(a=Math.max(a/32767,-1)),a}case te.UNSIGNED_SHORT:{let a=e.getUint16(s,!0);return n&&(a=a/65535),a}case te.INT:return e.getInt32(s,!0);case te.UNSIGNED_INT:return e.getUint32(s,!0);case te.FLOAT:return e.getFloat32(s,!0);default:throw new Error(`Invalid component type ${i}`)}}}te._Counter=0,te.BYTE=5120,te.UNSIGNED_BYTE=5121,te.SHORT=5122,te.UNSIGNED_SHORT=5123,te.INT=5124,te.UNSIGNED_INT=5125,te.FLOAT=5126,te.PositionKind="position",te.NormalKind="normal",te.TangentKind="tangent",te.UVKind="uv",te.UV2Kind="uv2",te.UV3Kind="uv3",te.UV4Kind="uv4",te.UV5Kind="uv5",te.UV6Kind="uv6",te.ColorKind="color",te.ColorInstanceKind="instanceColor",te.MatricesIndicesKind="matricesIndices",te.MatricesWeightsKind="matricesWeights",te.MatricesIndicesExtraKind="matricesIndicesExtra",te.MatricesWeightsExtraKind="matricesWeightsExtra";class In{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,i=!0){if(!this.pickedMesh||i&&!this.pickedMesh.isVerticesDataPresent(te.NormalKind))return null;const s=this.pickedMesh.getIndices();if(!s)return null;let n;if(i){const p=this.pickedMesh.getVerticesData(te.NormalKind);let _=j.FromArray(p,s[this.faceId*3]*3),g=j.FromArray(p,s[this.faceId*3+1]*3),y=j.FromArray(p,s[this.faceId*3+2]*3);_=_.scale(this.bu),g=g.scale(this.bv),y=y.scale(1-this.bu-this.bv),n=new j(_.x+g.x+y.x,_.y+g.y+y.y,_.z+g.z+y.z)}else{const p=this.pickedMesh.getVerticesData(te.PositionKind),_=j.FromArray(p,s[this.faceId*3]*3),g=j.FromArray(p,s[this.faceId*3+1]*3),y=j.FromArray(p,s[this.faceId*3+2]*3),b=_.subtract(g),v=y.subtract(g);n=j.Cross(b,v)}const a=(p,_)=>{let g=p.getWorldMatrix();p.nonUniformScaling&&(ge.Matrix[0].copyFrom(g),g=ge.Matrix[0],g.setTranslationFromFloats(0,0,0),g.invert(),g.transposeToRef(ge.Matrix[1]),g=ge.Matrix[1]),j.TransformNormalToRef(_,g,_)};if(e&&a(this.pickedMesh,n),this.ray){const p=ge.Vector3[0].copyFrom(n);e||a(this.pickedMesh,p),j.Dot(p,this.ray.direction)>0&&n.negateInPlace()}return n.normalize(),n}getTextureCoordinates(e=te.UVKind){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e))return null;const i=this.pickedMesh.getIndices();if(!i)return null;const s=this.pickedMesh.getVerticesData(e);if(!s)return null;let n=ii.FromArray(s,i[this.faceId*3]*2),a=ii.FromArray(s,i[this.faceId*3+1]*2),p=ii.FromArray(s,i[this.faceId*3+2]*2);return n=n.scale(this.bu),a=a.scale(this.bv),p=p.scale(1-this.bu-this.bv),new ii(n.x+a.x+p.x,n.y+a.y+p.y)}}class Os{constructor(e,i,s,n,a,p){this.source=e,this.pointerX=i,this.pointerY=s,this.meshUnderPointer=n,this.sourceEvent=a,this.additionalData=p}static CreateNew(e,i,s){const n=e.getScene();return new Os(e,n.pointerX,n.pointerY,n.meshUnderPointer||e,i,s)}static CreateNewFromSprite(e,i,s,n){return new Os(e,i.pointerX,i.pointerY,i.meshUnderPointer,s,n)}static CreateNewFromScene(e,i){return new Os(null,e.pointerX,e.pointerY,e.meshUnderPointer,i)}static CreateNewFromPrimitive(e,i,s,n){return new Os(e,i.x,i.y,null,s,n)}}class r_{constructor(e){this._vertexBuffers={},this._scene=e}_prepareBuffers(){if(this._vertexBuffers[te.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[te.PositionKind]=new te(this._scene.getEngine(),e,te.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){const e=this._vertexBuffers[te.PositionKind];!e||(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,i=null){const s=this._scene.activeCamera;return!s||(i=i||s._postProcesses.filter(n=>n!=null),!i||i.length===0||!this._scene.postProcessesEnabled)?!1:(i[0].activate(s,e,i!=null),!0)}directRender(e,i=null,s=!1,n=0,a=0,p=!1){var _;const g=this._scene.getEngine();for(let y=0;y<e.length;y++){y<e.length-1?e[y+1].activate(this._scene.activeCamera,i?.texture):(i?g.bindFramebuffer(i,n,void 0,void 0,s,a):p||g.restoreDefaultFramebuffer(),(_=g._debugInsertMarker)===null||_===void 0||_.call(g,`post process ${e[y].name} output`));const b=e[y],v=b.apply();v&&(b.onBeforeRenderObservable.notifyObservers(v),this._prepareBuffers(),g.bindBuffers(this._vertexBuffers,this._indexBuffer,v),g.drawElementsType(0,0,6),b.onAfterRenderObservable.notifyObservers(v))}g.setDepthBuffer(!0),g.setDepthWrite(!0)}_finalizeFrame(e,i,s,n,a=!1){var p;const _=this._scene.activeCamera;if(!_||(n=n||_._postProcesses.filter(y=>y!=null),n.length===0||!this._scene.postProcessesEnabled))return;const g=this._scene.getEngine();for(let y=0,b=n.length;y<b;y++){const v=n[y];if(y<b-1?v._outputTexture=n[y+1].activate(_,i?.texture):(i?(g.bindFramebuffer(i,s,void 0,void 0,a),v._outputTexture=i):(g.restoreDefaultFramebuffer(),v._outputTexture=null),(p=g._debugInsertMarker)===null||p===void 0||p.call(g,`post process ${n[y].name} output`)),e)break;const S=v.apply();S&&(v.onBeforeRenderObservable.notifyObservers(S),this._prepareBuffers(),g.bindBuffers(this._vertexBuffers,this._indexBuffer,S),g.drawElementsType(0,0,6),v.onAfterRenderObservable.notifyObservers(S))}g.setDepthBuffer(!0),g.setDepthWrite(!0),g.setAlphaMode(0)}dispose(){const e=this._vertexBuffers[te.PositionKind];e&&(e.dispose(),this._vertexBuffers[te.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}class yo{set opaqueSortCompareFn(e){e?this._opaqueSortCompareFn=e:this._opaqueSortCompareFn=yo.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){e?this._alphaTestSortCompareFn=e:this._alphaTestSortCompareFn=yo.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){e?this._transparentSortCompareFn=e:this._transparentSortCompareFn=yo.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,i,s=null,n=null,a=null){this.index=e,this._opaqueSubMeshes=new Ps(256),this._transparentSubMeshes=new Ps(256),this._alphaTestSubMeshes=new Ps(256),this._depthOnlySubMeshes=new Ps(256),this._particleSystems=new Ps(256),this._spriteManagers=new Ps(256),this._empty=!0,this._edgesRenderers=new dl(16),this._scene=i,this.opaqueSortCompareFn=s,this.alphaTestSortCompareFn=n,this.transparentSortCompareFn=a}render(e,i,s,n){if(e){e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}const a=this._scene.getEngine();this._depthOnlySubMeshes.length!==0&&(a.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),a.setColorWrite(!0)),this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);const p=a.getStencilBuffer();if(a.setStencilBuffer(!1),i&&this._renderSprites(),s&&this._renderParticles(n),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency){if(a.setStencilBuffer(p),this._scene.useOrderIndependentTransparency){const _=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);_.length&&this._renderTransparent(_)}else this._renderTransparent(this._transparentSubMeshes);a.setAlphaMode(0)}if(a.setStencilBuffer(!1),this._edgesRenderers.length){for(let _=0;_<this._edgesRenderers.length;_++)this._edgesRenderers.data[_].render();a.setAlphaMode(0)}a.setStencilBuffer(p)}_renderOpaqueSorted(e){return yo._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(e){return yo._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(e){return yo._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(e,i,s,n){let a=0,p;const _=s?s.globalPosition:yo._ZeroVector;if(n)for(;a<e.length;a++)p=e.data[a],p._alphaIndex=p.getMesh().alphaIndex,p._distanceToCamera=j.Distance(p.getBoundingInfo().boundingSphere.centerWorld,_);const g=e.length===e.data.length?e.data:e.data.slice(0,e.length);i&&g.sort(i);const y=g[0].getMesh().getScene();for(a=0;a<g.length;a++)if(p=g[a],!(y._activeMeshesFrozenButKeepClipping&&!p.isInFrustum(y._frustumPlanes))){if(n){const b=p.getMaterial();if(b&&b.needDepthPrePass){const v=b.getScene().getEngine();v.setColorWrite(!1),v.setAlphaMode(0),p.render(!1),v.setColorWrite(!0)}}p.render(n)}}static defaultTransparentSortCompare(e,i){return e._alphaIndex>i._alphaIndex?1:e._alphaIndex<i._alphaIndex?-1:yo.backToFrontSortCompare(e,i)}static backToFrontSortCompare(e,i){return e._distanceToCamera<i._distanceToCamera?1:e._distanceToCamera>i._distanceToCamera?-1:0}static frontToBackSortCompare(e,i){return e._distanceToCamera<i._distanceToCamera?-1:e._distanceToCamera>i._distanceToCamera?1:0}static PainterSortCompare(e,i){const s=e.getMesh(),n=i.getMesh();return s.material&&n.material?s.material.uniqueId-n.material.uniqueId:s.uniqueId-n.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,i,s){i===void 0&&(i=e.getMesh()),s===void 0&&(s=e.getMaterial()),s!=null&&(s.needAlphaBlendingForMesh(i)?this._transparentSubMeshes.push(e):s.needAlphaTesting()?(s.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(s.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),i._renderingGroup=this,i._edgesRenderer&&i._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(i._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(this._particleSystems.length===0)return;const i=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let s=0;s<this._particleSystems.length;s++){const n=this._particleSystems.data[s];if((i&&i.layerMask&n.layerMask)===0)continue;const a=n.emitter;(!a.position||!e||e.indexOf(a)!==-1)&&this._scene._activeParticles.addCount(n.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||this._spriteManagers.length===0)return;const e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let i=0;i<this._spriteManagers.length;i++){const s=this._spriteManagers.data[i];(e&&e.layerMask&s.layerMask)!==0&&s.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}yo._ZeroVector=j.Zero();class N9{}class tn{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){if(e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,!this._maintainStateBetweenFrames)){for(const i of this._scene.meshes)if(i.subMeshes)for(const s of i.subMeshes)s._wasDispatched=!1;if(this._scene.spriteManagers)for(const i of this._scene.spriteManagers)i._wasDispatched=!1;for(const i of this._scene.particleSystems)i._wasDispatched=!1}}constructor(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new N9,this._maintainStateBetweenFrames=!1,this._scene=e;for(let i=tn.MIN_RENDERINGGROUPS;i<tn.MAX_RENDERINGGROUPS;i++)this._autoClearDepthStencil[i]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(e){const i=e||0;return this._prepareRenderingGroup(i),this._renderingGroups[i]}_clearDepthStencilBuffer(e=!0,i=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,i),this._depthStencilBufferAlreadyCleaned=!0)}render(e,i,s,n){const a=this._renderingGroupInfo;if(a.scene=this._scene,a.camera=this._scene.activeCamera,this._scene.spriteManagers&&n)for(let p=0;p<this._scene.spriteManagers.length;p++){const _=this._scene.spriteManagers[p];this.dispatchSprites(_)}for(let p=tn.MIN_RENDERINGGROUPS;p<tn.MAX_RENDERINGGROUPS;p++){this._depthStencilBufferAlreadyCleaned=p===tn.MIN_RENDERINGGROUPS;const _=this._renderingGroups[p];if(!_||_._empty)continue;const g=Math.pow(2,p);if(a.renderingGroupId=p,this._scene.onBeforeRenderingGroupObservable.notifyObservers(a,g),tn.AUTOCLEAR){const y=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(p):this._autoClearDepthStencil[p];y&&y.autoClear&&this._clearDepthStencilBuffer(y.depth,y.stencil)}for(const y of this._scene._beforeRenderingGroupDrawStage)y.action(p);_.render(e,n,s,i);for(const y of this._scene._afterRenderingGroupDrawStage)y.action(p);this._scene.onAfterRenderingGroupObservable.notifyObservers(a,g)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=tn.MIN_RENDERINGGROUPS;e<tn.MAX_RENDERINGGROUPS;e++){const i=this._renderingGroups[e];i&&i.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=tn.MIN_RENDERINGGROUPS;e<tn.MAX_RENDERINGGROUPS;e++){const i=this._renderingGroups[e];i&&i.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=tn.MIN_RENDERINGGROUPS;e<tn.MAX_RENDERINGGROUPS;e++){const i=this._renderingGroups[e];i&&i.dispose()}}_prepareRenderingGroup(e){this._renderingGroups[e]===void 0&&(this._renderingGroups[e]=new yo(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,i,s){i===void 0&&(i=e.getMesh()),!(this.maintainStateBetweenFrames&&e._wasDispatched)&&(e._wasDispatched=!0,this.getRenderingGroup(i.renderingGroupId).dispatch(e,i,s))}setRenderingOrder(e,i=null,s=null,n=null){if(this._customOpaqueSortCompareFn[e]=i,this._customAlphaTestSortCompareFn[e]=s,this._customTransparentSortCompareFn[e]=n,this._renderingGroups[e]){const a=this._renderingGroups[e];a.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],a.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],a.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,i,s=!0,n=!0){this._autoClearDepthStencil[e]={autoClear:i,depth:s,stencil:n}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}}tn.MAX_RENDERINGGROUPS=4,tn.MIN_RENDERINGGROUPS=0,tn.AUTOCLEAR=!0;class Vt{}Vt.NAME_EFFECTLAYER="EffectLayer",Vt.NAME_LAYER="Layer",Vt.NAME_LENSFLARESYSTEM="LensFlareSystem",Vt.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer",Vt.NAME_PARTICLESYSTEM="ParticleSystem",Vt.NAME_GAMEPAD="Gamepad",Vt.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue",Vt.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer",Vt.NAME_PREPASSRENDERER="PrePassRenderer",Vt.NAME_DEPTHRENDERER="DepthRenderer",Vt.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer",Vt.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager",Vt.NAME_SPRITE="Sprite",Vt.NAME_SUBSURFACE="SubSurface",Vt.NAME_OUTLINERENDERER="Outline",Vt.NAME_PROCEDURALTEXTURE="ProceduralTexture",Vt.NAME_SHADOWGENERATOR="ShadowGenerator",Vt.NAME_OCTREE="Octree",Vt.NAME_PHYSICSENGINE="PhysicsEngine",Vt.NAME_AUDIO="Audio",Vt.NAME_FLUIDRENDERER="FluidRenderer",Vt.STEP_ISREADYFORMESH_EFFECTLAYER=0,Vt.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0,Vt.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0,Vt.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0,Vt.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1,Vt.STEP_BEFORECAMERADRAW_PREPASS=0,Vt.STEP_BEFORECAMERADRAW_EFFECTLAYER=1,Vt.STEP_BEFORECAMERADRAW_LAYER=2,Vt.STEP_BEFORERENDERTARGETDRAW_PREPASS=0,Vt.STEP_BEFORERENDERTARGETDRAW_LAYER=1,Vt.STEP_BEFORERENDERINGMESH_PREPASS=0,Vt.STEP_BEFORERENDERINGMESH_OUTLINE=1,Vt.STEP_AFTERRENDERINGMESH_PREPASS=0,Vt.STEP_AFTERRENDERINGMESH_OUTLINE=1,Vt.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0,Vt.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1,Vt.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0,Vt.STEP_BEFORECAMERAUPDATE_GAMEPAD=1,Vt.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0,Vt.STEP_BEFORECLEAR_PREPASS=1,Vt.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0,Vt.STEP_AFTERRENDERTARGETDRAW_PREPASS=0,Vt.STEP_AFTERRENDERTARGETDRAW_LAYER=1,Vt.STEP_AFTERCAMERADRAW_PREPASS=0,Vt.STEP_AFTERCAMERADRAW_EFFECTLAYER=1,Vt.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2,Vt.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3,Vt.STEP_AFTERCAMERADRAW_LAYER=4,Vt.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5,Vt.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0,Vt.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0,Vt.STEP_AFTERRENDER_AUDIO=0,Vt.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0,Vt.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1,Vt.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2,Vt.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3,Vt.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0,Vt.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1,Vt.STEP_POINTERMOVE_SPRITE=0,Vt.STEP_POINTERDOWN_SPRITE=0,Vt.STEP_POINTERUP_SPRITE=0;class Nr extends Array{constructor(e){super(...e)}static Create(){return Object.create(Nr.prototype)}registerStep(e,i,s){let n=0,a=Number.MAX_VALUE;for(;n<this.length&&(a=this[n].index,!(e<a));n++);this.splice(n,0,{index:e,component:i,action:s.bind(i)})}clear(){this.length=0}}class Lt{}Lt.POINTERDOWN=1,Lt.POINTERUP=2,Lt.POINTERMOVE=4,Lt.POINTERWHEEL=8,Lt.POINTERPICK=16,Lt.POINTERTAP=32,Lt.POINTERDOUBLETAP=64;class IE{constructor(e,i){this.type=e,this.event=i}}class B9 extends IE{constructor(e,i,s,n){super(e,i),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new ii(s,n)}}class qa extends IE{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,i,s,n=null){super(e,i),this._pickInfo=s,this._inputManager=n}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}}class va{constructor(){this.hoverCursor="",this.actions=new Array,this.isRecursive=!1}static get HasTriggers(){for(const e in va.Triggers)if(Object.prototype.hasOwnProperty.call(va.Triggers,e))return!0;return!1}static get HasPickTriggers(){for(const e in va.Triggers)if(Object.prototype.hasOwnProperty.call(va.Triggers,e)){const i=parseInt(e);if(i>=1&&i<=7)return!0}return!1}static HasSpecificTrigger(e){for(const i in va.Triggers)if(Object.prototype.hasOwnProperty.call(va.Triggers,i)&&parseInt(i)===e)return!0;return!1}}va.Triggers={};class vc{}vc.KEYDOWN=1,vc.KEYUP=2;class s_{constructor(e,i){this.type=e,this.event=i}}class SE extends s_{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,i){super(e,i),this.type=e,this.event=i,this.skipOnKeyboardObservable=!1}}var Bt;(function(l){l[l.Generic=0]="Generic",l[l.Keyboard=1]="Keyboard",l[l.Mouse=2]="Mouse",l[l.Touch=3]="Touch",l[l.DualShock=4]="DualShock",l[l.Xbox=5]="Xbox",l[l.Switch=6]="Switch",l[l.DualSense=7]="DualSense"})(Bt||(Bt={}));var ri;(function(l){l[l.Horizontal=0]="Horizontal",l[l.Vertical=1]="Vertical",l[l.LeftClick=2]="LeftClick",l[l.MiddleClick=3]="MiddleClick",l[l.RightClick=4]="RightClick",l[l.BrowserBack=5]="BrowserBack",l[l.BrowserForward=6]="BrowserForward",l[l.MouseWheelX=7]="MouseWheelX",l[l.MouseWheelY=8]="MouseWheelY",l[l.MouseWheelZ=9]="MouseWheelZ",l[l.Move=12]="Move"})(ri||(ri={}));var T2;(function(l){l[l.Horizontal=0]="Horizontal",l[l.Vertical=1]="Vertical",l[l.LeftClick=2]="LeftClick",l[l.MiddleClick=3]="MiddleClick",l[l.RightClick=4]="RightClick",l[l.BrowserBack=5]="BrowserBack",l[l.BrowserForward=6]="BrowserForward",l[l.MouseWheelX=7]="MouseWheelX",l[l.MouseWheelY=8]="MouseWheelY",l[l.MouseWheelZ=9]="MouseWheelZ",l[l.DeltaHorizontal=10]="DeltaHorizontal",l[l.DeltaVertical=11]="DeltaVertical"})(T2||(T2={}));var ME;(function(l){l[l.Cross=0]="Cross",l[l.Circle=1]="Circle",l[l.Square=2]="Square",l[l.Triangle=3]="Triangle",l[l.L1=4]="L1",l[l.R1=5]="R1",l[l.L2=6]="L2",l[l.R2=7]="R2",l[l.Share=8]="Share",l[l.Options=9]="Options",l[l.L3=10]="L3",l[l.R3=11]="R3",l[l.DPadUp=12]="DPadUp",l[l.DPadDown=13]="DPadDown",l[l.DPadLeft=14]="DPadLeft",l[l.DPadRight=15]="DPadRight",l[l.Home=16]="Home",l[l.TouchPad=17]="TouchPad",l[l.LStickXAxis=18]="LStickXAxis",l[l.LStickYAxis=19]="LStickYAxis",l[l.RStickXAxis=20]="RStickXAxis",l[l.RStickYAxis=21]="RStickYAxis"})(ME||(ME={}));var PE;(function(l){l[l.Cross=0]="Cross",l[l.Circle=1]="Circle",l[l.Square=2]="Square",l[l.Triangle=3]="Triangle",l[l.L1=4]="L1",l[l.R1=5]="R1",l[l.L2=6]="L2",l[l.R2=7]="R2",l[l.Create=8]="Create",l[l.Options=9]="Options",l[l.L3=10]="L3",l[l.R3=11]="R3",l[l.DPadUp=12]="DPadUp",l[l.DPadDown=13]="DPadDown",l[l.DPadLeft=14]="DPadLeft",l[l.DPadRight=15]="DPadRight",l[l.Home=16]="Home",l[l.TouchPad=17]="TouchPad",l[l.LStickXAxis=18]="LStickXAxis",l[l.LStickYAxis=19]="LStickYAxis",l[l.RStickXAxis=20]="RStickXAxis",l[l.RStickYAxis=21]="RStickYAxis"})(PE||(PE={}));var OE;(function(l){l[l.A=0]="A",l[l.B=1]="B",l[l.X=2]="X",l[l.Y=3]="Y",l[l.LB=4]="LB",l[l.RB=5]="RB",l[l.LT=6]="LT",l[l.RT=7]="RT",l[l.Back=8]="Back",l[l.Start=9]="Start",l[l.LS=10]="LS",l[l.RS=11]="RS",l[l.DPadUp=12]="DPadUp",l[l.DPadDown=13]="DPadDown",l[l.DPadLeft=14]="DPadLeft",l[l.DPadRight=15]="DPadRight",l[l.Home=16]="Home",l[l.LStickXAxis=17]="LStickXAxis",l[l.LStickYAxis=18]="LStickYAxis",l[l.RStickXAxis=19]="RStickXAxis",l[l.RStickYAxis=20]="RStickYAxis"})(OE||(OE={}));var wE;(function(l){l[l.B=0]="B",l[l.A=1]="A",l[l.Y=2]="Y",l[l.X=3]="X",l[l.L=4]="L",l[l.R=5]="R",l[l.ZL=6]="ZL",l[l.ZR=7]="ZR",l[l.Minus=8]="Minus",l[l.Plus=9]="Plus",l[l.LS=10]="LS",l[l.RS=11]="RS",l[l.DPadUp=12]="DPadUp",l[l.DPadDown=13]="DPadDown",l[l.DPadLeft=14]="DPadLeft",l[l.DPadRight=15]="DPadRight",l[l.Home=16]="Home",l[l.Capture=17]="Capture",l[l.LStickXAxis=18]="LStickXAxis",l[l.LStickYAxis=19]="LStickYAxis",l[l.RStickXAxis=20]="RStickXAxis",l[l.RStickYAxis=21]="RStickYAxis"})(wE||(wE={}));var DE;(function(l){l[l.PointerMove=0]="PointerMove",l[l.PointerDown=1]="PointerDown",l[l.PointerUp=2]="PointerUp"})(DE||(DE={}));class Tc{}Tc.DOM_DELTA_PIXEL=0,Tc.DOM_DELTA_LINE=1,Tc.DOM_DELTA_PAGE=2;class pl{static CreateDeviceEvent(e,i,s,n,a,p,_){switch(e){case Bt.Keyboard:return this._CreateKeyboardEvent(s,n,a,p);case Bt.Mouse:if(s===ri.MouseWheelX||s===ri.MouseWheelY||s===ri.MouseWheelZ)return this._CreateWheelEvent(e,i,s,n,a,p);case Bt.Touch:return this._CreatePointerEvent(e,i,s,n,a,p,_);default:throw`Unable to generate event for device ${Bt[e]}`}}static _CreatePointerEvent(e,i,s,n,a,p,_){const g=this._CreateMouseEvent(e,i,s,n,a,p);return e===Bt.Mouse?(g.deviceType=Bt.Mouse,g.pointerId=1,g.pointerType="mouse"):(g.deviceType=Bt.Touch,g.pointerId=_??i,g.pointerType="touch"),s===ri.Move?g.type="pointermove":s>=ri.LeftClick&&s<=ri.RightClick&&(g.type=n===1?"pointerdown":"pointerup",g.button=s-2),g}static _CreateWheelEvent(e,i,s,n,a,p){const _=this._CreateMouseEvent(e,i,s,n,a,p);switch(_.pointerId=1,_.type="wheel",_.deltaMode=Tc.DOM_DELTA_PIXEL,_.deltaX=0,_.deltaY=0,_.deltaZ=0,s){case ri.MouseWheelX:_.deltaX=n;break;case ri.MouseWheelY:_.deltaY=n;break;case ri.MouseWheelZ:_.deltaZ=n;break}return _}static _CreateMouseEvent(e,i,s,n,a,p){const _=this._CreateEvent(p),g=a.pollInput(e,i,ri.Horizontal),y=a.pollInput(e,i,ri.Vertical);return p?(_.movementX=0,_.movementY=0,_.offsetX=_.movementX-p.getBoundingClientRect().x,_.offsetY=_.movementY-p.getBoundingClientRect().y):(_.movementX=a.pollInput(e,i,T2.DeltaHorizontal),_.movementY=a.pollInput(e,i,T2.DeltaVertical),_.offsetX=0,_.offsetY=0),this._CheckNonCharacterKeys(_,a),_.clientX=g,_.clientY=y,_.x=g,_.y=y,_.deviceType=e,_.deviceSlot=i,_.inputIndex=s,_}static _CreateKeyboardEvent(e,i,s,n){const a=this._CreateEvent(n);return this._CheckNonCharacterKeys(a,s),a.deviceType=Bt.Keyboard,a.deviceSlot=0,a.inputIndex=e,a.type=i===1?"keydown":"keyup",a.key=String.fromCharCode(e),a.keyCode=e,a}static _CheckNonCharacterKeys(e,i){const s=i.isDeviceAvailable(Bt.Keyboard),n=s&&i.pollInput(Bt.Keyboard,0,18)===1,a=s&&i.pollInput(Bt.Keyboard,0,17)===1,p=s&&(i.pollInput(Bt.Keyboard,0,91)===1||i.pollInput(Bt.Keyboard,0,92)===1||i.pollInput(Bt.Keyboard,0,93)===1),_=s&&i.pollInput(Bt.Keyboard,0,16)===1;e.altKey=n,e.ctrlKey=a,e.metaKey=p,e.shiftKey=_}static _CreateEvent(e){const i={};return i.preventDefault=()=>{},i.target=e,i}}class k9{constructor(e,i,s){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,i,(n,a,p,_)=>{const g=pl.CreateDeviceEvent(n,a,p,_,this);s(n,a,g)}):this._createDummyNativeInput()}pollInput(e,i,s){return this._nativeInput.pollInput(e,i,s)}isDeviceAvailable(e){return e===Bt.Mouse||e===Bt.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}const FE=255,LE=Object.keys(ri).length/2;class U9{constructor(e,i,s,n){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=Le.IsSafari(),this._usingMacOS=zm()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=a=>{},this._keyboardUpEvent=a=>{},this._keyboardBlurEvent=a=>{},this._pointerMoveEvent=a=>{},this._pointerDownEvent=a=>{},this._pointerUpEvent=a=>{},this._pointerCancelEvent=a=>{},this._pointerWheelEvent=a=>{},this._pointerBlurEvent=a=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=Xm.IsNavigatorAvailable()&&navigator.userAgent&&navigator.userAgent.indexOf("Firefox")!==-1,this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=a=>{},this._gamepadDisconnectedEvent=a=>{},this._eventPrefix=Le.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=i,this._onDeviceDisconnected=s,this._onInputChanged=n,this._mouseId=this._isUsingFirefox?0:1,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,i,s){const n=this._inputs[e][i];if(!n)throw`Unable to find device ${Bt[e]}`;e>=Bt.DualShock&&e<=Bt.DualSense&&this._updateDevice(e,i,s);const a=n[s];if(a===void 0)throw`Unable to find input ${s} for device ${Bt[e]} in slot ${i}`;return s===ri.Move&&Le.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),a}isDeviceAvailable(e){return this._inputs[e]!==void 0}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){const e=this===null||this===void 0?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs){for(const i of this._inputs)if(i)for(const s in i){const n=+s,a=i[n];if(a)for(let p=0;p<a.length;p++)a[p]=0}}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=this._elementToAttachTo.tabIndex!==-1?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){const e=navigator.getGamepads();for(const i of e)i&&this._addGamePad(i)}typeof matchMedia=="function"&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(Bt.Mouse,0,0,0)}_addGamePad(e){const i=this._getGamepadDeviceType(e.id),s=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(i,s,e.buttons.length+e.axes.length),this._gamepads[s]=i}_addPointerDevice(e,i,s,n){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,i,LE);const a=this._inputs[e][i];a[0]=s,a[1]=n}_registerDevice(e,i,s){if(i===void 0)throw`Unable to register device ${Bt[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][i]){const n=new Array(s);n.fill(0),this._inputs[e][i]=n,this._onDeviceConnected(e,i)}}_unregisterDevice(e,i){this._inputs[e][i]&&(delete this._inputs[e][i],this._onDeviceDisconnected(e,i))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(Bt.Keyboard,0,FE));const i=this._inputs[Bt.Keyboard][0];if(i){i[e.keyCode]=1;const s=e;s.inputIndex=e.keyCode,this._usingMacOS&&e.metaKey&&e.key!=="Meta"&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(Bt.Keyboard,0,s)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(Bt.Keyboard,0,FE));const i=this._inputs[Bt.Keyboard][0];if(i){i[e.keyCode]=0;const s=e;if(s.inputIndex=e.keyCode,this._usingMacOS&&e.key==="Meta"&&this._metaKeys.length>0){for(const n of this._metaKeys){const a=pl.CreateDeviceEvent(Bt.Keyboard,0,n,0,this,this._elementToAttachTo);i[n]=0,this._onInputChanged(Bt.Keyboard,0,a)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(Bt.Keyboard,0,s)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){const e=this._inputs[Bt.Keyboard][0];for(let i=0;i<e.length;i++)if(e[i]!==0){e[i]=0;const s=pl.CreateDeviceEvent(Bt.Keyboard,0,i,0,this,this._elementToAttachTo);this._onInputChanged(Bt.Keyboard,0,s)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=Xm.IsNavigatorAvailable()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let s=0;s<this._maxTouchPoints;s++)this._activeTouchIds[s]=-1;this._pointerMoveEvent=s=>{const n=this._getPointerType(s),a=n===Bt.Mouse?0:this._activeTouchIds.indexOf(s.pointerId);this._inputs[n]||(this._inputs[n]={}),this._inputs[n][a]||this._addPointerDevice(n,a,s.clientX,s.clientY);const p=this._inputs[n][a];if(p){const _=s;_.inputIndex=ri.Move,p[ri.Horizontal]=s.clientX,p[ri.Vertical]=s.clientY,s.pointerId===void 0&&(s.pointerId=this._mouseId),this._onInputChanged(n,a,_),!this._usingSafari&&s.button!==-1&&(_.inputIndex=s.button+2,p[s.button+2]=p[s.button+2]?0:1,this._onInputChanged(n,a,_))}},this._pointerDownEvent=s=>{const n=this._getPointerType(s);let a=n===Bt.Mouse?0:s.pointerId;if(n===Bt.Touch){const _=this._activeTouchIds.indexOf(-1);if(_>=0)a=_,this._activeTouchIds[_]=s.pointerId;else{Le.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);return}}this._inputs[n]||(this._inputs[n]={}),this._inputs[n][a]?n===Bt.Touch&&this._onDeviceConnected(n,a):this._addPointerDevice(n,a,s.clientX,s.clientY);const p=this._inputs[n][a];if(p){const _=p[ri.Horizontal],g=p[ri.Vertical];if(n===Bt.Mouse){if(s.pointerId===void 0&&(s.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch{}}else if(s.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(s.pointerId)}catch{}p[ri.Horizontal]=s.clientX,p[ri.Vertical]=s.clientY,p[s.button+2]=1;const y=s;y.inputIndex=s.button+2,this._onInputChanged(n,a,y),(_!==s.clientX||g!==s.clientY)&&(y.inputIndex=ri.Move,this._onInputChanged(n,a,y))}},this._pointerUpEvent=s=>{var n,a,p,_,g;const y=this._getPointerType(s),b=y===Bt.Mouse?0:this._activeTouchIds.indexOf(s.pointerId);if(y===Bt.Touch){if(b===-1)return;this._activeTouchIds[b]=-1}const v=(n=this._inputs[y])===null||n===void 0?void 0:n[b];if(v&&v[s.button+2]!==0){const S=v[ri.Horizontal],M=v[ri.Vertical];v[ri.Horizontal]=s.clientX,v[ri.Vertical]=s.clientY,v[s.button+2]=0;const F=s;s.pointerId===void 0&&(s.pointerId=this._mouseId),(S!==s.clientX||M!==s.clientY)&&(F.inputIndex=ri.Move,this._onInputChanged(y,b,F)),F.inputIndex=s.button+2,y===Bt.Mouse&&this._mouseId>=0&&((p=(a=this._elementToAttachTo).hasPointerCapture)===null||p===void 0?void 0:p.call(a,this._mouseId))?this._elementToAttachTo.releasePointerCapture(this._mouseId):s.pointerId&&((g=(_=this._elementToAttachTo).hasPointerCapture)===null||g===void 0?void 0:g.call(_,s.pointerId))&&this._elementToAttachTo.releasePointerCapture(s.pointerId),this._onInputChanged(y,b,F),y===Bt.Touch&&this._onDeviceDisconnected(y,b)}},this._pointerCancelEvent=s=>{var n,a,p,_;if(s.pointerType==="mouse"){const g=this._inputs[Bt.Mouse][0];this._mouseId>=0&&((a=(n=this._elementToAttachTo).hasPointerCapture)===null||a===void 0?void 0:a.call(n,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let y=ri.LeftClick;y<=ri.BrowserForward;y++)if(g[y]===1){g[y]=0;const b=pl.CreateDeviceEvent(Bt.Mouse,0,y,0,this,this._elementToAttachTo);this._onInputChanged(Bt.Mouse,0,b)}}else{const g=this._activeTouchIds.indexOf(s.pointerId);!((_=(p=this._elementToAttachTo).hasPointerCapture)===null||_===void 0)&&_.call(p,s.pointerId)&&this._elementToAttachTo.releasePointerCapture(s.pointerId),this._inputs[Bt.Touch][g][ri.LeftClick]=0;const y=pl.CreateDeviceEvent(Bt.Touch,g,ri.LeftClick,0,this,this._elementToAttachTo,s.pointerId);this._onInputChanged(Bt.Touch,g,y),this._activeTouchIds[g]=-1,this._onDeviceDisconnected(Bt.Touch,g)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll";let e=!1;const i=function(){};try{const s=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",i,s),this._elementToAttachTo.removeEventListener("test",i,s)}catch{}this._pointerBlurEvent=()=>{var s,n,a,p,_;if(this.isDeviceAvailable(Bt.Mouse)){const g=this._inputs[Bt.Mouse][0];this._mouseId>=0&&((n=(s=this._elementToAttachTo).hasPointerCapture)===null||n===void 0?void 0:n.call(s,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let y=ri.LeftClick;y<=ri.BrowserForward;y++)if(g[y]===1){g[y]=0;const b=pl.CreateDeviceEvent(Bt.Mouse,0,y,0,this,this._elementToAttachTo);this._onInputChanged(Bt.Mouse,0,b)}}if(this.isDeviceAvailable(Bt.Touch)){const g=this._inputs[Bt.Touch];for(let y=0;y<this._activeTouchIds.length;y++){const b=this._activeTouchIds[y];if(!((p=(a=this._elementToAttachTo).hasPointerCapture)===null||p===void 0)&&p.call(a,b)&&this._elementToAttachTo.releasePointerCapture(b),b!==-1&&((_=g[y])===null||_===void 0?void 0:_[ri.LeftClick])===1){g[y][ri.LeftClick]=0;const v=pl.CreateDeviceEvent(Bt.Touch,y,ri.LeftClick,0,this,this._elementToAttachTo,b);this._onInputChanged(Bt.Touch,y,v),this._activeTouchIds[y]=-1,this._onDeviceDisconnected(Bt.Touch,y)}}}},this._pointerWheelEvent=s=>{const n=Bt.Mouse,a=0;this._inputs[n]||(this._inputs[n]=[]),this._inputs[n][a]||(this._pointerActive=!0,this._registerDevice(n,a,LE));const p=this._inputs[n][a];if(p){p[ri.MouseWheelX]=s.deltaX||0,p[ri.MouseWheelY]=s.deltaY||s.wheelDelta||0,p[ri.MouseWheelZ]=s.deltaZ||0;const _=s;s.pointerId===void 0&&(s.pointerId=this._mouseId),p[ri.MouseWheelX]!==0&&(_.inputIndex=ri.MouseWheelX,this._onInputChanged(n,a,_)),p[ri.MouseWheelY]!==0&&(_.inputIndex=ri.MouseWheelY,this._onInputChanged(n,a,_)),p[ri.MouseWheelZ]!==0&&(_.inputIndex=ri.MouseWheelZ,this._onInputChanged(n,a,_))}},this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,e?{passive:!1}:!1),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(()=>{if(this.isDeviceAvailable(Bt.Mouse)){const s=this._inputs[Bt.Mouse][0];s[ri.MouseWheelX]=0,s[ri.MouseWheelY]=0,s[ri.MouseWheelZ]=0}})}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){const i=this._getGamepadDeviceType(e.gamepad.id),s=e.gamepad.index;this._unregisterDevice(i,s),delete this._gamepads[s]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,i,s){const n=navigator.getGamepads()[i];if(n&&e===this._gamepads[i]){const a=this._inputs[e][i];s>=n.buttons.length?a[s]=n.axes[s-n.buttons.length].valueOf():a[s]=n.buttons[s].value}}_getGamepadDeviceType(e){return e.indexOf("054c")!==-1?e.indexOf("0ce6")!==-1?Bt.DualSense:Bt.DualShock:e.indexOf("Xbox One")!==-1||e.search("Xbox 360")!==-1||e.search("xinput")!==-1?Bt.Xbox:e.indexOf("057e")!==-1?Bt.Switch:Bt.Generic}_getPointerType(e){let i=Bt.Mouse;return(e.pointerType==="touch"||e.pointerType==="pen"||e.touches)&&(i=Bt.Touch),i}}class NE{constructor(e,i,s=0){this.deviceType=i,this.deviceSlot=s,this.onInputChangedObservable=new Re,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}class V9{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=p=>{for(let _=0;_<this._devices.length;_++){const g=this._devices[_];for(const y in g){const b=+y;p._addDevice(new NE(this._deviceInputSystem,_,b))}}this._registeredManagers.push(p)},this.unregisterManager=p=>{const _=this._registeredManagers.indexOf(p);_>-1&&this._registeredManagers.splice(_,1)};const i=Object.keys(Bt).length/2;this._devices=new Array(i);const s=(p,_)=>{this._devices[p]||(this._devices[p]=new Array),this._devices[p][_]||(this._devices[p][_]=_);for(const g of this._registeredManagers){const y=new NE(this._deviceInputSystem,p,_);g._addDevice(y)}},n=(p,_)=>{var g;!((g=this._devices[p])===null||g===void 0)&&g[_]&&delete this._devices[p][_];for(const y of this._registeredManagers)y._removeDevice(p,_)},a=(p,_,g)=>{if(g)for(const y of this._registeredManagers)y._onInputChanged(p,_,g)};typeof _native<"u"?this._deviceInputSystem=new k9(s,n,a):this._deviceInputSystem=new U9(e,s,n,a)}dispose(){this._deviceInputSystem.dispose()}}class G9{getDeviceSource(e,i){if(i===void 0){if(this._firstDevice[e]===void 0)return null;i=this._firstDevice[e]}return!this._devices[e]||this._devices[e][i]===void 0?null:this._devices[e][i]}getDeviceSources(e){return this._devices[e]?this._devices[e].filter(i=>!!i):[]}constructor(e){const i=Object.keys(Bt).length/2;this._devices=new Array(i),this._firstDevice=new Array(i),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new V9(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new Re(s=>{for(const n of this._devices)if(n)for(const a of n)a&&this.onDeviceConnectedObservable.notifyObserver(s,a)}),this.onDeviceDisconnectedObservable=new Re,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,i){var s,n;const a=(s=this._devices[e])===null||s===void 0?void 0:s[i];this.onDeviceDisconnectedObservable.notifyObservers(a),!((n=this._devices[e])===null||n===void 0)&&n[i]&&delete this._devices[e][i],this._updateFirstDevices(e)}_onInputChanged(e,i,s){var n,a;(a=(n=this._devices[e])===null||n===void 0?void 0:n[i])===null||a===void 0||a.onInputChangedObservable.notifyObservers(s)}_updateFirstDevices(e){switch(e){case Bt.Keyboard:case Bt.Mouse:this._firstDevice[e]=0;break;case Bt.Touch:case Bt.DualSense:case Bt.DualShock:case Bt.Xbox:case Bt.Switch:case Bt.Generic:{delete this._firstDevice[e];const i=this._devices[e];if(i){for(let s=0;s<i.length;s++)if(i[s]){this._firstDevice[e]=s;break}}break}}}}class BE{constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e}set doubleClick(e){this._doubleClick=e}set hasSwiped(e){this._hasSwiped=e}set ignore(e){this._ignore=e}}class Br{constructor(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._isMultiTouchGesture=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new ii(0,0),this._previousStartingPointerPosition=new ii(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._delayedClicks=[null,null,null,null,null],this._deviceSourceManager=null,this._scene=e||Zt.LastCreatedScene,this._scene}get meshUnderPointer(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}getMeshUnderPointerByPointerId(e){return this._meshUnderPointerId[e]||null}get unTranslatedPointer(){return new ii(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(e){this._pointerX=e}get pointerY(){return this._pointerY}set pointerY(e){this._pointerY=e}_updatePointerPosition(e){const i=this._scene.getEngine().getInputElementClientRect();!i||(this._pointerX=e.clientX-i.left,this._pointerY=e.clientY-i.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(e,i){const s=this._scene,n=s.getEngine(),a=n.getInputElement();a&&(a.tabIndex=n.canvasTabIndex,s.doNotHandleCursors||(a.style.cursor=s.defaultCursor)),this._setCursorAndPointerOverMesh(e,i,s);for(const g of s._pointerMoveStage){const y=!!e?.pickedMesh;e=g.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,y,a)}const p=i.inputIndex>=ri.MouseWheelX&&i.inputIndex<=ri.MouseWheelZ?Lt.POINTERWHEEL:Lt.POINTERMOVE;s.onPointerMove&&(e=e||this._pickMove(i),s.onPointerMove(i,e,p));let _;e?(_=new qa(p,i,e),this._setRayOnPointerInfo(e,i)):(_=new qa(p,i,null,this),this._movePointerInfo=_),s.onPointerObservable.hasObservers()&&s.onPointerObservable.notifyObservers(_,p)}_setRayOnPointerInfo(e,i){const s=this._scene;e&&s._pickingAvailable&&(e.ray||(e.ray=s.createPickingRay(i.offsetX,i.offsetY,fe.Identity(),s.activeCamera)))}_addCameraPointerObserver(e,i){return this._cameraObserverCount++,this._scene.onPointerObservable.add(e,i)}_removeCameraPointerObserver(e){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(e)}_checkForPicking(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(e,i,s){const n=this._scene,a=new B9(s,i,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(a.originalPickingInfo=e,a.ray=e.ray,e.originMesh&&(a.nearInteractionPickingInfo=e)),n.onPrePointerObservable.notifyObservers(a,s),!!a.skipOnPointerObservable}_pickMove(e){const i=this._scene,s=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,i.pointerMovePredicate,!1,i.cameraToUseForPointers,i.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(s,e,i),s}_setCursorAndPointerOverMesh(e,i,s){const a=s.getEngine().getInputElement();if(e?.pickedMesh){if(this.setPointerOverMesh(e.pickedMesh,i.pointerId,e,i),!s.doNotHandleCursors&&a&&this._pointerOverMesh){const p=this._pointerOverMesh._getActionManagerForTrigger();p&&p.hasPointerTriggers&&(a.style.cursor=p.hoverCursor||s.hoverCursor)}}else this.setPointerOverMesh(null,i.pointerId,e,i)}simulatePointerMove(e,i){const s=new PointerEvent("pointermove",i);s.inputIndex=ri.Move,!this._checkPrePointerObservable(e,s,Lt.POINTERMOVE)&&this._processPointerMove(e,s)}simulatePointerDown(e,i){const s=new PointerEvent("pointerdown",i);s.inputIndex=s.button+2,!this._checkPrePointerObservable(e,s,Lt.POINTERDOWN)&&this._processPointerDown(e,s)}_processPointerDown(e,i){const s=this._scene;if(e?.pickedMesh){this._pickedDownMesh=e.pickedMesh;const p=e.pickedMesh._getActionManagerForTrigger();if(p){if(p.hasPickTriggers)switch(p.processTrigger(5,Os.CreateNew(e.pickedMesh,i)),i.button){case 0:p.processTrigger(2,Os.CreateNew(e.pickedMesh,i));break;case 1:p.processTrigger(4,Os.CreateNew(e.pickedMesh,i));break;case 2:p.processTrigger(3,Os.CreateNew(e.pickedMesh,i));break}p.hasSpecificTrigger(8)&&window.setTimeout(()=>{const _=s.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,g=>g.isPickable&&g.isVisible&&g.isReady()&&g.actionManager&&g.actionManager.hasSpecificTrigger(8)&&g===this._pickedDownMesh,!1,s.cameraToUseForPointers);_?.pickedMesh&&p&&this._totalPointersPressed!==0&&Date.now()-this._startingPointerTime>Br.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,p.processTrigger(8,Os.CreateNew(_.pickedMesh,i)))},Br.LongPressDelay)}}else for(const p of s._pointerDownStage)e=p.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,i,!1);let n;const a=Lt.POINTERDOWN;e?(s.onPointerDown&&s.onPointerDown(i,e,a),n=new qa(a,i,e),this._setRayOnPointerInfo(e,i)):n=new qa(a,i,null,this),s.onPointerObservable.hasObservers()&&s.onPointerObservable.notifyObservers(n,a)}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(e,i,s){const n=new PointerEvent("pointerup",i);n.inputIndex=ri.Move;const a=new BE;s?a.doubleClick=!0:a.singleClick=!0,!this._checkPrePointerObservable(e,n,Lt.POINTERUP)&&this._processPointerUp(e,n,a)}_processPointerUp(e,i,s){const n=this._scene;if(e?.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(n.onPointerPick&&n.onPointerPick(i,e),s.singleClick&&!s.ignore&&n.onPointerObservable.observers.length>this._cameraObserverCount)){const p=Lt.POINTERPICK,_=new qa(p,i,e);this._setRayOnPointerInfo(e,i),n.onPointerObservable.notifyObservers(_,p)}const a=e.pickedMesh._getActionManagerForTrigger();if(a&&!s.ignore){a.processTrigger(7,Os.CreateNew(e.pickedMesh,i,e)),!s.hasSwiped&&s.singleClick&&a.processTrigger(1,Os.CreateNew(e.pickedMesh,i,e));const p=e.pickedMesh._getActionManagerForTrigger(6);s.doubleClick&&p&&p.processTrigger(6,Os.CreateNew(e.pickedMesh,i,e))}}else if(!s.ignore)for(const a of n._pointerUpStage)e=a.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,i,s.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){const a=this._pickedDownMesh._getActionManagerForTrigger(16);a&&a.processTrigger(16,Os.CreateNew(this._pickedDownMesh,i))}if(!s.ignore){const a=new qa(Lt.POINTERUP,i,e);if(this._setRayOnPointerInfo(e,i),n.onPointerObservable.notifyObservers(a,Lt.POINTERUP),n.onPointerUp&&n.onPointerUp(i,e,Lt.POINTERUP),!s.hasSwiped&&!this._skipPointerTap&&!this._isMultiTouchGesture){let p=0;if(s.singleClick?p=Lt.POINTERTAP:s.doubleClick&&(p=Lt.POINTERDOUBLETAP),p){const _=new qa(p,i,e);n.onPointerObservable.hasObservers()&&n.onPointerObservable.hasSpecificMask(p)&&n.onPointerObservable.notifyObservers(_,p)}}}}isPointerCaptured(e=0){return this._pointerCaptures[e]}attachControl(e=!0,i=!0,s=!0,n=null){const a=this._scene,p=a.getEngine();n||(n=p.getInputElement()),this._alreadyAttached&&this.detachControl(),n&&(this._alreadyAttachedTo=n),this._deviceSourceManager=new G9(p),this._initActionManager=_=>{if(!this._meshPickProceed){const g=a.skipPointerUpPicking||a._registeredActions===0&&!this._checkForPicking()&&!a.onPointerUp?null:a.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,a.pointerUpPredicate,!1,a.cameraToUseForPointers);this._currentPickResult=g,g&&(_=g.hit&&g.pickedMesh?g.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return _},this._delayedSimpleClick=(_,g,y)=>{if((Date.now()-this._previousStartingPointerTime>Br.DoubleClickDelay&&!this._doubleClickOccured||_!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,g.singleClick=!0,g.ignore=!1,this._delayedClicks[_])){const b=this._delayedClicks[_].evt,v=Lt.POINTERTAP,S=new qa(v,b,this._currentPickResult);a.onPointerObservable.hasObservers()&&a.onPointerObservable.hasSpecificMask(v)&&a.onPointerObservable.notifyObservers(S,v),this._delayedClicks[_]=null}},this._initClickEvent=(_,g,y,b)=>{var v,S;const M=new BE;this._currentPickResult=null;let F=null,L=_.hasSpecificMask(Lt.POINTERPICK)||g.hasSpecificMask(Lt.POINTERPICK)||_.hasSpecificMask(Lt.POINTERTAP)||g.hasSpecificMask(Lt.POINTERTAP)||_.hasSpecificMask(Lt.POINTERDOUBLETAP)||g.hasSpecificMask(Lt.POINTERDOUBLETAP);!L&&va&&(F=this._initActionManager(F,M),F&&(L=F.hasPickTriggers));let N=!1;if(L){const k=y.button;if(M.hasSwiped=this._isPointerSwiping(),!M.hasSwiped){let G=!Br.ExclusiveDoubleClickMode;if(G||(G=!_.hasSpecificMask(Lt.POINTERDOUBLETAP)&&!g.hasSpecificMask(Lt.POINTERDOUBLETAP),G&&!va.HasSpecificTrigger(6)&&(F=this._initActionManager(F,M),F&&(G=!F.hasSpecificTrigger(6)))),G)(Date.now()-this._previousStartingPointerTime>Br.DoubleClickDelay||k!==this._previousButtonPressed)&&(M.singleClick=!0,b(M,this._currentPickResult),N=!0);else{const z={evt:y,clickInfo:M,timeoutId:window.setTimeout(this._delayedSimpleClick.bind(this,k,M,b),Br.DoubleClickDelay)};this._delayedClicks[k]=z}let H=_.hasSpecificMask(Lt.POINTERDOUBLETAP)||g.hasSpecificMask(Lt.POINTERDOUBLETAP);!H&&va.HasSpecificTrigger(6)&&(F=this._initActionManager(F,M),F&&(H=F.hasSpecificTrigger(6))),H&&(k===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<Br.DoubleClickDelay&&!this._doubleClickOccured?(!M.hasSwiped&&!this._isPointerSwiping()?(this._previousStartingPointerTime=0,this._doubleClickOccured=!0,M.doubleClick=!0,M.ignore=!1,Br.ExclusiveDoubleClickMode&&this._delayedClicks[k]&&(clearTimeout((v=this._delayedClicks[k])===null||v===void 0?void 0:v.timeoutId),this._delayedClicks[k]=null),b(M,this._currentPickResult)):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=k,Br.ExclusiveDoubleClickMode?(this._delayedClicks[k]&&(clearTimeout((S=this._delayedClicks[k])===null||S===void 0?void 0:S.timeoutId),this._delayedClicks[k]=null),b(M,this._previousPickResult)):b(M,this._currentPickResult)),N=!0):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=k))}}N||b(M,this._currentPickResult)},this._onPointerMove=_=>{if(this._updatePointerPosition(_),!this._isSwiping&&this._swipeButtonPressed!==-1&&(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>Br.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>Br.DragMovementThreshold),p.isPointerLock&&p._verifyPointerLock(),this._checkPrePointerObservable(null,_,_.inputIndex>=ri.MouseWheelX&&_.inputIndex<=ri.MouseWheelZ?Lt.POINTERWHEEL:Lt.POINTERMOVE)||!a.cameraToUseForPointers&&!a.activeCamera)return;if(a.skipPointerMovePicking){this._processPointerMove(new In,_);return}a.pointerMovePredicate||(a.pointerMovePredicate=y=>y.isPickable&&y.isVisible&&y.isReady()&&y.isEnabled()&&(y.enablePointerMoveEvents||a.constantlyUpdateMeshUnderPointer||y._getActionManagerForTrigger()!==null)&&(!a.cameraToUseForPointers||(a.cameraToUseForPointers.layerMask&y.layerMask)!==0));const g=a._registeredActions>0?this._pickMove(_):null;this._processPointerMove(g,_)},this._onPointerDown=_=>{var g;if(this._totalPointersPressed++,this._pickedDownMesh=null,this._meshPickProceed=!1,Br.ExclusiveDoubleClickMode){for(let b=0;b<this._delayedClicks.length;b++)if(this._delayedClicks[b])if(_.button===b)clearTimeout((g=this._delayedClicks[b])===null||g===void 0?void 0:g.timeoutId);else{const v=this._delayedClicks[b].clickInfo;this._doubleClickOccured=!1,v.singleClick=!0,v.ignore=!1;const S=this._delayedClicks[b].evt,M=Lt.POINTERTAP,F=new qa(M,S,this._currentPickResult);a.onPointerObservable.hasObservers()&&a.onPointerObservable.hasSpecificMask(M)&&a.onPointerObservable.notifyObservers(F,M),this._delayedClicks[b]=null}}if(this._updatePointerPosition(_),this._swipeButtonPressed===-1&&(this._swipeButtonPressed=_.button),a.preventDefaultOnPointerDown&&n&&(_.preventDefault(),n.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,_,Lt.POINTERDOWN)||!a.cameraToUseForPointers&&!a.activeCamera)return;this._pointerCaptures[_.pointerId]=!0,a.pointerDownPredicate||(a.pointerDownPredicate=b=>b.isPickable&&b.isVisible&&b.isReady()&&b.isEnabled()&&(!a.cameraToUseForPointers||(a.cameraToUseForPointers.layerMask&b.layerMask)!==0)),this._pickedDownMesh=null;let y;a.skipPointerDownPicking||a._registeredActions===0&&!this._checkForPicking()&&!a.onPointerDown?y=new In:y=a.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,a.pointerDownPredicate,!1,a.cameraToUseForPointers),this._processPointerDown(y,_)},this._onPointerUp=_=>{this._totalPointersPressed!==0&&(this._totalPointersPressed--,this._pickedUpMesh=null,this._meshPickProceed=!1,this._updatePointerPosition(_),a.preventDefaultOnPointerUp&&n&&(_.preventDefault(),n.focus()),this._initClickEvent(a.onPrePointerObservable,a.onPointerObservable,_,(g,y)=>{if(a.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=!1,!g.ignore)){if(this._checkPrePointerObservable(null,_,Lt.POINTERUP)){this._swipeButtonPressed===_.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1);return}g.hasSwiped||(g.singleClick&&a.onPrePointerObservable.hasSpecificMask(Lt.POINTERTAP)&&this._checkPrePointerObservable(null,_,Lt.POINTERTAP)&&(this._skipPointerTap=!0),g.doubleClick&&a.onPrePointerObservable.hasSpecificMask(Lt.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,_,Lt.POINTERDOUBLETAP)&&(this._skipPointerTap=!0))}if(!this._pointerCaptures[_.pointerId]){this._swipeButtonPressed===_.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1);return}_.buttons===0&&(this._pointerCaptures[_.pointerId]=!1),!(!a.cameraToUseForPointers&&!a.activeCamera)&&(a.pointerUpPredicate||(a.pointerUpPredicate=b=>b.isPickable&&b.isVisible&&b.isReady()&&b.isEnabled()&&(!a.cameraToUseForPointers||(a.cameraToUseForPointers.layerMask&b.layerMask)!==0)),!this._meshPickProceed&&(va&&va.HasTriggers||this._checkForPicking()||a.onPointerUp)&&this._initActionManager(null,g),y||(y=this._currentPickResult),this._processPointerUp(y,_,g),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===_.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1))}))},this._onKeyDown=_=>{const g=vc.KEYDOWN;if(a.onPreKeyboardObservable.hasObservers()){const y=new SE(g,_);if(a.onPreKeyboardObservable.notifyObservers(y,g),y.skipOnKeyboardObservable)return}if(a.onKeyboardObservable.hasObservers()){const y=new s_(g,_);a.onKeyboardObservable.notifyObservers(y,g)}a.actionManager&&a.actionManager.processTrigger(14,Os.CreateNewFromScene(a,_))},this._onKeyUp=_=>{const g=vc.KEYUP;if(a.onPreKeyboardObservable.hasObservers()){const y=new SE(g,_);if(a.onPreKeyboardObservable.notifyObservers(y,g),y.skipOnKeyboardObservable)return}if(a.onKeyboardObservable.hasObservers()){const y=new s_(g,_);a.onKeyboardObservable.notifyObservers(y,g)}a.actionManager&&a.actionManager.processTrigger(15,Os.CreateNewFromScene(a,_))},this._deviceSourceManager.onDeviceConnectedObservable.add(_=>{_.deviceType===Bt.Mouse?_.onInputChangedObservable.add(g=>{g.inputIndex===ri.LeftClick||g.inputIndex===ri.MiddleClick||g.inputIndex===ri.RightClick||g.inputIndex===ri.BrowserBack||g.inputIndex===ri.BrowserForward?i&&_.getInput(g.inputIndex)===1?this._onPointerDown(g):e&&_.getInput(g.inputIndex)===0&&this._onPointerUp(g):s&&(g.inputIndex===ri.Move?this._onPointerMove(g):(g.inputIndex===ri.MouseWheelX||g.inputIndex===ri.MouseWheelY||g.inputIndex===ri.MouseWheelZ)&&this._onPointerMove(g))}):_.deviceType===Bt.Touch?_.onInputChangedObservable.add(g=>{g.inputIndex===ri.LeftClick&&(i&&_.getInput(g.inputIndex)===1?(this._onPointerDown(g),this._totalPointersPressed>1&&(this._isMultiTouchGesture=!0)):e&&_.getInput(g.inputIndex)===0&&(this._onPointerUp(g),this._totalPointersPressed===0&&(this._isMultiTouchGesture=!1))),s&&g.inputIndex===ri.Move&&this._onPointerMove(g)}):_.deviceType===Bt.Keyboard&&_.onInputChangedObservable.add(g=>{g.type==="keydown"?this._onKeyDown(g):g.type==="keyup"&&this._onKeyUp(g)})}),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(e,i=0,s,n){if(this._meshUnderPointerId[i]===e&&(!e||!e._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;const a=this._meshUnderPointerId[i];let p;a&&(p=a._getActionManagerForTrigger(10),p&&p.processTrigger(10,Os.CreateNew(a,n,{pointerId:i}))),e?(this._meshUnderPointerId[i]=e,this._pointerOverMesh=e,p=e._getActionManagerForTrigger(9),p&&p.processTrigger(9,Os.CreateNew(e,n,{pointerId:i,pickResult:s}))):(delete this._meshUnderPointerId[i],this._pointerOverMesh=null)}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(e){this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null);for(const i in this._meshUnderPointerId)this._meshUnderPointerId[i]===e&&delete this._meshUnderPointerId[i]}}Br.DragMovementThreshold=10,Br.LongPressDelay=500,Br.DoubleClickDelay=300,Br.ExclusiveDoubleClickMode=!1;class aa{constructor(e,i,s,n){this.normal=new j(e,i,s),this.d=n}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new aa(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let e=this.normal.getHashCode();return e=e*397^(this.d|0),e}normalize(){const e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);let i=0;return e!==0&&(i=1/e),this.normal.x*=i,this.normal.y*=i,this.normal.z*=i,this.d*=i,this}transform(e){const i=aa._TmpMatrix;e.invertToRef(i);const s=i.m,n=this.normal.x,a=this.normal.y,p=this.normal.z,_=this.d,g=n*s[0]+a*s[1]+p*s[2]+_*s[3],y=n*s[4]+a*s[5]+p*s[6]+_*s[7],b=n*s[8]+a*s[9]+p*s[10]+_*s[11],v=n*s[12]+a*s[13]+p*s[14]+_*s[15];return new aa(g,y,b,v)}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,i,s){const n=i.x-e.x,a=i.y-e.y,p=i.z-e.z,_=s.x-e.x,g=s.y-e.y,y=s.z-e.z,b=a*y-p*g,v=p*_-n*y,S=n*g-a*_,M=Math.sqrt(b*b+v*v+S*S);let F;return M!==0?F=1/M:F=0,this.normal.x=b*F,this.normal.y=v*F,this.normal.z=S*F,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,i){return j.Dot(this.normal,e)<=i}signedDistanceTo(e){return j.Dot(e,this.normal)+this.d}static FromArray(e){return new aa(e[0],e[1],e[2],e[3])}static FromPoints(e,i,s){const n=new aa(0,0,0,0);return n.copyFromPoints(e,i,s),n}static FromPositionAndNormal(e,i){const s=new aa(0,0,0,0);return i.normalize(),s.normal=i,s.d=-(i.x*e.x+i.y*e.y+i.z*e.z),s}static SignedDistanceToPlaneFromPositionAndNormal(e,i,s){const n=-(i.x*e.x+i.y*e.y+i.z*e.z);return j.Dot(s,i)+n}}aa._TmpMatrix=fe.Identity();class Ta{static GetPlanes(e){const i=[];for(let s=0;s<6;s++)i.push(new aa(0,0,0,0));return Ta.GetPlanesToRef(e,i),i}static GetNearPlaneToRef(e,i){const s=e.m;i.normal.x=s[3]+s[2],i.normal.y=s[7]+s[6],i.normal.z=s[11]+s[10],i.d=s[15]+s[14],i.normalize()}static GetFarPlaneToRef(e,i){const s=e.m;i.normal.x=s[3]-s[2],i.normal.y=s[7]-s[6],i.normal.z=s[11]-s[10],i.d=s[15]-s[14],i.normalize()}static GetLeftPlaneToRef(e,i){const s=e.m;i.normal.x=s[3]+s[0],i.normal.y=s[7]+s[4],i.normal.z=s[11]+s[8],i.d=s[15]+s[12],i.normalize()}static GetRightPlaneToRef(e,i){const s=e.m;i.normal.x=s[3]-s[0],i.normal.y=s[7]-s[4],i.normal.z=s[11]-s[8],i.d=s[15]-s[12],i.normalize()}static GetTopPlaneToRef(e,i){const s=e.m;i.normal.x=s[3]-s[1],i.normal.y=s[7]-s[5],i.normal.z=s[11]-s[9],i.d=s[15]-s[13],i.normalize()}static GetBottomPlaneToRef(e,i){const s=e.m;i.normal.x=s[3]+s[1],i.normal.y=s[7]+s[5],i.normal.z=s[11]+s[9],i.d=s[15]+s[13],i.normalize()}static GetPlanesToRef(e,i){Ta.GetNearPlaneToRef(e,i[0]),Ta.GetFarPlaneToRef(e,i[1]),Ta.GetLeftPlaneToRef(e,i[2]),Ta.GetRightPlaneToRef(e,i[3]),Ta.GetTopPlaneToRef(e,i[4]),Ta.GetBottomPlaneToRef(e,i[5])}static IsPointInFrustum(e,i){for(let s=0;s<6;s++)if(i[s].dotCoordinate(e)<0)return!1;return!0}}class n_{static get UniqueId(){const e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}}n_._UniqueIdCounter=1;class Ji{static CompareLightsPriority(e,i){return e.shadowEnabled!==i.shadowEnabled?(i.shadowEnabled?1:0)-(e.shadowEnabled?1:0):i.renderPriority-e.renderPriority}}Ji.FALLOFF_DEFAULT=0,Ji.FALLOFF_PHYSICAL=1,Ji.FALLOFF_GLTF=2,Ji.FALLOFF_STANDARD=3,Ji.LIGHTMAP_DEFAULT=0,Ji.LIGHTMAP_SPECULAR=1,Ji.LIGHTMAP_SHADOWSONLY=2,Ji.INTENSITYMODE_AUTOMATIC=0,Ji.INTENSITYMODE_LUMINOUSPOWER=1,Ji.INTENSITYMODE_LUMINOUSINTENSITY=2,Ji.INTENSITYMODE_ILLUMINANCE=3,Ji.INTENSITYMODE_LUMINANCE=4,Ji.LIGHTTYPEID_POINTLIGHT=0,Ji.LIGHTTYPEID_DIRECTIONALLIGHT=1,Ji.LIGHTTYPEID_SPOTLIGHT=2,Ji.LIGHTTYPEID_HEMISPHERICLIGHT=3;var zo;(function(l){l[l.BackwardCompatible=0]="BackwardCompatible",l[l.Intermediate=1]="Intermediate",l[l.Aggressive=2]="Aggressive"})(zo||(zo={}));class Nt extends Xh{static DefaultMaterialFactory(e){throw xi("StandardMaterial")}static CollisionCoordinatorFactory(){throw xi("DefaultCollisionCoordinator")}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.markAllMaterialsAsDirty(1))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority){switch(this._performancePriority=e,e){case zo.BackwardCompatible:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case zo.Intermediate:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case zo.Aggressive:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1;break}this.onScenePerformancePriorityChangedObservable.notifyObservers(e)}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return Br.DragMovementThreshold}static set DragMovementThreshold(e){Br.DragMovementThreshold=e}static get LongPressDelay(){return Br.LongPressDelay}static set LongPressDelay(e){Br.LongPressDelay=e}static get DoubleClickDelay(){return Br.DoubleClickDelay}static set DoubleClickDelay(e){Br.DoubleClickDelay=e}static get ExclusiveDoubleClickMode(){return Br.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){Br.ExclusiveDoubleClickMode=e}bindEyePosition(e,i="vEyePosition",s=!1){var n;const a=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:(n=this.activeCamera.globalPosition)!==null&&n!==void 0?n:this.activeCamera.devicePosition,p=this.useRightHandedSystem===(this._mirroredCameraPosition!=null);return ge.Vector4[0].set(a.x,a.y,a.z,p?-1:1),e&&(s?e.setFloat3(i,ge.Vector4[0].x,ge.Vector4[0].y,ge.Vector4[0].z):e.setVector4(i,ge.Vector4[0])),ge.Vector4[0]}finalizeSceneUbo(){const e=this.getSceneUniformBuffer(),i=this.bindEyePosition(null);return e.updateFloat4("vEyePosition",i.x,i.y,i.z,i.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=yE(e,()=>{this.onActiveCamerasChanged.notifyObservers(this)})),this._activeCameras=e}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=Nt.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=Nt.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(const e of this._transientComponents)e.register();this._transientComponents.length=0}}_addComponent(e){this._components.push(e),this._transientComponents.push(e);const i=e;i.addFromContainer&&i.serialize&&this._serializableComponents.push(i)}_getComponent(e){for(const i of this._components)if(i.name===e)return i;return null}constructor(e,i){super(),this._inputManager=new Br(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this.clearColor=new pi(.2,.2,.3,1),this.ambientColor=new qe(0,0,0),this.environmentIntensity=1,this._performancePriority=zo.BackwardCompatible,this.onScenePerformancePriorityChangedObservable=new Re,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=new Array,this.onDisposeObservable=new Re,this._onDisposeObserver=null,this.onBeforeRenderObservable=new Re,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new Re,this.onAfterRenderCameraObservable=new Re,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new Re,this.onAfterAnimationsObservable=new Re,this.onBeforeDrawPhaseObservable=new Re,this.onAfterDrawPhaseObservable=new Re,this.onReadyObservable=new Re,this.onBeforeCameraRenderObservable=new Re,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new Re,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new Re,this.onAfterActiveMeshesEvaluationObservable=new Re,this.onBeforeParticlesRenderingObservable=new Re,this.onAfterParticlesRenderingObservable=new Re,this.onDataLoadedObservable=new Re,this.onNewCameraAddedObservable=new Re,this.onCameraRemovedObservable=new Re,this.onNewLightAddedObservable=new Re,this.onLightRemovedObservable=new Re,this.onNewGeometryAddedObservable=new Re,this.onGeometryRemovedObservable=new Re,this.onNewTransformNodeAddedObservable=new Re,this.onTransformNodeRemovedObservable=new Re,this.onNewMeshAddedObservable=new Re,this.onMeshRemovedObservable=new Re,this.onNewSkeletonAddedObservable=new Re,this.onSkeletonRemovedObservable=new Re,this.onNewMaterialAddedObservable=new Re,this.onNewMultiMaterialAddedObservable=new Re,this.onMaterialRemovedObservable=new Re,this.onMultiMaterialRemovedObservable=new Re,this.onNewTextureAddedObservable=new Re,this.onTextureRemovedObservable=new Re,this.onBeforeRenderTargetsRenderObservable=new Re,this.onAfterRenderTargetsRenderObservable=new Re,this.onBeforeStepObservable=new Re,this.onAfterStepObservable=new Re,this.onActiveCameraChanged=new Re,this.onActiveCamerasChanged=new Re,this.onBeforeRenderingGroupObservable=new Re,this.onAfterRenderingGroupObservable=new Re,this.onMeshImportedObservable=new Re,this.onAnimationFileImportedObservable=new Re,this._registeredForLateAnimationBindings=new dl(256),this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1,this.onPrePointerObservable=new Re,this.onPointerObservable=new Re,this.onPreKeyboardObservable=new Re,this.onKeyboardObservable=new Re,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=Nt.FOGMODE_NONE,this.fogColor=new qe(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new j(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=new Array,this.importedMeshesFiles=new Array,this.probesEnabled=!0,this._meshesForIntersections=new dl(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new Go,this._activeIndices=new Go,this._activeParticles=new Go,this._activeBones=new Go,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=new Array,this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new Ps(256),this._processedMaterials=new Ps(256),this._renderTargets=new dl(256),this._materialsRenderTargets=new dl(256),this._activeParticleSystems=new Ps(256),this._activeSkeletons=new dl(32),this._softwareSkinnedMeshes=new dl(32),this._activeAnimatables=new Array,this._transformMatrix=fe.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=Nr.Create(),this._beforeClearStage=Nr.Create(),this._beforeRenderTargetClearStage=Nr.Create(),this._gatherRenderTargetsStage=Nr.Create(),this._gatherActiveCameraRenderTargetsStage=Nr.Create(),this._isReadyForMeshStage=Nr.Create(),this._beforeEvaluateActiveMeshStage=Nr.Create(),this._evaluateSubMeshStage=Nr.Create(),this._preActiveMeshStage=Nr.Create(),this._cameraDrawRenderTargetStage=Nr.Create(),this._beforeCameraDrawStage=Nr.Create(),this._beforeRenderTargetDrawStage=Nr.Create(),this._beforeRenderingGroupDrawStage=Nr.Create(),this._beforeRenderingMeshStage=Nr.Create(),this._afterRenderingMeshStage=Nr.Create(),this._afterRenderingGroupDrawStage=Nr.Create(),this._afterCameraDrawStage=Nr.Create(),this._afterCameraPostProcessStage=Nr.Create(),this._afterRenderTargetDrawStage=Nr.Create(),this._afterRenderTargetPostProcessStage=Nr.Create(),this._afterRenderStage=Nr.Create(),this._pointerMoveStage=Nr.Create(),this._pointerDownStage=Nr.Create(),this._pointerUpStage=Nr.Create(),this._geometriesByUniqueId=null,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=new Array;const s={useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1,...i};this._engine=e||Zt.LastCreatedEngine,s.virtual?this._engine._virtualScenes.push(this):(Zt._LastCreatedScene=this,this._engine.scenes.push(this)),this._uid=null,this._renderingManager=new tn(this),r_&&(this.postProcessManager=new r_(this)),Ts()&&this.attachControl(),this._createUbo(),Oi&&(this._imageProcessingConfiguration=new Oi),this.setDefaultCandidateProviders(),s.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=s.useMaterialMeshMap,this.useClonedMeshMap=s.useClonedMeshMap,(!i||!i.virtual)&&this._engine.onNewSceneAddedObservable.notifyObservers(this)}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=this._getDefaultMeshCandidates.bind(this),this.getActiveSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getIntersectingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getCollidingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,i,s=1){return this._cachedEffect!==i||this._cachedMaterial!==e||this._cachedVisibility!==s}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return this._animationRatio!==void 0?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(e,i){return this._inputManager.simulatePointerMove(e,i),this}simulatePointerDown(e,i){return this._inputManager.simulatePointerDown(e,i),this}simulatePointerUp(e,i,s){return this._inputManager.simulatePointerUp(e,i,s),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=!0,i=!0,s=!0){this._inputManager.attachControl(e,i,s)}detachControl(){this._inputManager.detachControl()}isReady(e=!0){if(this._isDisposed)return!1;let i;const s=this.getEngine();let n=!0;for(this._pendingData.length>0&&(n=!1),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),i=0;i<this.meshes.length;i++){const a=this.meshes[i];if(!a.subMeshes||a.subMeshes.length===0)continue;if(!a.isReady(!0)){n=!1;continue}const p=a.hasThinInstances||a.getClassName()==="InstancedMesh"||a.getClassName()==="InstancedLinesMesh"||s.getCaps().instancedArrays&&a.instances.length>0;for(const g of this._isReadyForMeshStage)g.action(a,p)||(n=!1);if(!e)continue;const _=a.material||this.defaultMaterial;if(_)if(_._storeEffectOnSubMeshes)for(const g of a.subMeshes){const y=g.getMaterial();y&&y.hasRenderTargetTextures&&y.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(y)===-1&&(this._processedMaterials.push(y),this._materialsRenderTargets.concatWithNoDuplicate(y.getRenderTargetTextures()))}else _.hasRenderTargetTextures&&_.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(_)===-1&&(this._processedMaterials.push(_),this._materialsRenderTargets.concatWithNoDuplicate(_.getRenderTargetTextures()))}if(!n||!s.areAllEffectsReady())return!1;if(e){for(i=0;i<this._materialsRenderTargets.length;++i)if(!this._materialsRenderTargets.data[i].isReadyForRendering())return!1}for(i=0;i<this.geometries.length;i++)if(this.geometries[i].delayLoadState===2)return!1;if(this.activeCameras&&this.activeCameras.length>0){for(const a of this.activeCameras)if(!a.isReady(!0))return!1}else if(this.activeCamera&&!this.activeCamera.isReady(!0))return!1;for(const a of this.particleSystems)if(!a.isReady())return!1;return!0}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(e){this.onBeforeRenderObservable.add(e)}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e)}registerAfterRender(e){this.onAfterRenderObservable.add(e)}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e)}_executeOnceBeforeRender(e){const i=()=>{e(),setTimeout(()=>{this.unregisterBeforeRender(i)})};this.registerBeforeRender(i)}executeOnceBeforeRender(e,i){i!==void 0?setTimeout(()=>{this._executeOnceBeforeRender(e)},i):this._executeOnceBeforeRender(e)}addPendingData(e){this._pendingData.push(e)}removePendingData(e){const i=this.isLoading,s=this._pendingData.indexOf(e);s!==-1&&this._pendingData.splice(s,1),i&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,i=!1){this.onReadyObservable.addOnce(e),this._executeWhenReadyTimeoutId===null&&this._checkIsReady(i)}whenReadyAsync(e=!1){return new Promise(i=>{this.executeWhenReady(()=>{i()},e)})}_checkIsReady(e=!1){if(this._registerTransientComponents(),this.isReady(e)){this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}if(this._isDisposed){this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}this._executeWhenReadyTimeoutId=setTimeout(()=>{this.incrementRenderId(),this._checkIsReady(e)},100)}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=na.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,i,s,n){!s&&!n&&this._multiviewSceneUbo&&(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),!(this._viewUpdateFlag===e.updateFlag&&this._projectionUpdateFlag===i.updateFlag)&&(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=i.updateFlag,this._viewMatrix=e,this._projectionMatrix=i,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?Ta.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Ta.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(s,n):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e){const i=new At(this._engine,void 0,!1,e??"scene");return i.addUniform("viewProjection",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return n_.UniqueId}addMesh(e,i=!1){this._blockEntityCollection||(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(e),i&&e.getChildMeshes().forEach(s=>{this.addMesh(s)}))}removeMesh(e,i=!1){const s=this.meshes.indexOf(e);return s!==-1&&(this.meshes[s]=this.meshes[this.meshes.length-1],this.meshes.pop(),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),i&&e.getChildMeshes().forEach(n=>{this.removeMesh(n)}),s}addTransformNode(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneTransformNodesArray!==-1||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}removeTransformNode(e){const i=e._indexInSceneTransformNodesArray;if(i!==-1){if(i!==this.transformNodes.length-1){const s=this.transformNodes[this.transformNodes.length-1];this.transformNodes[i]=s,s._indexInSceneTransformNodesArray=i}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),i}removeSkeleton(e){const i=this.skeletons.indexOf(e);return i!==-1&&(this.skeletons.splice(i,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),i}removeMorphTargetManager(e){const i=this.morphTargetManagers.indexOf(e);return i!==-1&&this.morphTargetManagers.splice(i,1),i}removeLight(e){const i=this.lights.indexOf(e);if(i!==-1){for(const s of this.meshes)s._removeLightSource(e,!1);this.lights.splice(i,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),i}removeCamera(e){const i=this.cameras.indexOf(e);if(i!==-1&&(this.cameras.splice(i,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){const s=this.activeCameras.indexOf(e);s!==-1&&this.activeCameras.splice(s,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),i}removeParticleSystem(e){const i=this.particleSystems.indexOf(e);return i!==-1&&(this.particleSystems.splice(i,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),i}removeAnimation(e){const i=this.animations.indexOf(e);return i!==-1&&this.animations.splice(i,1),i}stopAnimation(e,i,s){}removeAnimationGroup(e){const i=this.animationGroups.indexOf(e);return i!==-1&&this.animationGroups.splice(i,1),i}removeMultiMaterial(e){const i=this.multiMaterials.indexOf(e);return i!==-1&&this.multiMaterials.splice(i,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),i}removeMaterial(e){const i=e._indexInSceneMaterialArray;if(i!==-1&&i<this.materials.length){if(i!==this.materials.length-1){const s=this.materials[this.materials.length-1];this.materials[i]=s,s._indexInSceneMaterialArray=i}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),i}removeActionManager(e){const i=this.actionManagers.indexOf(e);return i!==-1&&this.actionManagers.splice(i,1),i}removeTexture(e){const i=this.textures.indexOf(e);return i!==-1&&this.textures.splice(i,1),this.onTextureRemovedObservable.notifyObservers(e),i}addLight(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();for(const i of this.meshes)i.lightSources.indexOf(e)===-1&&(i.lightSources.push(e),i._resyncLightSources());this.onNewLightAddedObservable.notifyObservers(e)}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(Ji.CompareLightsPriority)}addCamera(e){this._blockEntityCollection||(this.cameras.push(e),this.onNewCameraAddedObservable.notifyObservers(e),e.parent||e._addToSceneRootNodes())}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),this.onNewSkeletonAddedObservable.notifyObservers(e))}addParticleSystem(e){this._blockEntityCollection||this.particleSystems.push(e)}addAnimation(e){this._blockEntityCollection||this.animations.push(e)}addAnimationGroup(e){this._blockEntityCollection||this.animationGroups.push(e)}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),this.onNewMultiMaterialAddedObservable.notifyObservers(e))}addMaterial(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneMaterialArray!==-1||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),this.onNewMaterialAddedObservable.notifyObservers(e))}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}addActionManager(e){this.actionManagers.push(e)}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}switchActiveCamera(e,i=!0){!this._engine.getInputElement()||(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,i&&e.attachControl())}setActiveCameraById(e){const i=this.getCameraById(e);return i?(this.activeCamera=i,i):null}setActiveCameraByName(e){const i=this.getCameraByName(e);return i?(this.activeCamera=i,i):null}getAnimationGroupByName(e){for(let i=0;i<this.animationGroups.length;i++)if(this.animationGroups[i].name===e)return this.animationGroups[i];return null}_getMaterial(e,i){for(let s=0;s<this.materials.length;s++){const n=this.materials[s];if(i(n))return n}if(e)for(let s=0;s<this.multiMaterials.length;s++){const n=this.multiMaterials[s];if(i(n))return n}return null}getMaterialByUniqueID(e,i=!1){return this._getMaterial(i,s=>s.uniqueId===e)}getMaterialById(e,i=!1){return this._getMaterial(i,s=>s.id===e)}getMaterialByName(e,i=!1){return this._getMaterial(i,s=>s.name===e)}getLastMaterialById(e,i=!1){for(let s=this.materials.length-1;s>=0;s--)if(this.materials[s].id===e)return this.materials[s];if(i){for(let s=this.multiMaterials.length-1;s>=0;s--)if(this.multiMaterials[s].id===e)return this.multiMaterials[s]}return null}getTextureByUniqueId(e){for(let i=0;i<this.textures.length;i++)if(this.textures[i].uniqueId===e)return this.textures[i];return null}getTextureByName(e){for(let i=0;i<this.textures.length;i++)if(this.textures[i].name===e)return this.textures[i];return null}getCameraById(e){for(let i=0;i<this.cameras.length;i++)if(this.cameras[i].id===e)return this.cameras[i];return null}getCameraByUniqueId(e){for(let i=0;i<this.cameras.length;i++)if(this.cameras[i].uniqueId===e)return this.cameras[i];return null}getCameraByName(e){for(let i=0;i<this.cameras.length;i++)if(this.cameras[i].name===e)return this.cameras[i];return null}getBoneById(e){for(let i=0;i<this.skeletons.length;i++){const s=this.skeletons[i];for(let n=0;n<s.bones.length;n++)if(s.bones[n].id===e)return s.bones[n]}return null}getBoneByName(e){for(let i=0;i<this.skeletons.length;i++){const s=this.skeletons[i];for(let n=0;n<s.bones.length;n++)if(s.bones[n].name===e)return s.bones[n]}return null}getLightByName(e){for(let i=0;i<this.lights.length;i++)if(this.lights[i].name===e)return this.lights[i];return null}getLightById(e){for(let i=0;i<this.lights.length;i++)if(this.lights[i].id===e)return this.lights[i];return null}getLightByUniqueId(e){for(let i=0;i<this.lights.length;i++)if(this.lights[i].uniqueId===e)return this.lights[i];return null}getParticleSystemById(e){for(let i=0;i<this.particleSystems.length;i++)if(this.particleSystems[i].id===e)return this.particleSystems[i];return null}getGeometryById(e){for(let i=0;i<this.geometries.length;i++)if(this.geometries[i].id===e)return this.geometries[i];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){const i=this._geometriesByUniqueId[e];if(i!==void 0)return this.geometries[i]}else for(let i=0;i<this.geometries.length;i++)if(this.geometries[i].uniqueId===e)return this.geometries[i];return null}pushGeometry(e,i){return!i&&this._getGeometryByUniqueId(e.uniqueId)?!1:(this.addGeometry(e),this.onNewGeometryAddedObservable.notifyObservers(e),!0)}removeGeometry(e){let i;if(this._geometriesByUniqueId){if(i=this._geometriesByUniqueId[e.uniqueId],i===void 0)return!1}else if(i=this.geometries.indexOf(e),i<0)return!1;if(i!==this.geometries.length-1){const s=this.geometries[this.geometries.length-1];s&&(this.geometries[i]=s,this._geometriesByUniqueId&&(this._geometriesByUniqueId[s.uniqueId]=i))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}getGeometries(){return this.geometries}getMeshById(e){for(let i=0;i<this.meshes.length;i++)if(this.meshes[i].id===e)return this.meshes[i];return null}getMeshesById(e){return this.meshes.filter(function(i){return i.id===e})}getTransformNodeById(e){for(let i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].id===e)return this.transformNodes[i];return null}getTransformNodeByUniqueId(e){for(let i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].uniqueId===e)return this.transformNodes[i];return null}getTransformNodesById(e){return this.transformNodes.filter(function(i){return i.id===e})}getMeshByUniqueId(e){for(let i=0;i<this.meshes.length;i++)if(this.meshes[i].uniqueId===e)return this.meshes[i];return null}getLastMeshById(e){for(let i=this.meshes.length-1;i>=0;i--)if(this.meshes[i].id===e)return this.meshes[i];return null}getLastEntryById(e){let i;for(i=this.meshes.length-1;i>=0;i--)if(this.meshes[i].id===e)return this.meshes[i];for(i=this.transformNodes.length-1;i>=0;i--)if(this.transformNodes[i].id===e)return this.transformNodes[i];for(i=this.cameras.length-1;i>=0;i--)if(this.cameras[i].id===e)return this.cameras[i];for(i=this.lights.length-1;i>=0;i--)if(this.lights[i].id===e)return this.lights[i];return null}getNodeById(e){const i=this.getMeshById(e);if(i)return i;const s=this.getTransformNodeById(e);if(s)return s;const n=this.getLightById(e);if(n)return n;const a=this.getCameraById(e);if(a)return a;const p=this.getBoneById(e);return p||null}getNodeByName(e){const i=this.getMeshByName(e);if(i)return i;const s=this.getTransformNodeByName(e);if(s)return s;const n=this.getLightByName(e);if(n)return n;const a=this.getCameraByName(e);if(a)return a;const p=this.getBoneByName(e);return p||null}getMeshByName(e){for(let i=0;i<this.meshes.length;i++)if(this.meshes[i].name===e)return this.meshes[i];return null}getTransformNodeByName(e){for(let i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].name===e)return this.transformNodes[i];return null}getLastSkeletonById(e){for(let i=this.skeletons.length-1;i>=0;i--)if(this.skeletons[i].id===e)return this.skeletons[i];return null}getSkeletonByUniqueId(e){for(let i=0;i<this.skeletons.length;i++)if(this.skeletons[i].uniqueId===e)return this.skeletons[i];return null}getSkeletonById(e){for(let i=0;i<this.skeletons.length;i++)if(this.skeletons[i].id===e)return this.skeletons[i];return null}getSkeletonByName(e){for(let i=0;i<this.skeletons.length;i++)if(this.skeletons[i].name===e)return this.skeletons[i];return null}getMorphTargetManagerById(e){for(let i=0;i<this.morphTargetManagers.length;i++)if(this.morphTargetManagers[i].uniqueId===e)return this.morphTargetManagers[i];return null}getMorphTargetById(e){for(let i=0;i<this.morphTargetManagers.length;++i){const s=this.morphTargetManagers[i];for(let n=0;n<s.numTargets;++n){const a=s.getTarget(n);if(a.id===e)return a}}return null}getMorphTargetByName(e){for(let i=0;i<this.morphTargetManagers.length;++i){const s=this.morphTargetManagers[i];for(let n=0;n<s.numTargets;++n){const a=s.getTarget(n);if(a.name===e)return a}}return null}getPostProcessByName(e){for(let i=0;i<this.postProcesses.length;++i){const s=this.postProcesses[i];if(s.name===e)return s}return null}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}get uid(){return this._uid||(this._uid=Le.RandomId()),this._uid}addExternalData(e,i){return this._externalData||(this._externalData=new gE),this._externalData.add(e,i)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,i){return this._externalData||(this._externalData=new gE),this._externalData.getOrAddWithFactory(e,i)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,i,s,n){if(n||e.isInFrustum(this._frustumPlanes)){for(const p of this._evaluateSubMeshStage)p.action(i,e);const a=e.getMaterial();a!=null&&(a.hasRenderTargetTextures&&a.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(a)===-1&&(this._processedMaterials.push(a),this._materialsRenderTargets.concatWithNoDuplicate(a.getRenderTargetTextures())),this._renderingManager.dispatch(e,i,a))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){const i=this.activeCameras[e];i&&i._activeMeshes&&i._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){const i=this.textures[e];i&&i.renderList&&i.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=!1,i,s,n=!0,a=!1){return this.executeWhenReady(()=>{if(!this.activeCamera){s&&s("No active camera found");return}if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=a,this._skipEvaluateActiveMeshesCompletely=e,n)for(let p=0;p<this._activeMeshes.length;p++)this._activeMeshes.data[p]._freeze();i&&i()}),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){const i=this.meshes[e];i._internalAbstractMeshDataInfo&&(i._internalAbstractMeshDataInfo._isActive=!1)}for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(e){!(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(()=>e.dispose())}_evaluateActiveMeshes(){var e;if(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1){this._activeMeshes.length>0&&((e=this.activeCamera)===null||e===void 0||e._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset());return}if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){const n=this._activeMeshes.length;for(let a=0;a<n;a++)this._activeMeshes.data[a].computeWorldMatrix()}if(this._activeParticleSystems){const n=this._activeParticleSystems.length;for(let a=0;a<n;a++)this._activeParticleSystems.data[a].animate()}this._renderingManager.resetSprites();return}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(const n of this._beforeEvaluateActiveMeshStage)n.action();const i=this.getActiveMeshCandidates(),s=i.length;for(let n=0;n<s;n++){const a=i.data[n];if(a._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,a.isBlocked||(this._totalVertices.addCount(a.getTotalVertices(),!1),!a.isReady()||!a.isEnabled()||a.scaling.hasAZeroComponent))continue;a.computeWorldMatrix(),a.actionManager&&a.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(a);let p=this.customLODSelector?this.customLODSelector(a,this.activeCamera):a.getLOD(this.activeCamera);if(a._internalAbstractMeshDataInfo._currentLOD=p,a._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,p!=null&&(p!==a&&p.billboardMode!==0&&p.computeWorldMatrix(),a._preActivate(),a.isVisible&&a.visibility>0&&(a.layerMask&this.activeCamera.layerMask)!==0&&(this._skipFrustumClipping||a.alwaysSelectAsActiveMesh||a.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(a),this.activeCamera._activeMeshes.push(a),p!==a&&p._activate(this._renderId,!1);for(const _ of this._preActiveMeshStage)_.action(a);a._activate(this._renderId,!1)&&(a.isAnInstance?a._internalAbstractMeshDataInfo._actAsRegularMesh&&(p=a):p._internalAbstractMeshDataInfo._onlyForInstances=!1,p._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(a,p)),a._postActivate()}}if(this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let n=0;n<this.particleSystems.length;n++){const a=this.particleSystems[n];if(!a.isStarted()||!a.emitter)continue;const p=a.emitter;(!p.position||p.isEnabled())&&(this._activeParticleSystems.push(a),a.animate(),this._renderingManager.dispatchParticles(a))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_activeMesh(e,i){this._skeletonsEnabled&&i.skeleton!==null&&i.skeleton!==void 0&&(this._activeSkeletons.pushNoDuplicate(i.skeleton)&&(i.skeleton.prepare(),this._activeBones.addCount(i.skeleton.bones.length,!1)),i.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(i));let s=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||i.alwaysSelectAsActiveMesh;if(i&&i.subMeshes&&i.subMeshes.length>0){const n=this.getActiveSubMeshCandidates(i),a=n.length;s=s||a===1;for(let p=0;p<a;p++){const _=n.data[p];this._evaluateSubMesh(_,i,e,s)}}}updateTransformMatrix(e){if(!!this.activeCamera)if(this.activeCamera._renderingMultiview){const i=this.activeCamera._rigCameras[0],s=this.activeCamera._rigCameras[1];this.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(e),s.getViewMatrix(),s.getProjectionMatrix(e))}else this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(e))}_bindFrameBuffer(e,i=!0){e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),i&&this._clearFrameBuffer(e)}_clearFrameBuffer(e){if(!(e&&e._multiviewTexture))if(e&&e.outputRenderTarget&&!e._renderingMultiview){const i=e.outputRenderTarget;i.onClearObservable.hasObservers()?i.onClearObservable.notifyObservers(this._engine):i.skipInitialClear||(this.autoClear&&this._engine.clear(i.clearColor||this.clearColor,!i._cleared,!0,!0),i._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(e,i,s=!0){var n,a,p;if(e&&e._skipRendering)return;const _=this._engine;if(this._activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");if(_.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&s){let y=!0;e._renderingMultiview&&e.outputRenderTarget&&(y=e.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=y)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let y=0;y<this._softwareSkinnedMeshes.length;y++){const b=this._softwareSkinnedMeshes.data[y];b.applySkeleton(b.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),i&&i.customRenderTargets&&i.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(i.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(const y of this._gatherActiveCameraRenderTargetsStage)y.action(this._renderTargets);let g=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){Le.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(let y=0;y<this._renderTargets.length;y++){const b=this._renderTargets.data[y];if(b._shouldRender()){this._renderId++;const v=b.activeCamera&&b.activeCamera!==this.activeCamera;b.render(v,this.dumpNextRenderTargets),g=!0}}Le.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(const y of this._cameraDrawRenderTargetStage)g=y.action(this.activeCamera)||g;this._intermediateRendering=!1}this._engine.currentRenderPassId=(p=(a=(n=e.outputRenderTarget)===null||n===void 0?void 0:n.renderPassId)!==null&&a!==void 0?a:e.renderPassId)!==null&&p!==void 0?p:0,g&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager&&!e._multiviewTexture&&!this.prePass&&this.postProcessManager._prepareFrame();for(const y of this._beforeCameraDrawStage)y.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),_.snapshotRendering&&_.snapshotRenderingMode===1&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(const y of this._afterCameraDrawStage)y.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){const y=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,y)}for(const y of this._afterCameraPostProcessStage)y.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(e,i=!0){if(e.cameraRigMode===0||e._renderingMultiview){e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,i),this.onAfterRenderCameraObservable.notifyObservers(e);return}if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(let s=0;s<e._rigCameras.length;s++)this._renderForCamera(e._rigCameras[s],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){const i=this._meshesForIntersections.data[e];if(!!i.actionManager)for(let s=0;i.actionManager&&s<i.actionManager.actions.length;s++){const n=i.actionManager.actions[s];if(n.trigger===12||n.trigger===13){const a=n.getTriggerParameter(),p=a.mesh?a.mesh:a,_=p.intersectsMesh(i,a.usePreciseIntersection),g=i._intersectionsInProgress.indexOf(p);_&&g===-1?n.trigger===12?(n._executeCurrent(Os.CreateNew(i,void 0,p)),i._intersectionsInProgress.push(p)):n.trigger===13&&i._intersectionsInProgress.push(p):!_&&g>-1&&(n.trigger===13&&n._executeCurrent(Os.CreateNew(i,void 0,p)),(!i.actionManager.hasSpecificTrigger(13,y=>{const b=y.mesh?y.mesh:y;return p===b})||n.trigger===13)&&i._intersectionsInProgress.splice(g,1))}}}}_advancePhysicsEngineStep(e){}_animate(){}animate(){if(this._engine.isDeterministicLockStep()){let e=Math.max(Nt.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Nt.MaxDeltaTime))+this._timeAccumulator;const i=this._engine.getTimeStep(),s=1e3/i/1e3;let n=0;const a=this._engine.getLockstepMaxSteps();let p=Math.floor(e/i);for(p=Math.min(p,a);e>0&&n<p;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=i*s,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(i),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,n++,e-=i;this._timeAccumulator=e<0?0:e}else{const e=this.useConstantAnimationDeltaTime?16:Math.max(Nt.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Nt.MaxDeltaTime));this._animationRatio=e*(60/1e3),this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(e){var i;if(e?.outputRenderTarget&&!e?.isRigCamera&&(e.outputRenderTarget._cleared=!1),!((i=e?.rigCameras)===null||i===void 0)&&i.length)for(let s=0;s<e.rigCameras.length;++s){const n=e.rigCameras[s].outputRenderTarget;n&&(n._cleared=!1)}}resetDrawCache(e){if(!!this.meshes)for(const i of this.meshes)i.resetDrawCache(e)}render(e=!0,i=!1){var s,n,a;if(this.isDisposed)return;this.onReadyObservable.hasObservers()&&this._executeWhenReadyTimeoutId===null&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),!((s=this.activeCameras)===null||s===void 0)&&s.length&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),i||this.animate();for(const g of this._beforeCameraUpdateStage)g.action();if(e){if(this.activeCameras&&this.activeCameras.length>0)for(let g=0;g<this.activeCameras.length;g++){const y=this.activeCameras[g];if(y.update(),y.cameraRigMode!==0)for(let b=0;b<y._rigCameras.length;b++)y._rigCameras[b].update()}else if(this.activeCamera&&(this.activeCamera.update(),this.activeCamera.cameraRigMode!==0))for(let g=0;g<this.activeCamera._rigCameras.length;g++)this.activeCamera._rigCameras[g].update()}this.onBeforeRenderObservable.notifyObservers(this);const p=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);const _=!((n=this.activeCameras)===null||n===void 0)&&n.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){Le.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(let g=0;g<this.customRenderTargets.length;g++){const y=this.customRenderTargets[g];if(y._shouldRender()){if(this._renderId++,this.activeCamera=y.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");p.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),y.render(_!==this.activeCamera,this.dumpNextRenderTargets)}}Le.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=(a=_?.renderPassId)!==null&&a!==void 0?a:0,this.activeCamera=_,this._activeCamera&&this._activeCamera.cameraRigMode!==22&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(const g of this._beforeClearStage)g.action();this._clearFrameBuffer(this.activeCamera);for(const g of this._gatherRenderTargetsStage)g.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let g=0;g<this.activeCameras.length;g++)this._processSubCameras(this.activeCameras[g],g>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}this._checkIntersections();for(const g of this._afterRenderStage)g.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let g=0;g<this._toBeDisposed.length;g++){const y=this._toBeDisposed[g];y&&y.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze()}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}dispose(){if(this.isDisposed)return;this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=new Array,this.stopAllAnimations&&this.stopAllAnimations(),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;const e=this._activeRequests.slice();for(const a of e)a.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(a){console.error("An error occurred while calling onDisposeObservable!",a)}if(this.detachControl(),this._engine.getInputElement())for(let a=0;a<this.cameras.length;a++)this.cameras[a].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,a=>a.dispose(!0)),this._disposeList(this.transformNodes,a=>a.dispose(!0));const s=this.cameras;this._disposeList(s),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let n=this._engine.scenes.indexOf(this);n>-1&&this._engine.scenes.splice(n,1),Zt._LastCreatedScene===this&&(this._engine.scenes.length>0?Zt._LastCreatedScene=this._engine.scenes[this._engine.scenes.length-1]:Zt._LastCreatedScene=null),n=this._engine._virtualScenes.indexOf(this),n>-1&&this._engine._virtualScenes.splice(n,1),this._engine.wipeCaches(!0),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this._isDisposed=!0}_disposeList(e,i){const s=e.slice(0);i=i??(n=>n.dispose());for(const n of s)i(n);e.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){const s=this.meshes[e].geometry;s&&s.clearCachedData()}}cleanCachedTextureBuffer(){for(const e of this.textures)e._buffer&&(e._buffer=null)}getWorldExtends(e){const i=new j(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new j(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return e=e||(()=>!0),this.meshes.filter(e).forEach(n=>{if(n.computeWorldMatrix(!0),!n.subMeshes||n.subMeshes.length===0||n.infiniteDistance)return;const a=n.getBoundingInfo(),p=a.boundingBox.minimumWorld,_=a.boundingBox.maximumWorld;j.CheckExtends(p,i,s),j.CheckExtends(_,i,s)}),{min:i,max:s}}createPickingRay(e,i,s,n,a=!1){throw xi("Ray")}createPickingRayToRef(e,i,s,n,a,p=!1,_=!1){throw xi("Ray")}createPickingRayInCameraSpace(e,i,s){throw xi("Ray")}createPickingRayInCameraSpaceToRef(e,i,s,n){throw xi("Ray")}get _pickingAvailable(){return!1}pick(e,i,s,n,a,p){return new In}pickWithBoundingInfo(e,i,s,n,a){return new In}pickWithRay(e,i,s,n){throw xi("Ray")}multiPick(e,i,s,n,a){throw xi("Ray")}multiPickWithRay(e,i,s){throw xi("Ray")}setPointerOverMesh(e,i,s){this._inputManager.setPointerOverMesh(e,i,s)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(const e of this._components)e.rebuild();for(const e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(const e of this.spriteManagers)e.rebuild()}_rebuildTextures(){for(const e of this.textures)e._rebuild();this.markAllMaterialsAsDirty(1)}_getByTags(e,i,s){if(i===void 0)return e;const n=[];s=s||(a=>{});for(const a in e){const p=e[a];Bi&&Bi.MatchesQuery(p,i)&&(n.push(p),s(p))}return n}getMeshesByTags(e,i){return this._getByTags(this.meshes,e,i)}getCamerasByTags(e,i){return this._getByTags(this.cameras,e,i)}getLightsByTags(e,i){return this._getByTags(this.lights,e,i)}getMaterialByTags(e,i){return this._getByTags(this.materials,e,i).concat(this._getByTags(this.multiMaterials,e,i))}getTransformNodesByTags(e,i){return this._getByTags(this.transformNodes,e,i)}setRenderingOrder(e,i=null,s=null,n=null){this._renderingManager.setRenderingOrder(e,i,s,n)}setRenderingAutoClearDepthStencil(e,i,s=!0,n=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,i,s,n)}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(63))}markAllMaterialsAsDirty(e,i){if(!this._blockMaterialDirtyMechanism)for(const s of this.materials)i&&!i(s)||s.markAsDirty(e)}_loadFile(e,i,s,n,a,p,_){const g=gx(e,i,s,n?this.offlineProvider:void 0,a,p,_);return this._activeRequests.push(g),g.onCompleteObservable.add(y=>{this._activeRequests.splice(this._activeRequests.indexOf(y),1)}),g}_loadFileAsync(e,i,s,n,a){return new Promise((p,_)=>{this._loadFile(e,g=>{p(g)},i,s,n,(g,y)=>{_(y)},a)})}_requestFile(e,i,s,n,a,p,_){const g=Jm(e,i,s,n?this.offlineProvider:void 0,a,p,_);return this._activeRequests.push(g),g.onCompleteObservable.add(y=>{this._activeRequests.splice(this._activeRequests.indexOf(y),1)}),g}_requestFileAsync(e,i,s,n,a){return new Promise((p,_)=>{this._requestFile(e,g=>{p(g)},i,s,n,g=>{_(g)},a)})}_readFile(e,i,s,n,a){const p=Gh(e,i,s,n,a);return this._activeRequests.push(p),p.onCompleteObservable.add(_=>{this._activeRequests.splice(this._activeRequests.indexOf(_),1)}),p}_readFileAsync(e,i,s){return new Promise((n,a)=>{this._readFile(e,p=>{n(p)},i,s,p=>{a(p)})})}getPerfCollector(){throw xi("performanceViewerSceneExtension")}}Nt.FOGMODE_NONE=0,Nt.FOGMODE_EXP=1,Nt.FOGMODE_EXP2=2,Nt.FOGMODE_LINEAR=3,Nt.MinDeltaTime=1,Nt.MaxDeltaTime=1e3,Nt.prototype.setActiveCameraByID=function(l){return this.setActiveCameraById(l)},Nt.prototype.getLastMaterialByID=function(l){return this.getLastMaterialById(l)},Nt.prototype.getMaterialByID=function(l){return this.getMaterialById(l)},Nt.prototype.getTextureByUniqueID=function(l){return this.getTextureByUniqueId(l)},Nt.prototype.getCameraByID=function(l){return this.getCameraById(l)},Nt.prototype.getCameraByUniqueID=function(l){return this.getCameraByUniqueId(l)},Nt.prototype.getBoneByID=function(l){return this.getBoneById(l)},Nt.prototype.getLightByID=function(l){return this.getLightById(l)},Nt.prototype.getLightByUniqueID=function(l){return this.getLightByUniqueId(l)},Nt.prototype.getParticleSystemByID=function(l){return this.getParticleSystemById(l)},Nt.prototype.getGeometryByID=function(l){return this.getGeometryById(l)},Nt.prototype.getMeshByID=function(l){return this.getMeshById(l)},Nt.prototype.getMeshesByID=function(l){return this.getMeshesById(l)},Nt.prototype.getTransformNodeByID=function(l){return this.getTransformNodeById(l)},Nt.prototype.getTransformNodeByUniqueID=function(l){return this.getTransformNodeByUniqueId(l)},Nt.prototype.getTransformNodesByID=function(l){return this.getTransformNodesById(l)},Nt.prototype.getMeshByUniqueID=function(l){return this.getMeshByUniqueId(l)},Nt.prototype.getLastMeshByID=function(l){return this.getLastMeshById(l)},Nt.prototype.getLastEntryByID=function(l){return this.getLastEntryById(l)},Nt.prototype.getNodeByID=function(l){return this.getNodeById(l)},Nt.prototype.getLastSkeletonByID=function(l){return this.getLastSkeletonById(l)};class W9{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new Re,this._onClonedObservable=new Re}}class vr{static AddNodeConstructor(e,i){this._NodeConstructors[e]=i}static Construct(e,i,s,n){const a=this._NodeConstructors[e];return a?a(i,s,n):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return this._nodeDataStorage._doNotSerialize?!0:this._parentNode?this._parentNode.doNotSerialize:!1}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;const i=this._parentNode;if(this._parentNode&&this._parentNode._children!==void 0&&this._parentNode._children!==null){const s=this._parentNode._children.indexOf(this);s!==-1&&this._parentNode._children.splice(s,1),!e&&!this._nodeDataStorage._isDisposed&&this._addToSceneRootNodes()}this._parentNode=e,this._parentNode&&((this._parentNode._children===void 0||this._parentNode._children===null)&&(this._parentNode._children=new Array),this._parentNode._children.push(this),i||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){this._nodeDataStorage._sceneRootNodesIndex===-1&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(this._nodeDataStorage._sceneRootNodesIndex!==-1){const e=this._scene.rootNodes,i=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[i],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}constructor(e,i=null){this._isDirty=!1,this._nodeDataStorage=new W9,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new Re,this._parentContainer=null,this.animations=new Array,this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=fe.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new Re,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=i||Zt.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache()}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,i=!1){return this._behaviors.indexOf(e)!==-1?this:(e.init(),this._scene.isLoading&&!i?this._scene.onDataLoadedObservable.addOnce(()=>{e.attach(this)}):e.attach(this),this._behaviors.push(e),this)}removeBehavior(e){const i=this._behaviors.indexOf(e);return i===-1?this:(this._behaviors[i].detach(),this._behaviors.splice(i,1),this)}get behaviors(){return this._behaviors}getBehaviorByName(e){for(const i of this._behaviors)if(i.name===e)return i;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={},this._cache.parent=void 0}updateCache(e){!e&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())}_getActionManagerForTrigger(e,i=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return this._parentNode?this._parentNode._isDirty||this._parentUpdateId!==this._parentNode._childUpdateId?!1:this._parentNode.isSynchronized():!0}isSynchronized(){return this._cache.parent!==this._parentNode?(this._cache.parent=this._parentNode,!1):this._parentNode&&!this.isSynchronizedWithParent()?!1:this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return e===!1?this._nodeDataStorage._isEnabled:this._nodeDataStorage._isEnabled?this._nodeDataStorage._isParentEnabled:!1}_syncParentEnabledState(){this._nodeDataStorage._isParentEnabled=this._parentNode?this._parentNode.isEnabled():!0,this._children&&this._children.forEach(e=>{e._syncParentEnabledState()})}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return this.parent?this.parent===e?!0:this.parent.isDescendantOf(e):!1}_getDescendants(e,i=!1,s){if(!!this._children)for(let n=0;n<this._children.length;n++){const a=this._children[n];(!s||s(a))&&e.push(a),i||a._getDescendants(e,!1,s)}}getDescendants(e,i){const s=new Array;return this._getDescendants(s,e,i),s}getChildMeshes(e,i){const s=[];return this._getDescendants(s,e,n=>(!i||i(n))&&n.cullingStrategy!==void 0),s}getChildren(e,i=!0){return this.getDescendants(i,e)}_setReady(e){if(e!==this._nodeDataStorage._isReady){if(!e){this._nodeDataStorage._isReady=!1;return}this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0}}getAnimationByName(e){for(let i=0;i<this.animations.length;i++){const s=this.animations[i];if(s.name===e)return s}return null}createAnimationRange(e,i,s){if(!this._ranges[e]){this._ranges[e]=vr._AnimationRangeFactory(e,i,s);for(let n=0,a=this.animations.length;n<a;n++)this.animations[n]&&this.animations[n].createRange(e,i,s)}}deleteAnimationRange(e,i=!0){for(let s=0,n=this.animations.length;s<n;s++)this.animations[s]&&this.animations[s].deleteRange(e,i);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let i;for(i in this._ranges)e.push(this._ranges[i]);return e}beginAnimation(e,i,s,n){const a=this.getAnimationRange(e);return a?this._scene.beginAnimation(this,a.from,a.to,i,s,n):null}serializeAnimationRanges(){const e=[];for(const i in this._ranges){const s=this._ranges[i];if(!s)continue;const n={};n.name=i,n.from=s.from,n.to=s.to,e.push(n)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=fe.Identity()),this._worldMatrix}dispose(e,i=!1){if(this._nodeDataStorage._isDisposed=!0,!e){const s=this.getDescendants(!0);for(const n of s)n.dispose(e,i)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(const s of this._behaviors)s.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,i,s){if(i.ranges)for(let n=0;n<i.ranges.length;n++){const a=i.ranges[n];e.createAnimationRange(a.name,a.from,a.to)}}getHierarchyBoundingVectors(e=!0,i=null){this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);let s,n;const a=this;if(a.getBoundingInfo&&a.subMeshes){const p=a.getBoundingInfo();s=p.boundingBox.minimumWorld.clone(),n=p.boundingBox.maximumWorld.clone()}else s=new j(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new j(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){const p=this.getDescendants(!1);for(const _ of p){const g=_;if(g.computeWorldMatrix(!0),i&&!i(g)||!g.getBoundingInfo||g.getTotalVertices()===0)continue;const b=g.getBoundingInfo().boundingBox,v=b.minimumWorld,S=b.maximumWorld;j.CheckExtends(v,s,n),j.CheckExtends(S,s,n)}}return{min:s,max:n}}}vr._AnimationRangeFactory=(l,e,i)=>{throw xi("AnimationRange")},vr._NodeConstructors={},J([xe()],vr.prototype,"name",void 0),J([xe()],vr.prototype,"id",void 0),J([xe()],vr.prototype,"uniqueId",void 0),J([xe()],vr.prototype,"state",void 0),J([xe()],vr.prototype,"metadata",void 0);class Za{constructor(e,i,s,n){this.x=e,this.y=i,this.width=s,this.height=n}toGlobal(e,i){return new Za(this.x*e,this.y*i,this.width*e,this.height*i)}toGlobalToRef(e,i,s){return s.x=this.x*e,s.y=this.y*i,s.width=this.width*e,s.height=this.height*i,this}clone(){return new Za(this.x,this.y,this.width,this.height)}}class wt extends vr{get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){var e,i,s,n;let a=0,p=0;if(this.mode===wt.PERSPECTIVE_CAMERA)this.fovMode===wt.FOVMODE_VERTICAL_FIXED?(p=this.minZ*2*Math.tan(this.fov/2),a=this.getEngine().getAspectRatio(this)*p):(a=this.minZ*2*Math.tan(this.fov/2),p=a/this.getEngine().getAspectRatio(this));else{const _=this.getEngine().getRenderWidth()/2,g=this.getEngine().getRenderHeight()/2;a=((e=this.orthoRight)!==null&&e!==void 0?e:_)-((i=this.orthoLeft)!==null&&i!==void 0?i:-_),p=((s=this.orthoTop)!==null&&s!==void 0?s:g)-((n=this.orthoBottom)!==null&&n!==void 0?n:-g)}return a*p}set orthoLeft(e){this._orthoLeft=e;for(const i of this._rigCameras)i.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(const i of this._rigCameras)i.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(const i of this._rigCameras)i.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(const i of this._rigCameras)i.orthoTop=e}get orthoTop(){return this._orthoTop}set mode(e){this._mode=e;for(const i of this._rigCameras)i.mode=e}get mode(){return this._mode}constructor(e,i,s,n=!0){super(e,s),this._position=j.Zero(),this._upVector=j.Up(),this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=wt.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new Za(0,0,1,1),this.layerMask=268435455,this.fovMode=wt.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=wt.RIG_MODE_NONE,this.customRenderTargets=new Array,this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new Re,this.onProjectionMatrixChangedObservable=new Re,this.onAfterCheckInputsObservable=new Re,this.onRestoreStateObservable=new Re,this.isRigCamera=!1,this._rigCameras=new Array,this._webvrViewMatrix=fe.Identity(),this._skipRendering=!1,this._projectionMatrix=new fe,this._postProcesses=new Array,this._activeMeshes=new Ps(256),this._globalPosition=j.Zero(),this._computedViewMatrix=fe.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=fe.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=Ve.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),n&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=i,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`)}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}_restoreStateValues(){return this._stateStored?(this.fov=this._storedFov,!0):!1}restoreState(){return this._restoreStateValues()?(this.onRestoreStateObservable.notifyObservers(this),!0):!1}getClassName(){return"Camera"}toString(e){let i="Name: "+this.name;if(i+=", type: "+this.getClassName(),this.animations)for(let s=0;s<this.animations.length;s++)i+=", animation[0]: "+this.animations[s].toString(e);return i}applyVerticalCorrection(){const e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}isReady(e=!1){if(e){for(const i of this._postProcesses)if(i&&!i.isReady())return!1}return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new j(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new j(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return super._isSynchronized()?this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent():!1}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;const i=this.getEngine();return this.mode===wt.PERSPECTIVE_CAMERA?e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===i.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===i.getRenderWidth()&&this._cache.renderHeight===i.getRenderHeight(),e}attachControl(e,i){}detachControl(e){}update(){this._checkInputs(),this.cameraRigMode!==wt.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(this._postProcesses[e]!==null)return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){const e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let i=0,s=this._rigCameras.length;i<s;i++){const n=this._rigCameras[i],a=n._rigPostProcess;a?(a.getEffectName()==="pass"&&(n.isIntermediate=this._postProcesses.length===0),n._postProcesses=this._postProcesses.slice(0).concat(a),a.markTextureDirty()):n._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,i=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(Ie.Error("You're trying to reuse a post process not defined as reusable."),0):(i==null||i<0?this._postProcesses.push(e):this._postProcesses[i]===null?this._postProcesses[i]=e:this._postProcesses.splice(i,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){const i=this._postProcesses.indexOf(e);i!==-1&&(this._postProcesses[i]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()?this._worldMatrix:(this.getViewMatrix(),this._worldMatrix)}_getViewMatrix(){return fe.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix),this._computedViewMatrix)}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,e!==void 0&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){var i,s,n,a,p,_,g,y;if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;const b=this.getEngine(),v=this.getScene(),S=b.useReverseDepthBuffer;if(this.mode===wt.PERSPECTIVE_CAMERA){this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=b.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1);let M;v.useRightHandedSystem?M=fe.PerspectiveFovRHToRef:M=fe.PerspectiveFovLHToRef,M(this.fov,b.getAspectRatio(this),S?this.maxZ:this.minZ,S?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===wt.FOVMODE_VERTICAL_FIXED,b.isNDCHalfZRange,this.projectionPlaneTilt,S)}else{const M=b.getRenderWidth()/2,F=b.getRenderHeight()/2;v.useRightHandedSystem?fe.OrthoOffCenterRHToRef((i=this.orthoLeft)!==null&&i!==void 0?i:-M,(s=this.orthoRight)!==null&&s!==void 0?s:M,(n=this.orthoBottom)!==null&&n!==void 0?n:-F,(a=this.orthoTop)!==null&&a!==void 0?a:F,S?this.maxZ:this.minZ,S?this.minZ:this.maxZ,this._projectionMatrix,b.isNDCHalfZRange):fe.OrthoOffCenterLHToRef((p=this.orthoLeft)!==null&&p!==void 0?p:-M,(_=this.orthoRight)!==null&&_!==void 0?_:M,(g=this.orthoBottom)!==null&&g!==void 0?g:-F,(y=this.orthoTop)!==null&&y!==void 0?y:F,S?this.maxZ:this.minZ,S?this.minZ:this.maxZ,this._projectionMatrix,b.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=b.getRenderWidth(),this._cache.renderHeight=b.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_updateFrustumPlanes(){!this._refreshFrustumPlanes||(this.getTransformationMatrix(),this._frustumPlanes?Ta.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Ta.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,i=!1){if(this._updateFrustumPlanes(),i&&this.rigCameras.length>0){let s=!1;return this.rigCameras.forEach(n=>{n._updateFrustumPlanes(),s=s||e.isInFrustum(n._frustumPlanes)}),s}else return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,i,s){throw xi("Ray")}getForwardRayToRef(e,i=100,s,n){throw xi("Ray")}dispose(e,i=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){const n=this._rigCameras.pop();n&&n.dispose()}if(this._parentContainer){const n=this._parentContainer.cameras.indexOf(this);n>-1&&this._parentContainer.cameras.splice(n,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==wt.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let n=this._postProcesses.length;for(;--n>=0;){const a=this._postProcesses[n];a&&a.dispose(this)}}let s=this.customRenderTargets.length;for(;--s>=0;)this.customRenderTargets[s].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,i)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,i){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){const s=this._rigCameras.pop();s&&s.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=i.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=Le.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==wt.RIG_MODE_NONE){const s=this.createRigCamera(this.name+"_L",0);s&&(s._isLeftCamera=!0);const n=this.createRigCamera(this.name+"_R",1);n&&(n._isRightCamera=!0),s&&n&&(this._rigCameras.push(s),this._rigCameras.push(n))}this._setRigMode(i),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return fe.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}_updateCameraRotationMatrix(){}_updateWebVRCameraRotationMatrix(){}_getWebVRProjectionMatrix(){return fe.Identity()}_getWebVRViewMatrix(){return fe.Identity()}setCameraRigParameter(e,i){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=i,e==="interaxialDistance"&&(this._cameraRigParams.stereoHalfAngle=Le.ToRadians(i/.0637))}createRigCamera(e,i){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===wt.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){const e=Kt.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),Kt.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,i=null){const s=Kt.Clone(wt.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return s.name=e,s.parent=i,this.onClonedObservable.notifyObservers(s),s}getDirection(e){const i=j.Zero();return this.getDirectionToRef(e,i),i}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,i){j.TransformNormalToRef(e,this.getWorldMatrix(),i)}static GetConstructorFromName(e,i,s,n=0,a=!0){const p=vr.Construct(e,i,s,{interaxial_distance:n,isStereoscopicSideBySide:a});return p||(()=>wt._CreateDefaultParsedCamera(i,s))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,i){const s=e.type,n=wt.GetConstructorFromName(s,e.name,i,e.interaxial_distance,e.isStereoscopicSideBySide),a=Kt.Parse(n,e,i);if(e.parentId!==void 0&&(a._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(a._waitingParentInstanceIndex=e.parentInstanceIndex),a.inputs&&(a.inputs.parse(e),a._setupInputs()),e.upVector&&(a.upVector=j.FromArray(e.upVector)),a.setPosition&&(a.position.copyFromFloats(0,0,0),a.setPosition(j.FromArray(e.position))),e.target&&a.setTarget&&a.setTarget(j.FromArray(e.target)),e.cameraRigMode){const p=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};a.setCameraRigMode(e.cameraRigMode,p)}if(e.animations){for(let p=0;p<e.animations.length;p++){const _=e.animations[p],g=Ka("BABYLON.Animation");g&&a.animations.push(g.Parse(_))}vr.ParseAnimationRanges(a,e,i)}return e.autoAnimate&&i.beginAnimation(a,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&a.setEnabled(e.isEnabled),a}}wt._CreateDefaultParsedCamera=(l,e)=>{throw xi("UniversalCamera")},wt.PERSPECTIVE_CAMERA=0,wt.ORTHOGRAPHIC_CAMERA=1,wt.FOVMODE_VERTICAL_FIXED=0,wt.FOVMODE_HORIZONTAL_FIXED=1,wt.RIG_MODE_NONE=0,wt.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,wt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,wt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,wt.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,wt.RIG_MODE_STEREOSCOPIC_INTERLACED=14,wt.RIG_MODE_VR=20,wt.RIG_MODE_WEBVR=21,wt.RIG_MODE_CUSTOM=22,wt.ForceAttachControlToAlwaysPreventDefault=!1,J([Rn("position")],wt.prototype,"_position",void 0),J([Rn("upVector")],wt.prototype,"_upVector",void 0),J([xe()],wt.prototype,"orthoLeft",null),J([xe()],wt.prototype,"orthoRight",null),J([xe()],wt.prototype,"orthoBottom",null),J([xe()],wt.prototype,"orthoTop",null),J([xe()],wt.prototype,"fov",void 0),J([xe()],wt.prototype,"projectionPlaneTilt",void 0),J([xe()],wt.prototype,"minZ",void 0),J([xe()],wt.prototype,"maxZ",void 0),J([xe()],wt.prototype,"inertia",void 0),J([xe()],wt.prototype,"mode",null),J([xe()],wt.prototype,"layerMask",void 0),J([xe()],wt.prototype,"fovMode",void 0),J([xe()],wt.prototype,"cameraRigMode",void 0),J([xe()],wt.prototype,"interaxialDistance",void 0),J([xe()],wt.prototype,"isStereoscopicSideBySide",void 0);var Ki;(function(l){l[l.LOCAL=0]="LOCAL",l[l.WORLD=1]="WORLD",l[l.BONE=2]="BONE"})(Ki||(Ki={}));class oa{}oa.X=new j(1,0,0),oa.Y=new j(0,1,0),oa.Z=new j(0,0,1);var ml;(function(l){l[l.X=0]="X",l[l.Y=1]="Y",l[l.Z=2]="Z"})(ml||(ml={}));class rs extends wt{constructor(e,i,s,n=!0){super(e,i,s,n),this._tmpUpVector=j.Zero(),this._tmpTargetVector=j.Zero(),this.cameraDirection=new j(0,0,0),this.cameraRotation=new ii(0,0),this.ignoreParentScaling=!1,this.updateUpVectorFromRotation=!1,this._tmpQuaternion=new Ve,this.rotation=new j(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this._currentTarget=j.Zero(),this._initialFocalDistance=1,this._viewMatrix=fe.Zero(),this._camMatrix=fe.Zero(),this._cameraTransformMatrix=fe.Zero(),this._cameraRotationMatrix=fe.Zero(),this._referencePoint=new j(0,0,1),this._transformedReferencePoint=j.Zero(),this._defaultUp=j.Up(),this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0}getFrontPosition(e){this.getWorldMatrix();const i=this.getTarget().subtract(this.position);return i.normalize(),i.scaleInPlace(e),this.globalPosition.add(i)}_getLockedTargetPosition(){if(!this.lockedTarget)return null;if(this.lockedTarget.absolutePosition){const e=this.lockedTarget;e.computeWorldMatrix().getTranslationToRef(e.absolutePosition)}return this.lockedTarget.absolutePosition||this.lockedTarget}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0):!1}_initCache(){super._initCache(),this._cache.lockedTarget=new j(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new j(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new Ve(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();const i=this._getLockedTargetPosition();i?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(i):this._cache.lockedTarget=i.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;const e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){const e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(e.getFps()*100))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=rr),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),fe.LookAtLHToRef(this.position,e,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);const i=e.subtract(this.position);i.x>=0?this.rotation.y=-Math.atan(i.z/i.x)+Math.PI/2:this.rotation.y=-Math.atan(i.z/i.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&Ve.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent){this.parent.getWorldMatrix().invertToRef(ge.Matrix[0]),j.TransformNormalToRef(this.cameraDirection,ge.Matrix[0],ge.Vector3[0]),this.position.addInPlace(ge.Vector3[0]);return}this.position.addInPlace(this.cameraDirection)}_checkInputs(){const e=this.invertRotation?-this.inverseRotationSpeed:1,i=this._decideIfNeedsToMove(),s=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;i&&this._updatePosition(),s&&(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this.rotation),this.rotation.x+=this.cameraRotation.x*e,this.rotation.y+=this.cameraRotation.y*e,this.noRotationConstraint||(this.rotation.x>1.570796&&(this.rotation.x=1.570796),this.rotation.x<-1.570796&&(this.rotation.x=-1.570796)),this.rotationQuaternion&&this.rotation.lengthSquared()&&Ve.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)),i&&(Math.abs(this.cameraDirection.x)<this.speed*rr&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*rr&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*rr&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),s&&(Math.abs(this.cameraRotation.x)<this.speed*rr&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*rr&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):fe.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return j.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),j.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?oa.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(Ve.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),oa.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,i,s){if(this.ignoreParentScaling){if(this.parent){const n=this.parent.getWorldMatrix();j.TransformCoordinatesToRef(e,n,this._globalPosition),j.TransformCoordinatesToRef(i,n,this._tmpTargetVector),j.TransformNormalToRef(s,n,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e),this._tmpTargetVector.copyFrom(i),this._tmpUpVector.copyFrom(s);this.getScene().useRightHandedSystem?fe.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):fe.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix);return}if(this.getScene().useRightHandedSystem?fe.LookAtRHToRef(e,i,s,this._viewMatrix):fe.LookAtLHToRef(e,i,s,this._viewMatrix),this.parent){const n=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(n,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e)}createRigCamera(e,i){if(this.cameraRigMode!==wt.RIG_MODE_NONE){const s=new rs(e,this.position.clone(),this.getScene());return s.isRigCamera=!0,s.rigParent=this,(this.cameraRigMode===wt.RIG_MODE_VR||this.cameraRigMode===wt.RIG_MODE_WEBVR)&&(this.rotationQuaternion||(this.rotationQuaternion=new Ve),s._cameraRigParams={},s.rotationQuaternion=new Ve),s.mode=this.mode,s.orthoLeft=this.orthoLeft,s.orthoRight=this.orthoRight,s.orthoTop=this.orthoTop,s.orthoBottom=this.orthoBottom,s}return null}_updateRigCameras(){const e=this._rigCameras[0],i=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case wt.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case wt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case wt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case wt.RIG_MODE_STEREOSCOPIC_OVERUNDER:case wt.RIG_MODE_STEREOSCOPIC_INTERLACED:{const s=this.cameraRigMode===wt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,n=this.cameraRigMode===wt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*s,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*n,i);break}case wt.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),i.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),i.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),i.position.copyFrom(this.position);break}super._updateRigCameras()}_getRigCamPositionAndTarget(e,i){this.getTarget().subtractToRef(this.position,rs._TargetFocalPoint),rs._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);const n=rs._TargetFocalPoint.addInPlace(this.position);fe.TranslationToRef(-n.x,-n.y,-n.z,rs._TargetTransformMatrix),rs._TargetTransformMatrix.multiplyToRef(fe.RotationAxis(i.upVector,e),rs._RigCamTransformMatrix),fe.TranslationToRef(n.x,n.y,n.z,rs._TargetTransformMatrix),rs._RigCamTransformMatrix.multiplyToRef(rs._TargetTransformMatrix,rs._RigCamTransformMatrix),j.TransformCoordinatesToRef(this.position,rs._RigCamTransformMatrix,i.position),i.setTarget(n)}getClassName(){return"TargetCamera"}}rs._RigCamTransformMatrix=new fe,rs._TargetTransformMatrix=new fe,rs._TargetFocalPoint=new j,J([Rn()],rs.prototype,"rotation",void 0),J([xe()],rs.prototype,"speed",void 0),J([AE("lockedTargetId")],rs.prototype,"lockedTarget",void 0);var Qa={};class kE{constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}add(e){const i=e.getSimpleName();if(this.attached[i]){Ie.Warn("camera input of type "+i+" already exists on camera");return}this.attached[i]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault)}remove(e){for(const i in this.attached){const s=this.attached[i];if(s===e){s.detachControl(),s.camera=null,delete this.attached[i],this.rebuildInputCheck();return}}}removeByType(e){for(const i in this.attached){const s=this.attached[i];s.getClassName()===e&&(s.detachControl(),s.camera=null,delete this.attached[i],this.rebuildInputCheck())}}_addCheckInputs(e){const i=this.checkInputs;return()=>{i(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=wt.ForceAttachControlToAlwaysPreventDefault?!1:e,this.attachedToElement=!0,this.noPreventDefault=e;for(const i in this.attached)this.attached[i].attachControl(e)}}detachElement(e=!1){for(const i in this.attached)this.attached[i].detachControl(),e&&(this.attached[i].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(const e in this.attached){const i=this.attached[e];i.checkInputs&&(this.checkInputs=this._addCheckInputs(i.checkInputs.bind(i)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){const i={};for(const s in this.attached){const n=this.attached[s],a=Kt.Serialize(n);i[n.getClassName()]=a}e.inputsmgr=i}parse(e){const i=e.inputsmgr;if(i){this.clear();for(const s in i){const n=Qa[s];if(n){const a=i[s],p=Kt.Parse(()=>new n,a,null);this.add(p)}}}else for(const s in this.attached){const n=Qa[this.attached[s].getClassName()];if(n){const a=Kt.Parse(()=>new n,e,null);this.remove(this.attached[s]),this.add(a)}}}}class Ea{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=Le.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(i=>{const s=i.event;if(!s.metaKey){if(i.type===vc.KEYDOWN)(this.keysUp.indexOf(s.keyCode)!==-1||this.keysDown.indexOf(s.keyCode)!==-1||this.keysLeft.indexOf(s.keyCode)!==-1||this.keysRight.indexOf(s.keyCode)!==-1||this.keysUpward.indexOf(s.keyCode)!==-1||this.keysDownward.indexOf(s.keyCode)!==-1||this.keysRotateLeft.indexOf(s.keyCode)!==-1||this.keysRotateRight.indexOf(s.keyCode)!==-1||this.keysRotateUp.indexOf(s.keyCode)!==-1||this.keysRotateDown.indexOf(s.keyCode)!==-1)&&(this._keys.indexOf(s.keyCode)===-1&&this._keys.push(s.keyCode),e||s.preventDefault());else if(this.keysUp.indexOf(s.keyCode)!==-1||this.keysDown.indexOf(s.keyCode)!==-1||this.keysLeft.indexOf(s.keyCode)!==-1||this.keysRight.indexOf(s.keyCode)!==-1||this.keysUpward.indexOf(s.keyCode)!==-1||this.keysDownward.indexOf(s.keyCode)!==-1||this.keysRotateLeft.indexOf(s.keyCode)!==-1||this.keysRotateRight.indexOf(s.keyCode)!==-1||this.keysRotateUp.indexOf(s.keyCode)!==-1||this.keysRotateDown.indexOf(s.keyCode)!==-1){const n=this._keys.indexOf(s.keyCode);n>=0&&this._keys.splice(n,1),e||s.preventDefault()}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let i=0;i<this._keys.length;i++){const s=this._keys[i],n=e._computeLocalCameraSpeed();this.keysLeft.indexOf(s)!==-1?e._localDirection.copyFromFloats(-n,0,0):this.keysUp.indexOf(s)!==-1?e._localDirection.copyFromFloats(0,0,n):this.keysRight.indexOf(s)!==-1?e._localDirection.copyFromFloats(n,0,0):this.keysDown.indexOf(s)!==-1?e._localDirection.copyFromFloats(0,0,-n):this.keysUpward.indexOf(s)!==-1?e._localDirection.copyFromFloats(0,n,0):this.keysDownward.indexOf(s)!==-1?e._localDirection.copyFromFloats(0,-n,0):this.keysRotateLeft.indexOf(s)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):this.keysRotateRight.indexOf(s)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):this.keysRotateUp.indexOf(s)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):this.keysRotateDown.indexOf(s)!==-1&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),j.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){let e=this.rotationSpeed*this._engine.getDeltaTime()/1e3;return this.camera.getScene().useRightHandedSystem&&(e*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e}}J([xe()],Ea.prototype,"keysUp",void 0),J([xe()],Ea.prototype,"keysUpward",void 0),J([xe()],Ea.prototype,"keysDown",void 0),J([xe()],Ea.prototype,"keysDownward",void 0),J([xe()],Ea.prototype,"keysLeft",void 0),J([xe()],Ea.prototype,"keysRight",void 0),J([xe()],Ea.prototype,"rotationSpeed",void 0),J([xe()],Ea.prototype,"keysRotateLeft",void 0),J([xe()],Ea.prototype,"keysRotateRight",void 0),J([xe()],Ea.prototype,"keysRotateUp",void 0),J([xe()],Ea.prototype,"keysRotateDown",void 0),Qa.FreeCameraKeyboardMoveInput=Ea;class E2{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new Re,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=Le.BackCompatCameraNoPreventDefault(arguments);const i=this.camera.getEngine(),s=i.getInputElement();this._pointerInput||(this._pointerInput=n=>{const a=n.event,p=a.pointerType==="touch";if(i.isInVRExclusivePointerMode||!this.touchEnabled&&p||n.type!==Lt.POINTERMOVE&&this.buttons.indexOf(a.button)===-1)return;const _=a.target;if(n.type===Lt.POINTERDOWN){if(p&&this._activePointerId!==-1||!p&&this._currentActiveButton!==-1)return;this._activePointerId=a.pointerId;try{_?.setPointerCapture(a.pointerId)}catch{}this._currentActiveButton===-1&&(this._currentActiveButton=a.button),this._previousPosition={x:a.clientX,y:a.clientY},e||(a.preventDefault(),s&&s.focus()),i.isPointerLock&&this._onMouseMove&&this._onMouseMove(n.event)}else if(n.type===Lt.POINTERUP){if(p&&this._activePointerId!==a.pointerId||!p&&this._currentActiveButton!==a.button)return;try{_?.releasePointerCapture(a.pointerId)}catch{}this._currentActiveButton=-1,this._previousPosition=null,e||a.preventDefault(),this._activePointerId=-1}else if(n.type===Lt.POINTERMOVE&&(this._activePointerId===a.pointerId||!p)){if(i.isPointerLock&&this._onMouseMove)this._onMouseMove(n.event);else if(this._previousPosition){let g=a.clientX-this._previousPosition.x;const y=a.clientY-this._previousPosition.y;this.camera.getScene().useRightHandedSystem&&(g*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(g*=-1),this._allowCameraRotation&&(this.camera.cameraRotation.y+=g/this.angularSensibility,this.camera.cameraRotation.x+=y/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:g,offsetY:y}),this._previousPosition={x:a.clientX,y:a.clientY},e||a.preventDefault()}}}),this._onMouseMove=n=>{if(!i.isPointerLock||i.isInVRExclusivePointerMode)return;let a=n.movementX;this.camera.getScene().useRightHandedSystem&&(a*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(a*=-1),this.camera.cameraRotation.y+=a/this.angularSensibility;const p=n.movementY;this.camera.cameraRotation.x+=p/this.angularSensibility,this._previousPosition=null,e||n.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Lt.POINTERDOWN|Lt.POINTERUP|Lt.POINTERMOVE),s&&(this._contextMenuBind=this.onContextMenu.bind(this),s.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){const i=this.camera.getEngine().getInputElement();i&&i.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}}J([xe()],E2.prototype,"buttons",void 0),J([xe()],E2.prototype,"angularSensibility",void 0),Qa.FreeCameraMouseInput=E2;class A2{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new Re,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=Le.BackCompatCameraNoPreventDefault(arguments),this._wheel=i=>{if(i.type!==Lt.POINTERWHEEL)return;const s=i.event,n=s.deltaMode===Tc.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*n*s.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*n*s.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*n*s.deltaZ/this._normalize,s.preventDefault&&(e||s.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Lt.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}J([xe()],A2.prototype,"wheelPrecisionX",void 0),J([xe()],A2.prototype,"wheelPrecisionY",void 0),J([xe()],A2.prototype,"wheelPrecisionZ",void 0);var dr;(function(l){l[l.MoveRelative=0]="MoveRelative",l[l.RotateRelative=1]="RotateRelative",l[l.MoveScene=2]="MoveScene"})(dr||(dr={}));class bo extends A2{constructor(){super(...arguments),this._moveRelative=j.Zero(),this._rotateRelative=j.Zero(),this._moveScene=j.Zero(),this._wheelXAction=dr.MoveRelative,this._wheelXActionCoordinate=ml.X,this._wheelYAction=dr.MoveRelative,this._wheelYActionCoordinate=ml.Z,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){e===null&&this._wheelXAction!==dr.MoveRelative||(this._wheelXAction=dr.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==dr.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){e===null&&this._wheelYAction!==dr.MoveRelative||(this._wheelYAction=dr.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==dr.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){e===null&&this._wheelZAction!==dr.MoveRelative||(this._wheelZAction=dr.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==dr.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){e===null&&this._wheelXAction!==dr.RotateRelative||(this._wheelXAction=dr.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==dr.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){e===null&&this._wheelYAction!==dr.RotateRelative||(this._wheelYAction=dr.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==dr.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){e===null&&this._wheelZAction!==dr.RotateRelative||(this._wheelZAction=dr.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==dr.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){e===null&&this._wheelXAction!==dr.MoveScene||(this._wheelXAction=dr.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==dr.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){e===null&&this._wheelYAction!==dr.MoveScene||(this._wheelYAction=dr.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==dr.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){e===null&&this._wheelZAction!==dr.MoveScene||(this._wheelZAction=dr.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==dr.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(this._wheelDeltaX===0&&this._wheelDeltaY===0&&this._wheelDeltaZ==0)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=fe.Zero();this.camera.getViewMatrix().invertToRef(e);const i=j.Zero();j.TransformNormalToRef(this._moveRelative,e,i),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(i),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,i,s){if(e===0||i===null||s===null)return;let n=null;switch(i){case dr.MoveRelative:n=this._moveRelative;break;case dr.RotateRelative:n=this._rotateRelative;break;case dr.MoveScene:n=this._moveScene;break}switch(s){case ml.X:n.set(e,0,0);break;case ml.Y:n.set(0,e,0);break;case ml.Z:n.set(0,0,e);break}}}J([xe()],bo.prototype,"wheelXMoveRelative",null),J([xe()],bo.prototype,"wheelYMoveRelative",null),J([xe()],bo.prototype,"wheelZMoveRelative",null),J([xe()],bo.prototype,"wheelXRotateRelative",null),J([xe()],bo.prototype,"wheelYRotateRelative",null),J([xe()],bo.prototype,"wheelZRotateRelative",null),J([xe()],bo.prototype,"wheelXMoveScene",null),J([xe()],bo.prototype,"wheelYMoveScene",null),J([xe()],bo.prototype,"wheelZMoveScene",null),Qa.FreeCameraMouseWheelInput=bo;class C2{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=Le.IsSafari()}attachControl(e){e=Le.BackCompatCameraNoPreventDefault(arguments);let i=null;if(this._pointerInput===void 0&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=s=>{const n=s.event,a=n.pointerType==="mouse"||this._isSafari&&typeof n.pointerType>"u";if(!(!this.allowMouse&&a)){if(s.type===Lt.POINTERDOWN){if(e||n.preventDefault(),this._pointerPressed.push(n.pointerId),this._pointerPressed.length!==1)return;i={x:n.clientX,y:n.clientY}}else if(s.type===Lt.POINTERUP){e||n.preventDefault();const p=this._pointerPressed.indexOf(n.pointerId);if(p===-1||(this._pointerPressed.splice(p,1),p!=0))return;i=null,this._offsetX=null,this._offsetY=null}else if(s.type===Lt.POINTERMOVE){if(e||n.preventDefault(),!i||this._pointerPressed.indexOf(n.pointerId)!=0)return;this._offsetX=n.clientX-i.x,this._offsetY=-(n.clientY-i.y)}}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Lt.POINTERDOWN|Lt.POINTERUP|Lt.POINTERMOVE),this._onLostFocus){const n=this.camera.getEngine().getInputElement();n&&n.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){const i=this.camera.getEngine().getInputElement();i&&i.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(this._offsetX===null||this._offsetY===null||this._offsetX===0&&this._offsetY===0)return;const e=this.camera;if(e.cameraRotation.y=this._offsetX/this.touchAngularSensibility,this.singleFingerRotate&&this._pointerPressed.length===1||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{const s=e._computeLocalCameraSpeed(),n=new j(0,0,this.touchMoveSensibility!==0?s*this._offsetY/this.touchMoveSensibility:0);fe.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(j.TransformCoordinates(n,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}}J([xe()],C2.prototype,"touchAngularSensibility",void 0),J([xe()],C2.prototype,"touchMoveSensibility",void 0),Qa.FreeCameraTouchInput=C2;class a_ extends kE{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new Ea),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new E2(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new bo,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new C2),this}clear(){super.clear(),this._mouseInput=null}}class Vn extends rs{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const i=this.inputs.attached.mouse;i&&(i.angularSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const i=this.inputs.attached.keyboard;i&&(i.keysUp=e)}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const i=this.inputs.attached.keyboard;i&&(i.keysUpward=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const i=this.inputs.attached.keyboard;i&&(i.keysDown=e)}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const i=this.inputs.attached.keyboard;i&&(i.keysDownward=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const i=this.inputs.attached.keyboard;i&&(i.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const i=this.inputs.attached.keyboard;i&&(i.keysRight=e)}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const i=this.inputs.attached.keyboard;i&&(i.keysRotateLeft=e)}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const i=this.inputs.attached.keyboard;i&&(i.keysRotateRight=e)}get keysRotateUp(){const e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){const i=this.inputs.attached.keyboard;i&&(i.keysRotateUp=e)}get keysRotateDown(){const e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){const i=this.inputs.attached.keyboard;i&&(i.keysRotateDown=e)}constructor(e,i,s,n=!0){super(e,i,s,n),this.ellipsoid=new j(.5,1,.5),this.ellipsoidOffset=new j(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=j.Zero(),this._diffPosition=j.Zero(),this._newPosition=j.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(a,p,_=null)=>{(y=>{this._newPosition.copyFrom(y),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>Ae.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&_&&this.onCollide(_))})(p)},this.inputs=new a_(this),this.inputs.addKeyboard().addMouse()}attachControl(e,i){i=Le.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(i)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new j(0,0,0),this.cameraRotation=new ii(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let i;this.parent?i=j.TransformCoordinates(this.position,this.parent.getWorldMatrix()):i=this.position,i.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const s=this.getScene().collisionCoordinator;this._collider||(this._collider=s.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let n=e;this.applyGravity&&(n=e.add(this.getScene().gravity)),s.getNewPosition(this._oldPosition,n,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=j.Zero(),this._transformedDirection=j.Zero()),this.inputs.checkInputs(),super._checkInputs()}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}}J([Rn()],Vn.prototype,"ellipsoid",void 0),J([Rn()],Vn.prototype,"ellipsoidOffset",void 0),J([xe()],Vn.prototype,"checkCollisions",void 0),J([xe()],Vn.prototype,"applyGravity",void 0),vr.AddNodeConstructor("TouchCamera",(l,e)=>()=>new UE(l,j.Zero(),e));class UE extends Vn{get touchAngularSensibility(){const e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0}set touchAngularSensibility(e){const i=this.inputs.attached.touch;i&&(i.touchAngularSensibility=e)}get touchMoveSensibility(){const e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0}set touchMoveSensibility(e){const i=this.inputs.attached.touch;i&&(i.touchMoveSensibility=e)}constructor(e,i,s){super(e,i,s),this.inputs.addTouch(),this._setupInputs()}getClassName(){return"TouchCamera"}_setupInputs(){const e=this.inputs.attached.touch,i=this.inputs.attached.mouse;i?i.touchEnabled=!1:e.allowMouse=!0}}class o_{constructor(e,i,s){this.bu=e,this.bv=i,this.distance=s,this.faceId=0,this.subMeshId=0}}class wi{constructor(e,i,s=Number.MAX_VALUE){this.origin=e,this.direction=i,this.length=s}clone(){return new wi(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,i,s=0){const n=wi._TmpVector3[0].copyFromFloats(e.x-s,e.y-s,e.z-s),a=wi._TmpVector3[1].copyFromFloats(i.x+s,i.y+s,i.z+s);let p=0,_=Number.MAX_VALUE,g,y,b,v;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<n.x||this.origin.x>a.x)return!1}else if(g=1/this.direction.x,y=(n.x-this.origin.x)*g,b=(a.x-this.origin.x)*g,b===-1/0&&(b=1/0),y>b&&(v=y,y=b,b=v),p=Math.max(y,p),_=Math.min(b,_),p>_)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<n.y||this.origin.y>a.y)return!1}else if(g=1/this.direction.y,y=(n.y-this.origin.y)*g,b=(a.y-this.origin.y)*g,b===-1/0&&(b=1/0),y>b&&(v=y,y=b,b=v),p=Math.max(y,p),_=Math.min(b,_),p>_)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<n.z||this.origin.z>a.z)return!1}else if(g=1/this.direction.z,y=(n.z-this.origin.z)*g,b=(a.z-this.origin.z)*g,b===-1/0&&(b=1/0),y>b&&(v=y,y=b,b=v),p=Math.max(y,p),_=Math.min(b,_),p>_)return!1;return!0}intersectsBox(e,i=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,i)}intersectsSphere(e,i=0){const s=e.center.x-this.origin.x,n=e.center.y-this.origin.y,a=e.center.z-this.origin.z,p=s*s+n*n+a*a,_=e.radius+i,g=_*_;if(p<=g)return!0;const y=s*this.direction.x+n*this.direction.y+a*this.direction.z;return y<0?!1:p-y*y<=g}intersectsTriangle(e,i,s){const n=wi._TmpVector3[0],a=wi._TmpVector3[1],p=wi._TmpVector3[2],_=wi._TmpVector3[3],g=wi._TmpVector3[4];i.subtractToRef(e,n),s.subtractToRef(e,a),j.CrossToRef(this.direction,a,p);const y=j.Dot(n,p);if(y===0)return null;const b=1/y;this.origin.subtractToRef(e,_);const v=j.Dot(_,p)*b;if(v<0||v>1)return null;j.CrossToRef(_,n,g);const S=j.Dot(this.direction,g)*b;if(S<0||v+S>1)return null;const M=j.Dot(a,g)*b;return M>this.length?null:new o_(1-v-S,v,M)}intersectsPlane(e){let i;const s=j.Dot(e.normal,this.direction);if(Math.abs(s)<999999997475243e-21)return null;{const n=j.Dot(e.normal,this.origin);return i=(-e.d-n)/s,i<0?i<-999999997475243e-21?null:0:i}}intersectsAxis(e,i=0){switch(e){case"y":{const s=(this.origin.y-i)/this.direction.y;return s>0?null:new j(this.origin.x+this.direction.x*-s,i,this.origin.z+this.direction.z*-s)}case"x":{const s=(this.origin.x-i)/this.direction.x;return s>0?null:new j(i,this.origin.y+this.direction.y*-s,this.origin.z+this.direction.z*-s)}case"z":{const s=(this.origin.z-i)/this.direction.z;return s>0?null:new j(this.origin.x+this.direction.x*-s,this.origin.y+this.direction.y*-s,i)}default:return null}}intersectsMesh(e,i){const s=ge.Matrix[0];return e.getWorldMatrix().invertToRef(s),this._tmpRay?wi.TransformToRef(this,s,this._tmpRay):this._tmpRay=wi.Transform(this,s),e.intersects(this._tmpRay,i)}intersectsMeshes(e,i,s){s?s.length=0:s=[];for(let n=0;n<e.length;n++){const a=this.intersectsMesh(e[n],i);a.hit&&s.push(a)}return s.sort(this._comparePickingInfo),s}_comparePickingInfo(e,i){return e.distance<i.distance?-1:e.distance>i.distance?1:0}intersectionSegment(e,i,s){const n=this.origin,a=ge.Vector3[0],p=ge.Vector3[1],_=ge.Vector3[2],g=ge.Vector3[3];i.subtractToRef(e,a),this.direction.scaleToRef(wi._Rayl,_),n.addToRef(_,p),e.subtractToRef(n,g);const y=j.Dot(a,a),b=j.Dot(a,_),v=j.Dot(_,_),S=j.Dot(a,g),M=j.Dot(_,g),F=y*v-b*b;let L,N=F,k,G=F;F<wi._Smallnum?(L=0,N=1,k=M,G=v):(L=b*M-v*S,k=y*M-b*S,L<0?(L=0,k=M,G=v):L>N&&(L=N,k=M+b,G=v)),k<0?(k=0,-S<0?L=0:-S>y?L=N:(L=-S,N=y)):k>G&&(k=G,-S+b<0?L=0:-S+b>y?L=N:(L=-S+b,N=y));const H=Math.abs(L)<wi._Smallnum?0:L/N,z=Math.abs(k)<wi._Smallnum?0:k/G,W=ge.Vector3[4];_.scaleToRef(z,W);const Y=ge.Vector3[5];a.scaleToRef(H,Y),Y.addInPlace(g);const Z=ge.Vector3[6];return Y.subtractToRef(W,Z),z>0&&z<=this.length&&Z.lengthSquared()<s*s?Y.length():-1}update(e,i,s,n,a,p,_,g=!1){if(g){wi._RayDistant||(wi._RayDistant=wi.Zero()),wi._RayDistant.unprojectRayToRef(e,i,s,n,fe.IdentityReadOnly,p,_);const y=ge.Matrix[0];a.invertToRef(y),wi.TransformToRef(wi._RayDistant,y,this)}else this.unprojectRayToRef(e,i,s,n,a,p,_);return this}static Zero(){return new wi(j.Zero(),j.Zero())}static CreateNew(e,i,s,n,a,p,_){return wi.Zero().update(e,i,s,n,a,p,_)}static CreateNewFromTo(e,i,s=fe.IdentityReadOnly){const n=i.subtract(e),a=Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z);return n.normalize(),wi.Transform(new wi(e,n,a),s)}static Transform(e,i){const s=new wi(new j(0,0,0),new j(0,0,0));return wi.TransformToRef(e,i,s),s}static TransformToRef(e,i,s){j.TransformCoordinatesToRef(e.origin,i,s.origin),j.TransformNormalToRef(e.direction,i,s.direction),s.length=e.length;const n=s.direction,a=n.length();if(!(a===0||a===1)){const p=1/a;n.x*=p,n.y*=p,n.z*=p,s.length*=a}}unprojectRayToRef(e,i,s,n,a,p,_){var g;const y=ge.Matrix[0];a.multiplyToRef(p,y),y.multiplyToRef(_,y),y.invert();const b=ge.Vector3[0];b.x=e/s*2-1,b.y=-(i/n*2-1),b.z=!((g=Zt.LastCreatedEngine)===null||g===void 0)&&g.isNDCHalfZRange?0:-1;const v=ge.Vector3[1].copyFromFloats(b.x,b.y,1-1e-8),S=ge.Vector3[2],M=ge.Vector3[3];j._UnprojectFromInvertedMatrixToRef(b,y,S),j._UnprojectFromInvertedMatrixToRef(v,y,M),this.origin.copyFrom(S),M.subtractToRef(S,this.direction),this.direction.normalize()}}wi._TmpVector3=As.BuildArray(6,j.Zero),wi._RayDistant=wi.Zero(),wi._Smallnum=1e-8,wi._Rayl=1e9,Nt.prototype.createPickingRay=function(l,e,i,s,n=!1){const a=wi.Zero();return this.createPickingRayToRef(l,e,i,a,s,n),a},Nt.prototype.createPickingRayToRef=function(l,e,i,s,n,a=!1,p=!1){const _=this.getEngine();if(!n){if(!this.activeCamera)return this;n=this.activeCamera}const y=n.viewport.toGlobal(_.getRenderWidth(),_.getRenderHeight());return l=l/_.getHardwareScalingLevel()-y.x,e=e/_.getHardwareScalingLevel()-(_.getRenderHeight()-y.y-y.height),s.update(l,e,y.width,y.height,i||fe.IdentityReadOnly,a?fe.IdentityReadOnly:n.getViewMatrix(),n.getProjectionMatrix(),p),this},Nt.prototype.createPickingRayInCameraSpace=function(l,e,i){const s=wi.Zero();return this.createPickingRayInCameraSpaceToRef(l,e,s,i),s},Nt.prototype.createPickingRayInCameraSpaceToRef=function(l,e,i,s){if(!In)return this;const n=this.getEngine();if(!s){if(!this.activeCamera)throw new Error("Active camera not set");s=this.activeCamera}const p=s.viewport.toGlobal(n.getRenderWidth(),n.getRenderHeight()),_=fe.Identity();return l=l/n.getHardwareScalingLevel()-p.x,e=e/n.getHardwareScalingLevel()-(n.getRenderHeight()-p.y-p.height),i.update(l,e,p.width,p.height,_,_,s.getProjectionMatrix()),this},Nt.prototype._internalPickForMesh=function(l,e,i,s,n,a,p,_){const g=e(s,i.enableDistantPicking),y=i.intersects(g,n,p,a,s,_);return!y||!y.hit||!n&&l!=null&&y.distance>=l.distance?null:y},Nt.prototype._internalPick=function(l,e,i,s,n){let a=null;const p=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),_=this.cameraToUseForPointers||this.activeCamera;for(let g=0;g<this.meshes.length;g++){const y=this.meshes[g];if(e){if(!e(y))continue}else if(!y.isEnabled()||!y.isVisible||!y.isPickable)continue;const b=p&&y.isWorldMatrixCameraDependent(),v=y.computeWorldMatrix(b,_);if(y.hasThinInstances&&y.thinInstanceEnablePicking){const S=this._internalPickForMesh(a,l,y,v,!0,!0,n);if(S){if(s)return S;const M=ge.Matrix[1],F=y.thinInstanceGetWorldMatrices();for(let L=0;L<F.length;L++){F[L].multiplyToRef(v,M);const k=this._internalPickForMesh(a,l,y,M,i,s,n,!0);if(k&&(a=k,a.thinInstanceIndex=L,i))return a}}}else{const S=this._internalPickForMesh(a,l,y,v,i,s,n);if(S&&(a=S,i))return a}}return a||new In},Nt.prototype._internalMultiPick=function(l,e,i){if(!In)return null;const s=new Array,n=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),a=this.cameraToUseForPointers||this.activeCamera;for(let p=0;p<this.meshes.length;p++){const _=this.meshes[p];if(e){if(!e(_))continue}else if(!_.isEnabled()||!_.isVisible||!_.isPickable)continue;const g=n&&_.isWorldMatrixCameraDependent(),y=_.computeWorldMatrix(g,a);if(_.hasThinInstances&&_.thinInstanceEnablePicking){if(this._internalPickForMesh(null,l,_,y,!0,!0,i)){const v=ge.Matrix[1],S=_.thinInstanceGetWorldMatrices();for(let M=0;M<S.length;M++){S[M].multiplyToRef(y,v);const L=this._internalPickForMesh(null,l,_,v,!1,!1,i,!0);L&&(L.thinInstanceIndex=M,s.push(L))}}}else{const b=this._internalPickForMesh(null,l,_,y,!1,!1,i);b&&s.push(b)}}return s},Nt.prototype.pickWithBoundingInfo=function(l,e,i,s,n){if(!In)return null;const a=this._internalPick(p=>(this._tempPickingRay||(this._tempPickingRay=wi.Zero()),this.createPickingRayToRef(l,e,p,this._tempPickingRay,n||null),this._tempPickingRay),i,s,!0);return a&&(a.ray=this.createPickingRay(l,e,fe.Identity(),n||null)),a},Object.defineProperty(Nt.prototype,"_pickingAvailable",{get:()=>!0,enumerable:!1,configurable:!1}),Nt.prototype.pick=function(l,e,i,s,n,a,p=!1){const _=this._internalPick((g,y)=>(this._tempPickingRay||(this._tempPickingRay=wi.Zero()),this.createPickingRayToRef(l,e,g,this._tempPickingRay,n||null,!1,y),this._tempPickingRay),i,s,!1,a);return _&&(_.ray=this.createPickingRay(l,e,fe.Identity(),n||null)),_},Nt.prototype.pickWithRay=function(l,e,i,s){const n=this._internalPick(a=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=fe.Identity()),a.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=wi.Zero()),wi.TransformToRef(l,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),e,i,!1,s);return n&&(n.ray=l),n},Nt.prototype.multiPick=function(l,e,i,s,n){return this._internalMultiPick(a=>this.createPickingRay(l,e,a,s||null),i,n)},Nt.prototype.multiPickWithRay=function(l,e,i){return this._internalMultiPick(s=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=fe.Identity()),s.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=wi.Zero()),wi.TransformToRef(l,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),e,i)},wt.prototype.getForwardRay=function(l=100,e,i){return this.getForwardRayToRef(new wi(j.Zero(),j.Zero(),l),l,e,i)},wt.prototype.getForwardRayToRef=function(l,e=100,i,s){return i||(i=this.getWorldMatrix()),l.length=e,s?l.origin.copyFrom(s):l.origin.copyFrom(this.position),ge.Vector3[2].set(0,0,this._scene.useRightHandedSystem?-1:1),j.TransformNormalToRef(ge.Vector3[2],i,ge.Vector3[3]),j.NormalizeToRef(ge.Vector3[3],l.direction),l};class ZY{constructor(e,i){this.x=e,this.y=i}}class kr{get isConnected(){return this._isConnected}constructor(e,i,s,n=0,a=1,p=2,_=3){this.id=e,this.index=i,this.browserGamepad=s,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=kr.GAMEPAD,this._leftStickAxisX=n,this._leftStickAxisY=a,this._rightStickAxisX=p,this._rightStickAxisY=_,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}onleftstickchanged(e){this._onleftstickchanged=e}onrightstickchanged(e){this._onrightstickchanged=e}get leftStick(){return this._leftStick}set leftStick(e){this._onleftstickchanged&&(this._leftStick.x!==e.x||this._leftStick.y!==e.y)&&this._onleftstickchanged(e),this._leftStick=e}get rightStick(){return this._rightStick}set rightStick(e){this._onrightstickchanged&&(this._rightStick.x!==e.x||this._rightStick.y!==e.y)&&this._onrightstickchanged(e),this._rightStick=e}update(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}dispose(){}}kr.GAMEPAD=0,kr.GENERIC=1,kr.XBOX=2,kr.POSE_ENABLED=3,kr.DUALSHOCK=4;class z9 extends kr{onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}constructor(e,i,s){super(e,i,s),this.onButtonDownObservable=new Re,this.onButtonUpObservable=new Re,this.type=kr.GENERIC,this._buttons=new Array(s.buttons.length)}_setButtonValue(e,i,s){return e!==i&&(e===1&&(this._onbuttondown&&this._onbuttondown(s),this.onButtonDownObservable.notifyObservers(s)),e===0&&(this._onbuttonup&&this._onbuttonup(s),this.onButtonUpObservable.notifyObservers(s))),e}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()}}var Kh;(function(l){l[l.VIVE=0]="VIVE",l[l.OCULUS=1]="OCULUS",l[l.WINDOWS=2]="WINDOWS",l[l.GEAR_VR=3]="GEAR_VR",l[l.DAYDREAM=4]="DAYDREAM",l[l.GENERIC=5]="GENERIC"})(Kh||(Kh={}));class x_{static InitiateController(e){for(const i of this._ControllerFactories)if(i.canCreate(e))return i.create(e);if(this._DefaultControllerFactory)return this._DefaultControllerFactory(e);throw"The type of gamepad you are trying to load needs to be imported first or is not supported."}}x_._ControllerFactories=[],x_._DefaultControllerFactory=null;class R2 extends kr{_disableTrackPosition(e){this._trackPosition&&(this._calculatedPosition.copyFrom(e),this._trackPosition=!1)}constructor(e){super(e.id,e.index,e),this.isXR=!1,this._deviceRoomPosition=j.Zero(),this._deviceRoomRotationQuaternion=new Ve,this.devicePosition=j.Zero(),this.deviceRotationQuaternion=new Ve,this.deviceScaleFactor=1,this._trackPosition=!0,this._maxRotationDistFromHeadset=Math.PI/5,this._draggedRoomRotation=0,this._leftHandSystemQuaternion=new Ve,this._deviceToWorld=fe.Identity(),this._pointingPoseNode=null,this._workingMatrix=fe.Identity(),this._meshAttachedObservable=new Re,this.type=kr.POSE_ENABLED,this.controllerType=Kh.GENERIC,this.position=j.Zero(),this.rotationQuaternion=new Ve,this._calculatedPosition=j.Zero(),this._calculatedRotation=new Ve,Ve.RotationYawPitchRollToRef(Math.PI,0,0,this._leftHandSystemQuaternion)}update(){super.update(),this._updatePoseAndMesh()}_updatePoseAndMesh(){if(this.isXR)return;const e=this.browserGamepad.pose;if(this.updateFromDevice(e),!this._trackPosition&&Zt.LastCreatedScene&&Zt.LastCreatedScene.activeCamera&&Zt.LastCreatedScene.activeCamera.devicePosition){const i=Zt.LastCreatedScene.activeCamera;if(i._computeDevicePosition(),this._deviceToWorld.setTranslation(i.devicePosition),i.deviceRotationQuaternion){i._deviceRoomRotationQuaternion.toEulerAnglesToRef(ge.Vector3[0]);const s=Math.atan2(Math.sin(ge.Vector3[0].y-this._draggedRoomRotation),Math.cos(ge.Vector3[0].y-this._draggedRoomRotation));if(Math.abs(s)>this._maxRotationDistFromHeadset){const n=s-(s<0?-this._maxRotationDistFromHeadset:this._maxRotationDistFromHeadset);this._draggedRoomRotation+=n;const a=Math.sin(-n),p=Math.cos(-n);this._calculatedPosition.x=this._calculatedPosition.x*p-this._calculatedPosition.z*a,this._calculatedPosition.z=this._calculatedPosition.x*a+this._calculatedPosition.z*p}}}j.TransformCoordinatesToRef(this._calculatedPosition,this._deviceToWorld,this.devicePosition),this._deviceToWorld.getRotationMatrixToRef(this._workingMatrix),Ve.FromRotationMatrixToRef(this._workingMatrix,this.deviceRotationQuaternion),this.deviceRotationQuaternion.multiplyInPlace(this._calculatedRotation),this._mesh&&(this._mesh.position.copyFrom(this.devicePosition),this._mesh.rotationQuaternion&&this._mesh.rotationQuaternion.copyFrom(this.deviceRotationQuaternion))}updateFromDevice(e){if(!this.isXR&&e){this.rawPose=e,e.position&&(this._deviceRoomPosition.copyFromFloats(e.position[0],e.position[1],-e.position[2]),this._mesh&&this._mesh.getScene().useRightHandedSystem&&(this._deviceRoomPosition.z*=-1),this._trackPosition&&this._deviceRoomPosition.scaleToRef(this.deviceScaleFactor,this._calculatedPosition),this._calculatedPosition.addInPlace(this.position));const i=this.rawPose;e.orientation&&i.orientation&&i.orientation.length===4&&(this._deviceRoomRotationQuaternion.copyFromFloats(i.orientation[0],i.orientation[1],-i.orientation[2],-i.orientation[3]),this._mesh&&(this._mesh.getScene().useRightHandedSystem?(this._deviceRoomRotationQuaternion.z*=-1,this._deviceRoomRotationQuaternion.w*=-1):this._deviceRoomRotationQuaternion.multiplyToRef(this._leftHandSystemQuaternion,this._deviceRoomRotationQuaternion)),this._deviceRoomRotationQuaternion.multiplyToRef(this.rotationQuaternion,this._calculatedRotation))}}attachToMesh(e){if(this._mesh&&(this._mesh.parent=null),this._mesh=e,this._poseControlledCamera&&(this._mesh.parent=this._poseControlledCamera),this._mesh.rotationQuaternion||(this._mesh.rotationQuaternion=new Ve),!this.isXR&&(this._updatePoseAndMesh(),this._pointingPoseNode)){const i=[];let s=this._pointingPoseNode;for(;s.parent;)i.push(s.parent),s=s.parent;i.reverse().forEach(n=>{n.computeWorldMatrix(!0)})}this._meshAttachedObservable.notifyObservers(e)}attachToPoseControlledCamera(e){this._poseControlledCamera=e,this._mesh&&(this._mesh.parent=this._poseControlledCamera)}dispose(){this._mesh&&this._mesh.dispose(),this._mesh=null,super.dispose()}get mesh(){return this._mesh}getForwardRay(e=100){if(!this.mesh)return new wi(j.Zero(),new j(0,0,1),e);const i=this._pointingPoseNode?this._pointingPoseNode.getWorldMatrix():this.mesh.getWorldMatrix(),s=i.getTranslation(),n=new j(0,0,-1),a=j.TransformNormal(n,i),p=j.Normalize(a);return new wi(s,p,e)}}R2.POINTING_POSE="POINTING_POSE";var xa;(function(l){l[l.A=0]="A",l[l.B=1]="B",l[l.X=2]="X",l[l.Y=3]="Y",l[l.LB=4]="LB",l[l.RB=5]="RB",l[l.Back=8]="Back",l[l.Start=9]="Start",l[l.LeftStick=10]="LeftStick",l[l.RightStick=11]="RightStick"})(xa||(xa={}));var Ec;(function(l){l[l.Up=12]="Up",l[l.Down=13]="Down",l[l.Left=14]="Left",l[l.Right=15]="Right"})(Ec||(Ec={}));class H9 extends kr{constructor(e,i,s,n=!1){super(e,i,s,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new Re,this.onButtonUpObservable=new Re,this.onPadDownObservable=new Re,this.onPadUpObservable=new Re,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLB=0,this._buttonRB=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this._isXboxOnePad=!1,this.type=kr.XBOX,this._isXboxOnePad=n}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,i,s){return e!==i&&(e===1&&(this._onbuttondown&&this._onbuttondown(s),this.onButtonDownObservable.notifyObservers(s)),e===0&&(this._onbuttonup&&this._onbuttonup(s),this.onButtonUpObservable.notifyObservers(s))),e}_setDPadValue(e,i,s){return e!==i&&(e===1&&(this._ondpaddown&&this._ondpaddown(s),this.onPadDownObservable.notifyObservers(s)),e===0&&(this._ondpadup&&this._ondpadup(s),this.onPadUpObservable.notifyObservers(s))),e}get buttonA(){return this._buttonA}set buttonA(e){this._buttonA=this._setButtonValue(e,this._buttonA,xa.A)}get buttonB(){return this._buttonB}set buttonB(e){this._buttonB=this._setButtonValue(e,this._buttonB,xa.B)}get buttonX(){return this._buttonX}set buttonX(e){this._buttonX=this._setButtonValue(e,this._buttonX,xa.X)}get buttonY(){return this._buttonY}set buttonY(e){this._buttonY=this._setButtonValue(e,this._buttonY,xa.Y)}get buttonStart(){return this._buttonStart}set buttonStart(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,xa.Start)}get buttonBack(){return this._buttonBack}set buttonBack(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,xa.Back)}get buttonLB(){return this._buttonLB}set buttonLB(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,xa.LB)}get buttonRB(){return this._buttonRB}set buttonRB(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,xa.RB)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,xa.LeftStick)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,xa.RightStick)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,Ec.Up)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,Ec.Down)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,Ec.Left)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,Ec.Right)}update(){super.update(),this._isXboxOnePad?(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value):(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}var $a;(function(l){l[l.Cross=0]="Cross",l[l.Circle=1]="Circle",l[l.Square=2]="Square",l[l.Triangle=3]="Triangle",l[l.L1=4]="L1",l[l.R1=5]="R1",l[l.Share=8]="Share",l[l.Options=9]="Options",l[l.LeftStick=10]="LeftStick",l[l.RightStick=11]="RightStick"})($a||($a={}));var Ac;(function(l){l[l.Up=12]="Up",l[l.Down=13]="Down",l[l.Left=14]="Left",l[l.Right=15]="Right"})(Ac||(Ac={}));class X9 extends kr{constructor(e,i,s){super(e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),i,s,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new Re,this.onButtonUpObservable=new Re,this.onPadDownObservable=new Re,this.onPadUpObservable=new Re,this._buttonCross=0,this._buttonCircle=0,this._buttonSquare=0,this._buttonTriangle=0,this._buttonShare=0,this._buttonOptions=0,this._buttonL1=0,this._buttonR1=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this.type=kr.DUALSHOCK}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,i,s){return e!==i&&(e===1&&(this._onbuttondown&&this._onbuttondown(s),this.onButtonDownObservable.notifyObservers(s)),e===0&&(this._onbuttonup&&this._onbuttonup(s),this.onButtonUpObservable.notifyObservers(s))),e}_setDPadValue(e,i,s){return e!==i&&(e===1&&(this._ondpaddown&&this._ondpaddown(s),this.onPadDownObservable.notifyObservers(s)),e===0&&(this._ondpadup&&this._ondpadup(s),this.onPadUpObservable.notifyObservers(s))),e}get buttonCross(){return this._buttonCross}set buttonCross(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,$a.Cross)}get buttonCircle(){return this._buttonCircle}set buttonCircle(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,$a.Circle)}get buttonSquare(){return this._buttonSquare}set buttonSquare(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,$a.Square)}get buttonTriangle(){return this._buttonTriangle}set buttonTriangle(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,$a.Triangle)}get buttonOptions(){return this._buttonOptions}set buttonOptions(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,$a.Options)}get buttonShare(){return this._buttonShare}set buttonShare(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,$a.Share)}get buttonL1(){return this._buttonL1}set buttonL1(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,$a.L1)}get buttonR1(){return this._buttonR1}set buttonR1(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,$a.R1)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,$a.LeftStick)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,$a.RightStick)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,Ac.Up)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,Ac.Down)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,Ac.Left)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,Ac.Right)}update(){super.update(),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}class Y9{constructor(e){if(this._scene=e,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new Re,Ts()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&navigator.getGamepads):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new Re(i=>{for(const s in this._babylonGamepads){const n=this._babylonGamepads[s];n&&n._isConnected&&this.onGamepadConnectedObservable.notifyObserver(i,n)}}),this._onGamepadConnectedEvent=i=>{const s=i.gamepad;if(s.index in this._babylonGamepads&&this._babylonGamepads[s.index].isConnected)return;let n;this._babylonGamepads[s.index]?(n=this._babylonGamepads[s.index],n.browserGamepad=s,n._isConnected=!0):n=this._addNewGamepad(s),this.onGamepadConnectedObservable.notifyObservers(n),this._startMonitoringGamepads()},this._onGamepadDisconnectedEvent=i=>{const s=i.gamepad;for(const n in this._babylonGamepads)if(this._babylonGamepads[n].index===s.index){const a=this._babylonGamepads[n];a._isConnected=!1,this.onGamepadDisconnectedObservable.notifyObservers(a),a.dispose&&a.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){const i=this._scene?this._scene.getEngine().getHostWindow():window;i&&(i.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),i.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}get gamepads(){return this._babylonGamepads}getGamepadByType(e=kr.XBOX){for(const i of this._babylonGamepads)if(i&&i.type===e)return i;return null}dispose(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null),this._babylonGamepads.forEach(e=>{e.dispose()}),this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]}_addNewGamepad(e){this._oneGamepadConnected||(this._oneGamepadConnected=!0);let i;const s=e.id.search("054c")!==-1&&e.id.search("0ce6")===-1,n=e.id.search("Xbox One")!==-1;return n||e.id.search("Xbox 360")!==-1||e.id.search("xinput")!==-1||e.id.search("045e")!==-1&&e.id.search("Surface Dock")===-1?i=new H9(e.id,e.index,e,n):s?i=new X9(e.id,e.index,e):e.pose?i=x_.InitiateController(e):i=new z9(e.id,e.index,e),this._babylonGamepads[i.index]=i,i}_startMonitoringGamepads(){this._isMonitoring||(this._isMonitoring=!0,this._scene||this._checkGamepadsStatus())}_stopMonitoringGamepads(){this._isMonitoring=!1}_checkGamepadsStatus(){this._updateGamepadObjects();for(const e in this._babylonGamepads){const i=this._babylonGamepads[e];if(!(!i||!i.isConnected))try{i.update()}catch{this._loggedErrors.indexOf(i.index)===-1&&(Le.Warn(`Error updating gamepad ${i.id}`),this._loggedErrors.push(i.index))}}this._isMonitoring&&!this._scene&&Ae.QueueNewFrame(()=>{this._checkGamepadsStatus()})}_updateGamepadObjects(){const e=navigator.getGamepads?navigator.getGamepads():[];for(let i=0;i<e.length;i++){const s=e[i];if(s)if(this._babylonGamepads[s.index])this._babylonGamepads[i].browserGamepad=s,this._babylonGamepads[i].isConnected||(this._babylonGamepads[i]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[i]));else{const n=this._addNewGamepad(s);this.onGamepadConnectedObservable.notifyObservers(n)}}}}class I2{constructor(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this.deadzoneDelta=.1,this._yAxisScale=1,this._cameraTransform=fe.Identity(),this._deltaTransform=j.Zero(),this._vector3=j.Zero(),this._vector2=ii.Zero()}get invertYAxis(){return this._yAxisScale!==1}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(i=>{i.type!==kr.POSE_ENABLED&&(!this.gamepad||i.type===kr.XBOX)&&(this.gamepad=i)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(i=>{this.gamepad===i&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(kr.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad&&this.gamepad.leftStick){const e=this.camera,i=this.gamepad.leftStick;this.gamepadMoveSensibility!==0&&(i.x=Math.abs(i.x)>this.deadzoneDelta?i.x/this.gamepadMoveSensibility:0,i.y=Math.abs(i.y)>this.deadzoneDelta?i.y/this.gamepadMoveSensibility:0);let s=this.gamepad.rightStick;s&&this.gamepadAngularSensibility!==0?(s.x=Math.abs(s.x)>this.deadzoneDelta?s.x/this.gamepadAngularSensibility:0,s.y=(Math.abs(s.y)>this.deadzoneDelta?s.y/this.gamepadAngularSensibility:0)*this._yAxisScale):s={x:0,y:0},e.rotationQuaternion?e.rotationQuaternion.toRotationMatrix(this._cameraTransform):fe.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,this._cameraTransform);const n=e._computeLocalCameraSpeed()*50;this._vector3.copyFromFloats(i.x*n,0,-i.y*n),j.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),e.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(s.y,s.x),e.cameraRotation.addInPlace(this._vector2)}}getClassName(){return"FreeCameraGamepadInput"}getSimpleName(){return"gamepad"}}J([xe()],I2.prototype,"gamepadAngularSensibility",void 0),J([xe()],I2.prototype,"gamepadMoveSensibility",void 0),Qa.FreeCameraGamepadInput=I2;class VE{constructor(){this._currentActiveButton=-1,this.buttons=[0,1,2]}attachControl(e){e=Le.BackCompatCameraNoPreventDefault(arguments);const i=this.camera.getEngine(),s=i.getInputElement();let n=0,a=null;this._pointA=null,this._pointB=null,this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._pointerInput=_=>{var g,y;const b=_.event,v=b.pointerType==="touch";if(i.isInVRExclusivePointerMode||_.type!==Lt.POINTERMOVE&&this.buttons.indexOf(b.button)===-1)return;const S=b.target;if(this._altKey=b.altKey,this._ctrlKey=b.ctrlKey,this._metaKey=b.metaKey,this._shiftKey=b.shiftKey,this._buttonsPressed=b.buttons,i.isPointerLock){const M=b.movementX,F=b.movementY;this.onTouch(null,M,F),this._pointA=null,this._pointB=null}else{if(_.type!==Lt.POINTERDOWN&&v&&((g=this._pointA)===null||g===void 0?void 0:g.pointerId)!==b.pointerId&&((y=this._pointB)===null||y===void 0?void 0:y.pointerId)!==b.pointerId)return;if(_.type===Lt.POINTERDOWN&&(this._currentActiveButton===-1||v)){try{S?.setPointerCapture(b.pointerId)}catch{}if(this._pointA===null)this._pointA={x:b.clientX,y:b.clientY,pointerId:b.pointerId,type:b.pointerType};else if(this._pointB===null)this._pointB={x:b.clientX,y:b.clientY,pointerId:b.pointerId,type:b.pointerType};else return;this._currentActiveButton===-1&&!v&&(this._currentActiveButton=b.button),this.onButtonDown(b),e||(b.preventDefault(),s&&s.focus())}else if(_.type===Lt.POINTERDOUBLETAP)this.onDoubleTap(b.pointerType);else if(_.type===Lt.POINTERUP&&(this._currentActiveButton===b.button||v)){try{S?.releasePointerCapture(b.pointerId)}catch{}v||(this._pointB=null),i._badOS?this._pointA=this._pointB=null:this._pointB&&this._pointA&&this._pointA.pointerId==b.pointerId?(this._pointA=this._pointB,this._pointB=null):this._pointA&&this._pointB&&this._pointB.pointerId==b.pointerId?this._pointB=null:this._pointA=this._pointB=null,(n!==0||a)&&(this.onMultiTouch(this._pointA,this._pointB,n,0,a,null),n=0,a=null),this._currentActiveButton=-1,this.onButtonUp(b),e||b.preventDefault()}else if(_.type===Lt.POINTERMOVE){if(e||b.preventDefault(),this._pointA&&this._pointB===null){const M=b.clientX-this._pointA.x,F=b.clientY-this._pointA.y;this.onTouch(this._pointA,M,F),this._pointA.x=b.clientX,this._pointA.y=b.clientY}else if(this._pointA&&this._pointB){const M=this._pointA.pointerId===b.pointerId?this._pointA:this._pointB;M.x=b.clientX,M.y=b.clientY;const F=this._pointA.x-this._pointB.x,L=this._pointA.y-this._pointB.y,N=F*F+L*L,k={x:(this._pointA.x+this._pointB.x)/2,y:(this._pointA.y+this._pointB.y)/2,pointerId:b.pointerId,type:_.type};this.onMultiTouch(this._pointA,this._pointB,n,N,a,k),a=k,n=N}}}},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Lt.POINTERDOWN|Lt.POINTERUP|Lt.POINTERMOVE|Lt.POINTERDOUBLETAP),this._onLostFocus=()=>{this._pointA=this._pointB=null,n=0,a=null,this.onLostFocus()},this._contextMenuBind=this.onContextMenu.bind(this),s&&s.addEventListener("contextmenu",this._contextMenuBind,!1);const p=this.camera.getScene().getEngine().getHostWindow();p&&Le.RegisterTopRootEvents(p,[{name:"blur",handler:this._onLostFocus}])}detachControl(){if(this._onLostFocus){const e=this.camera.getScene().getEngine().getHostWindow();e&&Le.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}])}if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._contextMenuBind){const e=this.camera.getScene().getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this._onLostFocus=null}this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._currentActiveButton=-1}getClassName(){return"BaseCameraPointersInput"}getSimpleName(){return"pointers"}onDoubleTap(e){}onTouch(e,i,s){}onMultiTouch(e,i,s,n,a,p){}onContextMenu(e){e.preventDefault()}onButtonDown(e){}onButtonUp(e){}onLostFocus(){}}J([xe()],VE.prototype,"buttons",void 0);class Gn extends VE{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.pinchZoom=!0,this.panningSensibility=1e3,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this.pinchInwards=!0,this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,i){if(this.panningSensibility!==0&&e&&i){const s=i.x-e.x,n=i.y-e.y;this.camera.inertialPanningX+=-s/this.panningSensibility,this.camera.inertialPanningY+=n/this.panningSensibility}}_computePinchZoom(e,i){const s=this.camera.radius||Gn.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=s*Math.sqrt(e)/Math.sqrt(i):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=(i-e)*.001*s*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(i-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,i,s){this.panningSensibility!==0&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-i/this.panningSensibility,this.camera.inertialPanningY+=s/this.panningSensibility):(this.camera.inertialAlphaOffset-=i/this.angularSensibilityX,this.camera.inertialBetaOffset-=s/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(e,i,s,n,a,p){s===0&&a===null||n===0&&p===null||(this.multiTouchPanAndZoom?(this._computePinchZoom(s,n),this._computeMultiTouchPanning(a,p)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(n)-Math.sqrt(s))>this.camera.pinchToPanMaxDistance?(this._computePinchZoom(s,n),this._isPinching=!0):this._computeMultiTouchPanning(a,p)):this.multiTouchPanning?this._computeMultiTouchPanning(a,p):this.pinchZoom&&this._computePinchZoom(s,n))}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton}onButtonUp(){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}}Gn.MinimumRadiusForPinch=.001,J([xe()],Gn.prototype,"buttons",void 0),J([xe()],Gn.prototype,"angularSensibilityX",void 0),J([xe()],Gn.prototype,"angularSensibilityY",void 0),J([xe()],Gn.prototype,"pinchPrecision",void 0),J([xe()],Gn.prototype,"pinchDeltaPercentage",void 0),J([xe()],Gn.prototype,"useNaturalPinchZoom",void 0),J([xe()],Gn.prototype,"pinchZoom",void 0),J([xe()],Gn.prototype,"panningSensibility",void 0),J([xe()],Gn.prototype,"multiTouchPanning",void 0),J([xe()],Gn.prototype,"multiTouchPanAndZoom",void 0),Qa.ArcRotateCameraPointersInput=Gn;class vo{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}attachControl(e){e=Le.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(i=>{const s=i.event;if(!s.metaKey){if(i.type===vc.KEYDOWN)this._ctrlPressed=s.ctrlKey,this._altPressed=s.altKey,(this.keysUp.indexOf(s.keyCode)!==-1||this.keysDown.indexOf(s.keyCode)!==-1||this.keysLeft.indexOf(s.keyCode)!==-1||this.keysRight.indexOf(s.keyCode)!==-1||this.keysReset.indexOf(s.keyCode)!==-1)&&(this._keys.indexOf(s.keyCode)===-1&&this._keys.push(s.keyCode),s.preventDefault&&(e||s.preventDefault()));else if(this.keysUp.indexOf(s.keyCode)!==-1||this.keysDown.indexOf(s.keyCode)!==-1||this.keysLeft.indexOf(s.keyCode)!==-1||this.keysRight.indexOf(s.keyCode)!==-1||this.keysReset.indexOf(s.keyCode)!==-1){const n=this._keys.indexOf(s.keyCode);n>=0&&this._keys.splice(n,1),s.preventDefault&&(e||s.preventDefault())}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let i=0;i<this._keys.length;i++){const s=this._keys[i];this.keysLeft.indexOf(s)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:this.keysUp.indexOf(s)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:this.keysRight.indexOf(s)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:this.keysDown.indexOf(s)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:this.keysReset.indexOf(s)!==-1&&e.useInputToRestoreState&&e.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}}J([xe()],vo.prototype,"keysUp",void 0),J([xe()],vo.prototype,"keysDown",void 0),J([xe()],vo.prototype,"keysLeft",void 0),J([xe()],vo.prototype,"keysRight",void 0),J([xe()],vo.prototype,"keysReset",void 0),J([xe()],vo.prototype,"panningSensibility",void 0),J([xe()],vo.prototype,"zoomingSensibility",void 0),J([xe()],vo.prototype,"useAltToZoom",void 0),J([xe()],vo.prototype,"angularSpeed",void 0),Qa.ArcRotateCameraKeyboardMoveInput=vo;const K9=40;class jh{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._inertialPanning=j.Zero()}_computeDeltaFromMouseWheelLegacyEvent(e,i){let s=0;const n=e*.01*this.wheelDeltaPercentage*i;return e>0?s=n/(1+this.wheelDeltaPercentage):s=n*(1+this.wheelDeltaPercentage),s}attachControl(e){e=Le.BackCompatCameraNoPreventDefault(arguments),this._wheel=i=>{if(i.type!==Lt.POINTERWHEEL)return;const s=i.event;let n=0;const a=s.deltaMode===Tc.DOM_DELTA_LINE?K9:1,p=-(s.deltaY*a);if(this.customComputeDeltaFromMouseWheel)n=this.customComputeDeltaFromMouseWheel(p,this,s);else if(this.wheelDeltaPercentage){if(n=this._computeDeltaFromMouseWheelLegacyEvent(p,this.camera.radius),n>0){let _=this.camera.radius,g=this.camera.inertialRadiusOffset+n;for(let y=0;y<20&&Math.abs(g)>.001;y++)_-=g,g*=this.camera.inertia;_=at.Clamp(_,0,Number.MAX_VALUE),n=this._computeDeltaFromMouseWheelLegacyEvent(p,_)}}else n=p/(this.wheelPrecision*40);n&&(this.zoomToMouseLocation&&this._hitPlane?this._zoomToMouse(n):this.camera.inertialRadiusOffset+=n),s.preventDefault&&(e||s.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Lt.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}checkInputs(){if(!this.zoomToMouseLocation)return;const e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}_updateHitPlane(){const e=this.camera,i=e.target.subtract(e.position);this._hitPlane=aa.FromPositionAndNormal(e.target,i)}_getPosition(){var e;const i=this.camera,s=i.getScene(),n=s.createPickingRay(s.pointerX,s.pointerY,fe.Identity(),i,!1);let a=0;return this._hitPlane&&(a=(e=n.intersectsPlane(this._hitPlane))!==null&&e!==void 0?e:0),n.origin.addInPlace(n.direction.scaleInPlace(a))}_zoomToMouse(e){var i,s;const n=this.camera,a=1-n.inertia;if(n.lowerRadiusLimit){const b=(i=n.lowerRadiusLimit)!==null&&i!==void 0?i:0;n.radius-(n.inertialRadiusOffset+e)/a<b&&(e=(n.radius-b)*a-n.inertialRadiusOffset)}if(n.upperRadiusLimit){const b=(s=n.upperRadiusLimit)!==null&&s!==void 0?s:0;n.radius-(n.inertialRadiusOffset+e)/a>b&&(e=(n.radius-b)*a-n.inertialRadiusOffset)}const _=e/a/n.radius,g=this._getPosition(),y=ge.Vector3[6];g.subtractToRef(n.target,y),y.scaleInPlace(_),y.scaleInPlace(a),this._inertialPanning.addInPlace(y),n.inertialRadiusOffset+=e}_zeroIfClose(e){Math.abs(e.x)<rr&&(e.x=0),Math.abs(e.y)<rr&&(e.y=0),Math.abs(e.z)<rr&&(e.z=0)}}J([xe()],jh.prototype,"wheelPrecision",void 0),J([xe()],jh.prototype,"zoomToMouseLocation",void 0),J([xe()],jh.prototype,"wheelDeltaPercentage",void 0),Qa.ArcRotateCameraMouseWheelInput=jh;class GE extends kE{constructor(e){super(e)}addMouseWheel(){return this.add(new jh),this}addPointers(){return this.add(new Gn),this}addKeyboard(){return this.add(new vo),this}}class S2{constructor(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}get invertYAxis(){return this._yAxisScale!==1}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(i=>{i.type!==kr.POSE_ENABLED&&(!this.gamepad||i.type===kr.XBOX)&&(this.gamepad=i)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(i=>{this.gamepad===i&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(kr.XBOX)}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad){const e=this.camera,i=this.gamepad.rightStick;if(i){if(i.x!=0){const n=i.x/this.gamepadRotationSensibility;n!=0&&Math.abs(n)>.005&&(e.inertialAlphaOffset+=n)}if(i.y!=0){const n=i.y/this.gamepadRotationSensibility*this._yAxisScale;n!=0&&Math.abs(n)>.005&&(e.inertialBetaOffset+=n)}}const s=this.gamepad.leftStick;if(s&&s.y!=0){const n=s.y/this.gamepadMoveSensibility;n!=0&&Math.abs(n)>.005&&(this.camera.inertialRadiusOffset-=n)}}}getClassName(){return"ArcRotateCameraGamepadInput"}getSimpleName(){return"gamepad"}}J([xe()],S2.prototype,"gamepadRotationSensibility",void 0),J([xe()],S2.prototype,"gamepadMoveSensibility",void 0),Qa.ArcRotateCameraGamepadInput=S2,Object.defineProperty(Nt.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new Y9(this);let l=this._getComponent(Vt.NAME_GAMEPAD);l||(l=new j9(this),this._addComponent(l))}return this._gamepadManager},enumerable:!0,configurable:!0}),a_.prototype.addGamepad=function(){return this.add(new I2),this},GE.prototype.addGamepad=function(){return this.add(new S2),this};class j9{constructor(e){this.name=Vt.NAME_GAMEPAD,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(Vt.STEP_BEFORECAMERAUPDATE_GAMEPAD,this,this._beforeCameraUpdate)}rebuild(){}dispose(){const e=this.scene._gamepadManager;e&&(e.dispose(),this.scene._gamepadManager=null)}_beforeCameraUpdate(){const e=this.scene._gamepadManager;e&&e._isMonitoring&&e._checkGamepadsStatus()}}vr.AddNodeConstructor("FreeCamera",(l,e)=>()=>new M2(l,j.Zero(),e));class M2 extends UE{get gamepadAngularSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0}set gamepadAngularSensibility(e){const i=this.inputs.attached.gamepad;i&&(i.gamepadAngularSensibility=e)}get gamepadMoveSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0}set gamepadMoveSensibility(e){const i=this.inputs.attached.gamepad;i&&(i.gamepadMoveSensibility=e)}constructor(e,i,s){super(e,i,s),this.inputs.addGamepad()}getClassName(){return"UniversalCamera"}}wt._CreateDefaultParsedCamera=(l,e)=>new M2(l,j.Zero(),e);class E0{constructor(e,i,s){this.vectors=As.BuildArray(8,j.Zero),this.center=j.Zero(),this.centerWorld=j.Zero(),this.extendSize=j.Zero(),this.extendSizeWorld=j.Zero(),this.directions=As.BuildArray(3,j.Zero),this.vectorsWorld=As.BuildArray(8,j.Zero),this.minimumWorld=j.Zero(),this.maximumWorld=j.Zero(),this.minimum=j.Zero(),this.maximum=j.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,i,s)}reConstruct(e,i,s){const n=e.x,a=e.y,p=e.z,_=i.x,g=i.y,y=i.z,b=this.vectors;this.minimum.copyFromFloats(n,a,p),this.maximum.copyFromFloats(_,g,y),b[0].copyFromFloats(n,a,p),b[1].copyFromFloats(_,g,y),b[2].copyFromFloats(_,a,p),b[3].copyFromFloats(n,g,p),b[4].copyFromFloats(n,a,y),b[5].copyFromFloats(_,g,p),b[6].copyFromFloats(n,g,y),b[7].copyFromFloats(_,a,y),i.addToRef(e,this.center).scaleInPlace(.5),i.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=s||fe.IdentityReadOnly,this._update(this._worldMatrix)}scale(e){const i=E0._TmpVector3,s=this.maximum.subtractToRef(this.minimum,i[0]),n=s.length();s.normalizeFromLength(n);const a=n*e,p=s.scaleInPlace(a*.5),_=this.center.subtractToRef(p,i[1]),g=this.center.addToRef(p,i[2]);return this.reConstruct(_,g,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){const i=this.minimumWorld,s=this.maximumWorld,n=this.directions,a=this.vectorsWorld,p=this.vectors;if(e.isIdentity()){i.copyFrom(this.minimum),s.copyFrom(this.maximum);for(let _=0;_<8;++_)a[_].copyFrom(p[_]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{i.setAll(Number.MAX_VALUE),s.setAll(-Number.MAX_VALUE);for(let _=0;_<8;++_){const g=a[_];j.TransformCoordinatesToRef(p[_],e,g),i.minimizeInPlace(g),s.maximizeInPlace(g)}s.subtractToRef(i,this.extendSizeWorld).scaleInPlace(.5),s.addToRef(i,this.centerWorld).scaleInPlace(.5)}j.FromArrayToRef(e.m,0,n[0]),j.FromArrayToRef(e.m,4,n[1]),j.FromArrayToRef(e.m,8,n[2]),this._worldMatrix=e}isInFrustum(e){return E0.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return E0.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){const i=this.minimumWorld,s=this.maximumWorld,n=i.x,a=i.y,p=i.z,_=s.x,g=s.y,y=s.z,b=e.x,v=e.y,S=e.z,M=-rr;return!(_-b<M||M>b-n||g-v<M||M>v-a||y-S<M||M>S-p)}intersectsSphere(e){return E0.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,i){const s=this.minimumWorld,n=this.maximumWorld,a=s.x,p=s.y,_=s.z,g=n.x,y=n.y,b=n.z,v=e.x,S=e.y,M=e.z,F=i.x,L=i.y,N=i.z;return!(g<v||a>F||y<S||p>L||b<M||_>N)}dispose(){var e,i;(e=this._drawWrapperFront)===null||e===void 0||e.dispose(),(i=this._drawWrapperBack)===null||i===void 0||i.dispose()}static Intersects(e,i){return e.intersectsMinMax(i.minimumWorld,i.maximumWorld)}static IntersectsSphere(e,i,s,n){const a=E0._TmpVector3[0];return j.ClampToRef(s,e,i,a),j.DistanceSquared(s,a)<=n*n}static IsCompletelyInFrustum(e,i){for(let s=0;s<6;++s){const n=i[s];for(let a=0;a<8;++a)if(n.dotCoordinate(e[a])<0)return!1}return!0}static IsInFrustum(e,i){for(let s=0;s<6;++s){let n=!0;const a=i[s];for(let p=0;p<8;++p)if(a.dotCoordinate(e[p])>=0){n=!1;break}if(n)return!1}return!0}}E0._TmpVector3=As.BuildArray(3,j.Zero);class A0{constructor(e,i,s){this.center=j.Zero(),this.centerWorld=j.Zero(),this.minimum=j.Zero(),this.maximum=j.Zero(),this.reConstruct(e,i,s)}reConstruct(e,i,s){this.minimum.copyFrom(e),this.maximum.copyFrom(i);const n=j.Distance(e,i);i.addToRef(e,this.center).scaleInPlace(.5),this.radius=n*.5,this._update(s||fe.IdentityReadOnly)}scale(e){const i=this.radius*e,s=A0._TmpVector3,n=s[0].setAll(i),a=this.center.subtractToRef(n,s[1]),p=this.center.addToRef(n,s[2]);return this.reConstruct(a,p,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{j.TransformCoordinatesToRef(this.center,e,this.centerWorld);const i=A0._TmpVector3[0];j.TransformNormalFromFloatsToRef(1,1,1,e,i),this.radiusWorld=Math.max(Math.abs(i.x),Math.abs(i.y),Math.abs(i.z))*this.radius}}isInFrustum(e){const i=this.centerWorld,s=this.radiusWorld;for(let n=0;n<6;n++)if(e[n].dotCoordinate(i)<=-s)return!1;return!0}isCenterInFrustum(e){const i=this.centerWorld;for(let s=0;s<6;s++)if(e[s].dotCoordinate(i)<0)return!1;return!0}intersectsPoint(e){const i=j.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<i)}static Intersects(e,i){const s=j.DistanceSquared(e.centerWorld,i.centerWorld),n=e.radiusWorld+i.radiusWorld;return!(n*n<s)}static CreateFromCenterAndRadius(e,i,s){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,i),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);const n=new A0(this._TmpVector3[0],this._TmpVector3[2]);return s?n._worldMatrix=s:n._worldMatrix=fe.Identity(),n}}A0._TmpVector3=As.BuildArray(3,j.Zero);const l_={min:0,max:0},c_={min:0,max:0},WE=(l,e,i)=>{const s=j.Dot(e.centerWorld,l),n=Math.abs(j.Dot(e.directions[0],l))*e.extendSize.x,a=Math.abs(j.Dot(e.directions[1],l))*e.extendSize.y,p=Math.abs(j.Dot(e.directions[2],l))*e.extendSize.z,_=n+a+p;i.min=s-_,i.max=s+_},Wn=(l,e,i)=>(WE(l,e,l_),WE(l,i,c_),!(l_.min>c_.max||c_.min>l_.max));class la{constructor(e,i,s){this._isLocked=!1,this.boundingBox=new E0(e,i,s),this.boundingSphere=new A0(e,i,s)}reConstruct(e,i,s){this.boundingBox.reConstruct(e,i,s),this.boundingSphere.reConstruct(e,i,s)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(e,i){const s=la._TmpVector3[0].copyFrom(e).subtractInPlace(i),n=la._TmpVector3[1].copyFrom(e).addInPlace(i);return this.boundingBox.reConstruct(s,n,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(s,n,this.boundingBox.getWorldMatrix()),this}encapsulate(e){const i=j.Minimize(this.minimum,e),s=j.Maximize(this.maximum,e);return this.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){const i=ge.Matrix[0];this.boundingBox.getWorldMatrix().invertToRef(i);const s=ge.Vector3[0];return j.TransformCoordinatesToRef(e.boundingBox.minimumWorld,i,s),this.encapsulate(s),j.TransformCoordinatesToRef(e.boundingBox.maximumWorld,i,s),this.encapsulate(s),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,i=0){return(i===2||i===3)&&this.boundingSphere.isCenterInFrustum(e)?!0:this.boundingSphere.isInFrustum(e)?i===1||i===3?!0:this.boundingBox.isInFrustum(e):!1}get diagonalLength(){const e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,la._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(e)||!this.boundingBox.intersectsPoint(e))}intersects(e,i){if(!A0.Intersects(this.boundingSphere,e.boundingSphere)||!E0.Intersects(this.boundingBox,e.boundingBox))return!1;if(!i)return!0;const s=this.boundingBox,n=e.boundingBox;return!(!Wn(s.directions[0],s,n)||!Wn(s.directions[1],s,n)||!Wn(s.directions[2],s,n)||!Wn(n.directions[0],s,n)||!Wn(n.directions[1],s,n)||!Wn(n.directions[2],s,n)||!Wn(j.Cross(s.directions[0],n.directions[0]),s,n)||!Wn(j.Cross(s.directions[0],n.directions[1]),s,n)||!Wn(j.Cross(s.directions[0],n.directions[2]),s,n)||!Wn(j.Cross(s.directions[1],n.directions[0]),s,n)||!Wn(j.Cross(s.directions[1],n.directions[1]),s,n)||!Wn(j.Cross(s.directions[1],n.directions[2]),s,n)||!Wn(j.Cross(s.directions[2],n.directions[0]),s,n)||!Wn(j.Cross(s.directions[2],n.directions[1]),s,n)||!Wn(j.Cross(s.directions[2],n.directions[2]),s,n))}}la._TmpVector3=As.BuildArray(2,j.Zero);class P2{static extractMinAndMaxIndexed(e,i,s,n,a,p){for(let _=s;_<s+n;_++){const g=i[_]*3,y=e[g],b=e[g+1],v=e[g+2];a.minimizeInPlaceFromFloats(y,b,v),p.maximizeInPlaceFromFloats(y,b,v)}}static extractMinAndMax(e,i,s,n,a,p){for(let _=i,g=i*n;_<i+s;_++,g+=n){const y=e[g],b=e[g+1],v=e[g+2];a.minimizeInPlaceFromFloats(y,b,v),p.maximizeInPlaceFromFloats(y,b,v)}}}J([bx.filter((...[l,e])=>!Array.isArray(l)&&!Array.isArray(e))],P2,"extractMinAndMaxIndexed",null),J([bx.filter((...[l])=>!Array.isArray(l))],P2,"extractMinAndMax",null);function q9(l,e,i,s,n=null){const a=new j(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),p=new j(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return P2.extractMinAndMaxIndexed(l,e,i,s,a,p),n&&(a.x-=a.x*n.x+n.y,a.y-=a.y*n.x+n.y,a.z-=a.z*n.x+n.y,p.x+=p.x*n.x+n.y,p.y+=p.y*n.x+n.y,p.z+=p.z*n.x+n.y),{minimum:a,maximum:p}}function zE(l,e,i,s=null,n){const a=new j(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),p=new j(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return n||(n=3),P2.extractMinAndMax(l,e,i,n,a,p),s&&(a.x-=a.x*s.x+s.y,a.y-=a.y*s.x+s.y,a.z-=a.z*s.x+s.y,p.x+=p.x*s.x+s.y,p.y+=p.y*s.x+s.y,p.z+=p.z*s.x+s.y),{minimum:a,maximum:p}}class Sn{get materialDefines(){var e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:(e=this._getDrawWrapper())===null||e===void 0?void 0:e.defines}set materialDefines(e){var i;const s=(i=this._mainDrawWrapperOverride)!==null&&i!==void 0?i:this._getDrawWrapper(void 0,!0);s.defines=e}_getDrawWrapper(e,i=!1){e=e??this._engine.currentRenderPassId;let s=this._drawWrappers[e];return!s&&i&&(this._drawWrappers[e]=s=new ul(this._mesh.getScene().getEngine())),s}_removeDrawWrapper(e,i=!0){var s;i&&((s=this._drawWrappers[e])===null||s===void 0||s.dispose()),this._drawWrappers[e]=void 0}get effect(){var e,i;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:(i=(e=this._getDrawWrapper())===null||e===void 0?void 0:e.effect)!==null&&i!==void 0?i:null}get _drawWrapper(){var e;return(e=this._mainDrawWrapperOverride)!==null&&e!==void 0?e:this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,i=null,s,n=!0){const a=this._drawWrapper;a.setEffect(e,i,n),s!==void 0&&(a.materialContext=s),e||(a.defines=null,a.materialContext=void 0)}resetDrawCache(e){if(this._drawWrappers)if(e!==void 0){this._removeDrawWrapper(e);return}else for(const i of this._drawWrappers)i?.dispose();this._drawWrappers=[]}static AddToMesh(e,i,s,n,a,p,_,g=!0){return new Sn(e,i,s,n,a,p,_,g)}constructor(e,i,s,n,a,p,_,g=!0,y=!0){this.materialIndex=e,this.verticesStart=i,this.verticesCount=s,this.indexStart=n,this.indexCount=a,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=p,this._renderingMesh=_||p,y&&p.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=p.subMeshes.length-1,g&&(this.refreshBoundingInfo(),p.computeWorldMatrix(!0))}get IsGlobal(){return this.verticesStart===0&&this.verticesCount===this._mesh.getTotalVertices()&&this.indexStart===0&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){const e=this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null;return e||this._renderingMesh}getMaterial(e=!0){var i;const s=(i=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId))!==null&&i!==void 0?i:this._renderingMesh.material;if(s){if(this._isMultiMaterial(s)){const n=s.getSubMaterial(this.materialIndex);return this._currentMaterial!==n&&(this._currentMaterial=n,this.resetDrawCache()),n}}else return e?this._mesh.getScene().defaultMaterial:null;return s}_isMultiMaterial(e){return e.getSubMaterial!==void 0}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(te.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;const i=this._renderingMesh.getIndices();let s;if(this.indexStart===0&&this.indexCount===i.length){const n=this._renderingMesh.getBoundingInfo();s={minimum:n.minimum.clone(),maximum:n.maximum.clone()}}else s=q9(e,i,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(s.minimum,s.maximum):this._boundingInfo=new la(s.minimum,s.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let i=this.getBoundingInfo();return i||(this.refreshBoundingInfo(),i=this.getBoundingInfo()),i&&i.update(e),this}isInFrustum(e){const i=this.getBoundingInfo();return i?i.isInFrustum(e,this._mesh.cullingStrategy):!1}isCompletelyInFrustum(e){const i=this.getBoundingInfo();return i?i.isCompletelyInFrustum(e):!1}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,i){if(!this._linesIndexBuffer){const s=[];for(let n=this.indexStart;n<this.indexStart+this.indexCount;n+=3)s.push(e[n],e[n+1],e[n+1],e[n+2],e[n+2],e[n]);this._linesIndexBuffer=i.createIndexBuffer(s),this._linesIndexCount=s.length}return this._linesIndexBuffer}canIntersects(e){const i=this.getBoundingInfo();return i?e.intersectsBox(i.boundingBox):!1}intersects(e,i,s,n,a){const p=this.getMaterial();if(!p)return null;let _=3,g=!1;switch(p.fillMode){case 3:case 5:case 6:case 8:return null;case 7:_=1,g=!0;break;default:break}return p.fillMode===4?s.length?this._intersectLines(e,i,s,this._mesh.intersectionThreshold,n):this._intersectUnIndexedLines(e,i,s,this._mesh.intersectionThreshold,n):!s.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,i,s,n,a):this._intersectTriangles(e,i,s,_,g,n,a)}_intersectLines(e,i,s,n,a){let p=null;for(let _=this.indexStart;_<this.indexStart+this.indexCount;_+=2){const g=i[s[_]],y=i[s[_+1]],b=e.intersectionSegment(g,y,n);if(!(b<0)&&(a||!p||b<p.distance)&&(p=new o_(null,null,b),p.faceId=_/2,a))break}return p}_intersectUnIndexedLines(e,i,s,n,a){let p=null;for(let _=this.verticesStart;_<this.verticesStart+this.verticesCount;_+=2){const g=i[_],y=i[_+1],b=e.intersectionSegment(g,y,n);if(!(b<0)&&(a||!p||b<p.distance)&&(p=new o_(null,null,b),p.faceId=_/2,a))break}return p}_intersectTriangles(e,i,s,n,a,p,_){let g=null,y=-1;for(let b=this.indexStart;b<this.indexStart+this.indexCount-(3-n);b+=n){y++;const v=s[b],S=s[b+1],M=s[b+2];if(a&&M===4294967295){b+=2;continue}const F=i[v],L=i[S],N=i[M];if(!F||!L||!N||_&&!_(F,L,N,e,v,S,M))continue;const k=e.intersectsTriangle(F,L,N);if(k){if(k.distance<0)continue;if((p||!g||k.distance<g.distance)&&(g=k,g.faceId=y,p))break}}return g}_intersectUnIndexedTriangles(e,i,s,n,a){let p=null;for(let _=this.verticesStart;_<this.verticesStart+this.verticesCount;_+=3){const g=i[_],y=i[_+1],b=i[_+2];if(a&&!a(g,y,b,e,-1,-1,-1))continue;const v=e.intersectsTriangle(g,y,b);if(v){if(v.distance<0)continue;if((n||!p||v.distance<p.distance)&&(p=v,p.faceId=_/3,n))break}}return p}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(e,i){const s=new Sn(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,i,!1);if(!this.IsGlobal){const n=this.getBoundingInfo();if(!n)return s;s._boundingInfo=new la(n.minimum,n.maximum)}return s}dispose(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);const e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1),this.resetDrawCache()}getClassName(){return"SubMesh"}static CreateFromIndices(e,i,s,n,a,p=!0){let _=Number.MAX_VALUE,g=-Number.MAX_VALUE;const b=(a||n).getIndices();for(let v=i;v<i+s;v++){const S=b[v];S<_&&(_=S),S>g&&(g=S)}return new Sn(e,_,g-_+1,i,s,n,a,p)}}function O2(l){l.indexOf("vClipPlane")===-1&&l.push("vClipPlane"),l.indexOf("vClipPlane2")===-1&&l.push("vClipPlane2"),l.indexOf("vClipPlane3")===-1&&l.push("vClipPlane3"),l.indexOf("vClipPlane4")===-1&&l.push("vClipPlane4"),l.indexOf("vClipPlane5")===-1&&l.push("vClipPlane5"),l.indexOf("vClipPlane6")===-1&&l.push("vClipPlane6")}function Z9(l,e,i){var s,n,a,p,_,g;const y=!!((s=l.clipPlane)!==null&&s!==void 0?s:e.clipPlane),b=!!((n=l.clipPlane2)!==null&&n!==void 0?n:e.clipPlane2),v=!!((a=l.clipPlane3)!==null&&a!==void 0?a:e.clipPlane3),S=!!((p=l.clipPlane4)!==null&&p!==void 0?p:e.clipPlane4),M=!!((_=l.clipPlane5)!==null&&_!==void 0?_:e.clipPlane5),F=!!((g=l.clipPlane6)!==null&&g!==void 0?g:e.clipPlane6);y&&i.push("#define CLIPPLANE"),b&&i.push("#define CLIPPLANE2"),v&&i.push("#define CLIPPLANE3"),S&&i.push("#define CLIPPLANE4"),M&&i.push("#define CLIPPLANE5"),F&&i.push("#define CLIPPLANE6")}function Q9(l,e,i){var s,n,a,p,_,g;let y=!1;const b=!!((s=l.clipPlane)!==null&&s!==void 0?s:e.clipPlane),v=!!((n=l.clipPlane2)!==null&&n!==void 0?n:e.clipPlane2),S=!!((a=l.clipPlane3)!==null&&a!==void 0?a:e.clipPlane3),M=!!((p=l.clipPlane4)!==null&&p!==void 0?p:e.clipPlane4),F=!!((_=l.clipPlane5)!==null&&_!==void 0?_:e.clipPlane5),L=!!((g=l.clipPlane6)!==null&&g!==void 0?g:e.clipPlane6);return i.CLIPPLANE!==b&&(i.CLIPPLANE=b,y=!0),i.CLIPPLANE2!==v&&(i.CLIPPLANE2=v,y=!0),i.CLIPPLANE3!==S&&(i.CLIPPLANE3=S,y=!0),i.CLIPPLANE4!==M&&(i.CLIPPLANE4=M,y=!0),i.CLIPPLANE5!==F&&(i.CLIPPLANE5=F,y=!0),i.CLIPPLANE6!==L&&(i.CLIPPLANE6=L,y=!0),y}function w2(l,e,i){var s,n,a,p,_,g;let y=(s=e.clipPlane)!==null&&s!==void 0?s:i.clipPlane;Cc(l,"vClipPlane",y),y=(n=e.clipPlane2)!==null&&n!==void 0?n:i.clipPlane2,Cc(l,"vClipPlane2",y),y=(a=e.clipPlane3)!==null&&a!==void 0?a:i.clipPlane3,Cc(l,"vClipPlane3",y),y=(p=e.clipPlane4)!==null&&p!==void 0?p:i.clipPlane4,Cc(l,"vClipPlane4",y),y=(_=e.clipPlane5)!==null&&_!==void 0?_:i.clipPlane5,Cc(l,"vClipPlane5",y),y=(g=e.clipPlane6)!==null&&g!==void 0?g:i.clipPlane6,Cc(l,"vClipPlane6",y)}function Cc(l,e,i){i&&l.setFloat4(e,i.normal.x,i.normal.y,i.normal.z,i.d)}class nt{static BindSceneUniformBuffer(e,i){i.bindToEffect(e,"Scene")}static PrepareDefinesForMergedUV(e,i,s){i._needUVs=!0,i[s]=!0,e.optimizeUVAllocation&&e.getTextureMatrix().isIdentityAs3x2()?(i[s+"DIRECTUV"]=e.coordinatesIndex+1,i["MAINUV"+(e.coordinatesIndex+1)]=!0):i[s+"DIRECTUV"]=0}static BindTextureMatrix(e,i,s){const n=e.getTextureMatrix();i.updateMatrix(s+"Matrix",n)}static GetFogState(e,i){return i.fogEnabled&&e.applyFog&&i.fogMode!==Nt.FOGMODE_NONE}static PrepareDefinesForMisc(e,i,s,n,a,p,_){_._areMiscDirty&&(_.LOGARITHMICDEPTH=s,_.POINTSIZE=n,_.FOG=a&&this.GetFogState(e,i),_.NONUNIFORMSCALING=e.nonUniformScaling,_.ALPHATEST=p)}static PrepareDefinesForCamera(e,i){let s=!1;if(e.activeCamera){const n=i.CAMERA_ORTHOGRAPHIC?1:0,a=i.CAMERA_PERSPECTIVE?1:0,p=e.activeCamera.mode===wt.ORTHOGRAPHIC_CAMERA?1:0,_=e.activeCamera.mode===wt.PERSPECTIVE_CAMERA?1:0;(n^p||a^_)&&(i.CAMERA_ORTHOGRAPHIC=p===1,i.CAMERA_PERSPECTIVE=_===1,s=!0)}return s}static PrepareDefinesForFrameBoundValues(e,i,s,n,a,p=null,_=!1){let g=nt.PrepareDefinesForCamera(e,n);p!==!1&&(g=Q9(s,e,n)),n.DEPTHPREPASS!==!i.getColorWrite()&&(n.DEPTHPREPASS=!n.DEPTHPREPASS,g=!0),n.INSTANCES!==a&&(n.INSTANCES=a,g=!0),n.THIN_INSTANCES!==_&&(n.THIN_INSTANCES=_,g=!0),g&&n.markAsUnprocessed()}static PrepareDefinesForBones(e,i){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){i.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;const s=i.BONETEXTURE!==void 0;if(e.skeleton.isUsingTextureForMatrices&&s)i.BONETEXTURE=!0;else{i.BonesPerMesh=e.skeleton.bones.length+1,i.BONETEXTURE=s?!1:void 0;const n=e.getScene().prePassRenderer;if(n&&n.enabled){const a=n.excludedSkinnedMesh.indexOf(e)===-1;i.BONES_VELOCITY_ENABLED=a}}}else i.NUM_BONE_INFLUENCERS=0,i.BonesPerMesh=0,i.BONETEXTURE!==void 0&&(i.BONETEXTURE=!1)}static PrepareDefinesForMorphTargets(e,i){const s=e.morphTargetManager;s?(i.MORPHTARGETS_UV=s.supportsUVs&&i.UV1,i.MORPHTARGETS_TANGENT=s.supportsTangents&&i.TANGENT,i.MORPHTARGETS_NORMAL=s.supportsNormals&&i.NORMAL,i.MORPHTARGETS=s.numInfluencers>0,i.NUM_MORPH_INFLUENCERS=s.numInfluencers,i.MORPHTARGETS_TEXTURE=s.isUsingTextureForTargets):(i.MORPHTARGETS_UV=!1,i.MORPHTARGETS_TANGENT=!1,i.MORPHTARGETS_NORMAL=!1,i.MORPHTARGETS=!1,i.NUM_MORPH_INFLUENCERS=0)}static PrepareDefinesForBakedVertexAnimation(e,i){const s=e.bakedVertexAnimationManager;i.BAKED_VERTEX_ANIMATION_TEXTURE=!!(s&&s.isEnabled)}static PrepareDefinesForAttributes(e,i,s,n,a=!1,p=!0,_=!0){if(!i._areAttributesDirty&&i._needNormals===i._normals&&i._needUVs===i._uvs)return!1;i._normals=i._needNormals,i._uvs=i._needUVs,i.NORMAL=i._needNormals&&e.isVerticesDataPresent(te.NormalKind),i._needNormals&&e.isVerticesDataPresent(te.TangentKind)&&(i.TANGENT=!0);for(let g=1;g<=6;++g)i["UV"+g]=i._needUVs?e.isVerticesDataPresent(`uv${g===1?"":g}`):!1;if(s){const g=e.useVertexColors&&e.isVerticesDataPresent(te.ColorKind);i.VERTEXCOLOR=g,i.VERTEXALPHA=e.hasVertexAlpha&&g&&p}return e.isVerticesDataPresent(te.ColorInstanceKind)&&(e.hasInstances||e.hasThinInstances)&&(i.INSTANCESCOLOR=!0),n&&this.PrepareDefinesForBones(e,i),a&&this.PrepareDefinesForMorphTargets(e,i),_&&this.PrepareDefinesForBakedVertexAnimation(e,i),!0}static PrepareDefinesForMultiview(e,i){if(e.activeCamera){const s=i.MULTIVIEW;i.MULTIVIEW=e.activeCamera.outputRenderTarget!==null&&e.activeCamera.outputRenderTarget.getViewCount()>1,i.MULTIVIEW!=s&&i.markAsUnprocessed()}}static PrepareDefinesForOIT(e,i,s){const n=i.ORDER_INDEPENDENT_TRANSPARENCY,a=i.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;i.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&s,i.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,(n!==i.ORDER_INDEPENDENT_TRANSPARENCY||a!==i.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&i.markAsUnprocessed()}static PrepareDefinesForPrePass(e,i,s){const n=i.PREPASS;if(!i._arePrePassDirty)return;const a=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&s){i.PREPASS=!0,i.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount;for(let p=0;p<a.length;p++){const _=e.prePassRenderer.getIndex(a[p].type);_!==-1?(i[a[p].define]=!0,i[a[p].index]=_):i[a[p].define]=!1}}else{i.PREPASS=!1;for(let p=0;p<a.length;p++)i[a[p].define]=!1}i.PREPASS!=n&&(i.markAsUnprocessed(),i.markAsImageProcessingDirty())}static PrepareDefinesForLight(e,i,s,n,a,p,_){var g;switch(_.needNormals=!0,a["LIGHT"+n]===void 0&&(_.needRebuild=!0),a["LIGHT"+n]=!0,a["SPOTLIGHT"+n]=!1,a["HEMILIGHT"+n]=!1,a["POINTLIGHT"+n]=!1,a["DIRLIGHT"+n]=!1,s.prepareLightSpecificDefines(a,n),a["LIGHT_FALLOFF_PHYSICAL"+n]=!1,a["LIGHT_FALLOFF_GLTF"+n]=!1,a["LIGHT_FALLOFF_STANDARD"+n]=!1,s.falloffType){case Ji.FALLOFF_GLTF:a["LIGHT_FALLOFF_GLTF"+n]=!0;break;case Ji.FALLOFF_PHYSICAL:a["LIGHT_FALLOFF_PHYSICAL"+n]=!0;break;case Ji.FALLOFF_STANDARD:a["LIGHT_FALLOFF_STANDARD"+n]=!0;break}if(p&&!s.specular.equalsFloats(0,0,0)&&(_.specularEnabled=!0),a["SHADOW"+n]=!1,a["SHADOWCSM"+n]=!1,a["SHADOWCSMDEBUG"+n]=!1,a["SHADOWCSMNUM_CASCADES"+n]=!1,a["SHADOWCSMUSESHADOWMAXZ"+n]=!1,a["SHADOWCSMNOBLEND"+n]=!1,a["SHADOWCSM_RIGHTHANDED"+n]=!1,a["SHADOWPCF"+n]=!1,a["SHADOWPCSS"+n]=!1,a["SHADOWPOISSON"+n]=!1,a["SHADOWESM"+n]=!1,a["SHADOWCLOSEESM"+n]=!1,a["SHADOWCUBE"+n]=!1,a["SHADOWLOWQUALITY"+n]=!1,a["SHADOWMEDIUMQUALITY"+n]=!1,i&&i.receiveShadows&&e.shadowsEnabled&&s.shadowEnabled){const y=(g=s.getShadowGenerator(e.activeCamera))!==null&&g!==void 0?g:s.getShadowGenerator();if(y){const b=y.getShadowMap();b&&b.renderList&&b.renderList.length>0&&(_.shadowEnabled=!0,y.prepareDefines(a,n))}}s.lightmapMode!=Ji.LIGHTMAP_DEFAULT?(_.lightmapMode=!0,a["LIGHTMAPEXCLUDED"+n]=!0,a["LIGHTMAPNOSPECULAR"+n]=s.lightmapMode==Ji.LIGHTMAP_SHADOWSONLY):(a["LIGHTMAPEXCLUDED"+n]=!1,a["LIGHTMAPNOSPECULAR"+n]=!1)}static PrepareDefinesForLights(e,i,s,n,a=4,p=!1){if(!s._areLightsDirty)return s._needNormals;let _=0;const g={needNormals:s._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(e.lightsEnabled&&!p){for(const b of i.lightSources)if(this.PrepareDefinesForLight(e,i,b,_,s,n,g),_++,_===a)break}s.SPECULARTERM=g.specularEnabled,s.SHADOWS=g.shadowEnabled;for(let b=_;b<a;b++)s["LIGHT"+b]!==void 0&&(s["LIGHT"+b]=!1,s["HEMILIGHT"+b]=!1,s["POINTLIGHT"+b]=!1,s["DIRLIGHT"+b]=!1,s["SPOTLIGHT"+b]=!1,s["SHADOW"+b]=!1,s["SHADOWCSM"+b]=!1,s["SHADOWCSMDEBUG"+b]=!1,s["SHADOWCSMNUM_CASCADES"+b]=!1,s["SHADOWCSMUSESHADOWMAXZ"+b]=!1,s["SHADOWCSMNOBLEND"+b]=!1,s["SHADOWCSM_RIGHTHANDED"+b]=!1,s["SHADOWPCF"+b]=!1,s["SHADOWPCSS"+b]=!1,s["SHADOWPOISSON"+b]=!1,s["SHADOWESM"+b]=!1,s["SHADOWCLOSEESM"+b]=!1,s["SHADOWCUBE"+b]=!1,s["SHADOWLOWQUALITY"+b]=!1,s["SHADOWMEDIUMQUALITY"+b]=!1);const y=e.getEngine().getCaps();return s.SHADOWFLOAT===void 0&&(g.needRebuild=!0),s.SHADOWFLOAT=g.shadowEnabled&&(y.textureFloatRender&&y.textureFloatLinearFiltering||y.textureHalfFloatRender&&y.textureHalfFloatLinearFiltering),s.LIGHTMAPEXCLUDED=g.lightmapMode,g.needRebuild&&s.rebuild(),g.needNormals}static PrepareUniformsAndSamplersForLight(e,i,s,n,a=null,p=!1){a&&a.push("Light"+e),!p&&(i.push("vLightData"+e,"vLightDiffuse"+e,"vLightSpecular"+e,"vLightDirection"+e,"vLightFalloff"+e,"vLightGround"+e,"lightMatrix"+e,"shadowsInfo"+e,"depthValues"+e),s.push("shadowSampler"+e),s.push("depthSampler"+e),i.push("viewFrustumZ"+e,"cascadeBlendFactor"+e,"lightSizeUVCorrection"+e,"depthCorrection"+e,"penumbraDarkness"+e,"frustumLengths"+e),n&&(s.push("projectionLightSampler"+e),i.push("textureProjectionMatrix"+e)))}static PrepareUniformsAndSamplersList(e,i,s,n=4){let a,p=null;if(e.uniformsNames){const _=e;a=_.uniformsNames,p=_.uniformBuffersNames,i=_.samplers,s=_.defines,n=_.maxSimultaneousLights||0}else a=e,i||(i=[]);for(let _=0;_<n&&s["LIGHT"+_];_++)this.PrepareUniformsAndSamplersForLight(_,a,i,s["PROJECTEDLIGHTTEXTURE"+_],p);s.NUM_MORPH_INFLUENCERS&&a.push("morphTargetInfluences"),s.BAKED_VERTEX_ANIMATION_TEXTURE&&(a.push("bakedVertexAnimationSettings"),a.push("bakedVertexAnimationTextureSizeInverted"),a.push("bakedVertexAnimationTime"),i.push("bakedVertexAnimationTexture"))}static HandleFallbacksForShadows(e,i,s=4,n=0){let a=0;for(let p=0;p<s&&e["LIGHT"+p];p++)p>0&&(a=n+p,i.addFallback(a,"LIGHT"+p)),e.SHADOWS||(e["SHADOW"+p]&&i.addFallback(n,"SHADOW"+p),e["SHADOWPCF"+p]&&i.addFallback(n,"SHADOWPCF"+p),e["SHADOWPCSS"+p]&&i.addFallback(n,"SHADOWPCSS"+p),e["SHADOWPOISSON"+p]&&i.addFallback(n,"SHADOWPOISSON"+p),e["SHADOWESM"+p]&&i.addFallback(n,"SHADOWESM"+p),e["SHADOWCLOSEESM"+p]&&i.addFallback(n,"SHADOWCLOSEESM"+p));return a++}static PrepareAttributesForMorphTargetsInfluencers(e,i,s){this._TmpMorphInfluencers.NUM_MORPH_INFLUENCERS=s,this.PrepareAttributesForMorphTargets(e,i,this._TmpMorphInfluencers)}static PrepareAttributesForMorphTargets(e,i,s){const n=s.NUM_MORPH_INFLUENCERS;if(n>0&&Zt.LastCreatedEngine){const a=Zt.LastCreatedEngine.getCaps().maxVertexAttribs,p=i.morphTargetManager;if(p?.isUsingTextureForTargets)return;const _=p&&p.supportsNormals&&s.NORMAL,g=p&&p.supportsTangents&&s.TANGENT,y=p&&p.supportsUVs&&s.UV1;for(let b=0;b<n;b++)e.push(te.PositionKind+b),_&&e.push(te.NormalKind+b),g&&e.push(te.TangentKind+b),y&&e.push(te.UVKind+"_"+b),e.length>a&&Ie.Error("Cannot add more vertex attributes for mesh "+i.name)}}static PrepareAttributesForBakedVertexAnimation(e,i,s){s.BAKED_VERTEX_ANIMATION_TEXTURE&&s.INSTANCES&&e.push("bakedVertexAnimationSettingsInstanced")}static PrepareAttributesForBones(e,i,s,n){s.NUM_BONE_INFLUENCERS>0&&(n.addCPUSkinningFallback(0,i),e.push(te.MatricesIndicesKind),e.push(te.MatricesWeightsKind),s.NUM_BONE_INFLUENCERS>4&&(e.push(te.MatricesIndicesExtraKind),e.push(te.MatricesWeightsExtraKind)))}static PrepareAttributesForInstances(e,i){(i.INSTANCES||i.THIN_INSTANCES)&&this.PushAttributesForInstances(e,!!i.PREPASS_VELOCITY),i.INSTANCESCOLOR&&e.push(te.ColorInstanceKind)}static PushAttributesForInstances(e,i=!1){e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"),i&&(e.push("previousWorld0"),e.push("previousWorld1"),e.push("previousWorld2"),e.push("previousWorld3"))}static BindLightProperties(e,i,s){e.transferToEffect(i,s+"")}static BindLight(e,i,s,n,a,p=!0){e._bindLight(i,s,n,a,p)}static BindLights(e,i,s,n,a=4){const p=Math.min(i.lightSources.length,a);for(let _=0;_<p;_++){const g=i.lightSources[_];this.BindLight(g,_,e,s,typeof n=="boolean"?n:n.SPECULARTERM,i.receiveShadows)}}static BindFogParameters(e,i,s,n=!1){e.fogEnabled&&i.applyFog&&e.fogMode!==Nt.FOGMODE_NONE&&(s.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),n?(e.fogColor.toLinearSpaceToRef(this._TempFogColor,e.getEngine().useExactSrgbConversions),s.setColor3("vFogColor",this._TempFogColor)):s.setColor3("vFogColor",e.fogColor))}static BindBonesParameters(e,i,s){if(!(!i||!e)&&(e.computeBonesUsingShaders&&i._bonesComputationForcedToCPU&&(e.computeBonesUsingShaders=!1),e.useBones&&e.computeBonesUsingShaders&&e.skeleton)){const n=e.skeleton;if(n.isUsingTextureForMatrices&&i.getUniformIndex("boneTextureWidth")>-1){const a=n.getTransformMatrixTexture(e);i.setTexture("boneSampler",a),i.setFloat("boneTextureWidth",4*(n.bones.length+1))}else{const a=n.getTransformMatrices(e);a&&(i.setMatrices("mBones",a),s&&e.getScene().prePassRenderer&&e.getScene().prePassRenderer.getIndex(2)&&(s.previousBones[e.uniqueId]||(s.previousBones[e.uniqueId]=a.slice()),i.setMatrices("mPreviousBones",s.previousBones[e.uniqueId]),nt._CopyBonesTransformationMatrices(a,s.previousBones[e.uniqueId])))}}}static _CopyBonesTransformationMatrices(e,i){return i.set(e),i}static BindMorphTargetParameters(e,i){const s=e.morphTargetManager;!e||!s||i.setFloatArray("morphTargetInfluences",s.influences)}static BindLogDepth(e,i,s){if(!e||e.LOGARITHMICDEPTH||e.indexOf&&e.indexOf("LOGARITHMICDEPTH")>=0){const n=s.activeCamera;n.mode===wt.ORTHOGRAPHIC_CAMERA&&Ie.Error("Logarithmic depth is not compatible with orthographic cameras!",20),i.setFloat("logarithmicDepthConstant",2/(Math.log(n.maxZ+1)/Math.LN2))}}}nt._TmpMorphInfluencers={NUM_MORPH_INFLUENCERS:0},nt._TempFogColor=qe.Black();class C0{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}get func(){return this._func}set func(e){this._func=e}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef=e}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask=e}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail=e}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail=e}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass=e}get mask(){return this._mask}set mask(e){this._mask=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e}getClassName(){return"MaterialStencilState"}copyTo(e){Kt.Clone(()=>e,this)}serialize(){return Kt.Serialize(this)}parse(e,i,s){Kt.Parse(()=>this,e,i,s)}}J([xe()],C0.prototype,"func",null),J([xe()],C0.prototype,"funcRef",null),J([xe()],C0.prototype,"funcMask",null),J([xe()],C0.prototype,"opStencilFail",null),J([xe()],C0.prototype,"opDepthFail",null),J([xe()],C0.prototype,"opStencilDepthPass",null),J([xe()],C0.prototype,"mask",null),J([xe()],C0.prototype,"enabled",null);var ws;(function(l){l[l.Created=1]="Created",l[l.Disposed=2]="Disposed",l[l.GetDefineNames=4]="GetDefineNames",l[l.PrepareUniformBuffer=8]="PrepareUniformBuffer",l[l.IsReadyForSubMesh=16]="IsReadyForSubMesh",l[l.PrepareDefines=32]="PrepareDefines",l[l.BindForSubMesh=64]="BindForSubMesh",l[l.PrepareEffect=128]="PrepareEffect",l[l.GetAnimatables=256]="GetAnimatables",l[l.GetActiveTextures=512]="GetActiveTextures",l[l.HasTexture=1024]="HasTexture",l[l.FillRenderTargetTextures=2048]="FillRenderTargetTextures",l[l.HasRenderTargetTextures=4096]="HasRenderTargetTextures",l[l.HardBindForSubMesh=8192]="HardBindForSubMesh"})(ws||(ws={}));class Be{get canRenderToMRT(){return!1}set alpha(e){if(this._alpha===e)return;const i=this._alpha;this._alpha=e,(i===1||e===1)&&this.markAsDirty(Be.MiscDirtyFlag)}get alpha(){return this._alpha}set backFaceCulling(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(Be.TextureDirtyFlag))}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(Be.TextureDirtyFlag))}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty())}atomicMaterialsUpdate(e){this.blockDirtyMechanism=!0;try{e(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new Re),this._onBindObservable}set onBind(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)}get onUnBindObservable(){return this._onUnBindObservable||(this._onUnBindObservable=new Re),this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new Re),this._onEffectCreatedObservable}set alphaMode(e){this._alphaMode!==e&&(this._alphaMode=e,this.markAsDirty(Be.TextureDirtyFlag))}get alphaMode(){return this._alphaMode}set needDepthPrePass(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return!1}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(Be.MiscDirtyFlag))}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case Be.WireFrameFillMode:case Be.LineListDrawMode:case Be.LineLoopDrawMode:case Be.LineStripDrawMode:return!0}return this._scene.forceWireframe}set wireframe(e){this.fillMode=e?Be.WireFrameFillMode:Be.TriangleFillMode}get pointsCloud(){switch(this._fillMode){case Be.PointFillMode:case Be.PointListDrawMode:return!0}return this._scene.forcePointsCloud}set pointsCloud(e){this.fillMode=e?Be.PointFillMode:Be.TriangleFillMode}get fillMode(){return this._fillMode}set fillMode(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(Be.MiscDirtyFlag))}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(e){this._drawWrapper=e}constructor(e,i,s){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new Re,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new C0,this._useUBO=!1,this._fillMode=Be.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=e;const n=i||Zt.LastCreatedScene;!n||(this._scene=n,this._dirtyCallbacks={},this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||Le.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new ul(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._scene.useRightHandedSystem?this.sideOrientation=Be.ClockWiseSideOrientation:this.sideOrientation=Be.CounterClockWiseSideOrientation,this._uniformBuffer=new At(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,s||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),Be.OnEventObservable.notifyObservers(this,ws.Created))}toString(e){return"Name: "+this.name}getClassName(){return"Material"}get _isMaterial(){return!0}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(e,i){return!0}isReadyForSubMesh(e,i,s){const n=i.materialDefines;return n?(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=n,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh):!1}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._forceAlphaTest=e===Be.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())}get _disableAlphaBlending(){return this._transparencyMode===Be.MATERIAL_OPAQUE||this._transparencyMode===Be.MATERIAL_ALPHATEST}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1}needAlphaBlendingForMesh(e){return e.visibility<1?!0:this._disableAlphaBlending?!1:e.hasVertexAlpha||this.needAlphaBlending()}needAlphaTesting(){return!!this._forceAlphaTest}_shouldTurnAlphaTestOn(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(e=!1){const i=this.getScene().meshes;for(const s of i)if(!!s.subMeshes)for(const n of s.subMeshes)n.getMaterial()===this&&(!n.effect||(n.effect._wasPreviouslyReady=!1,n.effect._wasPreviouslyUsingInstances=null,n.effect._forceRebindOnNextCall=e));e&&this.markAsDirty(Be.AllDirtyFlag)}_preBind(e,i=null){const s=this._scene.getEngine(),a=(i??this.sideOrientation)===Be.ClockWiseSideOrientation;return s.enableEffect(e||this._getDrawWrapper()),s.setState(this.backFaceCulling,this.zOffset,!1,a,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),a}bind(e,i){}buildUniformLayout(){const e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(ws.PrepareUniformBuffer,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0}bindForSubMesh(e,i,s){const n=s.effect;!n||(this._eventInfo.subMesh=s,this._callbackPluginEventBindForSubMesh(this._eventInfo),n._forceRebindOnNextCall=!1)}bindOnlyWorldMatrix(e){}bindView(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())}bindViewProjection(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))}bindEyePosition(e,i){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,i)}_afterBind(e,i=null){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&i&&(this._needToBindSceneUbo=!1,nt.BindSceneUniformBuffer(i,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),e?this._scene._cachedVisibility=e.visibility:this._scene._cachedVisibility=1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){const s=this._scene.getEngine();this._cachedDepthWriteState=s.getDepthWrite(),s.setDepthWrite(!1)}if(this.disableColorWrite){const s=this._scene.getEngine();this._cachedColorWriteState=s.getColorWrite(),s.setColorWrite(!1)}if(this.depthFunction!==0){const s=this._scene.getEngine();this._cachedDepthFunctionState=s.getDepthFunction()||0,s.setDepthFunction(this.depthFunction)}}unbind(){this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),this.depthFunction!==0&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(ws.GetAnimatables,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(ws.GetActiveTextures,this._eventInfo),this._eventInfo.activeTextures}hasTexture(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(ws.HasTexture,this._eventInfo),this._eventInfo.hasTexture}clone(e){return null}getBindedMeshes(){if(this.meshMap){const e=new Array;for(const i in this.meshMap){const s=this.meshMap[i];s&&e.push(s)}return e}else return this._scene.meshes.filter(i=>i.material===this)}forceCompilation(e,i,s,n){const a={clipPlane:!1,useInstances:!1,...s},p=this.getScene(),_=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;const g=()=>{if(!this._scene||!this._scene.getEngine())return;const y=p.clipPlane;if(a.clipPlane&&(p.clipPlane=new aa(0,0,0,1)),this._storeEffectOnSubMeshes){let b=!0,v=null;if(e.subMeshes){const S=new Sn(0,0,0,0,0,e,void 0,!1,!1);S.materialDefines&&(S.materialDefines._renderId=-1),this.isReadyForSubMesh(e,S,a.useInstances)||(S.effect&&S.effect.getCompilationError()&&S.effect.allFallbacksProcessed()?v=S.effect.getCompilationError():(b=!1,setTimeout(g,16)))}b&&(this.allowShaderHotSwapping=_,v&&n&&n(v),i&&i(this))}else this.isReady()?(this.allowShaderHotSwapping=_,i&&i(this)):setTimeout(g,16);a.clipPlane&&(p.clipPlane=y)};g()}forceCompilationAsync(e,i){return new Promise((s,n)=>{this.forceCompilation(e,()=>{s()},i,a=>{n(a)})})}markAsDirty(e){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(Be._DirtyCallbackArray.length=0,e&Be.TextureDirtyFlag&&Be._DirtyCallbackArray.push(Be._TextureDirtyCallBack),e&Be.LightDirtyFlag&&Be._DirtyCallbackArray.push(Be._LightsDirtyCallBack),e&Be.FresnelDirtyFlag&&Be._DirtyCallbackArray.push(Be._FresnelDirtyCallBack),e&Be.AttributesDirtyFlag&&Be._DirtyCallbackArray.push(Be._AttributeDirtyCallBack),e&Be.MiscDirtyFlag&&Be._DirtyCallbackArray.push(Be._MiscDirtyCallBack),e&Be.PrePassDirtyFlag&&Be._DirtyCallbackArray.push(Be._PrePassDirtyCallBack),Be._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(Be._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}resetDrawCache(){const e=this.getScene().meshes;for(const i of e)if(!!i.subMeshes)for(const s of i.subMeshes)s.getMaterial()===this&&s.resetDrawCache()}_markAllSubMeshesAsDirty(e){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const i=this.getScene().meshes;for(const s of i)if(!!s.subMeshes){for(const n of s.subMeshes)if(n.getMaterial(!1)===this)for(const a of n._drawWrappers)!a||!a.defines||!a.defines.markAllAsDirty||this._materialContext===a.materialContext&&e(a.defines)}}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(Be._AllDirtyCallBack)}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(Be._ImageProcessingDirtyCallBack)}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(Be._TextureDirtyCallBack)}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(Be._FresnelDirtyCallBack)}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(Be._FresnelAndMiscDirtyCallBack)}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(Be._LightsDirtyCallBack)}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(Be._AttributeDirtyCallBack)}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(Be._MiscDirtyCallBack)}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(Be._MiscDirtyCallBack)}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(Be._TextureAndMiscDirtyCallBack)}_checkScenePerformancePriority(){if(this._scene.performancePriority!==zo.BackwardCompatible){this.checkReadyOnlyOnce=!0;const e=this._scene.onScenePerformancePriorityChangedObservable.addOnce(()=>{this.checkReadyOnlyOnce=!1});this.onDisposeObservable.add(()=>{this._scene.onScenePerformancePriorityChangedObservable.remove(e)})}}setPrePassRenderer(e){return!1}dispose(e,i,s){const n=this.getScene();if(n.stopAnimation(this),n.freeProcessedMaterials(),n.removeMaterial(this),this._eventInfo.forceDisposeTextures=i,this._callbackPluginEventGeneric(ws.Disposed,this._eventInfo),this._parentContainer){const a=this._parentContainer.materials.indexOf(this);a>-1&&this._parentContainer.materials.splice(a,1),this._parentContainer=null}if(s!==!0)if(this.meshMap)for(const a in this.meshMap){const p=this.meshMap[a];p&&(p.material=null,this.releaseVertexArrayObject(p,e))}else{const a=n.meshes;for(const p of a)p.material===this&&!p.sourceMesh&&(p.material=null,this.releaseVertexArrayObject(p,e))}this._uniformBuffer.dispose(),e&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&(this._eventInfo={})}releaseVertexArrayObject(e,i){if(e.geometry){const s=e.geometry;if(this._storeEffectOnSubMeshes)for(const n of e.subMeshes)s._releaseVertexArrayObject(n.effect),i&&n.effect&&n.effect.dispose();else s._releaseVertexArrayObject(this._drawWrapper.effect)}}serialize(){const e=Kt.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,e}static Parse(e,i,s){if(!e.customType)e.customType="BABYLON.StandardMaterial";else if(e.customType==="BABYLON.PBRMaterial"&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return Ie.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null;const a=Le.Instantiate(e.customType).Parse(e,i,s);return a._loadedUniqueId=e.uniqueId,a}}Be.TriangleFillMode=0,Be.WireFrameFillMode=1,Be.PointFillMode=2,Be.PointListDrawMode=3,Be.LineListDrawMode=4,Be.LineLoopDrawMode=5,Be.LineStripDrawMode=6,Be.TriangleStripDrawMode=7,Be.TriangleFanDrawMode=8,Be.ClockWiseSideOrientation=0,Be.CounterClockWiseSideOrientation=1,Be.TextureDirtyFlag=1,Be.LightDirtyFlag=2,Be.FresnelDirtyFlag=4,Be.AttributesDirtyFlag=8,Be.MiscDirtyFlag=16,Be.PrePassDirtyFlag=32,Be.AllDirtyFlag=63,Be.MATERIAL_OPAQUE=0,Be.MATERIAL_ALPHATEST=1,Be.MATERIAL_ALPHABLEND=2,Be.MATERIAL_ALPHATESTANDBLEND=3,Be.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0,Be.MATERIAL_NORMALBLENDMETHOD_RNM=1,Be.OnEventObservable=new Re,Zt.OnEnginesDisposedObservable.addOnce(()=>{Be.OnEventObservable.clear()}),Be._AllDirtyCallBack=l=>l.markAllAsDirty(),Be._ImageProcessingDirtyCallBack=l=>l.markAsImageProcessingDirty(),Be._TextureDirtyCallBack=l=>l.markAsTexturesDirty(),Be._FresnelDirtyCallBack=l=>l.markAsFresnelDirty(),Be._MiscDirtyCallBack=l=>l.markAsMiscDirty(),Be._PrePassDirtyCallBack=l=>l.markAsPrePassDirty(),Be._LightsDirtyCallBack=l=>l.markAsLightDirty(),Be._AttributeDirtyCallBack=l=>l.markAsAttributesDirty(),Be._FresnelAndMiscDirtyCallBack=l=>{Be._FresnelDirtyCallBack(l),Be._MiscDirtyCallBack(l)},Be._TextureAndMiscDirtyCallBack=l=>{Be._TextureDirtyCallBack(l),Be._MiscDirtyCallBack(l)},Be._DirtyCallbackArray=[],Be._RunDirtyCallBacks=l=>{for(const e of Be._DirtyCallbackArray)e(l)},J([xe()],Be.prototype,"id",void 0),J([xe()],Be.prototype,"uniqueId",void 0),J([xe()],Be.prototype,"name",void 0),J([xe()],Be.prototype,"metadata",void 0),J([xe()],Be.prototype,"checkReadyOnEveryCall",void 0),J([xe()],Be.prototype,"checkReadyOnlyOnce",void 0),J([xe()],Be.prototype,"state",void 0),J([xe("alpha")],Be.prototype,"_alpha",void 0),J([xe("backFaceCulling")],Be.prototype,"_backFaceCulling",void 0),J([xe("cullBackFaces")],Be.prototype,"_cullBackFaces",void 0),J([xe()],Be.prototype,"sideOrientation",void 0),J([xe("alphaMode")],Be.prototype,"_alphaMode",void 0),J([xe()],Be.prototype,"_needDepthPrePass",void 0),J([xe()],Be.prototype,"disableDepthWrite",void 0),J([xe()],Be.prototype,"disableColorWrite",void 0),J([xe()],Be.prototype,"forceDepthWrite",void 0),J([xe()],Be.prototype,"depthFunction",void 0),J([xe()],Be.prototype,"separateCullingPass",void 0),J([xe("fogEnabled")],Be.prototype,"_fogEnabled",void 0),J([xe()],Be.prototype,"pointSize",void 0),J([xe()],Be.prototype,"zOffset",void 0),J([xe()],Be.prototype,"zOffsetUnits",void 0),J([xe()],Be.prototype,"pointsCloud",null),J([xe()],Be.prototype,"fillMode",null),J([xe()],Be.prototype,"transparencyMode",null);class Aa{constructor(e,i){this.width=e,this.height=i}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=this.width|0;return e=e*397^(this.height|0),e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,i){return this.width=e,this.height=i,this}set(e,i){return this.copyFromFloats(e,i)}multiplyByFloats(e,i){return new Aa(this.width*e,this.height*i)}clone(){return new Aa(this.width,this.height)}equals(e){return e?this.width===e.width&&this.height===e.height:!1}get surface(){return this.width*this.height}static Zero(){return new Aa(0,0)}add(e){return new Aa(this.width+e.width,this.height+e.height)}subtract(e){return new Aa(this.width-e.width,this.height-e.height)}static Lerp(e,i,s){const n=e.width+(i.width-e.width)*s,a=e.height+(i.height-e.height)*s;return new Aa(n,a)}}class h_{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return this._texture?this._texture.isCube:!1}set isCube(e){!this._texture||(this._texture.isCube=e)}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){!this._texture||(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){!this._texture||(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}static _IsRenderTargetWrapper(e){return e?._shareDepth!==void 0}constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=Aa.Zero(),this._cachedBaseSize=Aa.Zero(),this._initialSamplingMode=2,this._texture=h_._IsRenderTargetWrapper(e)?e.texture:e,this._texture&&(this._engine=this._texture.getEngine())}isReady(){return this.delayLoadState===4?(this.delayLoad(),!1):this._texture?this._texture.isReady:!1}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return!this.isReady()||!this._texture?(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize):this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}}class er extends h_{set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){!this._texture||(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){!this._texture||(this._texture.is2DArray=e)}get gammaSpace(){if(this._texture)this._texture._gammaSpace===null&&(this._texture._gammaSpace=this._gammaSpace);else return this._gammaSpace;return this._texture._gammaSpace&&!this._texture._useSRGBBuffer}set gammaSpace(e){if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}this._markAllSubMeshesAsTexturesDirty()}get isRGBD(){return this._texture!=null&&this._texture._isRGBD}set isRGBD(e){this._texture&&(this._texture._isRGBD=e)}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return this._texture?this._texture._linearSpecularLOD:!1}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=m2()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}constructor(e,i=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=er.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=new Array,this.onDisposeObservable=new Re,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?er._IsScene(e)?this._scene=e:this._engine=e:this._scene=Zt.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=i,this._uid=null}getScene(){return this._scene}_getEngine(){return this._engine}checkTransformsAreIdentical(e){return e!==null}getTextureMatrix(){return fe.IdentityReadOnly}getReflectionTextureMatrix(){return fe.IdentityReadOnly}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,i,s,n,a,p){const _=this._getEngine();if(!_)return null;const g=_._getUseSRGBBuffer(!!a,i),y=_.getLoadedTexturesCache();for(let b=0;b<y.length;b++){const v=y[b];if((a===void 0||g===v._useSRGBBuffer)&&(n===void 0||n===v.invertY)&&v.url===e&&v.generateMipMaps===!i&&(!s||s===v.samplingMode)&&(p===void 0||p===v.isCube))return v.incrementReferences(),v}return null}_rebuild(){}clone(){return null}get textureType(){return this._texture&&this._texture.type!==void 0?this._texture.type:0}get textureFormat(){return this._texture&&this._texture.format!==void 0?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){const e=this.getScene();!e||e.markAllMaterialsAsDirty(1)}readPixels(e=0,i=0,s=null,n=!0,a=!1,p=0,_=0,g=Number.MAX_VALUE,y=Number.MAX_VALUE){if(!this._texture)return null;const b=this._getEngine();if(!b)return null;const v=this.getSize();let S=v.width,M=v.height;i!==0&&(S=S/Math.pow(2,i),M=M/Math.pow(2,i),S=Math.round(S),M=Math.round(M)),g=Math.min(S,g),y=Math.min(M,y);try{return this._texture.isCube?b._readTexturePixels(this._texture,g,y,e,i,s,n,a,p,_):b._readTexturePixels(this._texture,g,y,-1,i,s,n,a,p,_)}catch{return null}}_readPixelsSync(e=0,i=0,s=null,n=!0,a=!1){if(!this._texture)return null;const p=this.getSize();let _=p.width,g=p.height;const y=this._getEngine();if(!y)return null;i!=0&&(_=_/Math.pow(2,i),g=g/Math.pow(2,i),_=Math.round(_),g=Math.round(g));try{return this._texture.isCube?y._readTexturePixelsSync(this._texture,_,g,e,i,s,n,a):y._readTexturePixelsSync(this._texture,_,g,-1,i,s,n,a)}catch{return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);const e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){const i=this._parentContainer.textures.indexOf(this);i>-1&&this._parentContainer.textures.splice(i,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(e=!1){if(!this.name&&!e)return null;const i=Kt.Serialize(this);return Kt.AppendSerializedAnimations(this,i),i}static WhenAllReady(e,i){let s=e.length;if(s===0){i();return}for(let n=0;n<e.length;n++){const a=e[n];if(a.isReady())--s===0&&i();else{const p=a.onLoadObservable;p?p.addOnce(()=>{--s===0&&i()}):--s===0&&i()}}}static _IsScene(e){return e.getClassName()==="Scene"}}er.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4,J([xe()],er.prototype,"uniqueId",void 0),J([xe()],er.prototype,"name",void 0),J([xe()],er.prototype,"metadata",void 0),J([xe("hasAlpha")],er.prototype,"_hasAlpha",void 0),J([xe("getAlphaFromRGB")],er.prototype,"_getAlphaFromRGB",void 0),J([xe()],er.prototype,"level",void 0),J([xe("coordinatesIndex")],er.prototype,"_coordinatesIndex",void 0),J([xe()],er.prototype,"optimizeUVAllocation",void 0),J([xe("coordinatesMode")],er.prototype,"_coordinatesMode",void 0),J([xe()],er.prototype,"wrapU",null),J([xe()],er.prototype,"wrapV",null),J([xe()],er.prototype,"wrapR",void 0),J([xe()],er.prototype,"anisotropicFilteringLevel",void 0),J([xe()],er.prototype,"isCube",null),J([xe()],er.prototype,"is3D",null),J([xe()],er.prototype,"is2DArray",null),J([xe()],er.prototype,"gammaSpace",null),J([xe()],er.prototype,"invertZ",void 0),J([xe()],er.prototype,"lodLevelInAlpha",void 0),J([xe()],er.prototype,"lodGenerationOffset",null),J([xe()],er.prototype,"lodGenerationScale",null),J([xe()],er.prototype,"linearSpecularLOD",null),J([qi()],er.prototype,"irradianceTexture",null),J([xe()],er.prototype,"isRenderTarget",void 0);function u_(l,e,i=!1){const s=e.width,n=e.height;if(l instanceof Float32Array){let y=l.byteLength/l.BYTES_PER_ELEMENT;const b=new Uint8Array(y);for(;--y>=0;){let v=l[y];v<0?v=0:v>1&&(v=1),b[y]=v*255}l=b}const a=document.createElement("canvas");a.width=s,a.height=n;const p=a.getContext("2d");if(!p)return null;const _=p.createImageData(s,n);if(_.data.set(l),p.putImageData(_,0,0),i){const y=document.createElement("canvas");y.width=s,y.height=n;const b=y.getContext("2d");return b?(b.translate(0,n),b.scale(1,-1),b.drawImage(a,0,0),y.toDataURL("image/png")):null}return a.toDataURL("image/png")}function HE(l,e=0,i=0){const s=l.getInternalTexture();if(!s)return null;const n=l._readPixelsSync(e,i);return n?u_(n,l.getSize(),s.invertY):null}async function XE(l,e=0,i=0){const s=l.getInternalTexture();if(!s)return null;const n=await l.readPixels(e,i);return n?u_(n,l.getSize(),s.invertY):null}const QY={GenerateBase64StringFromPixelData:u_,GenerateBase64StringFromTexture:HE,GenerateBase64StringFromTextureAsync:XE};class wr{}wr.UseOpenGLOrientationForUV=!1;class Oe extends er{get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}constructor(e,i,s,n,a=Oe.TRILINEAR_SAMPLINGMODE,p=null,_=null,g=null,y=!1,b,v,S,M,F){var L,N,k,G,H,z,W,Y,Z;super(i),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new Re,this._isBlocking=!0,this.name=e||"",this.url=e;let Q,se=!1,$=null;typeof s=="object"&&s!==null?(Q=(L=s.noMipmap)!==null&&L!==void 0?L:!1,n=(N=s.invertY)!==null&&N!==void 0?N:!wr.UseOpenGLOrientationForUV,a=(k=s.samplingMode)!==null&&k!==void 0?k:Oe.TRILINEAR_SAMPLINGMODE,p=(G=s.onLoad)!==null&&G!==void 0?G:null,_=(H=s.onError)!==null&&H!==void 0?H:null,g=(z=s.buffer)!==null&&z!==void 0?z:null,y=(W=s.deleteBuffer)!==null&&W!==void 0?W:!1,b=s.format,v=s.mimeType,S=s.loaderOptions,M=s.creationFlags,se=(Y=s.useSRGBBuffer)!==null&&Y!==void 0?Y:!1,$=(Z=s.internalTexture)!==null&&Z!==void 0?Z:null):Q=!!s,this._noMipmap=Q,this._invertY=n===void 0?!wr.UseOpenGLOrientationForUV:n,this._initialSamplingMode=a,this._buffer=g,this._deleteBuffer=y,this._mimeType=v,this._loaderOptions=S,this._creationFlags=M,this._useSRGBBuffer=se,this._forcedExtension=F,b&&(this._format=b);const oe=this.getScene(),ue=this._getEngine();if(!ue)return;ue.onBeforeTextureInitObservable.notifyObservers(this);const de=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),this._texture._cachedWrapU!==null&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),this._texture._cachedWrapV!==null&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),this._texture._cachedWrapR!==null&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),p&&p(),!this.isBlocking&&oe&&oe.resetCachedMaterial()},ye=(_e,we)=>{this._loadingError=!0,this._errorObject={message:_e,exception:we},_&&_(_e,we),Oe.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!$){this._delayedOnLoad=de,this._delayedOnError=ye;return}if(this._texture=$??this._getFromCache(this.url,Q,a,this._invertY,se),this._texture)if(this._texture.isReady)pc.SetImmediate(()=>de());else{const _e=this._texture.onLoadedObservable.add(de);this._texture.onErrorObservable.add(we=>{var Pe;ye(we.message,we.exception),(Pe=this._texture)===null||Pe===void 0||Pe.onLoadedObservable.remove(_e)})}else if(!oe||!oe.useDelayedTextureLoading){try{this._texture=ue.createTexture(this.url,Q,this._invertY,oe,a,de,ye,this._buffer,void 0,this._format,this._forcedExtension,v,S,M,se)}catch(_e){throw ye("error loading",_e),_e}y&&(this._buffer=null)}else this.delayLoadState=4,this._delayedOnLoad=de,this._delayedOnError=ye}updateURL(e,i=null,s,n){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1)),(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,this._buffer=i,this._forcedExtension=n,this.delayLoadState=4,s&&(this._delayedOnLoad=s),this.delayLoad()}delayLoad(){if(this.delayLoadState!==4)return;const e=this.getScene();!e||(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer),this._texture?this._delayedOnLoad&&(this._texture.isReady?pc.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(e,i,s,n){e*=this._cachedUScale,i*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,i-=this.vRotationCenter*this._cachedVScale,s-=this.wRotationCenter,j.TransformCoordinatesFromFloatsToRef(e,i,s,this._rowGenerationMatrix,n),n.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,n.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,n.z+=this.wRotationCenter}checkTransformsAreIdentical(e){return e!==null&&this.uOffset===e.uOffset&&this.vOffset===e.vOffset&&this.uScale===e.uScale&&this.vScale===e.vScale&&this.uAng===e.uAng&&this.vAng===e.vAng&&this.wAng===e.wAng}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=fe.Zero(),this._rowGenerationMatrix=new fe,this._t0=j.Zero(),this._t1=j.Zero(),this._t2=j.Zero()),fe.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(fe.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,ge.Matrix[0]),fe.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,ge.Matrix[1]),fe.ScalingToRef(this._cachedUScale,this._cachedVScale,0,ge.Matrix[2]),fe.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,ge.Matrix[3]),ge.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(ge.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(ge.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(ge.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),fe.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));const i=this.getScene();return i?(this.optimizeUVAllocation&&i.markAllMaterialsAsDirty(1,s=>s.hasTexture(this)),this._cachedTextureMatrix):this._cachedTextureMatrix}getReflectionTextureMatrix(){const e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode)if(this.coordinatesMode===Oe.PROJECTION_MODE){if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}else return this._cachedReflectionTextureMatrix;this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=fe.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=fe.Zero());const i=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case Oe.PLANAR_MODE:{fe.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break}case Oe.PROJECTION_MODE:{fe.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);const s=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=s.updateFlag,s.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:fe.IdentityToRef(this._cachedReflectionTextureMatrix);break}return i&&e.markAllMaterialsAsDirty(1,s=>s.getActiveTextures().indexOf(this)!==-1),this._cachedReflectionTextureMatrix}clone(){const e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return Kt.Clone(()=>new Oe(this._texture?this._texture.url:null,this.getScene(),e),this)}serialize(){var e,i;const s=this.name;Oe.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");const n=super.serialize(Oe._SerializeInternalTextureUniqueId);return n?((Oe.SerializeBuffers||Oe.ForceSerializeBuffers)&&(typeof this._buffer=="string"&&this._buffer.substr(0,5)==="data:"?(n.base64String=this._buffer,n.name=n.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?n.base64String="data:image/png;base64,"+qm(this._buffer):(Oe.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(n.base64String=!this._engine||this._engine._features.supportSyncTextureRead?HE(this):XE(this))),n.invertY=this._invertY,n.samplingMode=this.samplingMode,n._creationFlags=this._creationFlags,n._useSRGBBuffer=this._useSRGBBuffer,Oe._SerializeInternalTextureUniqueId&&(n.internalTextureUniqueId=(i=(e=this._texture)===null||e===void 0?void 0:e.uniqueId)!==null&&i!==void 0?i:void 0),this.name=s,n):null}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}static Parse(e,i,s){if(e.customType){const y=Hh.Instantiate(e.customType).Parse(e,i,s);return e.samplingMode&&y.updateSamplingMode&&y._samplingMode&&y._samplingMode!==e.samplingMode&&y.updateSamplingMode(e.samplingMode),y}if(e.isCube&&!e.isRenderTarget)return Oe._CubeTextureParser(e,i,s);const n=e.internalTextureUniqueId!==void 0;if(!e.name&&!e.isRenderTarget&&!n)return null;let a;if(n){const g=i.getEngine().getLoadedTexturesCache();for(const y of g)if(y.uniqueId===e.internalTextureUniqueId){a=y;break}}const p=g=>{var y;if(g&&g._texture&&(g._texture._cachedWrapU=null,g._texture._cachedWrapV=null,g._texture._cachedWrapR=null),e.samplingMode){const b=e.samplingMode;g&&g.samplingMode!==b&&g.updateSamplingMode(b)}if(g&&e.animations)for(let b=0;b<e.animations.length;b++){const v=e.animations[b],S=Ka("BABYLON.Animation");S&&g.animations.push(S.Parse(v))}n&&!a&&((y=g?._texture)===null||y===void 0||y._setUniqueId(e.internalTextureUniqueId))};return Kt.Parse(()=>{var g,y,b;let v=!0;if(e.noMipmap&&(v=!1),e.mirrorPlane){const S=Oe._CreateMirror(e.name,e.renderTargetSize,i,v);return S._waitingRenderList=e.renderList,S.mirrorPlane=aa.FromArray(e.mirrorPlane),p(S),S}else if(e.isRenderTarget){let S=null;if(e.isCube){if(i.reflectionProbes)for(let M=0;M<i.reflectionProbes.length;M++){const F=i.reflectionProbes[M];if(F.name===e.name)return F.cubeTexture}}else S=Oe._CreateRenderTargetTexture(e.name,e.renderTargetSize,i,v,(g=e._creationFlags)!==null&&g!==void 0?g:0),S._waitingRenderList=e.renderList;return p(S),S}else{let S;if(e.base64String&&!a)S=Oe.CreateFromBase64String(e.base64String,e.base64String,i,!v,e.invertY,e.samplingMode,()=>{p(S)},(y=e._creationFlags)!==null&&y!==void 0?y:0,(b=e._useSRGBBuffer)!==null&&b!==void 0?b:!1),S.name=e.name;else{let M;e.name&&e.name.indexOf("://")>0?M=e.name:M=s+e.name,e.url&&(e.url.startsWith("data:")||Oe.UseSerializedUrlIfAny)&&(M=e.url);const F={noMipmap:!v,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:()=>{p(S)},internalTexture:a};S=new Oe(M,i,F)}return S}},e,i)}static CreateFromBase64String(e,i,s,n,a,p=Oe.TRILINEAR_SAMPLINGMODE,_=null,g=null,y=5,b){return new Oe("data:"+i,s,n,a,p,_,g,e,!1,y,void 0,void 0,b)}static LoadFromDataString(e,i,s,n=!1,a,p=!0,_=Oe.TRILINEAR_SAMPLINGMODE,g=null,y=null,b=5,v){return e.substr(0,5)!=="data:"&&(e="data:"+e),new Oe(e,s,a,p,_,g,y,i,n,b,void 0,void 0,v)}}Oe.SerializeBuffers=!0,Oe.ForceSerializeBuffers=!1,Oe.OnTextureLoadErrorObservable=new Re,Oe._SerializeInternalTextureUniqueId=!1,Oe._CubeTextureParser=(l,e,i)=>{throw xi("CubeTexture")},Oe._CreateMirror=(l,e,i,s)=>{throw xi("MirrorTexture")},Oe._CreateRenderTargetTexture=(l,e,i,s,n)=>{throw xi("RenderTargetTexture")},Oe.NEAREST_SAMPLINGMODE=1,Oe.NEAREST_NEAREST_MIPLINEAR=8,Oe.BILINEAR_SAMPLINGMODE=2,Oe.LINEAR_LINEAR_MIPNEAREST=11,Oe.TRILINEAR_SAMPLINGMODE=3,Oe.LINEAR_LINEAR_MIPLINEAR=3,Oe.NEAREST_NEAREST_MIPNEAREST=4,Oe.NEAREST_LINEAR_MIPNEAREST=5,Oe.NEAREST_LINEAR_MIPLINEAR=6,Oe.NEAREST_LINEAR=7,Oe.NEAREST_NEAREST=1,Oe.LINEAR_NEAREST_MIPNEAREST=9,Oe.LINEAR_NEAREST_MIPLINEAR=10,Oe.LINEAR_LINEAR=2,Oe.LINEAR_NEAREST=12,Oe.EXPLICIT_MODE=0,Oe.SPHERICAL_MODE=1,Oe.PLANAR_MODE=2,Oe.CUBIC_MODE=3,Oe.PROJECTION_MODE=4,Oe.SKYBOX_MODE=5,Oe.INVCUBIC_MODE=6,Oe.EQUIRECTANGULAR_MODE=7,Oe.FIXED_EQUIRECTANGULAR_MODE=8,Oe.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,Oe.CLAMP_ADDRESSMODE=0,Oe.WRAP_ADDRESSMODE=1,Oe.MIRROR_ADDRESSMODE=2,Oe.UseSerializedUrlIfAny=!1,J([xe()],Oe.prototype,"url",void 0),J([xe()],Oe.prototype,"uOffset",void 0),J([xe()],Oe.prototype,"vOffset",void 0),J([xe()],Oe.prototype,"uScale",void 0),J([xe()],Oe.prototype,"vScale",void 0),J([xe()],Oe.prototype,"uAng",void 0),J([xe()],Oe.prototype,"vAng",void 0),J([xe()],Oe.prototype,"wAng",void 0),J([xe()],Oe.prototype,"uRotationCenter",void 0),J([xe()],Oe.prototype,"vRotationCenter",void 0),J([xe()],Oe.prototype,"wRotationCenter",void 0),J([xe()],Oe.prototype,"homogeneousRotationInUVTransform",void 0),J([xe()],Oe.prototype,"isBlocking",null),ur("BABYLON.Texture",Oe),Kt._TextureParser=Oe.Parse;class $9{constructor(e){this.name=Vt.NAME_LAYER,this.scene=e||Zt.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine(),this.scene.layers=new Array)}register(){this.scene._beforeCameraDrawStage.registerStep(Vt.STEP_BEFORECAMERADRAW_LAYER,this,this._drawCameraBackground),this.scene._afterCameraDrawStage.registerStep(Vt.STEP_AFTERCAMERADRAW_LAYER,this,this._drawCameraForegroundWithPostProcessing),this.scene._afterCameraPostProcessStage.registerStep(Vt.STEP_AFTERCAMERAPOSTPROCESS_LAYER,this,this._drawCameraForegroundWithoutPostProcessing),this.scene._beforeRenderTargetDrawStage.registerStep(Vt.STEP_BEFORERENDERTARGETDRAW_LAYER,this,this._drawRenderTargetBackground),this.scene._afterRenderTargetDrawStage.registerStep(Vt.STEP_AFTERRENDERTARGETDRAW_LAYER,this,this._drawRenderTargetForegroundWithPostProcessing),this.scene._afterRenderTargetPostProcessStage.registerStep(Vt.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER,this,this._drawRenderTargetForegroundWithoutPostProcessing)}rebuild(){const e=this.scene.layers;for(const i of e)i._rebuild()}dispose(){const e=this.scene.layers;for(;e.length;)e[0].dispose()}_draw(e){const i=this.scene.layers;if(i.length){this._engine.setDepthBuffer(!1);for(const s of i)e(s)&&s.render();this._engine.setDepthBuffer(!0)}}_drawCameraPredicate(e,i,s,n){return!e.renderOnlyInRenderTargetTextures&&e.isBackground===i&&e.applyPostProcess===s&&(e.layerMask&n)!==0}_drawCameraBackground(e){this._draw(i=>this._drawCameraPredicate(i,!0,!0,e.layerMask))}_drawCameraForegroundWithPostProcessing(e){this._draw(i=>this._drawCameraPredicate(i,!1,!0,e.layerMask))}_drawCameraForegroundWithoutPostProcessing(e){this._draw(i=>this._drawCameraPredicate(i,!1,!1,e.layerMask))}_drawRenderTargetPredicate(e,i,s,n,a){return e.renderTargetTextures.length>0&&e.isBackground===i&&e.applyPostProcess===s&&e.renderTargetTextures.indexOf(a)>-1&&(e.layerMask&n)!==0}_drawRenderTargetBackground(e){this._draw(i=>this._drawRenderTargetPredicate(i,!0,!0,this.scene.activeCamera.layerMask,e))}_drawRenderTargetForegroundWithPostProcessing(e){this._draw(i=>this._drawRenderTargetPredicate(i,!1,!0,this.scene.activeCamera.layerMask,e))}_drawRenderTargetForegroundWithoutPostProcessing(e){this._draw(i=>this._drawRenderTargetPredicate(i,!1,!1,this.scene.activeCamera.layerMask,e))}addFromContainer(e){!e.layers||e.layers.forEach(i=>{this.scene.layers.push(i)})}removeFromContainer(e,i=!1){!e.layers||e.layers.forEach(s=>{const n=this.scene.layers.indexOf(s);n!==-1&&this.scene.layers.splice(n,1),i&&s.dispose()})}}const YE="helperFunctions",KE=`const float PI=3.1415926535897932384626433832795;
const float HALF_MIN=5.96046448e-08; 
const float LinearEncodePowerApprox=2.2;
const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;
const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);
const float Epsilon=0.0000001;
#define saturate(x) clamp(x,0.0,1.0)
#define absEps(x) abs(x)+Epsilon
#define maxEps(x) max(x,Epsilon)
#define saturateEps(x) clamp(x,Epsilon,1.0)
mat3 transposeMat3(mat3 inMatrix) {
vec3 i0=inMatrix[0];
vec3 i1=inMatrix[1];
vec3 i2=inMatrix[2];
mat3 outMatrix=mat3(
vec3(i0.x,i1.x,i2.x),
vec3(i0.y,i1.y,i2.y),
vec3(i0.z,i1.z,i2.z)
);
return outMatrix;
}
mat3 inverseMat3(mat3 inMatrix) {
float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];
float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];
float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];
float b01=a22*a11-a12*a21;
float b11=-a22*a10+a12*a20;
float b21=a21*a10-a11*a20;
float det=a00*b01+a01*b11+a02*b21;
return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),
b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),
b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;
}
#if USE_EXACT_SRGB_CONVERSIONS
vec3 toLinearSpaceExact(vec3 color)
{
vec3 nearZeroSection=0.0773993808*color;
vec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));
#else
return
vec3(
color.r<=0.04045 ? nearZeroSection.r : remainingSection.r,
color.g<=0.04045 ? nearZeroSection.g : remainingSection.g,
color.b<=0.04045 ? nearZeroSection.b : remainingSection.b);
#endif
}
vec3 toGammaSpaceExact(vec3 color)
{
vec3 nearZeroSection=12.92*color;
vec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));
#else
return
vec3(
color.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,
color.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,
color.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);
#endif
}
#endif
float toLinearSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=0.0773993808*color;
float remainingSection=pow(0.947867299*(color+0.055),2.4);
return color<=0.04045 ? nearZeroSection : remainingSection;
#else
return pow(color,LinearEncodePowerApprox);
#endif
}
vec3 toLinearSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toLinearSpaceExact(color);
#else
return pow(color,vec3(LinearEncodePowerApprox));
#endif
}
vec4 toLinearSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toLinearSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);
#endif
}
float toGammaSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=12.92*color;
float remainingSection=1.055*pow(color,0.41666)-0.055;
return color<=0.0031308 ? nearZeroSection : remainingSection;
#else
return pow(color,GammaEncodePowerApprox);
#endif
}
vec3 toGammaSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toGammaSpaceExact(color);
#else
return pow(color,vec3(GammaEncodePowerApprox));
#endif
}
vec4 toGammaSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toGammaSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);
#endif
}
float square(float value)
{
return value*value;
}
vec3 square(vec3 value)
{
return value*value;
}
float pow5(float value) {
float sq=value*value;
return sq*sq*value;
}
float getLuminance(vec3 color)
{
return clamp(dot(color,LuminanceEncodeApprox),0.,1.);
}
float getRand(vec2 seed) {
return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);
}
float dither(vec2 seed,float varianceAmount) {
float rand=getRand(seed);
float normVariance=varianceAmount/255.0;
float dither=mix(-normVariance,normVariance,rand);
return dither;
}
const float rgbdMaxRange=255.0;
vec4 toRGBD(vec3 color) {
float maxRGB=maxEps(max(color.r,max(color.g,color.b)));
float D =max(rgbdMaxRange/maxRGB,1.);
D =clamp(floor(D)/255.0,0.,1.);
vec3 rgb=color.rgb*D;
rgb=toGammaSpace(rgb);
return vec4(clamp(rgb,0.,1.),D); 
}
vec3 fromRGBD(vec4 rgbd) {
rgbd.rgb=toLinearSpace(rgbd.rgb);
return rgbd.rgb/rgbd.a;
}
vec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {
vec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;
vec3 halfSize=cubeSize*0.5;
vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;
vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;
vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);
float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);
vec3 intersectPositionWS=vertexPos+origVec*distance;
return intersectPositionWS-cubePos;
}
`;Ye.IncludesShadersStore[YE]=KE;const $Y={name:YE,shader:KE},jE="layerPixelShader",qE=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec4 color;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 baseColor=texture2D(textureSampler,vUV);
#ifdef LINEAR
baseColor.rgb=toGammaSpace(baseColor.rgb);
#endif
#ifdef ALPHATEST
if (baseColor.a<0.4)
discard;
#endif
gl_FragColor=baseColor*color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;Ye.ShadersStore[jE]=qE;const JY={name:jE,shader:qE},ZE="layerVertexShader",QE=`attribute vec2 position;
uniform vec2 scale;
uniform vec2 offset;
uniform mat4 textureMatrix;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec2 shiftedPosition=position*scale+offset;
vUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));
gl_Position=vec4(shiftedPosition,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;Ye.ShadersStore[ZE]=QE;const eK={name:ZE,shader:QE};class J9{set applyPostProcess(e){this._applyPostProcess=e}get applyPostProcess(){return this.isBackground||this._applyPostProcess}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}constructor(e,i,s,n,a){this.name=e,this._applyPostProcess=!0,this.scale=new ii(1,1),this.offset=new ii(0,0),this.alphaBlendingMode=2,this.layerMask=268435455,this.renderTargetTextures=[],this.renderOnlyInRenderTargetTextures=!1,this.isEnabled=!0,this._vertexBuffers={},this.onDisposeObservable=new Re,this.onBeforeRenderObservable=new Re,this.onAfterRenderObservable=new Re,this.texture=i?new Oe(i,s,!0):null,this.isBackground=n===void 0?!0:n,this.color=a===void 0?new pi(1,1,1,1):a,this._scene=s||Zt.LastCreatedScene;let p=this._scene._getComponent(Vt.NAME_LAYER);p||(p=new $9(this._scene),this._scene._addComponent(p)),this._scene.layers.push(this);const _=this._scene.getEngine();this._drawWrapper=new ul(_);const g=[];g.push(1,1),g.push(-1,1),g.push(-1,-1),g.push(1,-1);const y=new te(_,g,te.PositionKind,!1,!1,2);this._vertexBuffers[te.PositionKind]=y,this._createIndexBuffer()}_createIndexBuffer(){const e=this._scene.getEngine(),i=[];i.push(0),i.push(1),i.push(2),i.push(0),i.push(2),i.push(3),this._indexBuffer=e.createIndexBuffer(i)}_rebuild(){const e=this._vertexBuffers[te.PositionKind];e&&e._rebuild(),this._createIndexBuffer()}render(){if(!this.isEnabled)return;const e=this._scene.getEngine();let i="";this.alphaTest&&(i="#define ALPHATEST"),this.texture&&!this.texture.gammaSpace&&(i+=`\r
#define LINEAR`),this._previousDefines!==i&&(this._previousDefines=i,this._drawWrapper.effect=e.createEffect("layer",[te.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],i));const s=this._drawWrapper.effect;!s||!s.isReady()||!this.texture||!this.texture.isReady()||(this.onBeforeRenderObservable.notifyObservers(this),e.enableEffect(this._drawWrapper),e.setState(!1),s.setTexture("textureSampler",this.texture),s.setMatrix("textureMatrix",this.texture.getTextureMatrix()),s.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a),s.setVector2("offset",this.offset),s.setVector2("scale",this.scale),e.bindBuffers(this._vertexBuffers,this._indexBuffer,s),this.alphaTest?e.drawElementsType(Be.TriangleFillMode,0,6):(e.setAlphaMode(this.alphaBlendingMode),e.drawElementsType(Be.TriangleFillMode,0,6),e.setAlphaMode(0)),this.onAfterRenderObservable.notifyObservers(this))}dispose(){const e=this._vertexBuffers[te.PositionKind];e&&(e.dispose(),this._vertexBuffers[te.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.texture&&(this.texture.dispose(),this.texture=null),this.renderTargetTextures=[];const i=this._scene.layers.indexOf(this);this._scene.layers.splice(i,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderObservable.clear()}}function d_(l,e,i){try{const s=l.next();s.done?e(s):s.value?s.value.then(()=>{s.value=void 0,e(s)},i):e(s)}catch(s){i(s)}}function eW(l=25){let e;return(i,s,n)=>{const a=performance.now();e===void 0||a-e>l?(e=a,setTimeout(()=>{d_(i,s,n)},0)):d_(i,s,n)}}function $E(l,e,i,s,n){const a=()=>{let p;const _=g=>{g.done?i(g.value):p===void 0?p=!0:a()};do p=void 0,!n||!n.aborted?e(l,_,s):s(new Error("Aborted")),p===void 0&&(p=!1);while(p)};a()}function f_(l,e){let i;return $E(l,d_,s=>i=s,s=>{throw s},e),i}function JE(l,e,i){return new Promise((s,n)=>{$E(l,e,s,n,i)})}function tW(l,e){return(...i)=>f_(l(...i),e)}function tK(l,e,i){return(...s)=>JE(l(...s),e,i)}class Mt{constructor(){this._applyTo=tW(this._applyToCoroutine.bind(this))}set(e,i){switch(e.length||Ie.Warn(`Setting vertex data kind '${i}' with an empty array`),i){case te.PositionKind:this.positions=e;break;case te.NormalKind:this.normals=e;break;case te.TangentKind:this.tangents=e;break;case te.UVKind:this.uvs=e;break;case te.UV2Kind:this.uvs2=e;break;case te.UV3Kind:this.uvs3=e;break;case te.UV4Kind:this.uvs4=e;break;case te.UV5Kind:this.uvs5=e;break;case te.UV6Kind:this.uvs6=e;break;case te.ColorKind:this.colors=e;break;case te.MatricesIndicesKind:this.matricesIndices=e;break;case te.MatricesWeightsKind:this.matricesWeights=e;break;case te.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case te.MatricesWeightsExtraKind:this.matricesWeightsExtra=e;break}}applyToMesh(e,i){return this._applyTo(e,i,!1),this}applyToGeometry(e,i){return this._applyTo(e,i,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,i=!1,s){return this.positions&&(e.setVerticesData(te.PositionKind,this.positions,i),s&&(yield)),this.normals&&(e.setVerticesData(te.NormalKind,this.normals,i),s&&(yield)),this.tangents&&(e.setVerticesData(te.TangentKind,this.tangents,i),s&&(yield)),this.uvs&&(e.setVerticesData(te.UVKind,this.uvs,i),s&&(yield)),this.uvs2&&(e.setVerticesData(te.UV2Kind,this.uvs2,i),s&&(yield)),this.uvs3&&(e.setVerticesData(te.UV3Kind,this.uvs3,i),s&&(yield)),this.uvs4&&(e.setVerticesData(te.UV4Kind,this.uvs4,i),s&&(yield)),this.uvs5&&(e.setVerticesData(te.UV5Kind,this.uvs5,i),s&&(yield)),this.uvs6&&(e.setVerticesData(te.UV6Kind,this.uvs6,i),s&&(yield)),this.colors&&(e.setVerticesData(te.ColorKind,this.colors,i),s&&(yield)),this.matricesIndices&&(e.setVerticesData(te.MatricesIndicesKind,this.matricesIndices,i),s&&(yield)),this.matricesWeights&&(e.setVerticesData(te.MatricesWeightsKind,this.matricesWeights,i),s&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(te.MatricesIndicesExtraKind,this.matricesIndicesExtra,i),s&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(te.MatricesWeightsExtraKind,this.matricesWeightsExtra,i),s&&(yield)),this.indices?(e.setIndices(this.indices,null,i),s&&(yield)):e.setIndices([],null),this}_update(e,i,s){return this.positions&&e.updateVerticesData(te.PositionKind,this.positions,i,s),this.normals&&e.updateVerticesData(te.NormalKind,this.normals,i,s),this.tangents&&e.updateVerticesData(te.TangentKind,this.tangents,i,s),this.uvs&&e.updateVerticesData(te.UVKind,this.uvs,i,s),this.uvs2&&e.updateVerticesData(te.UV2Kind,this.uvs2,i,s),this.uvs3&&e.updateVerticesData(te.UV3Kind,this.uvs3,i,s),this.uvs4&&e.updateVerticesData(te.UV4Kind,this.uvs4,i,s),this.uvs5&&e.updateVerticesData(te.UV5Kind,this.uvs5,i,s),this.uvs6&&e.updateVerticesData(te.UV6Kind,this.uvs6,i,s),this.colors&&e.updateVerticesData(te.ColorKind,this.colors,i,s),this.matricesIndices&&e.updateVerticesData(te.MatricesIndicesKind,this.matricesIndices,i,s),this.matricesWeights&&e.updateVerticesData(te.MatricesWeightsKind,this.matricesWeights,i,s),this.matricesIndicesExtra&&e.updateVerticesData(te.MatricesIndicesExtraKind,this.matricesIndicesExtra,i,s),this.matricesWeightsExtra&&e.updateVerticesData(te.MatricesWeightsExtraKind,this.matricesWeightsExtra,i,s),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,i,s=0,n=e.length){const a=ge.Vector3[0],p=ge.Vector3[1];for(let _=s;_<s+n;_+=3)j.FromArrayToRef(e,_,a),j.TransformCoordinatesToRef(a,i,p),e[_]=p.x,e[_+1]=p.y,e[_+2]=p.z}static _TransformVector3Normals(e,i,s=0,n=e.length){const a=ge.Vector3[0],p=ge.Vector3[1];for(let _=s;_<s+n;_+=3)j.FromArrayToRef(e,_,a),j.TransformNormalToRef(a,i,p),e[_]=p.x,e[_+1]=p.y,e[_+2]=p.z}static _TransformVector4Normals(e,i,s=0,n=e.length){const a=ge.Vector4[0],p=ge.Vector4[1];for(let _=s;_<s+n;_+=4)xr.FromArrayToRef(e,_,a),xr.TransformNormalToRef(a,i,p),e[_]=p.x,e[_+1]=p.y,e[_+2]=p.z,e[_+3]=p.w}static _FlipFaces(e,i=0,s=e.length){for(let n=i;n<i+s;n+=3){const a=e[n+1];e[n+1]=e[n+2],e[n+2]=a}}transform(e){const i=e.determinant()<0;return this.positions&&Mt._TransformVector3Coordinates(this.positions,e),this.normals&&Mt._TransformVector3Normals(this.normals,e),this.tangents&&Mt._TransformVector4Normals(this.tangents,e),i&&this.indices&&Mt._FlipFaces(this.indices),this}merge(e,i=!1,s=!1){const n=Array.isArray(e)?e.map(a=>({vertexData:a})):[{vertexData:e}];return f_(this._mergeCoroutine(void 0,n,i,!1,s))}*_mergeCoroutine(e,i,s=!1,n,a){var p,_,g,y;this._validate();const b=i.map(F=>F.vertexData);for(const F of b)if(F._validate(),!this.normals!=!F.normals||!this.tangents!=!F.tangents||!this.uvs!=!F.uvs||!this.uvs2!=!F.uvs2||!this.uvs3!=!F.uvs3||!this.uvs4!=!F.uvs4||!this.uvs5!=!F.uvs5||!this.uvs6!=!F.uvs6||!this.colors!=!F.colors||!this.matricesIndices!=!F.matricesIndices||!this.matricesWeights!=!F.matricesWeights||!this.matricesIndicesExtra!=!F.matricesIndicesExtra||!this.matricesWeightsExtra!=!F.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes");const v=b.reduce((F,L)=>{var N,k;return F+((k=(N=L.indices)===null||N===void 0?void 0:N.length)!==null&&k!==void 0?k:0)},(_=(p=this.indices)===null||p===void 0?void 0:p.length)!==null&&_!==void 0?_:0);let M=a||b.some(F=>F.indices===this.indices)?(g=this.indices)===null||g===void 0?void 0:g.slice():this.indices;if(v>0){let F=(y=M?.length)!==null&&y!==void 0?y:0;if(M||(M=new Array(v)),M.length!==v){if(Array.isArray(M))M.length=v;else{const N=s||M instanceof Uint32Array?new Uint32Array(v):new Uint16Array(v);N.set(M),M=N}e&&e.determinant()<0&&Mt._FlipFaces(M,0,F)}let L=this.positions?this.positions.length/3:0;for(const{vertexData:N,transform:k}of i)if(N.indices){for(let G=0;G<N.indices.length;G++)M[F+G]=N.indices[G]+L;k&&k.determinant()<0&&Mt._FlipFaces(M,F,N.indices.length),L+=N.positions.length/3,F+=N.indices.length,n&&(yield)}}return this.indices=M,this.positions=Mt._MergeElement(te.PositionKind,this.positions,e,i.map(F=>[F.vertexData.positions,F.transform])),n&&(yield),this.normals=Mt._MergeElement(te.NormalKind,this.normals,e,i.map(F=>[F.vertexData.normals,F.transform])),n&&(yield),this.tangents=Mt._MergeElement(te.TangentKind,this.tangents,e,i.map(F=>[F.vertexData.tangents,F.transform])),n&&(yield),this.uvs=Mt._MergeElement(te.UVKind,this.uvs,e,i.map(F=>[F.vertexData.uvs,F.transform])),n&&(yield),this.uvs2=Mt._MergeElement(te.UV2Kind,this.uvs2,e,i.map(F=>[F.vertexData.uvs2,F.transform])),n&&(yield),this.uvs3=Mt._MergeElement(te.UV3Kind,this.uvs3,e,i.map(F=>[F.vertexData.uvs3,F.transform])),n&&(yield),this.uvs4=Mt._MergeElement(te.UV4Kind,this.uvs4,e,i.map(F=>[F.vertexData.uvs4,F.transform])),n&&(yield),this.uvs5=Mt._MergeElement(te.UV5Kind,this.uvs5,e,i.map(F=>[F.vertexData.uvs5,F.transform])),n&&(yield),this.uvs6=Mt._MergeElement(te.UV6Kind,this.uvs6,e,i.map(F=>[F.vertexData.uvs6,F.transform])),n&&(yield),this.colors=Mt._MergeElement(te.ColorKind,this.colors,e,i.map(F=>[F.vertexData.colors,F.transform])),n&&(yield),this.matricesIndices=Mt._MergeElement(te.MatricesIndicesKind,this.matricesIndices,e,i.map(F=>[F.vertexData.matricesIndices,F.transform])),n&&(yield),this.matricesWeights=Mt._MergeElement(te.MatricesWeightsKind,this.matricesWeights,e,i.map(F=>[F.vertexData.matricesWeights,F.transform])),n&&(yield),this.matricesIndicesExtra=Mt._MergeElement(te.MatricesIndicesExtraKind,this.matricesIndicesExtra,e,i.map(F=>[F.vertexData.matricesIndicesExtra,F.transform])),n&&(yield),this.matricesWeightsExtra=Mt._MergeElement(te.MatricesWeightsExtraKind,this.matricesWeightsExtra,e,i.map(F=>[F.vertexData.matricesWeightsExtra,F.transform])),this}static _MergeElement(e,i,s,n){const a=n.filter(g=>g[0]!==null&&g[0]!==void 0);if(!i&&a.length==0)return i;if(!i)return this._MergeElement(e,a[0][0],a[0][1],a.slice(1));const p=a.reduce((g,y)=>g+y[0].length,i.length),_=e===te.PositionKind?Mt._TransformVector3Coordinates:e===te.NormalKind?Mt._TransformVector3Normals:e===te.TangentKind?Mt._TransformVector4Normals:()=>{};if(i instanceof Float32Array){const g=new Float32Array(p);g.set(i),s&&_(g,s,0,i.length);let y=i.length;for(const[b,v]of a)g.set(b,y),v&&_(g,v,y,b.length),y+=b.length;return g}else{const g=new Array(p);for(let b=0;b<i.length;b++)g[b]=i[b];s&&_(g,s,0,i.length);let y=i.length;for(const[b,v]of a){for(let S=0;S<b.length;S++)g[y+S]=b[S];v&&_(g,v,y,b.length),y+=b.length}return g}}_validate(){if(!this.positions)throw new Wo("Positions are required",_x.MeshInvalidPositionsError);const e=(n,a)=>{const p=te.DeduceStride(n);if(a.length%p!==0)throw new Error("The "+n+"s array count must be a multiple of "+p);return a.length/p},i=e(te.PositionKind,this.positions),s=(n,a)=>{const p=e(n,a);if(p!==i)throw new Error("The "+n+"s element count ("+p+") does not match the positions count ("+i+")")};this.normals&&s(te.NormalKind,this.normals),this.tangents&&s(te.TangentKind,this.tangents),this.uvs&&s(te.UVKind,this.uvs),this.uvs2&&s(te.UV2Kind,this.uvs2),this.uvs3&&s(te.UV3Kind,this.uvs3),this.uvs4&&s(te.UV4Kind,this.uvs4),this.uvs5&&s(te.UV5Kind,this.uvs5),this.uvs6&&s(te.UV6Kind,this.uvs6),this.colors&&s(te.ColorKind,this.colors),this.matricesIndices&&s(te.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&s(te.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&s(te.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&s(te.MatricesWeightsExtraKind,this.matricesWeightsExtra)}serialize(){const e={};return this.positions&&(e.positions=this.positions),this.normals&&(e.normals=this.normals),this.tangents&&(e.tangents=this.tangents),this.uvs&&(e.uvs=this.uvs),this.uvs2&&(e.uvs2=this.uvs2),this.uvs3&&(e.uvs3=this.uvs3),this.uvs4&&(e.uvs4=this.uvs4),this.uvs5&&(e.uvs5=this.uvs5),this.uvs6&&(e.uvs6=this.uvs6),this.colors&&(e.colors=this.colors),this.matricesIndices&&(e.matricesIndices=this.matricesIndices,e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=this.matricesWeights),this.matricesIndicesExtra&&(e.matricesIndicesExtra=this.matricesIndicesExtra,e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=this.matricesWeightsExtra),e.indices=this.indices,e}static ExtractFromMesh(e,i,s){return Mt._ExtractFrom(e,i,s)}static ExtractFromGeometry(e,i,s){return Mt._ExtractFrom(e,i,s)}static _ExtractFrom(e,i,s){const n=new Mt;return e.isVerticesDataPresent(te.PositionKind)&&(n.positions=e.getVerticesData(te.PositionKind,i,s)),e.isVerticesDataPresent(te.NormalKind)&&(n.normals=e.getVerticesData(te.NormalKind,i,s)),e.isVerticesDataPresent(te.TangentKind)&&(n.tangents=e.getVerticesData(te.TangentKind,i,s)),e.isVerticesDataPresent(te.UVKind)&&(n.uvs=e.getVerticesData(te.UVKind,i,s)),e.isVerticesDataPresent(te.UV2Kind)&&(n.uvs2=e.getVerticesData(te.UV2Kind,i,s)),e.isVerticesDataPresent(te.UV3Kind)&&(n.uvs3=e.getVerticesData(te.UV3Kind,i,s)),e.isVerticesDataPresent(te.UV4Kind)&&(n.uvs4=e.getVerticesData(te.UV4Kind,i,s)),e.isVerticesDataPresent(te.UV5Kind)&&(n.uvs5=e.getVerticesData(te.UV5Kind,i,s)),e.isVerticesDataPresent(te.UV6Kind)&&(n.uvs6=e.getVerticesData(te.UV6Kind,i,s)),e.isVerticesDataPresent(te.ColorKind)&&(n.colors=e.getVerticesData(te.ColorKind,i,s)),e.isVerticesDataPresent(te.MatricesIndicesKind)&&(n.matricesIndices=e.getVerticesData(te.MatricesIndicesKind,i,s)),e.isVerticesDataPresent(te.MatricesWeightsKind)&&(n.matricesWeights=e.getVerticesData(te.MatricesWeightsKind,i,s)),e.isVerticesDataPresent(te.MatricesIndicesExtraKind)&&(n.matricesIndicesExtra=e.getVerticesData(te.MatricesIndicesExtraKind,i,s)),e.isVerticesDataPresent(te.MatricesWeightsExtraKind)&&(n.matricesWeightsExtra=e.getVerticesData(te.MatricesWeightsExtraKind,i,s)),n.indices=e.getIndices(i,s),n}static CreateRibbon(e){throw xi("ribbonBuilder")}static CreateBox(e){throw xi("boxBuilder")}static CreateTiledBox(e){throw xi("tiledBoxBuilder")}static CreateTiledPlane(e){throw xi("tiledPlaneBuilder")}static CreateSphere(e){throw xi("sphereBuilder")}static CreateCylinder(e){throw xi("cylinderBuilder")}static CreateTorus(e){throw xi("torusBuilder")}static CreateLineSystem(e){throw xi("linesBuilder")}static CreateDashedLines(e){throw xi("linesBuilder")}static CreateGround(e){throw xi("groundBuilder")}static CreateTiledGround(e){throw xi("groundBuilder")}static CreateGroundFromHeightMap(e){throw xi("groundBuilder")}static CreatePlane(e){throw xi("planeBuilder")}static CreateDisc(e){throw xi("discBuilder")}static CreatePolygon(e,i,s,n,a,p,_){throw xi("polygonBuilder")}static CreateIcoSphere(e){throw xi("icoSphereBuilder")}static CreatePolyhedron(e){throw xi("polyhedronBuilder")}static CreateCapsule(e={orientation:j.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw xi("capsuleBuilder")}static CreateTorusKnot(e){throw xi("torusKnotBuilder")}static ComputeNormals(e,i,s,n){let a=0,p=0,_=0,g=0,y=0,b=0,v=0,S=0,M=0,F=0,L=0,N=0,k=0,G=0,H=0,z=0,W=0,Y=0,Z=0,Q=0,se=!1,$=!1,oe=!1,ue=!1,de=1,ye=0,_e=null;n&&(se=!!n.facetNormals,$=!!n.facetPositions,oe=!!n.facetPartitioning,de=n.useRightHandedSystem===!0?-1:1,ye=n.ratio||0,ue=!!n.depthSort,_e=n.distanceTo,ue&&_e===void 0&&(_e=j.Zero()));let we=0,Pe=0,Ee=0,We=0;for(oe&&n&&n.bbSize&&(we=n.subDiv.X*ye/n.bbSize.x,Pe=n.subDiv.Y*ye/n.bbSize.y,Ee=n.subDiv.Z*ye/n.bbSize.z,We=n.subDiv.max*n.subDiv.max,n.facetPartitioning.length=0),a=0;a<e.length;a++)s[a]=0;const et=i.length/3|0;for(a=0;a<et;a++){if(N=i[a*3]*3,k=N+1,G=N+2,H=i[a*3+1]*3,z=H+1,W=H+2,Y=i[a*3+2]*3,Z=Y+1,Q=Y+2,p=e[N]-e[H],_=e[k]-e[z],g=e[G]-e[W],y=e[Y]-e[H],b=e[Z]-e[z],v=e[Q]-e[W],S=de*(_*v-g*b),M=de*(g*y-p*v),F=de*(p*b-_*y),L=Math.sqrt(S*S+M*M+F*F),L=L===0?1:L,S/=L,M/=L,F/=L,se&&n&&(n.facetNormals[a].x=S,n.facetNormals[a].y=M,n.facetNormals[a].z=F),$&&n&&(n.facetPositions[a].x=(e[N]+e[H]+e[Y])/3,n.facetPositions[a].y=(e[k]+e[z]+e[Z])/3,n.facetPositions[a].z=(e[G]+e[W]+e[Q])/3),oe&&n){const ke=Math.floor((n.facetPositions[a].x-n.bInfo.minimum.x*ye)*we),$e=Math.floor((n.facetPositions[a].y-n.bInfo.minimum.y*ye)*Pe),pt=Math.floor((n.facetPositions[a].z-n.bInfo.minimum.z*ye)*Ee),Xe=Math.floor((e[N]-n.bInfo.minimum.x*ye)*we),Tt=Math.floor((e[k]-n.bInfo.minimum.y*ye)*Pe),fi=Math.floor((e[G]-n.bInfo.minimum.z*ye)*Ee),li=Math.floor((e[H]-n.bInfo.minimum.x*ye)*we),Ot=Math.floor((e[z]-n.bInfo.minimum.y*ye)*Pe),Gt=Math.floor((e[W]-n.bInfo.minimum.z*ye)*Ee),bi=Math.floor((e[Y]-n.bInfo.minimum.x*ye)*we),si=Math.floor((e[Z]-n.bInfo.minimum.y*ye)*Pe),oi=Math.floor((e[Q]-n.bInfo.minimum.z*ye)*Ee),ci=Xe+n.subDiv.max*Tt+We*fi,Li=li+n.subDiv.max*Ot+We*Gt,hi=bi+n.subDiv.max*si+We*oi,mi=ke+n.subDiv.max*$e+We*pt;n.facetPartitioning[mi]=n.facetPartitioning[mi]?n.facetPartitioning[mi]:new Array,n.facetPartitioning[ci]=n.facetPartitioning[ci]?n.facetPartitioning[ci]:new Array,n.facetPartitioning[Li]=n.facetPartitioning[Li]?n.facetPartitioning[Li]:new Array,n.facetPartitioning[hi]=n.facetPartitioning[hi]?n.facetPartitioning[hi]:new Array,n.facetPartitioning[ci].push(a),Li!=ci&&n.facetPartitioning[Li].push(a),hi==Li||hi==ci||n.facetPartitioning[hi].push(a),mi==ci||mi==Li||mi==hi||n.facetPartitioning[mi].push(a)}if(ue&&n&&n.facetPositions){const ke=n.depthSortedFacets[a];ke.ind=a*3,ke.sqDistance=j.DistanceSquared(n.facetPositions[a],_e)}s[N]+=S,s[k]+=M,s[G]+=F,s[H]+=S,s[z]+=M,s[W]+=F,s[Y]+=S,s[Z]+=M,s[Q]+=F}for(a=0;a<s.length/3;a++)S=s[a*3],M=s[a*3+1],F=s[a*3+2],L=Math.sqrt(S*S+M*M+F*F),L=L===0?1:L,S/=L,M/=L,F/=L,s[a*3]=S,s[a*3+1]=M,s[a*3+2]=F}static _ComputeSides(e,i,s,n,a,p,_){const g=s.length,y=n.length;let b,v;switch(e=e||Mt.DEFAULTSIDE,e){case Mt.FRONTSIDE:break;case Mt.BACKSIDE:for(b=0;b<g;b+=3){const S=s[b];s[b]=s[b+2],s[b+2]=S}for(v=0;v<y;v++)n[v]=-n[v];break;case Mt.DOUBLESIDE:{const S=i.length,M=S/3;for(let N=0;N<S;N++)i[S+N]=i[N];for(b=0;b<g;b+=3)s[b+g]=s[b+2]+M,s[b+1+g]=s[b+1]+M,s[b+2+g]=s[b]+M;for(v=0;v<y;v++)n[y+v]=-n[v];const F=a.length;let L=0;for(L=0;L<F;L++)a[L+F]=a[L];for(p=p||new xr(0,0,1,1),_=_||new xr(0,0,1,1),L=0,b=0;b<F/2;b++)a[L]=p.x+(p.z-p.x)*a[L],a[L+1]=p.y+(p.w-p.y)*a[L+1],a[L+F]=_.x+(_.z-_.x)*a[L+F],a[L+F+1]=_.y+(_.w-_.y)*a[L+F+1],L+=2;break}}}static ImportVertexData(e,i){const s=new Mt,n=e.positions;n&&s.set(n,te.PositionKind);const a=e.normals;a&&s.set(a,te.NormalKind);const p=e.tangents;p&&s.set(p,te.TangentKind);const _=e.uvs;_&&s.set(_,te.UVKind);const g=e.uv2s;g&&s.set(g,te.UV2Kind);const y=e.uv3s;y&&s.set(y,te.UV3Kind);const b=e.uv4s;b&&s.set(b,te.UV4Kind);const v=e.uv5s;v&&s.set(v,te.UV5Kind);const S=e.uv6s;S&&s.set(S,te.UV6Kind);const M=e.colors;M&&s.set(pi.CheckColors4(M,n.length/3),te.ColorKind);const F=e.matricesIndices;F&&s.set(F,te.MatricesIndicesKind);const L=e.matricesWeights;L&&s.set(L,te.MatricesWeightsKind);const N=e.indices;N&&(s.indices=N),i.setAllVerticesData(s,e.updatable)}}Mt.FRONTSIDE=0,Mt.BACKSIDE=1,Mt.DOUBLESIDE=2,Mt.DEFAULTSIDE=0,J([bx.filter((...[l])=>!Array.isArray(l))],Mt,"_TransformVector3Coordinates",null),J([bx.filter((...[l])=>!Array.isArray(l))],Mt,"_TransformVector3Normals",null),J([bx.filter((...[l])=>!Array.isArray(l))],Mt,"_TransformVector4Normals",null),J([bx.filter((...[l])=>!Array.isArray(l))],Mt,"_FlipFaces",null);class Jt extends vr{get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._cache.useBillboardPosition=(this._billboardMode&Jt.BILLBOARDMODE_USE_POSITION)!==0,this._computeUseBillboardPath())}get preserveParentRotationForBillboard(){return this._preserveParentRotationForBillboard}set preserveParentRotationForBillboard(e){e!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=e,this._computeUseBillboardPath())}_computeUseBillboardPath(){this._cache.useBillboardPath=this._billboardMode!==Jt.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}constructor(e,i=null,s=!0){super(e,i),this._forward=new j(0,0,1),this._up=new j(0,1,0),this._right=new j(1,0,0),this._position=j.Zero(),this._rotation=j.Zero(),this._rotationQuaternion=null,this._scaling=j.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=Jt.BILLBOARDMODE_NONE,this._preserveParentRotationForBillboard=!1,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=fe.Zero(),this._usePivotMatrix=!1,this._absolutePosition=j.Zero(),this._absoluteScaling=j.Zero(),this._absoluteRotationQuaternion=Ve.Identity(),this._pivotMatrix=fe.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new Re,this._nonUniformScaling=!1,s&&this.getScene().addTransformNode(this)}getClassName(){return"TransformNode"}get position(){return this._position}set position(e){this._position=e,this._isDirty=!0}isUsingPivotMatrix(){return this._usePivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._isDirty=!0}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._isDirty=!0}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._isDirty=!0}get forward(){return j.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return j.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return j.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=fe.Identity()),this._poseMatrix}_isSynchronized(){const e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==Jt.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();const e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1,e.useBillboardPosition=!1,e.useBillboardPath=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,i=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=i,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=fe.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,i,s){const n=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);n&&s&&s(this,n);for(const a of this.getChildTransformNodes(!0))a.instantiateHierarchy(n,i,s);return n}freezeWorldMatrix(e=null,i=!1){return e?i?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||Ve.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let i,s,n;if(e.x===void 0){if(arguments.length<3)return this;i=arguments[0],s=arguments[1],n=arguments[2]}else i=e.x,s=e.y,n=e.z;if(this.parent){const a=ge.Matrix[0];this.parent.getWorldMatrix().invertToRef(a),j.TransformCoordinatesFromFloatsToRef(i,s,n,a,this.position)}else this.position.x=i,this.position.y=s,this.position.z=n;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=j.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();const e=ge.Matrix[0];return this._localMatrix.invertToRef(e),j.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=j.TransformCoordinates(e,this._localMatrix),this}lookAt(e,i=0,s=0,n=0,a=Ki.LOCAL){const p=Jt._LookAtVectorCache,_=a===Ki.LOCAL?this.position:this.getAbsolutePosition();if(e.subtractToRef(_,p),this.setDirection(p,i,s,n),a===Ki.WORLD&&this.parent)if(this.rotationQuaternion){const g=ge.Matrix[0];this.rotationQuaternion.toRotationMatrix(g);const y=ge.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(y),y.invert(),g.multiplyToRef(y,g),this.rotationQuaternion.fromRotationMatrix(g)}else{const g=ge.Quaternion[0];Ve.FromEulerVectorToRef(this.rotation,g);const y=ge.Matrix[0];g.toRotationMatrix(y);const b=ge.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(b),b.invert(),y.multiplyToRef(b,y),g.fromRotationMatrix(y),g.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){const i=j.Zero();return this.getDirectionToRef(e,i),i}getDirectionToRef(e,i){return j.TransformNormalToRef(e,this.getWorldMatrix(),i),this}setDirection(e,i=0,s=0,n=0){const a=-Math.atan2(e.z,e.x)+Math.PI/2,p=Math.sqrt(e.x*e.x+e.z*e.z),_=-Math.atan2(e.y,p);return this.rotationQuaternion?Ve.RotationYawPitchRollToRef(a+i,_+s,n,this.rotationQuaternion):(this.rotation.x=_+s,this.rotation.y=a+i,this.rotation.z=n),this}setPivotPoint(e,i=Ki.LOCAL){this.getScene().getRenderId()==0&&this.computeWorldMatrix(!0);const s=this.getWorldMatrix();if(i==Ki.WORLD){const n=ge.Matrix[0];s.invertToRef(n),e=j.TransformCoordinates(e,n)}return this.setPivotMatrix(fe.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){const e=j.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){const e=j.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),j.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(const i of this._children)i.markAsDirty(e);return super.markAsDirty(e)}setParent(e,i=!1,s=!1){if(!e&&!this.parent)return this;const n=ge.Quaternion[0],a=ge.Vector3[0],p=ge.Vector3[1],_=ge.Matrix[1];fe.IdentityToRef(_);const g=ge.Matrix[0];this.computeWorldMatrix(!0);let y=this.rotationQuaternion;return y||(y=Jt._TmpRotation,Ve.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,y)),fe.ComposeToRef(this.scaling,y,this.position,g),this.parent&&g.multiplyToRef(this.parent.computeWorldMatrix(!0),g),e&&(e.computeWorldMatrix(!0).invertToRef(_),g.multiplyToRef(_,g)),g.decompose(p,n,a,i?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(n):n.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(p),this.position.copyFrom(a),this.parent=e,s&&this.setPivotMatrix(fe.Identity()),this}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling===e?!1:(this._nonUniformScaling=e,!0)}attachToBone(e,i){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=i,this.parent=e,e.getSkeleton().prepare(),e.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,e?this.parent=this._currentParentWhenAttachingToBone:this.parent=null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(e,i,s){e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0));let n;if(!s||s===Ki.LOCAL)n=Ve.RotationAxisToRef(e,i,Jt._RotationAxisCache),this.rotationQuaternion.multiplyToRef(n,this.rotationQuaternion);else{if(this.parent){const a=ge.Matrix[0];this.parent.getWorldMatrix().invertToRef(a),e=j.TransformNormal(e,a)}n=Ve.RotationAxisToRef(e,i,Jt._RotationAxisCache),n.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this}rotateAround(e,i,s){i.normalize(),this.rotationQuaternion||(this.rotationQuaternion=Ve.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));const n=ge.Vector3[0],a=ge.Vector3[1],p=ge.Vector3[2],_=ge.Quaternion[0],g=ge.Matrix[0],y=ge.Matrix[1],b=ge.Matrix[2],v=ge.Matrix[3];return e.subtractToRef(this.position,n),fe.TranslationToRef(n.x,n.y,n.z,g),fe.TranslationToRef(-n.x,-n.y,-n.z,y),fe.RotationAxisToRef(i,s,b),y.multiplyToRef(b,v),v.multiplyToRef(g,v),v.decompose(a,_,p),this.position.addInPlace(p),_.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,i,s){const n=e.scale(i);if(!s||s===Ki.LOCAL){const a=this.getPositionExpressedInLocalSpace().add(n);this.setPositionWithLocalVector(a)}else this.setAbsolutePosition(this.getAbsolutePosition().add(n));return this}addRotation(e,i,s){let n;this.rotationQuaternion?n=this.rotationQuaternion:(n=ge.Quaternion[1],Ve.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,n));const a=ge.Quaternion[0];return Ve.RotationYawPitchRollToRef(i,e,s,a),n.multiplyInPlace(a),this.rotationQuaternion||n.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==Jt.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}computeWorldMatrix(e=!1,i=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;const s=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===s||this.isSynchronized()))return this._currentRenderId=s,this._worldMatrix;i=i||this.getScene().activeCamera,this._updateCache();const n=this._cache;n.pivotMatrixUpdated=!1,n.billboardMode=this.billboardMode,n.infiniteDistance=this.infiniteDistance,n.parent=this._parentNode,this._currentRenderId=s,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;const a=this._getEffectiveParent(),p=Jt._TmpScaling;let _=this._position;if(this._infiniteDistance&&!this.parent&&i){const y=i.getWorldMatrix(),b=new j(y.m[12],y.m[13],y.m[14]);_=Jt._TmpTranslation,_.copyFromFloats(this._position.x+b.x,this._position.y+b.y,this._position.z+b.z)}p.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant);let g;if(this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,g=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(Ve.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(g=Jt._TmpRotation,Ve.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,g)),this._usePivotMatrix){const y=ge.Matrix[1];fe.ScalingToRef(p.x,p.y,p.z,y);const b=ge.Matrix[0];g.toRotationMatrix(b),this._pivotMatrix.multiplyToRef(y,ge.Matrix[4]),ge.Matrix[4].multiplyToRef(b,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(_.x,_.y,_.z)}else fe.ComposeToRef(p,g,_,this._localMatrix);if(a&&a.getWorldMatrix){if(e&&a.computeWorldMatrix(e),n.useBillboardPath){this._transformToBoneReferal?a.getWorldMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),ge.Matrix[7]):ge.Matrix[7].copyFrom(a.getWorldMatrix());const y=ge.Vector3[5],b=ge.Vector3[6],v=ge.Quaternion[0];ge.Matrix[7].decompose(b,v,y),fe.ScalingToRef(b.x,b.y,b.z,ge.Matrix[7]),ge.Matrix[7].setTranslation(y),Jt.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(v,y),this._localMatrix.setTranslation(y)),this._localMatrix.multiplyToRef(ge.Matrix[7],this._worldMatrix)}else this._transformToBoneReferal?(this._localMatrix.multiplyToRef(a.getWorldMatrix(),ge.Matrix[6]),ge.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)):this._localMatrix.multiplyToRef(a.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(n.useBillboardPath&&i&&this.billboardMode&&!n.useBillboardPosition){const y=ge.Vector3[0];if(this._worldMatrix.getTranslationToRef(y),ge.Matrix[1].copyFrom(i.getViewMatrix()),ge.Matrix[1].setTranslationFromFloats(0,0,0),ge.Matrix[1].invertToRef(ge.Matrix[0]),(this.billboardMode&Jt.BILLBOARDMODE_ALL)!==Jt.BILLBOARDMODE_ALL){ge.Matrix[0].decompose(void 0,ge.Quaternion[0],void 0);const b=ge.Vector3[1];ge.Quaternion[0].toEulerAnglesToRef(b),(this.billboardMode&Jt.BILLBOARDMODE_X)!==Jt.BILLBOARDMODE_X&&(b.x=0),(this.billboardMode&Jt.BILLBOARDMODE_Y)!==Jt.BILLBOARDMODE_Y&&(b.y=0),(this.billboardMode&Jt.BILLBOARDMODE_Z)!==Jt.BILLBOARDMODE_Z&&(b.z=0),fe.RotationYawPitchRollToRef(b.y,b.x,b.z,ge.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(ge.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(ge.Vector3[0])}else if(n.useBillboardPath&&i&&n.useBillboardPosition){const y=ge.Vector3[0];this._worldMatrix.getTranslationToRef(y);const b=i.globalPosition;this._worldMatrix.invertToRef(ge.Matrix[1]);const v=ge.Vector3[1];j.TransformCoordinatesToRef(b,ge.Matrix[1],v),v.normalize();const S=-Math.atan2(v.z,v.x)+Math.PI/2,M=Math.sqrt(v.x*v.x+v.z*v.z),F=-Math.atan2(v.y,M);if(Ve.RotationYawPitchRollToRef(S,F,0,ge.Quaternion[0]),(this.billboardMode&Jt.BILLBOARDMODE_ALL)!==Jt.BILLBOARDMODE_ALL){const L=ge.Vector3[1];ge.Quaternion[0].toEulerAnglesToRef(L),(this.billboardMode&Jt.BILLBOARDMODE_X)!==Jt.BILLBOARDMODE_X&&(L.x=0),(this.billboardMode&Jt.BILLBOARDMODE_Y)!==Jt.BILLBOARDMODE_Y&&(L.y=0),(this.billboardMode&Jt.BILLBOARDMODE_Z)!==Jt.BILLBOARDMODE_Z&&(L.z=0),fe.RotationYawPitchRollToRef(L.y,L.x,L.z,ge.Matrix[0])}else fe.FromQuaternionToRef(ge.Quaternion[0],ge.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(ge.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(ge.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):a&&a._nonUniformScaling?this._updateNonUniformScalingState(a._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=fe.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){const i=this.getChildren();for(let s=0;s<i.length;++s){const n=i[s];if(n){n.computeWorldMatrix();const a=ge.Matrix[0];n._localMatrix.multiplyToRef(this._localMatrix,a);const p=ge.Quaternion[0];a.decompose(n.scaling,p,n.position),n.rotationQuaternion?n.rotationQuaternion.copyFrom(p):p.toEulerAnglesToRef(n.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=Ve.Identity()),this._worldMatrix=fe.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),j.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,i,s){const n=Kt.Clone(()=>new Jt(e,this.getScene()),this);if(n.name=e,n.id=e,i&&(n.parent=i),!s){const a=this.getDescendants(!0);for(let p=0;p<a.length;p++){const _=a[p];_.clone&&_.clone(e+"."+_.name,n)}}return n}serialize(e){const i=Kt.Serialize(this,e);return i.type=this.getClassName(),i.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(i),i.localMatrix=this.getPivotMatrix().asArray(),i.isEnabled=this.isEnabled(),i}static Parse(e,i,s){const n=Kt.Parse(()=>new Jt(e.name,i),e,i,s);return e.localMatrix?n.setPreTransformMatrix(fe.FromArray(e.localMatrix)):e.pivotMatrix&&n.setPivotMatrix(fe.FromArray(e.pivotMatrix)),n.setEnabled(e.isEnabled),n._waitingParsedUniqueId=e.uniqueId,e.parentId!==void 0&&(n._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(n._waitingParentInstanceIndex=e.parentInstanceIndex),n}getChildTransformNodes(e,i){const s=[];return this._getDescendants(s,e,n=>(!i||i(n))&&n instanceof Jt),s}dispose(e,i=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){const s=this._parentContainer.transformNodes.indexOf(this);s>-1&&this._parentContainer.transformNodes.splice(s,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){const s=this.getChildTransformNodes(!0);for(const n of s)n.parent=null,n.computeWorldMatrix(!0)}super.dispose(e,i)}normalizeToUnitCube(e=!0,i=!1,s){let n=null,a=null;i&&(this.rotationQuaternion?(a=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(n=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));const p=this.getHierarchyBoundingVectors(e,s),_=p.max.subtract(p.min),g=Math.max(_.x,_.y,_.z);if(g===0)return this;const y=1/g;return this.scaling.scaleInPlace(y),i&&(this.rotationQuaternion&&a?this.rotationQuaternion.copyFrom(a):this.rotation&&n&&this.rotation.copyFrom(n)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}}Jt.BILLBOARDMODE_NONE=0,Jt.BILLBOARDMODE_X=1,Jt.BILLBOARDMODE_Y=2,Jt.BILLBOARDMODE_Z=4,Jt.BILLBOARDMODE_ALL=7,Jt.BILLBOARDMODE_USE_POSITION=128,Jt.BillboardUseParentOrientation=!1,Jt._TmpRotation=Ve.Zero(),Jt._TmpScaling=j.Zero(),Jt._TmpTranslation=j.Zero(),Jt._LookAtVectorCache=new j(0,0,0),Jt._RotationAxisCache=new Ve,J([Rn("position")],Jt.prototype,"_position",void 0),J([Rn("rotation")],Jt.prototype,"_rotation",void 0),J([D9("rotationQuaternion")],Jt.prototype,"_rotationQuaternion",void 0),J([Rn("scaling")],Jt.prototype,"_scaling",void 0),J([xe("billboardMode")],Jt.prototype,"_billboardMode",void 0),J([xe()],Jt.prototype,"scalingDeterminant",void 0),J([xe("infiniteDistance")],Jt.prototype,"_infiniteDistance",void 0),J([xe()],Jt.prototype,"ignoreNonUniformScaling",void 0),J([xe()],Jt.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);const iW=null;function iK(l){return Object.fromEntries(iW.map(e=>[e,l(e)]))}class rK extends null{constructor(e,i,s=1){super(e,i,["image"],{size:"2f",flip:"1f"},`
            precision mediump float;
            varying vec2 coords;
            uniform vec2 size;
            uniform sampler2D image;
            void main() {
                float res = texture2D(image, coords).r;
                for (int x = -`+s+"; x <= "+s+`; x++)
                    for (int y = -`+s+"; y <= "+s+`; y++)
                        res = max(res, texture2D(image, coords + vec2(x, y) / size).r);
                gl_FragColor = vec4(res, res, res, 1.0);
            }`,void 0,!0)}}class rW{get depthStencilTexture(){return this._depthStencilTexture}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get size(){return this.width}get width(){return this._size.width||this._size}get height(){return this._size.height||this._size}get layers(){return this._size.layers||0}get texture(){var e,i;return(i=(e=this._textures)===null||e===void 0?void 0:e[0])!==null&&i!==void 0?i:null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}get samples(){return this._samples}setSamples(e,i=!0,s=!1){if(this.samples===e&&!s)return e;const n=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,i):this._engine.updateRenderTargetTextureSampleCount(this,e);return this._samples=e,n}constructor(e,i,s,n){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this._isMulti=e,this._isCube=i,this._size=s,this._engine=n,this._depthStencilTexture=null}setTextures(e){Array.isArray(e)?this._textures=e:e?this._textures=[e]:this._textures=null}setTexture(e,i=0,s=!0){this._textures||(this._textures=[]),this._textures[i]&&s&&this._textures[i].dispose(),this._textures[i]=e}setLayerAndFaceIndices(e,i){this._layerIndices=e,this._faceIndices=i}setLayerAndFaceIndex(e=0,i,s){this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),i!==void 0&&i>=0&&(this._layerIndices[e]=i),s!==void 0&&s>=0&&(this._faceIndices[e]=s)}createDepthStencilTexture(e=0,i=!0,s=!1,n=1,a=14,p){var _;return(_=this._depthStencilTexture)===null||_===void 0||_.dispose(),this._depthStencilTextureWithStencil=s,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:i,comparisonFunction:e,generateStencil:s,isCube:this._isCube,samples:n,depthTextureFormat:a,label:p},this),this._depthStencilTexture}_shareDepth(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,this._depthStencilTexture.incrementReferences())}_swapAndDie(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){var e,i,s,n,a,p,_,g;let y=null;if(this._isMulti){const b=this.textures;if(b&&b.length>0){let v=!1,S=b.length;const M=b[b.length-1]._source;(M===or.Depth||M===or.DepthStencil)&&(v=!0,S--);const F=[],L=[],N=[],k=[],G=[],H=[],z=[],W={};for(let Q=0;Q<S;++Q){const se=b[Q];F.push(se.samplingMode),L.push(se.type),N.push(se.format),W[se.uniqueId]!==void 0?(k.push(-1),z.push(0)):(W[se.uniqueId]=Q,se.is2DArray?(k.push(35866),z.push(se.depth)):se.isCube?(k.push(34067),z.push(0)):se.is3D?(k.push(32879),z.push(se.depth)):(k.push(3553),z.push(0))),this._faceIndices&&G.push((e=this._faceIndices[Q])!==null&&e!==void 0?e:0),this._layerIndices&&H.push((i=this._layerIndices[Q])!==null&&i!==void 0?i:0)}const Y={samplingModes:F,generateMipMaps:b[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:v,types:L,formats:N,textureCount:S,targetTypes:k,faceIndex:G,layerIndex:H,layerCounts:z},Z={width:this.width,height:this.height};y=this._engine.createMultipleRenderTarget(Z,Y);for(let Q=0;Q<S;++Q){if(k[Q]!==-1)continue;const se=W[b[Q].uniqueId];y.setTexture(y.textures[se],Q)}}}else{const b={};if(b.generateDepthBuffer=this._generateDepthBuffer,b.generateMipMaps=(n=(s=this.texture)===null||s===void 0?void 0:s.generateMipMaps)!==null&&n!==void 0?n:!1,b.generateStencilBuffer=this._generateStencilBuffer,b.samplingMode=(a=this.texture)===null||a===void 0?void 0:a.samplingMode,b.type=(p=this.texture)===null||p===void 0?void 0:p.type,b.format=(_=this.texture)===null||_===void 0?void 0:_.format,this.isCube)y=this._engine.createRenderTargetCubeTexture(this.width,b);else{const v={width:this.width,height:this.height,layers:this.is2DArray?(g=this.texture)===null||g===void 0?void 0:g.depth:void 0};y=this._engine.createRenderTargetTexture(v,b)}y.texture.isReady=!0}return y}_swapRenderTargetWrapper(e){if(this._textures&&e._textures)for(let i=0;i<this._textures.length;++i)this._textures[i]._swapAndDie(e._textures[i],!1),e._textures[i].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const e=this._cloneRenderTargetWrapper();if(!!e){if(this._depthStencilTexture){const i=this._depthStencilTexture.samplingMode,s=i===2||i===3||i===11;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,s,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}}releaseTextures(){var e,i;if(this._textures)for(let s=0;(i=s<((e=this._textures)===null||e===void 0?void 0:e.length))!==null&&i!==void 0&&i;++s)this._textures[s].dispose();this._textures=null}dispose(e=!1){var i;e||((i=this._depthStencilTexture)===null||i===void 0||i.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)}}class sW extends rW{constructor(e,i,s,n,a){super(e,i,s,n),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._context=a}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),e.texture.isReady=!0):e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}_shareDepth(e){super._shareDepth(e);const i=this._context,s=this._depthStencilBuffer,n=e._MSAAFramebuffer||e._framebuffer;e._depthStencilBuffer&&i.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=this._depthStencilBuffer,this._engine._bindUnboundFramebuffer(n),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,s),this._engine._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(e,i=0,s,n=0){var a,p,_,g;if(!e._hardwareTexture)return;const y=this._framebuffer,b=this._engine._currentFramebuffer;if(this._engine._bindUnboundFramebuffer(y),this._engine.webGLVersion>1){const v=this._context,S=v["COLOR_ATTACHMENT"+i];e.is2DArray||e.is3D?(s=(p=s??((a=this.layerIndices)===null||a===void 0?void 0:a[i]))!==null&&p!==void 0?p:0,v.framebufferTextureLayer(v.FRAMEBUFFER,S,e._hardwareTexture.underlyingResource,n,s)):e.isCube?(s=(g=s??((_=this.faceIndices)===null||_===void 0?void 0:_[i]))!==null&&g!==void 0?g:0,v.framebufferTexture2D(v.FRAMEBUFFER,S,v.TEXTURE_CUBE_MAP_POSITIVE_X+s,e._hardwareTexture.underlyingResource,n)):v.framebufferTexture2D(v.FRAMEBUFFER,S,v.TEXTURE_2D,e._hardwareTexture.underlyingResource,n)}else{const v=this._context,S=v["COLOR_ATTACHMENT"+i+"_WEBGL"],M=s!==void 0?v.TEXTURE_CUBE_MAP_POSITIVE_X+s:v.TEXTURE_2D;v.framebufferTexture2D(v.FRAMEBUFFER,S,M,e._hardwareTexture.underlyingResource,n)}this._engine._bindUnboundFramebuffer(b)}setTexture(e,i=0,s=!0){super.setTexture(e,i,s),this._bindTextureRenderTarget(e,i)}setLayerAndFaceIndices(e,i){var s,n;if(super.setLayerAndFaceIndices(e,i),!this.textures||!this.layerIndices||!this.faceIndices)return;const a=(n=(s=this._attachments)===null||s===void 0?void 0:s.length)!==null&&n!==void 0?n:this.textures.length;for(let p=0;p<a;p++){const _=this.textures[p];!_||(_.is2DArray||_.is3D?this._bindTextureRenderTarget(_,p,this.layerIndices[p]):_.isCube?this._bindTextureRenderTarget(_,p,this.faceIndices[p]):this._bindTextureRenderTarget(_,p))}}setLayerAndFaceIndex(e=0,i,s){if(super.setLayerAndFaceIndex(e,i,s),!this.textures||!this.layerIndices||!this.faceIndices)return;const n=this.textures[e];n.is2DArray||n.is3D?this._bindTextureRenderTarget(this.textures[e],e,this.layerIndices[e]):n.isCube&&this._bindTextureRenderTarget(this.textures[e],e,this.faceIndices[e])}dispose(e=!1){const i=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(i.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(i.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(i.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e)}}Yt.prototype._createHardwareRenderTargetWrapper=function(l,e,i){const s=new sW(l,e,i,this,this._gl);return this._renderTargetWrapperCache.push(s),s},Yt.prototype.createRenderTargetTexture=function(l,e){var i,s;const n=this._createHardwareRenderTargetWrapper(!1,!1,l);let a=!0,p=!1,_=!1,g,y=1;e!==void 0&&typeof e=="object"&&(a=(i=e.generateDepthBuffer)!==null&&i!==void 0?i:!0,p=!!e.generateStencilBuffer,_=!!e.noColorAttachment,g=e.colorAttachment,y=(s=e.samples)!==null&&s!==void 0?s:1);const b=g||(_?null:this._createInternalTexture(l,e,!0,or.RenderTarget)),v=l.width||l,S=l.height||l,M=this._currentFramebuffer,F=this._gl,L=F.createFramebuffer();return this._bindUnboundFramebuffer(L),n._depthStencilBuffer=this._setupFramebufferDepthAttachments(p,a,v,S),b&&!b.is2DArray&&F.framebufferTexture2D(F.FRAMEBUFFER,F.COLOR_ATTACHMENT0,F.TEXTURE_2D,b._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(M),n._framebuffer=L,n._generateDepthBuffer=a,n._generateStencilBuffer=p,n.setTextures(b),this.updateRenderTargetTextureSampleCount(n,y),n},Yt.prototype.createDepthStencilTexture=function(l,e,i){if(e.isCube){const s=l.width||l;return this._createDepthStencilCubeTexture(s,e,i)}else return this._createDepthStencilTexture(l,e,i)},Yt.prototype._createDepthStencilTexture=function(l,e,i){const s=this._gl,n=l.layers||0,a=n!==0?s.TEXTURE_2D_ARRAY:s.TEXTURE_2D,p=new Bs(this,or.DepthStencil);if(!this._caps.depthTextureExtension)return Ie.Error("Depth texture is not supported by your browser or hardware."),p;const _={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...e};if(this._bindTextureDirectly(a,p,!0),this._setupDepthStencilTexture(p,l,_.generateStencil,_.comparisonFunction===0?!1:_.bilinearFiltering,_.comparisonFunction,_.samples),_.depthTextureFormat!==void 0){if(_.depthTextureFormat!==15&&_.depthTextureFormat!==16&&_.depthTextureFormat!==17&&_.depthTextureFormat!==13&&_.depthTextureFormat!==14&&_.depthTextureFormat!==18)return Ie.Error("Depth texture format is not supported."),p;p.format=_.depthTextureFormat}else p.format=_.generateStencil?13:16;const g=p.format===17||p.format===13||p.format===18;i._depthStencilTexture=p,i._depthStencilTextureWithStencil=g;let y=s.UNSIGNED_INT;p.format===15?y=s.UNSIGNED_SHORT:p.format===17||p.format===13?y=s.UNSIGNED_INT_24_8:p.format===14?y=s.FLOAT:p.format===18&&(y=s.FLOAT_32_UNSIGNED_INT_24_8_REV);const b=g?s.DEPTH_STENCIL:s.DEPTH_COMPONENT;let v=b;this.webGLVersion>1&&(p.format===15?v=s.DEPTH_COMPONENT16:p.format===16?v=s.DEPTH_COMPONENT24:p.format===17||p.format===13?v=s.DEPTH24_STENCIL8:p.format===14?v=s.DEPTH_COMPONENT32F:p.format===18&&(v=s.DEPTH32F_STENCIL8)),p.is2DArray?s.texImage3D(a,0,v,p.width,p.height,n,0,b,y,null):s.texImage2D(a,0,v,p.width,p.height,0,b,y,null),this._bindTextureDirectly(a,null),this._internalTexturesCache.push(p);const S=i;if(S._depthStencilBuffer){const M=this._currentFramebuffer;this._bindUnboundFramebuffer(S._framebuffer),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,null),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,null),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.STENCIL_ATTACHMENT,s.RENDERBUFFER,null),this._bindUnboundFramebuffer(M),s.deleteRenderbuffer(S._depthStencilBuffer),S._depthStencilBuffer=null}return p},Yt.prototype.updateRenderTargetTextureSampleCount=function(l,e){if(this.webGLVersion<2||!l||!l.texture)return 1;if(l.samples===e)return e;const i=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),l._depthStencilBuffer&&(i.deleteRenderbuffer(l._depthStencilBuffer),l._depthStencilBuffer=null),l._MSAAFramebuffer&&(i.deleteFramebuffer(l._MSAAFramebuffer),l._MSAAFramebuffer=null);const s=l.texture._hardwareTexture;if(s.releaseMSAARenderBuffers(),e>1&&typeof i.renderbufferStorageMultisample=="function"){const n=i.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");l._MSAAFramebuffer=n,this._bindUnboundFramebuffer(l._MSAAFramebuffer);const a=this._createRenderBuffer(l.texture.width,l.texture.height,e,-1,this._getRGBAMultiSampleBufferFormat(l.texture.type),i.COLOR_ATTACHMENT0,!1);if(!a)throw new Error("Unable to create multi sampled framebuffer");s.addMSAARenderBuffer(a)}else this._bindUnboundFramebuffer(l._framebuffer);return l.texture.samples=e,l._samples=e,l._depthStencilBuffer=this._setupFramebufferDepthAttachments(l._generateStencilBuffer,l._generateDepthBuffer,l.texture.width,l.texture.height,e),this._bindUnboundFramebuffer(null),e},Yt.prototype.createRenderTargetCubeTexture=function(l,e){const i=this._createHardwareRenderTargetWrapper(!1,!0,l),s={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...e};s.generateStencilBuffer=s.generateDepthBuffer&&s.generateStencilBuffer,(s.type===1&&!this._caps.textureFloatLinearFiltering||s.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(s.samplingMode=1);const n=this._gl,a=new Bs(this,or.RenderTarget);this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,a,!0);const p=this._getSamplingParameters(s.samplingMode,s.generateMipMaps);s.type===1&&!this._caps.textureFloat&&(s.type=0,Ie.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MAG_FILTER,p.mag),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MIN_FILTER,p.min),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE);for(let g=0;g<6;g++)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+g,0,this._getRGBABufferInternalSizedFormat(s.type,s.format),l,l,0,this._getInternalFormat(s.format),this._getWebGLTextureType(s.type),null);const _=n.createFramebuffer();return this._bindUnboundFramebuffer(_),i._depthStencilBuffer=this._setupFramebufferDepthAttachments(s.generateStencilBuffer,s.generateDepthBuffer,l,l),s.generateMipMaps&&n.generateMipmap(n.TEXTURE_CUBE_MAP),this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),i._framebuffer=_,i._generateDepthBuffer=s.generateDepthBuffer,i._generateStencilBuffer=s.generateStencilBuffer,a.width=l,a.height=l,a.isReady=!0,a.isCube=!0,a.samples=1,a.generateMipMaps=s.generateMipMaps,a.samplingMode=s.samplingMode,a.type=s.type,a.format=s.format,this._internalTexturesCache.push(a),i.setTextures(a),i};const eA="postprocessVertexShader",tA=`attribute vec2 position;
uniform vec2 scale;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd)*scale;
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;Ye.ShadersStore[eA]=tA;const sK={name:eA,shader:tA},p_={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class nW{constructor(e,i=p_){var s,n;this._fullscreenViewport=new Za(0,0,1,1);const a=(s=i.positions)!==null&&s!==void 0?s:p_.positions,p=(n=i.indices)!==null&&n!==void 0?n:p_.indices;this.engine=e,this._vertexBuffers={[te.PositionKind]:new te(e,a,te.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(p),this._onContextRestoredObserver=e.onContextRestoredObservable.add(()=>{this._indexBuffer=e.createIndexBuffer(p);for(const _ in this._vertexBuffers)this._vertexBuffers[_]._rebuild()})}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e._drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}restoreStates(){this.engine.depthCullingState.depthTest=!0,this.engine.stencilState.stencilTest=!0}draw(){this.engine.drawElementsType(0,0,6)}_isRenderTargetTexture(e){return e.renderTarget!==void 0}render(e,i=null){if(!e.effect.isReady())return;this.setViewport();const s=i===null?null:this._isRenderTargetTexture(i)?i.renderTarget:i;s&&this.engine.bindFramebuffer(s),this.applyEffectWrapper(e),this.draw(),s&&this.engine.unBindFramebuffer(s),this.restoreStates()}dispose(){const e=this._vertexBuffers[te.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[te.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class aW{get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){this.onApplyObservable=new Re;let i;const s=e.uniformNames||[];e.vertexShader?i={fragmentSource:e.fragmentShader,vertexSource:e.vertexShader,spectorName:e.name||"effectWrapper"}:(s.push("scale"),i={fragmentSource:e.fragmentShader,vertex:"postprocess",spectorName:e.name||"effectWrapper"},this.onApplyObservable.add(()=>{this.effect.setFloat2("scale",1,1)}));const n=e.defines?e.defines.join(`
`):"";this._drawWrapper=new ul(e.engine),e.useShaderStore?(i.fragment=i.fragmentSource,i.vertex||(i.vertex=i.vertexSource),delete i.fragmentSource,delete i.vertexSource,this.effect=e.engine.createEffect(i,e.attributeNames||["position"],s,e.samplerNames,n,void 0,e.onCompiled,void 0,void 0,e.shaderLanguage)):(this.effect=new ir(i,e.attributeNames||["position"],s,e.samplerNames,e.engine,n,void 0,e.onCompiled,void 0,void 0,void 0,e.shaderLanguage),this._onContextRestoredObserver=e.engine.onContextRestoredObservable.add(()=>{this.effect._pipelineContext=null,this.effect._wasPreviouslyReady=!1,this.effect._prepareEffect()}))}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.effect.dispose()}}const iA="passPixelShader",rA=`varying vec2 vUV;
uniform sampler2D textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
gl_FragColor=texture2D(textureSampler,vUV);
}`;Ye.ShadersStore[iA]=rA;const sA={name:iA,shader:rA};class ln{static _CreateDumpRenderer(){if(!ln._DumpToolsEngine){const e=document.createElement("canvas"),i=new Yt(e,!1,{preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1});i.getCaps().parallelShaderCompile=void 0;const s=new nW(i),n=new aW({engine:i,name:sA.name,fragmentShader:sA.shader,samplerNames:["textureSampler"]});ln._DumpToolsEngine={canvas:e,engine:i,renderer:s,wrapper:n}}return ln._DumpToolsEngine}static async DumpFramebuffer(e,i,s,n,a="image/png",p){const _=await s.readPixels(0,0,e,i),g=new Uint8Array(_.buffer);ln.DumpData(e,i,g,n,a,p,!0)}static DumpDataAsync(e,i,s,n="image/png",a,p=!1,_=!1,g){return new Promise(y=>{ln.DumpData(e,i,s,b=>y(b),n,a,p,_,g)})}static DumpData(e,i,s,n,a="image/png",p,_=!1,g=!1,y){const b=ln._CreateDumpRenderer();if(b.engine.setSize(e,i,!0),s instanceof Float32Array){const S=new Uint8Array(s.length);let M=s.length;for(;M--;){const F=s[M];S[M]=F<0?0:F>1?1:Math.round(F*255)}s=S}const v=b.engine.createRawTexture(s,e,i,5,!1,!_,1);b.renderer.setViewport(),b.renderer.applyEffectWrapper(b.wrapper),b.wrapper.effect._bindTexture("textureSampler",v),b.renderer.draw(),g?Le.ToBlob(b.canvas,S=>{const M=new FileReader;M.onload=F=>{const L=F.target.result;n&&n(L)},M.readAsArrayBuffer(S)},a,y):Le.EncodeScreenshotCanvasData(b.canvas,n,a,p,y),v.dispose()}static Dispose(){ln._DumpToolsEngine&&(ln._DumpToolsEngine.wrapper.dispose(),ln._DumpToolsEngine.renderer.dispose(),ln._DumpToolsEngine.engine.dispose()),ln._DumpToolsEngine=null}}(()=>{Le.DumpData=ln.DumpData,Le.DumpDataAsync=ln.DumpDataAsync,Le.DumpFramebuffer=ln.DumpFramebuffer})();class zn extends Oe{get renderList(){return this._renderList}set renderList(e){this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=yE(e,this._renderListHasChanged)),this._renderList=e}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(e,i){let s;Array.isArray(e)?s=e:s=[e];for(let n=0;n<s.length;++n)for(let a=0;a<this._renderPassIds.length;++a)s[n].setMaterialForRenderPass(this._renderPassIds[a],i!==void 0?Array.isArray(i)?i[a]:i:void 0)}get isMulti(){var e,i;return(i=(e=this._renderTarget)===null||e===void 0?void 0:e.isMulti)!==null&&i!==void 0?i:!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const i=this.getScene();i&&i.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var e,i;return(i=(e=this._renderTarget)===null||e===void 0?void 0:e._depthStencilTexture)!==null&&i!==void 0?i:null}constructor(e,i,s,n=!1,a=!0,p=0,_=!1,g=Oe.TRILINEAR_SAMPLINGMODE,y=!0,b=!1,v=!1,S=5,M=!1,F,L,N=!1,k=!1){var G,H,z,W,Y,Z;let Q;if(typeof n=="object"){const $=n;n=!!$.generateMipMaps,a=(G=$.doNotChangeAspectRatio)!==null&&G!==void 0?G:!0,p=(H=$.type)!==null&&H!==void 0?H:0,_=!!$.isCube,g=(z=$.samplingMode)!==null&&z!==void 0?z:Oe.TRILINEAR_SAMPLINGMODE,y=(W=$.generateDepthBuffer)!==null&&W!==void 0?W:!0,b=!!$.generateStencilBuffer,v=!!$.isMulti,S=(Y=$.format)!==null&&Y!==void 0?Y:5,M=!!$.delayAllocation,F=$.samples,L=$.creationFlags,N=!!$.noColorAttachment,k=!!$.useSRGBBuffer,Q=$.colorAttachment}if(super(null,s,!n,void 0,g,void 0,void 0,void 0,void 0,S),this._unObserveRenderList=null,this._renderListHasChanged=($,oe)=>{var ue;const de=this._renderList?this._renderList.length:0;(oe===0&&de>0||de===0)&&((ue=this.getScene())===null||ue===void 0||ue.meshes.forEach(ye=>{ye._markSubMeshesAsLightDirty()}))},this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new Re,this.onAfterUnbindObservable=new Re,this.onBeforeRenderObservable=new Re,this.onAfterRenderObservable=new Re,this.onClearObservable=new Re,this.onResizeObservable=new Re,this._cleared=!1,this.skipInitialClear=!1,this._currentRefreshId=-1,this._refreshRate=1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this.boundingBoxPosition=j.Zero(),s=this.getScene(),!s)return;const se=this.getScene().getEngine();this._coordinatesMode=Oe.PROJECTION_MODE,this.renderList=new Array,this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=i,this._renderPassIds=[],this._isCubeData=_,this._processSizeParameter(i),this.renderPassId=this._renderPassIds[0],this._resizeObserver=se.onResizeObservable.add(()=>{}),this._generateMipMaps=!!n,this._doNotChangeAspectRatio=a,this._renderingManager=new tn(s),this._renderingManager._useSceneAutoClearSetup=!0,!v&&(this._renderTargetOptions={generateMipMaps:n,type:p,format:(Z=this._format)!==null&&Z!==void 0?Z:void 0,samplingMode:this.samplingMode,generateDepthBuffer:y,generateStencilBuffer:b,samples:F,creationFlags:L,noColorAttachment:N,useSRGBBuffer:k,colorAttachment:Q,label:this.name},this.samplingMode===Oe.NEAREST_SAMPLINGMODE&&(this.wrapU=Oe.CLAMP_ADDRESSMODE,this.wrapV=Oe.CLAMP_ADDRESSMODE),M||(_?(this._renderTarget=s.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=Oe.INVCUBIC_MODE,this._textureMatrix=fe.Identity()):this._renderTarget=s.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,F!==void 0&&(this.samples=F)))}createDepthStencilTexture(e=0,i=!0,s=!1,n=1,a=14){var p;(p=this._renderTarget)===null||p===void 0||p.createDepthStencilTexture(e,i,s,n,a)}_releaseRenderPassId(){if(this._scene){const e=this._scene.getEngine();for(let i=0;i<this._renderPassIds.length;++i)e.releaseRenderPassId(this._renderPassIds[i])}this._renderPassIds=[]}_createRenderPassId(){this._releaseRenderPassId();const e=this._scene.getEngine(),i=this._isCubeData?6:this.getRenderLayers()||1;for(let s=0;s<i;++s)this._renderPassIds[s]=e.createRenderPassId(`RenderTargetTexture - ${this.name}#${s}`)}_processSizeParameter(e){if(e.ratio){this._sizeRatio=e.ratio;const i=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(i.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(i.getRenderHeight(),this._sizeRatio)}}else this._size=e;this._createRenderPassId()}get samples(){var e,i;return(i=(e=this._renderTarget)===null||e===void 0?void 0:e.samples)!==null&&i!==void 0?i:this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}addPostProcess(e){if(!this._postProcessManager){const i=this.getScene();if(!i)return;this._postProcessManager=new r_(i),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}clearPostProcesses(e=!1){if(!!this._postProcesses){if(e)for(const i of this._postProcesses)i.dispose();this._postProcesses=[]}}removePostProcess(e){if(!this._postProcesses)return;const i=this._postProcesses.indexOf(e);i!==-1&&(this._postProcesses.splice(i,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}_shouldRender(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const e=this._size.layers;return e||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(e){const i=Math.max(1,this.getRenderSize()*e);this.resize(i)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){var i;const s=this.isCube;(i=this._renderTarget)===null||i===void 0||i.dispose(),this._renderTarget=null;const n=this.getScene();!n||(this._processSizeParameter(e),s?this._renderTarget=n.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._renderTarget=n.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,this._renderTargetOptions.samples!==void 0&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(e=!1,i=!1){this._render(e,i)}isReadyForRendering(){return this._render(!1,!1,!0)}_render(e=!1,i=!1,s=!1){var n;const a=this.getScene();if(!a)return s;const p=a.getEngine();if(this.useCameraPostProcesses!==void 0&&(e=this.useCameraPostProcesses),this._waitingRenderList){this.renderList=[];for(let v=0;v<this._waitingRenderList.length;v++){const S=this._waitingRenderList[v],M=a.getMeshById(S);M&&this.renderList.push(M)}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const v=this.getScene();if(!v)return s;const S=v.meshes;for(let M=0;M<S.length;M++){const F=S[M];this.renderListPredicate(F)&&this.renderList.push(F)}}const _=p.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);const g=(n=this.activeCamera)!==null&&n!==void 0?n:a.activeCamera,y=a.activeCamera;g&&(g!==a.activeCamera&&(a.setTransformMatrix(g.getViewMatrix(),g.getProjectionMatrix(!0)),a.activeCamera=g),p.setViewport(g.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1;let b=s;if(s){a.getViewMatrix()||a.updateTransformMatrix();const v=this.is2DArray?this.getRenderLayers():this.isCube?6:1;for(let S=0;S<v&&b;S++){let M=null;const F=this.renderList?this.renderList:a.getActiveMeshes().data,L=this.renderList?this.renderList.length:a.getActiveMeshes().length;p.currentRenderPassId=this._renderPassIds[S],this.onBeforeRenderObservable.notifyObservers(S),this.getCustomRenderList&&(M=this.getCustomRenderList(S,F,L)),M||(M=F),this._doNotChangeAspectRatio||a.updateTransformMatrix(!0);for(let N=0;N<M.length&&b;++N){const k=M[N];if(!(!k.isEnabled()||k.isBlocked||!k.isVisible||!k.subMeshes)){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(k,this.refreshRate,s)){b=!1;continue}}else if(!k.isReady(!0)){b=!1;continue}}}this.onAfterRenderObservable.notifyObservers(S),(this.is2DArray||this.isCube)&&(a.incrementRenderId(),a.resetCachedMaterial())}}else if(this.is2DArray&&!this.isMulti)for(let v=0;v<this.getRenderLayers();v++)this._renderToTarget(0,e,i,v,g),a.incrementRenderId(),a.resetCachedMaterial();else if(this.isCube&&!this.isMulti)for(let v=0;v<6;v++)this._renderToTarget(v,e,i,void 0,g),a.incrementRenderId(),a.resetCachedMaterial();else this._renderToTarget(0,e,i,void 0,g);return this.onAfterUnbindObservable.notifyObservers(this),p.currentRenderPassId=_,y&&(a.activeCamera=y,(a.getEngine().scenes.length>1||this.activeCamera&&this.activeCamera!==a.activeCamera)&&a.setTransformMatrix(a.activeCamera.getViewMatrix(),a.activeCamera.getProjectionMatrix(!0)),p.setViewport(a.activeCamera.viewport)),a.resetCachedMaterial(),b}_bestReflectionRenderTargetDimension(e,i){const n=e*i,a=Ae.NearestPOT(n+128*128/(128+n));return Math.min(Ae.FloorPOT(e),a)}_prepareRenderingManager(e,i,s,n){const a=this.getScene();if(!a)return;this._renderingManager.reset();const p=a.getRenderId();for(let _=0;_<i;_++){const g=e[_];if(g&&!g.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(g,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!g.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}if(!g._internalAbstractMeshDataInfo._currentLODIsUpToDate&&a.activeCamera&&(g._internalAbstractMeshDataInfo._currentLOD=a.customLODSelector?a.customLODSelector(g,this.activeCamera||a.activeCamera):g.getLOD(this.activeCamera||a.activeCamera),g._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!g._internalAbstractMeshDataInfo._currentLOD)continue;let y=g._internalAbstractMeshDataInfo._currentLOD;y._preActivateForIntermediateRendering(p);let b;if(n&&s?b=(g.layerMask&s.layerMask)===0:b=!1,g.isEnabled()&&g.isVisible&&g.subMeshes&&!b&&(y!==g&&y._activate(p,!0),g._activate(p,!0)&&g.subMeshes.length)){g.isAnInstance?g._internalAbstractMeshDataInfo._actAsRegularMesh&&(y=g):y._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,y._internalAbstractMeshDataInfo._isActiveIntermediate=!0;for(let v=0;v<y.subMeshes.length;v++){const S=y.subMeshes[v];this._renderingManager.dispatch(S,y)}}}}for(let _=0;_<a.particleSystems.length;_++){const g=a.particleSystems[_],y=g.emitter;!g.isStarted()||!y||y.position&&!y.isEnabled()||this._renderingManager.dispatchParticles(g)}}_bindFrameBuffer(e=0,i=0){const s=this.getScene();if(!s)return;const n=s.getEngine();this._renderTarget&&n.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,i)}_unbindFrameBuffer(e,i){!this._renderTarget||e.unBindFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(i)})}_prepareFrame(e,i,s,n){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!n||!e.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(i,s)}_renderToTarget(e,i,s,n=0,a=null){var p,_,g,y,b,v;const S=this.getScene();if(!S)return;const M=S.getEngine();if((p=M._debugPushGroup)===null||p===void 0||p.call(M,`render to face #${e} layer #${n}`,1),this._prepareFrame(S,e,n,i),this.is2DArray?(M.currentRenderPassId=this._renderPassIds[n],this.onBeforeRenderObservable.notifyObservers(n)):(M.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e)),M.snapshotRendering&&M.snapshotRenderingMode===1)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(M):this.skipInitialClear||M.clear(this.clearColor||S.clearColor,!0,!0,!0);else{let L=null;const N=this.renderList?this.renderList:S.getActiveMeshes().data,k=this.renderList?this.renderList.length:S.getActiveMeshes().length;this.getCustomRenderList&&(L=this.getCustomRenderList(this.is2DArray?n:e,N,k)),L?this._prepareRenderingManager(L,L.length,a,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(N,k,a,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),L=N);for(const H of S._beforeRenderTargetClearStage)H.action(this,e,n);this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(M):this.skipInitialClear||M.clear(this.clearColor||S.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||S.updateTransformMatrix(!0);for(const H of S._beforeRenderTargetDrawStage)H.action(this,e,n);this._renderingManager.render(this.customRenderFunction,L,this.renderParticles,this.renderSprites);for(const H of S._afterRenderTargetDrawStage)H.action(this,e,n);const G=(g=(_=this._texture)===null||_===void 0?void 0:_.generateMipMaps)!==null&&g!==void 0?g:!1;this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,(y=this._renderTarget)!==null&&y!==void 0?y:void 0,e,this._postProcesses,this.ignoreCameraViewport):i&&S.postProcessManager._finalizeFrame(!1,(b=this._renderTarget)!==null&&b!==void 0?b:void 0,e);for(const H of S._afterRenderTargetPostProcessStage)H.action(this,e,n);this._texture&&(this._texture.generateMipMaps=G),this._doNotChangeAspectRatio||S.updateTransformMatrix(!0),s&&ln.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),M)}this._unbindFrameBuffer(M,e),this._texture&&this.isCube&&e===5&&M.generateMipMapsForCubemap(this._texture),(v=M._debugPopGroup)===null||v===void 0||v.call(M,1)}setRenderingOrder(e,i=null,s=null,n=null){this._renderingManager.setRenderingOrder(e,i,s,n)}setRenderingAutoClearDepthStencil(e,i){this._renderingManager.setRenderingAutoClearDepthStencil(e,i),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const e=this.getSize(),i=new zn(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.coordinatesMode=this.coordinatesMode,this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;const e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let i=0;i<this.renderList.length;i++)e.renderList.push(this.renderList[i].id);return e}disposeFramebufferObjects(){var e;(e=this._renderTarget)===null||e===void 0||e.dispose(!0)}releaseInternalTexture(){var e;(e=this._renderTarget)===null||e===void 0||e.releaseTextures(),this._texture=null}dispose(){var e;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._releaseRenderPassId(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;const i=this.getScene();if(!i)return;let s=i.customRenderTargets.indexOf(this);s>=0&&i.customRenderTargets.splice(s,1);for(const n of i.cameras)s=n.customRenderTargets.indexOf(this),s>=0&&n.customRenderTargets.splice(s,1);(e=this._renderTarget)===null||e===void 0||e.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this.refreshRate===zn.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=zn.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}getViewCount(){return 1}}zn.REFRESHRATE_RENDER_ONCE=0,zn.REFRESHRATE_RENDER_ONEVERYFRAME=1,zn.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,Oe._CreateRenderTargetTexture=(l,e,i,s,n)=>new zn(l,e,i,s);class Rc{constructor(){this.previousWorldMatrices={},this.previousBones={}}static AddUniforms(e){e.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(e){}bindForSubMesh(e,i,s,n,a){if(i.prePassRenderer&&i.prePassRenderer.enabled&&i.prePassRenderer.currentRTisSceneRT&&i.prePassRenderer.getIndex(2)!==-1){this.previousWorldMatrices[s.uniqueId]||(this.previousWorldMatrices[s.uniqueId]=n.clone()),this.previousViewProjection||(this.previousViewProjection=i.getTransformMatrix().clone(),this.currentViewProjection=i.getTransformMatrix().clone());const p=i.getEngine();this.currentViewProjection.updateFlag!==i.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=p.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(i.getTransformMatrix())):this._lastUpdateFrameId!==p.frameId&&(this._lastUpdateFrameId=p.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[s.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[s.uniqueId]=n.clone()}}}class qh extends Be{constructor(e,i,s=!0){super(e,i),this._normalMatrix=new fe,this._storeEffectOnSubMeshes=s}getEffect(){return this._storeEffectOnSubMeshes?this._activeEffect:super.getEffect()}isReady(e,i){return e?!this._storeEffectOnSubMeshes||!e.subMeshes||e.subMeshes.length===0?!0:this.isReadyForSubMesh(e,e.subMeshes[0],i):!1}_isReadyForSubMesh(e){const i=e.materialDefines;return!!(!this.checkReadyOnEveryCall&&e.effect&&i&&i._renderId===this.getScene().getRenderId())}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindOnlyNormalMatrix(e){this._activeEffect.setMatrix("normalMatrix",e)}bind(e,i){!i||this.bindForSubMesh(e,i,i.subMeshes[0])}_afterBind(e,i=null){super._afterBind(e,i),this.getScene()._cachedEffect=i,i&&(i._forceRebindOnNextCall=!1)}_mustRebind(e,i,s=1){return e.isCachedMaterialInvalid(this,i,s)}dispose(e,i,s){this._activeEffect=void 0,super.dispose(e,i,s)}}class Ze{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get DecalMapEnabled(){return this._DecalMapEnabled}static set DecalMapEnabled(e){this._DecalMapEnabled!==e&&(this._DecalMapEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,Ae.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set TranslucencyIntensityTextureEnabled(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(e){this._IridescenceTextureEnabled!==e&&(this._IridescenceTextureEnabled=e,Ae.MarkAllMaterialsAsDirty(1))}}Ze._DiffuseTextureEnabled=!0,Ze._DetailTextureEnabled=!0,Ze._DecalMapEnabled=!0,Ze._AmbientTextureEnabled=!0,Ze._OpacityTextureEnabled=!0,Ze._ReflectionTextureEnabled=!0,Ze._EmissiveTextureEnabled=!0,Ze._SpecularTextureEnabled=!0,Ze._BumpTextureEnabled=!0,Ze._LightmapTextureEnabled=!0,Ze._RefractionTextureEnabled=!0,Ze._ColorGradingTextureEnabled=!0,Ze._FresnelEnabled=!0,Ze._ClearCoatTextureEnabled=!0,Ze._ClearCoatBumpTextureEnabled=!0,Ze._ClearCoatTintTextureEnabled=!0,Ze._SheenTextureEnabled=!0,Ze._AnisotropicTextureEnabled=!0,Ze._ThicknessTextureEnabled=!0,Ze._RefractionIntensityTextureEnabled=!0,Ze._TranslucencyIntensityTextureEnabled=!0,Ze._IridescenceTextureEnabled=!0;const nA="decalFragmentDeclaration",aA=`#ifdef DECAL
uniform vec4 vDecalInfos;
#endif
`;Ye.IncludesShadersStore[nA]=aA;const aK={name:nA,shader:aA},oA="defaultFragmentDeclaration",xA=`uniform vec4 vEyePosition;
uniform vec4 vDiffuseColor;
#ifdef SPECULARTERM
uniform vec4 vSpecularColor;
#endif
uniform vec3 vEmissiveColor;
uniform vec3 vAmbientColor;
uniform float visibility;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY 
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform vec2 vTangentSpaceParams;
#endif
#ifdef ALPHATEST
uniform float alphaCutOff;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFRACTION
uniform vec4 vRefractionInfos;
#ifndef REFRACTIONMAP_3D
uniform mat4 refractionMatrix;
#endif
#ifdef REFRACTIONFRESNEL
uniform vec4 refractionLeftColor;
uniform vec4 refractionRightColor;
#endif
#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)
uniform vec3 vRefractionPosition;
uniform vec3 vRefractionSize; 
#endif
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
#endif
#ifdef DIFFUSEFRESNEL
uniform vec4 diffuseLeftColor;
uniform vec4 diffuseRightColor;
#endif
#ifdef OPACITYFRESNEL
uniform vec4 opacityParts;
#endif
#ifdef EMISSIVEFRESNEL
uniform vec4 emissiveLeftColor;
uniform vec4 emissiveRightColor;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)
uniform mat4 reflectionMatrix;
#endif
#ifndef REFLECTIONMAP_SKYBOX
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;
uniform vec3 vReflectionSize; 
#endif
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 reflectionLeftColor;
uniform vec4 reflectionRightColor;
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#define ADDITIONAL_FRAGMENT_DECLARATION
`;Ye.IncludesShadersStore[oA]=xA;const oK={name:oA,shader:xA},lA="sceneUboDeclaration",cA=`layout(std140,column_major) uniform;
uniform Scene {
mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
mat4 view;
mat4 projection;
vec4 vEyePosition;
};
`;Ye.IncludesShadersStore[lA]=cA;const xK={name:lA,shader:cA},hA="meshUboDeclaration",uA=`#ifdef WEBGL2
uniform mat4 world;
uniform float visibility;
#else
layout(std140,column_major) uniform;
uniform Mesh
{
mat4 world;
float visibility;
};
#endif
#define WORLD_UBO
`;Ye.IncludesShadersStore[hA]=uA;const lK={name:hA,shader:uA},dA="defaultUboDeclaration",fA=`layout(std140,column_major) uniform;
uniform Material
{
vec4 diffuseLeftColor;
vec4 diffuseRightColor;
vec4 opacityParts;
vec4 reflectionLeftColor;
vec4 reflectionRightColor;
vec4 refractionLeftColor;
vec4 refractionRightColor;
vec4 emissiveLeftColor;
vec4 emissiveRightColor;
vec2 vDiffuseInfos;
vec2 vAmbientInfos;
vec2 vOpacityInfos;
vec2 vReflectionInfos;
vec3 vReflectionPosition;
vec3 vReflectionSize;
vec2 vEmissiveInfos;
vec2 vLightmapInfos;
vec2 vSpecularInfos;
vec3 vBumpInfos;
mat4 diffuseMatrix;
mat4 ambientMatrix;
mat4 opacityMatrix;
mat4 reflectionMatrix;
mat4 emissiveMatrix;
mat4 lightmapMatrix;
mat4 specularMatrix;
mat4 bumpMatrix;
vec2 vTangentSpaceParams;
float pointSize;
float alphaCutOff;
mat4 refractionMatrix;
vec4 vRefractionInfos;
vec3 vRefractionPosition;
vec3 vRefractionSize;
vec4 vSpecularColor;
vec3 vEmissiveColor;
vec4 vDiffuseColor;
vec3 vAmbientColor;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;Ye.IncludesShadersStore[dA]=fA;const cK={name:dA,shader:fA},pA="prePassDeclaration",mA=`#ifdef PREPASS
#extension GL_EXT_draw_buffers : require
layout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;
#ifdef PREPASS_DEPTH
varying highp vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
varying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;
#endif
#endif
`;Ye.IncludesShadersStore[pA]=mA;const hK={name:pA,shader:mA},_A="oitDeclaration",gA=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
#extension GL_EXT_draw_buffers : require
layout(location=0) out vec2 depth; 
layout(location=1) out vec4 frontColor;
layout(location=2) out vec4 backColor;
#define MAX_DEPTH 99999.0
highp vec4 gl_FragColor;
uniform sampler2D oitDepthSampler;
uniform sampler2D oitFrontColorSampler;
#endif
`;Ye.IncludesShadersStore[_A]=gA;const uK={name:_A,shader:gA},yA="mainUVVaryingDeclaration",bA=`#ifdef MAINUV{X}
varying vec2 vMainUV{X};
#endif
`;Ye.IncludesShadersStore[yA]=bA;const dK={name:yA,shader:bA},vA="lightFragmentDeclaration",TA=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};
uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float cascadeBlendFactor{X};
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
uniform highp sampler2DArray depthSampler{X};
uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
#else
uniform highp sampler2DArray shadowSampler{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);
vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowSampler{X};
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowSampler{X};
uniform highp sampler2D depthSampler{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowSampler{X};
#else
uniform sampler2D shadowSampler{X};
#endif
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};
uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};
uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};
uniform sampler2D projectionLightSampler{X};
#endif
#endif
`;Ye.IncludesShadersStore[vA]=TA;const fK={name:vA,shader:TA},EA="lightUboDeclaration",AA=`#ifdef LIGHT{X}
uniform Light{X}
{
vec4 vLightData;
vec4 vLightDiffuse;
vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;
vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;
vec2 depthValues;
} light{X};
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};
uniform sampler2D projectionLightSampler{X};
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float cascadeBlendFactor{X};
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
uniform highp sampler2DArray depthSampler{X};
uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
#else
uniform highp sampler2DArray shadowSampler{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);
vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowSampler{X}; 
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowSampler{X};
uniform highp sampler2D depthSampler{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowSampler{X};
#else
uniform sampler2D shadowSampler{X};
#endif
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;Ye.IncludesShadersStore[EA]=AA;const pK={name:EA,shader:AA},CA="lightsFragmentFunctions",RA=`struct lightingInfo
{
vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef NDOTL
float ndl;
#endif
};
lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {
lightingInfo result;
vec3 lightVectorW;
float attenuation=1.0;
if (lightData.w==0.)
{
vec3 direction=lightData.xyz-vPositionW;
attenuation=max(0.,1.0-length(direction)/range);
lightVectorW=normalize(direction);
}
else
{
lightVectorW=normalize(-lightData.xyz);
}
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor*attenuation;
#endif
return result;
}
lightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {
lightingInfo result;
vec3 direction=lightData.xyz-vPositionW;
vec3 lightVectorW=normalize(direction);
float attenuation=max(0.,1.0-length(direction)/range);
float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));
if (cosAngle>=lightDirection.w)
{
cosAngle=max(0.,pow(cosAngle,lightData.w));
attenuation*=cosAngle;
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor*attenuation;
#endif
return result;
}
result.diffuse=vec3(0.);
#ifdef SPECULARTERM
result.specular=vec3(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;
}
lightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {
lightingInfo result;
float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightData.xyz);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor;
#endif
return result;
}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){
vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);
strq/=strq.w;
vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;
return textureColor;
}`;Ye.IncludesShadersStore[CA]=RA;const mK={name:CA,shader:RA},IA="shadowsFragmentFunctions",SA=`#ifdef SHADOWS
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
#ifndef SHADOWFLOAT
float unpack(vec4 color)
{
const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);
return dot(color,bit_shift);
}
#endif
float computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)
{
float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));
return mix(value,1.0,mask);
}
#define inline
float computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
depth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadow=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadow=textureCube(shadowSampler,directionToLight).x;
#endif
return depth>shadow ? darkness : 1.0;
}
#define inline
float computeShadowWithPoissonSamplingCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
depth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
float visibility=1.;
vec3 poissonDisk[4];
poissonDisk[0]=vec3(-1.0,1.0,-1.0);
poissonDisk[1]=vec3(1.0,-1.0,-1.0);
poissonDisk[2]=vec3(-1.0,-1.0,-1.0);
poissonDisk[3]=vec3(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;
#else
if (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;
#endif
return min(1.0,visibility+darkness);
}
#define inline
float computeShadowWithESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
float shadowPixelDepth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness); 
return esm;
}
#define inline
float computeShadowWithCloseESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
float shadowPixelDepth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);
return esm;
}
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define inline
float computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
vec3 uvLayer=vec3(uv.x,uv.y,layer);
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(texture2D(shadowSampler,uvLayer));
#else
float shadow=texture2D(shadowSampler,uvLayer).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;
}
#endif
#define inline
float computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;
}
}
#define inline
float computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
float visibility=1.;
vec2 poissonDisk[4];
poissonDisk[0]=vec2(-0.94201624,-0.39906216);
poissonDisk[1]=vec2(0.94558609,-0.76890725);
poissonDisk[2]=vec2(-0.094184101,-0.92938870);
poissonDisk[3]=vec2(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
#else
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);
return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);
return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);
}
}
#ifdef IS_NDC_HALF_ZRANGE
#define ZINCLIP clipSpace.z
#else
#define ZINCLIP uvDepth.z
#endif
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define GREATEST_LESS_THAN_ONE 0.99999994
#define inline
float computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);
float shadow=texture2D(shadowSampler,uvDepthLayer);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;
vec2 uvw1=1.+2.*st;
vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;
vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));
shadow=shadow/16.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;
vec2 uvw1=vec2(7.);
vec2 uvw2=1.+3.*st;
vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;
vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));
shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));
shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));
shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));
shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));
shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));
shadow=shadow/144.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
float shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;
vec2 uvw1=1.+2.*st;
vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;
vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);
shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);
shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);
shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);
shadow=shadow/16.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;
vec2 uvw1=vec2(7.);
vec2 uvw2=1.+3.*st;
vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;
vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);
shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);
shadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);
shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);
shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);
shadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);
shadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);
shadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);
shadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);
shadow=shadow/144.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
const vec3 PoissonSamplers32[64]=vec3[64](
vec3(0.06407013,0.05409927,0.),
vec3(0.7366577,0.5789394,0.),
vec3(-0.6270542,-0.5320278,0.),
vec3(-0.4096107,0.8411095,0.),
vec3(0.6849564,-0.4990818,0.),
vec3(-0.874181,-0.04579735,0.),
vec3(0.9989998,0.0009880066,0.),
vec3(-0.004920578,-0.9151649,0.),
vec3(0.1805763,0.9747483,0.),
vec3(-0.2138451,0.2635818,0.),
vec3(0.109845,0.3884785,0.),
vec3(0.06876755,-0.3581074,0.),
vec3(0.374073,-0.7661266,0.),
vec3(0.3079132,-0.1216763,0.),
vec3(-0.3794335,-0.8271583,0.),
vec3(-0.203878,-0.07715034,0.),
vec3(0.5912697,0.1469799,0.),
vec3(-0.88069,0.3031784,0.),
vec3(0.5040108,0.8283722,0.),
vec3(-0.5844124,0.5494877,0.),
vec3(0.6017799,-0.1726654,0.),
vec3(-0.5554981,0.1559997,0.),
vec3(-0.3016369,-0.3900928,0.),
vec3(-0.5550632,-0.1723762,0.),
vec3(0.925029,0.2995041,0.),
vec3(-0.2473137,0.5538505,0.),
vec3(0.9183037,-0.2862392,0.),
vec3(0.2469421,0.6718712,0.),
vec3(0.3916397,-0.4328209,0.),
vec3(-0.03576927,-0.6220032,0.),
vec3(-0.04661255,0.7995201,0.),
vec3(0.4402924,0.3640312,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.)
);
const vec3 PoissonSamplers64[64]=vec3[64](
vec3(-0.613392,0.617481,0.),
vec3(0.170019,-0.040254,0.),
vec3(-0.299417,0.791925,0.),
vec3(0.645680,0.493210,0.),
vec3(-0.651784,0.717887,0.),
vec3(0.421003,0.027070,0.),
vec3(-0.817194,-0.271096,0.),
vec3(-0.705374,-0.668203,0.),
vec3(0.977050,-0.108615,0.),
vec3(0.063326,0.142369,0.),
vec3(0.203528,0.214331,0.),
vec3(-0.667531,0.326090,0.),
vec3(-0.098422,-0.295755,0.),
vec3(-0.885922,0.215369,0.),
vec3(0.566637,0.605213,0.),
vec3(0.039766,-0.396100,0.),
vec3(0.751946,0.453352,0.),
vec3(0.078707,-0.715323,0.),
vec3(-0.075838,-0.529344,0.),
vec3(0.724479,-0.580798,0.),
vec3(0.222999,-0.215125,0.),
vec3(-0.467574,-0.405438,0.),
vec3(-0.248268,-0.814753,0.),
vec3(0.354411,-0.887570,0.),
vec3(0.175817,0.382366,0.),
vec3(0.487472,-0.063082,0.),
vec3(-0.084078,0.898312,0.),
vec3(0.488876,-0.783441,0.),
vec3(0.470016,0.217933,0.),
vec3(-0.696890,-0.549791,0.),
vec3(-0.149693,0.605762,0.),
vec3(0.034211,0.979980,0.),
vec3(0.503098,-0.308878,0.),
vec3(-0.016205,-0.872921,0.),
vec3(0.385784,-0.393902,0.),
vec3(-0.146886,-0.859249,0.),
vec3(0.643361,0.164098,0.),
vec3(0.634388,-0.049471,0.),
vec3(-0.688894,0.007843,0.),
vec3(0.464034,-0.188818,0.),
vec3(-0.440840,0.137486,0.),
vec3(0.364483,0.511704,0.),
vec3(0.034028,0.325968,0.),
vec3(0.099094,-0.308023,0.),
vec3(0.693960,-0.366253,0.),
vec3(0.678884,-0.204688,0.),
vec3(0.001801,0.780328,0.),
vec3(0.145177,-0.898984,0.),
vec3(0.062655,-0.611866,0.),
vec3(0.315226,-0.604297,0.),
vec3(-0.780145,0.486251,0.),
vec3(-0.371868,0.882138,0.),
vec3(0.200476,0.494430,0.),
vec3(-0.494552,-0.711051,0.),
vec3(0.612476,0.705252,0.),
vec3(-0.578845,-0.768792,0.),
vec3(-0.772454,-0.090976,0.),
vec3(0.504440,0.372295,0.),
vec3(0.155736,0.065157,0.),
vec3(0.391522,0.849605,0.),
vec3(-0.620106,-0.328104,0.),
vec3(0.789239,-0.419965,0.),
vec3(-0.545396,0.538133,0.),
vec3(-0.178564,-0.596057,0.)
);
#define inline
float computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);
float blockerDepth=0.0;
float sumBlockerDepth=0.0;
float numBlocker=0.0;
for (int i=0; i<searchTapCount; i ++) {
blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;
if (blockerDepth<depthMetric) {
sumBlockerDepth+=blockerDepth;
numBlocker++;
}
}
float avgBlockerDepth=sumBlockerDepth/numBlocker;
float AAOffset=shadowMapSizeInverse*10.;
float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);
vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);
float random=getRand(vPositionFromLight.xy);
float rotationAngle=random*3.1415926;
vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));
float shadow=0.;
for (int i=0; i<pcfTapCount; i++) {
vec4 offset=vec4(poissonSamplers[i],0.);
offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);
shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);
}
shadow/=float(pcfTapCount);
shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));
shadow=mix(darkness,1.,shadow);
if (numBlocker<1.0) {
return 1.0;
}
else
{
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
float blockerDepth=0.0;
float sumBlockerDepth=0.0;
float numBlocker=0.0;
for (int i=0; i<searchTapCount; i ++) {
blockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;
if (blockerDepth<depthMetric) {
sumBlockerDepth+=blockerDepth;
numBlocker++;
}
}
if (numBlocker<1.0) {
return 1.0;
}
else
{
float avgBlockerDepth=sumBlockerDepth/numBlocker;
float AAOffset=shadowMapSizeInverse*10.;
float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);
float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;
float random=getRand(vPositionFromLight.xy);
float rotationAngle=random*3.1415926;
vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));
float shadow=0.;
for (int i=0; i<pcfTapCount; i++) {
vec3 offset=poissonSamplers[i];
offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);
shadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);
}
shadow/=float(pcfTapCount);
shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
}
#define inline
float computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);
}
#define inline
float computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);
}
#define inline
float computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);
}
#define inline
float computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#define inline
float computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#define inline
float computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#endif
#endif
`;Ye.IncludesShadersStore[IA]=SA;const _K={name:IA,shader:SA},MA="samplerFragmentDeclaration",PA=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
uniform sampler2D _SAMPLERNAME_Sampler;
#endif
`;Ye.IncludesShadersStore[MA]=PA;const gK={name:MA,shader:PA},OA="fresnelFunction",wA=`#ifdef FRESNEL
float computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)
{
float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);
return clamp(fresnelTerm,0.,1.);
}
#endif
`;Ye.IncludesShadersStore[OA]=wA;const yK={name:OA,shader:wA},DA="reflectionFunction",FA=`vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{
float lon=atan(direction.z,direction.x);
float lat=acos(direction.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(s,t,0); 
}
vec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{
float lon=atan(direction.z,direction.x);
float lat=acos(direction.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(1.0-s,t,0); 
}
vec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);
vec3 r=normalize(reflect(cameraToVertex,worldNormal));
r=vec3(reflectionMatrix*vec4(r,0));
float lon=atan(r.z,r.x);
float lat=acos(r.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(s,t,0);
}
vec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)
{
vec3 viewDir=normalize(vec3(view*worldPos));
vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));
vec3 r=reflect(viewDir,viewNormal);
r=vec3(reflectionMatrix*vec4(r,0));
r.z=r.z-1.0;
float m=2.0*length(r);
return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);
}
vec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 viewDir=worldPos.xyz-eyePosition;
vec3 coords=normalize(reflect(viewDir,worldNormal));
return vec3(reflectionMatrix*vec4(coords,1));
}
vec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 viewDir=normalize(worldPos.xyz-eyePosition);
vec3 coords=reflect(viewDir,worldNormal);
coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;
}
vec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)
{
vec3 viewDir=normalize(worldPos.xyz-eyePosition);
vec3 coords=reflect(viewDir,worldNormal);
coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);
coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;
}
vec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)
{
return vec3(reflectionMatrix*(view*worldPos));
}
vec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)
{
return vec3(reflectionMatrix*vec4(positionW,1.));
}
#ifdef REFLECTION
vec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);
return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);
return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(vPositionUVW,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3(0,0,0);
#endif
}
#endif
`;Ye.IncludesShadersStore[DA]=FA;const bK={name:DA,shader:FA},LA="imageProcessingDeclaration",NA=`#ifdef EXPOSURE
uniform float exposureLinear;
#endif
#ifdef CONTRAST
uniform float contrast;
#endif
#if defined(VIGNETTE) || defined(DITHER)
uniform vec2 vInverseScreenSize;
#endif
#ifdef VIGNETTE
uniform vec4 vignetteSettings1;
uniform vec4 vignetteSettings2;
#endif
#ifdef COLORCURVES
uniform vec4 vCameraColorCurveNegative;
uniform vec4 vCameraColorCurveNeutral;
uniform vec4 vCameraColorCurvePositive;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
uniform highp sampler3D txColorTransform;
#else
uniform sampler2D txColorTransform;
#endif
uniform vec4 colorTransformSettings;
#endif
#ifdef DITHER
uniform float ditherIntensity;
#endif
`;Ye.IncludesShadersStore[LA]=NA;const vK={name:LA,shader:NA},BA="imageProcessingFunctions",kA=`#if defined(COLORGRADING) && !defined(COLORGRADING3D)
/** 
* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.
* sampler3dSetting.x=textureOffset (0.5/textureSize).
* sampler3dSetting.y=textureSize.
*/
#define inline
vec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)
{
float sliceSize=2.0*sampler3dSetting.x; 
#ifdef SAMPLER3DGREENDEPTH
float sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;
#else
float sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;
#endif
float sliceInteger=floor(sliceContinuous);
float sliceFraction=sliceContinuous-sliceInteger;
#ifdef SAMPLER3DGREENDEPTH
vec2 sliceUV=color.rb;
#else
vec2 sliceUV=color.rg;
#endif
sliceUV.x*=sliceSize;
sliceUV.x+=sliceInteger*sliceSize;
sliceUV=saturate(sliceUV);
vec4 slice0Color=texture2D(colorTransform,sliceUV);
sliceUV.x+=sliceSize;
sliceUV=saturate(sliceUV);
vec4 slice1Color=texture2D(colorTransform,sliceUV);
vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);
#ifdef SAMPLER3DBGRMAP
color.rgb=result.rgb;
#else
color.rgb=result.bgr;
#endif
return color;
}
#endif
#ifdef TONEMAPPING_ACES
const mat3 ACESInputMat=mat3(
vec3(0.59719,0.07600,0.02840),
vec3(0.35458,0.90834,0.13383),
vec3(0.04823,0.01566,0.83777)
);
const mat3 ACESOutputMat=mat3(
vec3( 1.60475,-0.10208,-0.00327),
vec3(-0.53108, 1.10813,-0.07276),
vec3(-0.07367,-0.00605, 1.07602)
);
vec3 RRTAndODTFit(vec3 v)
{
vec3 a=v*(v+0.0245786)-0.000090537;
vec3 b=v*(0.983729*v+0.4329510)+0.238081;
return a/b;
}
vec3 ACESFitted(vec3 color)
{
color=ACESInputMat*color;
color=RRTAndODTFit(color);
color=ACESOutputMat*color;
color=saturate(color);
return color;
}
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS
vec4 applyImageProcessing(vec4 result) {
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART
#ifdef EXPOSURE
result.rgb*=exposureLinear;
#endif
#ifdef VIGNETTE
vec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;
viewportXY=viewportXY*2.0-1.0;
vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);
float vignetteTerm=dot(vignetteXY1,vignetteXY1);
float vignette=pow(vignetteTerm,vignetteSettings2.w);
vec3 vignetteColor=vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
vec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);
result.rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
result.rgb=mix(vignetteColor,result.rgb,vignette);
#endif
#endif
#ifdef TONEMAPPING
#ifdef TONEMAPPING_ACES
result.rgb=ACESFitted(result.rgb);
#else
const float tonemappingCalibration=1.590579;
result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);
#endif
#endif
result.rgb=toGammaSpace(result.rgb);
result.rgb=saturate(result.rgb);
#ifdef CONTRAST
vec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);
if (contrast<1.0) {
result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);
} else {
result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);
}
#endif
#ifdef COLORGRADING
vec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;
#ifdef COLORGRADING3D
vec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;
#else
vec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;
#endif
result.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);
#endif
#ifdef COLORCURVES
float luma=getLuminance(result.rgb);
vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));
vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;
result.rgb*=colorCurve.rgb;
result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);
#endif
#ifdef DITHER
float rand=getRand(gl_FragCoord.xy*vInverseScreenSize);
float dither=mix(-ditherIntensity,ditherIntensity,rand);
result.rgb=saturate(result.rgb+vec3(dither));
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND
return result;
}`;Ye.IncludesShadersStore[BA]=kA;const TK={name:BA,shader:kA},UA="bumpFragmentMainFunctions",VA=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform mat4 normalMatrix;
#if defined(WEBGL2) || defined(WEBGPU)
mat4 toNormalMatrix(mat4 wMatrix)
{
mat4 ret=inverse(wMatrix);
ret=transpose(ret);
ret[0][3]=0.;
ret[1][3]=0.;
ret[2][3]=0.;
ret[3]=vec4(0.,0.,0.,1.);
return ret;
}
#else
mat4 toNormalMatrix(mat4 m)
{
float
a00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],
a10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],
a20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],
a30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],
b00=a00*a11-a01*a10,
b01=a00*a12-a02*a10,
b02=a00*a13-a03*a10,
b03=a01*a12-a02*a11,
b04=a01*a13-a03*a11,
b05=a02*a13-a03*a12,
b06=a20*a31-a21*a30,
b07=a20*a32-a22*a30,
b08=a20*a33-a23*a30,
b09=a21*a32-a22*a31,
b10=a21*a33-a23*a31,
b11=a22*a33-a23*a32,
det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;
mat4 mi=mat4(
a11*b11-a12*b10+a13*b09,
a02*b10-a01*b11-a03*b09,
a31*b05-a32*b04+a33*b03,
a22*b04-a21*b05-a23*b03,
a12*b08-a10*b11-a13*b07,
a00*b11-a02*b08+a03*b07,
a32*b02-a30*b05-a33*b01,
a20*b05-a22*b02+a23*b01,
a10*b10-a11*b08+a13*b06,
a01*b08-a00*b10-a03*b06,
a30*b04-a31*b02+a33*b00,
a21*b02-a20*b04-a23*b00,
a11*b07-a10*b09-a12*b06,
a00*b09-a01*b07+a02*b06,
a31*b01-a30*b03-a32*b00,
a20*b03-a21*b01+a22*b00)/det;
return mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);
}
#endif
#endif
vec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)
{
#ifdef NORMALXYSCALE
normal=normalize(normal*vec3(scale,scale,1.0));
#endif
return normalize(cotangentFrame*normal);
}
vec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)
{
return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);
}
mat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)
{
vec3 dp1=dFdx(p);
vec3 dp2=dFdy(p);
vec2 duv1=dFdx(uv);
vec2 duv2=dFdy(uv);
vec3 dp2perp=cross(dp2,normal);
vec3 dp1perp=cross(normal,dp1);
vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;
vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;
tangent*=tangentSpaceParams.x;
bitangent*=tangentSpaceParams.y;
float det=max(dot(tangent,tangent),dot(bitangent,bitangent));
float invmax=det==0.0 ? 0.0 : inversesqrt(det);
return mat3(tangent*invmax,bitangent*invmax,normal);
}
#endif
`;Ye.IncludesShadersStore[UA]=VA;const EK={name:UA,shader:VA},GA="bumpFragmentFunctions",WA=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const float minSamples=4.;
const float maxSamples=15.;
const int iMaxSamples=15;
vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {
float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;
parallaxLimit*=parallaxScale;
vec2 vOffsetDir=normalize(vViewDirCoT.xy);
vec2 vMaxOffset=vOffsetDir*parallaxLimit;
float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));
float stepSize=1.0/numSamples;
float currRayHeight=1.0;
vec2 vCurrOffset=vec2(0,0);
vec2 vLastOffset=vec2(0,0);
float lastSampledHeight=1.0;
float currSampledHeight=1.0;
bool keepWorking=true;
for (int i=0; i<iMaxSamples; i++)
{
currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;
if (!keepWorking)
{
}
else if (currSampledHeight>currRayHeight)
{
float delta1=currSampledHeight-currRayHeight;
float delta2=(currRayHeight+stepSize)-lastSampledHeight;
float ratio=delta1/(delta1+delta2);
vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;
keepWorking=false;
}
else
{
currRayHeight-=stepSize;
vLastOffset=vCurrOffset;
vCurrOffset+=stepSize*vMaxOffset;
lastSampledHeight=currSampledHeight;
}
}
return vCurrOffset;
}
vec2 parallaxOffset(vec3 viewDir,float heightScale)
{
float height=texture2D(bumpSampler,vBumpUV).w;
vec2 texCoordOffset=heightScale*viewDir.xy*height;
return -texCoordOffset;
}
#endif
`;Ye.IncludesShadersStore[GA]=WA;const AK={name:GA,shader:WA},zA="clipPlaneFragmentDeclaration",HA=`#ifdef CLIPPLANE
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
varying float fClipDistance6;
#endif
`;Ye.IncludesShadersStore[zA]=HA;const CK={name:zA,shader:HA},XA="logDepthDeclaration",YA=`#ifdef LOGARITHMICDEPTH
uniform float logarithmicDepthConstant;
varying float vFragmentDepth;
#endif
`;Ye.IncludesShadersStore[XA]=YA;const RK={name:XA,shader:YA},KA="fogFragmentDeclaration",jA=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
#define E 2.71828
uniform vec4 vFogInfos;
uniform vec3 vFogColor;
varying vec3 vFogDistance;
float CalcFogFactor()
{
float fogCoeff=1.0;
float fogStart=vFogInfos.y;
float fogEnd=vFogInfos.z;
float fogDensity=vFogInfos.w;
float fogDistance=length(vFogDistance);
if (FOGMODE_LINEAR==vFogInfos.x)
{
fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);
}
else if (FOGMODE_EXP==vFogInfos.x)
{
fogCoeff=1.0/pow(E,fogDistance*fogDensity);
}
else if (FOGMODE_EXP2==vFogInfos.x)
{
fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);
}
return clamp(fogCoeff,0.0,1.0);
}
#endif
`;Ye.IncludesShadersStore[KA]=jA;const IK={name:KA,shader:jA},qA="clipPlaneFragment",ZA=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fClipDistance>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE2
else if (fClipDistance2>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE3
else if (fClipDistance3>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE4
else if (fClipDistance4>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE5
else if (fClipDistance5>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE6
else if (fClipDistance6>0.0)
{
discard;
}
#endif
`;Ye.IncludesShadersStore[qA]=ZA;const SK={name:qA,shader:ZA},QA="bumpFragment",$A=`vec2 uvOffset=vec2(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
float normalScale=1.0;
#elif defined(BUMP)
float normalScale=vBumpInfos.y;
#else
float normalScale=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#elif defined(BUMP)
vec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;
mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);
#else
vec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;
mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#else
vec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;
mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));
#endif
#endif
#ifdef PARALLAX
mat3 invTBN=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
vec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);
vec2 detailNormalRG=detailColor.wy*2.0-1.0;
float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));
vec3 detailNormal=vec3(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);
normalW=normalize(mat3(normalMatrix)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);
#else
vec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal.xy*=vDetailInfos.z;
vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal.xy*=vDetailInfos.z;
bumpNormal+=vec3(0.0,0.0,1.0);
detailNormal*=vec3(-1.0,-1.0,1.0);
vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal.xy*=vDetailInfos.z;
normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);
#endif
`;Ye.IncludesShadersStore[QA]=$A;const MK={name:QA,shader:$A},JA="decalFragment",eC=`#ifdef DECAL
#ifdef GAMMADECAL
decalColor.rgb=toLinearSpace(decalColor.rgb);
#endif
#ifdef DECAL_SMOOTHALPHA
decalColor.a*=decalColor.a;
#endif
surfaceAlbedo.rgb=mix(surfaceAlbedo.rgb,decalColor.rgb,decalColor.a);
#endif
`;Ye.IncludesShadersStore[JA]=eC;const PK={name:JA,shader:eC},tC="depthPrePass",iC=`#ifdef DEPTHPREPASS
gl_FragColor=vec4(0.,0.,0.,1.0);
return;
#endif
`;Ye.IncludesShadersStore[tC]=iC;const OK={name:tC,shader:iC},rC="lightFragment",sC=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
#ifdef PBR
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#ifdef HEMILIGHT{X}
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb,light{X}.vLightGround);
#elif defined(SS_TRANSLUCENCY)
info.diffuse=computeDiffuseAndTransmittedLighting(preInfo,light{X}.vLightDiffuse.rgb,subSurfaceOut.transmittance);
#else
info.diffuse=computeDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb);
#endif
#ifdef SPECULARTERM
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light{X}.vLightDiffuse.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);
info.diffuse*=absorption;
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightSampler{X},textureProjectionMatrix{X});
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) 
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;
#else
diff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {
index{X}=i;
break;
}
}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
float frustumLength=frustumLengths{X}[index{X}];
float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};
if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{
index{X}+=1;
float nextShadow=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;
shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else 
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;Ye.IncludesShadersStore[rC]=sC;const wK={name:rC,shader:sC},nC="logDepthFragment",aC=`#ifdef LOGARITHMICDEPTH
gl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;
#endif
`;Ye.IncludesShadersStore[nC]=aC;const DK={name:nC,shader:aC},oC="fogFragment",xC=`#ifdef FOG
float fog=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color.rgb=mix(vFogColor,color.rgb,fog);
#endif
`;Ye.IncludesShadersStore[oC]=xC;const FK={name:oC,shader:xC},lC="oitFragment",cC=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
float fragDepth=gl_FragCoord.z; 
#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS
uint halfFloat=packHalf2x16(vec2(fragDepth));
vec2 full=unpackHalf2x16(halfFloat);
fragDepth=full.x;
#endif
ivec2 fragCoord=ivec2(gl_FragCoord.xy);
vec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;
vec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);
depth.rg=vec2(-MAX_DEPTH);
frontColor=lastFrontColor;
backColor=vec4(0.0);
#ifdef USE_REVERSE_DEPTHBUFFER
float furthestDepth=-lastDepth.x;
float nearestDepth=lastDepth.y;
#else
float nearestDepth=-lastDepth.x;
float furthestDepth=lastDepth.y;
#endif
float alphaMultiplier=1.0-lastFrontColor.a;
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth>nearestDepth || fragDepth<furthestDepth) {
#else
if (fragDepth<nearestDepth || fragDepth>furthestDepth) {
#endif
return;
}
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth<nearestDepth && fragDepth>furthestDepth) {
#else
if (fragDepth>nearestDepth && fragDepth<furthestDepth) {
#endif
depth.rg=vec2(-fragDepth,fragDepth);
return;
}
#endif
`;Ye.IncludesShadersStore[lC]=cC;const LK={name:lC,shader:cC},hC="defaultPixelShader",uC=`#include<__decl__defaultFragment>
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#define RECIPROCAL_PI2 0.15915494
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#include<helperFunctions>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef REFRACTION
#ifdef REFRACTIONMAP_3D
uniform samplerCube refractionCubeSampler;
#else
uniform sampler2D refraction2DSampler;
#endif
#endif
#if defined(SPECULARTERM)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)
#endif
#include<fresnelFunction>
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
uniform samplerCube reflectionCubeSampler;
#else
uniform sampler2D reflection2DSampler;
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#include<imageProcessingDeclaration>
#include<imageProcessingFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
vec4 baseColor=vec4(1.,1.,1.,1.);
vec3 diffuseColor=vDiffuseColor.rgb;
float alpha=vDiffuseColor.a;
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));
#endif
#include<bumpFragment>
#ifdef TWOSIDEDLIGHTING
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
#ifdef DIFFUSE
baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);
#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)
if (baseColor.a<alphaCutOff)
discard;
#endif
#ifdef ALPHAFROMDIFFUSE
alpha*=baseColor.a;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
baseColor.rgb*=vDiffuseInfos.y;
#endif
#ifdef DECAL
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#include<depthPrePass>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
baseColor.rgb*=vColor.rgb;
#endif
#ifdef DETAIL
baseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);
#endif
#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE
vec3 baseAmbientColor=vec3(1.,1.,1.);
#ifdef AMBIENT
baseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;
#endif
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
#ifdef SPECULARTERM
float glossiness=vSpecularColor.a;
vec3 specularColor=vSpecularColor.rgb;
#ifdef SPECULAR
vec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);
specularColor=specularMapColor.rgb;
#ifdef GLOSSINESS
glossiness=glossiness*specularMapColor.a;
#endif
#endif
#else
float glossiness=0.;
#endif
vec3 diffuseBase=vec3(0.,0.,0.);
lightingInfo info;
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
float shadow=1.;
#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
#include<lightFragment>[0..maxSimultaneousLights]
vec4 refractionColor=vec4(0.,0.,0.,1.);
#ifdef REFRACTION
vec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));
#ifdef REFRACTIONMAP_3D
#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;
vec4 refractionLookup=textureCube(refractionCubeSampler,refractionVector);
if (dot(refractionVector,viewDirectionW)<1.0) {
refractionColor=refractionLookup;
}
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;
refractionCoords.y=1.0-refractionCoords.y;
refractionColor=texture2D(refraction2DSampler,refractionCoords);
#endif
#ifdef RGBDREFRACTION
refractionColor.rgb=fromRGBD(refractionColor);
#endif
#ifdef IS_REFRACTION_LINEAR
refractionColor.rgb=toGammaSpace(refractionColor.rgb);
#endif
refractionColor.rgb*=vRefractionInfos.x;
#endif
vec4 reflectionColor=vec4(0.,0.,0.,1.);
#ifdef REFLECTION
vec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
vReflectionUVW.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
#ifdef ROUGHNESS
float bias=vReflectionInfos.y;
#ifdef SPECULARTERM
#ifdef SPECULAR
#ifdef GLOSSINESS
bias*=(1.0-specularMapColor.a);
#endif
#endif
#endif
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);
#else
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);
#endif
#else
vec2 coords=vReflectionUVW.xy;
#ifdef REFLECTIONMAP_PROJECTION
coords/=vReflectionUVW.z;
#endif
coords.y=1.0-coords.y;
reflectionColor=texture2D(reflection2DSampler,coords);
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef IS_REFLECTION_LINEAR
reflectionColor.rgb=toGammaSpace(reflectionColor.rgb);
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#ifdef REFLECTIONFRESNEL
float reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);
#ifdef REFLECTIONFRESNELFROMSPECULAR
#ifdef SPECULARTERM
reflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#endif
#endif
#ifdef REFRACTIONFRESNEL
float refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);
refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#ifdef OPACITYRGB
opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);
alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;
#else
alpha*=opacityMap.a*vOpacityInfos.y;
#endif
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#ifdef OPACITYFRESNEL
float opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);
alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;
#endif
#ifdef ALPHATEST
#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS
if (alpha<alphaCutOff)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
vec3 emissiveColor=vEmissiveColor;
#ifdef EMISSIVE
emissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;
#endif
#ifdef EMISSIVEFRESNEL
float emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);
emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;
#endif
#ifdef DIFFUSEFRESNEL
float diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);
diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;
#endif
#ifdef EMISSIVEASILLUMINATION
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
#ifdef LINKEMISSIVEWITHDIFFUSE
vec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#endif
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase*specularColor;
#ifdef SPECULAROVERALPHA
alpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#else
vec3 finalSpecular=vec3(0.0);
#endif
#ifdef REFLECTIONOVERALPHA
alpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#ifdef EMISSIVEASILLUMINATION
vec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);
#else
vec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);
#endif
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
color.rgb*=lightmapColor.rgb;
#else
color.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
color.rgb=max(color.rgb,0.);
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
color.rgb=toLinearSpace(color.rgb);
#else
#ifdef IMAGEPROCESSING
color.rgb=toLinearSpace(color.rgb);
color=applyImageProcessing(color);
#endif
#endif
color.a*=visibility;
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;
gl_FragData[0]=color; 
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;
vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;
vec2 velocity=abs(a-b);
velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;
gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_NORMAL
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(SPECULARTERM)
#if defined(SPECULAR)
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularMapColor))*writeGeometryInfo; 
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularColor),1.0)*writeGeometryInfo;
#endif
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,1.0)*writeGeometryInfo;
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=color;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {
frontColor.rgb+=color.rgb*color.a*alphaMultiplier;
frontColor.a=1.0-alphaMultiplier*(1.0-color.a);
} else {
backColor+=color;
}
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}
`;Ye.ShadersStore[hC]=uC;const NK={name:hC,shader:uC},dC="decalVertexDeclaration",fC=`#ifdef DECAL
uniform vec4 vDecalInfos;
uniform mat4 decalMatrix;
#endif
`;Ye.IncludesShadersStore[dC]=fC;const BK={name:dC,shader:fC},pC="defaultVertexDeclaration",mC=`uniform mat4 viewProjection;
uniform mat4 view;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
uniform mat4 lightmapMatrix;
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
uniform mat4 specularMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform mat4 bumpMatrix;
#endif
#ifdef REFLECTION
uniform mat4 reflectionMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;Ye.IncludesShadersStore[pC]=mC;const kK={name:pC,shader:mC},_C="uvAttributeDeclaration",gC=`#ifdef UV{X}
attribute vec2 uv{X};
#endif
`;Ye.IncludesShadersStore[_C]=gC;const UK={name:_C,shader:gC},yC="bonesDeclaration",bC=`#if NUM_BONE_INFLUENCERS>0
attribute vec4 matricesIndices;
attribute vec4 matricesWeights;
#if NUM_BONE_INFLUENCERS>4
attribute vec4 matricesIndicesExtra;
attribute vec4 matricesWeightsExtra;
#endif
#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#ifdef BONETEXTURE
uniform sampler2D boneSampler;
uniform float boneTextureWidth;
#else
uniform mat4 mBones[BonesPerMesh];
#ifdef BONES_VELOCITY_ENABLED
uniform mat4 mPreviousBones[BonesPerMesh];
#endif
#endif
#ifdef BONETEXTURE
#define inline
mat4 readMatrixFromRawSampler(sampler2D smp,float index)
{
float offset=index *4.0;
float dx=1.0/boneTextureWidth;
vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));
vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));
vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));
vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));
return mat4(m0,m1,m2,m3);
}
#endif
#endif
#endif
`;Ye.IncludesShadersStore[yC]=bC;const VK={name:yC,shader:bC},vC="bakedVertexAnimationDeclaration",TC=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
uniform float bakedVertexAnimationTime;
uniform vec2 bakedVertexAnimationTextureSizeInverted;
uniform vec4 bakedVertexAnimationSettings;
uniform sampler2D bakedVertexAnimationTexture;
#ifdef INSTANCES
attribute vec4 bakedVertexAnimationSettingsInstanced;
#endif
#define inline
mat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)
{
float offset=index*4.0;
float frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;
float dx=bakedVertexAnimationTextureSizeInverted.x;
vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));
vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));
vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));
vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));
return mat4(m0,m1,m2,m3);
}
#endif
`;Ye.IncludesShadersStore[vC]=TC;const GK={name:vC,shader:TC},EC="instancesDeclaration",AC=`#ifdef INSTANCES
attribute vec4 world0;
attribute vec4 world1;
attribute vec4 world2;
attribute vec4 world3;
#ifdef INSTANCESCOLOR
attribute vec4 instanceColor;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
attribute vec4 previousWorld0;
attribute vec4 previousWorld1;
attribute vec4 previousWorld2;
attribute vec4 previousWorld3;
#ifdef THIN_INSTANCES
uniform mat4 previousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
uniform mat4 previousWorld;
#endif
#endif
`;Ye.IncludesShadersStore[EC]=AC;const WK={name:EC,shader:AC},CC="prePassVertexDeclaration",RC=`#ifdef PREPASS
#ifdef PREPASS_DEPTH
varying vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
uniform mat4 previousViewProjection;
varying vec4 vCurrentPosition;
varying vec4 vPreviousPosition;
#endif
#endif
`;Ye.IncludesShadersStore[CC]=RC;const zK={name:CC,shader:RC},IC="samplerVertexDeclaration",SC=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
varying vec2 v_VARYINGNAME_UV;
#endif
`;Ye.IncludesShadersStore[IC]=SC;const HK={name:IC,shader:SC},MC="bumpVertexDeclaration",PC=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#endif
`;Ye.IncludesShadersStore[MC]=PC;const XK={name:MC,shader:PC},OC="clipPlaneVertexDeclaration",wC=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;
varying float fClipDistance6;
#endif
`;Ye.IncludesShadersStore[OC]=wC;const YK={name:OC,shader:wC},DC="fogVertexDeclaration",FC=`#ifdef FOG
varying vec3 vFogDistance;
#endif
`;Ye.IncludesShadersStore[DC]=FC;const KK={name:DC,shader:FC},LC="lightVxFragmentDeclaration",NC=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};
uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};
uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};
uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#endif
`;Ye.IncludesShadersStore[LC]=NC;const jK={name:LC,shader:NC},BC="lightVxUboDeclaration",kC=`#ifdef LIGHT{X}
uniform Light{X}
{
vec4 vLightData;
vec4 vLightDiffuse;
vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;
vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;
vec2 depthValues;
} light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;Ye.IncludesShadersStore[BC]=kC;const qK={name:BC,shader:kC},UC="morphTargetsVertexGlobalDeclaration",VC=`#ifdef MORPHTARGETS
uniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];
#ifdef MORPHTARGETS_TEXTURE 
precision mediump sampler2DArray; 
uniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];
uniform vec3 morphTargetTextureInfo;
uniform sampler2DArray morphTargets;
vec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)
{ 
float y=floor(vertexIndex/morphTargetTextureInfo.y);
float x=vertexIndex-y*morphTargetTextureInfo.y;
vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);
return texture(morphTargets,textureUV).xyz;
}
#endif
#endif
`;Ye.IncludesShadersStore[UC]=VC;const ZK={name:UC,shader:VC},GC="morphTargetsVertexDeclaration",WC=`#ifdef MORPHTARGETS
#ifndef MORPHTARGETS_TEXTURE
attribute vec3 position{X};
#ifdef MORPHTARGETS_NORMAL
attribute vec3 normal{X};
#endif
#ifdef MORPHTARGETS_TANGENT
attribute vec3 tangent{X};
#endif
#ifdef MORPHTARGETS_UV
attribute vec2 uv_{X};
#endif
#endif
#endif
`;Ye.IncludesShadersStore[GC]=WC;const QK={name:GC,shader:WC},zC="morphTargetsVertexGlobal",HC=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
float vertexID;
#endif
#endif
`;Ye.IncludesShadersStore[zC]=HC;const $K={name:zC,shader:HC},XC="morphTargetsVertex",YC=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE 
vertexID=float(gl_VertexID)*morphTargetTextureInfo.x;
positionUpdated+=(readVector3FromRawSampler({X},vertexID)-position)*morphTargetInfluences[{X}];
vertexID+=1.0;
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(readVector3FromRawSampler({X},vertexID) -normal)*morphTargetInfluences[{X}];
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(readVector3FromRawSampler({X},vertexID).xy-uv)*morphTargetInfluences[{X}];
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*morphTargetInfluences[{X}];
#endif
#else
positionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];
#endif
#endif
#endif
`;Ye.IncludesShadersStore[XC]=YC;const JK={name:XC,shader:YC},KC="instancesVertex",jC=`#ifdef INSTANCES
mat4 finalWorld=mat4(world0,world1,world2,world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,previousWorld2,previousWorld3);
#endif
#ifdef THIN_INSTANCES
finalWorld=world*finalWorld;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
finalPreviousWorld=previousWorld*finalPreviousWorld;
#endif
#endif
#else
mat4 finalWorld=world;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=previousWorld;
#endif
#endif
`;Ye.IncludesShadersStore[KC]=jC;const ej={name:KC,shader:jC},qC="bonesVertex",ZC=`#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#if NUM_BONE_INFLUENCERS>0
mat4 influence;
#ifdef BONETEXTURE
influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];
#endif
#else
influence=mBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=mBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=mBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=mBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
#endif
finalWorld=finalWorld*influence;
#endif
#endif
`;Ye.IncludesShadersStore[qC]=ZC;const tj={name:qC,shader:ZC},QC="bakedVertexAnimation",$C=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
{
#ifdef INSTANCES
#define BVASNAME bakedVertexAnimationSettingsInstanced
#else
#define BVASNAME bakedVertexAnimationSettings
#endif
float VATStartFrame=BVASNAME.x;
float VATEndFrame=BVASNAME.y;
float VATOffsetFrame=BVASNAME.z;
float VATSpeed=BVASNAME.w;
float totalFrames=VATEndFrame-VATStartFrame+1.0;
float time=bakedVertexAnimationTime*VATSpeed/totalFrames;
float frameCorrection=time<1.0 ? 0.0 : 1.0;
float numOfFrames=totalFrames-frameCorrection;
float VATFrameNum=fract(time)*numOfFrames;
VATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);
VATFrameNum=floor(VATFrameNum);
VATFrameNum+=VATStartFrame+frameCorrection;
mat4 VATInfluence;
VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];
#endif
finalWorld=finalWorld*VATInfluence;
}
#endif
`;Ye.IncludesShadersStore[QC]=$C;const ij={name:QC,shader:$C},JC="prePassVertex",e1=`#ifdef PREPASS_DEPTH
vViewPos=(view*worldPos).rgb;
#endif
#if defined(PREPASS_VELOCITY) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*worldPos;
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;
previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
`;Ye.IncludesShadersStore[JC]=e1;const rj={name:JC,shader:e1},t1="uvVariableDeclaration",i1=`#if !defined(UV{X}) && defined(MAINUV{X})
vec2 uv{X}=vec2(0.,0.);
#endif
#ifdef MAINUV{X}
vMainUV{X}=uv{X};
#endif
`;Ye.IncludesShadersStore[t1]=i1;const sj={name:t1,shader:i1},r1="samplerVertexImplementation",s1=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
if (v_INFONAME_==0.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));
}
#ifdef UV2
else if (v_INFONAME_==1.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2,1.0,0.0));
}
#endif
#ifdef UV3
else if (v_INFONAME_==2.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));
}
#endif
#ifdef UV4
else if (v_INFONAME_==3.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));
}
#endif
#ifdef UV5
else if (v_INFONAME_==4.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));
}
#endif
#ifdef UV6
else if (v_INFONAME_==5.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));
}
#endif
#endif
`;Ye.IncludesShadersStore[r1]=s1;const nj={name:r1,shader:s1},n1="bumpVertex",a1=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
vec3 tbnNormal=normalize(normalUpdated);
vec3 tbnTangent=normalize(tangentUpdated.xyz);
vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;
vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);
#endif
#endif
`;Ye.IncludesShadersStore[n1]=a1;const aj={name:n1,shader:a1},o1="clipPlaneVertex",x1=`#ifdef CLIPPLANE
fClipDistance=dot(worldPos,vClipPlane);
#endif
#ifdef CLIPPLANE2
fClipDistance2=dot(worldPos,vClipPlane2);
#endif
#ifdef CLIPPLANE3
fClipDistance3=dot(worldPos,vClipPlane3);
#endif
#ifdef CLIPPLANE4
fClipDistance4=dot(worldPos,vClipPlane4);
#endif
#ifdef CLIPPLANE5
fClipDistance5=dot(worldPos,vClipPlane5);
#endif
#ifdef CLIPPLANE6
fClipDistance6=dot(worldPos,vClipPlane6);
#endif
`;Ye.IncludesShadersStore[o1]=x1;const oj={name:o1,shader:x1},l1="fogVertex",c1=`#ifdef FOG
vFogDistance=(view*worldPos).xyz;
#endif
`;Ye.IncludesShadersStore[l1]=c1;const xj={name:l1,shader:c1},h1="shadowsVertex",u1=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vPositionFromCamera{X}=view*worldPos;
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {
vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
}
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vPositionFromLight{X}=lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;Ye.IncludesShadersStore[h1]=u1;const lj={name:h1,shader:u1},d1="vertexColorMixing",f1=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
vColor=vec4(1.0);
#ifdef VERTEXCOLOR
#ifdef VERTEXALPHA
vColor*=color;
#else
vColor.rgb*=color.rgb;
#endif
#endif
#ifdef INSTANCESCOLOR
vColor*=instanceColor;
#endif
#endif
`;Ye.IncludesShadersStore[d1]=f1;const cj={name:d1,shader:f1},p1="pointCloudVertex",m1=`#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
`;Ye.IncludesShadersStore[p1]=m1;const hj={name:p1,shader:m1},_1="logDepthVertex",g1=`#ifdef LOGARITHMICDEPTH
vFragmentDepth=1.0+gl_Position.w;
gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;
#endif
`;Ye.IncludesShadersStore[_1]=g1;const uj={name:_1,shader:g1},y1="defaultVertexShader",b1=`#include<__decl__defaultVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<mainUVVaryingDeclaration>[1..7]
#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#if defined(SPECULARTERM)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)
#endif
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));
vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
vPositionW=vec3(worldPos);
#include<prePassVertex>
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#if defined(SPECULARTERM)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)
#endif
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<pointCloudVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;Ye.ShadersStore[y1]=b1;const dj={name:y1,shader:b1};class Zh{constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}unBindMesh(){this._mesh=null}addFallback(e,i){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(i)}addCPUSkinningFallback(e,i){this._mesh=i,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(e,i){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),i._bonesComputationForcedToCPU=!0;const s=this._mesh.getScene();for(let n=0;n<s.meshes.length;n++){const a=s.meshes[n];if(!a.material){!this._mesh.material&&a.computeBonesUsingShaders&&a.numBoneInfluencers>0&&(a.computeBonesUsingShaders=!1);continue}if(!(!a.computeBonesUsingShaders||a.numBoneInfluencers===0)){if(a.material.getEffect()===i)a.computeBonesUsingShaders=!1;else if(a.subMeshes){for(const p of a.subMeshes)if(p.effect===i){a.computeBonesUsingShaders=!1;break}}}}}else{const s=this._defines[this._currentRank];if(s)for(let n=0;n<s.length;n++)e=e.replace("#define "+s[n],"");this._currentRank++}return e}}const oW=new RegExp("^([gimus]+)!");class vx{constructor(e){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=e,this._scene=e.getScene(),this._engine=this._scene.getEngine()}_addPlugin(e){for(let n=0;n<this._plugins.length;++n)if(this._plugins[n].name===e.name)throw`Plugin "${e.name}" already added to the material "${this._material.name}"!`;if(this._material._uniformBufferLayoutBuilt)throw`The plugin "${e.name}" can't be added to the material "${this._material.name}" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.`;const i=e.getClassName();vx._MaterialPluginClassToMainDefine[i]||(vx._MaterialPluginClassToMainDefine[i]="MATERIALPLUGIN_"+ ++vx._MaterialPluginCounter),this._material._callbackPluginEventGeneric=this._handlePluginEvent.bind(this),this._plugins.push(e),this._plugins.sort((n,a)=>n.priority-a.priority),this._codeInjectionPoints={};const s={};s[vx._MaterialPluginClassToMainDefine[i]]={type:"boolean",default:!0};for(const n of this._plugins)n.collectDefines(s),this._collectPointNames("vertex",n.getCustomCode("vertex")),this._collectPointNames("fragment",n.getCustomCode("fragment"));this._defineNamesFromPlugins=s}_activatePlugin(e){this._activePlugins.indexOf(e)===-1&&(this._activePlugins.push(e),this._activePlugins.sort((i,s)=>i.priority-s.priority),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort((i,s)=>i.priority-s.priority),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}getPlugin(e){for(let i=0;i<this._plugins.length;++i)if(this._plugins[i].name===e)return this._plugins[i];return null}_handlePluginEventIsReadyForSubMesh(e){let i=!0;for(const s of this._activePlugins)i=i&&s.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh);e.isReadyForSubMesh=i}_handlePluginEventPrepareDefinesBeforeAttributes(e){for(const i of this._activePlugins)i.prepareDefinesBeforeAttributes(e.defines,this._scene,e.mesh)}_handlePluginEventPrepareDefines(e){for(const i of this._activePlugins)i.prepareDefines(e.defines,this._scene,e.mesh)}_handlePluginEventHardBindForSubMesh(e){for(const i of this._activePluginsForExtraEvents)i.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventBindForSubMesh(e){for(const i of this._activePlugins)i.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventHasRenderTargetTextures(e){let i=!1;for(const s of this._activePluginsForExtraEvents)if(i=s.hasRenderTargetTextures(),i)break;e.hasRenderTargetTextures=i}_handlePluginEventFillRenderTargetTextures(e){for(const i of this._activePluginsForExtraEvents)i.fillRenderTargetTextures(e.renderTargets)}_handlePluginEvent(e,i){var s;switch(e){case ws.GetActiveTextures:{const n=i;for(const a of this._activePlugins)a.getActiveTextures(n.activeTextures);break}case ws.GetAnimatables:{const n=i;for(const a of this._activePlugins)a.getAnimatables(n.animatables);break}case ws.HasTexture:{const n=i;let a=!1;for(const p of this._activePlugins)if(a=p.hasTexture(n.texture),a)break;n.hasTexture=a;break}case ws.Disposed:{const n=i;for(const a of this._plugins)a.dispose(n.forceDisposeTextures);break}case ws.GetDefineNames:{const n=i;n.defineNames=this._defineNamesFromPlugins;break}case ws.PrepareEffect:{const n=i;for(const a of this._activePlugins)n.fallbackRank=a.addFallbacks(n.defines,n.fallbacks,n.fallbackRank),a.getAttributes(n.attributes,this._scene,n.mesh);this._uniformList.length>0&&n.uniforms.push(...this._uniformList),this._samplerList.length>0&&n.samplers.push(...this._samplerList),this._uboList.length>0&&n.uniformBuffersNames.push(...this._uboList),n.customCode=this._injectCustomCode(n.customCode);break}case ws.PrepareUniformBuffer:{const n=i;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];for(const a of this._plugins){const p=a.getUniforms();if(p){if(p.ubo)for(const _ of p.ubo){if(_.size&&_.type){const g=(s=_.arraySize)!==null&&s!==void 0?s:0;n.ubo.addUniform(_.name,_.size,g),this._uboDeclaration+=`${_.type} ${_.name}${g>0?`[${g}]`:""};\r
`}this._uniformList.push(_.name)}p.vertex&&(this._vertexDeclaration+=p.vertex+`\r
`),p.fragment&&(this._fragmentDeclaration+=p.fragment+`\r
`)}a.getSamplers(this._samplerList),a.getUniformBuffersNames(this._uboList)}break}}}_collectPointNames(e,i){if(!!i)for(const s in i)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][s]=!0}_injectCustomCode(e){return(i,s)=>{var n;e&&(s=e(i,s)),this._uboDeclaration&&(s=s.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(s=s.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(s=s.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));const a=(n=this._codeInjectionPoints)===null||n===void 0?void 0:n[i];if(!a)return s;for(let p in a){let _="";for(const g of this._activePlugins){const y=g.getCustomCode(i);y?.[p]&&(_+=y[p]+`\r
`)}if(_.length>0)if(p.charAt(0)==="!"){p=p.substring(1);let g="g";if(p.charAt(0)==="!")g="",p=p.substring(1);else{const S=oW.exec(p);S&&S.length>=2&&(g=S[1],p=p.substring(g.length+1))}g.indexOf("g")<0&&(g+="g");const y=s,b=new RegExp(p,g);let v=b.exec(y);for(;v!==null;){let S=_;for(let M=0;M<v.length;++M)S=S.replace("$"+M,v[M]);s=s.replace(v[0],S),v=b.exec(y)}}else{const g="#define "+p;s=s.replace(g,`\r
`+_+`\r
`+g)}}return s}}}vx._MaterialPluginClassToMainDefine={},vx._MaterialPluginCounter=0;const Tx=null;let m_=!1,v1=null;function fj(l,e){m_||(v1=Material.OnEventObservable.add(s=>{for(const[,n]of Tx)n(s)},MaterialPluginEvent.Created),m_=!0);const i=Tx.filter(([s,n])=>s===l);i.length>0?i[0][1]=e:Tx.push([l,e])}function pj(l){for(let e=0;e<Tx.length;++e)if(Tx[e][0]===l)return Tx.splice(e,1),Tx.length===0&&xW(),!0;return!1}function xW(){Tx.length=0,m_=!1,Material.OnEventObservable.remove(v1)}class Ho{_enable(e){e&&this._pluginManager._activatePlugin(this)}constructor(e,i,s,n,a=!0,p=!1){this.priority=500,this.registerForExtraEvents=!1,this._material=e,this.name=i,this.priority=s,e.pluginManager||(e.pluginManager=new vx(e),e.onDisposeObservable.add(()=>{e.pluginManager=void 0})),this._pluginDefineNames=n,this._pluginManager=e.pluginManager,a&&this._pluginManager._addPlugin(this),p&&this._enable(!0),this.markAllDefinesAsDirty=e._dirtyCallbacks[63]}getClassName(){return"MaterialPluginBase"}isReadyForSubMesh(e,i,s,n){return!0}hardBindForSubMesh(e,i,s,n){}bindForSubMesh(e,i,s,n){}dispose(e){}getCustomCode(e){return null}collectDefines(e){if(!!this._pluginDefineNames)for(const i of Object.keys(this._pluginDefineNames)){if(i[0]==="_")continue;const s=typeof this._pluginDefineNames[i];e[i]={type:s==="number"?"number":s==="string"?"string":s==="boolean"?"boolean":"object",default:this._pluginDefineNames[i]}}}prepareDefinesBeforeAttributes(e,i,s){}prepareDefines(e,i,s){}hasTexture(e){return!1}hasRenderTargetTextures(){return!1}fillRenderTargetTextures(e){}getActiveTextures(e){}getAnimatables(e){}addFallbacks(e,i,s){return s}getSamplers(e){}getAttributes(e,i,s){}getUniformBuffersNames(e){}getUniforms(){return{}}copyTo(e){Kt.Clone(()=>e,this)}serialize(){return Kt.Serialize(this)}parse(e,i,s){Kt.Parse(()=>this,e,i,s)}}J([xe()],Ho.prototype,"name",void 0),J([xe()],Ho.prototype,"priority",void 0),J([xe()],Ho.prototype,"registerForExtraEvents",void 0);class lW extends ja{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}}class Ex extends Ho{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,i=!0){super(e,"DetailMap",140,new lW,i),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=Be.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,i,s){return this._isEnabled?!(e._areTexturesDirty&&i.texturesEnabled&&s.getCaps().standardDerivatives&&this._texture&&Ze.DetailTextureEnabled&&!this._texture.isReady()):!0}prepareDefines(e,i){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;const s=i.getEngine();e._areTexturesDirty&&(s.getCaps().standardDerivatives&&this._texture&&Ze.DetailTextureEnabled&&this._isEnabled?(nt.PrepareDefinesForMergedUV(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1}bindForSubMesh(e,i){if(!this._isEnabled)return;const s=this._material.isFrozen;(!e.useUbo||!s||!e.isSync)&&this._texture&&Ze.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),nt.BindTextureMatrix(this._texture,e,"detail")),i.texturesEnabled&&this._texture&&Ze.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){var i;e&&((i=this._texture)===null||i===void 0||i.dispose())}getClassName(){return"DetailMapConfiguration"}getSamplers(e){e.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}}J([qi("detailTexture"),He("_markAllSubMeshesAsTexturesDirty")],Ex.prototype,"texture",void 0),J([xe()],Ex.prototype,"diffuseBlendLevel",void 0),J([xe()],Ex.prototype,"roughnessBlendLevel",void 0),J([xe()],Ex.prototype,"bumpLevel",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Ex.prototype,"normalBlendMethod",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Ex.prototype,"isEnabled",void 0);const __={effect:null,subMesh:null};class cW extends ja{constructor(e){super(e),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.rebuild()}setReflectionMode(e){const i=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(const s of i)this[s]=s===e}}class ot extends qh{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}get canRenderToMRT(){return!0}constructor(e,i){super(e,i),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new qe(0,0,0),this.diffuseColor=new qe(1,1,1),this.specularColor=new qe(1,1,1),this.emissiveColor=new qe(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._renderTargets=new Ps(16),this._worldViewProjectionMatrix=fe.Zero(),this._globalAmbientColor=new qe(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new Ex(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new Rc,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),ot.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),ot.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get hasRenderTargetTextures(){return ot.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||ot.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported,this._markAllSubMeshesAsMiscDirty()}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled}needAlphaTesting(){return this._forceAlphaTest?!0:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===Be.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==Be.MATERIAL_OPAQUE}_hasAlphaChannel(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,i,s=!1){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),i.effect&&this.isFrozen&&i.effect._wasPreviouslyReady&&i.effect._wasPreviouslyUsingInstances===s)return!0;i.materialDefines||(this._callbackPluginEventGeneric(ws.GetDefineNames,this._eventInfo),i.materialDefines=new cW(this._eventInfo.defineNames));const n=this.getScene(),a=i.materialDefines;if(this._isReadyForSubMesh(i))return!0;const p=n.getEngine();a._needNormals=nt.PrepareDefinesForLights(n,e,a,!0,this._maxSimultaneousLights,this._disableLighting),nt.PrepareDefinesForMultiview(n,a);const _=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(nt.PrepareDefinesForPrePass(n,a,this.canRenderToMRT&&!_),nt.PrepareDefinesForOIT(n,a,_),a._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,a._needUVs=!1;for(let y=1;y<=6;++y)a["MAINUV"+y]=!1;if(n.texturesEnabled){if(a.DIFFUSEDIRECTUV=0,a.BUMPDIRECTUV=0,a.AMBIENTDIRECTUV=0,a.OPACITYDIRECTUV=0,a.EMISSIVEDIRECTUV=0,a.SPECULARDIRECTUV=0,a.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&ot.DiffuseTextureEnabled)if(this._diffuseTexture.isReadyOrNotBlocking())nt.PrepareDefinesForMergedUV(this._diffuseTexture,a,"DIFFUSE");else return!1;else a.DIFFUSE=!1;if(this._ambientTexture&&ot.AmbientTextureEnabled)if(this._ambientTexture.isReadyOrNotBlocking())nt.PrepareDefinesForMergedUV(this._ambientTexture,a,"AMBIENT");else return!1;else a.AMBIENT=!1;if(this._opacityTexture&&ot.OpacityTextureEnabled)if(this._opacityTexture.isReadyOrNotBlocking())nt.PrepareDefinesForMergedUV(this._opacityTexture,a,"OPACITY"),a.OPACITYRGB=this._opacityTexture.getAlphaFromRGB;else return!1;else a.OPACITY=!1;if(this._reflectionTexture&&ot.ReflectionTextureEnabled)if(this._reflectionTexture.isReadyOrNotBlocking()){switch(a._needNormals=!0,a.REFLECTION=!0,a.ROUGHNESS=this._roughness>0,a.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,a.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===Oe.INVCUBIC_MODE,a.REFLECTIONMAP_3D=this._reflectionTexture.isCube,a.REFLECTIONMAP_OPPOSITEZ=a.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,a.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case Oe.EXPLICIT_MODE:a.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case Oe.PLANAR_MODE:a.setReflectionMode("REFLECTIONMAP_PLANAR");break;case Oe.PROJECTION_MODE:a.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case Oe.SKYBOX_MODE:a.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case Oe.SPHERICAL_MODE:a.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case Oe.EQUIRECTANGULAR_MODE:a.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case Oe.FIXED_EQUIRECTANGULAR_MODE:a.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case Oe.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:a.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case Oe.CUBIC_MODE:case Oe.INVCUBIC_MODE:default:a.setReflectionMode("REFLECTIONMAP_CUBIC");break}a.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else return!1;else a.REFLECTION=!1,a.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&ot.EmissiveTextureEnabled)if(this._emissiveTexture.isReadyOrNotBlocking())nt.PrepareDefinesForMergedUV(this._emissiveTexture,a,"EMISSIVE");else return!1;else a.EMISSIVE=!1;if(this._lightmapTexture&&ot.LightmapTextureEnabled)if(this._lightmapTexture.isReadyOrNotBlocking())nt.PrepareDefinesForMergedUV(this._lightmapTexture,a,"LIGHTMAP"),a.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,a.RGBDLIGHTMAP=this._lightmapTexture.isRGBD;else return!1;else a.LIGHTMAP=!1;if(this._specularTexture&&ot.SpecularTextureEnabled)if(this._specularTexture.isReadyOrNotBlocking())nt.PrepareDefinesForMergedUV(this._specularTexture,a,"SPECULAR"),a.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha;else return!1;else a.SPECULAR=!1;if(n.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&ot.BumpTextureEnabled){if(this._bumpTexture.isReady())nt.PrepareDefinesForMergedUV(this._bumpTexture,a,"BUMP"),a.PARALLAX=this._useParallax,a.PARALLAXOCCLUSION=this._useParallaxOcclusion;else return!1;a.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else a.BUMP=!1,a.PARALLAX=!1,a.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&ot.RefractionTextureEnabled)if(this._refractionTexture.isReadyOrNotBlocking())a._needUVs=!0,a.REFRACTION=!0,a.REFRACTIONMAP_3D=this._refractionTexture.isCube,a.RGBDREFRACTION=this._refractionTexture.isRGBD,a.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize;else return!1;else a.REFRACTION=!1;a.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else a.DIFFUSE=!1,a.AMBIENT=!1,a.OPACITY=!1,a.REFLECTION=!1,a.EMISSIVE=!1,a.LIGHTMAP=!1,a.BUMP=!1,a.REFRACTION=!1;a.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),a.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,a.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,a.SPECULAROVERALPHA=this._useSpecularOverAlpha,a.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,a.ALPHATEST_AFTERALLALPHACOMPUTATIONS=this.transparencyMode!==null,a.ALPHABLEND=this.transparencyMode===null||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=a,this._eventInfo.subMesh=i,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(a._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(a),a.IS_REFLECTION_LINEAR=this.reflectionTexture!=null&&!this.reflectionTexture.gammaSpace,a.IS_REFRACTION_LINEAR=this.refractionTexture!=null&&!this.refractionTexture.gammaSpace}a._areFresnelDirty&&(ot.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(a.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,a.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,a.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,a.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,a.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,a.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,a._needNormals=!0,a.FRESNEL=!0):a.FRESNEL=!1),nt.PrepareDefinesForMisc(e,n,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,a),nt.PrepareDefinesForFrameBoundValues(n,p,this,a,s,null,i.getRenderingMesh().hasThinInstances),this._eventInfo.defines=a,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),nt.PrepareDefinesForAttributes(e,a,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let g=!1;if(a.isDirty){const y=a._areLightsDisposed;a.markAsProcessed();const b=new Zh;a.REFLECTION&&b.addFallback(0,"REFLECTION"),a.SPECULAR&&b.addFallback(0,"SPECULAR"),a.BUMP&&b.addFallback(0,"BUMP"),a.PARALLAX&&b.addFallback(1,"PARALLAX"),a.PARALLAXOCCLUSION&&b.addFallback(0,"PARALLAXOCCLUSION"),a.SPECULAROVERALPHA&&b.addFallback(0,"SPECULAROVERALPHA"),a.FOG&&b.addFallback(1,"FOG"),a.POINTSIZE&&b.addFallback(0,"POINTSIZE"),a.LOGARITHMICDEPTH&&b.addFallback(0,"LOGARITHMICDEPTH"),nt.HandleFallbacksForShadows(a,b,this._maxSimultaneousLights),a.SPECULARTERM&&b.addFallback(0,"SPECULARTERM"),a.DIFFUSEFRESNEL&&b.addFallback(1,"DIFFUSEFRESNEL"),a.OPACITYFRESNEL&&b.addFallback(2,"OPACITYFRESNEL"),a.REFLECTIONFRESNEL&&b.addFallback(3,"REFLECTIONFRESNEL"),a.EMISSIVEFRESNEL&&b.addFallback(4,"EMISSIVEFRESNEL"),a.FRESNEL&&b.addFallback(4,"FRESNEL"),a.MULTIVIEW&&b.addFallback(0,"MULTIVIEW");const v=[te.PositionKind];a.NORMAL&&v.push(te.NormalKind),a.TANGENT&&v.push(te.TangentKind);for(let z=1;z<=6;++z)a["UV"+z]&&v.push(`uv${z===1?"":z}`);a.VERTEXCOLOR&&v.push(te.ColorKind),nt.PrepareAttributesForBones(v,e,a,b),nt.PrepareAttributesForInstances(v,a),nt.PrepareAttributesForMorphTargets(v,e,a),nt.PrepareAttributesForBakedVertexAnimation(v,e,a);let S="default";const M=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],F=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],L=["Material","Scene","Mesh"];this._eventInfo.fallbacks=b,this._eventInfo.fallbackRank=0,this._eventInfo.defines=a,this._eventInfo.uniforms=M,this._eventInfo.attributes=v,this._eventInfo.samplers=F,this._eventInfo.uniformBuffersNames=L,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._callbackPluginEventGeneric(ws.PrepareEffect,this._eventInfo),Rc.AddUniforms(M),Rc.AddSamplers(F),Oi&&(Oi.PrepareUniforms(M,a),Oi.PrepareSamplers(F,a)),nt.PrepareUniformsAndSamplersList({uniformsNames:M,uniformBuffersNames:L,samplers:F,defines:a,maxSimultaneousLights:this._maxSimultaneousLights}),O2(M);const N={};this.customShaderNameResolve&&(S=this.customShaderNameResolve(S,M,L,F,a,v,N));const k=a.toString(),G=i.effect;let H=n.getEngine().createEffect(S,{attributes:v,uniformsNames:M,uniformBuffersNames:L,samplers:F,defines:k,fallbacks:b,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:a.NUM_MORPH_INFLUENCERS},processFinalCode:N.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:a.PREPASS},p);if(this._eventInfo.customCode=void 0,H)if(this._onEffectCreatedObservable&&(__.effect=H,__.subMesh=i,this._onEffectCreatedObservable.notifyObservers(__)),this.allowShaderHotSwapping&&G&&!H.isReady()){if(H=G,a.markAsUnprocessed(),g=this.isFrozen,y)return a._areLightsDisposed=!0,!1}else n.resetCachedMaterial(),i.setEffect(H,a,this._materialContext)}return!i.effect||!i.effect.isReady()?!1:(a._renderId=n.getRenderId(),i.effect._wasPreviouslyReady=!g,i.effect._wasPreviouslyUsingInstances=s,this._checkScenePerformancePriority(),!0)}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),super.buildUniformLayout()}bindForSubMesh(e,i,s){var n;const a=this.getScene(),p=s.materialDefines;if(!p)return;const _=s.effect;if(!_)return;this._activeEffect=_,i.getMeshUniformBuffer().bindToEffect(_,"Mesh"),i.transferToEffect(e),this._uniformBuffer.bindToEffect(_,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,a,i,e,this.isFrozen),this._eventInfo.subMesh=s,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),p.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const g=_._forceRebindOnNextCall||this._mustRebind(a,_,i.visibility);nt.BindBonesParameters(i,_);const y=this._uniformBuffer;if(g){if(this.bindViewProjection(_),!y.useUbo||!this.isFrozen||!y.isSync||_._forceRebindOnNextCall){if(ot.FresnelEnabled&&p.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(y.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),y.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&y.updateColor4("opacityParts",new qe(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(y.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),y.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(y.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),y.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(y.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),y.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),a.texturesEnabled){if(this._diffuseTexture&&ot.DiffuseTextureEnabled&&(y.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),nt.BindTextureMatrix(this._diffuseTexture,y,"diffuse")),this._ambientTexture&&ot.AmbientTextureEnabled&&(y.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),nt.BindTextureMatrix(this._ambientTexture,y,"ambient")),this._opacityTexture&&ot.OpacityTextureEnabled&&(y.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),nt.BindTextureMatrix(this._opacityTexture,y,"opacity")),this._hasAlphaChannel()&&y.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&ot.ReflectionTextureEnabled&&(y.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),y.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){const b=this._reflectionTexture;y.updateVector3("vReflectionPosition",b.boundingBoxPosition),y.updateVector3("vReflectionSize",b.boundingBoxSize)}if(this._emissiveTexture&&ot.EmissiveTextureEnabled&&(y.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),nt.BindTextureMatrix(this._emissiveTexture,y,"emissive")),this._lightmapTexture&&ot.LightmapTextureEnabled&&(y.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),nt.BindTextureMatrix(this._lightmapTexture,y,"lightmap")),this._specularTexture&&ot.SpecularTextureEnabled&&(y.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),nt.BindTextureMatrix(this._specularTexture,y,"specular")),this._bumpTexture&&a.getEngine().getCaps().standardDerivatives&&ot.BumpTextureEnabled&&(y.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),nt.BindTextureMatrix(this._bumpTexture,y,"bump"),a._mirroredCameraPosition?y.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):y.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&ot.RefractionTextureEnabled){let b=1;if(this._refractionTexture.isCube||(y.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(b=this._refractionTexture.depth)),y.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,b,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){const v=this._refractionTexture;y.updateVector3("vRefractionPosition",v.boundingBoxPosition),y.updateVector3("vRefractionSize",v.boundingBoxSize)}}}this.pointsCloud&&y.updateFloat("pointSize",this.pointSize),p.SPECULARTERM&&y.updateColor4("vSpecularColor",this.specularColor,this.specularPower),y.updateColor3("vEmissiveColor",ot.EmissiveTextureEnabled?this.emissiveColor:qe.BlackReadOnly),y.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),a.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),y.updateColor3("vAmbientColor",this._globalAmbientColor)}a.texturesEnabled&&(this._diffuseTexture&&ot.DiffuseTextureEnabled&&_.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&ot.AmbientTextureEnabled&&_.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&ot.OpacityTextureEnabled&&_.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&ot.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?_.setTexture("reflectionCubeSampler",this._reflectionTexture):_.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&ot.EmissiveTextureEnabled&&_.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&ot.LightmapTextureEnabled&&_.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&ot.SpecularTextureEnabled&&_.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&a.getEngine().getCaps().standardDerivatives&&ot.BumpTextureEnabled&&_.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&ot.RefractionTextureEnabled&&(this._refractionTexture.isCube?_.setTexture("refractionCubeSampler",this._refractionTexture):_.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(i)&&this.getScene().depthPeelingRenderer.bind(_),this._eventInfo.subMesh=s,this._callbackPluginEventBindForSubMesh(this._eventInfo),w2(_,this,a),this.bindEyePosition(_)}else a.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(g||!this.isFrozen)&&(a.lightsEnabled&&!this._disableLighting&&nt.BindLights(a,i,_,p,this._maxSimultaneousLights),(a.fogEnabled&&i.applyFog&&a.fogMode!==Nt.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||i.receiveShadows||p.PREPASS)&&this.bindView(_),nt.BindFogParameters(a,i,_),p.NUM_MORPH_INFLUENCERS&&nt.BindMorphTargetParameters(i,_),p.BAKED_VERTEX_ANIMATION_TEXTURE&&((n=i.bakedVertexAnimationManager)===null||n===void 0||n.bind(_,p.INSTANCES)),this.useLogarithmicDepth&&nt.BindLogDepth(p,_,a),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(i,this._activeEffect),y.update()}getAnimatables(){const e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){const e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e)}dispose(e,i){var s,n,a,p,_,g,y,b,v;i&&((s=this._diffuseTexture)===null||s===void 0||s.dispose(),(n=this._ambientTexture)===null||n===void 0||n.dispose(),(a=this._opacityTexture)===null||a===void 0||a.dispose(),(p=this._reflectionTexture)===null||p===void 0||p.dispose(),(_=this._emissiveTexture)===null||_===void 0||_.dispose(),(g=this._specularTexture)===null||g===void 0||g.dispose(),(y=this._bumpTexture)===null||y===void 0||y.dispose(),(b=this._lightmapTexture)===null||b===void 0||b.dispose(),(v=this._refractionTexture)===null||v===void 0||v.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,i)}clone(e){const i=Kt.Clone(()=>new ot(e,this.getScene()),this);return i.name=e,i.id=e,this.stencil.copyTo(i.stencil),i}static Parse(e,i,s){const n=Kt.Parse(()=>new ot(e.name,i),e,i,s);return e.stencil&&n.stencil.parse(e.stencil,i,s),n}static get DiffuseTextureEnabled(){return Ze.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){Ze.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return Ze.DetailTextureEnabled}static set DetailTextureEnabled(e){Ze.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return Ze.AmbientTextureEnabled}static set AmbientTextureEnabled(e){Ze.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return Ze.OpacityTextureEnabled}static set OpacityTextureEnabled(e){Ze.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return Ze.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){Ze.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return Ze.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){Ze.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return Ze.SpecularTextureEnabled}static set SpecularTextureEnabled(e){Ze.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return Ze.BumpTextureEnabled}static set BumpTextureEnabled(e){Ze.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return Ze.LightmapTextureEnabled}static set LightmapTextureEnabled(e){Ze.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return Ze.RefractionTextureEnabled}static set RefractionTextureEnabled(e){Ze.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return Ze.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){Ze.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return Ze.FresnelEnabled}static set FresnelEnabled(e){Ze.FresnelEnabled=e}}J([qi("diffuseTexture")],ot.prototype,"_diffuseTexture",void 0),J([He("_markAllSubMeshesAsTexturesAndMiscDirty")],ot.prototype,"diffuseTexture",void 0),J([qi("ambientTexture")],ot.prototype,"_ambientTexture",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"ambientTexture",void 0),J([qi("opacityTexture")],ot.prototype,"_opacityTexture",void 0),J([He("_markAllSubMeshesAsTexturesAndMiscDirty")],ot.prototype,"opacityTexture",void 0),J([qi("reflectionTexture")],ot.prototype,"_reflectionTexture",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"reflectionTexture",void 0),J([qi("emissiveTexture")],ot.prototype,"_emissiveTexture",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"emissiveTexture",void 0),J([qi("specularTexture")],ot.prototype,"_specularTexture",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"specularTexture",void 0),J([qi("bumpTexture")],ot.prototype,"_bumpTexture",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"bumpTexture",void 0),J([qi("lightmapTexture")],ot.prototype,"_lightmapTexture",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"lightmapTexture",void 0),J([qi("refractionTexture")],ot.prototype,"_refractionTexture",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"refractionTexture",void 0),J([Vs("ambient")],ot.prototype,"ambientColor",void 0),J([Vs("diffuse")],ot.prototype,"diffuseColor",void 0),J([Vs("specular")],ot.prototype,"specularColor",void 0),J([Vs("emissive")],ot.prototype,"emissiveColor",void 0),J([xe()],ot.prototype,"specularPower",void 0),J([xe("useAlphaFromDiffuseTexture")],ot.prototype,"_useAlphaFromDiffuseTexture",void 0),J([He("_markAllSubMeshesAsTexturesAndMiscDirty")],ot.prototype,"useAlphaFromDiffuseTexture",void 0),J([xe("useEmissiveAsIllumination")],ot.prototype,"_useEmissiveAsIllumination",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"useEmissiveAsIllumination",void 0),J([xe("linkEmissiveWithDiffuse")],ot.prototype,"_linkEmissiveWithDiffuse",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"linkEmissiveWithDiffuse",void 0),J([xe("useSpecularOverAlpha")],ot.prototype,"_useSpecularOverAlpha",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"useSpecularOverAlpha",void 0),J([xe("useReflectionOverAlpha")],ot.prototype,"_useReflectionOverAlpha",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"useReflectionOverAlpha",void 0),J([xe("disableLighting")],ot.prototype,"_disableLighting",void 0),J([He("_markAllSubMeshesAsLightsDirty")],ot.prototype,"disableLighting",void 0),J([xe("useObjectSpaceNormalMap")],ot.prototype,"_useObjectSpaceNormalMap",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"useObjectSpaceNormalMap",void 0),J([xe("useParallax")],ot.prototype,"_useParallax",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"useParallax",void 0),J([xe("useParallaxOcclusion")],ot.prototype,"_useParallaxOcclusion",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"useParallaxOcclusion",void 0),J([xe()],ot.prototype,"parallaxScaleBias",void 0),J([xe("roughness")],ot.prototype,"_roughness",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"roughness",void 0),J([xe()],ot.prototype,"indexOfRefraction",void 0),J([xe()],ot.prototype,"invertRefractionY",void 0),J([xe()],ot.prototype,"alphaCutOff",void 0),J([xe("useLightmapAsShadowmap")],ot.prototype,"_useLightmapAsShadowmap",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"useLightmapAsShadowmap",void 0),J([Yh("diffuseFresnelParameters")],ot.prototype,"_diffuseFresnelParameters",void 0),J([He("_markAllSubMeshesAsFresnelDirty")],ot.prototype,"diffuseFresnelParameters",void 0),J([Yh("opacityFresnelParameters")],ot.prototype,"_opacityFresnelParameters",void 0),J([He("_markAllSubMeshesAsFresnelAndMiscDirty")],ot.prototype,"opacityFresnelParameters",void 0),J([Yh("reflectionFresnelParameters")],ot.prototype,"_reflectionFresnelParameters",void 0),J([He("_markAllSubMeshesAsFresnelDirty")],ot.prototype,"reflectionFresnelParameters",void 0),J([Yh("refractionFresnelParameters")],ot.prototype,"_refractionFresnelParameters",void 0),J([He("_markAllSubMeshesAsFresnelDirty")],ot.prototype,"refractionFresnelParameters",void 0),J([Yh("emissiveFresnelParameters")],ot.prototype,"_emissiveFresnelParameters",void 0),J([He("_markAllSubMeshesAsFresnelDirty")],ot.prototype,"emissiveFresnelParameters",void 0),J([xe("useReflectionFresnelFromSpecular")],ot.prototype,"_useReflectionFresnelFromSpecular",void 0),J([He("_markAllSubMeshesAsFresnelDirty")],ot.prototype,"useReflectionFresnelFromSpecular",void 0),J([xe("useGlossinessFromSpecularMapAlpha")],ot.prototype,"_useGlossinessFromSpecularMapAlpha",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"useGlossinessFromSpecularMapAlpha",void 0),J([xe("maxSimultaneousLights")],ot.prototype,"_maxSimultaneousLights",void 0),J([He("_markAllSubMeshesAsLightsDirty")],ot.prototype,"maxSimultaneousLights",void 0),J([xe("invertNormalMapX")],ot.prototype,"_invertNormalMapX",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"invertNormalMapX",void 0),J([xe("invertNormalMapY")],ot.prototype,"_invertNormalMapY",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"invertNormalMapY",void 0),J([xe("twoSidedLighting")],ot.prototype,"_twoSidedLighting",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],ot.prototype,"twoSidedLighting",void 0),J([xe()],ot.prototype,"useLogarithmicDepth",null),ur("BABYLON.StandardMaterial",ot),Nt.DefaultMaterialFactory=l=>new ot("default material",l);class hW{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new j(0,0,0),this._diffPositionForCollisions=new j(0,0,0),this._collisionResponse=!0}}class uW{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=j.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}}class dW{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new uW,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new hW,this._enableDistantPicking=!1,this._rawBoundingInfo=null}}class Ds extends Jt{static get BILLBOARDMODE_NONE(){return Jt.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return Jt.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return Jt.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return Jt.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return Jt.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return Jt.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(e){return super._updateNonUniformScalingState(e)?(this._markSubMeshesAsMiscDirty(),!0):!1}get rawBoundingInfo(){return this._internalAbstractMeshDataInfo._rawBoundingInfo}set rawBoundingInfo(e){this._internalAbstractMeshDataInfo._rawBoundingInfo=e}set onCollide(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e)}set onCollisionPositionChange(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(e){if(this._internalAbstractMeshDataInfo._visibility===e)return;const i=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(i===1&&e!==1||i!==1&&e===1)&&this._markSubMeshesAsMiscDirty()}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(e){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=e}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(e){this._internalAbstractMeshDataInfo._renderingGroupId=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))}getMaterialForRenderPass(e){var i;return(i=this._internalAbstractMeshDataInfo._materialForRenderPass)===null||i===void 0?void 0:i[e]}setMaterialForRenderPass(e,i){this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=i}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e}get lightSources(){return this._lightSources}get _positions(){return null}set skeleton(e){const i=this._internalAbstractMeshDataInfo._skeleton;i&&i.needInitialSkinMatrix&&i._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}constructor(e,i=null){switch(super(e,i,!1),this._internalAbstractMeshDataInfo=new dW,this._waitingMaterialId=null,this.cullingStrategy=Ds.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new Re,this.onCollisionPositionChangeObservable=new Re,this.onMaterialChangedObservable=new Re,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this.isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=qe.Red(),this.outlineWidth=.02,this.overlayColor=qe.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new j(.5,1,.5),this.ellipsoidOffset=new j(0,0,0),this.edgesWidth=1,this.edgesColor=new pi(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new Re,this._onCollisionPositionChange=(s,n,a=null)=>{n.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>Ae.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),a&&this.onCollideObservable.notifyObservers(a),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},i=this.getScene(),i.addMesh(this),this._resyncLightSources(),this._uniformBuffer=new At(this.getScene().getEngine(),void 0,void 0,e,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),i.performancePriority){case zo.Aggressive:this.doNotSyncBoundingInfo=!0;case zo.Intermediate:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1;break}}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(e){const i=this._uniformBuffer;i.updateMatrix("world",e),i.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),i.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(e){let i="Name: "+this.name+", isInstance: "+(this.getClassName()!=="InstancedMesh"?"YES":"NO");i+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);const s=this._internalAbstractMeshDataInfo._skeleton;return s&&(i+=", skeleton: "+s.name),e&&(i+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],i+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),i}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==Jt.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(e,i=!0){if(this.actionManager&&(i||this.actionManager.isRecursive))if(e){if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}else return this.actionManager;return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_rebuild(e=!1){if(this.onRebuildObservable.notifyObservers(this),this._occlusionQuery!==null&&(this._occlusionQuery=null),!!this.subMeshes)for(const i of this.subMeshes)i._rebuild()}_resyncLightSources(){this._lightSources.length=0;for(const e of this.getScene().lights)!e.isEnabled()||e.canAffectMesh(this)&&this._lightSources.push(e);this._markSubMeshesAsLightDirty()}_resyncLightSource(e){const i=e.isEnabled()&&e.canAffectMesh(this),s=this._lightSources.indexOf(e);let n=!1;if(s===-1){if(!i)return;this._lightSources.push(e)}else{if(i)return;n=!0,this._lightSources.splice(s,1)}this._markSubMeshesAsLightDirty(n)}_unBindEffect(){for(const e of this.subMeshes)e.setEffect(null)}_removeLightSource(e,i){const s=this._lightSources.indexOf(e);s!==-1&&(this._lightSources.splice(s,1),this._markSubMeshesAsLightDirty(i))}_markSubMeshesAsDirty(e){if(!!this.subMeshes)for(const i of this.subMeshes)for(let s=0;s<i._drawWrappers.length;++s){const n=i._drawWrappers[s];!n||!n.defines||!n.defines.markAllAsDirty||e(n.defines)}}_markSubMeshesAsLightDirty(e=!1){this._markSubMeshesAsDirty(i=>i.markAsLightDirty(e))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty(e=>e.markAsAttributesDirty())}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty(e=>e.markAsMiscDirty())}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}resetDrawCache(e){if(!!this.subMeshes)for(const i of this.subMeshes)i.resetDrawCache(e)}get isBlocked(){return!1}getLOD(e){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(e){return null}setVerticesData(e,i,s,n){return this}updateVerticesData(e,i,s,n){return this}setIndices(e,i){return this}isVerticesDataPresent(e){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}getRawBoundingInfo(){var e;return(e=this.rawBoundingInfo)!==null&&e!==void 0?e:this.getBoundingInfo()}setBoundingInfo(e){return this._boundingInfo=e,this}get hasBoundingInfo(){return this._boundingInfo!==null}buildBoundingInfo(e,i,s){return this._boundingInfo=new la(e,i,s),this._boundingInfo}normalizeToUnitCube(e=!0,i=!1,s){return super.normalizeToUnitCube(e,i,s)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(te.MatricesIndicesKind)&&this.isVerticesDataPresent(te.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(e){}_activate(e,i){return this._renderId=e,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===Jt.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(e,i,s){return this.position.addInPlace(this.calcMovePOV(e,i,s)),this}calcMovePOV(e,i,s){const n=new fe;(this.rotationQuaternion?this.rotationQuaternion:Ve.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(n);const p=j.Zero(),_=this.definedFacingForward?-1:1;return j.TransformCoordinatesFromFloatsToRef(e*_,i,s*_,n,p),p}rotatePOV(e,i,s){return this.rotation.addInPlace(this.calcRotatePOV(e,i,s)),this}calcRotatePOV(e,i,s){const n=this.definedFacingForward?1:-1;return new j(e*n,i,s*n)}refreshBoundingInfo(e=!1,i=!1){return this._boundingInfo&&this._boundingInfo.isLocked?this:(this._refreshBoundingInfo(this._getPositionData(e,i),null),this)}_refreshBoundingInfo(e,i){if(e){const s=zE(e,0,this.getTotalVertices(),i);this._boundingInfo?this._boundingInfo.reConstruct(s.minimum,s.maximum):this._boundingInfo=new la(s.minimum,s.maximum)}if(this.subMeshes)for(let s=0;s<this.subMeshes.length;s++)this.subMeshes[s].refreshBoundingInfo(e);this._updateBoundingInfo()}_getData(e=!1,i=!1,s,n=te.PositionKind){if(s=s??this.getVerticesData(n).slice(),s&&i&&this.morphTargetManager){let a=0,p=0;for(let _=0;_<s.length;_++){for(let g=0;g<this.morphTargetManager.numTargets;g++){const y=this.morphTargetManager.getTarget(g),b=y.influence;if(b>0){const v=y.getPositions();v&&(s[_]+=(v[_]-s[_])*b)}}if(a++,n===te.PositionKind&&this._positions&&a===3){a=0;const g=p*3;this._positions[p++].copyFromFloats(s[g],s[g+1],s[g+2])}}}if(s&&e&&this.skeleton){const a=this.getVerticesData(te.MatricesIndicesKind),p=this.getVerticesData(te.MatricesWeightsKind);if(p&&a){const _=this.numBoneInfluencers>4,g=_?this.getVerticesData(te.MatricesIndicesExtraKind):null,y=_?this.getVerticesData(te.MatricesWeightsExtraKind):null,b=this.skeleton.getTransformMatrices(this),v=ge.Vector3[0],S=ge.Matrix[0],M=ge.Matrix[1];let F=0;for(let L=0;L<s.length;L+=3,F+=4){S.reset();let N,k;for(N=0;N<4;N++)k=p[F+N],k>0&&(fe.FromFloat32ArrayToRefScaled(b,Math.floor(a[F+N]*16),k,M),S.addToSelf(M));if(_)for(N=0;N<4;N++)k=y[F+N],k>0&&(fe.FromFloat32ArrayToRefScaled(b,Math.floor(g[F+N]*16),k,M),S.addToSelf(M));n===te.NormalKind?j.TransformNormalFromFloatsToRef(s[L],s[L+1],s[L+2],S,v):j.TransformCoordinatesFromFloatsToRef(s[L],s[L+1],s[L+2],S,v),v.toArray(s,L),n===te.PositionKind&&this._positions&&this._positions[L/3].copyFrom(v)}}}return s}getNormalsData(e=!1,i=!1){return this._getData(e,i,null,te.NormalKind)}getPositionData(e=!1,i=!1,s){return this._getData(e,i,s,te.PositionKind)}_getPositionData(e,i){var s;let n=this.getVerticesData(te.PositionKind);if(this._internalAbstractMeshDataInfo._positions&&(this._internalAbstractMeshDataInfo._positions=null),n&&(e&&this.skeleton||i&&this.morphTargetManager)){if(n=n.slice(),this._generatePointsArray(),this._positions){const a=this._positions;this._internalAbstractMeshDataInfo._positions=new Array(a.length);for(let p=0;p<a.length;p++)this._internalAbstractMeshDataInfo._positions[p]=((s=a[p])===null||s===void 0?void 0:s.clone())||new j}return this.getPositionData(e,i,n)}return n}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new la(j.Zero(),j.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(e){if(!this.subMeshes)return this;const i=this.subMeshes.length;for(let s=0;s<i;s++){const n=this.subMeshes[s];(i>1||!n.IsGlobal)&&n.updateBoundingInfo(e)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)}isCompletelyInFrustum(e){return this.getBoundingInfo().isCompletelyInFrustum(e)}intersectsMesh(e,i=!1,s){const n=this.getBoundingInfo(),a=e.getBoundingInfo();if(n.intersects(a,i))return!0;if(s){for(const p of this.getChildMeshes())if(p.intersectsMesh(e,i,!0))return!0}return!1}intersectsPoint(e){return this.getBoundingInfo().intersectsPoint(e)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(e){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);const s=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=s.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,s.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this}_collideForSubMesh(e,i,s){var n;if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(i)){e._lastColliderTransformMatrix=i.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];const a=e.verticesStart,p=e.verticesStart+e.verticesCount;for(let _=a;_<p;_++)e._lastColliderWorldVertices.push(j.TransformCoordinates(this._positions[_],i))}return s._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),((n=e.getMaterial())===null||n===void 0?void 0:n.fillMode)===7),this}_processCollisionsForSubMeshes(e,i){const s=this._scene.getCollidingSubMeshCandidates(this,e),n=s.length;for(let a=0;a<n;a++){const p=s.data[a];n>1&&!p._checkCollision(e)||this._collideForSubMesh(p,i,e)}return this}_shouldConvertRHS(){return!1}_checkCollision(e){if(!this.getBoundingInfo()._checkCollision(e))return this;const i=ge.Matrix[0],s=ge.Matrix[1];return fe.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,i),this.worldMatrixFromCache.multiplyToRef(i,s),this._processCollisionsForSubMeshes(e,s),this}_generatePointsArray(){return!1}intersects(e,i,s,n=!1,a,p=!1){const _=new In,g=this.getClassName()==="InstancedLinesMesh"||this.getClassName()==="LinesMesh"?this.intersectionThreshold:0,y=this.getBoundingInfo();if(!this.subMeshes||!p&&(!e.intersectsSphere(y.boundingSphere,g)||!e.intersectsBox(y.boundingBox,g)))return _;if(n)return _.hit=!p,_.pickedMesh=p?null:this,_.distance=p?0:j.Distance(e.origin,y.boundingSphere.center),_.subMeshId=0,_;if(!this._generatePointsArray())return _;let b=null;const v=this._scene.getIntersectingSubMeshCandidates(this,e),S=v.length;let M=!1;for(let F=0;F<S;F++){const N=v.data[F].getMaterial();if(!!N&&(N.fillMode==7||N.fillMode==0||N.fillMode==1||N.fillMode==2||N.fillMode==4)){M=!0;break}}if(!M)return _.hit=!0,_.pickedMesh=this,_.distance=j.Distance(e.origin,y.boundingSphere.center),_.subMeshId=-1,_;for(let F=0;F<S;F++){const L=v.data[F];if(S>1&&!L.canIntersects(e))continue;const N=L.intersects(e,this._positions,this.getIndices(),i,s);if(N&&(i||!b||N.distance<b.distance)&&(b=N,b.subMeshId=F,i))break}if(b){const F=a??this.getWorldMatrix(),L=ge.Vector3[0],N=ge.Vector3[1];j.TransformCoordinatesToRef(e.origin,F,L),e.direction.scaleToRef(b.distance,N);const G=j.TransformNormal(N,F).addInPlace(L);return _.hit=!0,_.distance=j.Distance(L,G),_.pickedPoint=G,_.pickedMesh=this,_.bu=b.bu||0,_.bv=b.bv||0,_.subMeshFaceId=b.faceId,_.faceId=b.faceId+v.data[b.subMeshId].indexStart/(this.getClassName().indexOf("LinesMesh")!==-1?2:3),_.subMeshId=b.subMeshId,_}return _}clone(e,i,s){return null}releaseSubMeshes(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=new Array;return this}dispose(e,i=!1){let s;for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this.getScene().freeActiveMeshes(),this.getScene().freeRenderingGroups(),this.actionManager!==void 0&&this.actionManager!==null&&(this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),s=0;s<this._intersectionsInProgress.length;s++){const p=this._intersectionsInProgress[s],_=p._intersectionsInProgress.indexOf(this);p._intersectionsInProgress.splice(_,1)}this._intersectionsInProgress.length=0,this.getScene().lights.forEach(p=>{let _=p.includedOnlyMeshes.indexOf(this);_!==-1&&p.includedOnlyMeshes.splice(_,1),_=p.excludedMeshes.indexOf(this),_!==-1&&p.excludedMeshes.splice(_,1);const g=p.getShadowGenerators();if(g){const y=g.values();for(let b=y.next();b.done!==!0;b=y.next()){const S=b.value.getShadowMap();S&&S.renderList&&(_=S.renderList.indexOf(this),_!==-1&&S.renderList.splice(_,1))}}}),(this.getClassName()!=="InstancedMesh"||this.getClassName()!=="InstancedLinesMesh")&&this.releaseSubMeshes();const a=this.getScene().getEngine();if(this._occlusionQuery!==null&&(this.isOcclusionQueryInProgress=!1,a.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),a.wipeCaches(),this.getScene().removeMesh(this),this._parentContainer){const p=this._parentContainer.meshes.indexOf(this);p>-1&&this._parentContainer.meshes.splice(p,1),this._parentContainer=null}if(i&&this.material&&(this.material.getClassName()==="MultiMaterial"?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!e)for(s=0;s<this.getScene().particleSystems.length;s++)this.getScene().particleSystems[s].emitter===this&&(this.getScene().particleSystems[s].dispose(),s--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(e,i)}addChild(e,i=!1){return e.setParent(this,i),this}removeChild(e,i=!1){return e.setParent(null,i),this}_initFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||(e.facetNormals=new Array),e.facetPositions||(e.facetPositions=new Array),e.facetPartitioning||(e.facetPartitioning=new Array),e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(let i=0;i<e.facetNb;i++)e.facetNormals[i]=j.Zero(),e.facetPositions[i]=j.Zero();return e.facetDataEnabled=!0,this}updateFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();const i=this.getVerticesData(te.PositionKind),s=this.getIndices(),n=this.getVerticesData(te.NormalKind),a=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=!0,s instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(s);else if(s instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(s);else{let _=!1;for(let g=0;g<s.length;g++)if(s[g]>65535){_=!0;break}_?e.depthSortedIndices=new Uint32Array(s):e.depthSortedIndices=new Uint16Array(s)}if(e.facetDepthSortFunction=function(_,g){return g.sqDistance-_.sqDistance},!e.facetDepthSortFrom){const _=this.getScene().activeCamera;e.facetDepthSortFrom=_?_.position:j.Zero()}e.depthSortedFacets=[];for(let _=0;_<e.facetNb;_++){const g={ind:_*3,sqDistance:0};e.depthSortedFacets.push(g)}e.invertedMatrix=fe.Identity(),e.facetDepthSortOrigin=j.Zero()}e.bbSize.x=a.maximum.x-a.minimum.x>rr?a.maximum.x-a.minimum.x:rr,e.bbSize.y=a.maximum.y-a.minimum.y>rr?a.maximum.y-a.minimum.y:rr,e.bbSize.z=a.maximum.z-a.minimum.z>rr?a.maximum.z-a.minimum.z:rr;let p=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(p=p>e.bbSize.z?p:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/p),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/p),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/p),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=a,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(e.invertedMatrix),j.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,n&&Mt.ComputeNormals(i,s,n,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);const _=e.depthSortedIndices.length/3|0;for(let g=0;g<_;g++){const y=e.depthSortedFacets[g].ind;e.depthSortedIndices[g*3]=s[y],e.depthSortedIndices[g*3+1]=s[y+1],e.depthSortedIndices[g*3+2]=s[y+2]}this.updateIndices(e.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals}getFacetLocalPositions(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions}getFacetLocalPartitioning(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning}getFacetPosition(e){const i=j.Zero();return this.getFacetPositionToRef(e,i),i}getFacetPositionToRef(e,i){const s=this.getFacetLocalPositions()[e],n=this.getWorldMatrix();return j.TransformCoordinatesToRef(s,n,i),this}getFacetNormal(e){const i=j.Zero();return this.getFacetNormalToRef(e,i),i}getFacetNormalToRef(e,i){const s=this.getFacetLocalNormals()[e];return j.TransformNormalToRef(s,this.getWorldMatrix(),i),this}getFacetsAtLocalCoordinates(e,i,s){const n=this.getBoundingInfo(),a=this._internalAbstractMeshDataInfo._facetData,p=Math.floor((e-n.minimum.x*a.partitioningBBoxRatio)*a.subDiv.X*a.partitioningBBoxRatio/a.bbSize.x),_=Math.floor((i-n.minimum.y*a.partitioningBBoxRatio)*a.subDiv.Y*a.partitioningBBoxRatio/a.bbSize.y),g=Math.floor((s-n.minimum.z*a.partitioningBBoxRatio)*a.subDiv.Z*a.partitioningBBoxRatio/a.bbSize.z);return p<0||p>a.subDiv.max||_<0||_>a.subDiv.max||g<0||g>a.subDiv.max?null:a.facetPartitioning[p+a.subDiv.max*_+a.subDiv.max*a.subDiv.max*g]}getClosestFacetAtCoordinates(e,i,s,n,a=!1,p=!0){const _=this.getWorldMatrix(),g=ge.Matrix[5];_.invertToRef(g);const y=ge.Vector3[8];j.TransformCoordinatesFromFloatsToRef(e,i,s,g,y);const b=this.getClosestFacetAtLocalCoordinates(y.x,y.y,y.z,n,a,p);return n&&j.TransformCoordinatesFromFloatsToRef(n.x,n.y,n.z,_,n),b}getClosestFacetAtLocalCoordinates(e,i,s,n,a=!1,p=!0){let _=null,g=0,y=0,b=0,v=0,S=0,M=0,F=0,L=0;const N=this.getFacetLocalPositions(),k=this.getFacetLocalNormals(),G=this.getFacetsAtLocalCoordinates(e,i,s);if(!G)return null;let H=Number.MAX_VALUE,z=H,W,Y,Z;for(let Q=0;Q<G.length;Q++)W=G[Q],Y=k[W],Z=N[W],v=(e-Z.x)*Y.x+(i-Z.y)*Y.y+(s-Z.z)*Y.z,(!a||a&&p&&v>=0||a&&!p&&v<=0)&&(v=Y.x*Z.x+Y.y*Z.y+Y.z*Z.z,S=-(Y.x*e+Y.y*i+Y.z*s-v)/(Y.x*Y.x+Y.y*Y.y+Y.z*Y.z),M=e+Y.x*S,F=i+Y.y*S,L=s+Y.z*S,g=M-e,y=F-i,b=L-s,z=g*g+y*y+b*b,z<H&&(H=z,_=W,n&&(n.x=M,n.y=F,n.z=L)));return _}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=!1,e.facetPositions=new Array,e.facetNormals=new Array,e.facetPartitioning=new Array,e.facetParameters=null,e.depthSortedIndices=new Uint32Array(0)),this}updateIndices(e,i,s=!1){return this}createNormals(e){const i=this.getVerticesData(te.PositionKind),s=this.getIndices();let n;return this.isVerticesDataPresent(te.NormalKind)?n=this.getVerticesData(te.NormalKind):n=[],Mt.ComputeNormals(i,s,n,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(te.NormalKind,n,e),this}alignWithNormal(e,i){i||(i=oa.Y);const s=ge.Vector3[0],n=ge.Vector3[1];return j.CrossToRef(i,e,n),j.CrossToRef(e,n,s),this.rotationQuaternion?Ve.RotationQuaternionFromAxisToRef(s,e,n,this.rotationQuaternion):j.RotationFromAxisToRef(s,e,n,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw xi("EdgesRenderer")}enableEdgesRendering(e,i,s){throw xi("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter(e=>e.emitter===this)}}Ds.OCCLUSION_TYPE_NONE=0,Ds.OCCLUSION_TYPE_OPTIMISTIC=1,Ds.OCCLUSION_TYPE_STRICT=2,Ds.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0,Ds.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1,Ds.CULLINGSTRATEGY_STANDARD=0,Ds.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,Ds.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,Ds.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,ur("BABYLON.AbstractMesh",Ds);class lr{static RegisterShaderCodeProcessing(e,i){if(!i){delete lr._CustomShaderCodeProcessing[e??""];return}lr._CustomShaderCodeProcessing[e??""]=i}static _GetShaderCodeProcessing(e){var i;return(i=lr._CustomShaderCodeProcessing[e])!==null&&i!==void 0?i:lr._CustomShaderCodeProcessing[""]}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(i=>{i.setSamples(this._samples)})}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,i,s,n,a,p,_=1,g,y,b=null,v=0,S="postprocess",M,F=!1,L=5,N=ks.GLSL){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.forceAutoClearInAlphaMode=!1,this.alphaMode=0,this.animations=new Array,this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new Ps(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new ii(1,1),this._texelSize=ii.Zero(),this.onActivateObservable=new Re,this.onSizeChangedObservable=new Re,this.onApplyObservable=new Re,this.onBeforeRenderObservable=new Re,this.onAfterRenderObservable=new Re,this.name=e,p!=null?(this._camera=p,this._scene=p.getScene(),p.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):g&&(this._engine=g,this._engine.postProcesses.push(this)),this._options=a,this.renderTargetSamplingMode=_||1,this._reusable=y||!1,this._textureType=v,this._textureFormat=L,this._shaderLanguage=N,this._samplers=n||[],this._samplers.push("textureSampler"),this._fragmentUrl=i,this._vertexUrl=S,this._parameters=s||[],this._parameters.push("scale"),this._indexParameters=M,this._drawWrapper=new ul(this._engine),F||this.updateEffect(b)}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){this._textures.length==0&&(this._textures=new Ps(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,i=null,s=null,n,a,p,_,g){var y,b;const v=lr._GetShaderCodeProcessing(this.name);if(v?.defineCustomBindings){const S=(y=i?.slice())!==null&&y!==void 0?y:[];S.push(...this._parameters);const M=(b=s?.slice())!==null&&b!==void 0?b:[];M.push(...this._samplers),e=v.defineCustomBindings(this.name,e,S,M),i=S,s=M}this._postProcessDefines=e,this._drawWrapper.effect=this._engine.createEffect({vertex:_??this._vertexUrl,fragment:g??this._fragmentUrl},{attributes:["position"],uniformsNames:i||this._parameters,uniformBuffersNames:[],samplers:s||this._samplers,defines:e!==null?e:"",fallbacks:null,onCompiled:a??null,onError:p??null,indexParameters:n||this._indexParameters,processCodeAfterIncludes:v?.processCodeAfterIncludes?(S,M)=>v.processCodeAfterIncludes(this.name,S,M):null,processFinalCode:v?.processFinalCode?(S,M)=>v.processFinalCode(this.name,S,M):null,shaderLanguage:this._shaderLanguage},this._engine)}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,i,s=0){for(let a=0;a<this._textureCache.length;a++)if(this._textureCache[a].texture.width===e.width&&this._textureCache[a].texture.height===e.height&&this._textureCache[a].postProcessChannel===s&&this._textureCache[a].texture._generateDepthBuffer===i.generateDepthBuffer&&this._textureCache[a].texture.samples===i.samples)return this._textureCache[a].texture;const n=this._engine.createRenderTargetTexture(e,i);return this._textureCache.push({texture:n,postProcessChannel:s,lastUsedRenderId:-1}),n}_flushTextureCache(){const e=this._renderId;for(let i=this._textureCache.length-1;i>=0;i--)if(e-this._textureCache[i].lastUsedRenderId>100){let s=!1;for(let n=0;n<this._textures.length;n++)if(this._textures.data[n]===this._textureCache[i].texture){s=!0;break}s||(this._textureCache[i].texture.dispose(),this._textureCache.splice(i,1))}}_resize(e,i,s,n,a){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=i;let p=null;for(let y=0;y<s._postProcesses.length;y++)if(s._postProcesses[y]!==null){p=s._postProcesses[y];break}const _={width:this.width,height:this.height},g={generateMipMaps:n,generateDepthBuffer:a||p===this,generateStencilBuffer:(a||p===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(_,g,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(_,g,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}activate(e,i=null,s){var n,a;e=e||this._camera;const p=e.getScene(),_=p.getEngine(),g=_.getCaps().maxTextureSize;let y=(i?i.width:this._engine.getRenderWidth(!0))*this._options|0;const b=(i?i.height:this._engine.getRenderHeight(!0))*this._options|0,v=e.parent;v&&(v.leftCamera==e||v.rightCamera==e)&&(y/=2);let S=this._options.width||y,M=this._options.height||b;const F=this.renderTargetSamplingMode!==7&&this.renderTargetSamplingMode!==1&&this.renderTargetSamplingMode!==2;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const N=_.currentViewport;N&&(S*=N.width,M*=N.height)}(F||this.alwaysForcePOT)&&(this._options.width||(S=_.needPOTTextures?Ae.GetExponentOfTwo(S,g,this.scaleMode):S),this._options.height||(M=_.needPOTTextures?Ae.GetExponentOfTwo(M,g,this.scaleMode):M)),(this.width!==S||this.height!==M)&&this._resize(S,M,e,F,s),this._textures.forEach(N=>{N.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(N,this.samples)}),this._flushTextureCache(),this._renderId++}let L;if(this._shareOutputWithPostProcess)L=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)L=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{L=this.inputTexture;let N;for(let k=0;k<this._textureCache.length;k++)if(this._textureCache[k].texture===L){N=this._textureCache[k];break}N&&(N.lastUsedRenderId=this._renderId)}return this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(y/S,b/M),this._engine.bindFramebuffer(L,0,y,b,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(L,0,void 0,void 0,this.forceFullscreenViewport)),(a=(n=this._engine)._debugInsertMarker)===null||a===void 0||a.call(n,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(e),this.autoClear&&(this.alphaMode===0||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:p.clearColor,p._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),L}get isSupported(){return this._drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){var e,i;return(i=(e=this._drawWrapper.effect)===null||e===void 0?void 0:e.isReady())!==null&&i!==void 0?i:!1}apply(){var e,i,s;if(!(!((e=this._drawWrapper.effect)===null||e===void 0)&&e.isReady()))return null;this._engine.enableEffect(this._drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a);let n;return this._shareOutputWithPostProcess?n=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?n=this._forcedOutputTexture:n=this.inputTexture,this.externalTextureSamplerBinding||this._drawWrapper.effect._bindTexture("textureSampler",n?.texture),this._drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._drawWrapper.effect),(s=(i=lr._GetShaderCodeProcessing(this.name))===null||i===void 0?void 0:i.bindCustomBindings)===null||s===void 0||s.call(i,this.name,this._drawWrapper.effect),this._drawWrapper.effect}_disposeTextures(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){this._disposeTextureCache();return}this._disposeTextureCache(),this._textures.dispose()}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return this._prePassEffectConfiguration?(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0):!1}dispose(e){e=e||this._camera,this._disposeTextures();let i;if(this._scene&&(i=this._scene.postProcesses.indexOf(this),i!==-1&&this._scene.postProcesses.splice(i,1)),this._parentContainer){const s=this._parentContainer.postProcesses.indexOf(this);s>-1&&this._parentContainer.postProcesses.splice(s,1),this._parentContainer=null}if(i=this._engine.postProcesses.indexOf(this),i!==-1&&this._engine.postProcesses.splice(i,1),!!e){if(e.detachPostProcess(this),i=e._postProcesses.indexOf(this),i===0&&e._postProcesses.length>0){const s=this._camera._getFirstPostProcess();s&&s.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}}serialize(){const e=Kt.Serialize(this),i=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=i?i.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const i=lr.Parse(e,this._scene,"");return i?(i.onActivateObservable=this.onActivateObservable.clone(),i.onSizeChangedObservable=this.onSizeChangedObservable.clone(),i.onApplyObservable=this.onApplyObservable.clone(),i.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),i.onAfterRenderObservable=this.onAfterRenderObservable.clone(),i._prePassEffectConfiguration=this._prePassEffectConfiguration,i):null}static Parse(e,i,s){const n=Ka(e.customType);if(!n||!n._Parse)return null;const a=i?i.getCameraById(e.cameraId):null;return n._Parse(e,a,i,s)}static _Parse(e,i,s,n){return Kt.Parse(()=>new lr(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,i,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat),e,s,n)}}lr._CustomShaderCodeProcessing={},J([xe()],lr.prototype,"uniqueId",void 0),J([xe()],lr.prototype,"name",void 0),J([xe()],lr.prototype,"width",void 0),J([xe()],lr.prototype,"height",void 0),J([xe()],lr.prototype,"renderTargetSamplingMode",void 0),J([CE()],lr.prototype,"clearColor",void 0),J([xe()],lr.prototype,"autoClear",void 0),J([xe()],lr.prototype,"forceAutoClearInAlphaMode",void 0),J([xe()],lr.prototype,"alphaMode",void 0),J([xe()],lr.prototype,"alphaConstants",void 0),J([xe()],lr.prototype,"enablePixelPerfectMode",void 0),J([xe()],lr.prototype,"forceFullscreenViewport",void 0),J([xe()],lr.prototype,"scaleMode",void 0),J([xe()],lr.prototype,"alwaysForcePOT",void 0),J([xe("samples")],lr.prototype,"_samples",void 0),J([xe()],lr.prototype,"adaptScaleToCurrentViewport",void 0),ur("BABYLON.PostProcess",lr);const T1="rgbdDecodePixelShader",E1=`varying vec2 vUV;
uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
gl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);
}`;Ye.ShadersStore[T1]=E1;const mj={name:T1,shader:E1},A1="passCubePixelShader",C1=`varying vec2 vUV;
uniform samplerCube textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
vec2 uv=vUV*2.0-1.0;
#ifdef POSITIVEX
gl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));
#endif
#ifdef NEGATIVEX
gl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));
#endif
#ifdef POSITIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));
#endif
#ifdef NEGATIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));
#endif
#ifdef POSITIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,1.001));
#endif
#ifdef NEGATIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));
#endif
}`;Ye.ShadersStore[A1]=C1;const _j={name:A1,shader:C1};class Qh extends lr{getClassName(){return"PassPostProcess"}constructor(e,i,s=null,n,a,p,_=0,g=!1){super(e,"pass",null,null,i,s,n,a,p,void 0,_,void 0,null,g)}static _Parse(e,i,s,n){return Kt.Parse(()=>new Qh(e.name,e.options,i,e.renderTargetSamplingMode,e._engine,e.reusable),e,s,n)}}ur("BABYLON.PassPostProcess",Qh);class R1 extends null{get face(){return this._face}set face(e){if(!(e<0||e>5))switch(this._face=e,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ");break}}getClassName(){return"PassCubePostProcess"}constructor(e,i,s=null,n,a,p,_=0,g=!1){super(e,"passCube",null,null,i,s,n,a,p,"#define POSITIVEX",_,void 0,null,g),this._face=0}static _Parse(e,i,s,n){return SerializationHelper.Parse(()=>new R1(e.name,e.options,i,e.renderTargetSamplingMode,e._engine,e.reusable),e,s,n)}}Ae._RescalePostProcessFactory=l=>new Qh("rescale",1,null,2,l,!1,0);function fW(l,e,i,s=!0){const n=l.getScene(),a=n.getEngine(),p=new zn("resized"+l.name,{width:e,height:i},n,!l.noMipmap,!0,l._texture.type,!1,l.samplingMode,!1);p.wrapU=l.wrapU,p.wrapV=l.wrapV,p.uOffset=l.uOffset,p.vOffset=l.vOffset,p.uScale=l.uScale,p.vScale=l.vScale,p.uAng=l.uAng,p.vAng=l.vAng,p.wAng=l.wAng,p.coordinatesIndex=l.coordinatesIndex,p.level=l.level,p.anisotropicFilteringLevel=l.anisotropicFilteringLevel,p._texture.isReady=!1,l.wrapU=Oe.CLAMP_ADDRESSMODE,l.wrapV=Oe.CLAMP_ADDRESSMODE;const _=new Qh("pass",1,null,s?Oe.BILINEAR_SAMPLINGMODE:Oe.NEAREST_SAMPLINGMODE,a,!1,0);return _.externalTextureSamplerBinding=!0,_.getEffect().executeWhenCompiled(()=>{_.onApply=function(y){y.setTexture("textureSampler",l)};const g=p.renderTarget;g&&(n.postProcessManager.directRender([_],g),a.unBindFramebuffer(g),p.disposeFramebufferObjects(),_.dispose(),p.getInternalTexture().isReady=!0)}),p}function I1(l,e,i,s,n,a,p,_){const g=e.getEngine();return e.isReady=!1,n=n??e.samplingMode,s=s??e.type,a=a??e.format,p=p??e.width,_=_??e.height,s===-1&&(s=0),new Promise(y=>{const b=new lr("postprocess",l,null,null,1,null,n,g,!1,void 0,s,void 0,null,!1,a);b.externalTextureSamplerBinding=!0;const v=g.createRenderTargetTexture({width:p,height:_},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:n,type:s,format:a});b.getEffect().executeWhenCompiled(()=>{b.onApply=S=>{S._bindTexture("textureSampler",e),S.setFloat2("scale",1,1)},i.postProcessManager.directRender([b],v,!0),g.restoreDefaultFramebuffer(),g._releaseTexture(e),b&&b.dispose(),v._swapAndDie(e),e.type=s,e.format=5,e.isReady=!0,y(e)})})}let D2,S1;function _l(l){D2||(D2=new Float32Array(1),S1=new Int32Array(D2.buffer)),D2[0]=l;const e=S1[0];let i=e>>16&32768,s=e>>12&2047;const n=e>>23&255;return n<103?i:n>142?(i|=31744,i|=(n==255?0:1)&&e&8388607,i):n<113?(s|=2048,i|=(s>>114-n)+(s>>113-n&1),i):(i|=n-112<<10|s>>1,i+=s&1,i)}function R0(l){const e=(l&32768)>>15,i=(l&31744)>>10,s=l&1023;return i===0?(e?-1:1)*Math.pow(2,-14)*(s/Math.pow(2,10)):i==31?s?NaN:(e?-1:1)*(1/0):(e?-1:1)*Math.pow(2,i-15)*(1+s/Math.pow(2,10))}const gj={CreateResizedCopy:fW,ApplyPostProcess:I1,ToHalfFloat:_l,FromHalfFloat:R0};class g_{static ExpandRGBDTexture(e){const i=e._texture;if(!i||!e.isRGBD)return;const s=i.getEngine(),n=s.getCaps(),a=i.isReady;let p=!1;n.textureHalfFloatRender&&n.textureHalfFloatLinearFiltering?(p=!0,i.type=2):n.textureFloatRender&&n.textureFloatLinearFiltering&&(p=!0,i.type=1),p&&(i.isReady=!1,i._isRGBD=!1,i.invertY=!1);const _=()=>{if(p){const g=new lr("rgbdDecode","rgbdDecode",null,null,1,null,3,s,!1,void 0,i.type,void 0,null,!1);g.externalTextureSamplerBinding=!0;const y=s.createRenderTargetTexture(i.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:i.samplingMode,type:i.type,format:5});g.getEffect().executeWhenCompiled(()=>{g.onApply=b=>{b._bindTexture("textureSampler",i),b.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([g],y,!0),s.restoreDefaultFramebuffer(),s._releaseTexture(i),g&&g.dispose(),y._swapAndDie(i),i.isReady=!0})}};a?_():e.onLoadObservable.addOnce(_)}static EncodeTextureToRGBD(e,i,s=0){return I1("rgbdEncode",e,i,s,1,5)}}const pW="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==";let mW=0;const y_=l=>{if(!l.environmentBRDFTexture){const e=l.useDelayedTextureLoading;l.useDelayedTextureLoading=!1;const i=l._blockEntityCollection;l._blockEntityCollection=!1;const s=Oe.CreateFromBase64String(pW,"EnvironmentBRDFTexture"+mW++,l,!0,!1,Oe.BILINEAR_SAMPLINGMODE);l._blockEntityCollection=i;const n=l.getEngine().getLoadedTexturesCache(),a=n.indexOf(s.getInternalTexture());a!==-1&&n.splice(a,1),s.isRGBD=!0,s.wrapU=Oe.CLAMP_ADDRESSMODE,s.wrapV=Oe.CLAMP_ADDRESSMODE,l.environmentBRDFTexture=s,l.useDelayedTextureLoading=e,g_.ExpandRGBDTexture(s);const p=l.getEngine().onContextRestoredObservable.add(()=>{s.isRGBD=!0;const _=()=>{s.isReady()?g_.ExpandRGBDTexture(s):Le.SetImmediate(_)};_()});l.onDisposeObservable.add(()=>{l.getEngine().onContextRestoredObservable.remove(p)})}return l.environmentBRDFTexture},yj={GetEnvironmentBRDFTexture:y_};class _W extends ja{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1}}class rn extends Ho{_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty()}constructor(e,i=!0){super(e,"PBRBRDF",90,new _W,i),this._useEnergyConservation=rn.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=rn.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=rn.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=rn.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=rn.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=rn.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=rn.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=rn.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],this._enable(!0)}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation}getClassName(){return"PBRBRDFConfiguration"}}rn.DEFAULT_USE_ENERGY_CONSERVATION=!0,rn.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0,rn.DEFAULT_USE_SPHERICAL_HARMONICS=!0,rn.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0,J([xe(),He("_markAllSubMeshesAsMiscDirty")],rn.prototype,"useEnergyConservation",void 0),J([xe(),He("_markAllSubMeshesAsMiscDirty")],rn.prototype,"useSmithVisibilityHeightCorrelated",void 0),J([xe(),He("_markAllSubMeshesAsMiscDirty")],rn.prototype,"useSphericalHarmonics",void 0),J([xe(),He("_markAllSubMeshesAsMiscDirty")],rn.prototype,"useSpecularGlossinessInputEnergyConservation",void 0);var Ic;(function(l){l[l.CW=0]="CW",l[l.CCW=1]="CCW"})(Ic||(Ic={}));class bj{static Interpolate(e,i,s,n,a){const p=1-3*n+3*i,_=3*n-6*i,g=3*i;let y=e;for(let b=0;b<5;b++){const v=y*y,S=v*y,M=p*S+_*v+g*y,F=1/(3*p*v+2*_*y+g);y-=(M-e)*F,y=Math.min(1,Math.max(0,y))}return 3*Math.pow(1-y,2)*y*s+3*(1-y)*Math.pow(y,2)*a+Math.pow(y,3)}}class Ax{constructor(e){this._radians=e,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return this._radians*180/Math.PI}radians(){return this._radians}static BetweenTwoPoints(e,i){const s=i.subtract(e),n=Math.atan2(s.y,s.x);return new Ax(n)}static FromRadians(e){return new Ax(e)}static FromDegrees(e){return new Ax(e*Math.PI/180)}}class gW{constructor(e,i,s){this.startPoint=e,this.midPoint=i,this.endPoint=s;const n=Math.pow(i.x,2)+Math.pow(i.y,2),a=(Math.pow(e.x,2)+Math.pow(e.y,2)-n)/2,p=(n-Math.pow(s.x,2)-Math.pow(s.y,2))/2,_=(e.x-i.x)*(i.y-s.y)-(i.x-s.x)*(e.y-i.y);this.centerPoint=new Vector2((a*(i.y-s.y)-p*(e.y-i.y))/_,((e.x-i.x)*p-(i.x-s.x)*a)/_),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=Ax.BetweenTwoPoints(this.centerPoint,this.startPoint);const g=this.startAngle.degrees();let y=Ax.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),b=Ax.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();y-g>180&&(y-=360),y-g<-180&&(y+=360),b-y>180&&(b-=360),b-y<-180&&(b+=360),this.orientation=y-g<0?Ic.CW:Ic.CCW,this.angle=Ax.FromDegrees(this.orientation===Ic.CW?g-b:b-g)}}class M1{constructor(e,i){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new Vector2(e,i))}addLineTo(e,i){if(this.closed)return this;const s=new Vector2(e,i),n=this._points[this._points.length-1];return this._points.push(s),this._length+=s.subtract(n).length(),this}addArcTo(e,i,s,n,a=36){if(this.closed)return this;const p=this._points[this._points.length-1],_=new Vector2(e,i),g=new Vector2(s,n),y=new gW(p,_,g);let b=y.angle.radians()/a;y.orientation===Ic.CW&&(b*=-1);let v=y.startAngle.radians()+b;for(let S=0;S<a;S++){const M=Math.cos(v)*y.radius+y.centerPoint.x,F=Math.sin(v)*y.radius+y.centerPoint.y;this.addLineTo(M,F),v+=b}return this}close(){return this.closed=!0,this}length(){let e=this._length;if(this.closed){const i=this._points[this._points.length-1];e+=this._points[0].subtract(i).length()}return e}getPoints(){return this._points}getPointAtLengthPosition(e){if(e<0||e>1)return Vector2.Zero();const i=e*this.length();let s=0;for(let n=0;n<this._points.length;n++){const a=(n+1)%this._points.length,p=this._points[n],g=this._points[a].subtract(p),y=g.length()+s;if(i>=s&&i<=y){const b=g.normalize(),v=i-s;return new Vector2(p.x+b.x*v,p.y+b.y*v)}s=y}return Vector2.Zero()}static StartingAt(e,i){return new M1(e,i)}}class P1{constructor(e,i=null,s,n=!1){this.path=e,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:Vector3.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:Matrix.Identity()};for(let a=0;a<e.length;a++)this._curve[a]=e[a].clone();this._raw=s||!1,this._alignTangentsWithPath=n,this._compute(i,n)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(e){return this._updatePointAtData(e).point}getTangentAt(e,i=!1){return this._updatePointAtData(e,i),i?Vector3.TransformCoordinates(Vector3.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(e,i=!1){return this._updatePointAtData(e,i),i?Vector3.TransformCoordinates(Vector3.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(e,i=!1){return this._updatePointAtData(e,i),i?Vector3.TransformCoordinates(Vector3.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(e){return this.length()*e}getPreviousPointIndexAt(e){return this._updatePointAtData(e),this._pointAtData.previousPointArrayIndex}getSubPositionAt(e){return this._updatePointAtData(e),this._pointAtData.subPosition}getClosestPositionTo(e){let i=Number.MAX_VALUE,s=0;for(let n=0;n<this._curve.length-1;n++){const a=this._curve[n+0],p=this._curve[n+1].subtract(a).normalize(),_=this._distances[n+1]-this._distances[n+0],g=Math.min(Math.max(Vector3.Dot(p,e.subtract(a).normalize()),0)*Vector3.Distance(a,e)/_,1),y=Vector3.Distance(a.add(p.scale(g*_)),e);y<i&&(i=y,s=(this._distances[n+0]+_*g)/this.length())}return s}slice(e=0,i=1){if(e<0&&(e=1-e*-1%1),i<0&&(i=1-i*-1%1),e>i){const y=e;e=i,i=y}const s=this.getCurve(),n=this.getPointAt(e);let a=this.getPreviousPointIndexAt(e);const p=this.getPointAt(i),_=this.getPreviousPointIndexAt(i)+1,g=[];return e!==0&&(a++,g.push(n)),g.push(...s.slice(a,_)),(i!==1||e===1)&&g.push(p),new P1(g,this.getNormalAt(e),this._raw,this._alignTangentsWithPath)}update(e,i=null,s=!1){for(let n=0;n<e.length;n++)this._curve[n].x=e[n].x,this._curve[n].y=e[n].y,this._curve[n].z=e[n].z;return this._compute(i,s),this}_compute(e,i=!1){const s=this._curve.length;if(s<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[s-1]=this._curve[s-1].subtract(this._curve[s-2]),this._raw||this._tangents[s-1].normalize();const n=this._tangents[0],a=this._normalVector(n,e);this._normals[0]=a,this._raw||this._normals[0].normalize(),this._binormals[0]=Vector3.Cross(n,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;let p,_,g,y,b;for(let v=1;v<s;v++)p=this._getLastNonNullVector(v),v<s-1&&(_=this._getFirstNonNullVector(v),this._tangents[v]=i?_:p.add(_),this._tangents[v].normalize()),this._distances[v]=this._distances[v-1]+this._curve[v].subtract(this._curve[v-1]).length(),g=this._tangents[v],b=this._binormals[v-1],this._normals[v]=Vector3.Cross(b,g),this._raw||(this._normals[v].length()===0?(y=this._normals[v-1],this._normals[v]=y.clone()):this._normals[v].normalize()),this._binormals[v]=Vector3.Cross(g,this._normals[v]),this._raw||this._binormals[v].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(e){let i=1,s=this._curve[e+i].subtract(this._curve[e]);for(;s.length()===0&&e+i+1<this._curve.length;)i++,s=this._curve[e+i].subtract(this._curve[e]);return s}_getLastNonNullVector(e){let i=1,s=this._curve[e].subtract(this._curve[e-i]);for(;s.length()===0&&e>i+1;)i++,s=this._curve[e].subtract(this._curve[e-i]);return s}_normalVector(e,i){let s,n=e.length();if(n===0&&(n=1),i==null){let a;Scalar.WithinEpsilon(Math.abs(e.y)/n,1,Epsilon)?Scalar.WithinEpsilon(Math.abs(e.x)/n,1,Epsilon)?Scalar.WithinEpsilon(Math.abs(e.z)/n,1,Epsilon)?a=Vector3.Zero():a=new Vector3(0,0,1):a=new Vector3(1,0,0):a=new Vector3(0,-1,0),s=Vector3.Cross(e,a)}else s=Vector3.Cross(e,i),Vector3.CrossToRef(s,e,s);return s.normalize(),s}_updatePointAtData(e,i=!1){if(this._pointAtData.id===e)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=e;const s=this.getPoints();if(e<=0)return this._setPointAtData(0,0,s[0],0,i);if(e>=1)return this._setPointAtData(1,1,s[s.length-1],s.length-1,i);let n=s[0],a,p=0;const _=e*this.length();for(let g=1;g<s.length;g++){a=s[g];const y=Vector3.Distance(n,a);if(p+=y,p===_)return this._setPointAtData(e,1,a,g,i);if(p>_){const v=(p-_)/y,S=n.subtract(a),M=a.add(S.scaleInPlace(v));return this._setPointAtData(e,1-v,M,g-1,i)}n=a}return this._pointAtData}_setPointAtData(e,i,s,n,a){return this._pointAtData.point=s,this._pointAtData.position=e,this._pointAtData.subPosition=i,this._pointAtData.previousPointArrayIndex=n,this._pointAtData.interpolateReady=a,a&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=Matrix.Identity();const e=this._pointAtData.previousPointArrayIndex;if(e!==this._tangents.length-1){const i=e+1,s=this._tangents[e].clone(),n=this._normals[e].clone(),a=this._binormals[e].clone(),p=this._tangents[i].clone(),_=this._normals[i].clone(),g=this._binormals[i].clone(),y=Quaternion.RotationQuaternionFromAxis(n,a,s),b=Quaternion.RotationQuaternionFromAxis(_,g,p);Quaternion.Slerp(y,b,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}class I0{static CreateQuadraticBezier(e,i,s,n){n=n>2?n:3;const a=new Array,p=(_,g,y,b)=>(1-_)*(1-_)*g+2*_*(1-_)*y+_*_*b;for(let _=0;_<=n;_++)a.push(new j(p(_/n,e.x,i.x,s.x),p(_/n,e.y,i.y,s.y),p(_/n,e.z,i.z,s.z)));return new I0(a)}static CreateCubicBezier(e,i,s,n,a){a=a>3?a:4;const p=new Array,_=(g,y,b,v,S)=>(1-g)*(1-g)*(1-g)*y+3*g*(1-g)*(1-g)*b+3*g*g*(1-g)*v+g*g*g*S;for(let g=0;g<=a;g++)p.push(new j(_(g/a,e.x,i.x,s.x,n.x),_(g/a,e.y,i.y,s.y,n.y),_(g/a,e.z,i.z,s.z,n.z)));return new I0(p)}static CreateHermiteSpline(e,i,s,n,a){const p=new Array,_=1/a;for(let g=0;g<=a;g++)p.push(j.Hermite(e,i,s,n,g*_));return new I0(p)}static CreateCatmullRomSpline(e,i,s){const n=new Array,a=1/i;let p=0;if(s){const _=e.length;for(let g=0;g<_;g++){p=0;for(let y=0;y<i;y++)n.push(j.CatmullRom(e[g%_],e[(g+1)%_],e[(g+2)%_],e[(g+3)%_],p)),p+=a}n.push(n[0])}else{const _=new Array;_.push(e[0].clone()),Array.prototype.push.apply(_,e),_.push(e[e.length-1].clone());let g=0;for(;g<_.length-3;g++){p=0;for(let y=0;y<i;y++)n.push(j.CatmullRom(_[g],_[g+1],_[g+2],_[g+3],p)),p+=a}g--,n.push(j.CatmullRom(_[g],_[g+1],_[g+2],_[g+3],p))}return new I0(n)}static ArcThru3Points(e,i,s,n=32,a=!1,p=!1){const _=new Array,g=i.subtract(e),y=s.subtract(i),b=e.subtract(s),v=j.Cross(g,y),S=v.length();if(S<Math.pow(10,-8))return new I0(_);const M=g.lengthSquared(),F=y.lengthSquared(),L=b.lengthSquared(),N=v.lengthSquared(),k=g.length(),G=y.length(),H=b.length(),z=.5*k*G*H/S,W=j.Dot(g,b),Y=j.Dot(g,y),Z=j.Dot(y,b),Q=-.5*F*W/N,se=-.5*L*Y/N,$=-.5*M*Z/N,oe=e.scale(Q).add(i.scale(se)).add(s.scale($)),de=e.subtract(oe).normalize(),ye=j.Cross(v,de).normalize();if(p){const _e=2*Math.PI/n;for(let we=0;we<=2*Math.PI;we+=_e)_.push(oe.add(de.scale(z*Math.cos(we)).add(ye.scale(z*Math.sin(we)))));_.push(e)}else{const _e=1/n;let we=0,Pe=j.Zero();do Pe=oe.add(de.scale(z*Math.cos(we)).add(ye.scale(z*Math.sin(we)))),_.push(Pe),we+=_e;while(!Pe.equalsWithEpsilon(s,z*_e*1.1));_.push(s),a&&_.push(e)}return new I0(_)}constructor(e){this._length=0,this._points=e,this._length=this._computeLength(e)}getPoints(){return this._points}length(){return this._length}continue(e){const i=this._points[this._points.length-1],s=this._points.slice(),n=e.getPoints();for(let p=1;p<n.length;p++)s.push(n[p].subtract(n[0]).add(i));return new I0(s)}_computeLength(e){let i=0;for(let s=1;s<e.length;s++)i+=e[s].subtract(e[s-1]).length();return i}}class O1{constructor(e=Vector3.Zero(),i=Vector3.Up()){this.position=e,this.normal=i}clone(){return new O1(this.position.clone(),this.normal.clone())}}class w1{constructor(e=Vector3.Zero(),i=Vector3.Up(),s=Vector2.Zero()){this.position=e,this.normal=i,this.uv=s}clone(){return new w1(this.position.clone(),this.normal.clone(),this.uv.clone())}}const Xo=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],yW=[()=>1,l=>l.y,l=>l.z,l=>l.x,l=>l.x*l.y,l=>l.y*l.z,l=>3*l.z*l.z-1,l=>l.x*l.z,l=>l.x*l.x-l.y*l.y],S0=(l,e)=>Xo[l]*yW[l](e),M0=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class Sc{constructor(){this.preScaled=!1,this.l00=j.Zero(),this.l1_1=j.Zero(),this.l10=j.Zero(),this.l11=j.Zero(),this.l2_2=j.Zero(),this.l2_1=j.Zero(),this.l20=j.Zero(),this.l21=j.Zero(),this.l22=j.Zero()}addLight(e,i,s){ge.Vector3[0].set(i.r,i.g,i.b);const n=ge.Vector3[0],a=ge.Vector3[1];n.scaleToRef(s,a),a.scaleToRef(S0(0,e),ge.Vector3[2]),this.l00.addInPlace(ge.Vector3[2]),a.scaleToRef(S0(1,e),ge.Vector3[2]),this.l1_1.addInPlace(ge.Vector3[2]),a.scaleToRef(S0(2,e),ge.Vector3[2]),this.l10.addInPlace(ge.Vector3[2]),a.scaleToRef(S0(3,e),ge.Vector3[2]),this.l11.addInPlace(ge.Vector3[2]),a.scaleToRef(S0(4,e),ge.Vector3[2]),this.l2_2.addInPlace(ge.Vector3[2]),a.scaleToRef(S0(5,e),ge.Vector3[2]),this.l2_1.addInPlace(ge.Vector3[2]),a.scaleToRef(S0(6,e),ge.Vector3[2]),this.l20.addInPlace(ge.Vector3[2]),a.scaleToRef(S0(7,e),ge.Vector3[2]),this.l21.addInPlace(ge.Vector3[2]),a.scaleToRef(S0(8,e),ge.Vector3[2]),this.l22.addInPlace(ge.Vector3[2])}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(M0[0]),this.l1_1.scaleInPlace(M0[1]),this.l10.scaleInPlace(M0[2]),this.l11.scaleInPlace(M0[3]),this.l2_2.scaleInPlace(M0[4]),this.l2_1.scaleInPlace(M0[5]),this.l20.scaleInPlace(M0[6]),this.l21.scaleInPlace(M0[7]),this.l22.scaleInPlace(M0[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(Xo[0]),this.l1_1.scaleInPlace(Xo[1]),this.l10.scaleInPlace(Xo[2]),this.l11.scaleInPlace(Xo[3]),this.l2_2.scaleInPlace(Xo[4]),this.l2_1.scaleInPlace(Xo[5]),this.l20.scaleInPlace(Xo[6]),this.l21.scaleInPlace(Xo[7]),this.l22.scaleInPlace(Xo[8])}updateFromArray(e){return j.FromArrayToRef(e[0],0,this.l00),j.FromArrayToRef(e[1],0,this.l1_1),j.FromArrayToRef(e[2],0,this.l10),j.FromArrayToRef(e[3],0,this.l11),j.FromArrayToRef(e[4],0,this.l2_2),j.FromArrayToRef(e[5],0,this.l2_1),j.FromArrayToRef(e[6],0,this.l20),j.FromArrayToRef(e[7],0,this.l21),j.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return j.FromFloatsToRef(e[0],e[1],e[2],this.l00),j.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),j.FromFloatsToRef(e[6],e[7],e[8],this.l10),j.FromFloatsToRef(e[9],e[10],e[11],this.l11),j.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),j.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),j.FromFloatsToRef(e[18],e[19],e[20],this.l20),j.FromFloatsToRef(e[21],e[22],e[23],this.l21),j.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return new Sc().updateFromArray(e)}static FromPolynomial(e){const i=new Sc;return i.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),i.l1_1=e.y.scale(.977204),i.l10=e.z.scale(.977204),i.l11=e.x.scale(.977204),i.l2_2=e.xy.scale(1.16538),i.l2_1=e.yz.scale(1.16538),i.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),i.l21=e.zx.scale(1.16538),i.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),i.l1_1.scaleInPlace(-1),i.l11.scaleInPlace(-1),i.l2_1.scaleInPlace(-1),i.l21.scaleInPlace(-1),i.scaleInPlace(Math.PI),i}}class Cx{constructor(){this.x=j.Zero(),this.y=j.Zero(),this.z=j.Zero(),this.xx=j.Zero(),this.yy=j.Zero(),this.zz=j.Zero(),this.xy=j.Zero(),this.yz=j.Zero(),this.zx=j.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=Sc.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){ge.Vector3[0].copyFromFloats(e.r,e.g,e.b);const i=ge.Vector3[0];this.xx.addInPlace(i),this.yy.addInPlace(i),this.zz.addInPlace(i)}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),ge.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),ge.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(ge.Vector3[0]).addInPlace(ge.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(ge.Vector3[0]).subtractInPlace(ge.Vector3[1]),this.zz.copyFrom(e.l00),ge.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(ge.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return new Cx().updateFromHarmonics(e)}static FromArray(e){const i=new Cx;return j.FromArrayToRef(e[0],0,i.x),j.FromArrayToRef(e[1],0,i.y),j.FromArrayToRef(e[2],0,i.z),j.FromArrayToRef(e[3],0,i.xx),j.FromArrayToRef(e[4],0,i.yy),j.FromArrayToRef(e[5],0,i.zz),j.FromArrayToRef(e[6],0,i.yz),j.FromArrayToRef(e[7],0,i.zx),j.FromArrayToRef(e[8],0,i.xy),i}}class Mc{constructor(e,i,s,n){this.name=e,this.worldAxisForNormal=i,this.worldAxisForFileX=s,this.worldAxisForFileY=n}}class b_{static ConvertCubeMapTextureToSphericalPolynomial(e){var i;if(!e.isCube)return null;(i=e.getScene())===null||i===void 0||i.getEngine().flushFramebuffer();const s=e.getSize().width,n=e.readPixels(0,void 0,void 0,!1),a=e.readPixels(1,void 0,void 0,!1);let p,_;e.isRenderTarget?(p=e.readPixels(3,void 0,void 0,!1),_=e.readPixels(2,void 0,void 0,!1)):(p=e.readPixels(2,void 0,void 0,!1),_=e.readPixels(3,void 0,void 0,!1));const g=e.readPixels(4,void 0,void 0,!1),y=e.readPixels(5,void 0,void 0,!1),b=e.gammaSpace,v=5;let S=0;return(e.textureType==1||e.textureType==2)&&(S=1),new Promise(M=>{Promise.all([a,n,p,_,g,y]).then(([F,L,N,k,G,H])=>{const z={size:s,right:L,left:F,up:N,down:k,front:G,back:H,format:v,type:S,gammaSpace:b};M(this.ConvertCubeMapToSphericalPolynomial(z))})})}static _AreaElement(e,i){return Math.atan2(e*i,Math.sqrt(e*e+i*i+1))}static ConvertCubeMapToSphericalPolynomial(e){const i=new Sc;let s=0;const n=2/e.size,a=n,p=.5*n,_=p-1;for(let S=0;S<6;S++){const M=this._FileFaces[S],F=e[M.name];let L=_;const N=e.format===5?4:3;for(let k=0;k<e.size;k++){let G=_;for(let H=0;H<e.size;H++){const z=M.worldAxisForFileX.scale(G).add(M.worldAxisForFileY.scale(L)).add(M.worldAxisForNormal);z.normalize();const W=this._AreaElement(G-p,L-p)-this._AreaElement(G-p,L+p)-this._AreaElement(G+p,L-p)+this._AreaElement(G+p,L+p);let Y=F[k*e.size*N+H*N+0],Z=F[k*e.size*N+H*N+1],Q=F[k*e.size*N+H*N+2];isNaN(Y)&&(Y=0),isNaN(Z)&&(Z=0),isNaN(Q)&&(Q=0),e.type===0&&(Y/=255,Z/=255,Q/=255),e.gammaSpace&&(Y=Math.pow(at.Clamp(Y),g2),Z=Math.pow(at.Clamp(Z),g2),Q=Math.pow(at.Clamp(Q),g2));const se=4096;Y=at.Clamp(Y,0,se),Z=at.Clamp(Z,0,se),Q=at.Clamp(Q,0,se);const $=new qe(Y,Z,Q);i.addLight(z,$,W),s+=W,G+=n}L+=a}}const v=4*Math.PI*6/6/s;return i.scaleInPlace(v),i.convertIncidentRadianceToIrradiance(),i.convertIrradianceToLambertianRadiance(),Cx.FromHarmonics(i)}}b_._FileFaces=[new Mc("right",new j(1,0,0),new j(0,0,-1),new j(0,-1,0)),new Mc("left",new j(-1,0,0),new j(0,0,1),new j(0,-1,0)),new Mc("up",new j(0,1,0),new j(1,0,0),new j(0,0,1)),new Mc("down",new j(0,-1,0),new j(1,0,0),new j(0,0,-1)),new Mc("front",new j(0,0,1),new j(1,0,0),new j(0,-1,0)),new Mc("back",new j(0,0,-1),new j(-1,0,0),new j(0,-1,0))],er.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)},Object.defineProperty(er.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=b_.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(l=>{this._texture._sphericalPolynomial=l,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(l){this._texture&&(this._texture._sphericalPolynomial=l)},enumerable:!0,configurable:!0});const D1="pbrFragmentDeclaration",F1=`uniform vec4 vEyePosition;
uniform vec3 vReflectionColor;
uniform vec4 vAlbedoColor;
uniform vec4 vLightingIntensity;
uniform vec4 vReflectivityColor;
uniform vec4 vMetallicReflectanceFactors;
uniform vec3 vEmissiveColor;
uniform float visibility;
uniform vec3 vAmbientColor;
#ifdef ALBEDO
uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform vec4 vAmbientInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform vec2 vTangentSpaceParams;
#endif
#ifdef OPACITY
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#ifdef REALTIME_FILTERING
uniform vec2 vReflectionFilteringInfo;
#endif
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;
uniform vec3 vReflectionSize; 
#endif
#endif
#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)
uniform vec3 vRefractionPosition;
uniform vec3 vRefractionSize; 
#endif
#ifdef CLEARCOAT
uniform vec2 vClearCoatParams;
uniform vec4 vClearCoatRefractionParams;
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;
uniform vec2 vClearCoatTangentSpaceParams;
uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT
uniform vec4 vClearCoatTintParams;
uniform float clearCoatColorAtDistance;
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;
uniform mat4 clearCoatTintMatrix;
#endif
#endif
#endif
#ifdef IRIDESCENCE
uniform vec4 vIridescenceParams;
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
uniform vec3 vAnisotropy;
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;
uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
uniform vec4 vSheenColor;
#ifdef SHEEN_ROUGHNESS
uniform float vSheenRoughness;
#endif
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionMicrosurfaceInfos;
uniform vec4 vRefractionInfos;
uniform mat4 refractionMatrix;
#ifdef REALTIME_FILTERING
uniform vec2 vRefractionFilteringInfo;
#endif
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;
uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;
uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;
uniform mat4 translucencyIntensityMatrix;
#endif
uniform vec2 vThicknessParam;
uniform vec3 vDiffusionDistance;
uniform vec4 vTintColor;
uniform vec3 vSubSurfaceIntensity;
#endif
#ifdef PREPASS
#ifdef SS_SCATTERING
uniform float scatteringDiffusionProfile;
#endif
#endif
#if DEBUGMODE>0
uniform vec2 vDebugMode;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;
uniform vec3 vSphericalL1_1;
uniform vec3 vSphericalL10;
uniform vec3 vSphericalL11;
uniform vec3 vSphericalL2_2;
uniform vec3 vSphericalL2_1;
uniform vec3 vSphericalL20;
uniform vec3 vSphericalL21;
uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;
uniform vec3 vSphericalY;
uniform vec3 vSphericalZ;
uniform vec3 vSphericalXX_ZZ;
uniform vec3 vSphericalYY_ZZ;
uniform vec3 vSphericalZZ;
uniform vec3 vSphericalXY;
uniform vec3 vSphericalYZ;
uniform vec3 vSphericalZX;
#endif
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;Ye.IncludesShadersStore[D1]=F1;const vj={name:D1,shader:F1},L1="pbrUboDeclaration",N1=`layout(std140,column_major) uniform;
uniform Material {
vec2 vAlbedoInfos;
vec4 vAmbientInfos;
vec2 vOpacityInfos;
vec2 vEmissiveInfos;
vec2 vLightmapInfos;
vec3 vReflectivityInfos;
vec2 vMicroSurfaceSamplerInfos;
vec2 vReflectionInfos;
vec2 vReflectionFilteringInfo;
vec3 vReflectionPosition;
vec3 vReflectionSize;
vec3 vBumpInfos;
mat4 albedoMatrix;
mat4 ambientMatrix;
mat4 opacityMatrix;
mat4 emissiveMatrix;
mat4 lightmapMatrix;
mat4 reflectivityMatrix;
mat4 microSurfaceSamplerMatrix;
mat4 bumpMatrix;
vec2 vTangentSpaceParams;
mat4 reflectionMatrix;
vec3 vReflectionColor;
vec4 vAlbedoColor;
vec4 vLightingIntensity;
vec3 vReflectionMicrosurfaceInfos;
float pointSize;
vec4 vReflectivityColor;
vec3 vEmissiveColor;
vec3 vAmbientColor;
vec2 vDebugMode;
vec4 vMetallicReflectanceFactors;
vec2 vMetallicReflectanceInfos;
mat4 metallicReflectanceMatrix;
vec2 vReflectanceInfos;
mat4 reflectanceMatrix;
vec3 vSphericalL00;
vec3 vSphericalL1_1;
vec3 vSphericalL10;
vec3 vSphericalL11;
vec3 vSphericalL2_2;
vec3 vSphericalL2_1;
vec3 vSphericalL20;
vec3 vSphericalL21;
vec3 vSphericalL22;
vec3 vSphericalX;
vec3 vSphericalY;
vec3 vSphericalZ;
vec3 vSphericalXX_ZZ;
vec3 vSphericalYY_ZZ;
vec3 vSphericalZZ;
vec3 vSphericalXY;
vec3 vSphericalYZ;
vec3 vSphericalZX;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;Ye.IncludesShadersStore[L1]=N1;const Tj={name:L1,shader:N1},B1="pbrFragmentExtraDeclaration",k1=`varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
`;Ye.IncludesShadersStore[B1]=k1;const Ej={name:B1,shader:k1},U1="samplerFragmentAlternateDeclaration",V1=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
#endif
`;Ye.IncludesShadersStore[U1]=V1;const Aj={name:U1,shader:V1},G1="pbrFragmentSamplersDeclaration",W1=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL)
uniform sampler2D clearCoatRoughnessSampler;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL)
uniform sampler2D sheenRoughnessSampler;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;
uniform samplerCube reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform samplerCube irradianceSampler;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D reflectionSamplerLow;
uniform sampler2D reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform sampler2D irradianceSampler;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
uniform sampler2D environmentBrdfSampler;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
#define sampleRefraction(s,c) textureCube(s,c)
uniform samplerCube refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube refractionSamplerLow;
uniform samplerCube refractionSamplerHigh;
#endif
#else
#define sampleRefraction(s,c) texture2D(s,c)
uniform sampler2D refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D refractionSamplerLow;
uniform sampler2D refractionSamplerHigh;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#endif
`;Ye.IncludesShadersStore[G1]=W1;const Cj={name:G1,shader:W1},z1="subSurfaceScatteringFunctions",H1=`bool testLightingForSSS(float diffusionProfile)
{
return diffusionProfile<1.;
}`;Ye.IncludesShadersStore[z1]=H1;const Rj={name:z1,shader:H1},X1="importanceSampling",Y1=`vec3 hemisphereCosSample(vec2 u) {
float phi=2.*PI*u.x;
float cosTheta2=1.-u.y;
float cosTheta=sqrt(cosTheta2);
float sinTheta=sqrt(1.-cosTheta2);
return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);
}
vec3 hemisphereImportanceSampleDggx(vec2 u,float a) {
float phi=2.*PI*u.x;
float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));
float cosTheta=sqrt(cosTheta2);
float sinTheta=sqrt(1.-cosTheta2);
return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);
}
vec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { 
float phi=2.*PI*u.x;
float sinTheta=pow(u.y,a/(2.*a+1.));
float cosTheta=sqrt(1.-sinTheta*sinTheta);
return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);
}`;Ye.IncludesShadersStore[X1]=Y1;const Ij={name:X1,shader:Y1},K1="pbrHelperFunctions",j1=`#define RECIPROCAL_PI2 0.15915494
#define RECIPROCAL_PI 0.31830988618
#define MINIMUMVARIANCE 0.0005
float convertRoughnessToAverageSlope(float roughness)
{
return square(roughness)+MINIMUMVARIANCE;
}
float fresnelGrazingReflectance(float reflectance0) {
float reflectance90=saturate(reflectance0*25.0);
return reflectance90;
}
vec2 getAARoughnessFactors(vec3 normalVector) {
#ifdef SPECULARAA
vec3 nDfdx=dFdx(normalVector.xyz);
vec3 nDfdy=dFdy(normalVector.xyz);
float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));
float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);
float geometricAlphaGFactor=sqrt(slopeSquare);
geometricAlphaGFactor*=0.75;
return vec2(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2(0.);
#endif
}
#ifdef ANISOTROPIC
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {
float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);
float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);
return vec2(alphaT,alphaB);
}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy) {
vec3 anisotropicFrameDirection=anisotropy>=0.0 ? B : T;
vec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);
vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);
vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));
return anisotropicNormal;
}
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
vec3 cocaLambert(vec3 alpha,float distance) {
return exp(-alpha*distance);
}
vec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {
return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));
}
vec3 computeColorAtDistanceInMedia(vec3 color,float distance) {
return -log(color)/distance;
}
vec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {
vec3 clearCoatAbsorption=mix(vec3(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);
return clearCoatAbsorption;
}
#endif
#ifdef MICROSURFACEAUTOMATIC
float computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)
{
const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;
float reflectivityLuminance=getLuminance(reflectivityColor);
float reflectivityLuma=sqrt(reflectivityLuminance);
microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;
return microSurface;
}
#endif
`;Ye.IncludesShadersStore[K1]=j1;const Sj={name:K1,shader:j1},q1="harmonicsFunctions",Z1=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
vec3 computeEnvironmentIrradiance(vec3 normal) {
return vSphericalL00
+ vSphericalL1_1*(normal.y)
+ vSphericalL10*(normal.z)
+ vSphericalL11*(normal.x)
+ vSphericalL2_2*(normal.y*normal.x)
+ vSphericalL2_1*(normal.y*normal.z)
+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ vSphericalL21*(normal.z*normal.x)
+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));
}
#else
vec3 computeEnvironmentIrradiance(vec3 normal) {
float Nx=normal.x;
float Ny=normal.y;
float Nz=normal.z;
vec3 C1=vSphericalZZ.rgb;
vec3 Cx=vSphericalX.rgb;
vec3 Cy=vSphericalY.rgb;
vec3 Cz=vSphericalZ.rgb;
vec3 Cxx_zz=vSphericalXX_ZZ.rgb;
vec3 Cyy_zz=vSphericalYY_ZZ.rgb;
vec3 Cxy=vSphericalXY.rgb;
vec3 Cyz=vSphericalYZ.rgb;
vec3 Czx=vSphericalZX.rgb;
vec3 a1=Cyy_zz*Ny+Cy;
vec3 a2=Cyz*Nz+a1;
vec3 b1=Czx*Nz+Cx;
vec3 b2=Cxy*Ny+b1;
vec3 b3=Cxx_zz*Nx+b2;
vec3 t1=Cz *Nz+C1;
vec3 t2=a2 *Ny+t1;
vec3 t3=b3 *Nx+t2;
return t3;
}
#endif
#endif
`;Ye.IncludesShadersStore[q1]=Z1;const Mj={name:q1,shader:Z1},Q1="pbrDirectLightingSetupFunctions",$1=`struct preLightingInfo
{
vec3 lightOffset;
float lightDistanceSquared;
float lightDistance;
float attenuation;
vec3 L;
vec3 H;
float NdotV;
float NdotLUnclamped;
float NdotL;
float VdotH;
float roughness;
#ifdef IRIDESCENCE
float iridescenceIntensity;
#endif
};
preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {
preLightingInfo result;
result.lightOffset=lightData.xyz-vPositionW;
result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);
result.lightDistance=sqrt(result.lightDistanceSquared);
result.L=normalize(result.lightOffset);
result.H=normalize(V+result.L);
result.VdotH=saturate(dot(V,result.H));
result.NdotLUnclamped=dot(N,result.L);
result.NdotL=saturateEps(result.NdotLUnclamped);
return result;
}
preLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {
preLightingInfo result;
result.lightDistance=length(-lightData.xyz);
result.L=normalize(-lightData.xyz);
result.H=normalize(V+result.L);
result.VdotH=saturate(dot(V,result.H));
result.NdotLUnclamped=dot(N,result.L);
result.NdotL=saturateEps(result.NdotLUnclamped);
return result;
}
preLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {
preLightingInfo result;
result.NdotL=dot(N,lightData.xyz)*0.5+0.5;
result.NdotL=saturateEps(result.NdotL);
result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);
result.H=normalize(V+result.L);
result.VdotH=saturate(dot(V,result.H));
#endif
return result;
}`;Ye.IncludesShadersStore[Q1]=$1;const Pj={name:Q1,shader:$1},J1="pbrDirectLightingFalloffFunctions",eR=`float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)
{
return max(0.,1.0-length(lightOffset)/range);
}
float computeDistanceLightFalloff_Physical(float lightDistanceSquared)
{
return 1.0/maxEps(lightDistanceSquared);
}
float computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)
{
float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);
float factor=lightDistanceSquared*inverseSquaredRange;
float attenuation=saturate(1.0-factor*factor);
attenuation*=attenuation;
lightDistanceFalloff*=attenuation;
return lightDistanceFalloff;
}
float computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
float computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)
{
float falloff=0.0;
float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));
if (cosAngle>=cosHalfAngle)
{
falloff=max(0.,pow(cosAngle,exponent));
}
return falloff;
}
float computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)
{
const float kMinusLog2ConeAngleIntensityRatio=6.64385618977; 
float concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);
vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);
float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));
return falloff;
}
float computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)
{
float cd=dot(-lightDirection,directionToLightCenterW);
float falloff=saturate(cd*lightAngleScale+lightAngleOffset);
falloff*=falloff;
return falloff;
}
float computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;Ye.IncludesShadersStore[J1]=eR;const Oj={name:J1,shader:eR},tR="pbrBRDFFunctions",iR=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);
}
#endif
#ifdef ENVIRONMENTBRDF
vec3 getBRDFLookup(float NdotV,float perceptualRoughness) {
vec2 UV=vec2(NdotV,perceptualRoughness);
vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup.rgb=fromRGBD(brdfLookup.rgba);
#endif
return brdfLookup.rgb;
}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;
}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;
}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
float getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)
{
float c=1.0-NdotV;
float c3=c*c*c;
return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));
}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
vec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{
float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);
return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));
}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
vec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {
vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;
return sheenEnvironmentReflectance;
}
#endif
vec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)
{
return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);
}
float fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)
{
return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);
}
#ifdef CLEARCOAT
vec3 getR0RemappedForClearCoat(vec3 f0) {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturate(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
vec3 s=sqrt(f0);
vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);
return square(t);
#endif
}
#endif
#ifdef IRIDESCENCE
const mat3 XYZ_TO_REC709=mat3(
3.2404542,-0.9692660, 0.0556434,
-1.5371385, 1.8760108,-0.2040259,
-0.4985314, 0.0415560, 1.0572252
);
vec3 getIORTfromAirToSurfaceR0(vec3 f0) {
vec3 sqrtF0=sqrt(f0);
return (1.+sqrtF0)/(1.-sqrtF0);
}
vec3 getR0fromIORs(vec3 iorT,float iorI) {
return square((iorT-vec3(iorI))/(iorT+vec3(iorI)));
}
float getR0fromIORs(float iorT,float iorI) {
return square((iorT-iorI)/(iorT+iorI));
}
vec3 evalSensitivity(float opd,vec3 shift) {
float phase=2.0*PI*opd*1.0e-9;
const vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);
const vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);
const vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);
vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);
xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));
xyz/=1.0685e-7;
vec3 srgb=XYZ_TO_REC709*xyz;
return srgb;
}
vec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {
vec3 I=vec3(1.0);
float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));
float sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));
float cosTheta2Sq=1.0-sinTheta2Sq;
if (cosTheta2Sq<0.0) {
return I;
}
float cosTheta2=sqrt(cosTheta2Sq);
float R0=getR0fromIORs(iridescenceIOR,outsideIOR);
float R12=fresnelSchlickGGX(cosTheta1,R0,1.);
float R21=R12;
float T121=1.0-R12;
float phi12=0.0;
if (iridescenceIOR<outsideIOR) phi12=PI;
float phi21=PI-phi12;
vec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); 
vec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);
vec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));
vec3 phi23=vec3(0.0);
if (baseIOR[0]<iridescenceIOR) phi23[0]=PI;
if (baseIOR[1]<iridescenceIOR) phi23[1]=PI;
if (baseIOR[2]<iridescenceIOR) phi23[2]=PI;
float opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;
vec3 phi=vec3(phi21)+phi23;
vec3 R123=clamp(R12*R23,1e-5,0.9999);
vec3 r123=sqrt(R123);
vec3 Rs=square(T121)*R23/(vec3(1.0)-R123);
vec3 C0=R12+Rs;
I=C0;
vec3 Cm=Rs-T121;
for (int m=1; m<=2; ++m)
{
Cm*=r123;
vec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);
I+=Cm*Sm;
}
return max(I,vec3(0.0));
}
#endif
float normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)
{
float a2=square(alphaG);
float d=NdotH*NdotH*(a2-1.0)+1.0;
return a2/(PI*d*d);
}
#ifdef SHEEN
float normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)
{
float invR=1./alphaG;
float cos2h=NdotH*NdotH;
float sin2h=1.-cos2h;
return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);
}
#endif
#ifdef ANISOTROPIC
float normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {
float a2=alphaTB.x*alphaTB.y;
vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);
float v2=dot(v,v);
float w2=a2/v2;
return a2*w2*w2*RECIPROCAL_PI;
}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {
#ifdef MOBILE
float GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);
float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);
return 0.5/(GGXV+GGXL);
#else
float a2=alphaG*alphaG;
float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);
float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);
return 0.5/(GGXV+GGXL);
#endif
}
#else
float smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
float alphaSquared=alphaG*alphaG;
return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
float smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)
{
float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);
return visibility;
}
#endif
#ifdef ANISOTROPIC
float smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {
float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));
float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));
float v=0.5/(lambdaV+lambdaL);
return v;
}
#endif
#ifdef CLEARCOAT
float visibility_Kelemen(float VdotH) {
return 0.25/(VdotH*VdotH); 
}
#endif
#ifdef SHEEN
float visibility_Ashikhmin(float NdotL,float NdotV)
{
return 1./(4.*(NdotL+NdotV-NdotL*NdotV));
}
/* NOT USED
#ifdef SHEEN_SOFTER
float l(float x,float alphaG)
{
float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);
float a=mix(21.5473,25.3245,oneMinusAlphaSq);
float b=mix(3.82987,3.32435,oneMinusAlphaSq);
float c=mix(0.19823,0.16801,oneMinusAlphaSq);
float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);
float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);
return a/(1.0+b*pow(x,c))+d*x+e;
}
float lambdaSheen(float cosTheta,float alphaG)
{
return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));
}
float visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)
{
float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));
return G/(4.0*NdotV*NdotL);
}
#endif
*/
#endif
float diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {
float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));
float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));
float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;
float fresnel =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);
return fresnel/PI;
}
#ifdef SS_TRANSLUCENCY
vec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {
vec3 S=1./maxEps(diffusionDistance);
vec3 temp=exp((-0.333333333*thickness)*S);
return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);
}
float computeWrappedDiffuseNdotL(float NdotL,float w) {
float t=1.0+w;
float invt2=1.0/square(t);
return saturate((NdotL+w)*invt2);
}
#endif
`;Ye.IncludesShadersStore[tR]=iR;const wj={name:tR,shader:iR},rR="hdrFilteringFunctions",sR=`#ifdef NUM_SAMPLES
#if NUM_SAMPLES>0
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
float radicalInverse_VdC(uint bits) 
{
bits=(bits<<16u) | (bits>>16u);
bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);
bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);
bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);
bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);
return float(bits)*2.3283064365386963e-10; 
}
vec2 hammersley(uint i,uint N)
{
return vec2(float(i)/float(N),radicalInverse_VdC(i));
}
#else
float vanDerCorpus(int n,int base)
{
float invBase=1.0/float(base);
float denom =1.0;
float result =0.0;
for(int i=0; i<32; ++i)
{
if(n>0)
{
denom =mod(float(n),2.0);
result+=denom*invBase;
invBase=invBase/2.0;
n =int(float(n)/2.0);
}
}
return result;
}
vec2 hammersley(int i,int N)
{
return vec2(float(i)/float(N),vanDerCorpus(i,2));
}
#endif
float log4(float x) {
return log2(x)/2.;
}
const float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);
const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;
const float K=4.;
#define inline
vec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{
vec3 n=normalize(inputN);
vec3 result=vec3(0.0);
vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);
tangent=normalize(cross(tangent,n));
vec3 bitangent=cross(n,tangent);
mat3 tbn=mat3(tangent,bitangent,n);
float maxLevel=filteringInfo.y;
float dim0=filteringInfo.x;
float omegaP=(4.*PI)/(6.*dim0*dim0);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{
vec2 Xi=hammersley(i,NUM_SAMPLES);
vec3 Ls=hemisphereCosSample(Xi);
Ls=normalize(Ls);
vec3 Ns=vec3(0.,0.,1.);
float NoL=dot(Ns,Ls);
if (NoL>0.) {
float pdf_inversed=PI/NoL;
float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;
float l=log4(omegaS)-log4(omegaP)+log4(K);
float mipLevel=clamp(l,0.0,maxLevel);
vec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c;
}
}
result=result*NUM_SAMPLES_FLOAT_INVERSED;
return result;
}
#define inline
vec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{
vec3 n=normalize(inputN);
if (alphaG==0.) {
vec3 c=textureCube(inputTexture,n).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;
} else {
vec3 result=vec3(0.);
vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);
tangent=normalize(cross(tangent,n));
vec3 bitangent=cross(n,tangent);
mat3 tbn=mat3(tangent,bitangent,n);
float maxLevel=filteringInfo.y;
float dim0=filteringInfo.x;
float omegaP=(4.*PI)/(6.*dim0*dim0);
float weight=0.;
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{
vec2 Xi=hammersley(i,NUM_SAMPLES);
vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);
float NoV=1.;
float NoH=H.z;
float NoH2=H.z*H.z;
float NoL=2.*NoH2-1.;
vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);
L=normalize(L);
if (NoL>0.) {
float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);
float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;
float l=log4(omegaS)-log4(omegaP)+log4(K);
float mipLevel=clamp(float(l),0.0,maxLevel);
weight+=NoL;
vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;
}
}
result=result/weight;
return result;
}
}
#endif
#endif
`;Ye.IncludesShadersStore[rR]=sR;const Dj={name:rR,shader:sR},nR="pbrDirectLightingFunctions",aR=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{
vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef CLEARCOAT
vec4 clearCoat;
#endif
#ifdef SHEEN
vec3 sheen;
#endif
};
float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
float lightRoughness=lightRadius/lightDistance;
float totalRoughness=saturate(lightRoughness+roughness);
return totalRoughness;
#else
return roughness;
#endif
}
vec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {
return mix(groundColor,lightColor,info.NdotL);
}
vec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {
float diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);
return diffuseTerm*info.attenuation*info.NdotL*lightColor;
}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){
vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);
strq/=strq.w;
vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;
return toLinearSpace(textureColor);
}
#ifdef SS_TRANSLUCENCY
vec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {
float NdotL=absEps(info.NdotLUnclamped);
float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);
float trAdapt=step(0.,info.NdotLUnclamped);
vec3 transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);
float diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);
return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;
}
#endif
#ifdef SPECULARTERM
vec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {
float NdotH=saturateEps(dot(N,info.H));
float roughness=max(info.roughness,geometricRoughnessFactor);
float alphaG=convertRoughnessToAverageSlope(roughness);
vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
float smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
vec3 specTerm=fresnel*distribution*smithVisibility;
return specTerm*info.attenuation*info.NdotL*lightColor;
}
#endif
#ifdef ANISOTROPIC
vec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {
float NdotH=saturateEps(dot(N,info.H));
float TdotH=dot(T,info.H);
float BdotH=dot(B,info.H);
float TdotV=dot(T,V);
float BdotV=dot(B,V);
float TdotL=dot(T,info.L);
float BdotL=dot(B,info.L);
float alphaG=convertRoughnessToAverageSlope(info.roughness);
vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);
alphaTB=max(alphaTB,square(geometricRoughnessFactor));
vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);
float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);
vec3 specTerm=fresnel*distribution*smithVisibility;
return specTerm*info.attenuation*info.NdotL*lightColor;
}
#endif
#ifdef CLEARCOAT
vec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {
float NccdotL=saturateEps(dot(Ncc,info.L));
float NccdotH=saturateEps(dot(Ncc,info.H));
float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);
float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);
fresnel*=clearCoatIntensity;
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);
float kelemenVisibility=visibility_Kelemen(info.VdotH);
float clearCoatTerm=fresnel*distribution*kelemenVisibility;
return vec4(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);
}
vec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {
vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);
float NdotLRefract=saturateEps(dot(Ncc,LRefract));
vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);
return absorption;
}
#endif
#ifdef SHEEN
vec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {
float NdotH=saturateEps(dot(N,info.H));
float roughness=max(info.roughness,geometricRoughnessFactor);
float alphaG=convertRoughnessToAverageSlope(roughness);
float fresnel=1.;
float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);
/*#ifdef SHEEN_SOFTER
float visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
float visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);
/* #endif */
float sheenTerm=fresnel*distribution*visibility;
return sheenTerm*info.attenuation*info.NdotL*lightColor;
}
#endif
`;Ye.IncludesShadersStore[nR]=aR;const Fj={name:nR,shader:aR},oR="pbrIBLFunctions",xR=`#if defined(REFLECTION) || defined(SS_REFRACTION)
float getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {
float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;
float lod=log2(microsurfaceAverageSlopeTexels);
return lod;
}
float getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {
float lod=log2(cubeMapDimensionPixels)*roughness;
return lod;
}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
float environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {
float temp=NdotVUnclamped+ambientOcclusion;
return saturate(square(temp)-1.0+ambientOcclusion);
}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
float environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {
vec3 reflection=reflect(view,normal);
float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));
return square(temp);
}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
#define UNPACK_LOD(x) (1.0-x)*255.0
float getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {
float microsurfaceAverageSlope=alphaG;
microsurfaceAverageSlope*=sqrt(abs(NdotV));
return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);
}
#endif
`;Ye.IncludesShadersStore[oR]=xR;const Lj={name:oR,shader:xR},lR="pbrBlockAlbedoOpacity",cR=`struct albedoOpacityOutParams
{
vec3 surfaceAlbedo;
float alpha;
};
#define pbr_inline
void albedoOpacityBlock(
in vec4 vAlbedoColor,
#ifdef ALBEDO
in vec4 albedoTexture,
in vec2 albedoInfos,
#endif
#ifdef OPACITY
in vec4 opacityMap,
in vec2 vOpacityInfos,
#endif
#ifdef DETAIL
in vec4 detailColor,
in vec4 vDetailInfos,
#endif
#ifdef DECAL
in vec4 decalColor,
in vec4 vDecalInfos,
#endif
out albedoOpacityOutParams outParams
)
{
vec3 surfaceAlbedo=vAlbedoColor.rgb;
float alpha=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpace(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#include<decalFragment>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
surfaceAlbedo*=vColor.rgb;
#endif
#ifdef DETAIL
float detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);
surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST
if (alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;
outParams.alpha=alpha;
}
`;Ye.IncludesShadersStore[lR]=cR;const Nj={name:lR,shader:cR},hR="pbrBlockReflectivity",uR=`struct reflectivityOutParams
{
float microSurface;
float roughness;
vec3 surfaceReflectivityColor;
#ifdef METALLICWORKFLOW
vec3 surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
vec3 ambientOcclusionColor;
#endif
#if DEBUGMODE>0
vec4 surfaceMetallicColorMap;
vec4 surfaceReflectivityColorMap;
vec2 metallicRoughness;
vec3 metallicF0;
#endif
};
#define pbr_inline
void reflectivityBlock(
in vec4 vReflectivityColor,
#ifdef METALLICWORKFLOW
in vec3 surfaceAlbedo,
in vec4 metallicReflectanceFactors,
#endif
#ifdef REFLECTIVITY
in vec3 reflectivityInfos,
in vec4 surfaceMetallicOrReflectivityColorMap,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
in vec3 ambientOcclusionColorIn,
#endif
#ifdef MICROSURFACEMAP
in vec4 microSurfaceTexel,
#endif
#ifdef DETAIL
in vec4 detailColor,
in vec4 vDetailInfos,
#endif
out reflectivityOutParams outParams
)
{
float microSurface=vReflectivityColor.a;
vec3 surfaceReflectivityColor=vReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec2 metallicRoughness=surfaceReflectivityColor.rg;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
vec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);
outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
float detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);
float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);
float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);
metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#if DEBUGMODE>0
outParams.metallicRoughness=metallicRoughness;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;
vec3 baseColor=surfaceAlbedo;
#ifdef FROSTBITE_REFLECTANCE
outParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);
surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);
#else
vec3 metallicF0=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=metallicF0;
#endif
outParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);
surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);
#endif
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;
microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
#endif
microSurface=saturate(microSurface);
float roughness=1.-microSurface;
outParams.microSurface=microSurface;
outParams.roughness=roughness;
outParams.surfaceReflectivityColor=surfaceReflectivityColor;
}
`;Ye.IncludesShadersStore[hR]=uR;const Bj={name:hR,shader:uR},dR="pbrBlockAmbientOcclusion",fR=`struct ambientOcclusionOutParams
{
vec3 ambientOcclusionColor;
#if DEBUGMODE>0
vec3 ambientOcclusionColorMap;
#endif
};
#define pbr_inline
void ambientOcclusionBlock(
#ifdef AMBIENT
in vec3 ambientOcclusionColorMap_,
in vec4 vAmbientInfos,
#endif
out ambientOcclusionOutParams outParams
)
{
vec3 ambientOcclusionColor=vec3(1.,1.,1.);
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;
}
`;Ye.IncludesShadersStore[dR]=fR;const kj={name:dR,shader:fR},pR="pbrBlockAlphaFresnel",mR=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{
float alpha;
};
#define pbr_inline
void alphaFresnelBlock(
in vec3 normalW,
in vec3 viewDirectionW,
in float alpha,
in float microSurface,
out alphaFresnelOutParams outParams
)
{
float opacityPerceptual=alpha;
#ifdef LINEARALPHAFRESNEL
float opacity0=opacityPerceptual;
#else
float opacity0=opacityPerceptual*opacityPerceptual;
#endif
float opacity90=fresnelGrazingReflectance(opacity0);
vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);
outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
}
#endif
#endif
`;Ye.IncludesShadersStore[pR]=mR;const Uj={name:pR,shader:mR},_R="pbrBlockAnisotropic",gR=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{
float anisotropy;
vec3 anisotropicTangent;
vec3 anisotropicBitangent;
vec3 anisotropicNormal;
#if DEBUGMODE>0
vec3 anisotropyMapData;
#endif
};
#define pbr_inline
void anisotropicBlock(
in vec3 vAnisotropy,
#ifdef ANISOTROPIC_TEXTURE
in vec3 anisotropyMapData,
#endif
in mat3 TBN,
in vec3 normalW,
in vec3 viewDirectionW,
out anisotropicOutParams outParams
)
{
float anisotropy=vAnisotropy.b;
vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
anisotropy*=anisotropyMapData.b;
anisotropyDirection.rg*=anisotropyMapData.rg*2.0-1.0;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
#endif
mat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));
vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);
vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));
outParams.anisotropy=anisotropy;
outParams.anisotropicTangent=anisotropicTangent;
outParams.anisotropicBitangent=anisotropicBitangent;
outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy);
}
#endif
`;Ye.IncludesShadersStore[_R]=gR;const Vj={name:_R,shader:gR},yR="pbrBlockReflection",bR=`#ifdef REFLECTION
struct reflectionOutParams
{
vec4 environmentRadiance;
vec3 environmentIrradiance;
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords;
#else
vec2 reflectionCoords;
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
vec3 irradianceVector;
#endif
#endif
#endif
};
#define pbr_inline
void createReflectionCoords(
in vec3 vPositionW,
in vec3 normalW,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REFLECTIONMAP_3D
out vec3 reflectionCoords
#else
out vec2 reflectionCoords
#endif
)
{
#ifdef ANISOTROPIC
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
}
#define pbr_inline
#define inline
void sampleReflectionTexture(
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
const vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
const vec2 reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out vec4 environmentRadiance
)
{
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
float automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);
float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);
#else
float requestedReflectionLOD=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#endif
#else
float lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));
float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;
vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);
if (lodReflectionNormalizedDoubled<1.0){
environmentRadiance=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);
} else {
environmentRadiance=mix(
environmentMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);
}
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif
environmentRadiance.rgb*=vReflectionInfos.x;
environmentRadiance.rgb*=vReflectionColor.rgb;
}
#define pbr_inline
#define inline
void reflectionBlock(
in vec3 vPositionW,
in vec3 normalW,
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
#else
in sampler2D reflectionSampler,
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
in vec3 vEnvironmentIrradiance,
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
in mat4 reflectionMatrix,
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
in samplerCube irradianceSampler,
#else
in sampler2D irradianceSampler,
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out reflectionOutParams outParams
)
{
vec4 environmentRadiance=vec4(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.);
#else
vec2 reflectionCoords=vec2(0.);
#endif
createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
reflectionCoords
);
sampleReflectionTexture(
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
#ifdef REFLECTIONMAP_3D
reflectionSampler,
reflectionCoords,
#else
reflectionSampler,
reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentRadiance
);
vec3 environmentIrradiance=vec3(0.,0.,0.);
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#ifdef ANISOTROPIC
vec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;
#else
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);
environmentIrradiance=environmentIrradiance4.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb;
outParams.environmentRadiance=environmentRadiance;
outParams.environmentIrradiance=environmentIrradiance;
outParams.reflectionCoords=reflectionCoords;
}
#endif
`;Ye.IncludesShadersStore[yR]=bR;const Gj={name:yR,shader:bR},vR="pbrBlockSheen",TR=`#ifdef SHEEN
struct sheenOutParams
{
float sheenIntensity;
vec3 sheenColor;
float sheenRoughness;
#ifdef SHEEN_LINKWITHALBEDO
vec3 surfaceAlbedo;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
float sheenAlbedoScaling;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 finalSheenRadianceScaled;
#endif
#if DEBUGMODE>0
vec4 sheenMapData;
vec3 sheenEnvironmentReflectance;
#endif
};
#define pbr_inline
#define inline
void sheenBlock(
in vec4 vSheenColor,
#ifdef SHEEN_ROUGHNESS
in float vSheenRoughness,
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
in vec4 sheenMapRoughnessData,
#endif
#endif
in float roughness,
#ifdef SHEEN_TEXTURE
in vec4 sheenMapData,
in float sheenMapLevel,
#endif
in float reflectance,
#ifdef SHEEN_LINKWITHALBEDO
in vec3 baseColor,
in vec3 surfaceAlbedo,
#endif
#ifdef ENVIRONMENTBRDF
in float NdotV,
in vec3 environmentBrdf,
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
in vec2 AARoughnessFactors,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
in vec4 vLightingIntensity,
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
in vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
in vec2 reflectionCoords,
#endif
in float NdotVUnclamped,
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
in float seo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
in float eho,
#endif
#endif
out sheenOutParams outParams
)
{
float sheenIntensity=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
float sheenFactor=pow5(1.0-sheenIntensity);
vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);
float sheenRoughness=sheenIntensity;
outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
vec3 sheenColor=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor.rgb*=toLinearSpace(sheenMapData.rgb);
#else
sheenColor.rgb*=sheenMapData.rgb;
#endif
sheenColor.rgb*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
float sheenRoughness=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
#ifdef SHEEN_TEXTURE_ROUGHNESS_IDENTICAL
sheenRoughness*=sheenMapData.a;
#else
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#endif
#else
float sheenRoughness=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
vec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
vec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);
#else
vec3 environmentSheenBrdf=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
float sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
vec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);
sampleReflectionTexture(
sheenAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
sheenRoughness,
#endif
reflectionSampler,
reflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentSheenRadiance
);
vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;
outParams.sheenColor=sheenColor;
outParams.sheenRoughness=sheenRoughness;
}
#endif
`;Ye.IncludesShadersStore[vR]=TR;const Wj={name:vR,shader:TR},ER="pbrBlockClearcoat",AR=`struct clearcoatOutParams
{
vec3 specularEnvironmentR0;
float conservationFactor;
vec3 clearCoatNormalW;
vec2 clearCoatAARoughnessFactors;
float clearCoatIntensity;
float clearCoatRoughness;
#ifdef REFLECTION
vec3 finalClearCoatRadianceScaled;
#endif
#ifdef CLEARCOAT_TINT
vec3 absorption;
float clearCoatNdotVRefract;
vec3 clearCoatColor;
float clearCoatThickness;
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
vec3 energyConservationFactorClearCoat;
#endif
#if DEBUGMODE>0
mat3 TBNClearCoat;
vec2 clearCoatMapData;
vec4 clearCoatTintMapData;
vec4 environmentClearCoatRadiance;
float clearCoatNdotV;
vec3 clearCoatEnvironmentReflectance;
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
#define inline
void clearcoatBlock(
in vec3 vPositionW,
in vec3 geometricNormalW,
in vec3 viewDirectionW,
in vec2 vClearCoatParams,
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
in vec4 clearCoatMapRoughnessData,
#endif
in vec3 specularEnvironmentR0,
#ifdef CLEARCOAT_TEXTURE
in vec2 clearCoatMapData,
#endif
#ifdef CLEARCOAT_TINT
in vec4 vClearCoatTintParams,
in float clearCoatColorAtDistance,
in vec4 vClearCoatRefractionParams,
#ifdef CLEARCOAT_TINT_TEXTURE
in vec4 clearCoatTintMapData,
#endif
#endif
#ifdef CLEARCOAT_BUMP
in vec2 vClearCoatBumpInfos,
in vec4 clearCoatBumpMapData,
in vec2 vClearCoatBumpUV,
#if defined(TANGENT) && defined(NORMAL)
in mat3 vTBN,
#else
in vec2 vClearCoatTangentSpaceParams,
#endif
#ifdef OBJECTSPACE_NORMALMAP
in mat4 normalMatrix,
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
in vec3 faceNormal,
#endif
#ifdef REFLECTION
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
in vec4 vLightingIntensity,
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
#else
in sampler2D reflectionSampler,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
in float ambientMonochrome,
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
in float frontFacingMultiplier,
#endif
out clearcoatOutParams outParams
)
{
float clearCoatIntensity=vClearCoatParams.x;
float clearCoatRoughness=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL
clearCoatRoughness*=clearCoatMapData.y;
#else
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
#endif
outParams.clearCoatIntensity=clearCoatIntensity;
outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
vec3 clearCoatColor=vClearCoatTintParams.rgb;
float clearCoatThickness=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);
outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
vec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
vec3 specularEnvironmentR0Updated=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);
vec3 clearCoatNormalW=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
float clearCoatNormalScale=1.0;
#else
float clearCoatNormalScale=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBNClearCoat=vTBN;
#else
vec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;
mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);
clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;
outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);
float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);
float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
vec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);
outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
vec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
float clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
vec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);
vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 clearCoatReflectionCoords=clearCoatReflectionVector;
#else
vec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
sampleReflectionTexture(
clearCoatAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
clearCoatNdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
clearCoatRoughness,
#endif
reflectionSampler,
clearCoatReflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentClearCoatRadiance
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);
clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
vec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
float fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);
fresnelIBLClearCoat*=clearCoatIntensity;
outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
}
#endif
`;Ye.IncludesShadersStore[ER]=AR;const zj={name:ER,shader:AR},CR="pbrBlockIridescence",RR=`struct iridescenceOutParams
{
float iridescenceIntensity;
float iridescenceIOR;
float iridescenceThickness;
vec3 specularEnvironmentR0;
};
#ifdef IRIDESCENCE
#define pbr_inline
#define inline
void iridescenceBlock(
in vec4 vIridescenceParams,
in float viewAngle,
in vec3 specularEnvironmentR0,
#ifdef IRIDESCENCE_TEXTURE
in vec2 iridescenceMapData,
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
in vec2 iridescenceThicknessMapData,
#endif
#ifdef CLEARCOAT
in float NdotVUnclamped,
#ifdef CLEARCOAT_TEXTURE
in vec2 clearCoatMapData,
#endif
#endif
out iridescenceOutParams outParams
)
{
float iridescenceIntensity=vIridescenceParams.x;
float iridescenceIOR=vIridescenceParams.y;
float iridescenceThicknessMin=vIridescenceParams.z;
float iridescenceThicknessMax=vIridescenceParams.w;
float iridescenceThicknessWeight=1.;
#ifdef IRIDESCENCE_TEXTURE
iridescenceIntensity*=iridescenceMapData.x;
#ifdef IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE
iridescenceThicknessWeight=iridescenceMapData.g;
#endif
#endif
#if defined(IRIDESCENCE_THICKNESS_TEXTURE)
iridescenceThicknessWeight=iridescenceThicknessMapData.g;
#endif
float iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);
float topIor=1.; 
#ifdef CLEARCOAT
float clearCoatIntensity=vClearCoatParams.x;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#endif
topIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);
viewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));
#endif
vec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);
outParams.iridescenceIntensity=iridescenceIntensity;
outParams.iridescenceThickness=iridescenceThickness;
outParams.iridescenceIOR=iridescenceIOR;
}
#endif
`;Ye.IncludesShadersStore[CR]=RR;const Hj={name:CR,shader:RR},IR="pbrBlockSubSurface",SR=`struct subSurfaceOutParams
{
vec3 specularEnvironmentReflectance;
#ifdef SS_REFRACTION
vec3 finalRefraction;
vec3 surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
float alpha;
#endif
#ifdef REFLECTION
float refractionFactorForIrradiance;
#endif
#endif
#ifdef SS_TRANSLUCENCY
vec3 transmittance;
float translucencyIntensity;
#ifdef REFLECTION
vec3 refractionIrradiance;
#endif
#endif
#if DEBUGMODE>0
vec4 thicknessMap;
vec4 environmentRefraction;
vec3 refractionTransmittance;
#endif
};
#ifdef SUBSURFACE
#define pbr_inline
#define inline
void subSurfaceBlock(
in vec3 vSubSurfaceIntensity,
in vec2 vThicknessParam,
in vec4 vTintColor,
in vec3 normalW,
in vec3 specularEnvironmentReflectance,
#ifdef SS_THICKNESSANDMASK_TEXTURE
in vec4 thicknessMap,
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
in vec4 refractionIntensityMap,
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
in vec4 translucencyIntensityMap,
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
in mat4 reflectionMatrix,
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
in vec3 irradianceVector_,
#endif
#if defined(REALTIME_FILTERING)
in samplerCube reflectionSampler,
in vec2 vReflectionFilteringInfo,
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
in samplerCube irradianceSampler,
#else
in sampler2D irradianceSampler,
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
in vec3 surfaceAlbedo,
#endif
#ifdef SS_REFRACTION
in vec3 vPositionW,
in vec3 viewDirectionW,
in mat4 view,
in vec4 vRefractionInfos,
in mat4 refractionMatrix,
in vec4 vRefractionMicrosurfaceInfos,
in vec4 vLightingIntensity,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
in float alpha,
#endif
#ifdef SS_LODINREFRACTIONALPHA
in float NdotVUnclamped,
#endif
#ifdef SS_LINEARSPECULARREFRACTION
in float roughness,
#endif
in float alphaG,
#ifdef SS_REFRACTIONMAP_3D
in samplerCube refractionSampler,
#ifndef LODBASEDMICROSFURACE
in samplerCube refractionSamplerLow,
in samplerCube refractionSamplerHigh,
#endif
#else
in sampler2D refractionSampler,
#ifndef LODBASEDMICROSFURACE
in sampler2D refractionSamplerLow,
in sampler2D refractionSamplerHigh,
#endif
#endif
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REALTIME_FILTERING
in vec2 vRefractionFilteringInfo,
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
in vec3 refractionPosition,
in vec3 refractionSize,
#endif
#endif
#ifdef SS_TRANSLUCENCY
in vec3 vDiffusionDistance,
#endif
out subSurfaceOutParams outParams
)
{
outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;
#ifdef SS_REFRACTION
float refractionIntensity=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);
outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
float translucencyIntensity=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#if defined(SS_USE_GLTF_TEXTURES)
float thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
float thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#ifdef SS_MASK_FROM_THICKNESS_TEXTURE
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE)
#if defined(SS_USE_GLTF_TEXTURES)
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE)
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
float thickness=vThicknessParam.y;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);
vec3 transmittance=transmittanceBRDF_Burley(vTintColor.rgb,vDiffusionDistance,thickness);
transmittance*=translucencyIntensity;
outParams.transmittance=transmittance;
outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef ANISOTROPIC
vec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,vRefractionInfos.y);
#else
vec3 refractionVector=refract(-viewDirectionW,normalW,vRefractionInfos.y);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;
vec3 refractionCoords=refractionVector;
refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
#endif
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;
refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef SS_HAS_THICKNESS
float ior=vRefractionInfos.y;
#else
float ior=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
float refractionAlphaG=alphaG;
refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));
float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
float refractionRoughness=alphaG;
refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));
float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
float refractionAlphaG=alphaG;
refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));
float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
#ifdef LODBASEDMICROSFURACE
refractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
float automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);
float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);
#else
float requestedRefractionLOD=refractionLOD;
#endif
#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)
environmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
float lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));
float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;
vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);
if (lodRefractionNormalizedDoubled<1.0){
environmentRefraction=mix(
sampleRefraction(refractionSamplerHigh,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);
} else {
environmentRefraction=mix(
environmentRefractionMid,
sampleRefraction(refractionSamplerLow,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);
}
#endif
#ifdef SS_RGBDREFRACTION
environmentRefraction.rgb=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
environmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);
#endif
environmentRefraction.rgb*=vRefractionInfos.x;
#endif
#ifdef SS_REFRACTION
vec3 refractionTransmittance=vec3(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);
refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
float maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);
vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);
environmentRefraction.rgb*=volumeAlbedo;
#else
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);
refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction.rgb*=surfaceAlbedo.rgb;
#endif
outParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);
#ifdef REFLECTION
outParams.refractionFactorForIrradiance=(1.-refractionIntensity);
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
vec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);
outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);
#endif
refractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
vec3 irradianceVector=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
vec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo);
#else
vec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec3 irradianceCoords=irradianceVector;
#else
vec2 irradianceCoords=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
vec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);
#ifdef RGBDREFLECTION
refractionIrradiance.rgb=fromRGBD(refractionIrradiance);
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);
#endif
#else
vec4 refractionIrradiance=vec4(0.);
#endif
refractionIrradiance.rgb*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance.rgb*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance.rgb;
#endif
}
#endif
`;Ye.IncludesShadersStore[IR]=SR;const Xj={name:IR,shader:SR},MR="pbrBlockNormalGeometric",PR=`vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#endif
vec3 geometricNormalW=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;
#endif
`;Ye.IncludesShadersStore[MR]=PR;const Yj={name:MR,shader:PR},OR="pbrBlockNormalFinal",wR=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
vec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=gl_FrontFacing ? faceNormal : -faceNormal;
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
`;Ye.IncludesShadersStore[OR]=wR;const Kj={name:OR,shader:wR},DR="pbrBlockLightmapInit",FR=`#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor.rgb=toLinearSpace(lightmapColor.rgb);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
`;Ye.IncludesShadersStore[DR]=FR;const jj={name:DR,shader:FR},LR="pbrBlockGeometryInfo",NR=`float NdotVUnclamped=dot(normalW,viewDirectionW);
float NdotV=absEps(NdotVUnclamped);
float alphaG=convertRoughnessToAverageSlope(roughness);
vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
vec3 environmentBrdf=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
float ambientMonochrome=aoOut.ambientOcclusionColor.r;
#else
float ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);
#endif
float seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;Ye.IncludesShadersStore[LR]=NR;const qj={name:LR,shader:NR},BR="pbrBlockReflectance0",kR=`float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);
vec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);
#else 
vec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);
#endif
#ifdef ALPHAFRESNEL
float reflectance90=fresnelGrazingReflectance(reflectance);
specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;Ye.IncludesShadersStore[BR]=kR;const Zj={name:BR,shader:kR},UR="pbrBlockReflectance",VR=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);
#ifdef RADIANCEOCCLUSION
specularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
specularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
vec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));
#endif
#ifdef CLEARCOAT
specularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
specularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;Ye.IncludesShadersStore[UR]=VR;const Qj={name:UR,shader:VR},GR="pbrBlockDirectLighting",WR=`vec3 diffuseBase=vec3(0.,0.,0.);
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
#ifdef CLEARCOAT
vec3 clearCoatBase=vec3(0.,0.,0.);
#endif
#ifdef SHEEN
vec3 sheenBase=vec3(0.,0.,0.);
#endif
preLightingInfo preInfo;
lightingInfo info;
float shadow=1.; 
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
vec3 absorption=vec3(0.);
#endif
`;Ye.IncludesShadersStore[GR]=WR;const $j={name:GR,shader:WR},zR="pbrBlockFinalLitComponents",HR=`#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef REFLECTION
vec3 finalIrradiance=reflectionOut.environmentIrradiance;
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);
finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
finalIrradiance*=surfaceAlbedo.rgb;
finalIrradiance*=vLightingIntensity.z;
finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase;
finalSpecular=max(finalSpecular,0.0);
vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
vec3 finalRadiance=reflectionOut.environmentRadiance.rgb;
finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;
vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
vec3 finalSheen=sheenBase*sheenOut.sheenColor;
finalSheen=max(finalSheen,0.0);
vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
vec3 finalClearCoat=clearCoatBase;
finalClearCoat=max(finalClearCoat,0.0);
vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
float luminanceOverAlpha=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;Ye.IncludesShadersStore[zR]=HR;const Jj={name:zR,shader:HR},XR="pbrBlockFinalUnlitComponents",YR=`vec3 finalDiffuse=diffuseBase;
finalDiffuse*=surfaceAlbedo.rgb;
finalDiffuse=max(finalDiffuse,0.0);
finalDiffuse*=vLightingIntensity.x;
vec3 finalAmbient=vAmbientColor;
finalAmbient*=surfaceAlbedo.rgb;
vec3 finalEmissive=vEmissiveColor;
#ifdef EMISSIVE
vec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpace(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= vEmissiveInfos.y;
#endif
finalEmissive*=vLightingIntensity.y;
#ifdef AMBIENT
vec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);
#else
vec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;
finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;Ye.IncludesShadersStore[XR]=YR;const eq={name:XR,shader:YR},KR="pbrBlockFinalColorComposition",jR=`vec4 finalColor=vec4(
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalAmbient +
finalDiffuse,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor.rgb*=lightmapColor.rgb;
#else
finalColor.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
finalColor.rgb+=finalEmissive;
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,0.0);
`;Ye.IncludesShadersStore[KR]=jR;const tq={name:KR,shader:jR},qR="pbrBlockImageProcessing",ZR=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor.rgb=clamp(finalColor.rgb,0.,30.0);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor.a*=visibility;
#ifdef PREMULTIPLYALPHA
finalColor.rgb*=finalColor.a;
#endif
`;Ye.IncludesShadersStore[qR]=ZR;const iq={name:qR,shader:ZR},QR="pbrDebug",$R=`#if DEBUGMODE>0
if (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {
#if DEBUGMODE==1
gl_FragColor.rgb=vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
gl_FragColor.rgb=vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
gl_FragColor.rgb=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
gl_FragColor.rgb=vec3(vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
gl_FragColor.rgb=vec3(vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
gl_FragColor.rgb=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
gl_FragColor.rgb=albedoTexture.rgb;
#elif DEBUGMODE==21 && defined(AMBIENT)
gl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
gl_FragColor.rgb=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
gl_FragColor.rgb=emissiveColorTex.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==24 && defined(LIGHTMAP)
gl_FragColor.rgb=lightmapColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
gl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
gl_FragColor.rgb=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
gl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
gl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
gl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
gl_FragColor.rgb=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
gl_FragColor.rgb=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
gl_FragColor.rgb=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
gl_FragColor.rgb=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==60
gl_FragColor.rgb=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
gl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
gl_FragColor.rgb=vec3(roughness);
#elif DEBUGMODE==64
gl_FragColor.rgb=vec3(alphaG);
#elif DEBUGMODE==65
gl_FragColor.rgb=vec3(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
gl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
gl_FragColor.rgb=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
gl_FragColor.rgb=vec3(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION)
gl_FragColor.rgb=vec3(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
gl_FragColor.rgb=vec3(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=specularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
gl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
gl_FragColor.rgb=vec3(luminanceOverAlpha);
#elif DEBUGMODE==87
gl_FragColor.rgb=vec3(alpha);
#endif
gl_FragColor.rgb*=vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
gl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
gl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);
#endif
gl_FragColor.a=1.0;
#ifdef PREPASS
gl_FragData[0]=toLinearSpace(gl_FragColor); 
gl_FragData[1]=vec4(0.,0.,0.,0.); 
#endif
return;
}
#endif
`;Ye.IncludesShadersStore[QR]=$R;const rq={name:QR,shader:$R},JR="pbrPixelShader",eI=`#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#extension GL_OES_standard_derivatives : enable
#endif
#ifdef LODBASEDMICROSFURACE
#extension GL_EXT_shader_texture_lod : enable
#endif
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
precision highp float;
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<__decl__pbrFragment>
#include<pbrFragmentExtraDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockIridescence>
#include<pbrBlockSubSurface>
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>
albedoOpacityOutParams albedoOpacityOut;
#ifdef ALBEDO
vec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#endif
#ifdef DECAL
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#endif
albedoOpacityBlock(
vAlbedoColor,
#ifdef ALBEDO
albedoTexture,
vAlbedoInfos,
#endif
#ifdef OPACITY
opacityMap,
vOpacityInfos,
#endif
#ifdef DETAIL
detailColor,
vDetailInfos,
#endif
#ifdef DECAL
decalColor,
vDecalInfos,
#endif
albedoOpacityOut
);
vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;
float alpha=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
ambientOcclusionOutParams aoOut;
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;
#endif
ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
vAmbientInfos,
#endif
aoOut
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
vec3 diffuseBase=vec3(1.,1.,1.);
#else
vec3 baseColor=surfaceAlbedo;
reflectivityOutParams reflectivityOut;
#if defined(REFLECTIVITY)
vec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);
vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
#ifdef REFLECTIVITY_GAMMA
surfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);
#endif
surfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;
#endif
#endif
#if defined(MICROSURFACEMAP)
vec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;
#endif
#ifdef METALLICWORKFLOW
vec4 metallicReflectanceFactors=vMetallicReflectanceFactors;
#ifdef REFLECTANCE
vec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);
#ifdef REFLECTANCE_GAMMA
reflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);
#endif
metallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;
#endif
#ifdef METALLIC_REFLECTANCE
vec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);
#ifdef METALLIC_REFLECTANCE_GAMMA
metallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);
#endif
#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY
metallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;
#endif
metallicReflectanceFactors*=metallicReflectanceFactorsMap.a;
#endif
#endif
reflectivityBlock(
vReflectivityColor,
#ifdef METALLICWORKFLOW
surfaceAlbedo,
metallicReflectanceFactors,
#endif
#ifdef REFLECTIVITY
vReflectivityInfos,
surfaceMetallicOrReflectivityColorMap,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor,
#endif
#ifdef MICROSURFACEMAP
microSurfaceTexel,
#endif
#ifdef DETAIL
detailColor,
vDetailInfos,
#endif
reflectivityOut
);
float microSurface=reflectivityOut.microSurface;
float roughness=reflectivityOut.roughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif
#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
alphaFresnelOutParams alphaFresnelOut;
alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface,
alphaFresnelOut
);
alpha=alphaFresnelOut.alpha;
#endif
#endif
#include<pbrBlockGeometryInfo>
#ifdef ANISOTROPIC
anisotropicOutParams anisotropicOut;
#ifdef ANISOTROPIC_TEXTURE
vec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;
#endif
anisotropicBlock(
vAnisotropy,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW,
anisotropicOut
);
#endif
#ifdef REFLECTION
reflectionOutParams reflectionOut;
#ifndef USE_CUSTOM_REFLECTION
reflectionBlock(
vPositionW,
normalW,
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
reflectionSampler,
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
vEnvironmentIrradiance,
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
reflectionMatrix,
#endif
#endif
#ifdef USEIRRADIANCEMAP
irradianceSampler,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
reflectionOut
);
#else
#define CUSTOM_REFLECTION
#endif
#endif
#include<pbrBlockReflectance0>
#ifdef SHEEN
sheenOutParams sheenOut;
#ifdef SHEEN_TEXTURE
vec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;
#endif
sheenBlock(
vSheenColor,
#ifdef SHEEN_ROUGHNESS
vSheenRoughness,
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
sheenMapRoughnessData,
#endif
#endif
roughness,
#ifdef SHEEN_TEXTURE
sheenMapData,
vSheenInfos.y,
#endif
reflectance,
#ifdef SHEEN_LINKWITHALBEDO
baseColor,
surfaceAlbedo,
#endif
#ifdef ENVIRONMENTBRDF
NdotV,
environmentBrdf,
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
AARoughnessFactors,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
vLightingIntensity,
reflectionSampler,
reflectionOut.reflectionCoords,
NdotVUnclamped,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
seo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
eho,
#endif
#endif
sheenOut
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;
#endif
#endif
#ifdef IRIDESCENCE
iridescenceOutParams iridescenceOut;
#ifdef IRIDESCENCE_TEXTURE
vec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
vec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;
#endif
iridescenceBlock(
vIridescenceParams,
NdotV,
specularEnvironmentR0,
#ifdef IRIDESCENCE_TEXTURE
iridescenceMapData,
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
iridescenceThicknessMapData,
#endif
#ifdef CLEARCOAT
NdotVUnclamped,
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData,
#endif
#endif
iridescenceOut
);
float iridescenceIntensity=iridescenceOut.iridescenceIntensity;
specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;
#endif
clearcoatOutParams clearcoatOut;
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);
#endif
#ifdef CLEARCOAT_BUMP
vec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);
#endif
clearcoatBlock(
vPositionW,
geometricNormalW,
viewDirectionW,
vClearCoatParams,
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatMapRoughnessData,
#endif
specularEnvironmentR0,
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData,
#endif
#ifdef CLEARCOAT_TINT
vClearCoatTintParams,
clearCoatColorAtDistance,
vClearCoatRefractionParams,
#ifdef CLEARCOAT_TINT_TEXTURE
clearCoatTintMapData,
#endif
#endif
#ifdef CLEARCOAT_BUMP
vClearCoatBumpInfos,
clearCoatBumpMapData,
vClearCoatBumpUV,
#if defined(TANGENT) && defined(NORMAL)
vTBN,
#else
vClearCoatTangentSpaceParams,
#endif
#ifdef OBJECTSPACE_NORMALMAP
normalMatrix,
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
faceNormal,
#endif
#ifdef REFLECTION
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
vLightingIntensity,
reflectionSampler,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
ambientMonochrome,
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
(gl_FrontFacing ? 1. : -1.),
#endif
clearcoatOut
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif
#include<pbrBlockReflectance>
subSurfaceOutParams subSurfaceOut;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
vec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
vec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);
#endif
subSurfaceBlock(
vSubSurfaceIntensity,
vThicknessParam,
vTintColor,
normalW,
specularEnvironmentReflectance,
#ifdef SS_THICKNESSANDMASK_TEXTURE
thicknessMap,
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
refractionIntensityMap,
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
translucencyIntensityMap,
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
reflectionMatrix,
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
reflectionOut.irradianceVector,
#endif
#if defined(REALTIME_FILTERING)
reflectionSampler,
vReflectionFilteringInfo,
#endif
#endif
#ifdef USEIRRADIANCEMAP
irradianceSampler,
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
surfaceAlbedo,
#endif
#ifdef SS_REFRACTION
vPositionW,
viewDirectionW,
view,
vRefractionInfos,
refractionMatrix,
vRefractionMicrosurfaceInfos,
vLightingIntensity,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha,
#endif
#ifdef SS_LODINREFRACTIONALPHA
NdotVUnclamped,
#endif
#ifdef SS_LINEARSPECULARREFRACTION
roughness,
#endif
alphaG,
refractionSampler,
#ifndef LODBASEDMICROSFURACE
refractionSamplerLow,
refractionSamplerHigh,
#endif
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#ifdef REALTIME_FILTERING
vRefractionFilteringInfo,
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
vRefractionPosition,
vRefractionSize,
#endif
#endif
#ifdef SS_TRANSLUCENCY
vDiffusionDistance,
#endif
subSurfaceOut
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;
#endif
#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]
#include<pbrBlockFinalLitComponents>
#endif 
#include<pbrBlockFinalUnlitComponents>
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=finalColor.a>0.4 ? 1.0 : 0.0;
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;
vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;
vec2 velocity=abs(a-b);
velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;
gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
vec3 sqAlbedo=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
vec3 irradiance=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
gl_FragData[0]=vec4(finalColor.rgb-irradiance,finalColor.a); 
irradiance/=sqAlbedo;
#else
gl_FragData[0]=finalColor; 
float scatteringDiffusionProfile=255.;
#endif
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); 
#else
gl_FragData[0]=vec4(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_NORMAL
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#ifndef UNLIT
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularEnvironmentR0,microSurface)*writeGeometryInfo;
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {
frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;
frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);
} else {
backColor+=finalColor;
}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;Ye.ShadersStore[JR]=eI;const sq={name:JR,shader:eI},tI="pbrVertexDeclaration",iI=`uniform mat4 view;
uniform mat4 viewProjection;
#ifdef ALBEDO
uniform mat4 albedoMatrix;
uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;
uniform vec4 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
uniform mat4 lightmapMatrix;
#endif
#ifdef REFLECTIVITY 
uniform vec3 vReflectivityInfos;
uniform mat4 reflectivityMatrix;
#endif
#ifdef METALLIC_REFLECTANCE
uniform vec2 vMetallicReflectanceInfos;
uniform mat4 metallicReflectanceMatrix;
#endif
#ifdef REFLECTANCE
uniform vec2 vReflectanceInfos;
uniform mat4 reflectanceMatrix;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
uniform mat4 microSurfaceSamplerMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform mat4 bumpMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
uniform mat4 reflectionMatrix;
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;
uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;
uniform mat4 clearCoatTintMatrix;
#endif
#endif
#ifdef IRIDESCENCE
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;
uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionInfos;
uniform mat4 refractionMatrix;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;
uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;
uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;
uniform mat4 translucencyIntensityMatrix;
#endif
#endif
#ifdef NORMAL
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;
uniform vec3 vSphericalL1_1;
uniform vec3 vSphericalL10;
uniform vec3 vSphericalL11;
uniform vec3 vSphericalL2_2;
uniform vec3 vSphericalL2_1;
uniform vec3 vSphericalL20;
uniform vec3 vSphericalL21;
uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;
uniform vec3 vSphericalY;
uniform vec3 vSphericalZ;
uniform vec3 vSphericalXX_ZZ;
uniform vec3 vSphericalYY_ZZ;
uniform vec3 vSphericalZZ;
uniform vec3 vSphericalXY;
uniform vec3 vSphericalYZ;
uniform vec3 vSphericalZX;
#endif
#endif
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;Ye.IncludesShadersStore[tI]=iI;const nq={name:tI,shader:iI},rI="pbrVertexShader",sI=`precision highp float;
#include<__decl__pbrVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)
#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)
#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
#ifdef CLEARCOAT
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)
#endif
#ifdef SUBSURFACE
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)
#endif
varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
vPositionW=vec3(worldPos);
#include<prePassVertex>
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));
vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
vec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vClipSpacePosition=gl_Position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#ifdef CLEARCOAT
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)
#endif
#ifdef SHEEN
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.z)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)
#endif
#ifdef SUBSURFACE
#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)
#endif
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;Ye.ShadersStore[rI]=sI;const aq={name:rI,shader:sI};class bW extends ja{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}}class Fs extends Ho{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,i=!0){super(e,"PBRClearCoat",100,new bW,i),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=Fs._DefaultIndexOfRefraction,this.indexOfRefraction=Fs._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=qe.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,i,s){if(!this._isEnabled)return!0;const n=this._material._disableBumpMap;return!(e._areTexturesDirty&&i.texturesEnabled&&(this._texture&&Ze.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&Ze.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()||s.getCaps().standardDerivatives&&this._bumpTexture&&Ze.ClearCoatBumpTextureEnabled&&!n&&!this._bumpTexture.isReady()||this._isTintEnabled&&this._tintTexture&&Ze.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking()))}prepareDefinesBeforeAttributes(e,i){var s;this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=this._texture!==null&&this._texture._texture===((s=this._textureRoughness)===null||s===void 0?void 0:s._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&i.texturesEnabled&&(this._texture&&Ze.ClearCoatTextureEnabled?nt.PrepareDefinesForMergedUV(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&Ze.ClearCoatTextureEnabled?nt.PrepareDefinesForMergedUV(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&Ze.ClearCoatBumpTextureEnabled?nt.PrepareDefinesForMergedUV(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===Fs._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&Ze.ClearCoatTintTextureEnabled?(nt.PrepareDefinesForMergedUV(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(e,i,s,n){var a,p,_,g,y,b,v,S;if(!this._isEnabled)return;const M=n.materialDefines,F=this._material.isFrozen,L=this._material._disableBumpMap,N=this._material._invertNormalMapX,k=this._material._invertNormalMapY,G=M.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL;if(!e.useUbo||!F||!e.isSync){G&&Ze.ClearCoatTextureEnabled?(e.updateFloat4("vClearCoatInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),nt.BindTextureMatrix(this._texture,e,"clearCoat")):(this._texture||this._textureRoughness)&&Ze.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",(p=(a=this._texture)===null||a===void 0?void 0:a.coordinatesIndex)!==null&&p!==void 0?p:0,(g=(_=this._texture)===null||_===void 0?void 0:_.level)!==null&&g!==void 0?g:0,(b=(y=this._textureRoughness)===null||y===void 0?void 0:y.coordinatesIndex)!==null&&b!==void 0?b:0,(S=(v=this._textureRoughness)===null||v===void 0?void 0:v.level)!==null&&S!==void 0?S:0),this._texture&&nt.BindTextureMatrix(this._texture,e,"clearCoat"),this._textureRoughness&&!G&&!M.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&nt.BindTextureMatrix(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&s.getCaps().standardDerivatives&&Ze.ClearCoatTextureEnabled&&!L&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),nt.BindTextureMatrix(this._bumpTexture,e,"clearCoatBump"),i._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",N?1:-1,k?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",N?-1:1,k?-1:1)),this._tintTexture&&Ze.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),nt.BindTextureMatrix(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);const H=1-this._indexOfRefraction,z=1+this._indexOfRefraction,W=Math.pow(-H/z,2),Y=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",W,Y,H,z),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}i.texturesEnabled&&(this._texture&&Ze.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!G&&!M.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&Ze.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&s.getCaps().standardDerivatives&&Ze.ClearCoatBumpTextureEnabled&&!L&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&Ze.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}hasTexture(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)}dispose(e){var i,s,n,a;e&&((i=this._texture)===null||i===void 0||i.dispose(),(s=this._textureRoughness)===null||s===void 0||s.dispose(),(n=this._bumpTexture)===null||n===void 0||n.dispose(),(a=this._tintTexture)===null||a===void 0||a.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(e,i,s){return e.CLEARCOAT_BUMP&&i.addFallback(s++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&i.addFallback(s++,"CLEARCOAT_TINT"),e.CLEARCOAT&&i.addFallback(s++,"CLEARCOAT"),s}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}}Fs._DefaultIndexOfRefraction=1.5,J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Fs.prototype,"isEnabled",void 0),J([xe()],Fs.prototype,"intensity",void 0),J([xe()],Fs.prototype,"roughness",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Fs.prototype,"indexOfRefraction",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Fs.prototype,"texture",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Fs.prototype,"useRoughnessFromMainTexture",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Fs.prototype,"textureRoughness",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Fs.prototype,"remapF0OnInterfaceChange",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Fs.prototype,"bumpTexture",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Fs.prototype,"isTintEnabled",void 0),J([Vs()],Fs.prototype,"tintColor",void 0),J([xe()],Fs.prototype,"tintColorAtDistance",void 0),J([xe()],Fs.prototype,"tintThickness",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Fs.prototype,"tintTexture",void 0);class vW extends ja{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0,this.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1}}class Hn extends Ho{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,i=!0){super(e,"PBRIridescence",110,new vW,i),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=Hn._DefaultMinimumThickness,this.maximumThickness=Hn._DefaultMaximumThickness,this.indexOfRefraction=Hn._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,i){return this._isEnabled?!(e._areTexturesDirty&&i.texturesEnabled&&(this._texture&&Ze.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._thicknessTexture&&Ze.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,i){var s;this._isEnabled?(e.IRIDESCENCE=!0,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=this._texture!==null&&this._texture._texture===((s=this._thicknessTexture)===null||s===void 0?void 0:s._texture)&&this._texture.checkTransformsAreIdentical(this._thicknessTexture),e._areTexturesDirty&&i.texturesEnabled&&(this._texture&&Ze.IridescenceTextureEnabled?nt.PrepareDefinesForMergedUV(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,!e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&this._thicknessTexture&&Ze.IridescenceTextureEnabled?nt.PrepareDefinesForMergedUV(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(e,i,s,n){var a,p,_,g,y,b,v,S;if(!this._isEnabled)return;const M=n.materialDefines,F=this._material.isFrozen,L=M.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE;(!e.useUbo||!F||!e.isSync)&&(L&&Ze.IridescenceTextureEnabled?(e.updateFloat4("vIridescenceInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),nt.BindTextureMatrix(this._texture,e,"iridescence")):(this._texture||this._thicknessTexture)&&Ze.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",(p=(a=this._texture)===null||a===void 0?void 0:a.coordinatesIndex)!==null&&p!==void 0?p:0,(g=(_=this._texture)===null||_===void 0?void 0:_.level)!==null&&g!==void 0?g:0,(b=(y=this._thicknessTexture)===null||y===void 0?void 0:y.coordinatesIndex)!==null&&b!==void 0?b:0,(S=(v=this._thicknessTexture)===null||v===void 0?void 0:v.level)!==null&&S!==void 0?S:0),this._texture&&nt.BindTextureMatrix(this._texture,e,"iridescence"),this._thicknessTexture&&!L&&!M.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&nt.BindTextureMatrix(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),i.texturesEnabled&&(this._texture&&Ze.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&!L&&!M.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&Ze.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)}dispose(e){var i,s;e&&((i=this._texture)===null||i===void 0||i.dispose(),(s=this._thicknessTexture)===null||s===void 0||s.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(e,i,s){return e.IRIDESCENCE&&i.addFallback(s++,"IRIDESCENCE"),s}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}}Hn._DefaultMinimumThickness=100,Hn._DefaultMaximumThickness=400,Hn._DefaultIndexOfRefraction=1.3,J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Hn.prototype,"isEnabled",void 0),J([xe()],Hn.prototype,"intensity",void 0),J([xe()],Hn.prototype,"minimumThickness",void 0),J([xe()],Hn.prototype,"maximumThickness",void 0),J([xe()],Hn.prototype,"indexOfRefraction",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Hn.prototype,"texture",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Hn.prototype,"thicknessTexture",void 0);class TW extends ja{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.MAINUV1=!1}}class $h extends Ho{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,i=!0){super(e,"PBRAnisotropic",110,new TW,i),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new ii(1,0),this._texture=null,this.texture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,i){return this._isEnabled?!(e._areTexturesDirty&&i.texturesEnabled&&this._texture&&Ze.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking()):!0}prepareDefinesBeforeAttributes(e,i,s){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!s.isVerticesDataPresent(te.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&i.texturesEnabled&&(this._texture&&Ze.AnisotropicTextureEnabled?nt.PrepareDefinesForMergedUV(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0)}bindForSubMesh(e,i){if(!this._isEnabled)return;const s=this._material.isFrozen;(!e.useUbo||!s||!e.isSync)&&(this._texture&&Ze.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),nt.BindTextureMatrix(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),i.texturesEnabled&&this._texture&&Ze.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture&&this._texture.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(e,i,s){return e.ANISOTROPIC&&i.addFallback(s++,"ANISOTROPIC"),s}getSamplers(e){e.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}}J([xe(),He("_markAllSubMeshesAsTexturesDirty")],$h.prototype,"isEnabled",void 0),J([xe()],$h.prototype,"intensity",void 0),J([i_()],$h.prototype,"direction",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],$h.prototype,"texture",void 0);class EW extends ja{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1}}class Yo extends Ho{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,i=!0){super(e,"Sheen",120,new EW,i),this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=qe.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,i){return this._isEnabled?!(e._areTexturesDirty&&i.texturesEnabled&&(this._texture&&Ze.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&Ze.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,i){var s;this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=this._roughness!==null,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=this._texture!==null&&this._texture._texture===((s=this._textureRoughness)===null||s===void 0?void 0:s._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e._areTexturesDirty&&i.texturesEnabled&&(this._texture&&Ze.SheenTextureEnabled?(nt.PrepareDefinesForMergedUV(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&Ze.SheenTextureEnabled?nt.PrepareDefinesForMergedUV(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(e,i,s,n){var a,p,_,g,y,b,v,S;if(!this._isEnabled)return;const M=n.materialDefines,F=this._material.isFrozen,L=M.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL;(!e.useUbo||!F||!e.isSync)&&(L&&Ze.SheenTextureEnabled?(e.updateFloat4("vSheenInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),nt.BindTextureMatrix(this._texture,e,"sheen")):(this._texture||this._textureRoughness)&&Ze.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",(p=(a=this._texture)===null||a===void 0?void 0:a.coordinatesIndex)!==null&&p!==void 0?p:0,(g=(_=this._texture)===null||_===void 0?void 0:_.level)!==null&&g!==void 0?g:0,(b=(y=this._textureRoughness)===null||y===void 0?void 0:y.coordinatesIndex)!==null&&b!==void 0?b:0,(S=(v=this._textureRoughness)===null||v===void 0?void 0:v.level)!==null&&S!==void 0?S:0),this._texture&&nt.BindTextureMatrix(this._texture,e,"sheen"),this._textureRoughness&&!L&&!M.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&nt.BindTextureMatrix(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),this._roughness!==null&&e.updateFloat("vSheenRoughness",this._roughness)),i.texturesEnabled&&(this._texture&&Ze.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!L&&!M.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&Ze.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)}dispose(e){var i,s;e&&((i=this._texture)===null||i===void 0||i.dispose(),(s=this._textureRoughness)===null||s===void 0||s.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(e,i,s){return e.SHEEN&&i.addFallback(s++,"SHEEN"),s}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}}J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Yo.prototype,"isEnabled",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Yo.prototype,"linkSheenWithAlbedo",void 0),J([xe()],Yo.prototype,"intensity",void 0),J([Vs()],Yo.prototype,"color",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Yo.prototype,"texture",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Yo.prototype,"useRoughnessFromMainTexture",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Yo.prototype,"roughness",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Yo.prototype,"textureRoughness",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Yo.prototype,"albedoScaling",void 0);class AW extends ja{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_SCATTERING=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_MASK_FROM_THICKNESS_TEXTURE=!1,this.SS_USE_GLTF_TEXTURES=!1}}class Ur extends Ho{get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){!this._scene.enableSubSurfaceForPrePass()||e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){e>=1?this._volumeIndexOfRefraction=e:this._volumeIndexOfRefraction=-1}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markScenePrePassDirty(){this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()}constructor(e,i=!0){super(e,"PBRSubSurface",130,new AW,i),this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=qe.White(),this.tintColorAtDistance=1,this.diffusionDistance=qe.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this._useGltfStyleTextures=!1,this.useGltfStyleTextures=!1,this._scene=e.getScene(),this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[32]}isReadyForSubMesh(e,i){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&i.texturesEnabled){if(this._thicknessTexture&&Ze.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1;const s=this._getRefractionTexture(i);if(s&&Ze.RefractionTextureEnabled&&!s.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,i){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled){e.SUBSURFACE=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_USE_GLTF_TEXTURES=!1;return}if(e._areTexturesDirty){e.SUBSURFACE=!0,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1;const s=!!this._thicknessTexture&&!!this._refractionIntensityTexture&&this._refractionIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._refractionIntensityTexture._texture===this._thicknessTexture._texture,n=!!this._thicknessTexture&&!!this._translucencyIntensityTexture&&this._translucencyIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._translucencyIntensityTexture._texture===this._thicknessTexture._texture,a=(s||!this._refractionIntensityTexture)&&(n||!this._translucencyIntensityTexture);if(e._areTexturesDirty&&i.texturesEnabled&&(this._thicknessTexture&&Ze.ThicknessTextureEnabled&&nt.PrepareDefinesForMergedUV(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&Ze.RefractionIntensityTextureEnabled&&!a&&nt.PrepareDefinesForMergedUV(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&Ze.TranslucencyIntensityTextureEnabled&&!a&&nt.PrepareDefinesForMergedUV(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE")),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!==0,e.SS_MASK_FROM_THICKNESS_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture||!!this._translucencyIntensityTexture)&&a,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture)&&a,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._translucencyIntensityTexture)&&a,this._isRefractionEnabled&&i.texturesEnabled){const p=this._getRefractionTexture(i);p&&Ze.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=p.isCube,e.SS_GAMMAREFRACTION=p.gammaSpace,e.SS_RGBDREFRACTION=p.isRGBD,e.SS_LINEARSPECULARREFRACTION=p.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=p.invertZ,e.SS_LODINREFRACTIONALPHA=p.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=p.isCube&&p.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(e,i,s,n){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;n.getRenderingMesh().getWorldMatrix().decompose(ge.Vector3[0]);const a=Math.max(Math.abs(ge.Vector3[0].x),Math.abs(ge.Vector3[0].y),Math.abs(ge.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*a,(this.maximumThickness-this.minimumThickness)*a)}bindForSubMesh(e,i,s,n){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;const a=n.materialDefines,p=this._material.isFrozen,_=this._material.realTimeFiltering,g=a.LODBASEDMICROSFURACE,y=this._getRefractionTexture(i);if(!e.useUbo||!p||!e.isSync){if(this._thicknessTexture&&Ze.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),nt.BindTextureMatrix(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&Ze.RefractionIntensityTextureEnabled&&a.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),nt.BindTextureMatrix(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyIntensityTexture&&Ze.TranslucencyIntensityTextureEnabled&&a.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),nt.BindTextureMatrix(this._translucencyIntensityTexture,e,"translucencyIntensity")),y&&Ze.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",y.getReflectionTextureMatrix());let b=1;y.isCube||y.depth&&(b=y.depth);const v=y.getSize().width,S=this.volumeIndexOfRefraction;if(e.updateFloat4("vRefractionInfos",y.level,1/S,b,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",v,y.lodGenerationScale,y.lodGenerationOffset,1/this.indexOfRefraction),_&&e.updateFloat2("vRefractionFilteringInfo",v,at.Log2(v)),y.boundingBoxSize){const M=y;e.updateVector3("vRefractionPosition",M.boundingBoxPosition),e.updateVector3("vRefractionSize",M.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0)}i.texturesEnabled&&(this._thicknessTexture&&Ze.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&Ze.RefractionIntensityTextureEnabled&&a.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&Ze.TranslucencyIntensityTextureEnabled&&a.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),y&&Ze.RefractionTextureEnabled&&(g?e.setTexture("refractionSampler",y):(e.setTexture("refractionSampler",y._lodTextureMid||y),e.setTexture("refractionSamplerLow",y._lodTextureLow||y),e.setTexture("refractionSamplerHigh",y._lodTextureHigh||y))))}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){Ze.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)}hasTexture(e){return this._thicknessTexture===e||this._refractionTexture===e}hasRenderTargetTextures(){return!!(Ze.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture)}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture)}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(e,i,s){return e.SS_SCATTERING&&i.addFallback(s++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&i.addFallback(s++,"SS_TRANSLUCENCY"),s}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"}]}}}J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Ur.prototype,"isRefractionEnabled",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Ur.prototype,"isTranslucencyEnabled",void 0),J([xe(),He("_markScenePrePassDirty")],Ur.prototype,"isScatteringEnabled",void 0),J([xe()],Ur.prototype,"_scatteringDiffusionProfileIndex",void 0),J([xe()],Ur.prototype,"refractionIntensity",void 0),J([xe()],Ur.prototype,"translucencyIntensity",void 0),J([xe()],Ur.prototype,"useAlbedoToTintRefraction",void 0),J([xe()],Ur.prototype,"useAlbedoToTintTranslucency",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Ur.prototype,"thicknessTexture",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Ur.prototype,"refractionTexture",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Ur.prototype,"indexOfRefraction",void 0),J([xe()],Ur.prototype,"_volumeIndexOfRefraction",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],Ur.prototype,"volumeIndexOfRefraction",null),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Ur.prototype,"invertRefractionY",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Ur.prototype,"linkRefractionWithTransparency",void 0),J([xe()],Ur.prototype,"minimumThickness",void 0),J([xe()],Ur.prototype,"maximumThickness",void 0),J([xe()],Ur.prototype,"useThicknessAsDepth",void 0),J([Vs()],Ur.prototype,"tintColor",void 0),J([xe()],Ur.prototype,"tintColorAtDistance",void 0),J([Vs()],Ur.prototype,"diffusionDistance",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Ur.prototype,"useMaskFromThicknessTexture",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Ur.prototype,"refractionIntensityTexture",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Ur.prototype,"translucencyIntensityTexture",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Ur.prototype,"useGltfStyleTextures",void 0);const Pc={effect:null,subMesh:null};class nI extends ja{constructor(e){super(e),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DEBUGMODE=0,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}}class mr extends qh{get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}constructor(e,i){super(e,i),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new xr(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=!1,this._albedoTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=mr.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=qe.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=!1,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new qe(0,0,0),this._albedoColor=new qe(1,1,1),this._reflectivityColor=new qe(1,1,1),this._reflectionColor=new qe(1,1,1),this._emissiveColor=new qe(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromAlbedoTexture=!1,this._useSpecularOverAlpha=!0,this._useMicroSurfaceFromReflectivityMapAlpha=!1,this._useRoughnessFromMetallicTextureAlpha=!0,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallnessFromMetallicTextureBlue=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useAmbientInGrayScale=!1,this._useAutoMicroSurfaceFromReflectivityMap=!1,this._lightFalloff=mr.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=!0,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._forceAlphaTest=!1,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._imageProcessingObserver=null,this._renderTargets=new Ps(16),this._globalAmbientColor=new qe(0,0,0),this._useLogarithmicDepth=!1,this._unlit=!1,this._debugMode=0,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=!1,this.brdf=new rn(this),this.clearCoat=new Fs(this),this.iridescence=new Hn(this),this.anisotropy=new $h(this),this.sheen=new Yo(this),this.subSurface=new Ur(this),this.detailMap=new Ex(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),Ze.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=y_(this.getScene()),this.prePassConfiguration=new Rc}get hasRenderTargetTextures(){return Ze.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported}get _disableAlphaBlending(){var e;return this._transparencyMode===mr.PBRMATERIAL_OPAQUE||this._transparencyMode===mr.PBRMATERIAL_ALPHATEST||((e=this.subSurface)===null||e===void 0?void 0:e.disableAlphaBlending)}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromAlbedoTexture()}needAlphaTesting(){var e;return this._forceAlphaTest?!0:!((e=this.subSurface)===null||e===void 0)&&e.disableAlphaBlending?!1:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===mr.PBRMATERIAL_ALPHATEST)}_shouldUseAlphaFromAlbedoTexture(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==mr.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,i,s){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),i.effect&&this.isFrozen&&i.effect._wasPreviouslyReady&&i.effect._wasPreviouslyUsingInstances===s)return!0;i.materialDefines||(this._callbackPluginEventGeneric(ws.GetDefineNames,this._eventInfo),i.materialDefines=new nI(this._eventInfo.defineNames));const n=i.materialDefines;if(this._isReadyForSubMesh(i))return!0;const a=this.getScene(),p=a.getEngine();if(n._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,a.texturesEnabled)){if(this._albedoTexture&&Ze.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking()||this._ambientTexture&&Ze.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking()||this._opacityTexture&&Ze.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;const v=this._getReflectionTexture();if(v&&Ze.ReflectionTextureEnabled&&(!v.isReadyOrNotBlocking()||v.irradianceTexture&&!v.irradianceTexture.isReadyOrNotBlocking())||this._lightmapTexture&&Ze.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking()||this._emissiveTexture&&Ze.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(Ze.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking()||this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking()||this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(p.getCaps().standardDerivatives&&this._bumpTexture&&Ze.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady()||this._environmentBRDFTexture&&Ze.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=n,this._eventInfo.subMesh=i,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh||n._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;!p.getCaps().standardDerivatives&&!e.isVerticesDataPresent(te.NormalKind)&&(e.createNormals(!0),Ie.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));const _=i.effect,g=n._areLightsDisposed;let y=this._prepareEffect(e,n,this.onCompiled,this.onError,s,null,i.getRenderingMesh().hasThinInstances),b=!1;if(y)if(this._onEffectCreatedObservable&&(Pc.effect=y,Pc.subMesh=i,this._onEffectCreatedObservable.notifyObservers(Pc)),this.allowShaderHotSwapping&&_&&!y.isReady()){if(y=_,n.markAsUnprocessed(),b=this.isFrozen,g)return n._areLightsDisposed=!0,!1}else a.resetCachedMaterial(),i.setEffect(y,n,this._materialContext);return!i.effect||!i.effect.isReady()?!1:(n._renderId=a.getRenderId(),i.effect._wasPreviouslyReady=!b,i.effect._wasPreviouslyUsingInstances=!!s,this._checkScenePerformancePriority(),!0)}isMetallicWorkflow(){return!!(this._metallic!=null||this._roughness!=null||this._metallicTexture)}_prepareEffect(e,i,s=null,n=null,a=null,p=null,_){if(this._prepareDefines(e,i,a,p,_),!i.isDirty)return null;i.markAsProcessed();const y=this.getScene().getEngine(),b=new Zh;let v=0;i.USESPHERICALINVERTEX&&b.addFallback(v++,"USESPHERICALINVERTEX"),i.FOG&&b.addFallback(v,"FOG"),i.SPECULARAA&&b.addFallback(v,"SPECULARAA"),i.POINTSIZE&&b.addFallback(v,"POINTSIZE"),i.LOGARITHMICDEPTH&&b.addFallback(v,"LOGARITHMICDEPTH"),i.PARALLAX&&b.addFallback(v,"PARALLAX"),i.PARALLAXOCCLUSION&&b.addFallback(v++,"PARALLAXOCCLUSION"),i.ENVIRONMENTBRDF&&b.addFallback(v++,"ENVIRONMENTBRDF"),i.TANGENT&&b.addFallback(v++,"TANGENT"),i.BUMP&&b.addFallback(v++,"BUMP"),v=nt.HandleFallbacksForShadows(i,b,this._maxSimultaneousLights,v++),i.SPECULARTERM&&b.addFallback(v++,"SPECULARTERM"),i.USESPHERICALFROMREFLECTIONMAP&&b.addFallback(v++,"USESPHERICALFROMREFLECTIONMAP"),i.USEIRRADIANCEMAP&&b.addFallback(v++,"USEIRRADIANCEMAP"),i.LIGHTMAP&&b.addFallback(v++,"LIGHTMAP"),i.NORMAL&&b.addFallback(v++,"NORMAL"),i.AMBIENT&&b.addFallback(v++,"AMBIENT"),i.EMISSIVE&&b.addFallback(v++,"EMISSIVE"),i.VERTEXCOLOR&&b.addFallback(v++,"VERTEXCOLOR"),i.MORPHTARGETS&&b.addFallback(v++,"MORPHTARGETS"),i.MULTIVIEW&&b.addFallback(0,"MULTIVIEW");const S=[te.PositionKind];i.NORMAL&&S.push(te.NormalKind),i.TANGENT&&S.push(te.TangentKind);for(let z=1;z<=6;++z)i["UV"+z]&&S.push(`uv${z===1?"":z}`);i.VERTEXCOLOR&&S.push(te.ColorKind),i.INSTANCESCOLOR&&S.push(te.ColorInstanceKind),nt.PrepareAttributesForBones(S,e,i,b),nt.PrepareAttributesForInstances(S,i),nt.PrepareAttributesForMorphTargets(S,e,i),nt.PrepareAttributesForBakedVertexAnimation(S,e,i);let M="pbr";const F=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],L=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],N=["Material","Scene","Mesh"];this._eventInfo.fallbacks=b,this._eventInfo.fallbackRank=v,this._eventInfo.defines=i,this._eventInfo.uniforms=F,this._eventInfo.attributes=S,this._eventInfo.samplers=L,this._eventInfo.uniformBuffersNames=N,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._callbackPluginEventGeneric(ws.PrepareEffect,this._eventInfo),Rc.AddUniforms(F),Rc.AddSamplers(L),O2(F),Oi&&(Oi.PrepareUniforms(F,i),Oi.PrepareSamplers(L,i)),nt.PrepareUniformsAndSamplersList({uniformsNames:F,uniformBuffersNames:N,samplers:L,defines:i,maxSimultaneousLights:this._maxSimultaneousLights});const k={};this.customShaderNameResolve&&(M=this.customShaderNameResolve(M,F,N,L,i,S,k));const G=i.toString(),H=y.createEffect(M,{attributes:S,uniformsNames:F,uniformBuffersNames:N,samplers:L,defines:G,fallbacks:b,onCompiled:s,onError:n,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:i.NUM_MORPH_INFLUENCERS},processFinalCode:k.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:i.PREPASS},y);return this._eventInfo.customCode=void 0,H}_prepareDefines(e,i,s=null,n=null,a=!1){var p;const _=this.getScene(),g=_.getEngine();nt.PrepareDefinesForLights(_,e,i,!0,this._maxSimultaneousLights,this._disableLighting),i._needNormals=!0,nt.PrepareDefinesForMultiview(_,i);const y=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(nt.PrepareDefinesForPrePass(_,i,this.canRenderToMRT&&!y),nt.PrepareDefinesForOIT(_,i,y),i.METALLICWORKFLOW=this.isMetallicWorkflow(),i._areTexturesDirty){i._needUVs=!1;for(let b=1;b<=6;++b)i["MAINUV"+b]=!1;if(_.texturesEnabled){i.ALBEDODIRECTUV=0,i.AMBIENTDIRECTUV=0,i.OPACITYDIRECTUV=0,i.EMISSIVEDIRECTUV=0,i.REFLECTIVITYDIRECTUV=0,i.MICROSURFACEMAPDIRECTUV=0,i.METALLIC_REFLECTANCEDIRECTUV=0,i.REFLECTANCEDIRECTUV=0,i.BUMPDIRECTUV=0,i.LIGHTMAPDIRECTUV=0,g.getCaps().textureLOD&&(i.LODBASEDMICROSFURACE=!0),this._albedoTexture&&Ze.DiffuseTextureEnabled?(nt.PrepareDefinesForMergedUV(this._albedoTexture,i,"ALBEDO"),i.GAMMAALBEDO=this._albedoTexture.gammaSpace):i.ALBEDO=!1,this._ambientTexture&&Ze.AmbientTextureEnabled?(nt.PrepareDefinesForMergedUV(this._ambientTexture,i,"AMBIENT"),i.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):i.AMBIENT=!1,this._opacityTexture&&Ze.OpacityTextureEnabled?(nt.PrepareDefinesForMergedUV(this._opacityTexture,i,"OPACITY"),i.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):i.OPACITY=!1;const b=this._getReflectionTexture();if(b&&Ze.ReflectionTextureEnabled){switch(i.REFLECTION=!0,i.GAMMAREFLECTION=b.gammaSpace,i.RGBDREFLECTION=b.isRGBD,i.LODINREFLECTIONALPHA=b.lodLevelInAlpha,i.LINEARSPECULARREFLECTION=b.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(i.NUM_SAMPLES=""+this.realTimeFilteringQuality,g._features.needTypeSuffixInShaderConstants&&(i.NUM_SAMPLES=i.NUM_SAMPLES+"u"),i.REALTIME_FILTERING=!0):i.REALTIME_FILTERING=!1,i.INVERTCUBICMAP=b.coordinatesMode===Oe.INVCUBIC_MODE,i.REFLECTIONMAP_3D=b.isCube,i.REFLECTIONMAP_OPPOSITEZ=i.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!b.invertZ:b.invertZ,i.REFLECTIONMAP_CUBIC=!1,i.REFLECTIONMAP_EXPLICIT=!1,i.REFLECTIONMAP_PLANAR=!1,i.REFLECTIONMAP_PROJECTION=!1,i.REFLECTIONMAP_SKYBOX=!1,i.REFLECTIONMAP_SPHERICAL=!1,i.REFLECTIONMAP_EQUIRECTANGULAR=!1,i.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,i.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,b.coordinatesMode){case Oe.EXPLICIT_MODE:i.REFLECTIONMAP_EXPLICIT=!0;break;case Oe.PLANAR_MODE:i.REFLECTIONMAP_PLANAR=!0;break;case Oe.PROJECTION_MODE:i.REFLECTIONMAP_PROJECTION=!0;break;case Oe.SKYBOX_MODE:i.REFLECTIONMAP_SKYBOX=!0;break;case Oe.SPHERICAL_MODE:i.REFLECTIONMAP_SPHERICAL=!0;break;case Oe.EQUIRECTANGULAR_MODE:i.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case Oe.FIXED_EQUIRECTANGULAR_MODE:i.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case Oe.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:i.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case Oe.CUBIC_MODE:case Oe.INVCUBIC_MODE:default:i.REFLECTIONMAP_CUBIC=!0,i.USE_LOCAL_REFLECTIONMAP_CUBIC=!!b.boundingBoxSize;break}b.coordinatesMode!==Oe.SKYBOX_MODE&&(b.irradianceTexture?(i.USEIRRADIANCEMAP=!0,i.USESPHERICALFROMREFLECTIONMAP=!1):b.isCube&&(i.USESPHERICALFROMREFLECTIONMAP=!0,i.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||g.getCaps().maxVaryingVectors<=8?i.USESPHERICALINVERTEX=!1:i.USESPHERICALINVERTEX=!0))}else i.REFLECTION=!1,i.REFLECTIONMAP_3D=!1,i.REFLECTIONMAP_SPHERICAL=!1,i.REFLECTIONMAP_PLANAR=!1,i.REFLECTIONMAP_CUBIC=!1,i.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,i.REFLECTIONMAP_PROJECTION=!1,i.REFLECTIONMAP_SKYBOX=!1,i.REFLECTIONMAP_EXPLICIT=!1,i.REFLECTIONMAP_EQUIRECTANGULAR=!1,i.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,i.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,i.INVERTCUBICMAP=!1,i.USESPHERICALFROMREFLECTIONMAP=!1,i.USEIRRADIANCEMAP=!1,i.USESPHERICALINVERTEX=!1,i.REFLECTIONMAP_OPPOSITEZ=!1,i.LODINREFLECTIONALPHA=!1,i.GAMMAREFLECTION=!1,i.RGBDREFLECTION=!1,i.LINEARSPECULARREFLECTION=!1;if(this._lightmapTexture&&Ze.LightmapTextureEnabled?(nt.PrepareDefinesForMergedUV(this._lightmapTexture,i,"LIGHTMAP"),i.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,i.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,i.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):i.LIGHTMAP=!1,this._emissiveTexture&&Ze.EmissiveTextureEnabled?(nt.PrepareDefinesForMergedUV(this._emissiveTexture,i,"EMISSIVE"),i.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):i.EMISSIVE=!1,Ze.SpecularTextureEnabled){if(this._metallicTexture?(nt.PrepareDefinesForMergedUV(this._metallicTexture,i,"REFLECTIVITY"),i.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,i.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,i.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,i.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,i.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?(nt.PrepareDefinesForMergedUV(this._reflectivityTexture,i,"REFLECTIVITY"),i.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,i.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,i.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):i.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture){const v=this._metallicReflectanceTexture!==null&&this._metallicReflectanceTexture._texture===((p=this._reflectanceTexture)===null||p===void 0?void 0:p._texture)&&this._metallicReflectanceTexture.checkTransformsAreIdentical(this._reflectanceTexture);i.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture&&!v,this._metallicReflectanceTexture?(nt.PrepareDefinesForMergedUV(this._metallicReflectanceTexture,i,"METALLIC_REFLECTANCE"),i.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):i.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&!v&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?(nt.PrepareDefinesForMergedUV(this._reflectanceTexture,i,"REFLECTANCE"),i.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):i.REFLECTANCE=!1}else i.METALLIC_REFLECTANCE=!1,i.REFLECTANCE=!1;this._microSurfaceTexture?nt.PrepareDefinesForMergedUV(this._microSurfaceTexture,i,"MICROSURFACEMAP"):i.MICROSURFACEMAP=!1}else i.REFLECTIVITY=!1,i.MICROSURFACEMAP=!1;g.getCaps().standardDerivatives&&this._bumpTexture&&Ze.BumpTextureEnabled&&!this._disableBumpMap?(nt.PrepareDefinesForMergedUV(this._bumpTexture,i,"BUMP"),this._useParallax&&this._albedoTexture&&Ze.DiffuseTextureEnabled?(i.PARALLAX=!0,i.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):i.PARALLAX=!1,i.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(i.BUMP=!1,i.PARALLAX=!1,i.PARALLAXOCCLUSION=!1,i.OBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&Ze.ReflectionTextureEnabled?(i.ENVIRONMENTBRDF=!0,i.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(i.ENVIRONMENTBRDF=!1,i.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?i.ALPHAFROMALBEDO=!0:i.ALPHAFROMALBEDO=!1}i.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===mr.LIGHTFALLOFF_STANDARD?(i.USEPHYSICALLIGHTFALLOFF=!1,i.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===mr.LIGHTFALLOFF_GLTF?(i.USEPHYSICALLIGHTFALLOFF=!1,i.USEGLTFLIGHTFALLOFF=!0):(i.USEPHYSICALLIGHTFALLOFF=!0,i.USEGLTFLIGHTFALLOFF=!1),i.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?i.TWOSIDEDLIGHTING=!0:i.TWOSIDEDLIGHTING=!1,i.SPECULARAA=g.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(i._areTexturesDirty||i._areMiscDirty)&&(i.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1===0?".":""}`,i.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,i.ALPHABLEND=this.needAlphaBlendingForMesh(e),i.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,i.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),i._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(i),i.FORCENORMALFORWARD=this._forceNormalForward,i.RADIANCEOCCLUSION=this._useRadianceOcclusion,i.HORIZONOCCLUSION=this._useHorizonOcclusion,i._areMiscDirty&&(nt.PrepareDefinesForMisc(e,_,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,i),i.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(te.NormalKind),i.DEBUGMODE=this._debugMode),nt.PrepareDefinesForFrameBoundValues(_,g,this,i,!!s,n,a),this._eventInfo.defines=i,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),nt.PrepareDefinesForAttributes(e,i,!0,!0,!0,this._transparencyMode!==mr.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}forceCompilation(e,i,s){const n={clipPlane:!1,useInstances:!1,...s};this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(ws.GetDefineNames,this._eventInfo);const a=new nI(this._eventInfo.defineNames),p=this._prepareEffect(e,a,void 0,void 0,n.useInstances,n.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(Pc.effect=p,Pc.subMesh=null,this._onEffectCreatedObservable.notifyObservers(Pc)),p.isReady()?i&&i(this):p.onCompileObservable.add(()=>{i&&i(this)})}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),super.buildUniformLayout()}bindForSubMesh(e,i,s){var n,a,p,_;const g=this.getScene(),y=s.materialDefines;if(!y)return;const b=s.effect;if(!b)return;this._activeEffect=b,i.getMeshUniformBuffer().bindToEffect(b,"Mesh"),i.transferToEffect(e);const v=g.getEngine();this._uniformBuffer.bindToEffect(b,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,g,i,e,this.isFrozen),this._eventInfo.subMesh=s,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),y.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const S=b._forceRebindOnNextCall||this._mustRebind(g,b,i.visibility);nt.BindBonesParameters(i,this._activeEffect,this.prePassConfiguration);let M=null;const F=this._uniformBuffer;if(S){if(this.bindViewProjection(b),M=this._getReflectionTexture(),!F.useUbo||!this.isFrozen||!F.isSync||b._forceRebindOnNextCall){if(g.texturesEnabled){if(this._albedoTexture&&Ze.DiffuseTextureEnabled&&(F.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),nt.BindTextureMatrix(this._albedoTexture,F,"albedo")),this._ambientTexture&&Ze.AmbientTextureEnabled&&(F.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),nt.BindTextureMatrix(this._ambientTexture,F,"ambient")),this._opacityTexture&&Ze.OpacityTextureEnabled&&(F.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),nt.BindTextureMatrix(this._opacityTexture,F,"opacity")),M&&Ze.ReflectionTextureEnabled){if(F.updateMatrix("reflectionMatrix",M.getReflectionTextureMatrix()),F.updateFloat2("vReflectionInfos",M.level,0),M.boundingBoxSize){const L=M;F.updateVector3("vReflectionPosition",L.boundingBoxPosition),F.updateVector3("vReflectionSize",L.boundingBoxSize)}if(this.realTimeFiltering){const L=M.getSize().width;F.updateFloat2("vReflectionFilteringInfo",L,at.Log2(L))}if(!y.USEIRRADIANCEMAP){const L=M.sphericalPolynomial;if(y.USESPHERICALFROMREFLECTIONMAP&&L)if(y.SPHERICAL_HARMONICS){const N=L.preScaledHarmonics;F.updateVector3("vSphericalL00",N.l00),F.updateVector3("vSphericalL1_1",N.l1_1),F.updateVector3("vSphericalL10",N.l10),F.updateVector3("vSphericalL11",N.l11),F.updateVector3("vSphericalL2_2",N.l2_2),F.updateVector3("vSphericalL2_1",N.l2_1),F.updateVector3("vSphericalL20",N.l20),F.updateVector3("vSphericalL21",N.l21),F.updateVector3("vSphericalL22",N.l22)}else F.updateFloat3("vSphericalX",L.x.x,L.x.y,L.x.z),F.updateFloat3("vSphericalY",L.y.x,L.y.y,L.y.z),F.updateFloat3("vSphericalZ",L.z.x,L.z.y,L.z.z),F.updateFloat3("vSphericalXX_ZZ",L.xx.x-L.zz.x,L.xx.y-L.zz.y,L.xx.z-L.zz.z),F.updateFloat3("vSphericalYY_ZZ",L.yy.x-L.zz.x,L.yy.y-L.zz.y,L.yy.z-L.zz.z),F.updateFloat3("vSphericalZZ",L.zz.x,L.zz.y,L.zz.z),F.updateFloat3("vSphericalXY",L.xy.x,L.xy.y,L.xy.z),F.updateFloat3("vSphericalYZ",L.yz.x,L.yz.y,L.yz.z),F.updateFloat3("vSphericalZX",L.zx.x,L.zx.y,L.zx.z)}F.updateFloat3("vReflectionMicrosurfaceInfos",M.getSize().width,M.lodGenerationScale,M.lodGenerationOffset)}this._emissiveTexture&&Ze.EmissiveTextureEnabled&&(F.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),nt.BindTextureMatrix(this._emissiveTexture,F,"emissive")),this._lightmapTexture&&Ze.LightmapTextureEnabled&&(F.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),nt.BindTextureMatrix(this._lightmapTexture,F,"lightmap")),Ze.SpecularTextureEnabled&&(this._metallicTexture?(F.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),nt.BindTextureMatrix(this._metallicTexture,F,"reflectivity")):this._reflectivityTexture&&(F.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),nt.BindTextureMatrix(this._reflectivityTexture,F,"reflectivity")),this._metallicReflectanceTexture&&(F.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),nt.BindTextureMatrix(this._metallicReflectanceTexture,F,"metallicReflectance")),this._reflectanceTexture&&y.REFLECTANCE&&(F.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),nt.BindTextureMatrix(this._reflectanceTexture,F,"reflectance")),this._microSurfaceTexture&&(F.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),nt.BindTextureMatrix(this._microSurfaceTexture,F,"microSurfaceSampler"))),this._bumpTexture&&v.getCaps().standardDerivatives&&Ze.BumpTextureEnabled&&!this._disableBumpMap&&(F.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),nt.BindTextureMatrix(this._bumpTexture,F,"bump"),g._mirroredCameraPosition?F.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):F.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&F.updateFloat("pointSize",this.pointSize),y.METALLICWORKFLOW){ji.Color3[0].r=this._metallic===void 0||this._metallic===null?1:this._metallic,ji.Color3[0].g=this._roughness===void 0||this._roughness===null?1:this._roughness,F.updateColor4("vReflectivityColor",ji.Color3[0],1);const L=(a=(n=this.subSurface)===null||n===void 0?void 0:n._indexOfRefraction)!==null&&a!==void 0?a:1.5,N=1,k=Math.pow((L-N)/(L+N),2);this._metallicReflectanceColor.scaleToRef(k*this._metallicF0Factor,ji.Color3[0]);const G=this._metallicF0Factor;F.updateColor4("vMetallicReflectanceFactors",ji.Color3[0],G)}else F.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);F.updateColor3("vEmissiveColor",Ze.EmissiveTextureEnabled?this._emissiveColor:qe.BlackReadOnly),F.updateColor3("vReflectionColor",this._reflectionColor),!y.SS_REFRACTION&&((p=this.subSurface)===null||p===void 0?void 0:p._linkRefractionWithTransparency)?F.updateColor4("vAlbedoColor",this._albedoColor,1):F.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*g.environmentIntensity,this._lightingInfos.w=this._specularIntensity,F.updateVector4("vLightingIntensity",this._lightingInfos),g.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),F.updateColor3("vAmbientColor",this._globalAmbientColor),F.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}g.texturesEnabled&&(this._albedoTexture&&Ze.DiffuseTextureEnabled&&F.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&Ze.AmbientTextureEnabled&&F.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&Ze.OpacityTextureEnabled&&F.setTexture("opacitySampler",this._opacityTexture),M&&Ze.ReflectionTextureEnabled&&(y.LODBASEDMICROSFURACE?F.setTexture("reflectionSampler",M):(F.setTexture("reflectionSampler",M._lodTextureMid||M),F.setTexture("reflectionSamplerLow",M._lodTextureLow||M),F.setTexture("reflectionSamplerHigh",M._lodTextureHigh||M)),y.USEIRRADIANCEMAP&&F.setTexture("irradianceSampler",M.irradianceTexture)),y.ENVIRONMENTBRDF&&F.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&Ze.EmissiveTextureEnabled&&F.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&Ze.LightmapTextureEnabled&&F.setTexture("lightmapSampler",this._lightmapTexture),Ze.SpecularTextureEnabled&&(this._metallicTexture?F.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&F.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&F.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&y.REFLECTANCE&&F.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&F.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&v.getCaps().standardDerivatives&&Ze.BumpTextureEnabled&&!this._disableBumpMap&&F.setTexture("bumpSampler",this._bumpTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(i)&&this.getScene().depthPeelingRenderer.bind(b),this._eventInfo.subMesh=s,this._callbackPluginEventBindForSubMesh(this._eventInfo),w2(this._activeEffect,this,g),this.bindEyePosition(b)}else g.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(S||!this.isFrozen)&&(g.lightsEnabled&&!this._disableLighting&&nt.BindLights(g,i,this._activeEffect,y,this._maxSimultaneousLights),(g.fogEnabled&&i.applyFog&&g.fogMode!==Nt.FOGMODE_NONE||M||i.receiveShadows||y.PREPASS)&&this.bindView(b),nt.BindFogParameters(g,i,this._activeEffect,!0),y.NUM_MORPH_INFLUENCERS&&nt.BindMorphTargetParameters(i,this._activeEffect),y.BAKED_VERTEX_ANIMATION_TEXTURE&&((_=i.bakedVertexAnimationManager)===null||_===void 0||_.bind(b,y.INSTANCES)),this._imageProcessingConfiguration.bind(this._activeEffect),nt.BindLogDepth(y,this._activeEffect,g)),this._afterBind(i,this._activeEffect),F.update()}getAnimatables(){const e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._metallicReflectanceTexture&&this._metallicReflectanceTexture.animations&&this._metallicReflectanceTexture.animations.length>0&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&this._reflectanceTexture.animations&&this._reflectanceTexture.animations.length>0&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&this._microSurfaceTexture.animations&&this._microSurfaceTexture.animations.length>0&&e.push(this._microSurfaceTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){const e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._albedoTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._reflectivityTexture===e||this._metallicTexture===e||this._metallicReflectanceTexture===e||this._reflectanceTexture===e||this._microSurfaceTexture===e||this._bumpTexture===e||this._lightmapTexture===e)}setPrePassRenderer(){var e;if(!(!((e=this.subSurface)===null||e===void 0)&&e.isScatteringEnabled))return!1;const i=this.getScene().enableSubSurfaceForPrePass();return i&&(i.enabled=!0),!0}dispose(e,i){var s,n,a,p,_,g,y,b,v,S,M,F;i&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),(s=this._albedoTexture)===null||s===void 0||s.dispose(),(n=this._ambientTexture)===null||n===void 0||n.dispose(),(a=this._opacityTexture)===null||a===void 0||a.dispose(),(p=this._reflectionTexture)===null||p===void 0||p.dispose(),(_=this._emissiveTexture)===null||_===void 0||_.dispose(),(g=this._metallicTexture)===null||g===void 0||g.dispose(),(y=this._reflectivityTexture)===null||y===void 0||y.dispose(),(b=this._bumpTexture)===null||b===void 0||b.dispose(),(v=this._lightmapTexture)===null||v===void 0||v.dispose(),(S=this._metallicReflectanceTexture)===null||S===void 0||S.dispose(),(M=this._reflectanceTexture)===null||M===void 0||M.dispose(),(F=this._microSurfaceTexture)===null||F===void 0||F.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,i)}}mr.PBRMATERIAL_OPAQUE=Be.MATERIAL_OPAQUE,mr.PBRMATERIAL_ALPHATEST=Be.MATERIAL_ALPHATEST,mr.PBRMATERIAL_ALPHABLEND=Be.MATERIAL_ALPHABLEND,mr.PBRMATERIAL_ALPHATESTANDBLEND=Be.MATERIAL_ALPHATESTANDBLEND,mr.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0,mr.LIGHTFALLOFF_PHYSICAL=0,mr.LIGHTFALLOFF_GLTF=1,mr.LIGHTFALLOFF_STANDARD=2,J([RE()],mr.prototype,"_imageProcessingConfiguration",void 0),J([He("_markAllSubMeshesAsMiscDirty")],mr.prototype,"debugMode",void 0),J([xe()],mr.prototype,"useLogarithmicDepth",null);class Et extends mr{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===mr.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=mr.LIGHTFALLOFF_PHYSICAL:this._lightFalloff=mr.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===mr.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=mr.LIGHTFALLOFF_GLTF:this._lightFalloff=mr.LIGHTFALLOFF_STANDARD)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}constructor(e,i){super(e,i),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=Et.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=qe.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new qe(0,0,0),this.albedoColor=new qe(1,1,1),this.reflectivityColor=new qe(1,1,1),this.reflectionColor=new qe(1,1,1),this.emissiveColor=new qe(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this._environmentBRDFTexture=y_(this.getScene())}getClassName(){return"PBRMaterial"}clone(e){const i=Kt.Clone(()=>new Et(e,this.getScene()),this);return i.id=e,i.name=e,this.stencil.copyTo(i.stencil),this.clearCoat.copyTo(i.clearCoat),this.anisotropy.copyTo(i.anisotropy),this.brdf.copyTo(i.brdf),this.sheen.copyTo(i.sheen),this.subSurface.copyTo(i.subSurface),this.iridescence.copyTo(i.iridescence),i}serialize(){const e=super.serialize();return e.customType="BABYLON.PBRMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,i,s){const n=Kt.Parse(()=>new Et(e.name,i),e,i,s);return e.stencil&&n.stencil.parse(e.stencil,i,s),e.clearCoat&&n.clearCoat.parse(e.clearCoat,i,s),e.anisotropy&&n.anisotropy.parse(e.anisotropy,i,s),e.brdf&&n.brdf.parse(e.brdf,i,s),e.sheen&&n.sheen.parse(e.sheen,i,s),e.subSurface&&n.subSurface.parse(e.subSurface,i,s),e.iridescence&&n.iridescence.parse(e.iridescence,i,s),n}}Et.PBRMATERIAL_OPAQUE=mr.PBRMATERIAL_OPAQUE,Et.PBRMATERIAL_ALPHATEST=mr.PBRMATERIAL_ALPHATEST,Et.PBRMATERIAL_ALPHABLEND=mr.PBRMATERIAL_ALPHABLEND,Et.PBRMATERIAL_ALPHATESTANDBLEND=mr.PBRMATERIAL_ALPHATESTANDBLEND,Et.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=mr.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"directIntensity",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"emissiveIntensity",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"environmentIntensity",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"specularIntensity",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"disableBumpMap",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"albedoTexture",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"ambientTexture",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"ambientTextureStrength",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"ambientTextureImpactOnAnalyticalLights",void 0),J([qi(),He("_markAllSubMeshesAsTexturesAndMiscDirty")],Et.prototype,"opacityTexture",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"reflectionTexture",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"emissiveTexture",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"reflectivityTexture",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"metallicTexture",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"metallic",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"roughness",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"metallicF0Factor",void 0),J([Vs(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"metallicReflectanceColor",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"metallicReflectanceTexture",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"reflectanceTexture",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"microSurfaceTexture",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"bumpTexture",void 0),J([qi(),He("_markAllSubMeshesAsTexturesDirty",null)],Et.prototype,"lightmapTexture",void 0),J([Vs("ambient"),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"ambientColor",void 0),J([Vs("albedo"),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"albedoColor",void 0),J([Vs("reflectivity"),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"reflectivityColor",void 0),J([Vs("reflection"),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"reflectionColor",void 0),J([Vs("emissive"),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"emissiveColor",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"microSurface",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"useLightmapAsShadowmap",void 0),J([xe(),He("_markAllSubMeshesAsTexturesAndMiscDirty")],Et.prototype,"useAlphaFromAlbedoTexture",void 0),J([xe(),He("_markAllSubMeshesAsTexturesAndMiscDirty")],Et.prototype,"forceAlphaTest",void 0),J([xe(),He("_markAllSubMeshesAsTexturesAndMiscDirty")],Et.prototype,"alphaCutOff",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"useSpecularOverAlpha",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"useRoughnessFromMetallicTextureGreen",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"useMetallnessFromMetallicTextureBlue",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"useAmbientInGrayScale",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),J([xe()],Et.prototype,"usePhysicalLightFalloff",null),J([xe()],Et.prototype,"useGLTFLightFalloff",null),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"useRadianceOverAlpha",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"useObjectSpaceNormalMap",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"useParallax",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"useParallaxOcclusion",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"parallaxScaleBias",void 0),J([xe(),He("_markAllSubMeshesAsLightsDirty")],Et.prototype,"disableLighting",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"forceIrradianceInFragment",void 0),J([xe(),He("_markAllSubMeshesAsLightsDirty")],Et.prototype,"maxSimultaneousLights",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"invertNormalMapX",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"invertNormalMapY",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"twoSidedLighting",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"useAlphaFresnel",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"useLinearAlphaFresnel",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"environmentBRDFTexture",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"forceNormalForward",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"enableSpecularAntiAliasing",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"useHorizonOcclusion",void 0),J([xe(),He("_markAllSubMeshesAsTexturesDirty")],Et.prototype,"useRadianceOcclusion",void 0),J([xe(),He("_markAllSubMeshesAsMiscDirty")],Et.prototype,"unlit",void 0),ur("BABYLON.PBRMaterial",Et);var CW=Object.defineProperty,RW=(l,e,i)=>e in l?CW(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,v_=(l,e,i)=>(RW(l,typeof e!="symbol"?e+"":e,i),i);class oq extends null{constructor(e,i,s){super({container:e,mode:i,layerCount:2,mirror:s}),v_(this,"renderer"),v_(this,"camera"),v_(this,"cameraAngle",10/180*Math.PI);const n=this.canvas.layers[1];this.renderer=new R(n,!0,{alpha:!0,preserveDrawingBuffer:!0},!0);const a=window.devicePixelRatio;this.renderer.setSize(n.clientWidth*a,n.clientHeight*a),this.canvas.on("resize",()=>{this.renderer.setSize(n.clientWidth*a,n.clientHeight*a)}),this.scene=new r(this.renderer),this.scene.useRightHandedSystem=!0,this.scene.clearColor=new A(0,0,0,0),this.camera=new u("camera",new T(0,0,0),this.scene),this.camera.rotationQuaternion=new B(1,0,0,0),this.camera.fov=this.cameraAngle,this.camera.minZ=.02,this.camera.maxZ=20}updateScene(){var e;(e=this.scene)==null||e.render()}dispose(){var e;this.renderer.dispose(),this.camera.dispose(),(e=this.scene)==null||e.dispose(),super.dispose()}setupCamera(e,i){super.setupCamera(e,i),this.camera.fov=this.cameraAngle,this.camera.getProjectionMatrix(!0)}}class IW extends D7{}class SW extends IW{}class xq extends null{}var MW=Object.defineProperty,PW=(l,e,i)=>e in l?MW(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,F2=(l,e,i)=>(PW(l,typeof e!="symbol"?e+"":e,i),i);class aI extends iE{constructor(e,i,s){super({container:e,mode:i,layerCount:1,mirror:s}),F2(this,"renderer"),F2(this,"layer"),F2(this,"camera"),F2(this,"cameraAngle",10/180*Math.PI);const n=this.canvas.layers[0];this.renderer=new Ae(n,!0,{alpha:!0,preserveDrawingBuffer:!0},!0);const a=window.devicePixelRatio;this.renderer.setSize(n.clientWidth*a,n.clientHeight*a),this.canvas.on("resize",()=>{this.renderer.setSize(n.clientWidth*a,n.clientHeight*a)}),this.scene=new Nt(this.renderer),this.scene.useRightHandedSystem=!0,this.scene.clearColor=new pi(0,0,0,0),this.camera=new M2("camera",new j(0,0,0),this.scene),this.camera.rotationQuaternion=new Ve(1,0,0,0),this.camera.fov=this.cameraAngle,this.camera.minZ=.02,this.camera.maxZ=20,this.layer=new J9("video",null,this.scene,!0)}updateVideo(e){var i;if(!this.current||!this.shader)return;this.shader.process([this.current],{flip:[1]});const s=(i=this.shader.output)==null?void 0:i.texture();return s&&(this.layer.texture=new er(this.scene,this.renderer.wrapWebGLTexture(s))),km.prototype.updateVideo.call(this,e)}updateScene(){var e;(e=this.scene)==null||e.render()}dispose(){var e;this.layer.dispose(),this.camera.dispose(),(e=this.scene)==null||e.dispose(),this.renderer.dispose(),super.dispose()}setupVideo(e,i){var s,n;km.prototype.setupVideo.call(this,e,i);const{width:a,height:p}=this.videoSize;(s=this.input)==null||s.resize({width:a,height:p}),(n=this.shader)==null||n.resize({width:a,height:p})}setupCamera(e,i){super.setupCamera(e,i),this.camera.fov=this.cameraAngle,this.camera.getProjectionMatrix(!0)}}class OW extends aI{}class lq extends null{}class cq extends null{constructor(e,i=!1){super(),this.node=e,this.shapeScale=i}async update(e,i){if(!this.loaded)return;const s=e.faces&&e.faces.length>0?e.faces[0].transform:void 0;if(!s)return this.node.setEnabled(!1),super.update(e,i);const n=T.FromArray(s.translation),a=new T().setAll(s.scale),p=T.FromArray(s.shapeScale).scale(s.scale),_=B.FromArray(s.rotation);return this.node.setEnabled(!0),this.node.rotationQuaternion=_,this.node.position=n,this.node.scaling=this.shapeScale?p:a,super.update(e,i)}}class hq extends null{constructor(e,i=0,s=!1){super(),this.node=e,this.facePoint=i,this.shapeScale=s}async update(e,i){if(!this.loaded)return;const{transform:s=void 0,metric:n=void 0}=e.faces&&e.faces.length>0?e.faces[0]:{};if(!s||!n)return this.node.setEnabled(!1),super.update(e,i);const a=T.FromArray(n[this.facePoint]),p=new T().setAll(s.scale),_=T.FromArray(s.shapeScale).scale(s.scale),g=B.FromArray(s.rotation);return this.node.setEnabled(!0),this.node.rotationQuaternion=g,this.node.position=a,this.node.scaling=this.shapeScale?_:p,super.update(e,i)}}var wW=Object.defineProperty,DW=(l,e,i)=>e in l?wW(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,FW=(l,e,i)=>(DW(l,typeof e!="symbol"?e+"":e,i),i);class uq extends null{constructor(e){super(),this.mesh=e,FW(this,"pointCont",w.length)}async load(e){this.loaded||(await super.load(e),await this.setMesh(this.mesh))}async update(e,i){var s;if(!this.loaded)return;const n=e.faces&&e.faces.length>0?e.faces[0].metric:void 0;return!n||!this.mesh?((s=this.mesh)==null||s.setEnabled(!1),super.update(e,i)):(this.mesh.setEnabled(!0),this.mesh.updateVerticesData(O.PositionKind,n.slice(0,this.pointCont).flat()),super.update(e,i))}async setMesh(e){if(delete this.mesh,this.mesh=e,!(!this.loaded||!e)){var i=new m;i.positions=w.flat(),i.indices=o.flat(),i.uvs=D.flat(),i.normals=[],m.ComputeNormals(i.positions,i.indices,i.normals),i.applyToMesh(e,!0),e.renderingGroupId=1}}}var LW=Object.defineProperty,NW=(l,e,i)=>e in l?LW(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,Oc=(l,e,i)=>(NW(l,typeof e!="symbol"?e+"":e,i),i);class BW extends SW{constructor(e,i={spineCurve:.5,neckAdjust:.01,headRatio:.32,shoulderDY:-.01,shoulderDZ:.005}){super(),this.node=e,this.tune=i,Oc(this,"skeleton"),Oc(this,"skeletonNodes"),Oc(this,"spineCurve"),Oc(this,"avatarLength",1),Oc(this,"alignScore",.9),Oc(this,"alignVisibility",.9)}async load(e){this.loaded||(await super.load(e),await this.setNode(this.node))}unload(){this.loaded&&(delete this.node,delete this.skeletonNodes,delete this.skeleton,delete this.spineCurve,super.unload())}setNode(e){var i,s;if(delete this.skeletonNodes,delete this.skeleton,delete this.spineCurve,this.node=e,!this.loaded||!e)return;this.skeleton=((i=e.getChildMeshes(!1).find(ye=>ye.skeleton))==null?void 0:i.skeleton)||void 0;const n=(s=this.skeleton)==null?void 0:s.bones;if(!n)return;const a=ye=>{var _e;return(_e=n.find(we=>we.name.toLowerCase().endsWith(ye)))==null?void 0:_e.getTransformNode()},p={hips:a("hips"),spine:a("spine"),spine1:a("spine1"),spine2:a("spine2"),neck:a("neck"),head:a("head"),headEnd:a("headtop_end"),shoulderL:a("leftshoulder"),shoulderR:a("rightshoulder"),armL:a("leftarm"),armR:a("rightarm"),foreArmL:a("leftforearm"),foreArmR:a("rightforearm"),handL:a("lefthand"),handR:a("righthand"),upLegL:a("leftupleg"),upLegR:a("rightupleg"),legL:a("leftleg"),legR:a("rightleg"),footL:a("leftfoot"),footR:a("rightfoot"),toeL:a("lefttoebase"),toeR:a("righttoebase")};this.skeletonNodes=p;const _=p.hips.absolutePosition,g=p.armL.absolutePosition,y=p.armR.absolutePosition,b=j.Lerp(g,y,.5).subtract(_).length(),v=g.subtract(_),S=y.subtract(_).cross(v).normalize(),M=p.spine.absolutePosition.subtract(_),F=j.Dot(M,S),L=M.subtract(S.scale(F)).length(),N=p.spine1.absolutePosition.subtract(_),k=j.Dot(N,S),G=N.subtract(S.scale(k)).length(),H=p.spine2.absolutePosition.subtract(_),z=j.Dot(H,S),W=H.subtract(S.scale(z)).length(),Y=p.head.absolutePosition,Z=p.headEnd.absolutePosition.subtract(Y).length();this.avatarLength=b,this.spineCurve={hips:[_.x,_.y],spine:[L/b,F/b],spine1:[G/b,k/b],spine2:[W/b,z/b],head:[Z/b,0]};let{min:Q,max:se}=e.getHierarchyBoundingVectors();const $=Q.add(se).scale(.5),oe=se.subtract(Q),ue=Math.max(oe.x,oe.y,oe.z)*1.1*.5,de=new j(ue,ue,ue);Q=$.subtract(de),se=$.add(de),e.getChildMeshes(!1).forEach(ye=>{ye.buildBoundingInfo(Q,se)})}async update(e,i){var s,n;if(!this.loaded)return;const a=e.poses&&e.poses.length>0?e.poses[0].points:void 0,{node:p,skeletonNodes:_,spineCurve:g}=this;if(!_||!g||!a||!p)return p?.setEnabled(!1),super.update(e,i);p.setEnabled(!0);const y=this.estimateBones(a,g),b=((s=this.spineCurve)==null?void 0:s.hips)||[0,1],v=y.hips.rotation,S=y.hips.position.add(new j(-b[0],-b[1],0).applyRotationQuaternionInPlace(v));return this.alignBone({position:S,rotation:v},p),(n=this.skeleton)==null||n.returnToRest(),this.updateSpine(y),this.updateHandL(y,a),this.updateHandR(y,a),this.updateLegL(y,a),this.updateLegR(y,a),super.update(e,i)}updateSpine(e){var i;const{skeletonNodes:s}=this;if(!s)return;this.alignBone(e.hips,s.hips,!1),this.alignBone(e.spine,s.spine),this.alignBone(e.spine1,s.spine1),this.alignBone(e.spine2,s.spine2),this.alignBone(e.neck,s.neck,!1),this.alignBone(e.head,s.head,!1);const n=(i=this.skeleton)==null?void 0:i.bones.find(a=>a.name.endsWith("HeadEnd"));if(n){const{head:a,headEnd:p}=e,_=p.position.subtract(a.position).length();s.head.scaling.setAll(1.05*_/n.position.length())}this.alignBone(e.shoulderL,s.shoulderL,!1),this.alignBone(e.shoulderR,s.shoulderR,!1)}updateHandL(e,i){const{skeletonNodes:s}=this;if(!s)return;const{alignScore:n,alignVisibility:a}=this;this.alignBone(e.armL,s.armL),!(i.elbowL.score<n&&i.elbowL.visibility<a)&&(this.alignBone(e.foreArmL,s.foreArmL),this.alignBone(e.handL,s.handL),s.handL.scaling.setAll(.95))}updateHandR(e,i){const{skeletonNodes:s}=this;if(!s)return;const{alignScore:n,alignVisibility:a}=this;this.alignBone(e.armR,s.armR),!(i.elbowR.score<n&&i.elbowR.visibility<a)&&(this.alignBone(e.foreArmR,s.foreArmR),this.alignBone(e.handR,s.handR),s.handR.scaling.setAll(.95))}updateLegL(e,i){const{skeletonNodes:s}=this;if(!s)return;const{alignScore:n,alignVisibility:a}=this;i.hipL.score<n&&i.hipL.visibility<a||(this.alignBone(e.upLegL,s.upLegL,!1),!(i.kneeL.score<n&&i.kneeL.visibility<a)&&(this.alignBone(e.legL,s.legL),!(i.ankleL.score<n&&i.ankleL.visibility<a)&&(this.alignBone(e.footL,s.footL),this.alignBone(e.toeL,s.toeL))))}updateLegR(e,i){const{skeletonNodes:s}=this;if(!s)return;const{alignScore:n,alignVisibility:a}=this;i.hipR.score<n&&i.hipR.visibility<a||(this.alignBone(e.upLegR,s.upLegR,!1),!(i.kneeR.score<n&&i.kneeR.visibility<a)&&(this.alignBone(e.legR,s.legR),!(i.ankleR.score<n&&i.ankleR.visibility<a)&&(this.alignBone(e.footR,s.footR),this.alignBone(e.toeR,s.toeR))))}estimateBones(e,i){var s;const n=new j(...e.hipL.metric),a=new j(...e.hipR.metric),p=j.Lerp(n,a,.5),_=n.subtract(a).normalize(),g=_.negate(),y=new j(...e.shoulderL.metric),b=new j(...e.shoulderR.metric),v=new j(...e.elbowL.metric),S=new j(...e.elbowR.metric),M=j.Lerp(y,b,.5),F=y.subtract(b).normalize(),L=y.subtract(p),N=b.subtract(p).cross(L).normalize();if(this.tune.shoulderDX||this.tune.shoulderDY||this.tune.shoulderDZ){const Ls=F.scale(this.tune.shoulderDX||0),da=M.subtract(p).normalize().scale(this.tune.shoulderDY||0).add(N.scale(((s=this.tune)==null?void 0:s.shoulderDZ)||0));y.addInPlace(da).addInPlace(Ls),b.addInPlace(da).addInPlace(Ls.negate())}const k=j.Lerp(y,b,.5),G=k.subtract(p).normalize(),H=v.subtract(y).normalize(),z=S.subtract(b).normalize();let W;if(this.tune.neckAdjust){const Ls=Math.abs(F.x);W=G.scale(Ls*(j.Dot(G,H)*-this.tune.neckAdjust+j.Dot(G,z)*-this.tune.neckAdjust)),k.addInPlace(W)}const Y=k.subtract(p).length(),Z=this.tune.shoulderOffset||.2,Q=j.Lerp(k,y,Z),se=j.Lerp(k,b,Z),$=new j(...e.earL.metric),oe=new j(...e.earR.metric),ue=j.Lerp($,oe,.5),de=new j(...e.nose.metric),ye=ue.subtract(de).normalize(),_e=$.subtract(oe).normalize(),we=_e.cross(ye).add(ye.scale(.05)).normalize(),Pe=this.tune.headRatio||.32,Ee=i.head[0]*Y,We=ue.add(we.cross(_e).scale(.025)),et=We.add(we.scale(-Pe*Ee)),ke=We.add(we.scale((1-Pe)*Ee)),$e=j.Lerp(et,ke,2),pt=j.Lerp(F,_e,.5),Xe=W?y.add(W):y.clone(),Tt=W?b.add(W):b.clone(),fi=j.Lerp(n,Xe,i.spine[0]),li=j.Lerp(a,Tt,i.spine[0]),Ot=j.Lerp(fi,li,.5),Gt=fi.subtract(li),bi=j.Lerp(n,Xe,i.spine1[0]),si=j.Lerp(a,Tt,i.spine1[0]),oi=j.Lerp(bi,si,.5),ci=bi.subtract(si),Li=j.Lerp(n,Xe,i.spine2[0]),hi=j.Lerp(a,Tt,i.spine2[0]),mi=j.Lerp(Li,hi,.5),cr=bi.subtract(hi);if(this.tune.spineCurve){const Ls=y.subtract(p),da=b.subtract(p).cross(Ls).normalize(),Io=this.tune.spineCurve*Y;Ot.addInPlace(da.scale(i.spine[1]*Io)),oi.addInPlace(da.scale(i.spine1[1]*Io)),mi.addInPlace(da.scale(i.spine2[1]*Io))}const Ui=new j(...e.wristL.metric),Ii=Ui.subtract(v).normalize().subtract(H).negate(),Cr=N.clone(),an=j.Lerp(Ii,Cr,.5),un=new j(...e.indexL.metric),Zn=new j(...e.pinkyL.metric),On=j.Lerp(un,Zn,.5),Yr=Zn.subtract(un),eo=new j(...e.wristR.metric),$o=eo.subtract(S).normalize().subtract(z),Jo=N.negate(),dn=j.Lerp($o,Jo,.5),wn=new j(...e.indexR.metric),Wr=new j(...e.pinkyR.metric),fn=j.Lerp(wn,Wr,.5),zs=wn.subtract(Wr),Qn=new j(...e.kneeL.metric),k0=new j(...e.ankleL.metric),U0=new j(...e.footIndexL.metric),to=new j(...e.heelL.metric),V0=k0.subtract(Qn).normalize(),io=U0.subtract(to).normalize(),Kr=V0.cross(io).normalize(),Hs=j.Lerp(to,U0,.8),Sr=j.Lerp(g,Kr,.2),e0=j.Lerp(g,Kr,.6),ro=new j(...e.kneeR.metric),Ro=new j(...e.ankleR.metric),t0=new j(...e.footIndexR.metric),so=new j(...e.heelR.metric),xs=Ro.subtract(ro).normalize(),on=t0.subtract(so).normalize(),Rt=xs.cross(on).normalize(),ps=j.Lerp(so,t0,.8),Vi=j.Lerp(g,Rt,.2),Rs=j.Lerp(g,Rt,.6);return{hips:this.estimateBone(p,Ot,_),spine:this.estimateBone(Ot,oi,Gt),spine1:this.estimateBone(oi,mi,ci),spine2:this.estimateBone(mi,k,cr),neck:this.estimateBone(k,et,pt),head:this.estimateBone(et,ke,_e),headEnd:this.estimateBone(ke,$e,_e),shoulderL:this.estimateBone(Q,y,Cr),armL:this.estimateBone(y,v,an),foreArmL:this.estimateBone(v,Ui,Ii),handL:this.estimateBone(Ui,On,Yr),shoulderR:this.estimateBone(se,b,Jo),armR:this.estimateBone(b,S,dn),foreArmR:this.estimateBone(S,eo,$o),handR:this.estimateBone(eo,fn,zs),upLegL:this.estimateBone(n,Qn,Sr),legL:this.estimateBone(Qn,k0,e0),footL:this.estimateBone(k0,Hs,Kr),toeL:this.estimateBone(Hs,U0,Kr),upLegR:this.estimateBone(a,ro,Vi),legR:this.estimateBone(ro,Ro,Rs),footR:this.estimateBone(Ro,ps,Rt),toeR:this.estimateBone(ps,t0,Rt)}}estimateBone(e,i,s){const n=i.subtract(e).normalize(),a=s.clone().normalize().cross(n).normalize(),p=n.cross(a);return{position:e.clone(),rotation:Ve.RotationQuaternionFromAxis(p,n,a)}}alignBone(e,i,s=!0){let n=e.rotation.clone(),a=e.position.clone();i.parent instanceof Jt&&(a=j.TransformCoordinates(a,i.parent.computeWorldMatrix(!0).clone().invert()),n=i.parent.absoluteRotationQuaternion.conjugate().multiply(n),s&&(i.parent.scaling.setAll(a.length()/i.position.length()),a=j.TransformCoordinates(e.position.clone(),i.parent.computeWorldMatrix(!0).clone().invert()))),i.position=a,i.rotationQuaternion=n}}class kW extends BW{constructor(e,i,s={spineCurve:.5,neckAdjust:.01,headRatio:.32,shoulderDY:-.01,shoulderDZ:.005}){super(e,s),this.outfit=i}setNode(e){super.setNode(e);const{outfit:i,node:s}=this;!i||!s||s.getChildMeshes().forEach(n=>{const a=p=>p?.some(_=>typeof _=="string"?n.name===_:_.test(n.name));if(a(i.occluders)){n.material&&(n.material.disableColorWrite=!0,n.material.needDepthPrePass=!0),n.renderingGroupId=0;return}if(a(i.hidden)){n.setEnabled(!1);return}})}setOutfit(e,i){this.outfit=i,this.setNode(e)}}class dq extends null{constructor(e,i,s,n,a={spineCurve:.5,neckAdjust:.01,headRatio:.32,shoulderDY:-.01,shoulderDZ:.005}){super(e,a),this.translation=i,this.rotation=s,this.scale=n}async update(e,i){await super.update(e,i);const s=e.poses&&e.poses.length>0?e.poses[0].points:void 0,{node:n,translation:a,rotation:p,scale:_}=this;if(!n||!s)return;const g=new T(...s.hipL.metric),y=new T(...s.hipR.metric),b=T.Lerp(g,y,.5);n.position=a?b.add(a):b,p&&(n.rotationQuaternion=p),_&&(n.scaling=new T().setAll(_))}updateSpine(e){const{skeletonNodes:i}=this;i&&(this.alignBone(e.hips,i.hips),this.alignBone(e.spine,i.spine),this.alignBone(e.spine1,i.spine1),this.alignBone(e.spine2,i.spine2),this.alignBone(e.neck,i.neck),this.alignBone(e.head,i.head),this.alignBone(e.shoulderL,i.shoulderL),this.alignBone(e.shoulderR,i.shoulderR))}alignBone(e,i){let s=e.rotation.clone();i.parent instanceof x&&(i.parent.computeWorldMatrix(!0),s=i.parent.absoluteRotationQuaternion.conjugate().multiply(s)),i.rotationQuaternion=s}}var UW=Object.defineProperty,VW=(l,e,i)=>e in l?UW(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,oI=(l,e,i)=>(VW(l,typeof e!="symbol"?e+"":e,i),i);const L2=.5,GW=64,xI=8,WW=40.1,zW=`
    precision mediump float;
    varying vec2 coords;
    uniform vec2 size;
    uniform vec4 box;
    uniform sampler2D image;
    uniform sampler2D mask;

    float readMask(vec2 coords, float dx, float dy) {
        return texture2D(mask, (coords + vec2(dx, dy) / size - box.xy) / box.zw).r;
    }

    vec4 readProp(vec2 coords, float dx, float ddx, float dy, float ddy) {
        return abs(dx) + abs(dy)< `+WW+` &&
            readMask(coords, ddx, ddy) < `+L2+` ?
            texture2D(image, coords + vec2(ddx, ddy) / size) :
            texture2D(image, coords + vec2(dx, dy) / size);
    }

    float traverse(vec2 coords, float dx, float dy) {
        bool bg = false;
        float d = 1.0;
        for (int di = 1; di < `+GW+`; di++) {
            d = bg ? d : float(di * `+xI+`);
            bg = bg || readMask(coords, d * dx, d * dy) < `+L2+`;
        }
        bool bg1 = bg;
        for (int di = 1; di < `+xI+`; di++) {
            float d1 = d - 1.0;
            bg1 = bg1 && readMask(coords, d1 * dx, d1 * dy) < `+L2+`;
            d = bg1 ? d1 : d;
        }
        return bg ? d : -1.0;
    }

    void main() {
        bool bg = texture2D(mask, (coords - box.xy) / (box.zw)).r < `+L2+`;
        bool bg1;
        vec4 color = texture2D(image, coords);
        if (bg) {
            gl_FragColor = color;
            return;
        }

        float x0 = traverse(coords, -1.0, 0.0);
        bg = x0 > 0.0;
        vec4 cx0 = bg ? readProp(coords, -x0, -x0 * 2.0 + 1.0, 0.0, 0.0) : color;
        x0 = bg ? 1.0 / x0 : 0.0;

        float x1 = traverse(coords, 1.0, 0.0);
        bg = x1 > 0.0;
        vec4 cx1 = bg ? readProp(coords, x1, x1 * 2.0 - 1.0, 0.0, 0.0) : color;
        x1 = bg ? 1.0 / x1 : 0.0;

        float y0 = traverse(coords, 0.0, -1.0);
        bg = y0 > 0.0;
        vec4 cy0 = bg ? readProp(coords, 0.0, 0.0, -y0, -2.0 * y0 + 1.0) : color;
        y0 = bg ? 1.0 / y0 : 0.0;

        float y1 = traverse(coords, 0.0, 1.0);
        bg = y1 > 0.0;
        vec4 cy1 = bg ? readProp(coords, 0.0, 0.0, y1, 2.0 * y1 + 1.0) : color;
        y1 = bg ? 1.0 / y1 : 0.0;

        float s = 1.0 / (x0 + x1 + y0 + y1);
        color = cx0 * x0 * s + cx1 * x1 * s + cy0 * y0 * s + cy1 * y1 * s;
        gl_FragColor = color;
    }
`;class fq extends null{constructor(){super(["image","mask"],{size:"2f",flip:"1f",box:"4f"},zW),oI(this,"maskTexture"),oI(this,"dilationShader")}async load(e){const i=e instanceof h&&e.shaderCtx;if(this.loaded||!i)return;const s={width:256,height:256};return this.maskTexture=new f(i,s,!0),this.dilationShader=new t(i,s,2),super.load(e)}unload(){var e,i;this.loaded&&((e=this.dilationShader)==null||e.dispose(),delete this.dilationShader,(i=this.maskTexture)==null||i.dispose(),delete this.maskTexture,super.unload())}async process(e,i){var s,n,a,p,_,g,y,b;const v=e.poses&&e.poses.length>0&&e.poses[0].mask;if(!v)return!1;(s=this.maskTexture)==null||s.resize(v.size),(n=this.maskTexture)==null||n.update(v.buffer),(a=this.dilationShader)==null||a.resize(v.size),(_=this.dilationShader)==null||_.process([((p=this.maskTexture)==null?void 0:p.texture())||null]);const S=v.box;return(b=this.shader)==null||b.process([i,((y=(g=this.dilationShader)==null?void 0:g.output)==null?void 0:y.texture())||null],{box:[S[0][0],S[0][1],S[1][0]-S[0][0],S[1][1]-S[0][1]]}),!0}}var HW=Object.defineProperty,XW=(l,e,i)=>e in l?HW(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i,wc=(l,e,i)=>(XW(l,typeof e!="symbol"?e+"":e,i),i);const Dc=.5,YW=32,lI=8,N2=64,KW=20.1,jW=`
    precision mediump float;
    varying vec2 coords;
    uniform vec2 size;
    uniform vec4 box;
    uniform sampler2D image;
    uniform sampler2D mask;
    uniform sampler2D part;

    float readMask(vec2 coords, float dx, float dy) {
        return texture2D(mask, (coords + vec2(dx, dy) / size - box.xy) / box.zw).r;
    }

    vec4 readPart(vec2 coords, float dx, float dy) {
        vec2 offset = coords + vec2(dx, dy) / size;
        return texture2D(part, vec2(offset.x, 1.0 - offset.y));
    }

    vec4 readProp(vec2 coords, float dx, float ddx, float dy, float ddy) {
        return abs(dx) + abs(dy)< `+KW+` &&
            readMask(coords, ddx, ddy) < `+Dc+` ?
            texture2D(image, coords + vec2(ddx, ddy) / size) :
            texture2D(image, coords + vec2(dx, dy) / size);
    }

    float traverse(vec2 coords, float dx, float dy) {
        bool bg = false;
        float d = 1.0;
        for (int di = 1; di < `+YW+`; di++) {
            d = bg ? d : float(di * `+lI+`);
            bg = bg || readMask(coords, d * dx, d * dy) < `+Dc+`;
        }
        bool bg1 = bg;
        for (int di = 1; di < `+lI+`; di++) {
            float d1 = d - 1.0;
            bg1 = bg1 && readMask(coords, d1 * dx, d1 * dy) < `+Dc+`;
            d = bg1 ? d1 : d;
        }
        return bg ? d : -1.0;
    }

    vec4 searchPart(vec2 coords, vec4 part, float dx, float dy) {
        bool bg = false;
        for (int di = 1; di < `+N2+`; di++) {
            float df = float(di);
            vec3 partD = readPart(coords, df * dx, df * dy).rgb;
            bg = bg || readMask(coords, df * dx, df * dy) < `+Dc+`;
            bool closer = !bg && (partD.r > 0.5 || partD.g > 0.5) && df < part.a;
            part.a = closer ? df : part.a;
            part.rgb = closer ? partD : part.rgb;
            // float df = float(di);
            // vec2 partD = readPart(coords, df * dx, df * dy).rg;
            // bg = bg || readMask(coords, df * dx, df * dy) < `+Dc+`;
            // bool closerR = !bg && partD.r > 0.5 && df < part.z;
            // bool closerG = !bg && partD.g > 0.5 && df < part.w;
            // part.z = closerR ? df : part.z;
            // part.r = closerR ? partD.r : part.r;
            // part.w = closerG ? df : part.w;
            // part.g = closerG ? partD.g : part.g;
        }
        return part;
    }

    void main() {
        bool bg = texture2D(mask, (coords - box.xy) / (box.zw)).r < `+Dc+`;
        vec4 color = texture2D(image, coords);
        if (bg) {
            gl_FragColor = color;
            return;
        }

        vec4 part = texture2D(part, vec2(coords.x, 1.0 - coords.y));
        if (part.g > 0.5 || part.r > 0.5) {
            gl_FragColor = color;
            return;
        }

        part.a = float(`+(2*N2+1)+`);
        // part.zw = vec2(`+(2*N2+1)+`);
        part = searchPart(coords, part, 1.0, 0.0);
        part = searchPart(coords, part, -1.0, 0.0);
        part = searchPart(coords, part, 0.0, 1.0);
        part = searchPart(coords, part, 0.0, -1.0);

        // if (part.w < part.z && part.w < float(`+N2+`)) {
        if (part.g > 0.5 || part.r <= 0.5) {
            gl_FragColor = color;
            return;
        }

        float x0 = traverse(coords, -1.0, 0.0);
        bg = x0 > 0.0;
        vec4 cx0 = bg ? readProp(coords, -x0, -x0 * 2.0 + 1.0, 0.0, 0.0) : color;
        x0 = bg ? 1.0 / x0 : 0.0;

        float x1 = traverse(coords, 1.0, 0.0);
        bg = x1 > 0.0;
        vec4 cx1 = bg ? readProp(coords, x1, x1 * 2.0 - 1.0, 0.0, 0.0) : color;
        x1 = bg ? 1.0 / x1 : 0.0;

        float y0 = traverse(coords, 0.0, -1.0);
        bg = y0 > 0.0;
        vec4 cy0 = bg ? readProp(coords, 0.0, 0.0, -y0, -2.0 * y0 + 1.0) : color;
        y0 = bg ? 1.0 / y0 : 0.0;

        float y1 = traverse(coords, 0.0, 1.0);
        bg = y1 > 0.0;
        vec4 cy1 = bg ? readProp(coords, 0.0, 0.0, y1, 2.0 * y1 + 1.0) : color;
        y1 = bg ? 1.0 / y1 : 0.0;

        float s = 1.0 / (x0 + x1 + y0 + y1);
        color = cx0 * x0 * s + cx1 * x1 * s + cy0 * y0 * s + cy1 * y1 * s;
        gl_FragColor = color;
    }
`;class pq extends null{constructor(e=[],i=[]){super(["image","mask","part"],{size:"2f",flip:"1f",box:"4f"},jW),this.patchParts=e,this.keepParts=i,wc(this,"maskTexture"),wc(this,"dilationShader"),wc(this,"partsTarget"),wc(this,"partsSkeletons",[]),wc(this,"patchMaterial"),wc(this,"keepMaterial")}setParts(e=[],i=[]){this.partsSkeletons=[],this.patchParts=e,this.keepParts=i,this.partsTarget&&(this.partsTarget.renderList=[...e,...i],this.partsTarget.setMaterialForRendering(e,this.patchMaterial),this.partsTarget.setMaterialForRendering(i,this.keepMaterial),this.partsTarget.renderList.forEach(s=>s.skeleton&&this.partsSkeletons.indexOf(s.skeleton)<0&&this.partsSkeletons.push(s.skeleton)))}async load(e){if(!(e instanceof aI))return;const{scene:i,shaderCtx:s}=e;if(this.loaded||!s)return;const n={width:256,height:256};return this.maskTexture=new f(s,n,!0),this.dilationShader=new t(s,n,1),this.partsTarget=new K("MasksTarget",this.size,i),this.partsTarget.clearColor=new A(0,0,0,1),this.patchMaterial=new V("PatchMaskMaterial",i),this.patchMaterial.emissiveColor=new P(1,0,0),this.patchMaterial.disableLighting=!0,this.keepMaterial=new V("KeepMaskMaterial",i),this.keepMaterial.emissiveColor=new P(0,1,0),this.keepMaterial.disableLighting=!0,this.setParts(this.patchParts,this.keepParts),super.load(e)}unload(){var e,i,s,n,a;this.loaded&&((e=this.dilationShader)==null||e.dispose(),delete this.dilationShader,(i=this.maskTexture)==null||i.dispose(),delete this.maskTexture,(s=this.partsTarget)==null||s.dispose(),delete this.partsTarget,(n=this.patchMaterial)==null||n.dispose(),delete this.patchMaterial,(a=this.keepMaterial)==null||a.dispose(),delete this.keepMaterial,super.unload())}async process(e,i){var s,n,a,p;const _=e.poses&&e.poses.length>0&&e.poses[0].mask,{partsTarget:g,partsSkeletons:y,maskTexture:b,dilationShader:v,shader:S}=this;if(!_||!g||!b||!v||!S)return!1;y.forEach(L=>L.prepare()),(s=g.renderList)==null||s.forEach(L=>L.computeWorldMatrix(!0)),g.render(),b.resize(_.size),b.update(_.buffer),v.resize(_.size),v.process([b.texture()||null]);const M=(a=(n=g.getInternalTexture())==null?void 0:n._hardwareTexture)==null?void 0:a._webGLTexture,F=_.box;return S.process([i,((p=v.output)==null?void 0:p.texture())||null,M||null],{box:[F[0][0],F[0][1],F[1][0]-F[0][0],F[1][1]-F[0][1]]}),!0}setupVideo(e){var i;super.setupVideo(e),(i=this.partsTarget)==null||i.resize(e),this.setParts(this.patchParts,this.keepParts)}}class mq extends null{constructor(e,i=0){super(),this.node=e,this.renderOrder=i}async load(e){if(!this.loaded)return this.node instanceof X&&(this.node.material&&(this.node.material.disableColorWrite=!0,this.node.material.needDepthPrePass=!0),this.node.renderingGroupId=this.renderOrder),this.node.getChildMeshes(!1).forEach(i=>{i.material&&(i.material.disableColorWrite=!0,i.material.needDepthPrePass=!0),i.renderingGroupId=this.renderOrder}),super.load(e)}}class _q extends null{constructor(e,i){super(e,i),this.disableColorWrite=!0,this.needDepthPrePass=!0}}class Ei extends vr{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}constructor(e,i){super(e,i),this.diffuse=new qe(1,1,1),this.specular=new qe(1,1,1),this.falloffType=Ei.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=Ei.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new At(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=new Array,this.excludedMeshes=new Array,this._resyncMeshes()}transferTexturesToEffect(e,i){return this}_bindLight(e,i,s,n,a=!0){var p;const _=e.toString();let g=!1;if(this._uniformBuffer.bindToEffect(s,"Light"+_),this._renderId!==i.getRenderId()||this._lastUseSpecular!==n||!this._uniformBuffer.useUbo){this._renderId=i.getRenderId(),this._lastUseSpecular=n;const y=this.getScaledIntensity();this.transferToEffect(s,_),this.diffuse.scaleToRef(y,ji.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",ji.Color3[0],this.range,_),n&&(this.specular.scaleToRef(y,ji.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",ji.Color3[1],this.radius,_)),g=!0}if(this.transferTexturesToEffect(s,_),i.shadowsEnabled&&this.shadowEnabled&&a){const y=(p=this.getShadowGenerator(i.activeCamera))!==null&&p!==void 0?p:this.getShadowGenerator();y&&(y.bindShadowLight(_,s),g=!0)}g?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let i="Name: "+this.name;if(i+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(let s=0;s<this.animations.length;s++)i+=", animation[0]: "+this.animations[s].toString(e);return i}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){var i;return this._shadowGenerators===null?null:(i=this._shadowGenerators.get(e))!==null&&i!==void 0?i:null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return j.Zero()}canAffectMesh(e){return e?!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(e)===-1||this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1||this.includeOnlyWithLayerMask!==0&&(this.includeOnlyWithLayerMask&e.layerMask)===0||this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&e.layerMask):!0}dispose(e,i=!1){if(this._shadowGenerators){const s=this._shadowGenerators.values();for(let n=s.next();n.done!==!0;n=s.next())n.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){const s=this._parentContainer.lights.indexOf(this);s>-1&&this._parentContainer.lights.splice(s,1),this._parentContainer=null}for(const s of this.getScene().meshes)s._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,i)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,i=null){const s=Ei.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!s)return null;const n=Kt.Clone(s,this);return e&&(n.name=e),i&&(n.parent=i),n.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(n),n}serialize(){const e=Kt.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach(i=>{e.excludedMeshesIds.push(i.id)})),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(i=>{e.includedOnlyMeshesIds.push(i.id)})),Kt.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,i,s){const n=vr.Construct("Light_Type_"+e,i,s);return n||null}static Parse(e,i){const s=Ei.GetConstructorFromName(e.type,e.name,i);if(!s)return null;const n=Kt.Parse(s,e,i);if(e.excludedMeshesIds&&(n._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(n._includedOnlyMeshesIds=e.includedOnlyMeshesIds),e.parentId!==void 0&&(n._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(n._waitingParentInstanceIndex=e.parentInstanceIndex),e.falloffType!==void 0&&(n.falloffType=e.falloffType),e.lightmapMode!==void 0&&(n.lightmapMode=e.lightmapMode),e.animations){for(let a=0;a<e.animations.length;a++){const p=e.animations[a],_=Ka("BABYLON.Animation");_&&n.animations.push(_.Parse(p))}vr.ParseAnimationRanges(n,e,i)}return e.autoAnimate&&i.beginAnimation(n,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&n.setEnabled(e.isEnabled),n}_hookArrayForExcluded(e){const i=e.push;e.push=(...n)=>{const a=i.apply(e,n);for(const p of n)p._resyncLightSource(this);return a};const s=e.splice;e.splice=(n,a)=>{const p=s.apply(e,[n,a]);for(const _ of p)_._resyncLightSource(this);return p};for(const n of e)n._resyncLightSource(this)}_hookArrayForIncludedOnly(e){const i=e.push;e.push=(...n)=>{const a=i.apply(e,n);return this._resyncMeshes(),a};const s=e.splice;e.splice=(n,a)=>{const p=s.apply(e,[n,a]);return this._resyncMeshes(),p},this._resyncMeshes()}_resyncMeshes(){for(const e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(const e of this.getScene().meshes)e.lightSources.indexOf(this)!==-1&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0;const i=this.getTypeID();let s=this.intensityMode;switch(s===Ei.INTENSITYMODE_AUTOMATIC&&(i===Ei.LIGHTTYPEID_DIRECTIONALLIGHT?s=Ei.INTENSITYMODE_ILLUMINANCE:s=Ei.INTENSITYMODE_LUMINOUSINTENSITY),i){case Ei.LIGHTTYPEID_POINTLIGHT:case Ei.LIGHTTYPEID_SPOTLIGHT:switch(s){case Ei.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case Ei.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case Ei.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius;break}break;case Ei.LIGHTTYPEID_DIRECTIONALLIGHT:switch(s){case Ei.INTENSITYMODE_ILLUMINANCE:e=1;break;case Ei.INTENSITYMODE_LUMINANCE:{let n=this.radius;n=Math.max(n,.001),e=2*Math.PI*(1-Math.cos(n));break}}break;case Ei.LIGHTTYPEID_HEMISPHERICLIGHT:e=1;break}return e}_reorderLightsInScene(){const e=this.getScene();this._renderPriority!=0&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}}Ei.FALLOFF_DEFAULT=Ji.FALLOFF_DEFAULT,Ei.FALLOFF_PHYSICAL=Ji.FALLOFF_PHYSICAL,Ei.FALLOFF_GLTF=Ji.FALLOFF_GLTF,Ei.FALLOFF_STANDARD=Ji.FALLOFF_STANDARD,Ei.LIGHTMAP_DEFAULT=Ji.LIGHTMAP_DEFAULT,Ei.LIGHTMAP_SPECULAR=Ji.LIGHTMAP_SPECULAR,Ei.LIGHTMAP_SHADOWSONLY=Ji.LIGHTMAP_SHADOWSONLY,Ei.INTENSITYMODE_AUTOMATIC=Ji.INTENSITYMODE_AUTOMATIC,Ei.INTENSITYMODE_LUMINOUSPOWER=Ji.INTENSITYMODE_LUMINOUSPOWER,Ei.INTENSITYMODE_LUMINOUSINTENSITY=Ji.INTENSITYMODE_LUMINOUSINTENSITY,Ei.INTENSITYMODE_ILLUMINANCE=Ji.INTENSITYMODE_ILLUMINANCE,Ei.INTENSITYMODE_LUMINANCE=Ji.INTENSITYMODE_LUMINANCE,Ei.LIGHTTYPEID_POINTLIGHT=Ji.LIGHTTYPEID_POINTLIGHT,Ei.LIGHTTYPEID_DIRECTIONALLIGHT=Ji.LIGHTTYPEID_DIRECTIONALLIGHT,Ei.LIGHTTYPEID_SPOTLIGHT=Ji.LIGHTTYPEID_SPOTLIGHT,Ei.LIGHTTYPEID_HEMISPHERICLIGHT=Ji.LIGHTTYPEID_HEMISPHERICLIGHT,J([Vs()],Ei.prototype,"diffuse",void 0),J([Vs()],Ei.prototype,"specular",void 0),J([xe()],Ei.prototype,"falloffType",void 0),J([xe()],Ei.prototype,"intensity",void 0),J([xe()],Ei.prototype,"range",null),J([xe()],Ei.prototype,"intensityMode",null),J([xe()],Ei.prototype,"radius",null),J([xe()],Ei.prototype,"_renderPriority",void 0),J([He("_reorderLightsInScene")],Ei.prototype,"renderPriority",void 0),J([xe("shadowEnabled")],Ei.prototype,"_shadowEnabled",void 0),J([xe("excludeWithLayerMask")],Ei.prototype,"_excludeWithLayerMask",void 0),J([xe("includeOnlyWithLayerMask")],Ei.prototype,"_includeOnlyWithLayerMask",void 0),J([xe("lightmapMode")],Ei.prototype,"_lightmapMode",void 0);class gl extends Ei{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0}_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return this.parent&&this.parent.getWorldMatrix?(this.transformedPosition||(this.transformedPosition=j.Zero()),j.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=j.Zero()),j.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0):!1}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=j.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();const e=j.Cross(this.direction,oa.Y),i=j.Cross(e,this.direction);return j.RotationFromAxis(e,i,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=j.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=fe.Identity()),fe.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}getDepthMinZ(e){return this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ}getDepthMaxZ(e){return this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ}setShadowProjectionMatrix(e,i,s){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(i,s,e):this._setDefaultShadowProjectionMatrix(e,i,s),this}_syncParentEnabledState(){super._syncParentEnabledState(),(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition=null,this.transformedDirection=null)}}J([Rn()],gl.prototype,"position",null),J([Rn()],gl.prototype,"direction",null),J([xe()],gl.prototype,"shadowMinZ",null),J([xe()],gl.prototype,"shadowMaxZ",null),vr.AddNodeConstructor("Light_Type_0",(l,e)=>()=>new Fc(l,j.Zero(),e));class Fc extends gl{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){const i=this.needCube();if(this._direction=e,this.needCube()!==i&&this._shadowGenerators){const s=this._shadowGenerators.values();for(let n=s.next();n.done!==!0;n=s.next())n.value.recreateShadowMap()}}constructor(e,i,s){super(e,s),this._shadowAngle=Math.PI/2,this.position=i}getClassName(){return"PointLight"}getTypeID(){return Ei.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new j(1,0,0);case 1:return new j(-1,0,0);case 2:return new j(0,-1,0);case 3:return new j(0,1,0);case 4:return new j(0,0,1);case 5:return new j(0,0,-1)}return j.Zero()}_setDefaultShadowProjectionMatrix(e,i,s){const n=this.getScene().activeCamera;if(!n)return;const a=this.shadowMinZ!==void 0?this.shadowMinZ:n.minZ,p=this.shadowMaxZ!==void 0?this.shadowMaxZ:n.maxZ,_=this.getScene().getEngine().useReverseDepthBuffer;fe.PerspectiveFovLHToRef(this.shadowAngle,1,_?p:a,_?a:p,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,_)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,i){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,i):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,i),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,i),this}transferToNodeMaterialEffect(e,i){return this.computeTransformedInformation()?e.setFloat3(i,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(i,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,i){e["POINTLIGHT"+i]=!0}}J([xe()],Fc.prototype,"shadowAngle",null),vr.AddNodeConstructor("Light_Type_3",(l,e)=>()=>new P0(l,j.Zero(),e));class P0 extends Ei{constructor(e,i,s){super(e,s),this.groundColor=new qe(0,0,0),this.direction=i||j.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=j.Normalize(e.subtract(j.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,i){const s=j.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",s.x,s.y,s.z,0,i),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),i),this}transferToNodeMaterialEffect(e,i){const s=j.Normalize(this.direction);return e.setFloat3(i,s.x,s.y,s.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=fe.Identity()),this._worldMatrix}getTypeID(){return Ei.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,i){e["HEMILIGHT"+i]=!0}}J([Vs()],P0.prototype,"groundColor",void 0),J([Rn()],P0.prototype,"direction",void 0);class ss{static get ForceFullSceneLoadingForIncremental(){return ss._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){ss._ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return ss._ShowLoadingScreen}static set ShowLoadingScreen(e){ss._ShowLoadingScreen=e}static get loggingLevel(){return ss._LoggingLevel}static set loggingLevel(e){ss._LoggingLevel=e}static get CleanBoneMatrixWeights(){return ss._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){ss._CleanBoneMatrixWeights=e}}ss._ForceFullSceneLoadingForIncremental=!1,ss._ShowLoadingScreen=!0,ss._CleanBoneMatrixWeights=!1,ss._LoggingLevel=0;var Rx;(function(l){l[l.Clean=0]="Clean",l[l.Stop=1]="Stop",l[l.Sync=2]="Sync",l[l.NoSync=3]="NoSync"})(Rx||(Rx={}));class ki{static get ForceFullSceneLoadingForIncremental(){return ss.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){ss.ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return ss.ShowLoadingScreen}static set ShowLoadingScreen(e){ss.ShowLoadingScreen=e}static get loggingLevel(){return ss.loggingLevel}static set loggingLevel(e){ss.loggingLevel=e}static get CleanBoneMatrixWeights(){return ss.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){ss.CleanBoneMatrixWeights=e}static GetDefaultPlugin(){return ki._RegisteredPlugins[".babylon"]}static _GetPluginForExtension(e){const i=ki._RegisteredPlugins[e];return i||(Ie.Warn("Unable to find a plugin to load "+e+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),ki.GetDefaultPlugin())}static _GetPluginForDirectLoad(e){for(const i in ki._RegisteredPlugins){const s=ki._RegisteredPlugins[i].plugin;if(s.canDirectLoad&&s.canDirectLoad(e))return ki._RegisteredPlugins[i]}return ki.GetDefaultPlugin()}static _GetPluginForFilename(e){const i=e.indexOf("?");i!==-1&&(e=e.substring(0,i));const s=e.lastIndexOf("."),n=e.substring(s,e.length).toLowerCase();return ki._GetPluginForExtension(n)}static _GetDirectLoad(e){return e.substr(0,5)==="data:"?e.substr(5):null}static _FormatErrorMessage(e,i,s){let n="Unable to load from "+e.url;return i?n+=`: ${i}`:s&&(n+=`: ${s}`),n}static _LoadData(e,i,s,n,a,p,_){const g=ki._GetDirectLoad(e.url),y=_?ki._GetPluginForExtension(_):g?ki._GetPluginForDirectLoad(e.url):ki._GetPluginForFilename(e.url);let b;if(y.plugin.createPlugin!==void 0?b=y.plugin.createPlugin():b=y.plugin,!b)throw"The loader plugin corresponding to the file type you are trying to load has not been found. If using es6, please import the plugin you wish to use before.";if(ki.OnPluginActivatedObservable.notifyObservers(b),g&&(b.canDirectLoad&&b.canDirectLoad(e.url)||!p2(e.url))){if(b.directLoad){const H=b.directLoad(i,g);H.then?H.then(z=>{s(b,z)}).catch(z=>{a("Error in directLoad of _loadData: "+z,z)}):s(b,H)}else s(b,g);return b}const v=y.isBinary,S=(H,z)=>{if(i.isDisposed){a("Scene has been disposed");return}s(b,H,z)};let M=null,F=!1;const L=b.onDisposeObservable;L&&L.add(()=>{F=!0,M&&(M.abort(),M=null),p()});const N=()=>{if(F)return;const H=(W,Y)=>{a(W?.statusText,Y)},z=e.file||e.url;M=b.loadFile?b.loadFile(i,z,S,n,v,H):i._loadFile(z,S,n,!0,v,H)},k=i.getEngine();let G=k.enableOfflineSupport;if(G){let H=!1;for(const z of i.disableOfflineSupportExceptionRules)if(z.test(e.url)){H=!0;break}G=!H}return G&&Ae.OfflineProviderFactory?i.offlineProvider=Ae.OfflineProviderFactory(e.url,N,k.disableManifestCheck):N(),b}static _GetFileInfo(e,i){let s,n,a=null;if(!i)s=e,n=Le.GetFilename(e),e=Le.GetFolderPath(e);else if(i.name){const p=i;s=`file:${p.name}`,n=p.name,a=p}else if(typeof i=="string"&&i.startsWith("data:"))s=i,n="";else{const p=i;if(p.substr(0,1)==="/")return Le.Error("Wrong sceneFilename parameter"),null;s=e+p,n=p}return{url:s,rootUrl:e,name:n,file:a}}static GetPluginForExtension(e){return ki._GetPluginForExtension(e).plugin}static IsPluginForExtensionAvailable(e){return!!ki._RegisteredPlugins[e]}static RegisterPlugin(e){if(typeof e.extensions=="string"){const i=e.extensions;ki._RegisteredPlugins[i.toLowerCase()]={plugin:e,isBinary:!1}}else{const i=e.extensions;Object.keys(i).forEach(s=>{ki._RegisteredPlugins[s.toLowerCase()]={plugin:e,isBinary:i[s].isBinary}})}}static ImportMesh(e,i,s="",n=Zt.LastCreatedScene,a=null,p=null,_=null,g=null){if(!n)return Ie.Error("No scene available to import mesh to"),null;const y=ki._GetFileInfo(i,s);if(!y)return null;const b={};n.addPendingData(b);const v=()=>{n.removePendingData(b)},S=(L,N)=>{const k=ki._FormatErrorMessage(y,L,N);_?_(n,k,new Wo(k,_x.SceneLoaderError,N)):Ie.Error(k),v()},M=p?L=>{try{p(L)}catch(N){S("Error in onProgress callback: "+N,N)}}:void 0,F=(L,N,k,G,H,z,W)=>{if(n.importedMeshesFiles.push(y.url),a)try{a(L,N,k,G,H,z,W)}catch(Y){S("Error in onSuccess callback: "+Y,Y)}n.removePendingData(b)};return ki._LoadData(y,n,(L,N,k)=>{if(L.rewriteRootURL&&(y.rootUrl=L.rewriteRootURL(y.rootUrl,k)),L.importMesh){const G=L,H=new Array,z=new Array,W=new Array;if(!G.importMesh(e,n,N,y.rootUrl,H,z,W,S))return;n.loadingPluginName=L.name,F(H,z,W,[],[],[],[])}else L.importMeshAsync(e,n,N,y.rootUrl,M,y.name).then(H=>{n.loadingPluginName=L.name,F(H.meshes,H.particleSystems,H.skeletons,H.animationGroups,H.transformNodes,H.geometries,H.lights)}).catch(H=>{S(H.message,H)})},M,S,v,g)}static ImportMeshAsync(e,i,s="",n=Zt.LastCreatedScene,a=null,p=null){return new Promise((_,g)=>{ki.ImportMesh(e,i,s,n,(y,b,v,S,M,F,L)=>{_({meshes:y,particleSystems:b,skeletons:v,animationGroups:S,transformNodes:M,geometries:F,lights:L})},a,(y,b,v)=>{g(v||new Error(b))},p)})}static Load(e,i="",s=Zt.LastCreatedEngine,n=null,a=null,p=null,_=null){return s?ki.Append(e,i,new Nt(s),n,a,p,_):(Le.Error("No engine available"),null)}static LoadAsync(e,i="",s=Zt.LastCreatedEngine,n=null,a=null){return new Promise((p,_)=>{ki.Load(e,i,s,g=>{p(g)},n,(g,y,b)=>{_(b||new Error(y))},a)})}static Append(e,i="",s=Zt.LastCreatedScene,n=null,a=null,p=null,_=null){if(!s)return Ie.Error("No scene available to append to"),null;const g=ki._GetFileInfo(e,i);if(!g)return null;const y={};s.addPendingData(y);const b=()=>{s.removePendingData(y)};ki.ShowLoadingScreen&&!this._ShowingLoadingScreen&&(this._ShowingLoadingScreen=!0,s.getEngine().displayLoadingUI(),s.executeWhenReady(()=>{s.getEngine().hideLoadingUI(),this._ShowingLoadingScreen=!1}));const v=(F,L)=>{const N=ki._FormatErrorMessage(g,F,L);p?p(s,N,new Wo(N,_x.SceneLoaderError,L)):Ie.Error(N),b()},S=a?F=>{try{a(F)}catch(L){v("Error in onProgress callback",L)}}:void 0,M=()=>{if(n)try{n(s)}catch(F){v("Error in onSuccess callback",F)}s.removePendingData(y)};return ki._LoadData(g,s,(F,L)=>{if(F.load){if(!F.load(s,L,g.rootUrl,v))return;s.loadingPluginName=F.name,M()}else F.loadAsync(s,L,g.rootUrl,S,g.name).then(()=>{s.loadingPluginName=F.name,M()}).catch(k=>{v(k.message,k)})},S,v,b,_)}static AppendAsync(e,i="",s=Zt.LastCreatedScene,n=null,a=null){return new Promise((p,_)=>{ki.Append(e,i,s,g=>{p(g)},n,(g,y,b)=>{_(b||new Error(y))},a)})}static LoadAssetContainer(e,i="",s=Zt.LastCreatedScene,n=null,a=null,p=null,_=null){if(!s)return Ie.Error("No scene available to load asset container to"),null;const g=ki._GetFileInfo(e,i);if(!g)return null;const y={};s.addPendingData(y);const b=()=>{s.removePendingData(y)},v=(F,L)=>{const N=ki._FormatErrorMessage(g,F,L);p?p(s,N,new Wo(N,_x.SceneLoaderError,L)):Ie.Error(N),b()},S=a?F=>{try{a(F)}catch(L){v("Error in onProgress callback",L)}}:void 0,M=F=>{if(n)try{n(F)}catch(L){v("Error in onSuccess callback",L)}s.removePendingData(y)};return ki._LoadData(g,s,(F,L)=>{if(F.loadAssetContainer){const k=F.loadAssetContainer(s,L,g.rootUrl,v);if(!k)return;s.loadingPluginName=F.name,M(k)}else F.loadAssetContainerAsync?F.loadAssetContainerAsync(s,L,g.rootUrl,S,g.name).then(k=>{s.loadingPluginName=F.name,M(k)}).catch(k=>{v(k.message,k)}):v("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},S,v,b,_)}static LoadAssetContainerAsync(e,i="",s=Zt.LastCreatedScene,n=null,a=null){return new Promise((p,_)=>{ki.LoadAssetContainer(e,i,s,g=>{p(g)},n,(g,y,b)=>{_(b||new Error(y))},a)})}static ImportAnimations(e,i="",s=Zt.LastCreatedScene,n=!0,a=Rx.Clean,p=null,_=null,g=null,y=null,b=null){if(!s){Ie.Error("No scene available to load animations to");return}if(n){for(const F of s.animatables)F.reset();s.stopAllAnimations(),s.animationGroups.slice().forEach(F=>{F.dispose()}),s.getNodes().forEach(F=>{F.animations&&(F.animations=[])})}else switch(a){case Rx.Clean:s.animationGroups.slice().forEach(M=>{M.dispose()});break;case Rx.Stop:s.animationGroups.forEach(M=>{M.stop()});break;case Rx.Sync:s.animationGroups.forEach(M=>{M.reset(),M.restart()});break;case Rx.NoSync:break;default:Ie.Error("Unknown animation group loading mode value '"+a+"'");return}const v=s.animatables.length,S=M=>{M.mergeAnimationsTo(s,s.animatables.slice(v),p),M.dispose(),s.onAnimationFileImportedObservable.notifyObservers(s),_&&_(s)};this.LoadAssetContainer(e,i,s,S,g,y,b)}static ImportAnimationsAsync(e,i="",s=Zt.LastCreatedScene,n=!0,a=Rx.Clean,p=null,_=null,g=null,y=null,b=null){return new Promise((v,S)=>{ki.ImportAnimations(e,i,s,n,a,p,M=>{v(M)},g,(M,F,L)=>{S(L||new Error(F))},b)})}}ki.NO_LOGGING=0,ki.MINIMAL_LOGGING=1,ki.SUMMARY_LOGGING=2,ki.DETAILED_LOGGING=3,ki.OnPluginActivatedObservable=new Re,ki._RegisteredPlugins={},ki._ShowingLoadingScreen=!1;class cn{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(e){const i=new cn(cn.RandomId(),e.getScene());return i.applyToMesh(e),i}get meshes(){return this._meshes}constructor(e,i,s,n=!1,a=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=i||Zt.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=n,s?this.setAllVerticesData(s,n):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),a&&(this.applyToMesh(a),a.computeWorldMatrix(!0)))}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return this.delayLoadState===1||this.delayLoadState===0}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable));for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild()}setAllVerticesData(e,i){e.applyToGeometry(this,i),this._notifyUpdate()}setVerticesData(e,i,s=!1,n){s&&Array.isArray(i)&&(i=new Float32Array(i));const a=new te(this._engine,i,e,s,this._meshes.length===0,n);this.setVerticesBuffer(a)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,i=null,s=!0){const n=e.getKind();this._vertexBuffers[n]&&s&&this._vertexBuffers[n].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[n]=e;const a=this._meshes,p=a.length;if(n===te.PositionKind){const _=e.getData();i!=null?this._totalVertices=i:_!=null&&(this._totalVertices=_.length/(e.type===te.BYTE?e.byteStride:e.byteStride/4)),this._updateExtend(_),this._resetPointsArrayCache();for(let g=0;g<p;g++){const y=a[g];y.buildBoundingInfo(this._extend.minimum,this._extend.maximum),y._createGlobalSubMesh(y.isUnIndexed),y.computeWorldMatrix(!0),y.synchronizeInstances()}}this._notifyUpdate(n)}updateVerticesDataDirectly(e,i,s,n=!1){const a=this.getVertexBuffer(e);!a||(a.updateDirectly(i,s,n),this._notifyUpdate(e))}updateVerticesData(e,i,s=!1){const n=this.getVertexBuffer(e);!n||(n.update(i),e===te.PositionKind&&this._updateBoundingInfo(s,i),this._notifyUpdate(e))}_updateBoundingInfo(e,i){if(e&&this._updateExtend(i),this._resetPointsArrayCache(),e){const s=this._meshes;for(const n of s){n.hasBoundingInfo?n.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):n.buildBoundingInfo(this._extend.minimum,this._extend.maximum);const a=n.subMeshes;for(const p of a)p.refreshBoundingInfo()}}}_bind(e,i,s,n){if(!e)return;i===void 0&&(i=this._indexBuffer);const a=this.getVertexBuffers();if(!a)return;if(i!=this._indexBuffer||!this._vertexArrayObjects&&!n){this._engine.bindBuffers(a,i,e,s);return}const p=n||this._vertexArrayObjects;p[e.key]||(p[e.key]=this._engine.recordVertexArrayObject(a,i,e,s)),this._engine.bindVertexArrayObject(p[e.key],i)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,i,s){const n=this.getVertexBuffer(e);return n?n.getFloatData(this._totalVertices,s||i&&this._meshes.length!==1):null}isVertexBufferUpdatable(e){const i=this._vertexBuffers[e];return i?i.isUpdatable():!1}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?this._vertexBuffers[e]!==void 0:this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}getVerticesDataKinds(){const e=[];let i;if(!this._vertexBuffers&&this._delayInfo)for(i in this._delayInfo)e.push(i);else for(i in this._vertexBuffers)e.push(i);return e}updateIndices(e,i,s=!1){if(!!this._indexBuffer)if(!this._indexBufferIsUpdatable)this.setIndices(e,null,!0);else{const n=e.length!==this._indices.length;if(s||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,i),n)for(const a of this._meshes)a._createGlobalSubMesh(!0)}}setIndices(e,i=null,s=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=s,this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,s)),i!=null&&(this._totalVertices=i);for(const n of this._meshes)n._createGlobalSubMesh(!0),n.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?this._indices.length:0}getIndices(e,i){if(!this.isReady())return null;const s=this._indices;return!i&&(!e||this._meshes.length===1)?s:s.slice()}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){!e||!this._vertexArrayObjects||this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,i){const s=this._meshes,n=s.indexOf(e);n!==-1&&(s.splice(n,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,s.length===0&&i&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;const i=e._geometry;i&&i.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();const s=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),s.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&(e=this.getVerticesData(te.PositionKind),!e))return;this._extend=zE(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){const i=this._meshes.length;for(const s in this._vertexBuffers)i===1&&this._vertexBuffers[s].create(),s===te.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());i===1&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(const i of this._meshes)i._markSubMeshesAsAttributesDirty()}load(e,i){if(this.delayLoadState!==2){if(this.isReady()){i&&i();return}this.delayLoadState=2,this._queueLoad(e,i)}}_queueLoad(e,i){!this.delayLoadingFile||(e.addPendingData(this),e._loadFile(this.delayLoadingFile,s=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(s),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);const n=this._meshes,a=n.length;for(let p=0;p<a;p++)this._applyToMesh(n[p]);i&&i()},void 0,!0))}toLeftHanded(){const e=this.getIndices(!1);if(e!=null&&e.length>0){for(let n=0;n<e.length;n+=3){const a=e[n+0];e[n+0]=e[n+2],e[n+2]=a}this.setIndices(e)}const i=this.getVerticesData(te.PositionKind,!1);if(i!=null&&i.length>0){for(let n=0;n<i.length;n+=3)i[n+2]=-i[n+2];this.setVerticesData(te.PositionKind,i,!1)}const s=this.getVerticesData(te.NormalKind,!1);if(s!=null&&s.length>0){for(let n=0;n<s.length;n+=3)s[n+2]=-s[n+2];this.setVerticesData(te.NormalKind,s,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;const e=this.getVerticesData(te.PositionKind);if(!e||e.length===0)return!1;for(let i=this._positionsCache.length*3,s=this._positionsCache.length;i<e.length;i+=3,++s)this._positionsCache[s]=j.FromArray(e,i);for(let i=0,s=0;i<e.length;i+=3,++s)this._positionsCache[s].set(e[0+i],e[1+i],e[2+i]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(const s in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[s]);this._vertexArrayObjects={};const e=this._meshes,i=e.length;for(let s=0;s<i;s++)e[s]._invalidateInstanceVertexArrayObject()}}dispose(){const e=this._meshes,i=e.length;let s;for(s=0;s<i;s++)this.releaseForMesh(e[s]);this._meshes.length=0,this._disposeVertexArrayObjects();for(const n in this._vertexBuffers)this._vertexBuffers[n].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){const n=this._parentContainer.geometries.indexOf(this);n>-1&&this._parentContainer.geometries.splice(n,1),this._parentContainer=null}this._isDisposed=!0}copy(e){const i=new Mt;i.indices=[];const s=this.getIndices();if(s)for(let g=0;g<s.length;g++)i.indices.push(s[g]);let n=!1,a=!1,p;for(p in this._vertexBuffers){const g=this.getVerticesData(p);if(g&&(g instanceof Float32Array?i.set(new Float32Array(g),p):i.set(g.slice(0),p),!a)){const y=this.getVertexBuffer(p);y&&(n=y.isUpdatable(),a=!n)}}const _=new cn(e,this._scene,i,n);_.delayLoadState=this.delayLoadState,_.delayLoadingFile=this.delayLoadingFile,_._delayLoadingFunction=this._delayLoadingFunction;for(p in this._delayInfo)_._delayInfo=_._delayInfo||[],_._delayInfo.push(p);return _._boundingInfo=new la(this._extend.minimum,this._extend.maximum),_}serialize(){const e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,Bi&&Bi.HasTags(this)&&(e.tags=Bi.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(const e in this._vertexBuffers)!Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)||(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){const e=this.serialize();return this.isVerticesDataPresent(te.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(te.PositionKind)),this.isVertexBufferUpdatable(te.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(te.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(te.NormalKind)),this.isVertexBufferUpdatable(te.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(te.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(te.TangentKind)),this.isVertexBufferUpdatable(te.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(te.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(te.UVKind)),this.isVertexBufferUpdatable(te.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(te.UV2Kind)&&(e.uv2s=this._toNumberArray(this.getVerticesData(te.UV2Kind)),this.isVertexBufferUpdatable(te.UV2Kind)&&(e.uv2s._updatable=!0)),this.isVerticesDataPresent(te.UV3Kind)&&(e.uv3s=this._toNumberArray(this.getVerticesData(te.UV3Kind)),this.isVertexBufferUpdatable(te.UV3Kind)&&(e.uv3s._updatable=!0)),this.isVerticesDataPresent(te.UV4Kind)&&(e.uv4s=this._toNumberArray(this.getVerticesData(te.UV4Kind)),this.isVertexBufferUpdatable(te.UV4Kind)&&(e.uv4s._updatable=!0)),this.isVerticesDataPresent(te.UV5Kind)&&(e.uv5s=this._toNumberArray(this.getVerticesData(te.UV5Kind)),this.isVertexBufferUpdatable(te.UV5Kind)&&(e.uv5s._updatable=!0)),this.isVerticesDataPresent(te.UV6Kind)&&(e.uv6s=this._toNumberArray(this.getVerticesData(te.UV6Kind)),this.isVertexBufferUpdatable(te.UV6Kind)&&(e.uv6s._updatable=!0)),this.isVerticesDataPresent(te.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(te.ColorKind)),this.isVertexBufferUpdatable(te.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(te.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(te.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(te.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(te.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(te.MatricesWeightsKind)),this.isVertexBufferUpdatable(te.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,i){const s=e._geometry;return s?s.copy(i):null}static RandomId(){return Le.RandomId()}static _GetGeometryByLoadedUniqueId(e,i){for(let s=0;s<i.geometries.length;s++)if(i.geometries[s]._loadedUniqueId===e)return i.geometries[s];return null}static _ImportGeometry(e,i){const s=i.getScene(),n=e.geometryUniqueId,a=e.geometryId;if(n||a){const p=n?this._GetGeometryByLoadedUniqueId(n,s):s.getGeometryById(a);p&&p.applyToMesh(i)}else if(e instanceof ArrayBuffer){const p=i._binaryInfo;if(p.positionsAttrDesc&&p.positionsAttrDesc.count>0){const _=new Float32Array(e,p.positionsAttrDesc.offset,p.positionsAttrDesc.count);i.setVerticesData(te.PositionKind,_,!1)}if(p.normalsAttrDesc&&p.normalsAttrDesc.count>0){const _=new Float32Array(e,p.normalsAttrDesc.offset,p.normalsAttrDesc.count);i.setVerticesData(te.NormalKind,_,!1)}if(p.tangetsAttrDesc&&p.tangetsAttrDesc.count>0){const _=new Float32Array(e,p.tangetsAttrDesc.offset,p.tangetsAttrDesc.count);i.setVerticesData(te.TangentKind,_,!1)}if(p.uvsAttrDesc&&p.uvsAttrDesc.count>0){const _=new Float32Array(e,p.uvsAttrDesc.offset,p.uvsAttrDesc.count);if(wr.UseOpenGLOrientationForUV)for(let g=1;g<_.length;g+=2)_[g]=1-_[g];i.setVerticesData(te.UVKind,_,!1)}if(p.uvs2AttrDesc&&p.uvs2AttrDesc.count>0){const _=new Float32Array(e,p.uvs2AttrDesc.offset,p.uvs2AttrDesc.count);if(wr.UseOpenGLOrientationForUV)for(let g=1;g<_.length;g+=2)_[g]=1-_[g];i.setVerticesData(te.UV2Kind,_,!1)}if(p.uvs3AttrDesc&&p.uvs3AttrDesc.count>0){const _=new Float32Array(e,p.uvs3AttrDesc.offset,p.uvs3AttrDesc.count);if(wr.UseOpenGLOrientationForUV)for(let g=1;g<_.length;g+=2)_[g]=1-_[g];i.setVerticesData(te.UV3Kind,_,!1)}if(p.uvs4AttrDesc&&p.uvs4AttrDesc.count>0){const _=new Float32Array(e,p.uvs4AttrDesc.offset,p.uvs4AttrDesc.count);if(wr.UseOpenGLOrientationForUV)for(let g=1;g<_.length;g+=2)_[g]=1-_[g];i.setVerticesData(te.UV4Kind,_,!1)}if(p.uvs5AttrDesc&&p.uvs5AttrDesc.count>0){const _=new Float32Array(e,p.uvs5AttrDesc.offset,p.uvs5AttrDesc.count);if(wr.UseOpenGLOrientationForUV)for(let g=1;g<_.length;g+=2)_[g]=1-_[g];i.setVerticesData(te.UV5Kind,_,!1)}if(p.uvs6AttrDesc&&p.uvs6AttrDesc.count>0){const _=new Float32Array(e,p.uvs6AttrDesc.offset,p.uvs6AttrDesc.count);if(wr.UseOpenGLOrientationForUV)for(let g=1;g<_.length;g+=2)_[g]=1-_[g];i.setVerticesData(te.UV6Kind,_,!1)}if(p.colorsAttrDesc&&p.colorsAttrDesc.count>0){const _=new Float32Array(e,p.colorsAttrDesc.offset,p.colorsAttrDesc.count);i.setVerticesData(te.ColorKind,_,!1,p.colorsAttrDesc.stride)}if(p.matricesIndicesAttrDesc&&p.matricesIndicesAttrDesc.count>0){const _=new Int32Array(e,p.matricesIndicesAttrDesc.offset,p.matricesIndicesAttrDesc.count),g=[];for(let y=0;y<_.length;y++){const b=_[y];g.push(b&255),g.push((b&65280)>>8),g.push((b&16711680)>>16),g.push(b>>24&255)}i.setVerticesData(te.MatricesIndicesKind,g,!1)}if(p.matricesIndicesExtraAttrDesc&&p.matricesIndicesExtraAttrDesc.count>0){const _=new Int32Array(e,p.matricesIndicesExtraAttrDesc.offset,p.matricesIndicesExtraAttrDesc.count),g=[];for(let y=0;y<_.length;y++){const b=_[y];g.push(b&255),g.push((b&65280)>>8),g.push((b&16711680)>>16),g.push(b>>24&255)}i.setVerticesData(te.MatricesIndicesExtraKind,g,!1)}if(p.matricesWeightsAttrDesc&&p.matricesWeightsAttrDesc.count>0){const _=new Float32Array(e,p.matricesWeightsAttrDesc.offset,p.matricesWeightsAttrDesc.count);i.setVerticesData(te.MatricesWeightsKind,_,!1)}if(p.indicesAttrDesc&&p.indicesAttrDesc.count>0){const _=new Int32Array(e,p.indicesAttrDesc.offset,p.indicesAttrDesc.count);i.setIndices(_,null)}if(p.subMeshesAttrDesc&&p.subMeshesAttrDesc.count>0){const _=new Int32Array(e,p.subMeshesAttrDesc.offset,p.subMeshesAttrDesc.count*5);i.subMeshes=[];for(let g=0;g<p.subMeshesAttrDesc.count;g++){const y=_[g*5+0],b=_[g*5+1],v=_[g*5+2],S=_[g*5+3],M=_[g*5+4];Sn.AddToMesh(y,b,v,S,M,i)}}}else if(e.positions&&e.normals&&e.indices){if(i.setVerticesData(te.PositionKind,e.positions,e.positions._updatable),i.setVerticesData(te.NormalKind,e.normals,e.normals._updatable),e.tangents&&i.setVerticesData(te.TangentKind,e.tangents,e.tangents._updatable),e.uvs&&i.setVerticesData(te.UVKind,e.uvs,e.uvs._updatable),e.uvs2&&i.setVerticesData(te.UV2Kind,e.uvs2,e.uvs2._updatable),e.uvs3&&i.setVerticesData(te.UV3Kind,e.uvs3,e.uvs3._updatable),e.uvs4&&i.setVerticesData(te.UV4Kind,e.uvs4,e.uvs4._updatable),e.uvs5&&i.setVerticesData(te.UV5Kind,e.uvs5,e.uvs5._updatable),e.uvs6&&i.setVerticesData(te.UV6Kind,e.uvs6,e.uvs6._updatable),e.colors&&i.setVerticesData(te.ColorKind,pi.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,i.setVerticesData(te.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable);else{const p=[];for(let _=0;_<e.matricesIndices.length;_++){const g=e.matricesIndices[_];p.push(g&255),p.push((g&65280)>>8),p.push((g&16711680)>>16),p.push(g>>24&255)}i.setVerticesData(te.MatricesIndicesKind,p,e.matricesIndices._updatable)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,i.setVerticesData(te.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable);else{const p=[];for(let _=0;_<e.matricesIndicesExtra.length;_++){const g=e.matricesIndicesExtra[_];p.push(g&255),p.push((g&65280)>>8),p.push((g&16711680)>>16),p.push(g>>24&255)}i.setVerticesData(te.MatricesIndicesExtraKind,p,e.matricesIndicesExtra._updatable)}e.matricesWeights&&(cn._CleanMatricesWeights(e,i),i.setVerticesData(te.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&i.setVerticesData(te.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),i.setIndices(e.indices,null)}if(e.subMeshes){i.subMeshes=[];for(let p=0;p<e.subMeshes.length;p++){const _=e.subMeshes[p];Sn.AddToMesh(_.materialIndex,_.verticesStart,_.verticesCount,_.indexStart,_.indexCount,i)}}i._shouldGenerateFlatShading&&(i.convertToFlatShadedMesh(),i._shouldGenerateFlatShading=!1),i.computeWorldMatrix(!0),s.onMeshImportedObservable.notifyObservers(i)}static _CleanMatricesWeights(e,i){if(!ss.CleanBoneMatrixWeights)return;let n=0;if(e.skeletonId>-1){const v=i.getScene().getLastSkeletonById(e.skeletonId);if(!v)return;n=v.bones.length}else return;const a=i.getVerticesData(te.MatricesIndicesKind),p=i.getVerticesData(te.MatricesIndicesExtraKind),_=e.matricesWeights,g=e.matricesWeightsExtra,y=e.numBoneInfluencer,b=_.length;for(let v=0;v<b;v+=4){let S=0,M=-1;for(let F=0;F<4;F++){const L=_[v+F];S+=L,L<.001&&M<0&&(M=F)}if(g)for(let F=0;F<4;F++){const L=g[v+F];S+=L,L<.001&&M<0&&(M=F+4)}if((M<0||M>y-1)&&(M=y-1),S>.001){const F=1/S;for(let L=0;L<4;L++)_[v+L]*=F;if(g)for(let L=0;L<4;L++)g[v+L]*=F}else M>=4?(g[v+M-4]=1-S,p[v+M-4]=n):(_[v+M]=1-S,a[v+M]=n)}i.setVerticesData(te.MatricesIndicesKind,a),e.matricesWeightsExtra&&i.setVerticesData(te.MatricesIndicesExtraKind,p)}static Parse(e,i,s){const n=new cn(e.id,i,void 0,e.updatable);return n._loadedUniqueId=e.uniqueId,Bi&&Bi.AddTagsTo(n,e.tags),e.delayLoadingFile?(n.delayLoadState=4,n.delayLoadingFile=s+e.delayLoadingFile,n._boundingInfo=new la(j.FromArray(e.boundingBoxMinimum),j.FromArray(e.boundingBoxMaximum)),n._delayInfo=[],e.hasUVs&&n._delayInfo.push(te.UVKind),e.hasUVs2&&n._delayInfo.push(te.UV2Kind),e.hasUVs3&&n._delayInfo.push(te.UV3Kind),e.hasUVs4&&n._delayInfo.push(te.UV4Kind),e.hasUVs5&&n._delayInfo.push(te.UV5Kind),e.hasUVs6&&n._delayInfo.push(te.UV6Kind),e.hasColors&&n._delayInfo.push(te.ColorKind),e.hasMatricesIndices&&n._delayInfo.push(te.MatricesIndicesKind),e.hasMatricesWeights&&n._delayInfo.push(te.MatricesWeightsKind),n._delayLoadingFunction=Mt.ImportVertexData):Mt.ImportVertexData(e,n),i.pushGeometry(n,!0),n}}class yl extends Be{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}constructor(e,i){super(e,i,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().multiMaterials.push(this),this.subMaterials=new Array,this._storeEffectOnSubMeshes=!0}_hookArray(e){const i=e.push;e.push=(...n)=>{const a=i.apply(e,n);return this._markAllSubMeshesAsTexturesDirty(),a};const s=e.splice;e.splice=(n,a)=>{const p=s.apply(e,[n,a]);return this._markAllSubMeshesAsTexturesDirty(),p}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map(e=>e?e.getActiveTextures():[]))}hasTexture(e){var i;if(super.hasTexture(e))return!0;for(let s=0;s<this.subMaterials.length;s++)if(!((i=this.subMaterials[s])===null||i===void 0)&&i.hasTexture(e))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(e,i,s){for(let n=0;n<this.subMaterials.length;n++){const a=this.subMaterials[n];if(a){if(a._storeEffectOnSubMeshes){if(!a.isReadyForSubMesh(e,i,s))return!1;continue}if(!a.isReady(e))return!1}}return!0}clone(e,i){const s=new yl(e,this.getScene());for(let n=0;n<this.subMaterials.length;n++){let a=null;const p=this.subMaterials[n];i&&p?a=p.clone(e+"-"+p.name):a=this.subMaterials[n],s.subMaterials.push(a)}return s}serialize(){const e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,Bi&&(e.tags=Bi.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let i=0;i<this.subMaterials.length;i++){const s=this.subMaterials[i];s?(e.materialsUniqueIds.push(s.uniqueId),e.materials.push(s.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,i,s){const n=this.getScene();if(!n)return;if(s)for(let p=0;p<this.subMaterials.length;p++){const _=this.subMaterials[p];_&&_.dispose(e,i)}const a=n.multiMaterials.indexOf(this);a>=0&&n.multiMaterials.splice(a,1),super.dispose(e,i)}static ParseMultiMaterial(e,i){const s=new yl(e.name,i);return s.id=e.id,s._loadedUniqueId=e.uniqueId,Bi&&Bi.AddTagsTo(s,e.tags),e.materialsUniqueIds?s._waitingSubMaterialsUniqueIds=e.materialsUniqueIds:e.materials.forEach(n=>s.subMaterials.push(i.getLastMaterialById(n))),s}}ur("BABYLON.MultiMaterial",yl);class qW{constructor(e,i){this.distanceOrScreenCoverage=e,this.mesh=i}}class ZW{}class QW{constructor(){this.visibleInstances={},this.batchCache=new cI,this.batchCacheReplacementModeInFrozenMode=new cI,this.instancesBufferSize=32*16*4}}class cI{constructor(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array,this.hardwareInstancedRendering=new Array}}class $W{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=32*16,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}}class JW{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0,this._overrideRenderingFillMode=null}}class Qe extends Ds{static _GetDefaultSideOrientation(e){return e||Qe.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(te.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(te.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new Re),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new Re),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new Re),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new Re),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new Re),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){var e;return((e=this._thinInstanceDataStorage.instancesCount)!==null&&e!==void 0?e:0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get overrideRenderingFillMode(){return this._internalMeshDataInfo._overrideRenderingFillMode}set overrideRenderingFillMode(e){this._internalMeshDataInfo._overrideRenderingFillMode=e}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesData}get previousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}constructor(e,i=null,s=null,n=null,a,p=!0){if(super(e,i),this._internalMeshDataInfo=new JW,this.delayLoadState=0,this.instances=new Array,this._creationDataStorage=null,this._geometry=null,this._instanceDataStorage=new QW,this._thinInstanceDataStorage=new $W,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=Qe.DEFAULTSIDE,this.overrideMaterialSideOrientation=null,this.ignoreCameraMaxZ=!1,i=this.getScene(),this._onBeforeDraw=(_,g,y)=>{_&&y&&(this._uniformBuffer?this.transferToEffect(g):y.bindOnlyWorldMatrix(g))},n){if(n._geometry&&n._geometry.applyToMesh(this),Ya.DeepCopy(n,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo"],["_poseMatrix"]),this._internalMeshDataInfo._source=n,i.useClonedMeshMap&&(n._internalMeshDataInfo.meshMap||(n._internalMeshDataInfo.meshMap={}),n._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=n._originalBuilderSideOrientation,this._creationDataStorage=n._creationDataStorage,n._ranges){const _=n._ranges;for(const g in _)!Object.prototype.hasOwnProperty.call(_,g)||!_[g]||this.createAnimationRange(g,_[g].from,_[g].to)}if(n.metadata&&n.metadata.clone?this.metadata=n.metadata.clone():this.metadata=n.metadata,this._internalMetadata=n._internalMetadata,Bi&&Bi.HasTags(n)&&Bi.AddTagsTo(this,Bi.GetTags(n,!0)),this.setEnabled(n.isEnabled(!1)),this.parent=n.parent,this.setPivotMatrix(n.getPivotMatrix()),this.id=e+"."+n.id,this.material=n.material,!a){const _=n.getDescendants(!0);for(let g=0;g<_.length;g++){const y=_[g];y.clone&&y.clone(e+"."+y.name,this)}}if(n.morphTargetManager&&(this.morphTargetManager=n.morphTargetManager),i.getPhysicsEngine){const _=i.getPhysicsEngine();if(p&&_)if(_.getPluginVersion()===1){const g=_.getImpostorForPhysicsObject(n);g&&(this.physicsImpostor=g.clone(this))}else _.getPluginVersion()===2&&n.physicsBody&&n.physicsBody.clone(this)}for(let _=0;_<i.particleSystems.length;_++){const g=i.particleSystems[_];g.emitter===n&&g.clone(g.name,this)}this.skeleton=n.skeleton,this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}s!==null&&(this.parent=s),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=_=>{_.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add(()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))}))},this.onMeshReadyObservable=new Re(this._internalMeshDataInfo._onMeshReadyObserverAdded),n&&n.onClonedObservable.notifyObservers(this)}instantiateHierarchy(e=null,i,s){const n=this.getTotalVertices()===0||i&&i.doNotInstantiate&&(i.doNotInstantiate===!0||i.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));n.parent=e||this.parent,n.position=this.position.clone(),n.scaling=this.scaling.clone(),this.rotationQuaternion?n.rotationQuaternion=this.rotationQuaternion.clone():n.rotation=this.rotation.clone(),s&&s(this,n);for(const a of this.getChildTransformNodes(!0))a.getClassName()==="InstancedMesh"&&n.getClassName()==="Mesh"&&a.sourceMesh===this?a.instantiateHierarchy(n,{doNotInstantiate:i&&i.doNotInstantiate||!1,newSourcedMesh:n},s):a.instantiateHierarchy(n,i,s);return n}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let i=super.toString(e);if(i+=", n vertices: "+this.getTotalVertices(),i+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let s=0;s<this.animations.length;s++)i+=", animation[0]: "+this.animations[s].toString(e);if(e)if(this._geometry){const s=this.getIndices(),n=this.getVerticesData(te.PositionKind);n&&s&&(i+=", flat shading: "+(n.length/3===s.length?"YES":"NO"))}else i+=", flat shading: UNKNOWN";return i}_unBindEffect(){super._unBindEffect();for(const e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){const e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((i,s)=>i.distanceOrScreenCoverage<s.distanceOrScreenCoverage?e:i.distanceOrScreenCoverage>s.distanceOrScreenCoverage?-e:0)}addLODLevel(e,i){if(i&&i._masterMesh)return Ie.Warn("You cannot use a mesh as LOD level twice"),this;const s=new qW(e,i);return this._internalMeshDataInfo._LODLevels.push(s),i&&(i._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){const i=this._internalMeshDataInfo;for(let s=0;s<i._LODLevels.length;s++){const n=i._LODLevels[s];if(n.distanceOrScreenCoverage===e)return n.mesh}return null}removeLODLevel(e){const i=this._internalMeshDataInfo;for(let s=0;s<i._LODLevels.length;s++)i._LODLevels[s].mesh===e&&(i._LODLevels.splice(s,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,i){const s=this._internalMeshDataInfo;if(!s._LODLevels||s._LODLevels.length===0)return this;const n=i||this.getBoundingInfo().boundingSphere,a=e.mode===wt.ORTHOGRAPHIC_CAMERA?e.minZ:n.centerWorld.subtract(e.globalPosition).length();let p=a,_=1;if(s._useLODScreenCoverage){const g=e.screenArea;let y=n.radiusWorld*e.minZ/a;y=y*y*Math.PI,p=y/g,_=-1}if(_*s._LODLevels[s._LODLevels.length-1].distanceOrScreenCoverage>_*p)return this.onLODLevelSelection&&this.onLODLevelSelection(p,this,this),this;for(let g=0;g<s._LODLevels.length;g++){const y=s._LODLevels[g];if(_*y.distanceOrScreenCoverage<_*p){if(y.mesh){if(y.mesh.delayLoadState===4)return y.mesh._checkDelayState(),this;if(y.mesh.delayLoadState===2)return this;y.mesh._preActivate(),y.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(p,this,y.mesh),y.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(p,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return this._geometry===null||this._geometry===void 0?0:this._geometry.getTotalVertices()}getVerticesData(e,i,s,n){var a,p;if(!this._geometry)return null;let _=n||(p=(a=this._userInstancedBuffersStorage)===null||a===void 0?void 0:a.vertexBuffers[e])===null||p===void 0?void 0:p.getFloatData(this.instances.length+1,s||i&&this._geometry.meshes.length!==1);return _||(_=this._geometry.getVerticesData(e,i,s)),_}getVertexBuffer(e,i){var s,n;return this._geometry?(n=i||(s=this._userInstancedBuffersStorage)===null||s===void 0?void 0:s.vertexBuffers[e])!==null&&n!==void 0?n:this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e,i){var s;return this._geometry?!i&&((s=this._userInstancedBuffersStorage)===null||s===void 0?void 0:s.vertexBuffers[e])!==void 0||this._geometry.isVerticesDataPresent(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}isVertexBufferUpdatable(e,i){var s;if(!this._geometry)return this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1;if(!i){const n=(s=this._userInstancedBuffersStorage)===null||s===void 0?void 0:s.vertexBuffers[e];if(n)return n.isUpdatable()}return this._geometry.isVertexBufferUpdatable(e)}getVerticesDataKinds(e){if(!this._geometry){const s=new Array;return this._delayInfo&&this._delayInfo.forEach(function(n){s.push(n)}),s}const i=this._geometry.getVerticesDataKinds();if(!e&&this._userInstancedBuffersStorage)for(const s in this._userInstancedBuffersStorage.vertexBuffers)i.indexOf(s)===-1&&i.push(s);return i}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,i){return this._geometry?this._geometry.getIndices(e,i):[]}get isBlocked(){return this._masterMesh!==null&&this._masterMesh!==void 0}isReady(e=!1,i=!1){var s,n,a,p,_,g;if(this.delayLoadState===2||!super.isReady(e))return!1;if(!this.subMeshes||this.subMeshes.length===0||!e)return!0;const y=this.getEngine(),b=this.getScene(),v=i||y.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();const S=this.material||b.defaultMaterial;if(S){if(S._storeEffectOnSubMeshes)for(const F of this.subMeshes){const L=F.getMaterial();if(L){if(L._storeEffectOnSubMeshes){if(!L.isReadyForSubMesh(this,F,v))return!1}else if(!L.isReady(this,v))return!1}}else if(!S.isReady(this,v))return!1}const M=y.currentRenderPassId;for(const F of this.lightSources){const L=F.getShadowGenerators();if(!L)continue;const N=L.values();for(let k=N.next();k.done!==!0;k=N.next()){const G=k.value;if(G&&(!(!((s=G.getShadowMap())===null||s===void 0)&&s.renderList)||((n=G.getShadowMap())===null||n===void 0?void 0:n.renderList)&&((p=(a=G.getShadowMap())===null||a===void 0?void 0:a.renderList)===null||p===void 0?void 0:p.indexOf(this))!==-1)){G.getShadowMap()&&(y.currentRenderPassId=G.getShadowMap().renderPassId);for(const H of this.subMeshes)if(!G.isReady(H,v,(g=(_=H.getMaterial())===null||_===void 0?void 0:_.needAlphaBlendingForMesh(this))!==null&&g!==void 0?g:!1))return y.currentRenderPassId=M,!1;y.currentRenderPassId=M}}}for(const F of this._internalMeshDataInfo._LODLevels)if(F.mesh&&!F.mesh.isReady(v))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_preActivate(){const e=this._internalMeshDataInfo,i=this.getScene().getRenderId();return e._preActivateId===i?this:(e._preActivateId=i,this._instanceDataStorage.visibleInstances=null,this)}_preActivateForIntermediateRendering(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,i){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:i,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[i]||(this._instanceDataStorage.previousRenderId!==void 0&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=i,this._instanceDataStorage.visibleInstances[i]=new Array),this._instanceDataStorage.visibleInstances[i].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,i=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const s=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(e,i),s),this}_createGlobalSubMesh(e){const i=this.getTotalVertices();if(!i||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){const s=this.getIndices();if(!s)return null;const n=s.length;let a=!1;if(e)a=!0;else for(const p of this.subMeshes){if(p.indexStart+p.indexCount>n){a=!0;break}if(p.verticesStart+p.verticesCount>i){a=!0;break}}if(!a)return this.subMeshes[0]}return this.releaseSubMeshes(),new Sn(0,0,i,0,this.getTotalIndices(),this)}subdivide(e){if(e<1)return;const i=this.getTotalIndices();let s=i/e|0,n=0;for(;s%3!==0;)s++;this.releaseSubMeshes();for(let a=0;a<e&&!(n>=i);a++)Sn.CreateFromIndices(0,n,a===e-1?i-n:s,this),n+=s;this.synchronizeInstances()}setVerticesData(e,i,s=!1,n){if(this._geometry)this._geometry.setVerticesData(e,i,s,n);else{const a=new Mt;a.set(i,e);const p=this.getScene();new cn(cn.RandomId(),p,a,s,this)}return this}removeVerticesData(e){!this._geometry||this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,i=!0){const s=this.getVertexBuffer(e);!s||s.isUpdatable()===i||this.setVerticesData(e,this.getVerticesData(e),i)}setVerticesBuffer(e,i=!0){return this._geometry||(this._geometry=cn.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,i),this}updateVerticesData(e,i,s,n){return this._geometry?(n?(this.makeGeometryUnique(),this.updateVerticesData(e,i,s,!1)):this._geometry.updateVerticesData(e,i,s),this):this}updateMeshPositions(e,i=!0){const s=this.getVerticesData(te.PositionKind);if(!s)return this;if(e(s),this.updateVerticesData(te.PositionKind,s,!1,!1),i){const n=this.getIndices(),a=this.getVerticesData(te.NormalKind);if(!a)return this;Mt.ComputeNormals(s,n,a),this.updateVerticesData(te.NormalKind,a,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(this._geometry.meshes.length===1)return this;const e=this._geometry,i=this._geometry.copy(cn.RandomId());return e.releaseForMesh(this,!0),i.applyToMesh(this),this}setIndices(e,i=null,s=!1){if(this._geometry)this._geometry.setIndices(e,i,s);else{const n=new Mt;n.indices=e;const a=this.getScene();new cn(cn.RandomId(),a,n,s,this)}return this}updateIndices(e,i,s=!1){return this._geometry?(this._geometry.updateIndices(e,i,s),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,i,s,n=!0){if(!this._geometry)return this;const a=this.getScene().getEngine();this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(i);let p;if(this._unIndexed)p=null;else switch(this._getRenderingFillMode(s)){case Be.PointFillMode:p=null;break;case Be.WireFrameFillMode:p=e._getLinesIndexBuffer(this.getIndices(),a);break;default:case Be.TriangleFillMode:p=this._geometry.getIndexBuffer();break}return!n||!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(i,p):this._geometry._bind(i,p,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),this}_draw(e,i,s){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);const a=this.getScene().getEngine();return this._unIndexed||i==Be.PointFillMode?a.drawArraysType(i,e.verticesStart,e.verticesCount,this.forcedInstanceCount||s):i==Be.WireFrameFillMode?a.drawElementsType(i,0,e._linesIndexCount,this.forcedInstanceCount||s):a.drawElementsType(i,e.indexStart,e.indexCount,this.forcedInstanceCount||s),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,i=!1){if(this._instanceDataStorage.isFrozen){if(i)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}const s=this.getScene(),n=s._isInIntermediateRendering(),a=n?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,p=this._instanceDataStorage.batchCache;if(p.mustReturn=!1,p.renderSelf[e]=i||!a&&this.isEnabled()&&this.isVisible,p.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!i){const _=this._instanceDataStorage.visibleInstances,g=s.getRenderId(),y=n?_.intermediateDefaultRenderId:_.defaultRenderId;p.visibleInstances[e]=_[g],!p.visibleInstances[e]&&y&&(p.visibleInstances[e]=_[y])}return p.hardwareInstancedRendering[e]=!i&&this._instanceDataStorage.hardwareInstancedRendering&&p.visibleInstances[e]!==null&&p.visibleInstances[e]!==void 0,this._instanceDataStorage.previousBatch=p,p}_renderWithInstances(e,i,s,n,a){var p;const _=s.visibleInstances[e._id],g=_?_.length:0,y=this._instanceDataStorage,b=y.instancesBufferSize;let v=y.instancesBuffer,S=y.instancesPreviousBuffer;const F=(g+1)*16*4;for(;y.instancesBufferSize<F;)y.instancesBufferSize*=2;(!y.instancesData||b!=y.instancesBufferSize)&&(y.instancesData=new Float32Array(y.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!y.instancesPreviousData||b!=y.instancesBufferSize)&&(y.instancesPreviousData=new Float32Array(y.instancesBufferSize/4));let L=0,N=0;const k=s.renderSelf[e._id],G=!v||b!==y.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!y.instancesPreviousBuffer;if(!this._instanceDataStorage.manualUpdate&&(!y.isFrozen||G)){const H=this.getWorldMatrix();if(k&&(this._scene.needsPreviousWorldMatrices&&(y.masterMeshPreviousWorldMatrix?(y.masterMeshPreviousWorldMatrix.copyToArray(y.instancesPreviousData,L),y.masterMeshPreviousWorldMatrix.copyFrom(H)):(y.masterMeshPreviousWorldMatrix=H.clone(),y.masterMeshPreviousWorldMatrix.copyToArray(y.instancesPreviousData,L))),H.copyToArray(y.instancesData,L),L+=16,N++),_){if(Qe.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&((p=e.getMaterial())===null||p===void 0?void 0:p.needAlphaBlendingForMesh(e.getRenderingMesh()))){const z=this._scene.activeCamera.globalPosition;for(let W=0;W<_.length;W++){const Y=_[W];Y._distanceToCamera=j.Distance(Y.getBoundingInfo().boundingSphere.centerWorld,z)}_.sort((W,Y)=>W._distanceToCamera>Y._distanceToCamera?-1:W._distanceToCamera<Y._distanceToCamera?1:0)}for(let z=0;z<_.length;z++){const W=_[z],Y=W.getWorldMatrix();Y.copyToArray(y.instancesData,L),this._scene.needsPreviousWorldMatrices&&(W._previousWorldMatrix?(W._previousWorldMatrix.copyToArray(y.instancesPreviousData,L),W._previousWorldMatrix.copyFrom(Y)):(W._previousWorldMatrix=Y.clone(),W._previousWorldMatrix.copyToArray(y.instancesPreviousData,L))),L+=16,N++}}}else N=(k?1:0)+g;return G?(v&&v.dispose(),S&&S.dispose(),v=new bc(a,y.instancesData,!0,16,!1,!0),y.instancesBuffer=v,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=v.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=v.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=v.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=v.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(S=new bc(a,y.instancesPreviousData,!0,16,!1,!0),y.instancesPreviousBuffer=S,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=S.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=S.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=S.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=S.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&(v.updateDirectly(y.instancesData,0,N),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&S.updateDirectly(y.instancesPreviousData,0,N)),this._processInstancedBuffers(_,k),this.getScene()._activeIndices.addCount(e.indexCount*N,!1),a._currentDrawContext&&(a._currentDrawContext.useInstancing=!0),this._bind(e,n,i),this._draw(e,i,N),this._scene.needsPreviousWorldMatrices&&!G&&this._instanceDataStorage.manualUpdate&&(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&!this._instanceDataStorage.previousManualUpdate&&S.updateDirectly(y.instancesData,0,N),a.unbindInstanceAttributes(),this}_renderWithThinInstances(e,i,s,n){var a,p;const _=(p=(a=this._thinInstanceDataStorage)===null||a===void 0?void 0:a.instancesCount)!==null&&p!==void 0?p:0;this.getScene()._activeIndices.addCount(e.indexCount*_,!1),n._currentDrawContext&&(n._currentDrawContext.useInstancing=!0),this._bind(e,s,i),this._draw(e,i,_),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,_):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),n.unbindInstanceAttributes()}_processInstancedBuffers(e,i){}_processRendering(e,i,s,n,a,p,_,g){const y=this.getScene(),b=y.getEngine();if(n=this._getRenderingFillMode(n),p&&i.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(i,n,s,b),this;if(p)this._renderWithInstances(i,n,a,s,b);else{b._currentDrawContext&&(b._currentDrawContext.useInstancing=!1);let v=0;a.renderSelf[i._id]&&(_&&_(!1,e.getWorldMatrix(),g),v++,this._draw(i,n,this._instanceDataStorage.overridenInstanceCount));const S=a.visibleInstances[i._id];if(S){const M=S.length;v+=M;for(let F=0;F<M;F++){const N=S[F].getWorldMatrix();_&&_(!0,N,g),this._draw(i,n)}}y._activeIndices.addCount(i.indexCount*v,!1)}return this}_rebuild(e=!1){if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(const i in this._userInstancedBuffersStorage.vertexBuffers){const s=this._userInstancedBuffersStorage.vertexBuffers[i];s&&(e&&s.dispose(),this._userInstancedBuffersStorage.vertexBuffers[i]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(!!this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}render(e,i,s){var n,a,p;const _=this.getScene();if(this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1,this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;const g=this._getInstancesRenderList(e._id,!!s);if(g.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const y=_.getEngine();let b=0,v=null;this.ignoreCameraMaxZ&&_.activeCamera&&!_._isInIntermediateRendering()&&(b=_.activeCamera.maxZ,v=_.activeCamera,_.activeCamera.maxZ=0,_.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);const S=e.getRenderingMesh(),M=g.hardwareInstancedRendering[e._id]||S.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,F=this._instanceDataStorage,L=e.getMaterial();if(!L)return v&&(v.maxZ=b,_.updateTransformMatrix(!0)),this;if(!F.isFrozen||!this._internalMeshDataInfo._effectiveMaterial||this._internalMeshDataInfo._effectiveMaterial!==L){if(L._storeEffectOnSubMeshes){if(!L.isReadyForSubMesh(this,e,M))return v&&(v.maxZ=b,_.updateTransformMatrix(!0)),this}else if(!L.isReady(this,M))return v&&(v.maxZ=b,_.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=L}else if(L._storeEffectOnSubMeshes&&!(!((n=e.effect)===null||n===void 0)&&n._wasPreviouslyReady)||!L._storeEffectOnSubMeshes&&!(!((a=L.getEffect())===null||a===void 0)&&a._wasPreviouslyReady))return v&&(v.maxZ=b,_.updateTransformMatrix(!0)),this;i&&y.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode);let N;this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?N=e._drawWrapper:N=this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();const k=(p=N?.effect)!==null&&p!==void 0?p:null;for(const Q of _._beforeRenderingMeshStage)Q.action(this,e,g,k);if(!N||!k)return v&&(v.maxZ=b,_.updateTransformMatrix(!0)),this;const G=s||this;let H;if(!F.isFrozen&&(this._internalMeshDataInfo._effectiveMaterial.backFaceCulling||this.overrideMaterialSideOrientation!==null)){const Q=G._getWorldMatrixDeterminant();H=this.overrideMaterialSideOrientation,H==null&&(H=this._internalMeshDataInfo._effectiveMaterial.sideOrientation),Q<0&&(H=H===Be.ClockWiseSideOrientation?Be.CounterClockWiseSideOrientation:Be.ClockWiseSideOrientation),F.sideOrientation=H}else H=F.sideOrientation;const z=this._internalMeshDataInfo._effectiveMaterial._preBind(N,H);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&y.setDepthWrite(!0);const W=this._internalMeshDataInfo._effectiveMaterial,Y=W.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),M||this._bind(e,k,Y,!1);const Z=G.getWorldMatrix();W._storeEffectOnSubMeshes?W.bindForSubMesh(Z,this,e):W.bind(Z,this),!W.backFaceCulling&&W.separateCullingPass&&(y.setState(!0,W.zOffset,!1,!z,W.cullBackFaces,W.stencil,W.zOffsetUnits),this._processRendering(this,e,k,Y,g,M,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),y.setState(!0,W.zOffset,!1,z,W.cullBackFaces,W.stencil,W.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,k,Y,g,M,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(const Q of _._afterRenderingMeshStage)Q.action(this,e,g,k);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),v&&(v.maxZ=b,_.updateTransformMatrix(!0)),_.performancePriority===zo.Aggressive&&!F.isFrozen&&this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(te.MatricesWeightsKind)&&(this.isVerticesDataPresent(te.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){const e=this.getVerticesData(te.MatricesWeightsKind),i=e.length;for(let s=0;s<i;s+=4){const n=e[s]+e[s+1]+e[s+2]+e[s+3];if(n===0)e[s]=1;else{const a=1/n;e[s]*=a,e[s+1]*=a,e[s+2]*=a,e[s+3]*=a}}this.setVerticesData(te.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){const e=this.getVerticesData(te.MatricesWeightsExtraKind),i=this.getVerticesData(te.MatricesWeightsKind),s=i.length;for(let n=0;n<s;n+=4){let a=i[n]+i[n+1]+i[n+2]+i[n+3];if(a+=e[n]+e[n+1]+e[n+2]+e[n+3],a===0)i[n]=1;else{const p=1/a;i[n]*=p,i[n+1]*=p,i[n+2]*=p,i[n+3]*=p,e[n]*=p,e[n+1]*=p,e[n+2]*=p,e[n+3]*=p}}this.setVerticesData(te.MatricesWeightsKind,i),this.setVerticesData(te.MatricesWeightsKind,e)}validateSkinning(){const e=this.getVerticesData(te.MatricesWeightsExtraKind),i=this.getVerticesData(te.MatricesWeightsKind);if(i===null||this.skeleton==null)return{skinned:!1,valid:!0,report:"not skinned"};const s=i.length;let n=0,a=0,p=0,_=0;const g=e===null?4:8,y=new Array;for(let N=0;N<=g;N++)y[N]=0;const b=.001;for(let N=0;N<s;N+=4){let k=i[N],G=k,H=G===0?0:1;for(let z=1;z<g;z++){const W=z<4?i[N+z]:e[N+z-4];W>k&&n++,W!==0&&H++,G+=W,k=W}if(y[H]++,H>p&&(p=H),G===0)a++;else{const z=1/G;let W=0;for(let Y=0;Y<g;Y++)Y<4?W+=Math.abs(i[N+Y]-i[N+Y]*z):W+=Math.abs(e[N+Y-4]-e[N+Y-4]*z);W>b&&_++}}const v=this.skeleton.bones.length,S=this.getVerticesData(te.MatricesIndicesKind),M=this.getVerticesData(te.MatricesIndicesExtraKind);let F=0;for(let N=0;N<s;N+=4)for(let k=0;k<g;k++){const G=k<4?S[N+k]:M[N+k-4];(G>=v||G<0)&&F++}const L="Number of Weights = "+s/4+`
Maximum influences = `+p+`
Missing Weights = `+a+`
Not Sorted = `+n+`
Not Normalized = `+_+`
WeightCounts = [`+y+`]
Number of bones = `+v+`
Bad Bone Indices = `+F;return{skinned:!0,valid:a===0&&_===0&&F===0,report:L}}_checkDelayState(){const e=this.getScene();return this._geometry?this._geometry.load(e):this.delayLoadState===4&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);const i=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;return Le.LoadFile(this.delayLoadingFile,s=>{s instanceof ArrayBuffer?this._delayLoadingFunction(s,this):this._delayLoadingFunction(JSON.parse(s),this),this.instances.forEach(n=>{n.refreshBoundingInfo(),n._syncSubMeshes()}),this.delayLoadState=1,e.removePendingData(this)},()=>{},e.offlineProvider,i),this}isInFrustum(e){return this.delayLoadState===2||!super.isInFrustum(e)?!1:(this._checkDelayState(),!0)}setMaterialById(e){const i=this.getScene().materials;let s;for(s=i.length-1;s>-1;s--)if(i[s].id===e)return this.material=i[s],this;const n=this.getScene().multiMaterials;for(s=n.length-1;s>-1;s--)if(n[s].id===e)return this.material=n[s],this;return this}getAnimatables(){const e=new Array;return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(te.PositionKind))return this;const i=this.subMeshes.splice(0);this._resetPointsArrayCache();let s=this.getVerticesData(te.PositionKind);const n=j.Zero();let a;for(a=0;a<s.length;a+=3)j.TransformCoordinatesFromFloatsToRef(s[a],s[a+1],s[a+2],e,n).toArray(s,a);if(this.setVerticesData(te.PositionKind,s,this.getVertexBuffer(te.PositionKind).isUpdatable()),this.isVerticesDataPresent(te.NormalKind)){for(s=this.getVerticesData(te.NormalKind),a=0;a<s.length;a+=3)j.TransformNormalFromFloatsToRef(s[a],s[a+1],s[a+2],e,n).normalize().toArray(s,a);this.setVerticesData(te.NormalKind,s,this.getVertexBuffer(te.NormalKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=i,this}bakeCurrentTransformIntoVertices(e=!0){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return this._geometry?this._geometry._generatePointsArray():!1}clone(e="",i=null,s,n=!0){return new Qe(e,this.getScene(),i,this,s,n)}dispose(e,i=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);const s=this._internalMeshDataInfo;if(s._onBeforeDrawObservable&&s._onBeforeDrawObservable.clear(),s._onBeforeBindObservable&&s._onBeforeBindObservable.clear(),s._onBeforeRenderObservable&&s._onBeforeRenderObservable.clear(),s._onAfterRenderObservable&&s._onAfterRenderObservable.clear(),s._onBetweenPassObservable&&s._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(s.meshMap)for(const n in s.meshMap){const a=s.meshMap[n];a&&(a._internalMeshDataInfo._source=null,s.meshMap[n]=void 0)}s._source&&s._source._internalMeshDataInfo.meshMap&&(s._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{const n=this.getScene().meshes;for(const a of n){const p=a;p._internalMeshDataInfo&&p._internalMeshDataInfo._source&&p._internalMeshDataInfo._source===this&&(p._internalMeshDataInfo._source=null)}}s._source=null,this._instanceDataStorage.visibleInstances={},this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,i)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,i,s,n,a,p,_=!1){const g=this.getScene(),y=b=>{const v=b.width,S=b.height,F=this.getEngine().createCanvas(v,S).getContext("2d");F.drawImage(b,0,0);const L=F.getImageData(0,0,v,S).data;this.applyDisplacementMapFromBuffer(L,v,S,i,s,a,p,_),n&&n(this)};return Le.LoadImage(e,y,()=>{},g.offlineProvider),this}applyDisplacementMapFromBuffer(e,i,s,n,a,p,_,g=!1){if(!this.isVerticesDataPresent(te.PositionKind)||!this.isVerticesDataPresent(te.NormalKind)||!this.isVerticesDataPresent(te.UVKind))return Ie.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;const y=this.getVerticesData(te.PositionKind,!0,!0),b=this.getVerticesData(te.NormalKind),v=this.getVerticesData(te.UVKind);let S=j.Zero();const M=j.Zero(),F=ii.Zero();p=p||ii.Zero(),_=_||new ii(1,1);for(let L=0;L<y.length;L+=3){j.FromArrayToRef(y,L,S),j.FromArrayToRef(b,L,M),ii.FromArrayToRef(v,L/3*2,F);const N=Math.abs(F.x*_.x+p.x%1)*(i-1)%i|0,k=Math.abs(F.y*_.y+p.y%1)*(s-1)%s|0,G=(N+k*i)*4,H=e[G]/255,z=e[G+1]/255,W=e[G+2]/255,Y=H*.3+z*.59+W*.11;M.normalize(),M.scaleInPlace(n+(a-n)*Y),S=S.add(M),S.toArray(y,L)}return Mt.ComputeNormals(y,this.getIndices(),b),g?(this.setVerticesData(te.PositionKind,y),this.setVerticesData(te.NormalKind,b),this.setVerticesData(te.UVKind,v)):(this.updateVerticesData(te.PositionKind,y),this.updateVerticesData(te.NormalKind,b)),this}convertToFlatShadedMesh(){const e=this.getVerticesDataKinds(),i={},s={},n={};let a=!1,p,_;for(p=0;p<e.length;p++){_=e[p];const N=this.getVertexBuffer(_),k=N.getData();if(!((k instanceof Array||k instanceof Float32Array)&&k.length===0)){if(_===te.NormalKind){a=N.isUpdatable(),e.splice(p,1),p--;continue}i[_]=N,s[_]=this.getVerticesData(_),n[_]=[]}}const g=this.subMeshes.slice(0),y=this.getIndices(),b=this.getTotalIndices();let v;for(v=0;v<b;v++){const N=y[v];for(p=0;p<e.length;p++){if(_=e[p],!i[_])continue;const k=i[_].getStrideSize();for(let G=0;G<k;G++)n[_].push(s[_][N*k+G])}}const S=[],M=n[te.PositionKind],F=this.getScene().useRightHandedSystem;let L;for(F?L=this.overrideMaterialSideOrientation===1:L=this.overrideMaterialSideOrientation===0,v=0;v<b;v+=3){y[v]=v,y[v+1]=v+1,y[v+2]=v+2;const N=j.FromArray(M,v*3),k=j.FromArray(M,(v+1)*3),G=j.FromArray(M,(v+2)*3),H=N.subtract(k),z=G.subtract(k),W=j.Normalize(j.Cross(H,z));L&&W.scaleInPlace(-1);for(let Y=0;Y<3;Y++)S.push(W.x),S.push(W.y),S.push(W.z)}for(this.setIndices(y),this.setVerticesData(te.NormalKind,S,a),p=0;p<e.length;p++)_=e[p],n[_]&&this.setVerticesData(_,n[_],i[_].isUpdatable());this.releaseSubMeshes();for(let N=0;N<g.length;N++){const k=g[N];Sn.AddToMesh(k.materialIndex,k.indexStart,k.indexCount,k.indexStart,k.indexCount,this)}return this.synchronizeInstances(),this}convertToUnIndexedMesh(){const e=this.getVerticesDataKinds(),i={},s={},n={};let a,p;for(a=0;a<e.length;a++){p=e[a];const v=this.getVertexBuffer(p);i[p]=v,s[p]=i[p].getData(),n[p]=[]}const _=this.subMeshes.slice(0),g=this.getIndices(),y=this.getTotalIndices();let b;for(b=0;b<y;b++){const v=g[b];for(a=0;a<e.length;a++){p=e[a];const S=i[p].getStrideSize();for(let M=0;M<S;M++)n[p].push(s[p][v*S+M])}}for(b=0;b<y;b+=3)g[b]=b,g[b+1]=b+1,g[b+2]=b+2;for(this.setIndices(g),a=0;a<e.length;a++)p=e[a],this.setVerticesData(p,n[p],i[p].isUpdatable(),i[p].getStrideSize());this.releaseSubMeshes();for(let v=0;v<_.length;v++){const S=_[v];Sn.AddToMesh(S.materialIndex,S.indexStart,S.indexCount,S.indexStart,S.indexCount,this)}return this._unIndexed=!0,this.synchronizeInstances(),this}flipFaces(e=!1){const i=Mt.ExtractFromMesh(this);let s;if(e&&this.isVerticesDataPresent(te.NormalKind)&&i.normals)for(s=0;s<i.normals.length;s++)i.normals[s]*=-1;if(i.indices){let n;for(s=0;s<i.indices.length;s+=3)n=i.indices[s+1],i.indices[s+1]=i.indices[s+2],i.indices[s+2]=n}return i.applyToMesh(this,this.isVertexBufferUpdatable(te.PositionKind)),this}increaseVertices(e=1){const i=Mt.ExtractFromMesh(this),s=i.indices&&!Array.isArray(i.indices)&&Array.from?Array.from(i.indices):i.indices,n=i.positions&&!Array.isArray(i.positions)&&Array.from?Array.from(i.positions):i.positions,a=i.uvs&&!Array.isArray(i.uvs)&&Array.from?Array.from(i.uvs):i.uvs,p=i.normals&&!Array.isArray(i.normals)&&Array.from?Array.from(i.normals):i.normals;if(!s||!n)Ie.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions");else{i.indices=s,i.positions=n,a&&(i.uvs=a),p&&(i.normals=p);const _=e+1,g=new Array;for(let W=0;W<_+1;W++)g[W]=new Array;let y,b;const v=new j(0,0,0),S=new j(0,0,0),M=new ii(0,0),F=new Array,L=new Array,N=new Array;let k,G=n.length,H;a&&(H=a.length);let z;p&&(z=p.length);for(let W=0;W<s.length;W+=3){L[0]=s[W],L[1]=s[W+1],L[2]=s[W+2];for(let Y=0;Y<3;Y++)if(y=L[Y],b=L[(Y+1)%3],N[y]===void 0&&N[b]===void 0?(N[y]=new Array,N[b]=new Array):(N[y]===void 0&&(N[y]=new Array),N[b]===void 0&&(N[b]=new Array)),N[y][b]===void 0&&N[b][y]===void 0){N[y][b]=[],v.x=(n[3*b]-n[3*y])/_,v.y=(n[3*b+1]-n[3*y+1])/_,v.z=(n[3*b+2]-n[3*y+2])/_,p&&(S.x=(p[3*b]-p[3*y])/_,S.y=(p[3*b+1]-p[3*y+1])/_,S.z=(p[3*b+2]-p[3*y+2])/_),a&&(M.x=(a[2*b]-a[2*y])/_,M.y=(a[2*b+1]-a[2*y+1])/_),N[y][b].push(y);for(let Z=1;Z<_;Z++)N[y][b].push(n.length/3),n[G++]=n[3*y]+Z*v.x,n[G++]=n[3*y+1]+Z*v.y,n[G++]=n[3*y+2]+Z*v.z,p&&(p[z++]=p[3*y]+Z*S.x,p[z++]=p[3*y+1]+Z*S.y,p[z++]=p[3*y+2]+Z*S.z),a&&(a[H++]=a[2*y]+Z*M.x,a[H++]=a[2*y+1]+Z*M.y);N[y][b].push(b),N[b][y]=new Array,k=N[y][b].length;for(let Z=0;Z<k;Z++)N[b][y][Z]=N[y][b][k-1-Z]}g[0][0]=s[W],g[1][0]=N[s[W]][s[W+1]][1],g[1][1]=N[s[W]][s[W+2]][1];for(let Y=2;Y<_;Y++){g[Y][0]=N[s[W]][s[W+1]][Y],g[Y][Y]=N[s[W]][s[W+2]][Y],v.x=(n[3*g[Y][Y]]-n[3*g[Y][0]])/Y,v.y=(n[3*g[Y][Y]+1]-n[3*g[Y][0]+1])/Y,v.z=(n[3*g[Y][Y]+2]-n[3*g[Y][0]+2])/Y,p&&(S.x=(p[3*g[Y][Y]]-p[3*g[Y][0]])/Y,S.y=(p[3*g[Y][Y]+1]-p[3*g[Y][0]+1])/Y,S.z=(p[3*g[Y][Y]+2]-p[3*g[Y][0]+2])/Y),a&&(M.x=(a[2*g[Y][Y]]-a[2*g[Y][0]])/Y,M.y=(a[2*g[Y][Y]+1]-a[2*g[Y][0]+1])/Y);for(let Z=1;Z<Y;Z++)g[Y][Z]=n.length/3,n[G++]=n[3*g[Y][0]]+Z*v.x,n[G++]=n[3*g[Y][0]+1]+Z*v.y,n[G++]=n[3*g[Y][0]+2]+Z*v.z,p&&(p[z++]=p[3*g[Y][0]]+Z*S.x,p[z++]=p[3*g[Y][0]+1]+Z*S.y,p[z++]=p[3*g[Y][0]+2]+Z*S.z),a&&(a[H++]=a[2*g[Y][0]]+Z*M.x,a[H++]=a[2*g[Y][0]+1]+Z*M.y)}g[_]=N[s[W+1]][s[W+2]],F.push(g[0][0],g[1][0],g[1][1]);for(let Y=1;Y<_;Y++){let Z;for(Z=0;Z<Y;Z++)F.push(g[Y][Z],g[Y+1][Z],g[Y+1][Z+1]),F.push(g[Y][Z],g[Y+1][Z+1],g[Y][Z+1]);F.push(g[Y][Z],g[Y+1][Z],g[Y+1][Z+1])}}i.indices=F,i.applyToMesh(this,this.isVertexBufferUpdatable(te.PositionKind))}}forceSharedVertices(){const e=Mt.ExtractFromMesh(this),i=e.uvs,s=e.indices,n=e.positions,a=e.colors,p=e.matricesIndices,_=e.matricesWeights,g=e.matricesIndicesExtra,y=e.matricesWeightsExtra;if(s===void 0||n===void 0||s===null||n===null)Ie.Warn("VertexData contains empty entries");else{const b=new Array,v=new Array,S=new Array,M=new Array,F=new Array,L=new Array,N=new Array,k=new Array;let G=new Array,H=0;const z={};let W,Y;for(let Q=0;Q<s.length;Q+=3){Y=[s[Q],s[Q+1],s[Q+2]],G=new Array;for(let se=0;se<3;se++){G[se]="";for(let $=0;$<3;$++)Math.abs(n[3*Y[se]+$])<1e-8&&(n[3*Y[se]+$]=0),G[se]+=n[3*Y[se]+$]+"|"}if(!(G[0]==G[1]||G[0]==G[2]||G[1]==G[2]))for(let se=0;se<3;se++){if(W=z[G[se]],W===void 0){z[G[se]]=H,W=H++;for(let $=0;$<3;$++)b.push(n[3*Y[se]+$]);if(a!=null)for(let $=0;$<4;$++)M.push(a[4*Y[se]+$]);if(i!=null)for(let $=0;$<2;$++)S.push(i[2*Y[se]+$]);if(p!=null)for(let $=0;$<4;$++)F.push(p[4*Y[se]+$]);if(_!=null)for(let $=0;$<4;$++)L.push(_[4*Y[se]+$]);if(g!=null)for(let $=0;$<4;$++)N.push(g[4*Y[se]+$]);if(y!=null)for(let $=0;$<4;$++)k.push(y[4*Y[se]+$])}v.push(W)}}const Z=new Array;Mt.ComputeNormals(b,v,Z),e.positions=b,e.indices=v,e.normals=Z,i!=null&&(e.uvs=S),a!=null&&(e.colors=M),p!=null&&(e.matricesIndices=F),_!=null&&(e.matricesWeights=L),g!=null&&(e.matricesIndicesExtra=N),_!=null&&(e.matricesWeightsExtra=k),e.applyToMesh(this,this.isVertexBufferUpdatable(te.PositionKind))}}static _instancedMeshFactory(e,i){throw xi("InstancedMesh")}static _PhysicsImpostorParser(e,i,s){throw xi("PhysicsImpostor")}createInstance(e){return Qe._instancedMeshFactory(e,this)}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){const i=this.getIndices(),s=this.getVerticesData(te.PositionKind);if(!s||!i)return this;const n=new Array;for(let p=0;p<s.length;p=p+3)n.push(j.FromArray(s,p));const a=new Array;return _2.SyncAsyncForLoop(n.length,40,p=>{const _=n.length-1-p,g=n[_];for(let y=0;y<_;++y){const b=n[y];if(g.equals(b)){a[_]=y;break}}},()=>{for(let _=0;_<i.length;++_)i[_]=a[i[_]]||i[_];const p=this.subMeshes.slice(0);this.setIndices(i),this.subMeshes=p,e&&e(this)}),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),Bi&&Bi.HasTags(this)&&(e.tags=Bi.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.checkCollisions=this.checkCollisions,e.isBlocker=this.isBlocker,e.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;const i=this._geometry;if(i&&this.subMeshes){e.geometryUniqueId=i.uniqueId,e.geometryId=i.id,e.subMeshes=[];for(let s=0;s<this.subMeshes.length;s++){const n=this.subMeshes[s];e.subMeshes.push({materialIndex:n.materialIndex,verticesStart:n.verticesStart,verticesCount:n.verticesCount,indexStart:n.indexStart,indexCount:n.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(Vt.NAME_PHYSICSENGINE)){const s=this.getPhysicsImpostor();s&&(e.physicsMass=s.getParam("mass"),e.physicsFriction=s.getParam("friction"),e.physicsRestitution=s.getParam("mass"),e.physicsImpostor=s.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let s=0;s<this.instances.length;s++){const n=this.instances[s];if(n.doNotSerialize)continue;const a={name:n.name,id:n.id,isEnabled:n.isEnabled(!1),isVisible:n.isVisible,isPickable:n.isPickable,checkCollisions:n.checkCollisions,position:n.position.asArray(),scaling:n.scaling.asArray()};if(n.parent&&n.parent._serializeAsParent(a),n.rotationQuaternion?a.rotationQuaternion=n.rotationQuaternion.asArray():n.rotation&&(a.rotation=n.rotation.asArray()),this.getScene()._getComponent(Vt.NAME_PHYSICSENGINE)){const p=n.getPhysicsImpostor();p&&(a.physicsMass=p.getParam("mass"),a.physicsFriction=p.getParam("friction"),a.physicsRestitution=p.getParam("mass"),a.physicsImpostor=p.type)}n.metadata&&(a.metadata=n.metadata),n.actionManager&&(a.actions=n.actionManager.serialize(n.name)),e.instances.push(a),Kt.AppendSerializedAnimations(n,a),a.ranges=n.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){const s={data:{},sizes:{},strides:{}};for(const n in this._userThinInstanceBuffersStorage.data)s.data[n]=Array.from(this._userThinInstanceBuffersStorage.data[n]),s.sizes[n]=this._userThinInstanceBuffersStorage.sizes[n],s.strides[n]=this._userThinInstanceBuffersStorage.strides[n];e.thinInstances.userThinInstance=s}return Kt.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();const e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices()){Ie.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),this.morphTargetManager=null;return}if(e.isUsingTextureForTargets)return;for(let i=0;i<e.numInfluencers;i++){const s=e.getActiveTarget(i),n=s.getPositions();if(!n){Ie.Error("Invalid morph target. Target must have positions.");return}this.geometry.setVerticesData(te.PositionKind+i,n,!1,3);const a=s.getNormals();a&&this.geometry.setVerticesData(te.NormalKind+i,a,!1,3);const p=s.getTangents();p&&this.geometry.setVerticesData(te.TangentKind+i,p,!1,3);const _=s.getUVs();_&&this.geometry.setVerticesData(te.UVKind+"_"+i,_,!1,2)}}else{let i=0;for(;this.geometry.isVerticesDataPresent(te.PositionKind+i);)this.geometry.removeVerticesData(te.PositionKind+i),this.geometry.isVerticesDataPresent(te.NormalKind+i)&&this.geometry.removeVerticesData(te.NormalKind+i),this.geometry.isVerticesDataPresent(te.TangentKind+i)&&this.geometry.removeVerticesData(te.TangentKind+i),this.geometry.isVerticesDataPresent(te.UVKind+i)&&this.geometry.removeVerticesData(te.UVKind+"_"+i),i++}}static Parse(e,i,s){let n;if(e.type&&e.type==="LinesMesh"?n=Qe._LinesMeshParser(e,i):e.type&&e.type==="GroundMesh"?n=Qe._GroundMeshParser(e,i):e.type&&e.type==="GoldbergMesh"?n=Qe._GoldbergMeshParser(e,i):n=new Qe(e.name,i),n.id=e.id,n._waitingParsedUniqueId=e.uniqueId,Bi&&Bi.AddTagsTo(n,e.tags),n.position=j.FromArray(e.position),e.metadata!==void 0&&(n.metadata=e.metadata),e.rotationQuaternion?n.rotationQuaternion=Ve.FromArray(e.rotationQuaternion):e.rotation&&(n.rotation=j.FromArray(e.rotation)),n.scaling=j.FromArray(e.scaling),e.localMatrix?n.setPreTransformMatrix(fe.FromArray(e.localMatrix)):e.pivotMatrix&&n.setPivotMatrix(fe.FromArray(e.pivotMatrix)),n.setEnabled(e.isEnabled),n.isVisible=e.isVisible,n.infiniteDistance=e.infiniteDistance,n.showBoundingBox=e.showBoundingBox,n.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,e.applyFog!==void 0&&(n.applyFog=e.applyFog),e.pickable!==void 0&&(n.isPickable=e.pickable),e.alphaIndex!==void 0&&(n.alphaIndex=e.alphaIndex),n.receiveShadows=e.receiveShadows,e.billboardMode!==void 0&&(n.billboardMode=e.billboardMode),e.visibility!==void 0&&(n.visibility=e.visibility),n.checkCollisions=e.checkCollisions,n.overrideMaterialSideOrientation=e.overrideMaterialSideOrientation,e.isBlocker!==void 0&&(n.isBlocker=e.isBlocker),n._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(n._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),e.parentId!==void 0&&(n._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(n._waitingParentInstanceIndex=e.parentInstanceIndex),e.actions!==void 0&&(n._waitingData.actions=e.actions),e.overlayAlpha!==void 0&&(n.overlayAlpha=e.overlayAlpha),e.overlayColor!==void 0&&(n.overlayColor=qe.FromArray(e.overlayColor)),e.renderOverlay!==void 0&&(n.renderOverlay=e.renderOverlay),n.isUnIndexed=!!e.isUnIndexed,n.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(n.delayLoadState=4,n.delayLoadingFile=s+e.delayLoadingFile,n.buildBoundingInfo(j.FromArray(e.boundingBoxMinimum),j.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(n._binaryInfo=e._binaryInfo),n._delayInfo=[],e.hasUVs&&n._delayInfo.push(te.UVKind),e.hasUVs2&&n._delayInfo.push(te.UV2Kind),e.hasUVs3&&n._delayInfo.push(te.UV3Kind),e.hasUVs4&&n._delayInfo.push(te.UV4Kind),e.hasUVs5&&n._delayInfo.push(te.UV5Kind),e.hasUVs6&&n._delayInfo.push(te.UV6Kind),e.hasColors&&n._delayInfo.push(te.ColorKind),e.hasMatricesIndices&&n._delayInfo.push(te.MatricesIndicesKind),e.hasMatricesWeights&&n._delayInfo.push(te.MatricesWeightsKind),n._delayLoadingFunction=cn._ImportGeometry,ss.ForceFullSceneLoadingForIncremental&&n._checkDelayState()):cn._ImportGeometry(e,n),e.materialUniqueId?n._waitingMaterialId=e.materialUniqueId:e.materialId&&(n._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(n.morphTargetManager=i.getMorphTargetManagerById(e.morphTargetManagerId)),e.skeletonId!==void 0&&e.skeletonId!==null&&(n.skeleton=i.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(n.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let a=0;a<e.animations.length;a++){const p=e.animations[a],_=Ka("BABYLON.Animation");_&&n.animations.push(_.Parse(p))}vr.ParseAnimationRanges(n,e,i)}if(e.autoAnimate&&i.beginAnimation(n,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?n.layerMask=Math.abs(parseInt(e.layerMask)):n.layerMask=268435455,e.physicsImpostor&&Qe._PhysicsImpostorParser(i,n,e),e.lodMeshIds&&(n._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let a=0;a<e.instances.length;a++){const p=e.instances[a],_=n.createInstance(p.name);if(p.id&&(_.id=p.id),Bi&&(p.tags?Bi.AddTagsTo(_,p.tags):Bi.AddTagsTo(_,e.tags)),_.position=j.FromArray(p.position),p.metadata!==void 0&&(_.metadata=p.metadata),p.parentId!==void 0&&(_._waitingParentId=p.parentId),p.parentInstanceIndex!==void 0&&(_._waitingParentInstanceIndex=p.parentInstanceIndex),p.isEnabled!==void 0&&p.isEnabled!==null&&_.setEnabled(p.isEnabled),p.isVisible!==void 0&&p.isVisible!==null&&(_.isVisible=p.isVisible),p.isPickable!==void 0&&p.isPickable!==null&&(_.isPickable=p.isPickable),p.rotationQuaternion?_.rotationQuaternion=Ve.FromArray(p.rotationQuaternion):p.rotation&&(_.rotation=j.FromArray(p.rotation)),_.scaling=j.FromArray(p.scaling),p.checkCollisions!=null&&p.checkCollisions!=null&&(_.checkCollisions=p.checkCollisions),p.pickable!=null&&p.pickable!=null&&(_.isPickable=p.pickable),p.showBoundingBox!=null&&p.showBoundingBox!=null&&(_.showBoundingBox=p.showBoundingBox),p.showSubMeshesBoundingBox!=null&&p.showSubMeshesBoundingBox!=null&&(_.showSubMeshesBoundingBox=p.showSubMeshesBoundingBox),p.alphaIndex!=null&&p.showSubMeshesBoundingBox!=null&&(_.alphaIndex=p.alphaIndex),p.physicsImpostor&&Qe._PhysicsImpostorParser(i,_,p),p.actions!==void 0&&(_._waitingData.actions=p.actions),p.animations){for(let g=0;g<p.animations.length;g++){const y=p.animations[g],b=Ka("BABYLON.Animation");b&&_.animations.push(b.Parse(y))}vr.ParseAnimationRanges(_,p,i),p.autoAnimate&&i.beginAnimation(_,p.autoAnimateFrom,p.autoAnimateTo,p.autoAnimateLoop,p.autoAnimateSpeed||1)}}if(e.thinInstances){const a=e.thinInstances;if(n.thinInstanceEnablePicking=!!a.enablePicking,a.matrixData?(n.thinInstanceSetBuffer("matrix",new Float32Array(a.matrixData),16,!1),n._thinInstanceDataStorage.matrixBufferSize=a.matrixBufferSize,n._thinInstanceDataStorage.instancesCount=a.instancesCount):n._thinInstanceDataStorage.matrixBufferSize=a.matrixBufferSize,e.thinInstances.userThinInstance){const p=e.thinInstances.userThinInstance;for(const _ in p.data)n.thinInstanceSetBuffer(_,new Float32Array(p.data[_]),p.strides[_],!1),n._userThinInstanceBuffersStorage.sizes[_]=p.sizes[_]}}return n}setPositionsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourcePositions){const i=this.getVerticesData(te.PositionKind);if(!i)return e._sourcePositions;e._sourcePositions=new Float32Array(i),this.isVertexBufferUpdatable(te.PositionKind)||this.setVerticesData(te.PositionKind,i,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourceNormals){const i=this.getVerticesData(te.NormalKind);if(!i)return e._sourceNormals;e._sourceNormals=new Float32Array(i),this.isVertexBufferUpdatable(te.NormalKind)||this.setVerticesData(te.NormalKind,i,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(te.PositionKind))return this;if(!this.isVerticesDataPresent(te.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(te.MatricesWeightsKind))return this;const i=this.isVerticesDataPresent(te.NormalKind),s=this._internalMeshDataInfo;if(!s._sourcePositions){const k=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=k}i&&!s._sourceNormals&&this.setNormalsForCPUSkinning();let n=this.getVerticesData(te.PositionKind);if(!n)return this;n instanceof Float32Array||(n=new Float32Array(n));let a=this.getVerticesData(te.NormalKind);if(i){if(!a)return this;a instanceof Float32Array||(a=new Float32Array(a))}const p=this.getVerticesData(te.MatricesIndicesKind),_=this.getVerticesData(te.MatricesWeightsKind);if(!_||!p)return this;const g=this.numBoneInfluencers>4,y=g?this.getVerticesData(te.MatricesIndicesExtraKind):null,b=g?this.getVerticesData(te.MatricesWeightsExtraKind):null,v=e.getTransformMatrices(this),S=j.Zero(),M=new fe,F=new fe;let L=0,N;for(let k=0;k<n.length;k+=3,L+=4){let G;for(N=0;N<4;N++)G=_[L+N],G>0&&(fe.FromFloat32ArrayToRefScaled(v,Math.floor(p[L+N]*16),G,F),M.addToSelf(F));if(g)for(N=0;N<4;N++)G=b[L+N],G>0&&(fe.FromFloat32ArrayToRefScaled(v,Math.floor(y[L+N]*16),G,F),M.addToSelf(F));j.TransformCoordinatesFromFloatsToRef(s._sourcePositions[k],s._sourcePositions[k+1],s._sourcePositions[k+2],M,S),S.toArray(n,k),i&&(j.TransformNormalFromFloatsToRef(s._sourceNormals[k],s._sourceNormals[k+1],s._sourceNormals[k+2],M,S),S.toArray(a,k)),M.reset()}return this.updateVerticesData(te.PositionKind,n),i&&this.updateVerticesData(te.NormalKind,a),this}static MinMax(e){let i=null,s=null;return e.forEach(function(n){const p=n.getBoundingInfo().boundingBox;!i||!s?(i=p.minimumWorld,s=p.maximumWorld):(i.minimizeInPlace(p.minimumWorld),s.maximizeInPlace(p.maximumWorld))}),!i||!s?{min:j.Zero(),max:j.Zero()}:{min:i,max:s}}static Center(e){const i=e instanceof Array?Qe.MinMax(e):e;return j.Center(i.min,i.max)}static MergeMeshes(e,i=!0,s,n,a,p){return f_(Qe._MergeMeshesCoroutine(e,i,s,n,a,p,!1))}static MergeMeshesAsync(e,i=!0,s,n,a,p){return JE(Qe._MergeMeshesCoroutine(e,i,s,n,a,p,!0),eW())}static*_MergeMeshesCoroutine(e,i=!0,s,n,a,p,_){if(e=e.filter(Boolean),e.length===0)return null;let g;if(!s){let Z=0;for(g=0;g<e.length;g++)if(Z+=e[g].getTotalVertices(),Z>=65536)return Ie.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}p&&(a=!1);const y=new Array,b=new Array,v=new Array,S=e[0].overrideMaterialSideOrientation;for(g=0;g<e.length;g++){const Z=e[g];if(Z.isAnInstance)return Ie.Warn("Cannot merge instance meshes."),null;if(S!==Z.overrideMaterialSideOrientation)return Ie.Warn("Cannot merge meshes with different overrideMaterialSideOrientation values."),null;if(a&&v.push(Z.getTotalIndices()),p)if(Z.material){const Q=Z.material;if(Q instanceof yl){for(let se=0;se<Q.subMaterials.length;se++)y.indexOf(Q.subMaterials[se])<0&&y.push(Q.subMaterials[se]);for(let se=0;se<Z.subMeshes.length;se++)b.push(y.indexOf(Q.subMaterials[Z.subMeshes[se].materialIndex])),v.push(Z.subMeshes[se].indexCount)}else{y.indexOf(Q)<0&&y.push(Q);for(let se=0;se<Z.subMeshes.length;se++)b.push(y.indexOf(Q)),v.push(Z.subMeshes[se].indexCount)}}else for(let Q=0;Q<Z.subMeshes.length;Q++)b.push(0),v.push(Z.subMeshes[Q].indexCount)}const M=e[0],F=Z=>{const Q=Z.computeWorldMatrix(!0);return{vertexData:Mt.ExtractFromMesh(Z,!1,!1),transform:Q}},{vertexData:L,transform:N}=F(M);_&&(yield);const k=new Array(e.length-1);for(let Z=1;Z<e.length;Z++)k[Z-1]=F(e[Z]),_&&(yield);const G=L._mergeCoroutine(N,k,s,_,!i);let H=G.next();for(;!H.done;)_&&(yield),H=G.next();const z=H.value;n||(n=new Qe(M.name+"_merged",M.getScene()));const W=z._applyToCoroutine(n,void 0,_);let Y=W.next();for(;!Y.done;)_&&(yield),Y=W.next();if(n.checkCollisions=M.checkCollisions,n.overrideMaterialSideOrientation=M.overrideMaterialSideOrientation,i)for(g=0;g<e.length;g++)e[g].dispose();if(a||p){n.releaseSubMeshes(),g=0;let Z=0;for(;g<v.length;)Sn.CreateFromIndices(0,Z,v[g],n,void 0,!1),Z+=v[g],g++;for(const Q of n.subMeshes)Q.refreshBoundingInfo();n.computeWorldMatrix(!0)}if(p){const Z=new yl(M.name+"_merged",M.getScene());Z.subMaterials=y;for(let Q=0;Q<n.subMeshes.length;Q++)n.subMeshes[Q].materialIndex=b[Q];n.material=Z}else n.material=M.material;return n}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){const i=e._indexInSourceMeshInstanceArray;if(i!=-1){if(i!==this.instances.length-1){const s=this.instances[this.instances.length-1];this.instances[i]=s,s._indexInSourceMeshInstanceArray=i}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this.overrideMaterialSideOrientation===Be.CounterClockWiseSideOrientation}_getRenderingFillMode(e){var i;const s=this.getScene();return s.forcePointsCloud?Be.PointFillMode:s.forceWireframe?Be.WireFrameFillMode:(i=this.overrideRenderingFillMode)!==null&&i!==void 0?i:e}}Qe.FRONTSIDE=Mt.FRONTSIDE,Qe.BACKSIDE=Mt.BACKSIDE,Qe.DOUBLESIDE=Mt.DOUBLESIDE,Qe.DEFAULTSIDE=Mt.DEFAULTSIDE,Qe.NO_CAP=0,Qe.CAP_START=1,Qe.CAP_END=2,Qe.CAP_ALL=3,Qe.NO_FLIP=0,Qe.FLIP_TILE=1,Qe.ROTATE_TILE=2,Qe.FLIP_ROW=3,Qe.ROTATE_ROW=4,Qe.FLIP_N_ROTATE_TILE=5,Qe.FLIP_N_ROTATE_ROW=6,Qe.CENTER=0,Qe.LEFT=1,Qe.RIGHT=2,Qe.TOP=3,Qe.BOTTOM=4,Qe.INSTANCEDMESH_SORT_TRANSPARENT=!1,Qe._GroundMeshParser=(l,e)=>{throw xi("GroundMesh")},Qe._GoldbergMeshParser=(l,e)=>{throw xi("GoldbergMesh")},Qe._LinesMeshParser=(l,e)=>{throw xi("LinesMesh")},ur("BABYLON.Mesh",Qe),Qe.prototype.setMaterialByID=function(l){return this.setMaterialById(l)},Qe.CreateDisc=Qe.CreateDisc||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Qe.CreateBox=Qe.CreateBox||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Qe.CreateSphere=Qe.CreateSphere||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Qe.CreateCylinder=Qe.CreateCylinder||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Qe.CreateTorusKnot=Qe.CreateTorusKnot||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Qe.CreateTorus=Qe.CreateTorus||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Qe.CreatePlane=Qe.CreatePlane||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Qe.CreateGround=Qe.CreateGround||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Qe.CreateTiledGround=Qe.CreateTiledGround||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Qe.CreateGroundFromHeightMap=Qe.CreateGroundFromHeightMap||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Qe.CreateTube=Qe.CreateTube||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Qe.CreatePolyhedron=Qe.CreatePolyhedron||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Qe.CreateIcoSphere=Qe.CreateIcoSphere||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Qe.CreateDecal=Qe.CreateDecal||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Qe.CreateCapsule=Qe.CreateCapsule||(()=>{throw new Error("Import MeshBuilder to populate this function")}),Qe.ExtendToGoldberg=Qe.ExtendToGoldberg||(()=>{throw new Error("Import MeshBuilder to populate this function")});class ez{constructor(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}get name(){return"AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;const i=this._attachedCamera.getScene();this._onPrePointerObservableObserver=i.onPrePointerObservable.add(s=>{if(s.type===Lt.POINTERDOWN){this._isPointerDown=!0;return}s.type===Lt.POINTERUP&&(this._isPointerDown=!1)}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{if(this._reachTargetAlpha())return;const s=na.Now;let n=0;this._lastFrameTime!=null&&(n=s-this._lastFrameTime),this._lastFrameTime=s,this._applyUserInteraction();const a=s-this._lastInteractionTime-this._idleRotationWaitTime,p=Math.max(Math.min(a/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*p,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(n/1e3))})}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null}resetLastInteractionTime(e){this._lastInteractionTime=e??na.Now}_reachTargetAlpha(){return this._attachedCamera&&this.targetAlpha?Math.abs(this._attachedCamera.alpha-this.targetAlpha)<rr:!1}_userIsZooming(){return this._attachedCamera?this._attachedCamera.inertialRadiusOffset!==0:!1}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return!1;let e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&this._attachedCamera.inertialRadiusOffset!==0&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=na.Now)}_userIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}}class sn{constructor(){this._easingMode=sn.EASINGMODE_EASEIN}setEasingMode(e){const i=Math.min(Math.max(e,0),2);this._easingMode=i}getEasingMode(){return this._easingMode}easeInCore(e){throw new Error("You must implement this method")}ease(e){switch(this._easingMode){case sn.EASINGMODE_EASEIN:return this.easeInCore(e);case sn.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-e)}return e>=.5?(1-this.easeInCore((1-e)*2))*.5+.5:this.easeInCore(e*2)*.5}}sn.EASINGMODE_EASEIN=0,sn.EASINGMODE_EASEOUT=1,sn.EASINGMODE_EASEINOUT=2;class tz extends sn{easeInCore(e){return e=Math.max(0,Math.min(1,e)),1-Math.sqrt(1-e*e)}}class iz extends sn{constructor(e=1){super(),this.amplitude=e}easeInCore(e){const i=Math.max(0,this.amplitude);return Math.pow(e,3)-e*i*Math.sin(3.141592653589793*e)}}class gq extends null{constructor(e=3,i=2){super(),this.bounces=e,this.bounciness=i}easeInCore(e){const i=Math.max(0,this.bounces);let s=this.bounciness;s<=1&&(s=1.001);const n=Math.pow(s,i),a=1-s,p=(1-n)/a+n*.5,_=e*p,g=Math.log(-_*(1-s)+1)/Math.log(s),y=Math.floor(g),b=y+1,v=(1-Math.pow(s,y))/(a*p),S=(1-Math.pow(s,b))/(a*p),M=(v+S)*.5,F=e-M,L=M-v;return-Math.pow(1/s,i-y)/(L*L)*(F-L)*(F+L)}}class yq extends null{easeInCore(e){return e*e*e}}class bq extends null{constructor(e=3,i=3){super(),this.oscillations=e,this.springiness=i}easeInCore(e){let i;const s=Math.max(0,this.oscillations),n=Math.max(0,this.springiness);return n==0?i=e:i=(Math.exp(n*e)-1)/(Math.exp(n)-1),i*Math.sin((6.283185307179586*s+1.5707963267948966)*e)}}class rz extends sn{constructor(e=2){super(),this.exponent=e}easeInCore(e){return this.exponent<=0?e:(Math.exp(this.exponent*e)-1)/(Math.exp(this.exponent)-1)}}class vq extends null{constructor(e=2){super(),this.power=e}easeInCore(e){const i=Math.max(0,this.power);return Math.pow(e,i)}}class sz extends sn{easeInCore(e){return e*e}}class Tq extends null{easeInCore(e){return e*e*e*e}}class Eq extends null{easeInCore(e){return e*e*e*e*e}}class hI extends sn{easeInCore(e){return 1-Math.sin(1.5707963267948966*(1-e))}}class Aq extends null{constructor(e=0,i=0,s=1,n=1){super(),this.x1=e,this.y1=i,this.x2=s,this.y2=n}easeInCore(e){return BezierCurve.Interpolate(e,this.x1,this.y1,this.x2,this.y2)}}var B2;(function(l){l[l.NONE=0]="NONE",l[l.STEP=1]="STEP"})(B2||(B2={}));class Lc{constructor(e,i,s){this.name=e,this.from=i,this.to=s}clone(){return new Lc(this.name,this.from,this.to)}}class Cq{}class Ce{static _PrepareAnimation(e,i,s,n,a,p,_,g){let y;if(!isNaN(parseFloat(a))&&isFinite(a)?y=Ce.ANIMATIONTYPE_FLOAT:a instanceof Ve?y=Ce.ANIMATIONTYPE_QUATERNION:a instanceof j?y=Ce.ANIMATIONTYPE_VECTOR3:a instanceof ii?y=Ce.ANIMATIONTYPE_VECTOR2:a instanceof qe?y=Ce.ANIMATIONTYPE_COLOR3:a instanceof pi?y=Ce.ANIMATIONTYPE_COLOR4:a instanceof Aa&&(y=Ce.ANIMATIONTYPE_SIZE),y==null)return null;const b=new Ce(e,i,s,y,_),v=[{frame:0,value:a},{frame:n,value:p}];return b.setKeys(v),g!==void 0&&b.setEasingFunction(g),b}static CreateAnimation(e,i,s,n){const a=new Ce(e+"Animation",e,s,i,Ce.ANIMATIONLOOPMODE_CONSTANT);return a.setEasingFunction(n),a}static CreateAndStartAnimation(e,i,s,n,a,p,_,g,y,b,v){const S=Ce._PrepareAnimation(e,s,n,a,p,_,g,y);return!S||(i.getScene&&(v=i.getScene()),!v)?null:v.beginDirectAnimation(i,[S],0,a,S.loopMode===1,1,b)}static CreateAndStartHierarchyAnimation(e,i,s,n,a,p,_,g,y,b,v){const S=Ce._PrepareAnimation(e,n,a,p,_,g,y,b);return S?i.getScene().beginDirectHierarchyAnimation(i,s,[S],0,p,S.loopMode===1,1,v):null}static CreateMergeAndStartAnimation(e,i,s,n,a,p,_,g,y,b){const v=Ce._PrepareAnimation(e,s,n,a,p,_,g,y);return v?(i.animations.push(v),i.getScene().beginAnimation(i,0,a,v.loopMode===1,1,b)):null}static MakeAnimationAdditive(e,i=0,s,n=!1,a){let p=e;if(n&&(p=e.clone(),p.name=a||p.name),!p._keys.length)return p;i=i>=0?i:0;let _=0;const g=p._keys[0];let y=p._keys.length-1;const b=p._keys[y],v={referenceValue:g.value,referencePosition:ge.Vector3[0],referenceQuaternion:ge.Quaternion[0],referenceScaling:ge.Vector3[1],keyPosition:ge.Vector3[2],keyQuaternion:ge.Quaternion[1],keyScaling:ge.Vector3[3]};let S=!1,M=g.frame,F=b.frame;if(s){const G=p.getRange(s);G&&(M=G.from,F=G.to)}let L=g.frame===M,N=b.frame===F;if(p._keys.length===1){const G=p._getKeyValue(p._keys[0]);v.referenceValue=G.clone?G.clone():G,S=!0}else if(i<=g.frame){const G=p._getKeyValue(g.value);v.referenceValue=G.clone?G.clone():G,S=!0}else if(i>=b.frame){const G=p._getKeyValue(b.value);v.referenceValue=G.clone?G.clone():G,S=!0}let k=0;for(;!S||!L||!N&&k<p._keys.length-1;){const G=p._keys[k],H=p._keys[k+1];if(!S&&i>=G.frame&&i<=H.frame){let z;if(i===G.frame)z=p._getKeyValue(G.value);else if(i===H.frame)z=p._getKeyValue(H.value);else{const W={key:k,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT};z=p._interpolate(i,W)}v.referenceValue=z.clone?z.clone():z,S=!0}if(!L&&M>=G.frame&&M<=H.frame){if(M===G.frame)_=k;else if(M===H.frame)_=k+1;else{const z={key:k,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT},W=p._interpolate(M,z),Y={frame:M,value:W.clone?W.clone():W};p._keys.splice(k+1,0,Y),_=k+1}L=!0}if(!N&&F>=G.frame&&F<=H.frame){if(F===G.frame)y=k;else if(F===H.frame)y=k+1;else{const z={key:k,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT},W=p._interpolate(F,z),Y={frame:F,value:W.clone?W.clone():W};p._keys.splice(k+1,0,Y),y=k+1}N=!0}k++}for(p.dataType===Ce.ANIMATIONTYPE_QUATERNION?v.referenceValue.normalize().conjugateInPlace():p.dataType===Ce.ANIMATIONTYPE_MATRIX&&(v.referenceValue.decompose(v.referenceScaling,v.referenceQuaternion,v.referencePosition),v.referenceQuaternion.normalize().conjugateInPlace()),k=_;k<=y;k++){const G=p._keys[k];if(!(k&&p.dataType!==Ce.ANIMATIONTYPE_FLOAT&&G.value===g.value))switch(p.dataType){case Ce.ANIMATIONTYPE_MATRIX:G.value.decompose(v.keyScaling,v.keyQuaternion,v.keyPosition),v.keyPosition.subtractInPlace(v.referencePosition),v.keyScaling.divideInPlace(v.referenceScaling),v.referenceQuaternion.multiplyToRef(v.keyQuaternion,v.keyQuaternion),fe.ComposeToRef(v.keyScaling,v.keyQuaternion,v.keyPosition,G.value);break;case Ce.ANIMATIONTYPE_QUATERNION:v.referenceValue.multiplyToRef(G.value,G.value);break;case Ce.ANIMATIONTYPE_VECTOR2:case Ce.ANIMATIONTYPE_VECTOR3:case Ce.ANIMATIONTYPE_COLOR3:case Ce.ANIMATIONTYPE_COLOR4:G.value.subtractToRef(v.referenceValue,G.value);break;case Ce.ANIMATIONTYPE_SIZE:G.value.width-=v.referenceValue.width,G.value.height-=v.referenceValue.height;break;default:G.value-=v.referenceValue}}return p}static TransitionTo(e,i,s,n,a,p,_,g=null){if(_<=0)return s[e]=i,g&&g(),null;const y=a*(_/1e3);p.setKeys([{frame:0,value:s[e].clone?s[e].clone():s[e]},{frame:y,value:i}]),s.animations||(s.animations=[]),s.animations.push(p);const b=n.beginAnimation(s,0,y,!1);return b.onAnimationEnd=g,b}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(const e of this._runtimeAnimations)if(!e.isStopped())return!0;return!1}constructor(e,i,s,n,a,p){this.name=e,this.targetProperty=i,this.framePerSecond=s,this.dataType=n,this.loopMode=a,this.enableBlending=p,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=i.split("."),this.dataType=n,this.loopMode=a===void 0?Ce.ANIMATIONLOOPMODE_CYCLE:a,this.uniqueId=Ce._UniqueIdGenerator++}toString(e){let i="Name: "+this.name+", property: "+this.targetProperty;if(i+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],i+=", nKeys: "+(this._keys?this._keys.length:"none"),i+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){i+=", Ranges: {";let s=!0;for(const n in this._ranges)s&&(i+=", ",s=!1),i+=n;i+="}"}return i}addEvent(e){this._events.push(e),this._events.sort((i,s)=>i.frame-s.frame)}removeEvents(e){for(let i=0;i<this._events.length;i++)this._events[i].frame===e&&(this._events.splice(i,1),i--)}getEvents(){return this._events}createRange(e,i,s){this._ranges[e]||(this._ranges[e]=new Lc(e,i,s))}deleteRange(e,i=!0){const s=this._ranges[e];if(!!s){if(i){const n=s.from,a=s.to;for(let p=this._keys.length-1;p>=0;p--)this._keys[p].frame>=n&&this._keys[p].frame<=a&&this._keys.splice(p,1)}this._ranges[e]=null}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let i=0,s=this._keys.length;i<s;i++)e<this._keys[i].frame&&(e=this._keys[i].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e}floatInterpolateFunction(e,i,s){return at.Lerp(e,i,s)}floatInterpolateFunctionWithTangents(e,i,s,n,a){return at.Hermite(e,i,s,n,a)}quaternionInterpolateFunction(e,i,s){return Ve.Slerp(e,i,s)}quaternionInterpolateFunctionWithTangents(e,i,s,n,a){return Ve.Hermite(e,i,s,n,a).normalize()}vector3InterpolateFunction(e,i,s){return j.Lerp(e,i,s)}vector3InterpolateFunctionWithTangents(e,i,s,n,a){return j.Hermite(e,i,s,n,a)}vector2InterpolateFunction(e,i,s){return ii.Lerp(e,i,s)}vector2InterpolateFunctionWithTangents(e,i,s,n,a){return ii.Hermite(e,i,s,n,a)}sizeInterpolateFunction(e,i,s){return Aa.Lerp(e,i,s)}color3InterpolateFunction(e,i,s){return qe.Lerp(e,i,s)}color3InterpolateFunctionWithTangents(e,i,s,n,a){return qe.Hermite(e,i,s,n,a)}color4InterpolateFunction(e,i,s){return pi.Lerp(e,i,s)}color4InterpolateFunctionWithTangents(e,i,s,n,a){return pi.Hermite(e,i,s,n,a)}_getKeyValue(e){return typeof e=="function"?e():e}evaluate(e){return this._interpolate(e,{key:0,repeatCount:0,loopMode:Ce.ANIMATIONLOOPMODE_CONSTANT})}_interpolate(e,i){if(i.loopMode===Ce.ANIMATIONLOOPMODE_CONSTANT&&i.repeatCount>0)return i.highLimitValue.clone?i.highLimitValue.clone():i.highLimitValue;const s=this._keys,n=s.length;let a=i.key;for(;a>=0&&e<s[a].frame;)--a;for(;a+1<=n-1&&e>=s[a+1].frame;)++a;if(i.key=a,a<0)return this._getKeyValue(s[0].value);if(a+1>n-1)return this._getKeyValue(s[n-1].value);const p=s[a],_=s[a+1],g=this._getKeyValue(p.value),y=this._getKeyValue(_.value);if(p.interpolation===B2.STEP)return _.frame>e?g:y;const b=p.outTangent!==void 0&&_.inTangent!==void 0,v=_.frame-p.frame;let S=(e-p.frame)/v;const M=this.getEasingFunction();switch(M!==null&&(S=M.ease(S)),this.dataType){case Ce.ANIMATIONTYPE_FLOAT:{const F=b?this.floatInterpolateFunctionWithTangents(g,p.outTangent*v,y,_.inTangent*v,S):this.floatInterpolateFunction(g,y,S);switch(i.loopMode){case Ce.ANIMATIONLOOPMODE_CYCLE:case Ce.ANIMATIONLOOPMODE_CONSTANT:return F;case Ce.ANIMATIONLOOPMODE_RELATIVE:return i.offsetValue*i.repeatCount+F}break}case Ce.ANIMATIONTYPE_QUATERNION:{const F=b?this.quaternionInterpolateFunctionWithTangents(g,p.outTangent.scale(v),y,_.inTangent.scale(v),S):this.quaternionInterpolateFunction(g,y,S);switch(i.loopMode){case Ce.ANIMATIONLOOPMODE_CYCLE:case Ce.ANIMATIONLOOPMODE_CONSTANT:return F;case Ce.ANIMATIONLOOPMODE_RELATIVE:return F.addInPlace(i.offsetValue.scale(i.repeatCount))}return F}case Ce.ANIMATIONTYPE_VECTOR3:{const F=b?this.vector3InterpolateFunctionWithTangents(g,p.outTangent.scale(v),y,_.inTangent.scale(v),S):this.vector3InterpolateFunction(g,y,S);switch(i.loopMode){case Ce.ANIMATIONLOOPMODE_CYCLE:case Ce.ANIMATIONLOOPMODE_CONSTANT:return F;case Ce.ANIMATIONLOOPMODE_RELATIVE:return F.add(i.offsetValue.scale(i.repeatCount))}break}case Ce.ANIMATIONTYPE_VECTOR2:{const F=b?this.vector2InterpolateFunctionWithTangents(g,p.outTangent.scale(v),y,_.inTangent.scale(v),S):this.vector2InterpolateFunction(g,y,S);switch(i.loopMode){case Ce.ANIMATIONLOOPMODE_CYCLE:case Ce.ANIMATIONLOOPMODE_CONSTANT:return F;case Ce.ANIMATIONLOOPMODE_RELATIVE:return F.add(i.offsetValue.scale(i.repeatCount))}break}case Ce.ANIMATIONTYPE_SIZE:{switch(i.loopMode){case Ce.ANIMATIONLOOPMODE_CYCLE:case Ce.ANIMATIONLOOPMODE_CONSTANT:return this.sizeInterpolateFunction(g,y,S);case Ce.ANIMATIONLOOPMODE_RELATIVE:return this.sizeInterpolateFunction(g,y,S).add(i.offsetValue.scale(i.repeatCount))}break}case Ce.ANIMATIONTYPE_COLOR3:{const F=b?this.color3InterpolateFunctionWithTangents(g,p.outTangent.scale(v),y,_.inTangent.scale(v),S):this.color3InterpolateFunction(g,y,S);switch(i.loopMode){case Ce.ANIMATIONLOOPMODE_CYCLE:case Ce.ANIMATIONLOOPMODE_CONSTANT:return F;case Ce.ANIMATIONLOOPMODE_RELATIVE:return F.add(i.offsetValue.scale(i.repeatCount))}break}case Ce.ANIMATIONTYPE_COLOR4:{const F=b?this.color4InterpolateFunctionWithTangents(g,p.outTangent.scale(v),y,_.inTangent.scale(v),S):this.color4InterpolateFunction(g,y,S);switch(i.loopMode){case Ce.ANIMATIONLOOPMODE_CYCLE:case Ce.ANIMATIONLOOPMODE_CONSTANT:return F;case Ce.ANIMATIONLOOPMODE_RELATIVE:return F.add(i.offsetValue.scale(i.repeatCount))}break}case Ce.ANIMATIONTYPE_MATRIX:{switch(i.loopMode){case Ce.ANIMATIONLOOPMODE_CYCLE:case Ce.ANIMATIONLOOPMODE_CONSTANT:return Ce.AllowMatricesInterpolation?this.matrixInterpolateFunction(g,y,S,i.workValue):g;case Ce.ANIMATIONLOOPMODE_RELATIVE:return g}break}}return 0}matrixInterpolateFunction(e,i,s,n){return Ce.AllowMatrixDecomposeForInterpolation?n?(fe.DecomposeLerpToRef(e,i,s,n),n):fe.DecomposeLerp(e,i,s):n?(fe.LerpToRef(e,i,s,n),n):fe.Lerp(e,i,s)}clone(){const e=new Ce(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(const i in this._ranges){const s=this._ranges[i];!s||(e._ranges[i]=s.clone())}}return e}setKeys(e){this._keys=e.slice(0)}serialize(){const e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;const i=this.dataType;e.keys=[];const s=this.getKeys();for(let n=0;n<s.length;n++){const a=s[n],p={};switch(p.frame=a.frame,i){case Ce.ANIMATIONTYPE_FLOAT:p.values=[a.value],a.inTangent!==void 0&&p.values.push(a.inTangent),a.outTangent!==void 0&&(a.inTangent===void 0&&p.values.push(void 0),p.values.push(a.outTangent)),a.interpolation!==void 0&&(a.inTangent===void 0&&p.values.push(void 0),a.outTangent===void 0&&p.values.push(void 0),p.values.push(a.interpolation));break;case Ce.ANIMATIONTYPE_QUATERNION:case Ce.ANIMATIONTYPE_MATRIX:case Ce.ANIMATIONTYPE_VECTOR3:case Ce.ANIMATIONTYPE_COLOR3:case Ce.ANIMATIONTYPE_COLOR4:p.values=a.value.asArray(),a.inTangent!=null&&p.values.push(a.inTangent.asArray()),a.outTangent!=null&&(a.inTangent===void 0&&p.values.push(void 0),p.values.push(a.outTangent.asArray())),a.interpolation!==void 0&&(a.inTangent===void 0&&p.values.push(void 0),a.outTangent===void 0&&p.values.push(void 0),p.values.push(a.interpolation));break}e.keys.push(p)}e.ranges=[];for(const n in this._ranges){const a=this._ranges[n];if(!a)continue;const p={};p.name=n,p.from=a.from,p.to=a.to,e.ranges.push(p)}return e}static _UniversalLerp(e,i,s){const n=e.constructor;return n.Lerp?n.Lerp(e,i,s):n.Slerp?n.Slerp(e,i,s):e.toFixed?e*(1-s)+s*i:i}static Parse(e){const i=new Ce(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),s=e.dataType,n=[];let a,p;for(e.enableBlending&&(i.enableBlending=e.enableBlending),e.blendingSpeed&&(i.blendingSpeed=e.blendingSpeed),p=0;p<e.keys.length;p++){const _=e.keys[p];let g,y,b;switch(s){case Ce.ANIMATIONTYPE_FLOAT:a=_.values[0],_.values.length>=2&&(g=_.values[1]),_.values.length>=3&&(y=_.values[2]),_.values.length>=4&&(b=_.values[3]);break;case Ce.ANIMATIONTYPE_QUATERNION:if(a=Ve.FromArray(_.values),_.values.length>=8){const S=Ve.FromArray(_.values.slice(4,8));S.equals(Ve.Zero())||(g=S)}if(_.values.length>=12){const S=Ve.FromArray(_.values.slice(8,12));S.equals(Ve.Zero())||(y=S)}_.values.length>=13&&(b=_.values[12]);break;case Ce.ANIMATIONTYPE_MATRIX:a=fe.FromArray(_.values),_.values.length>=17&&(b=_.values[16]);break;case Ce.ANIMATIONTYPE_COLOR3:a=qe.FromArray(_.values),_.values[3]&&(g=qe.FromArray(_.values[3])),_.values[4]&&(y=qe.FromArray(_.values[4])),_.values[5]&&(b=_.values[5]);break;case Ce.ANIMATIONTYPE_COLOR4:a=pi.FromArray(_.values),_.values[4]&&(g=pi.FromArray(_.values[4])),_.values[5]&&(y=pi.FromArray(_.values[5])),_.values[6]&&(b=pi.FromArray(_.values[6]));break;case Ce.ANIMATIONTYPE_VECTOR3:default:a=j.FromArray(_.values),_.values[3]&&(g=j.FromArray(_.values[3])),_.values[4]&&(y=j.FromArray(_.values[4])),_.values[5]&&(b=_.values[5]);break}const v={};v.frame=_.frame,v.value=a,g!=null&&(v.inTangent=g),y!=null&&(v.outTangent=y),b!=null&&(v.interpolation=b),n.push(v)}if(i.setKeys(n),e.ranges)for(p=0;p<e.ranges.length;p++)a=e.ranges[p],i.createRange(a.name,a.from,a.to);return i}static AppendSerializedAnimations(e,i){Kt.AppendSerializedAnimations(e,i)}static ParseFromFileAsync(e,i){return new Promise((s,n)=>{const a=new en;a.addEventListener("readystatechange",()=>{if(a.readyState==4)if(a.status==200){let p=JSON.parse(a.responseText);if(p.animations&&(p=p.animations),p.length){const _=new Array;for(const g of p)_.push(this.Parse(g));s(_)}else{const _=this.Parse(p);e&&(_.name=e),s(_)}}else n("Unable to load the animation")}),a.open("GET",i),a.send()})}static ParseFromSnippetAsync(e){return new Promise((i,s)=>{const n=new en;n.addEventListener("readystatechange",()=>{if(n.readyState==4)if(n.status==200){const a=JSON.parse(JSON.parse(n.responseText).jsonPayload);if(a.animations){const p=JSON.parse(a.animations),_=new Array;for(const g of p.animations){const y=this.Parse(g);y.snippetId=e,_.push(y)}i(_)}else{const p=JSON.parse(a.animation),_=this.Parse(p);_.snippetId=e,i(_)}}else s("Unable to load the snippet "+e)}),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()})}}Ce._UniqueIdGenerator=0,Ce.AllowMatricesInterpolation=!1,Ce.AllowMatrixDecomposeForInterpolation=!0,Ce.SnippetUrl="https://snippet.babylonjs.com",Ce.ANIMATIONTYPE_FLOAT=0,Ce.ANIMATIONTYPE_VECTOR3=1,Ce.ANIMATIONTYPE_QUATERNION=2,Ce.ANIMATIONTYPE_MATRIX=3,Ce.ANIMATIONTYPE_COLOR3=4,Ce.ANIMATIONTYPE_COLOR4=7,Ce.ANIMATIONTYPE_VECTOR2=5,Ce.ANIMATIONTYPE_SIZE=6,Ce.ANIMATIONLOOPMODE_RELATIVE=0,Ce.ANIMATIONLOOPMODE_CYCLE=1,Ce.ANIMATIONLOOPMODE_CONSTANT=2,Ce.CreateFromSnippetAsync=Ce.ParseFromSnippetAsync,ur("BABYLON.Animation",Ce),vr._AnimationRangeFactory=(l,e,i)=>new Lc(l,e,i);class bl{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=new Array}get name(){return"Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;const i=this._attachedCamera;!i||(e?this._onMeshTargetChangedObserver=i.onMeshTargetChangedObservable.add(s=>{if(!s)return;s.computeWorldMatrix(!0);const n=s.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=n*.05,this.upperRadiusTransitionRange=n*.05}):this._onMeshTargetChangedObserver&&i.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{!this._attachedCamera||(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange))})}detach(){!this._attachedCamera||(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)}_isRadiusAtLimit(e){return this._attachedCamera?this._attachedCamera.radius===e&&!this._radiusIsAnimating:!1}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(bl.EasingFunction.setEasingMode(bl.EasingMode),this._radiusBounceTransition=Ce.CreateAnimation("radius",Ce.ANIMATIONTYPE_FLOAT,60,bl.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;const i=Ce.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,()=>this._clearAnimationLocks());i&&this._animatables.push(i)}_clearAnimationLocks(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()}}bl.EasingFunction=new iz(.3),bl.EasingMode=sn.EASINGMODE_EASEOUT;class Xn{constructor(){this.onTargetFramingAnimationEndObservable=new Re,this._mode=Xn.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=!1}get name(){return"Framing"}set mode(e){this._mode=e}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;const i=this._attachedCamera.getScene();Xn.EasingFunction.setEasingMode(Xn.EasingMode),this._onPrePointerObservableObserver=i.onPrePointerObservable.add(s=>{if(s.type===Lt.POINTERDOWN){this._isPointerDown=!0;return}s.type===Lt.POINTERUP&&(this._isPointerDown=!1)}),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add(s=>{s&&this.zoomOnMesh(s,void 0,()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()})}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._applyUserInteraction(),this._maintainCameraAboveGround()})}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}zoomOnMesh(e,i=!1,s=null){e.computeWorldMatrix(!0);const n=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(n.minimumWorld,n.maximumWorld,i,s)}zoomOnMeshHierarchy(e,i=!1,s=null){e.computeWorldMatrix(!0);const n=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(n.min,n.max,i,s)}zoomOnMeshesHierarchy(e,i=!1,s=null){const n=new j(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new j(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let p=0;p<e.length;p++){const _=e[p].getHierarchyBoundingVectors(!0);j.CheckExtends(_.min,n,a),j.CheckExtends(_.max,n,a)}this.zoomOnBoundingInfo(n,a,i,s)}zoomOnBoundingInfo(e,i,s=!1,n=null){let a;if(!this._attachedCamera)return;const p=e.y,_=i.y,g=p+(_-p)*this._positionScale,y=i.subtract(e).scale(.5);if(s)a=new j(0,g,0);else{const S=e.add(y);a=new j(S.x,g,S.z)}this._vectorTransition||(this._vectorTransition=Ce.CreateAnimation("target",Ce.ANIMATIONTYPE_VECTOR3,60,Xn.EasingFunction)),this._betaIsAnimating=!0;let b=Ce.TransitionTo("target",a,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);b&&this._animatables.push(b);let v=0;if(this._mode===Xn.FitFrustumSidesMode){const S=this._calculateLowerRadiusFromModelBoundingSphere(e,i);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=y.length()+this._attachedCamera.minZ),v=S}else this._mode===Xn.IgnoreBoundsSizeMode&&(v=this._calculateLowerRadiusFromModelBoundingSphere(e,i),this.autoCorrectCameraLimitsAndSensibility&&this._attachedCamera.lowerRadiusLimit===null&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){const S=i.subtract(e).length();this._attachedCamera.panningSensibility=5e3/S,this._attachedCamera.wheelPrecision=100/v}this._radiusTransition||(this._radiusTransition=Ce.CreateAnimation("radius",Ce.ANIMATIONTYPE_FLOAT,60,Xn.EasingFunction)),b=Ce.TransitionTo("radius",v,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,()=>{this.stopAllAnimations(),n&&n(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState()}),b&&this._animatables.push(b)}_calculateLowerRadiusFromModelBoundingSphere(e,i){const n=i.subtract(e).length(),a=this._getFrustumSlope(),_=n*.5*this._radiusScale,g=_*Math.sqrt(1+1/(a.x*a.x)),y=_*Math.sqrt(1+1/(a.y*a.y));let b=Math.max(g,y);const v=this._attachedCamera;return v?(v.lowerRadiusLimit&&this._mode===Xn.IgnoreBoundsSizeMode&&(b=b<v.lowerRadiusLimit?v.lowerRadiusLimit:b),v.upperRadiusLimit&&(b=b>v.upperRadiusLimit?v.upperRadiusLimit:b),b):0}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;const e=na.Now-this._lastInteractionTime,i=Math.PI*.5-this._defaultElevation,s=Math.PI*.5;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>s&&e>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=Ce.CreateAnimation("beta",Ce.ANIMATIONTYPE_FLOAT,60,Xn.EasingFunction));const n=Ce.TransitionTo("beta",i,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,()=>{this._clearAnimationLocks(),this.stopAllAnimations()});n&&this._animatables.push(n)}}_getFrustumSlope(){const e=this._attachedCamera;if(!e)return ii.Zero();const s=e.getScene().getEngine().getAspectRatio(e),n=Math.tan(e.fov/2),a=n*s;return new ii(a,n)}_clearAnimationLocks(){this._betaIsAnimating=!1}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=na.Now,this.stopAllAnimations(),this._clearAnimationLocks())}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()}get isUserIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}}Xn.EasingFunction=new rz,Xn.EasingMode=sn.EASINGMODE_EASEINOUT,Xn.IgnoreBoundsSizeMode=0,Xn.FitFrustumSidesMode=1,vr.AddNodeConstructor("ArcRotateCamera",(l,e)=>()=>new Tr(l,0,0,1,j.Zero(),e));class Tr extends rs{get target(){return this._target}set target(e){this.setTarget(e)}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e)}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e)}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new fe,this._upToYMatrix=new fe,this._upVector=j.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp()}get upVector(){return this._upVector}setMatUp(){fe.RotationAlignToRef(j.UpReadOnly,this._upVector,this._yToUpMatrix),fe.RotationAlignToRef(this._upVector,j.UpReadOnly,this._upToYMatrix)}get angularSensibilityX(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){const i=this.inputs.attached.pointers;i&&(i.angularSensibilityX=e)}get angularSensibilityY(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){const i=this.inputs.attached.pointers;i&&(i.angularSensibilityY=e)}get pinchPrecision(){const e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){const i=this.inputs.attached.pointers;i&&(i.pinchPrecision=e)}get pinchDeltaPercentage(){const e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){const i=this.inputs.attached.pointers;i&&(i.pinchDeltaPercentage=e)}get useNaturalPinchZoom(){const e=this.inputs.attached.pointers;return e?e.useNaturalPinchZoom:!1}set useNaturalPinchZoom(e){const i=this.inputs.attached.pointers;i&&(i.useNaturalPinchZoom=e)}get panningSensibility(){const e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){const i=this.inputs.attached.pointers;i&&(i.panningSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const i=this.inputs.attached.keyboard;i&&(i.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const i=this.inputs.attached.keyboard;i&&(i.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const i=this.inputs.attached.keyboard;i&&(i.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const i=this.inputs.attached.keyboard;i&&(i.keysRight=e)}get wheelPrecision(){const e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){const i=this.inputs.attached.mousewheel;i&&(i.wheelPrecision=e)}get zoomToMouseLocation(){const e=this.inputs.attached.mousewheel;return e?e.zoomToMouseLocation:!1}set zoomToMouseLocation(e){const i=this.inputs.attached.mousewheel;i&&(i.zoomToMouseLocation=e)}get wheelDeltaPercentage(){const e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){const i=this.inputs.attached.mousewheel;i&&(i.wheelDeltaPercentage=e)}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return this._bouncingBehavior!=null}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new bl,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return this._framingBehavior!=null}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new Xn,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return this._autoRotationBehavior!=null}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new ez,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))}constructor(e,i,s,n,a,p,_=!0){super(e,j.Zero(),p,_),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=j.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=ii.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this._viewMatrix=new fe,this.panningAxis=new j(1,1,0),this._transformedDirection=new j,this.mapPanning=!1,this.onMeshTargetChangedObservable=new Re,this.checkCollisions=!1,this.collisionRadius=new j(.5,.5,.5),this._previousPosition=j.Zero(),this._collisionVelocity=j.Zero(),this._newPosition=j.Zero(),this._computationVector=j.Zero(),this._onCollisionPositionChange=(g,y,b=null)=>{b?(this.setPosition(y),this.onCollide&&this.onCollide(b)):this._previousPosition.copyFrom(this._position);const v=Math.cos(this.alpha),S=Math.sin(this.alpha),M=Math.cos(this.beta);let F=Math.sin(this.beta);F===0&&(F=1e-4);const L=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*v*F,this.radius*M,this.radius*S*F),L.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let N=this.upVector;this.allowUpsideDown&&this.beta<0&&(N=N.clone(),N=N.negate()),this._computeViewMatrix(this._position,L,N),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=!1},this._target=j.Zero(),a&&this.setTarget(a),this.alpha=i,this.beta=s,this.radius=n,this.getViewMatrix(),this.inputs=new GE(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_initCache(){super._initCache(),this._cache._target=new j(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=ii.Zero()}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){const i=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?i.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(i)}const e=this._getLockedTargetPosition();return e||this._target}storeState(){return this._storedAlpha=this.alpha,this._storedBeta=this.beta,this._storedRadius=this.radius,this._storedTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0):!1}_isSynchronizedViewMatrix(){return super._isSynchronizedViewMatrix()?this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset):!1}attachControl(e,i,s=!0,n=2){const a=arguments;i=Le.BackCompatCameraNoPreventDefault(a),this._useCtrlForPanning=s,this._panningMouseButton=n,typeof a[0]=="boolean"&&(a.length>1&&(this._useCtrlForPanning=a[1]),a.length>2&&(this._panningMouseButton=a[2])),this.inputs.attachElement(i),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){if(!this._collisionTriggered){if(this.inputs.checkInputs(),this.inertialAlphaOffset!==0||this.inertialBetaOffset!==0||this.inertialRadiusOffset!==0){const e=this.invertRotation?-1:1;let i=this.inertialAlphaOffset;this.beta<=0&&(i*=-1),this.getScene().useRightHandedSystem&&(i*=-1),this.parent&&this.parent._getWorldMatrixDeterminant()<0&&(i*=-1),this.alpha+=i*e,this.beta+=this.inertialBetaOffset*e,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<rr&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<rr&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<this.speed*rr&&(this.inertialRadiusOffset=0)}if(this.inertialPanningX!==0||this.inertialPanningY!==0){const e=new j(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);this._viewMatrix.invertToRef(this._cameraTransformMatrix),e.multiplyInPlace(this.panningAxis),j.TransformNormalToRef(e,this._cameraTransformMatrix,this._transformedDirection),(this.mapPanning||!this.panningAxis.y)&&(this._transformedDirection.y=0),this._targetHost||(this.panningDistanceLimit?(this._transformedDirection.addInPlace(this._target),j.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection)):this._target.addInPlace(this._transformedDirection)),this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<this.speed*rr&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<this.speed*rr&&(this.inertialPanningY=0)}this._checkLimits(),super._checkInputs()}}_checkLimits(){this.lowerBetaLimit===null||this.lowerBetaLimit===void 0?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),this.upperBetaLimit===null||this.upperBetaLimit===void 0?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerAlphaLimit!==null&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit!==null&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0)}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&j.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),this.radius===0&&(this.radius=1e-4);const e=this.alpha;this._computationVector.x===0&&this._computationVector.z===0?this.alpha=Math.PI/2:this.alpha=Math.acos(this._computationVector.x/Math.sqrt(Math.pow(this._computationVector.x,2)+Math.pow(this._computationVector.z,2))),this._computationVector.z<0&&(this.alpha=2*Math.PI-this.alpha);const i=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=i*2*Math.PI,this.beta=Math.acos(this._computationVector.y/this.radius),this._checkLimits()}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius())}setTarget(e,i=!1,s=!1,n=!1){var a;if(n=(a=this.overrideCloneAlphaBetaRadius)!==null&&a!==void 0?a:n,e.getBoundingInfo)i?this._targetBoundingCenter=e.getBoundingInfo().boundingBox.centerWorld.clone():this._targetBoundingCenter=null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{const p=e,_=this._getTargetPosition();if(_&&!s&&_.equals(p))return;this._targetHost=null,this._target=p,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}n||this.rebuildAnglesAndRadius()}_getViewMatrix(){const e=Math.cos(this.alpha),i=Math.sin(this.alpha),s=Math.cos(this.beta);let n=Math.sin(this.beta);n===0&&(n=1e-4),this.radius===0&&(this.radius=1e-4);const a=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*n,this.radius*s,this.radius*i*n),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&j.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),a.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){const p=this.getScene().collisionCoordinator;this._collider||(this._collider=p.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,p.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);let p=this.upVector;this.allowUpsideDown&&n<0&&(p=p.negate()),this._computeViewMatrix(this._position,a,p),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget=a,this._viewMatrix}zoomOn(e,i=!1){e=e||this.getScene().meshes;const s=Qe.MinMax(e),n=j.Distance(s.min,s.max);this.radius=n*this.zoomOnFactor,this.focusOn({min:s.min,max:s.max,distance:n},i)}focusOn(e,i=!1){let s,n;if(e.min===void 0){const a=e||this.getScene().meshes;s=Qe.MinMax(a),n=j.Distance(s.min,s.max)}else{const a=e;s=a,n=a.distance}this._target=Qe.Center(s),i||(this.maxZ=n*2)}createRigCamera(e,i){let s=0;switch(this.cameraRigMode){case wt.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case wt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case wt.RIG_MODE_STEREOSCOPIC_OVERUNDER:case wt.RIG_MODE_STEREOSCOPIC_INTERLACED:case wt.RIG_MODE_VR:s=this._cameraRigParams.stereoHalfAngle*(i===0?1:-1);break;case wt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:s=this._cameraRigParams.stereoHalfAngle*(i===0?-1:1);break}const n=new Tr(e,this.alpha+s,this.beta,this.radius,this._target,this.getScene());return n._cameraRigParams={},n.isRigCamera=!0,n.rigParent=this,n.upVector=this.upVector,n.mode=this.mode,n.orthoLeft=this.orthoLeft,n.orthoRight=this.orthoRight,n.orthoBottom=this.orthoBottom,n.orthoTop=this.orthoTop,n}_updateRigCameras(){const e=this._rigCameras[0],i=this._rigCameras[1];switch(e.beta=i.beta=this.beta,this.cameraRigMode){case wt.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case wt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case wt.RIG_MODE_STEREOSCOPIC_OVERUNDER:case wt.RIG_MODE_STEREOSCOPIC_INTERLACED:case wt.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,i.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case wt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,i.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;break}super._updateRigCameras()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}}J([xe()],Tr.prototype,"alpha",void 0),J([xe()],Tr.prototype,"beta",void 0),J([xe()],Tr.prototype,"radius",void 0),J([xe()],Tr.prototype,"overrideCloneAlphaBetaRadius",void 0),J([Rn("target")],Tr.prototype,"_target",void 0),J([AE("targetHost")],Tr.prototype,"_targetHost",void 0),J([xe()],Tr.prototype,"inertialAlphaOffset",void 0),J([xe()],Tr.prototype,"inertialBetaOffset",void 0),J([xe()],Tr.prototype,"inertialRadiusOffset",void 0),J([xe()],Tr.prototype,"lowerAlphaLimit",void 0),J([xe()],Tr.prototype,"upperAlphaLimit",void 0),J([xe()],Tr.prototype,"lowerBetaLimit",void 0),J([xe()],Tr.prototype,"upperBetaLimit",void 0),J([xe()],Tr.prototype,"lowerRadiusLimit",void 0),J([xe()],Tr.prototype,"upperRadiusLimit",void 0),J([xe()],Tr.prototype,"inertialPanningX",void 0),J([xe()],Tr.prototype,"inertialPanningY",void 0),J([xe()],Tr.prototype,"pinchToPanMaxDistance",void 0),J([xe()],Tr.prototype,"panningDistanceLimit",void 0),J([Rn()],Tr.prototype,"panningOriginTarget",void 0),J([xe()],Tr.prototype,"panningInertia",void 0),J([xe()],Tr.prototype,"zoomToMouseLocation",null),J([xe()],Tr.prototype,"zoomOnFactor",void 0),J([i_()],Tr.prototype,"targetScreenOffset",void 0),J([xe()],Tr.prototype,"allowUpsideDown",void 0),J([xe()],Tr.prototype,"useInputToRestoreState",void 0);const uI="kernelBlurVaryingDeclaration",dI="varying vec2 sampleCoord{X};";Ye.IncludesShadersStore[uI]=dI;const Rq={name:uI,shader:dI},fI="packingFunctions",pI=`vec4 pack(float depth)
{
const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);
const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);
vec4 res=fract(depth*bit_shift);
res-=res.xxyz*bit_mask;
return res;
}
float unpack(vec4 color)
{
const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);
return dot(color,bit_shift);
}`;Ye.IncludesShadersStore[fI]=pI;const Iq={name:fI,shader:pI},mI="kernelBlurFragment",_I=`#ifdef DOF
factor=sampleCoC(sampleCoord{X}); 
computedWeight=KERNEL_WEIGHT{X}*factor;
sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;
#endif
`;Ye.IncludesShadersStore[mI]=_I;const Sq={name:mI,shader:_I},gI="kernelBlurFragment2",yI=`#ifdef DOF
factor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});
computedWeight=KERNEL_DEP_WEIGHT{X}*factor;
sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_DEP_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;
#endif
`;Ye.IncludesShadersStore[gI]=yI;const Mq={name:gI,shader:yI},bI="kernelBlurPixelShader",vI=`uniform sampler2D textureSampler;
uniform vec2 delta;
varying vec2 sampleCenter;
#ifdef DOF
uniform sampler2D circleOfConfusionSampler;
float sampleCoC(in vec2 offset) {
float coc=texture2D(circleOfConfusionSampler,offset).r;
return coc; 
}
#endif
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#ifdef PACKEDFLOAT
#include<packingFunctions>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
float computedWeight=0.0;
#ifdef PACKEDFLOAT
float blend=0.;
#else
vec4 blend=vec4(0.);
#endif
#ifdef DOF
float sumOfWeights=CENTER_WEIGHT; 
float factor=0.0;
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;
#else
blend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;
#endif
#endif
#include<kernelBlurFragment>[0..varyingCount]
#include<kernelBlurFragment2>[0..depCount]
#ifdef PACKEDFLOAT
gl_FragColor=pack(blend);
#else
gl_FragColor=blend;
#endif
#ifdef DOF
gl_FragColor/=sumOfWeights;
#endif
}`;Ye.ShadersStore[bI]=vI;const Pq={name:bI,shader:vI},TI="kernelBlurVertex",EI="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";Ye.IncludesShadersStore[TI]=EI;const Oq={name:TI,shader:EI},AI="kernelBlurVertexShader",CI=`attribute vec2 position;
uniform vec2 delta;
varying vec2 sampleCenter;
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
sampleCenter=(position*madd+madd);
#include<kernelBlurVertex>[0..varyingCount]
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;Ye.ShadersStore[AI]=CI;const wq={name:AI,shader:CI};class Ix extends lr{set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this._blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this._blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,i,s,n,a,p=Oe.BILINEAR_SAMPLINGMODE,_,g,y=0,b="",v=!1,S=5){super(e,"kernelBlur",["delta","direction"],["circleOfConfusionSampler"],n,a,p,_,g,null,y,"kernelBlur",{varyingCount:0,depCount:0},!0,S),this._blockCompilation=v,this._packedFloat=!1,this._staticDefines="",this._staticDefines=b,this.direction=i,this.onApplyObservable.add(M=>{this._outputTexture?M.setFloat2("delta",1/this._outputTexture.width*this.direction.x,1/this._outputTexture.height*this.direction.y):M.setFloat2("delta",1/this.width*this.direction.x,1/this.height*this.direction.y)}),this.kernel=s}updateEffect(e=null,i=null,s=null,n,a,p){this._updateParameters(a,p)}_updateParameters(e,i){const s=this._kernel,n=(s-1)/2;let a=[],p=[],_=0;for(let N=0;N<s;N++){const k=N/(s-1),G=this._gaussianWeight(k*2-1);a[N]=N-n,p[N]=G,_+=G}for(let N=0;N<p.length;N++)p[N]/=_;const g=[],y=[],b=[];for(let N=0;N<=n;N+=2){const k=Math.min(N+1,Math.floor(n));if(N===k)b.push({o:a[N],w:p[N]});else{const H=k===n,z=p[N]+p[k]*(H?.5:1),W=a[N]+1/(1+p[N]/p[k]);W===0?(b.push({o:a[N],w:p[N]}),b.push({o:a[N+1],w:p[N+1]})):(b.push({o:W,w:z}),b.push({o:-W,w:z}))}}for(let N=0;N<b.length;N++)y[N]=b[N].o,g[N]=b[N].w;a=y,p=g;const v=this.getEngine().getCaps().maxVaryingVectors,S=Math.max(v,0)-1;let M=Math.min(a.length,S),F="";F+=this._staticDefines,this._staticDefines.indexOf("DOF")!=-1&&(F+=`#define CENTER_WEIGHT ${this._glslFloat(p[M-1])}\r
`,M--);for(let N=0;N<M;N++)F+=`#define KERNEL_OFFSET${N} ${this._glslFloat(a[N])}\r
`,F+=`#define KERNEL_WEIGHT${N} ${this._glslFloat(p[N])}\r
`;let L=0;for(let N=S;N<a.length;N++)F+=`#define KERNEL_DEP_OFFSET${L} ${this._glslFloat(a[N])}\r
`,F+=`#define KERNEL_DEP_WEIGHT${L} ${this._glslFloat(p[N])}\r
`,L++;this.packedFloat&&(F+="#define PACKEDFLOAT 1"),this._blockCompilation=!1,super.updateEffect(F,null,null,{varyingCount:M,depCount:L},e,i)}_nearestBestKernel(e){const i=Math.round(e);for(const s of[i,i-1,i+1,i-2,i+2])if(s%2!==0&&Math.floor(s/2)%2===0&&s>0)return Math.max(s,3);return Math.max(i,3)}_gaussianWeight(e){const i=.3333333333333333,s=Math.sqrt(2*Math.PI)*i,n=-(e*e/(2*i*i));return 1/s*Math.exp(n)}_glslFloat(e,i=8){return e.toFixed(i).replace(/0+$/,"")}static _Parse(e,i,s,n){return Kt.Parse(()=>new Ix(e.name,e.direction,e.kernel,e.options,i,e.renderTargetSamplingMode,s.getEngine(),e.reusable,e.textureType,void 0,!1),e,s,n)}}J([xe("kernel")],Ix.prototype,"_kernel",void 0),J([xe("packedFloat")],Ix.prototype,"_packedFloat",void 0),J([i_()],Ix.prototype,"direction",void 0),ur("BABYLON.BlurPostProcess",Ix);class k2 extends zn{set blurRatio(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())}get blurRatio(){return this._blurRatio}set adaptiveBlurKernel(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()}set blurKernel(e){this.blurKernelX=e,this.blurKernelY=e}set blurKernelX(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())}get blurKernelX(){return this._blurKernelX}set blurKernelY(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())}get blurKernelY(){return this._blurKernelY}_autoComputeBlurKernel(){const e=this.getScene().getEngine(),i=this.getRenderWidth()/e.getRenderWidth(),s=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*i,this.blurKernelY=this._adaptiveBlurKernel*s}_onRatioRescale(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()}_updateGammaSpace(){const e=this.getScene();!e||(this.gammaSpace=!e.imageProcessingConfiguration.isEnabled||!e.imageProcessingConfiguration.applyByPostProcess)}constructor(e,i,s,n,a=0,p=Oe.BILINEAR_SAMPLINGMODE,_=!0){if(super(e,i,s,n,!0,a,!1,p,_),this.mirrorPlane=new aa(0,1,0,1),this._transformMatrix=fe.Zero(),this._mirrorMatrix=fe.Zero(),this._adaptiveBlurKernel=0,this._blurKernelX=0,this._blurKernelY=0,this._blurRatio=1,s=this.getScene(),!s)return this;this.ignoreCameraViewport=!0,this._updateGammaSpace(),this._imageProcessingConfigChangeObserver=s.imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateGammaSpace()});const g=s.getEngine();g.supportsUniformBuffers&&(this._sceneUBO=s.createSceneUniformBuffer(`Scene for Mirror Texture (name "${e}")`)),this.onBeforeBindObservable.add(()=>{var b;(b=g._debugPushGroup)===null||b===void 0||b.call(g,`mirror generation for ${e}`,1)}),this.onAfterUnbindObservable.add(()=>{var b;(b=g._debugPopGroup)===null||b===void 0||b.call(g,1)});let y;this.onBeforeRenderObservable.add(()=>{this._sceneUBO&&(this._currentSceneUBO=s.getSceneUniformBuffer(),s.setSceneUniformBuffer(this._sceneUBO),s.getSceneUniformBuffer().unbindEffect()),fe.ReflectionToRef(this.mirrorPlane,this._mirrorMatrix),this._mirrorMatrix.multiplyToRef(s.getViewMatrix(),this._transformMatrix),s.setTransformMatrix(this._transformMatrix,s.getProjectionMatrix()),y=s.clipPlane,s.clipPlane=this.mirrorPlane,s._mirroredCameraPosition=j.TransformCoordinates(s.activeCamera.globalPosition,this._mirrorMatrix)}),this.onAfterRenderObservable.add(()=>{this._sceneUBO&&s.setSceneUniformBuffer(this._currentSceneUBO),s.updateTransformMatrix(),s._mirroredCameraPosition=null,s.clipPlane=y})}_preparePostProcesses(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){const e=this.getScene().getEngine(),i=e.getCaps().textureFloatRender&&e.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new Ix("horizontal blur",new ii(1,0),this._blurKernelX,this._blurRatio,null,Oe.BILINEAR_SAMPLINGMODE,e,!1,i),this._blurX.autoClear=!1,this._blurRatio===1&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new Ix("vertical blur",new ii(0,1),this._blurKernelY,this._blurRatio,null,Oe.BILINEAR_SAMPLINGMODE,e,!1,i),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=this._blurRatio!==1,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)}clone(){const e=this.getScene();if(!e)return this;const i=this.getSize(),s=new k2(this.name,i.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return s.hasAlpha=this.hasAlpha,s.level=this.level,s.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(s.renderList=this.renderList.slice(0)),s}serialize(){if(!this.name)return null;const e=super.serialize();return e.mirrorPlane=this.mirrorPlane.asArray(),e}dispose(){var e;super.dispose();const i=this.getScene();i&&i.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),(e=this._sceneUBO)===null||e===void 0||e.dispose()}}Oe._CreateMirror=(l,e,i,s)=>new k2(l,e,i,s),Yt.prototype._createDepthStencilCubeTexture=function(l,e,i){const s=new Bs(this,or.DepthStencil);if(s.isCube=!0,this.webGLVersion===1)return Ie.Error("Depth cube texture is not supported by WebGL 1."),s;const n={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...e},a=this._gl;this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,s,!0),this._setupDepthStencilTexture(s,l,n.generateStencil,n.bilinearFiltering,n.comparisonFunction),i._depthStencilTexture=s,i._depthStencilTextureWithStencil=n.generateStencil;for(let p=0;p<6;p++)n.generateStencil?a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+p,0,a.DEPTH24_STENCIL8,l,l,0,a.DEPTH_STENCIL,a.UNSIGNED_INT_24_8,null):a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+p,0,a.DEPTH_COMPONENT24,l,l,0,a.DEPTH_COMPONENT,a.UNSIGNED_INT,null);return this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(s),s},Yt.prototype._partialLoadFile=function(l,e,i,s,n=null){const a=_=>{i[e]=_,i._internalCount++,i._internalCount===6&&s(i)},p=(_,g)=>{n&&_&&n(_.status+" "+_.statusText,g)};this._loadFile(l,a,void 0,void 0,!0,p)},Yt.prototype._cascadeLoadFiles=function(l,e,i,s=null){const n=[];n._internalCount=0;for(let a=0;a<6;a++)this._partialLoadFile(i[a],a,n,e,s)},Yt.prototype._cascadeLoadImgs=function(l,e,i,s,n=null,a){const p=[];p._internalCount=0;for(let _=0;_<6;_++)this._partialLoadImg(s[_],_,p,l,e,i,n,a)},Yt.prototype._partialLoadImg=function(l,e,i,s,n,a,p=null,_){const g=m2();f2(l,v=>{i[e]=v,i._internalCount++,s&&s.removePendingData(g),i._internalCount===6&&a&&a(n,i)},(v,S)=>{s&&s.removePendingData(g),p&&p(v,S)},s?s.offlineProvider:null,_),s&&s.addPendingData(g)},Yt.prototype._setCubeMapTextureParams=function(l,e,i){const s=this._gl;s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,e?s.LINEAR_MIPMAP_LINEAR:s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),l.samplingMode=e?3:2,e&&this.getCaps().textureMaxLevel&&i!==void 0&&i>0&&(s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAX_LEVEL,i),l._maxLodLevel=i),this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null)},Yt.prototype.createCubeTextureBase=function(l,e,i,s,n=null,a=null,p,_=null,g=!1,y=0,b=0,v=null,S=null,M=null,F=!1){const L=v||new Bs(this,or.Cube);L.isCube=!0,L.url=l,L.generateMipMaps=!s,L._lodGenerationScale=y,L._lodGenerationOffset=b,L._useSRGBBuffer=!!F&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||!!s),L!==v&&(L.label=l.substring(0,60)),this._doNotHandleContextLost||(L._extension=_,L._files=i);const N=l;this._transformTextureUrl&&!v&&(l=this._transformTextureUrl(l));const k=l.split("?")[0],G=k.lastIndexOf("."),H=_||(G>-1?k.substring(G).toLowerCase():"");let z=null;for(const Y of Yt._TextureLoaders)if(Y.canLoad(H)){z=Y;break}const W=(Y,Z)=>{l===N?a&&Y&&a(Y.status+" "+Y.statusText,Z):(Ie.Warn(`Failed to load ${l}, falling back to the ${N}`),this.createCubeTextureBase(N,e,i,!!s,n,a,p,_,g,y,b,L,S,M,F))};if(z){const Y=Z=>{S&&S(L,Z),z.loadCubeData(Z,L,g,n,a)};i&&i.length===6?z.supportCascades?this._cascadeLoadFiles(e,Z=>Y(Z.map(Q=>new Uint8Array(Q))),i,a):a?a("Textures type does not support cascades."):Ie.Warn("Texture loader does not support cascades."):this._loadFile(l,Z=>Y(new Uint8Array(Z)),void 0,void 0,!0,W)}else{if(!i)throw new Error("Cannot load cubemap because files were not defined");this._cascadeLoadImgs(e,L,(Y,Z)=>{M&&M(Y,Z)},i,a)}return this._internalTexturesCache.push(L),L},Yt.prototype.createCubeTexture=function(l,e,i,s,n=null,a=null,p,_=null,g=!1,y=0,b=0,v=null,S,M=!1){const F=this._gl;return this.createCubeTextureBase(l,e,i,!!s,n,a,p,_,g,y,b,v,L=>this._bindTextureDirectly(F.TEXTURE_CUBE_MAP,L,!0),(L,N)=>{const k=this.needPOTTextures?Yt.GetExponentOfTwo(N[0].width,this._caps.maxCubemapTextureSize):N[0].width,G=k,H=[F.TEXTURE_CUBE_MAP_POSITIVE_X,F.TEXTURE_CUBE_MAP_POSITIVE_Y,F.TEXTURE_CUBE_MAP_POSITIVE_Z,F.TEXTURE_CUBE_MAP_NEGATIVE_X,F.TEXTURE_CUBE_MAP_NEGATIVE_Y,F.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(F.TEXTURE_CUBE_MAP,L,!0),this._unpackFlipY(!1);const z=p?this._getInternalFormat(p,L._useSRGBBuffer):L._useSRGBBuffer?F.SRGB8_ALPHA8:F.RGBA;let W=p?this._getInternalFormat(p):F.RGBA;L._useSRGBBuffer&&this.webGLVersion===1&&(W=z);for(let Y=0;Y<H.length;Y++)if(N[Y].width!==k||N[Y].height!==G){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext){Ie.Warn("Cannot create canvas to resize texture.");return}this._workingCanvas.width=k,this._workingCanvas.height=G,this._workingContext.drawImage(N[Y],0,0,N[Y].width,N[Y].height,0,0,k,G),F.texImage2D(H[Y],0,z,W,F.UNSIGNED_BYTE,this._workingCanvas)}else F.texImage2D(H[Y],0,z,W,F.UNSIGNED_BYTE,N[Y]);s||F.generateMipmap(F.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(L,!s),L.width=k,L.height=G,L.isReady=!0,p&&(L.format=p),L.onLoadedObservable.notifyObservers(L),L.onLoadedObservable.clear(),n&&n()},!!M)};class nn extends er{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const i=this.getScene();i&&i.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(fe.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,i,s){let n="";return e.forEach(a=>n+=a),new nn(n,i,null,s,e)}static CreateFromPrefilteredData(e,i,s=null,n=!0){const a=i.useDelayedTextureLoading;i.useDelayedTextureLoading=!1;const p=new nn(e,i,null,!1,null,null,null,void 0,!0,s,n);return i.useDelayedTextureLoading=a,p}constructor(e,i,s=null,n=!1,a=null,p=null,_=null,g=5,y=!1,b=null,v=!1,S=.8,M=0,F,L){var N;super(i),this._lodScale=.8,this._lodOffset=0,this.onLoadObservable=new Re,this.boundingBoxPosition=j.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this.name=e,this.url=e,this._noMipmap=n,this.hasAlpha=!1,this._format=g,this.isCube=!0,this._textureMatrix=fe.Identity(),this._createPolynomials=v,this.coordinatesMode=Oe.CUBIC_MODE,this._extensions=s,this._files=a,this._forcedExtension=b,this._loaderOptions=F,this._useSRGBBuffer=L,this._lodScale=S,this._lodOffset=M,!(!e&&!a)&&this.updateURL(e,b,p,y,_,s,(N=this.getScene())===null||N===void 0?void 0:N.useDelayedTextureLoading,a)}getClassName(){return"CubeTexture"}updateURL(e,i,s=null,n=!1,a=null,p=null,_=!1,g=null){(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,i&&(this._forcedExtension=i);const y=e.lastIndexOf("."),b=i||(y>-1?e.substring(y).toLowerCase():""),v=b.indexOf(".dds")===0,S=b.indexOf(".env")===0,M=b.indexOf(".basis")===0;if(S?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=n,n&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),g)this._files=g;else if(!M&&!S&&!v&&!p&&(p=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,p){for(let F=0;F<p.length;F++)this._files.push(e+p[F]);this._extensions=p}_?(this.delayLoadState=4,this._delayedOnLoad=s,this._delayedOnError=a):this._loadTexture(s,a)}delayLoad(e){this.delayLoadState===4&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var i;e.updateFlag!==this._textureMatrix.updateFlag&&(e.isIdentity()!==this._textureMatrix.isIdentity()&&((i=this.getScene())===null||i===void 0||i.markAllMaterialsAsDirty(1,s=>s.getActiveTextures().indexOf(this)!==-1)),this._textureMatrix=e)}_loadTexture(e=null,i=null){var s;const n=this.getScene(),a=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);const p=()=>{var g;this.onLoadObservable.notifyObservers(this),a&&(a.dispose(),(g=this.getScene())===null||g===void 0||g.markAllMaterialsAsDirty(1)),e&&e()},_=(g,y)=>{this._loadingError=!0,this._errorObject={message:g,exception:y},i&&i(g,y),Oe.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?Le.SetImmediate(()=>p()):this._texture.onLoadedObservable.add(()=>p()):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,n,this._lodScale,this._lodOffset,e,_,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,n,this._files,this._noMipmap,e,_,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer),(s=this._texture)===null||s===void 0||s.onLoadedObservable.add(()=>this.onLoadObservable.notifyObservers(this)))}static Parse(e,i,s){const n=Kt.Parse(()=>{let a=!1;return e.prefiltered&&(a=e.prefiltered),new nn(s+e.name,i,e.extensions,!1,e.files||null,null,null,void 0,a,e.forcedExtension)},e,i);if(e.boundingBoxPosition&&(n.boundingBoxPosition=j.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(n.boundingBoxSize=j.FromArray(e.boundingBoxSize)),e.animations)for(let a=0;a<e.animations.length;a++){const p=e.animations[a],_=Ka("BABYLON.Animation");_&&n.animations.push(_.Parse(p))}return n}clone(){let e=0;const i=Kt.Clone(()=>{const s=new nn(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=s.uniqueId,s},this);return i.uniqueId=e,i}}J([xe()],nn.prototype,"url",void 0),J([Rn()],nn.prototype,"boundingBoxPosition",void 0),J([Rn()],nn.prototype,"boundingBoxSize",null),J([xe("rotationY")],nn.prototype,"rotationY",null),J([xe("files")],nn.prototype,"_files",void 0),J([xe("forcedExtension")],nn.prototype,"_forcedExtension",void 0),J([xe("extensions")],nn.prototype,"_extensions",void 0),J([F9("textureMatrix")],nn.prototype,"_textureMatrix",void 0),Oe._CubeTextureParser=nn.Parse,ur("BABYLON.CubeTexture",nn);const RI="backgroundFragmentDeclaration",II=`uniform vec4 vEyePosition;
uniform vec4 vPrimaryColor;
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
uniform vec4 vPrimaryColorShadow;
#endif
uniform float shadowLevel;
uniform float alpha;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
#endif
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)
uniform mat4 view;
#endif
`;Ye.IncludesShadersStore[RI]=II;const Dq={name:RI,shader:II},SI="backgroundUboDeclaration",MI=`layout(std140,column_major) uniform;
uniform Material
{
uniform vec4 vPrimaryColor;
uniform vec4 vPrimaryColorShadow;
uniform vec2 vDiffuseInfos;
uniform vec2 vReflectionInfos;
uniform mat4 diffuseMatrix;
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
uniform float fFovMultiplier;
uniform float pointSize;
uniform float shadowLevel;
uniform float alpha;
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
};
#include<sceneUboDeclaration>
`;Ye.IncludesShadersStore[SI]=MI;const Fq={name:SI,shader:MI},PI="backgroundPixelShader",OI=`#ifdef TEXTURELODSUPPORT
#extension GL_EXT_shader_texture_lod : enable
#endif
precision highp float;
#include<__decl__backgroundFragment>
#include<helperFunctions>
#define RECIPROCAL_PI2 0.15915494
varying vec3 vPositionW;
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif 
#ifdef MAINUV2 
varying vec2 vMainUV2; 
#endif 
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef DIFFUSE
#if DIFFUSEDIRECTUV==1
#define vDiffuseUV vMainUV1
#elif DIFFUSEDIRECTUV==2
#define vDiffuseUV vMainUV2
#else
varying vec2 vDiffuseUV;
#endif
uniform sampler2D diffuseSampler;
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;
uniform samplerCube reflectionSamplerHigh;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;
uniform samplerCube reflectionSamplerHigh;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE;
#endif
#ifndef SHADOWONLY
#define SHADOWONLY;
#endif
#include<imageProcessingDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<imageProcessingFunctions>
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#ifdef REFLECTIONFRESNEL
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
vec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{
float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);
return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));
}
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=vec3(0.0,1.0,0.0);
#endif
float shadow=1.;
float globalShadow=0.;
float shadowLightCount=0.;
#include<lightFragment>[0..maxSimultaneousLights]
#ifdef SHADOWINUSE
globalShadow/=shadowLightCount;
#else
globalShadow=1.0;
#endif
#ifndef BACKMAT_SHADOWONLY
vec4 reflectionColor=vec4(1.,1.,1.,1.);
#ifdef REFLECTION
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=reflectionVector;
#else
vec2 reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
#ifdef REFLECTIONBLUR
float reflectionLOD=vReflectionInfos.y;
#ifdef TEXTURELODSUPPORT
reflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
reflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#else
float lodReflectionNormalized=saturate(reflectionLOD);
float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;
vec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);
if(lodReflectionNormalizedDoubled<1.0){
reflectionColor=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
reflectionSpecularMid,
lodReflectionNormalizedDoubled
);
} else {
reflectionColor=mix(
reflectionSpecularMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);
}
#endif
#else
vec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);
reflectionColor=reflectionSample;
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef GAMMAREFLECTION
reflectionColor.rgb=toLinearSpace(reflectionColor.rgb);
#endif
#ifdef REFLECTIONBGR
reflectionColor.rgb=reflectionColor.bgr;
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#endif
vec3 diffuseColor=vec3(1.,1.,1.);
float finalAlpha=alpha;
#ifdef DIFFUSE
vec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);
#ifdef GAMMADIFFUSE
diffuseMap.rgb=toLinearSpace(diffuseMap.rgb);
#endif
diffuseMap.rgb*=vDiffuseInfos.y;
#ifdef DIFFUSEHASALPHA
finalAlpha*=diffuseMap.a;
#endif
diffuseColor=diffuseMap.rgb;
#endif
#ifdef REFLECTIONFRESNEL
vec3 colorBase=diffuseColor;
#else
vec3 colorBase=reflectionColor.rgb*diffuseColor;
#endif
colorBase=max(colorBase,0.0);
#ifdef USERGBCOLOR
vec3 finalColor=colorBase;
#else
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
vec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);
#else
vec3 mainColor=vPrimaryColor.rgb;
#endif
vec3 finalColor=colorBase*mainColor;
#endif
#ifdef REFLECTIONFRESNEL
vec3 reflectionAmount=vReflectionControl.xxx;
vec3 reflectionReflectance0=vReflectionControl.yyy;
vec3 reflectionReflectance90=vReflectionControl.zzz;
float VdotN=dot(normalize(vEyePosition.xyz),normalW);
vec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);
reflectionAmount*=planarReflectionFresnel;
#ifdef REFLECTIONFALLOFF
float reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);
reflectionDistanceFalloff*=reflectionDistanceFalloff;
reflectionAmount*=reflectionDistanceFalloff;
#endif
finalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));
#endif
#ifdef OPACITYFRESNEL
float viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));
const float startAngle=0.1;
float fadeFactor=saturate(viewAngleToFloor/startAngle);
finalAlpha*=fadeFactor*fadeFactor;
#endif
#ifdef SHADOWINUSE
finalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);
#endif
vec4 color=vec4(finalColor,finalAlpha);
#else
vec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);
#endif
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
#if !defined(SKIPFINALCOLORCLAMP)
color.rgb=clamp(color.rgb,0.,30.0);
#endif
#else
color=applyImageProcessing(color);
#endif
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#ifdef NOISE
color.rgb+=dither(vPositionW.xy,0.5);
color=max(color,0.0);
#endif
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;Ye.ShadersStore[PI]=OI;const Lq={name:PI,shader:OI},wI="backgroundVertexDeclaration",DI=`uniform mat4 view;
uniform mat4 viewProjection;
uniform float shadowLevel;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
uniform float fFovMultiplier;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
`;Ye.IncludesShadersStore[wI]=DI;const Nq={name:wI,shader:DI},FI="backgroundVertexShader",LI=`precision highp float;
#include<__decl__backgroundVertex>
#include<helperFunctions>
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
varying vec2 vDiffuseUV;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=position;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
} else {
gl_Position=viewProjectionR*finalWorld*vec4(position,1.0);
}
#else
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#endif
vec4 worldPos=finalWorld*vec4(position,1.0);
vPositionW=vec3(worldPos);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normal);
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));
#ifdef EQUIRECTANGULAR_RELFECTION_FOV
mat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));
vec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));
if (fFovMultiplier<=1.0) {
vDirectionW=normalize(segment);
} else {
vDirectionW=normalize(vDirectionW+(vDirectionW-segment));
}
#endif
#endif
#ifndef UV1
vec2 uv=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uv;
#endif
#ifdef MAINUV2
vMainUV2=uv2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
if (vDiffuseInfos.x==0.)
{
vDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));
}
else
{
vDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
}
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#ifdef VERTEXCOLOR
vColor=color;
#endif
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#define CUSTOM_VERTEX_MAIN_END
}
`;Ye.ShadersStore[FI]=LI;const Bq={name:FI,shader:LI};class nz extends ja{constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}}class Mi extends qh{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let i=e;i<.5?(i=i*2,this.reflectionReflectance0=Mi.StandardReflectance0*i,this.reflectionReflectance90=Mi.StandardReflectance90*i):(i=i*2-1,this.reflectionReflectance0=Mi.StandardReflectance0+(1-Mi.StandardReflectance0)*i,this.reflectionReflectance90=Mi.StandardReflectance90+(1-Mi.StandardReflectance90)*i)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsImageProcessingDirty()})))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this.imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this.imageProcessingConfiguration.colorCurves=e}constructor(e,i){super(e,i),this.primaryColor=qe.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=j.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this._imageProcessingObserver=null,this.switchToBGR=!1,this._renderTargets=new Ps(16),this._reflectionControls=xr.Zero(),this._white=qe.White(),this._primaryShadowColor=qe.Black(),this._primaryHighlightColor=qe.Black(),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get hasRenderTargetTextures(){return!!(this._diffuseTexture&&this._diffuseTexture.isRenderTarget||this._reflectionTexture&&this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,i,s=!1){if(i.effect&&this.isFrozen&&i.effect._wasPreviouslyReady&&i.effect._wasPreviouslyUsingInstances===s)return!0;i.materialDefines||(i.materialDefines=new nz);const n=this.getScene(),a=i.materialDefines;if(this._isReadyForSubMesh(i))return!0;const p=n.getEngine();if(nt.PrepareDefinesForLights(n,e,a,!1,this._maxSimultaneousLights),a._needNormals=!0,nt.PrepareDefinesForMultiview(n,a),a._areTexturesDirty){if(a._needUVs=!1,n.texturesEnabled){if(n.getEngine().getCaps().textureLOD&&(a.TEXTURELODSUPPORT=!0),this._diffuseTexture&&Ze.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;nt.PrepareDefinesForMergedUV(this._diffuseTexture,a,"DIFFUSE"),a.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,a.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,a.OPACITYFRESNEL=this._opacityFresnel}else a.DIFFUSE=!1,a.DIFFUSEDIRECTUV=0,a.DIFFUSEHASALPHA=!1,a.GAMMADIFFUSE=!1,a.OPACITYFRESNEL=!1;const _=this._reflectionTexture;if(_&&Ze.ReflectionTextureEnabled){if(!_.isReadyOrNotBlocking())return!1;switch(a.REFLECTION=!0,a.GAMMAREFLECTION=_.gammaSpace,a.RGBDREFLECTION=_.isRGBD,a.REFLECTIONBLUR=this._reflectionBlur>0,a.LODINREFLECTIONALPHA=_.lodLevelInAlpha,a.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,a.REFLECTIONBGR=this.switchToBGR,_.coordinatesMode===Oe.INVCUBIC_MODE&&(a.INVERTCUBICMAP=!0),a.REFLECTIONMAP_3D=_.isCube,a.REFLECTIONMAP_OPPOSITEZ=a.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!_.invertZ:_.invertZ,_.coordinatesMode){case Oe.EXPLICIT_MODE:a.REFLECTIONMAP_EXPLICIT=!0;break;case Oe.PLANAR_MODE:a.REFLECTIONMAP_PLANAR=!0;break;case Oe.PROJECTION_MODE:a.REFLECTIONMAP_PROJECTION=!0;break;case Oe.SKYBOX_MODE:a.REFLECTIONMAP_SKYBOX=!0;break;case Oe.SPHERICAL_MODE:a.REFLECTIONMAP_SPHERICAL=!0;break;case Oe.EQUIRECTANGULAR_MODE:a.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case Oe.FIXED_EQUIRECTANGULAR_MODE:a.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case Oe.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:a.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case Oe.CUBIC_MODE:case Oe.INVCUBIC_MODE:default:a.REFLECTIONMAP_CUBIC=!0;break}this.reflectionFresnel?(a.REFLECTIONFRESNEL=!0,a.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(a.REFLECTIONFRESNEL=!1,a.REFLECTIONFALLOFF=!1)}else a.REFLECTION=!1,a.REFLECTIONFRESNEL=!1,a.REFLECTIONFALLOFF=!1,a.REFLECTIONBLUR=!1,a.REFLECTIONMAP_3D=!1,a.REFLECTIONMAP_SPHERICAL=!1,a.REFLECTIONMAP_PLANAR=!1,a.REFLECTIONMAP_CUBIC=!1,a.REFLECTIONMAP_PROJECTION=!1,a.REFLECTIONMAP_SKYBOX=!1,a.REFLECTIONMAP_EXPLICIT=!1,a.REFLECTIONMAP_EQUIRECTANGULAR=!1,a.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,a.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,a.INVERTCUBICMAP=!1,a.REFLECTIONMAP_OPPOSITEZ=!1,a.LODINREFLECTIONALPHA=!1,a.GAMMAREFLECTION=!1,a.RGBDREFLECTION=!1}a.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,a.USERGBCOLOR=this._useRGBColor,a.NOISE=this._enableNoise}if(a._areLightsDirty&&(a.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(this._primaryColorShadowLevel!==0||this._primaryColorHighlightLevel!==0),a.BACKMAT_SHADOWONLY=this._shadowOnly),a._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(a)}if(nt.PrepareDefinesForMisc(e,n,!1,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),a),nt.PrepareDefinesForFrameBoundValues(n,p,this,a,s,null,i.getRenderingMesh().hasThinInstances),nt.PrepareDefinesForAttributes(e,a,!1,!0,!1)&&e&&!n.getEngine().getCaps().standardDerivatives&&!e.isVerticesDataPresent(te.NormalKind)&&(e.createNormals(!0),Ie.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name)),a.isDirty){a.markAsProcessed(),n.resetCachedMaterial();const _=new Zh;a.FOG&&_.addFallback(0,"FOG"),a.POINTSIZE&&_.addFallback(1,"POINTSIZE"),a.MULTIVIEW&&_.addFallback(0,"MULTIVIEW"),nt.HandleFallbacksForShadows(a,_,this._maxSimultaneousLights);const g=[te.PositionKind];a.NORMAL&&g.push(te.NormalKind),a.UV1&&g.push(te.UVKind),a.UV2&&g.push(te.UV2Kind),nt.PrepareAttributesForBones(g,e,a,_),nt.PrepareAttributesForInstances(g,a);const y=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix"];O2(y);const b=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],v=["Material","Scene"];Oi&&(Oi.PrepareUniforms(y,a),Oi.PrepareSamplers(b,a)),nt.PrepareUniformsAndSamplersList({uniformsNames:y,uniformBuffersNames:v,samplers:b,defines:a,maxSimultaneousLights:this._maxSimultaneousLights});const S=a.toString(),M=n.getEngine().createEffect("background",{attributes:g,uniformsNames:y,uniformBuffersNames:v,samplers:b,defines:S,fallbacks:_,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights}},p);i.setEffect(M,a,this._materialContext),this.buildUniformLayout()}return!i.effect||!i.effect.isReady()?!1:(a._renderId=n.getRenderId(),i.effect._wasPreviouslyReady=!0,i.effect._wasPreviouslyUsingInstances=s,this._checkScenePerformancePriority(),!0)}_computePrimaryColorFromPerceptualColor(){!this.__perceptualColor||(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor,this.getScene().getEngine().useExactSrgbConversions),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){this._primaryColorShadowLevel===0&&this._primaryColorHighlightLevel===0||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,i,s){const n=this.getScene(),a=s.materialDefines;if(!a)return;const p=s.effect;if(!p)return;this._activeEffect=p,this.bindOnlyWorldMatrix(e),nt.BindBonesParameters(i,this._activeEffect);const _=this._mustRebind(n,p,i.visibility);if(_){this._uniformBuffer.bindToEffect(p,"Material"),this.bindViewProjection(p);const g=this._reflectionTexture;(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync)&&(n.texturesEnabled&&(this._diffuseTexture&&Ze.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),nt.BindTextureMatrix(this._diffuseTexture,this._uniformBuffer,"diffuse")),g&&Ze.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",g.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",g.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",g.getSize().width,g.lodGenerationScale,g.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),a.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),n.texturesEnabled&&(this._diffuseTexture&&Ze.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),g&&Ze.ReflectionTextureEnabled&&(a.REFLECTIONBLUR&&a.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",g):a.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",g._lodTextureMid||g),this._uniformBuffer.setTexture("reflectionSamplerLow",g._lodTextureLow||g),this._uniformBuffer.setTexture("reflectionSamplerHigh",g._lodTextureHigh||g)):this._uniformBuffer.setTexture("reflectionSampler",g),a.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w)))),w2(this._activeEffect,this,n),n.bindEyePosition(p)}else n.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(p,"Material"),this._needToBindSceneUbo=!0);(_||!this.isFrozen)&&(n.lightsEnabled&&nt.BindLights(n,i,this._activeEffect,a,this._maxSimultaneousLights),this.bindView(p),nt.BindFogParameters(n,i,this._activeEffect,!0),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(i,this._activeEffect),this._uniformBuffer.update()}hasTexture(e){return!!(super.hasTexture(e)||this._reflectionTexture===e||this._diffuseTexture===e)}dispose(e=!1,i=!1){i&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return Kt.Clone(()=>new Mi(e,this.getScene()),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,i,s){return Kt.Parse(()=>new Mi(e.name,i),e,i,s)}}Mi.StandardReflectance0=.05,Mi.StandardReflectance90=.5,J([Vs()],Mi.prototype,"_primaryColor",void 0),J([He("_markAllSubMeshesAsLightsDirty")],Mi.prototype,"primaryColor",void 0),J([Vs()],Mi.prototype,"__perceptualColor",void 0),J([xe()],Mi.prototype,"_primaryColorShadowLevel",void 0),J([xe()],Mi.prototype,"_primaryColorHighlightLevel",void 0),J([He("_markAllSubMeshesAsLightsDirty")],Mi.prototype,"primaryColorHighlightLevel",null),J([qi()],Mi.prototype,"_reflectionTexture",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],Mi.prototype,"reflectionTexture",void 0),J([xe()],Mi.prototype,"_reflectionBlur",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],Mi.prototype,"reflectionBlur",void 0),J([qi()],Mi.prototype,"_diffuseTexture",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],Mi.prototype,"diffuseTexture",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],Mi.prototype,"shadowLights",void 0),J([xe()],Mi.prototype,"_shadowLevel",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],Mi.prototype,"shadowLevel",void 0),J([Rn()],Mi.prototype,"_sceneCenter",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],Mi.prototype,"sceneCenter",void 0),J([xe()],Mi.prototype,"_opacityFresnel",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],Mi.prototype,"opacityFresnel",void 0),J([xe()],Mi.prototype,"_reflectionFresnel",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],Mi.prototype,"reflectionFresnel",void 0),J([xe()],Mi.prototype,"_reflectionFalloffDistance",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],Mi.prototype,"reflectionFalloffDistance",void 0),J([xe()],Mi.prototype,"_reflectionAmount",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],Mi.prototype,"reflectionAmount",void 0),J([xe()],Mi.prototype,"_reflectionReflectance0",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],Mi.prototype,"reflectionReflectance0",void 0),J([xe()],Mi.prototype,"_reflectionReflectance90",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],Mi.prototype,"reflectionReflectance90",void 0),J([xe()],Mi.prototype,"_useRGBColor",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],Mi.prototype,"useRGBColor",void 0),J([xe()],Mi.prototype,"_enableNoise",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],Mi.prototype,"enableNoise",void 0),J([xe()],Mi.prototype,"_maxSimultaneousLights",void 0),J([He("_markAllSubMeshesAsTexturesDirty")],Mi.prototype,"maxSimultaneousLights",void 0),J([xe()],Mi.prototype,"_shadowOnly",void 0),J([He("_markAllSubMeshesAsLightsDirty")],Mi.prototype,"shadowOnly",void 0),J([RE()],Mi.prototype,"_imageProcessingConfiguration",void 0),ur("BABYLON.BackgroundMaterial",Mi);function NI(l){const e=[],i=[],s=[],n=[],a=l.width||l.size||1,p=l.height||l.size||1,_=l.sideOrientation===0?0:l.sideOrientation||Mt.DEFAULTSIDE,g=a/2,y=p/2;i.push(-g,-y,0),s.push(0,0,-1),n.push(0,wr.UseOpenGLOrientationForUV?1:0),i.push(g,-y,0),s.push(0,0,-1),n.push(1,wr.UseOpenGLOrientationForUV?1:0),i.push(g,y,0),s.push(0,0,-1),n.push(1,wr.UseOpenGLOrientationForUV?0:1),i.push(-g,y,0),s.push(0,0,-1),n.push(0,wr.UseOpenGLOrientationForUV?0:1),e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),Mt._ComputeSides(_,i,e,s,n,l.frontUVs,l.backUVs);const b=new Mt;return b.indices=e,b.positions=i,b.normals=s,b.uvs=n,b}function T_(l,e={},i=null){const s=new Qe(l,i);return e.sideOrientation=Qe._GetDefaultSideOrientation(e.sideOrientation),s._originalBuilderSideOrientation=e.sideOrientation,NI(e).applyToMesh(s,e.updatable),e.sourcePlane&&(s.translate(e.sourcePlane.normal,-e.sourcePlane.d),s.setDirection(e.sourcePlane.normal.scale(-1))),s}const kq={CreatePlane:T_};Mt.CreatePlane=NI,Qe.CreatePlane=(l,e,i,s,n)=>T_(l,{size:e,width:e,height:e,sideOrientation:n,updatable:s},i);function BI(l){let i=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];const s=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],n=[];let a=[];const p=l.width||l.size||1,_=l.height||l.size||1,g=l.depth||l.size||1,y=l.wrap||!1;let b=l.topBaseAt===void 0?1:l.topBaseAt,v=l.bottomBaseAt===void 0?0:l.bottomBaseAt;b=(b+4)%4,v=(v+4)%4;const S=[2,0,3,1],M=[2,0,1,3];let F=S[b],L=M[v],N=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(y){i=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],N=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let Z=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],Q=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]];const se=[17,18,19,16],$=[22,23,20,21];for(;F>0;)Z.unshift(Z.pop()),se.unshift(se.pop()),F--;for(;L>0;)Q.unshift(Q.pop()),$.unshift($.pop()),L--;Z=Z.flat(),Q=Q.flat(),N=N.concat(Z).concat(Q),i.push(se[0],se[2],se[3],se[0],se[1],se[2]),i.push($[0],$[2],$[3],$[0],$[1],$[2])}const k=[p/2,_/2,g/2];a=N.reduce((Z,Q,se)=>Z.concat(Q*k[se%3]),[]);const G=l.sideOrientation===0?0:l.sideOrientation||Mt.DEFAULTSIDE,H=l.faceUV||new Array(6),z=l.faceColors,W=[];for(let Z=0;Z<6;Z++)H[Z]===void 0&&(H[Z]=new xr(0,0,1,1)),z&&z[Z]===void 0&&(z[Z]=new pi(1,1,1,1));for(let Z=0;Z<6;Z++)if(n.push(H[Z].z,wr.UseOpenGLOrientationForUV?1-H[Z].w:H[Z].w),n.push(H[Z].x,wr.UseOpenGLOrientationForUV?1-H[Z].w:H[Z].w),n.push(H[Z].x,wr.UseOpenGLOrientationForUV?1-H[Z].y:H[Z].y),n.push(H[Z].z,wr.UseOpenGLOrientationForUV?1-H[Z].y:H[Z].y),z)for(let Q=0;Q<4;Q++)W.push(z[Z].r,z[Z].g,z[Z].b,z[Z].a);Mt._ComputeSides(G,a,i,s,n,l.frontUVs,l.backUVs);const Y=new Mt;if(Y.indices=i,Y.positions=a,Y.normals=s,Y.uvs=n,z){const Z=G===Mt.DOUBLESIDE?W.concat(W):W;Y.colors=Z}return Y}function U2(l,e={},i=null){const s=new Qe(l,i);return e.sideOrientation=Qe._GetDefaultSideOrientation(e.sideOrientation),s._originalBuilderSideOrientation=e.sideOrientation,BI(e).applyToMesh(s,e.updatable),s}const Uq={CreateBox:U2};Mt.CreateBox=BI,Qe.CreateBox=(l,e,i=null,s,n)=>U2(l,{size:e,sideOrientation:n,updatable:s},i);class vl{static _GetDefaultOptions(e){return{createGround:!0,groundSize:15,groundTexture:this._GroundTextureCDNUrl,groundColor:new qe(.2,.2,.3).toLinearSpace(e.getEngine().useExactSrgbConversions).scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:this._SkyboxTextureCDNUrl,skyboxColor:new qe(.2,.2,.3).toLinearSpace(e.getEngine().useExactSrgbConversions).scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:j.Zero(),setupImageProcessing:!0,environmentTexture:this._EnvironmentTextureCDNUrl,cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}}get rootMesh(){return this._rootMesh}get skybox(){return this._skybox}get skyboxTexture(){return this._skyboxTexture}get skyboxMaterial(){return this._skyboxMaterial}get ground(){return this._ground}get groundTexture(){return this._groundTexture}get groundMirror(){return this._groundMirror}get groundMirrorRenderList(){return this._groundMirror?this._groundMirror.renderList:null}get groundMaterial(){return this._groundMaterial}constructor(e,i){this._errorHandler=(s,n)=>{this.onErrorObservable.notifyObservers({message:s,exception:n})},this._options={...vl._GetDefaultOptions(i),...e},this._scene=i,this.onErrorObservable=new Re,this._setupBackground(),this._setupImageProcessing()}updateOptions(e){const i={...this._options,...e};this._ground&&!i.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!i.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=i.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!i.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!i.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=i.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!i.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=i.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=i,this._setupBackground(),this._setupImageProcessing()}setMainColor(e){this.groundMaterial&&(this.groundMaterial.primaryColor=e),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=e),this.groundMirror&&(this.groundMirror.clearColor=new pi(e.r,e.g,e.b,1))}_setupImageProcessing(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())}_setupEnvironmentTexture(){if(this._scene.environmentTexture)return;if(this._options.environmentTexture instanceof er){this._scene.environmentTexture=this._options.environmentTexture;return}const e=nn.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=e}_setupBackground(){this._rootMesh||(this._rootMesh=new Qe("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;const e=this._getSceneSize();this._options.createGround&&(this._setupGround(e),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(e),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(e),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=e.rootPosition.x,this._rootMesh.position.z=e.rootPosition.z,this._rootMesh.position.y=e.rootPosition.y}_getSceneSize(){let e=this._options.groundSize,i=this._options.skyboxSize,s=this._options.rootPosition;if(!this._scene.meshes||this._scene.meshes.length===1)return{groundSize:e,skyboxSize:i,rootPosition:s};const n=this._scene.getWorldExtends(p=>p!==this._ground&&p!==this._rootMesh&&p!==this._skybox),a=n.max.subtract(n.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof Tr&&this._scene.activeCamera.upperRadiusLimit&&(e=this._scene.activeCamera.upperRadiusLimit*2,i=e);const p=a.length();p>e&&(e=p*2,i=e),e*=1.1,i*=1.5,s=n.min.add(a.scale(.5)),s.y=n.min.y-this._options.groundYBias}return{groundSize:e,skyboxSize:i,rootPosition:s}}_setupGround(e){(!this._ground||this._ground.isDisposed())&&(this._ground=T_("BackgroundPlane",{size:e.groundSize},this._scene),this._ground.rotation.x=Math.PI/2,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add(()=>{this._ground=null})),this._ground.receiveShadows=this._options.enableGroundShadow}_setupGroundMaterial(){this._groundMaterial||(this._groundMaterial=new Mi("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)}_setupGroundDiffuseTexture(){if(!!this._groundMaterial&&!this._groundTexture){if(this._options.groundTexture instanceof er){this._groundMaterial.diffuseTexture=this._options.groundTexture;return}this._groundTexture=new Oe(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture}}_setupGroundMirrorTexture(e){const i=Oe.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new k2("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,Oe.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new aa(0,-1,0,e.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=i,this._groundMirror.wrapV=i,this._groundMirror.renderList))for(let n=0;n<this._scene.meshes.length;n++){const a=this._scene.meshes[n];a!==this._ground&&a!==this._skybox&&a!==this._rootMesh&&this._groundMirror.renderList.push(a)}const s=this._options.groundColor.toGammaSpace(this._scene.getEngine().useExactSrgbConversions);this._groundMirror.clearColor=new pi(s.r,s.g,s.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel}_setupMirrorInGroundMaterial(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)}_setupSkybox(e){(!this._skybox||this._skybox.isDisposed())&&(this._skybox=U2("BackgroundSkybox",{size:e.skyboxSize,sideOrientation:Qe.BACKSIDE},this._scene),this._skybox.onDisposeObservable.add(()=>{this._skybox=null})),this._skybox.parent=this._rootMesh}_setupSkyboxMaterial(){!this._skybox||(this._skyboxMaterial||(this._skyboxMaterial=new Mi("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)}_setupSkyboxReflectionTexture(){if(!!this._skyboxMaterial&&!this._skyboxTexture){if(this._options.skyboxTexture instanceof er){this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture;return}this._skyboxTexture=new nn(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=Oe.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture}}dispose(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)}}vl._GroundTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundGround.png",vl._SkyboxTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundSkybox.dds",vl._EnvironmentTextureCDNUrl="https://assets.babylonjs.com/environments/environmentSpecular.env",a_.prototype.addDeviceOrientation=function(l){return this._deviceOrientationInput||(this._deviceOrientationInput=new kI,l&&(this._deviceOrientationInput.smoothFactor=l),this.add(this._deviceOrientationInput)),this};class kI{static WaitForOrientationChangeAsync(e){return new Promise((i,s)=>{let n=!1;const a=()=>{window.removeEventListener("deviceorientation",a),n=!0,i()};e&&setTimeout(()=>{n||(window.removeEventListener("deviceorientation",a),s("WaitForOrientationChangeAsync timed out"))},e),typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(p=>{p=="granted"?window.addEventListener("deviceorientation",a):Le.Warn("Permission not granted.")}).catch(p=>{Le.Error(p)}):window.addEventListener("deviceorientation",a)})}constructor(){this._screenOrientationAngle=0,this._screenQuaternion=new Ve,this._alpha=0,this._beta=0,this._gamma=0,this.smoothFactor=0,this._onDeviceOrientationChangedObservable=new Re,this._orientationChanged=()=>{this._screenOrientationAngle=window.orientation!==void 0?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-Le.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))},this._deviceOrientation=e=>{this.smoothFactor?(this._alpha=e.alpha!==null?Le.SmoothAngleChange(this._alpha,e.alpha,this.smoothFactor):0,this._beta=e.beta!==null?Le.SmoothAngleChange(this._beta,e.beta,this.smoothFactor):0,this._gamma=e.gamma!==null?Le.SmoothAngleChange(this._gamma,e.gamma,this.smoothFactor):0):(this._alpha=e.alpha!==null?e.alpha:0,this._beta=e.beta!==null?e.beta:0,this._gamma=e.gamma!==null?e.gamma:0),e.alpha!==null&&this._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTranform=new Ve(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}get camera(){return this._camera}set camera(e){this._camera=e,this._camera!=null&&!this._camera.rotationQuaternion&&(this._camera.rotationQuaternion=new Ve),this._camera&&this._camera.onDisposeObservable.add(()=>{this._onDeviceOrientationChangedObservable.clear()})}attachControl(){const e=this.camera.getScene().getEngine().getHostWindow();if(e){const i=()=>{e.addEventListener("orientationchange",this._orientationChanged),e.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(s=>{s==="granted"?i():Le.Warn("Permission not granted.")}).catch(s=>{Le.Error(s)}):i()}}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){!this._alpha||(Ve.RotationYawPitchRollToRef(Le.ToRadians(this._alpha),Le.ToRadians(this._beta),-Le.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTranform),this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}}Qa.FreeCameraDeviceOrientationInput=kI,vr.AddNodeConstructor("DeviceOrientationCamera",(l,e)=>()=>new E_(l,j.Zero(),e));class E_ extends Vn{constructor(e,i,s){super(e,i,s),this._tmpDragQuaternion=new Ve,this._disablePointerInputWhenUsingDeviceOrientation=!0,this._dragFactor=0,this._quaternionCache=new Ve,this.inputs.addDeviceOrientation(),this.inputs._deviceOrientationInput&&this.inputs._deviceOrientationInput._onDeviceOrientationChangedObservable.addOnce(()=>{this._disablePointerInputWhenUsingDeviceOrientation&&this.inputs._mouseInput&&(this.inputs._mouseInput._allowCameraRotation=!1,this.inputs._mouseInput.onPointerMovedObservable.add(n=>{this._dragFactor!=0&&(this._initialQuaternion||(this._initialQuaternion=new Ve),Ve.FromEulerAnglesToRef(0,n.offsetX*this._dragFactor,0,this._tmpDragQuaternion),this._initialQuaternion.multiplyToRef(this._tmpDragQuaternion,this._initialQuaternion))}))})}get disablePointerInputWhenUsingDeviceOrientation(){return this._disablePointerInputWhenUsingDeviceOrientation}set disablePointerInputWhenUsingDeviceOrientation(e){this._disablePointerInputWhenUsingDeviceOrientation=e}enableHorizontalDragging(e=1/300){this._dragFactor=e}getClassName(){return"DeviceOrientationCamera"}_checkInputs(){super._checkInputs(),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}resetToCurrentRotation(e=oa.Y){!this.rotationQuaternion||(this._initialQuaternion||(this._initialQuaternion=new Ve),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),["x","y","z"].forEach(i=>{e[i]?this._initialQuaternion[i]*=-1:this._initialQuaternion[i]=0}),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))}}class Jh{constructor(){this.compensateDistortion=!0,this.multiviewEnabled=!1}get aspectRatio(){return this.hResolution/(2*this.vResolution)}get aspectRatioFov(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))}get leftHMatrix(){const e=this.hScreenSize/4-this.lensSeparationDistance/2,i=4*e/this.hScreenSize;return fe.Translation(i,0,0)}get rightHMatrix(){const e=this.hScreenSize/4-this.lensSeparationDistance/2,i=4*e/this.hScreenSize;return fe.Translation(-i,0,0)}get leftPreViewMatrix(){return fe.Translation(.5*this.interpupillaryDistance,0,0)}get rightPreViewMatrix(){return fe.Translation(-.5*this.interpupillaryDistance,0,0)}static GetDefault(){const e=new Jh;return e.hResolution=1280,e.vResolution=800,e.hScreenSize=.149759993,e.vScreenSize=.0935999975,e.vScreenCenter=.0467999987,e.eyeToScreenDistance=.0410000011,e.lensSeparationDistance=.063500002,e.interpupillaryDistance=.064000003,e.distortionK=[1,.219999999,.239999995,0],e.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],e.postProcessScaleFactor=1.714605507808412,e.lensCenterOffset=.151976421,e}}const UI="vrDistortionCorrectionPixelShader",VI=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 LensCenter;
uniform vec2 Scale;
uniform vec2 ScaleIn;
uniform vec4 HmdWarpParam;
vec2 HmdWarp(vec2 in01) {
vec2 theta=(in01-LensCenter)*ScaleIn; 
float rSq=theta.x*theta.x+theta.y*theta.y;
vec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);
return LensCenter+Scale*rvector;
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec2 tc=HmdWarp(vUV);
if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)
gl_FragColor=vec4(0.0,0.0,0.0,0.0);
else{
gl_FragColor=texture2D(textureSampler,tc);
}
}`;Ye.ShadersStore[UI]=VI;const Vq={name:UI,shader:VI};class GI extends lr{getClassName(){return"VRDistortionCorrectionPostProcess"}constructor(e,i,s,n){super(e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,n.postProcessScaleFactor,i,Oe.BILINEAR_SAMPLINGMODE),this._isRightEye=s,this._distortionFactors=n.distortionK,this._postProcessScaleFactor=n.postProcessScaleFactor,this._lensCenterOffset=n.lensCenterOffset,this.adaptScaleToCurrentViewport=!0,this.onSizeChangedObservable.add(()=>{this._scaleIn=new ii(2,2/this.aspectRatio),this._scaleFactor=new ii(.5*(1/this._postProcessScaleFactor),.5*(1/this._postProcessScaleFactor)*this.aspectRatio),this._lensCenter=new ii(this._isRightEye?.5-this._lensCenterOffset*.5:.5+this._lensCenterOffset*.5,.5)}),this.onApplyObservable.add(a=>{a.setFloat2("LensCenter",this._lensCenter.x,this._lensCenter.y),a.setFloat2("Scale",this._scaleFactor.x,this._scaleFactor.y),a.setFloat2("ScaleIn",this._scaleIn.x,this._scaleIn.y),a.setFloat4("HmdWarpParam",this._distortionFactors[0],this._distortionFactors[1],this._distortionFactors[2],this._distortionFactors[3])})}}const WI="vrMultiviewToSingleviewPixelShader",zI=`precision mediump sampler2DArray;
varying vec2 vUV;
uniform sampler2DArray multiviewSampler;
uniform int imageIndex;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
gl_FragColor=texture2D(multiviewSampler,vec3(vUV,imageIndex));
}`;Ye.ShadersStore[WI]=zI;const Gq={name:WI,shader:zI};class A_ extends zn{set samples(e){this._samples=e}get samples(){return this._samples}constructor(e,i=512){super("multiview rtt",i,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0),this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight()),this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,this.samples=this._getEngine().getCaps().maxSamples||this.samples,this._texture.samples=this._samples}_bindFrameBuffer(){!this._renderTarget||this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)}getViewCount(){return 2}}Ae.prototype.createMultiviewRenderTargetTexture=function(l,e){const i=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";const s=this._createHardwareRenderTargetWrapper(!1,!1,{width:l,height:e});s._framebuffer=i.createFramebuffer();const n=new Bs(this,or.Unknown,!0);return n.width=l,n.height=e,n.isMultiview=!0,s._colorTextureArray=i.createTexture(),i.bindTexture(i.TEXTURE_2D_ARRAY,s._colorTextureArray),i.texStorage3D(i.TEXTURE_2D_ARRAY,1,i.RGBA8,l,e,2),s._depthStencilTextureArray=i.createTexture(),i.bindTexture(i.TEXTURE_2D_ARRAY,s._depthStencilTextureArray),i.texStorage3D(i.TEXTURE_2D_ARRAY,1,i.DEPTH24_STENCIL8,l,e,2),n.isReady=!0,s.setTextures(n),s._depthStencilTexture=n,s},Ae.prototype.bindMultiviewFramebuffer=function(l){const e=l,i=this._gl,s=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)this.getCaps().oculusMultiview?(s.framebufferTextureMultisampleMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,e._colorTextureArray,0,e.samples,0,2),s.framebufferTextureMultisampleMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,e.samples,0,2)):(s.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),s.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,0,2));else throw"Invalid multiview frame buffer"},wt.prototype._useMultiviewToSingleView=!1,wt.prototype._multiviewTexture=null,wt.prototype._resizeOrCreateMultiviewTexture=function(l,e){this._multiviewTexture?(this._multiviewTexture.getRenderWidth()!=l||this._multiviewTexture.getRenderHeight()!=e)&&(this._multiviewTexture.dispose(),this._multiviewTexture=new A_(this.getScene(),{width:l,height:e})):this._multiviewTexture=new A_(this.getScene(),{width:l,height:e})};function HI(l,e){const i=new At(l,void 0,!0,e);return i.addUniform("viewProjection",16),i.addUniform("viewProjectionR",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}const az=Nt.prototype.createSceneUniformBuffer;Nt.prototype._transformMatrixR=fe.Zero(),Nt.prototype._multiviewSceneUbo=null,Nt.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=HI(this.getEngine(),"scene_multiview")},Nt.prototype.createSceneUniformBuffer=function(l){return this._multiviewSceneUbo?HI(this.getEngine(),l):az.bind(this)(l)},Nt.prototype._updateMultiviewUbo=function(l,e){l&&e&&l.multiplyToRef(e,this._transformMatrixR),l&&e&&(l.multiplyToRef(e,ge.Matrix[0]),Ta.GetRightPlaneToRef(ge.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))},Nt.prototype._renderMultiviewToSingleView=function(l){l._resizeOrCreateMultiviewTexture(l._rigPostProcess&&l._rigPostProcess&&l._rigPostProcess.width>0?l._rigPostProcess.width:this.getEngine().getRenderWidth(!0),l._rigPostProcess&&l._rigPostProcess&&l._rigPostProcess.height>0?l._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),l.outputRenderTarget=l._multiviewTexture,this._renderForCamera(l),l.outputRenderTarget=null;for(let e=0;e<l._rigCameras.length;e++){const i=this.getEngine();this._activeCamera=l._rigCameras[e],i.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};class XI extends lr{getClassName(){return"VRMultiviewToSingleviewPostProcess"}constructor(e,i,s){super(e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],s,i,Oe.BILINEAR_SAMPLINGMODE);const n=i??this.getCamera();this.onSizeChangedObservable.add(()=>{}),this.onApplyObservable.add(a=>{n._scene.activeCamera&&n._scene.activeCamera.isLeftCamera?a.setInt("imageIndex",0):a.setInt("imageIndex",1),a.setTexture("multiviewSampler",n._multiviewTexture)})}}function oz(l,e){const i=e.vrCameraMetrics||Jh.GetDefault();l._rigCameras[0]._cameraRigParams.vrMetrics=i,l._rigCameras[0].viewport=new Za(0,0,.5,1),l._rigCameras[0]._cameraRigParams.vrWorkMatrix=new fe,l._rigCameras[0]._cameraRigParams.vrHMatrix=i.leftHMatrix,l._rigCameras[0]._cameraRigParams.vrPreViewMatrix=i.leftPreViewMatrix,l._rigCameras[0].getProjectionMatrix=l._rigCameras[0]._getVRProjectionMatrix,l._rigCameras[1]._cameraRigParams.vrMetrics=i,l._rigCameras[1].viewport=new Za(.5,0,.5,1),l._rigCameras[1]._cameraRigParams.vrWorkMatrix=new fe,l._rigCameras[1]._cameraRigParams.vrHMatrix=i.rightHMatrix,l._rigCameras[1]._cameraRigParams.vrPreViewMatrix=i.rightPreViewMatrix,l._rigCameras[1].getProjectionMatrix=l._rigCameras[1]._getVRProjectionMatrix,i.multiviewEnabled&&(l.getScene().getEngine().getCaps().multiview?(l._useMultiviewToSingleView=!0,l._rigPostProcess=new XI("VRMultiviewToSingleview",l,i.postProcessScaleFactor)):(Ie.Warn("Multiview is not supported, falling back to standard rendering"),i.multiviewEnabled=!1)),i.compensateDistortion&&(l._rigCameras[0]._rigPostProcess=new GI("VR_Distort_Compensation_Left",l._rigCameras[0],!1,i),l._rigCameras[1]._rigPostProcess=new GI("VR_Distort_Compensation_Right",l._rigCameras[1],!0,i))}vr.AddNodeConstructor("VRDeviceOrientationFreeCamera",(l,e)=>()=>new YI(l,j.Zero(),e));class YI extends E_{constructor(e,i,s,n=!0,a=Jh.GetDefault()){super(e,i,s),this._setRigMode=oz.bind(null,this),a.compensateDistortion=n,this.setCameraRigMode(wt.RIG_MODE_VR,{vrCameraMetrics:a})}getClassName(){return"VRDeviceOrientationFreeCamera"}}function xz(l,e){if(e.vrDisplay){const i=e.vrDisplay.getEyeParameters("left"),s=e.vrDisplay.getEyeParameters("right");l._rigCameras[0].viewport=new Za(0,0,.5,1),l._rigCameras[0].setCameraRigParameter("left",!0),l._rigCameras[0].setCameraRigParameter("specs",e.specs),l._rigCameras[0].setCameraRigParameter("eyeParameters",i),l._rigCameras[0].setCameraRigParameter("frameData",e.frameData),l._rigCameras[0].setCameraRigParameter("parentCamera",e.parentCamera),l._rigCameras[0]._cameraRigParams.vrWorkMatrix=new fe,l._rigCameras[0].getProjectionMatrix=l._getWebVRProjectionMatrix,l._rigCameras[0].parent=l,l._rigCameras[0]._getViewMatrix=l._getWebVRViewMatrix,l._rigCameras[1].viewport=new Za(.5,0,.5,1),l._rigCameras[1].setCameraRigParameter("eyeParameters",s),l._rigCameras[1].setCameraRigParameter("specs",e.specs),l._rigCameras[1].setCameraRigParameter("frameData",e.frameData),l._rigCameras[1].setCameraRigParameter("parentCamera",e.parentCamera),l._rigCameras[1]._cameraRigParams.vrWorkMatrix=new fe,l._rigCameras[1].getProjectionMatrix=l._getWebVRProjectionMatrix,l._rigCameras[1].parent=l,l._rigCameras[1]._getViewMatrix=l._getWebVRViewMatrix}}Object.defineProperty(Ae.prototype,"isInVRExclusivePointerMode",{get:function(){return this._vrExclusivePointerMode},enumerable:!0,configurable:!0}),Ae.prototype._prepareVRComponent=function(){this._vrSupported=!1,this._vrExclusivePointerMode=!1,this.onVRDisplayChangedObservable=new Re,this.onVRRequestPresentComplete=new Re,this.onVRRequestPresentStart=new Re},Ae.prototype.isVRDevicePresent=function(){return!!this._vrDisplay},Ae.prototype.getVRDevice=function(){return this._vrDisplay},Ae.prototype.initWebVR=function(){return this.initWebVRAsync(),this.onVRDisplayChangedObservable},Ae.prototype.initWebVRAsync=function(){const l=()=>{const e={vrDisplay:this._vrDisplay,vrSupported:this._vrSupported};this.onVRDisplayChangedObservable.notifyObservers(e),this._webVRInitPromise=new Promise(i=>{i(e)})};if(!this._onVrDisplayConnect){this._onVrDisplayConnect=i=>{this._vrDisplay=i.display,l()},this._onVrDisplayDisconnect=()=>{this._vrDisplay.cancelAnimationFrame(this._frameHandler),this._vrDisplay=void 0,this._frameHandler=Ae.QueueNewFrame(this._boundRenderFunction),l()},this._onVrDisplayPresentChange=()=>{this._vrExclusivePointerMode=this._vrDisplay&&this._vrDisplay.isPresenting};const e=this.getHostWindow();e&&(e.addEventListener("vrdisplayconnect",this._onVrDisplayConnect),e.addEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),e.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange))}return this._webVRInitPromise=this._webVRInitPromise||this._getVRDisplaysAsync(),this._webVRInitPromise.then(l),this._webVRInitPromise},Ae.prototype._getVRDisplaysAsync=function(){return new Promise(l=>{navigator.getVRDisplays?navigator.getVRDisplays().then(e=>{this._vrSupported=!0,this._vrDisplay=e[0],l({vrDisplay:this._vrDisplay,vrSupported:this._vrSupported})}):(this._vrDisplay=void 0,this._vrSupported=!1,l({vrDisplay:this._vrDisplay,vrSupported:this._vrSupported}))})},Ae.prototype.enableVR=function(l){if(this._vrDisplay&&!this._vrDisplay.isPresenting){const e=()=>{this.onVRRequestPresentComplete.notifyObservers(!0),this._onVRFullScreenTriggered()},i=()=>{this.onVRRequestPresentComplete.notifyObservers(!1)};this.onVRRequestPresentStart.notifyObservers(this);const s={highRefreshRate:this.vrPresentationAttributes?this.vrPresentationAttributes.highRefreshRate:!1,foveationLevel:this.vrPresentationAttributes?this.vrPresentationAttributes.foveationLevel:1,multiview:(this.getCaps().multiview||this.getCaps().oculusMultiview)&&l.useMultiview};this._vrDisplay.requestPresent([{source:this.getRenderingCanvas(),attributes:s,...s}]).then(e).catch(i)}},Ae.prototype._onVRFullScreenTriggered=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting){this._oldSize=new Aa(this.getRenderWidth(),this.getRenderHeight()),this._oldHardwareScaleFactor=this.getHardwareScalingLevel();const l=this._vrDisplay.getEyeParameters("left");this.setHardwareScalingLevel(1),this.setSize(l.renderWidth*2,l.renderHeight)}else this.setHardwareScalingLevel(this._oldHardwareScaleFactor),this.setSize(this._oldSize.width,this._oldSize.height)},Ae.prototype.disableVR=function(){this._vrDisplay&&this._vrDisplay.isPresenting&&this._vrDisplay.exitPresent().then(()=>this._onVRFullScreenTriggered()).catch(()=>this._onVRFullScreenTriggered()),Ts()&&(window.removeEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted),window.removeEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted),this._onVrDisplayConnect&&(window.removeEventListener("vrdisplayconnect",this._onVrDisplayConnect),this._onVrDisplayDisconnect&&window.removeEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),this._onVrDisplayPresentChange&&window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange),this._onVrDisplayConnect=null,this._onVrDisplayDisconnect=null))},Ae.prototype._connectVREvents=function(l,e){if(this._onVRDisplayPointerRestricted=()=>{l&&l.requestPointerLock()},this._onVRDisplayPointerUnrestricted=()=>{if(!e){const i=this.getHostWindow();i.document&&i.document.exitPointerLock&&i.document.exitPointerLock();return}!e.exitPointerLock||e.exitPointerLock()},Ts()){const i=this.getHostWindow();i.addEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted,!1),i.addEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted,!1)}},Ae.prototype._submitVRFrame=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting)try{this._vrDisplay.submitFrame()}catch(l){Le.Warn("webVR submitFrame has had an unexpected failure: "+l)}},Ae.prototype.isVRPresenting=function(){return this._vrDisplay&&this._vrDisplay.isPresenting},Ae.prototype._requestVRFrame=function(){this._frameHandler=Ae.QueueNewFrame(this._boundRenderFunction,this._vrDisplay)},vr.AddNodeConstructor("WebVRFreeCamera",(l,e)=>()=>new C_(l,j.Zero(),e)),vr.AddNodeConstructor("WebVRGamepadCamera",(l,e)=>()=>new C_(l,j.Zero(),e));class C_ extends Vn{constructor(e,i,s,n={}){super(e,i,s),this._webVROptions=n,this._vrDevice=null,this.rawPose=null,this._specsVersion="1.1",this._attached=!1,this._descendants=[],this._deviceRoomPosition=j.Zero(),this._deviceRoomRotationQuaternion=Ve.Identity(),this._standingMatrix=null,this.devicePosition=j.Zero(),this.deviceRotationQuaternion=Ve.Identity(),this.deviceScaleFactor=1,this._deviceToWorld=fe.Identity(),this._worldToDevice=fe.Identity(),this.controllers=[],this.onControllersAttachedObservable=new Re,this.onControllerMeshLoadedObservable=new Re,this.onPoseUpdatedFromDeviceObservable=new Re,this._poseSet=!1,this.rigParenting=!0,this._defaultHeight=void 0,this._setRigMode=xz.bind(null,this),this._detachIfAttached=()=>{const p=this.getEngine().getVRDevice();p&&!p.isPresenting&&this.detachControl()},this._workingVector=j.Zero(),this._oneVector=j.One(),this._workingMatrix=fe.Identity(),this._tmpMatrix=new fe,this._cache.position=j.Zero(),n.defaultHeight&&(this._defaultHeight=n.defaultHeight,this.position.y=this._defaultHeight),this.minZ=.1,arguments.length===5&&(this._webVROptions=arguments[4]),this._webVROptions.trackPosition==null&&(this._webVROptions.trackPosition=!0),this._webVROptions.controllerMeshes==null&&(this._webVROptions.controllerMeshes=!0),this._webVROptions.defaultLightingOnControllers==null&&(this._webVROptions.defaultLightingOnControllers=!0),this.rotationQuaternion=new Ve,this._webVROptions&&this._webVROptions.positionScale&&(this.deviceScaleFactor=this._webVROptions.positionScale);const a=this.getEngine();this._onVREnabled=p=>{p&&this.initControllers()},a.onVRRequestPresentComplete.add(this._onVREnabled),a.initWebVR().add(p=>{!p.vrDisplay||this._vrDevice===p.vrDisplay||(this._vrDevice=p.vrDisplay,this.setCameraRigMode(wt.RIG_MODE_WEBVR,{parentCamera:this,vrDisplay:this._vrDevice,frameData:this._frameData,specs:this._specsVersion}),this._attached&&this.getEngine().enableVR(this._webVROptions))}),typeof VRFrameData<"u"&&(this._frameData=new VRFrameData),n.useMultiview&&(this.getScene().getEngine().getCaps().multiview?(this._useMultiviewToSingleView=!0,this._rigPostProcess=new XI("VRMultiviewToSingleview",this,1)):(Ie.Warn("Multiview is not supported, falling back to standard rendering"),this._useMultiviewToSingleView=!1)),this.getScene().onBeforeCameraRenderObservable.add(p=>{p.parent===this&&this.rigParenting&&(this._descendants=this.getDescendants(!0,_=>{const g=this.controllers.some(b=>b._mesh===_),y=this._rigCameras.indexOf(_)!==-1;return!g&&!y}),this._descendants.forEach(_=>{_.parent=p}))}),this.getScene().onAfterCameraRenderObservable.add(p=>{p.parent===this&&this.rigParenting&&this._descendants.forEach(_=>{_.parent=this})})}deviceDistanceToRoomGround(){return this._standingMatrix?(this._standingMatrix.getTranslationToRef(this._workingVector),this._deviceRoomPosition.y+this._workingVector.y):this._defaultHeight||0}useStandingMatrix(e=i=>{}){this.getEngine().initWebVRAsync().then(i=>{!i.vrDisplay||!i.vrDisplay.stageParameters||!i.vrDisplay.stageParameters.sittingToStandingTransform||!this._webVROptions.trackPosition?e(!1):(this._standingMatrix=new fe,fe.FromFloat32ArrayToRefScaled(i.vrDisplay.stageParameters.sittingToStandingTransform,0,1,this._standingMatrix),this.getScene().useRightHandedSystem||this._standingMatrix&&this._standingMatrix.toggleModelMatrixHandInPlace(),e(!0))})}useStandingMatrixAsync(){return new Promise(e=>{this.useStandingMatrix(i=>{e(i)})})}dispose(){this._detachIfAttached(),this.getEngine().onVRRequestPresentComplete.removeCallback(this._onVREnabled),this._updateCacheWhenTrackingDisabledObserver&&this._scene.onBeforeRenderObservable.remove(this._updateCacheWhenTrackingDisabledObserver),super.dispose()}getControllerByName(e){for(const i of this.controllers)if(i.hand===e)return i;return null}get leftController(){return this._leftController||(this._leftController=this.getControllerByName("left")),this._leftController}get rightController(){return this._rightController||(this._rightController=this.getControllerByName("right")),this._rightController}getForwardRay(e=100){return this.leftCamera?super.getForwardRay(e,this.leftCamera.getWorldMatrix(),this.leftCamera.globalPosition):super.getForwardRay(e)}_checkInputs(){this._vrDevice&&this._vrDevice.isPresenting&&(this._vrDevice.getFrameData(this._frameData),this.updateFromDevice(this._frameData.pose)),super._checkInputs()}updateFromDevice(e){e&&e.orientation&&e.orientation.length===4&&(this.rawPose=e,this._deviceRoomRotationQuaternion.copyFromFloats(e.orientation[0],e.orientation[1],-e.orientation[2],-e.orientation[3]),this.getScene().useRightHandedSystem&&(this._deviceRoomRotationQuaternion.z*=-1,this._deviceRoomRotationQuaternion.w*=-1),this._webVROptions.trackPosition&&this.rawPose.position&&(this._deviceRoomPosition.copyFromFloats(this.rawPose.position[0],this.rawPose.position[1],-this.rawPose.position[2]),this.getScene().useRightHandedSystem&&(this._deviceRoomPosition.z*=-1)),this._poseSet=!0)}attachControl(e){e=Le.BackCompatCameraNoPreventDefault(arguments),super.attachControl(e),this._attached=!0,e=wt.ForceAttachControlToAlwaysPreventDefault?!1:e,this._vrDevice&&this.getEngine().enableVR(this._webVROptions);const i=this._scene.getEngine().getHostWindow();i&&i.addEventListener("vrdisplaypresentchange",this._detachIfAttached)}detachControl(){this.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),super.detachControl(),this._attached=!1,this.getEngine().disableVR(),window.removeEventListener("vrdisplaypresentchange",this._detachIfAttached)}getClassName(){return"WebVRFreeCamera"}resetToCurrentRotation(){this._vrDevice.resetPose()}_updateRigCameras(){const e=this._rigCameras[0],i=this._rigCameras[1];e.rotationQuaternion.copyFrom(this._deviceRoomRotationQuaternion),i.rotationQuaternion.copyFrom(this._deviceRoomRotationQuaternion),e.position.copyFrom(this._deviceRoomPosition),i.position.copyFrom(this._deviceRoomPosition)}_correctPositionIfNotTrackPosition(e,i=!1){this.rawPose&&this.rawPose.position&&!this._webVROptions.trackPosition&&(fe.TranslationToRef(this.rawPose.position[0],this.rawPose.position[1],-this.rawPose.position[2],this._tmpMatrix),i||this._tmpMatrix.invert(),this._tmpMatrix.multiplyToRef(e,e))}_updateCache(e){(!this.rotationQuaternion.equals(this._cache.rotationQuaternion)||!this.position.equals(this._cache.position))&&(this._updateCacheCalled||(this._updateCacheCalled=!0,this.update()),this.rotationQuaternion.toRotationMatrix(this._workingMatrix),j.TransformCoordinatesToRef(this._deviceRoomPosition,this._workingMatrix,this._workingVector),this.devicePosition.subtractToRef(this._workingVector,this._workingVector),fe.ComposeToRef(this._oneVector,this.rotationQuaternion,this._workingVector,this._deviceToWorld),this._deviceToWorld.getTranslationToRef(this._workingVector),this._workingVector.addInPlace(this.position),this._workingVector.subtractInPlace(this._cache.position),this._deviceToWorld.setTranslation(this._workingVector),this._deviceToWorld.invertToRef(this._worldToDevice),this.controllers.forEach(i=>{i._deviceToWorld.copyFrom(this._deviceToWorld),this._correctPositionIfNotTrackPosition(i._deviceToWorld),i.update()})),e||super._updateCache(),this._updateCacheCalled=!1}_computeDevicePosition(){j.TransformCoordinatesToRef(this._deviceRoomPosition,this._deviceToWorld,this.devicePosition)}update(){this._computeDevicePosition(),fe.FromQuaternionToRef(this._deviceRoomRotationQuaternion,this._workingMatrix),this._workingMatrix.multiplyToRef(this._deviceToWorld,this._workingMatrix),Ve.FromRotationMatrixToRef(this._workingMatrix,this.deviceRotationQuaternion),this._poseSet&&this.onPoseUpdatedFromDeviceObservable.notifyObservers(null),super.update()}_getViewMatrix(){return fe.Identity()}_getWebVRViewMatrix(){const e=this._cameraRigParams.parentCamera;e._updateCache();const i=this._cameraRigParams.left?this._cameraRigParams.frameData.leftViewMatrix:this._cameraRigParams.frameData.rightViewMatrix;return fe.FromArrayToRef(i,0,this._webvrViewMatrix),this.getScene().useRightHandedSystem||this._webvrViewMatrix.toggleModelMatrixHandInPlace(),this._webvrViewMatrix.getRotationMatrixToRef(this._cameraRotationMatrix),j.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),e.deviceScaleFactor!==1&&(this._webvrViewMatrix.invert(),e.deviceScaleFactor&&(this._webvrViewMatrix.multiplyAtIndex(12,e.deviceScaleFactor),this._webvrViewMatrix.multiplyAtIndex(13,e.deviceScaleFactor),this._webvrViewMatrix.multiplyAtIndex(14,e.deviceScaleFactor)),this._webvrViewMatrix.invert()),e._correctPositionIfNotTrackPosition(this._webvrViewMatrix,!0),e._worldToDevice.multiplyToRef(this._webvrViewMatrix,this._webvrViewMatrix),this._workingMatrix=this._workingMatrix||fe.Identity(),this._webvrViewMatrix.invertToRef(this._workingMatrix),this._workingMatrix.multiplyToRef(e.getWorldMatrix(),this._workingMatrix),this._workingMatrix.getTranslationToRef(this._globalPosition),this._markSyncedWithParent(),this._webvrViewMatrix}_getWebVRProjectionMatrix(){const e=this.parent;e._vrDevice.depthNear=e.minZ,e._vrDevice.depthFar=e.maxZ;const i=this._cameraRigParams.left?this._cameraRigParams.frameData.leftProjectionMatrix:this._cameraRigParams.frameData.rightProjectionMatrix;return fe.FromArrayToRef(i,0,this._projectionMatrix),this.getScene().useRightHandedSystem||this._projectionMatrix.toggleProjectionMatrixHandInPlace(),this._projectionMatrix}initControllers(){this.controllers.length=0;const e=this.getScene().gamepadManager;this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(i=>{if(i.type===kr.POSE_ENABLED){const s=i;s.defaultModel&&s.defaultModel.setEnabled(!1),s.hand==="right"&&(this._rightController=null),s.hand==="left"&&(this._leftController=null);const n=this.controllers.indexOf(s);n!==-1&&this.controllers.splice(n,1)}}),this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(i=>{if(i.type===kr.POSE_ENABLED){const s=i;if(this._webVROptions.trackPosition||(s._disableTrackPosition(new j(s.hand=="left"?-.15:.15,-.5,.25)),this._updateCacheWhenTrackingDisabledObserver||(this._updateCacheWhenTrackingDisabledObserver=this._scene.onBeforeRenderObservable.add(()=>{this._updateCache()}))),s.deviceScaleFactor=this.deviceScaleFactor,s._deviceToWorld.copyFrom(this._deviceToWorld),this._correctPositionIfNotTrackPosition(s._deviceToWorld),this._webVROptions.controllerMeshes&&(s.defaultModel?s.defaultModel.setEnabled(!0):s.initControllerMesh(this.getScene(),n=>{if(n.scaling.scaleInPlace(this.deviceScaleFactor),this.onControllerMeshLoadedObservable.notifyObservers(s),this._webVROptions.defaultLightingOnControllers){this._lightOnControllers||(this._lightOnControllers=new P0("vrControllersLight",new j(0,1,0),this.getScene()));const a=function(p,_){const g=p.getChildren();g&&g.length!==0&&g.forEach(y=>{_.includedOnlyMeshes.push(y),a(y,_)})};this._lightOnControllers.includedOnlyMeshes.push(n),a(n,this._lightOnControllers)}})),s.attachToPoseControlledCamera(this),this.controllers.indexOf(s)===-1){this.controllers.push(s);let n=!1;for(let a=0;a<this.controllers.length;a++)this.controllers[a].controllerType===Kh.VIVE&&(n?this.controllers[a].hand="right":(n=!0,this.controllers[a].hand="left"));this.controllers.length>=2&&this.onControllersAttachedObservable.notifyObservers(this.controllers)}}})}}class lz extends R2{onButtonStateChange(e){this._onButtonStateChange=e}get defaultModel(){return this._defaultModel}constructor(e){super(e),this.onTriggerStateChangedObservable=new Re,this.onMainButtonStateChangedObservable=new Re,this.onSecondaryButtonStateChangedObservable=new Re,this.onPadStateChangedObservable=new Re,this.onPadValuesChangedObservable=new Re,this.pad={x:0,y:0},this._changes={pressChanged:!1,touchChanged:!1,valueChanged:!1,changed:!1},this._buttons=new Array(e.buttons.length),this.hand=e.hand}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._setButtonValue(this.browserGamepad.buttons[e],this._buttons[e],e);(this.leftStick.x!==this.pad.x||this.leftStick.y!==this.pad.y)&&(this.pad.x=this.leftStick.x,this.pad.y=this.leftStick.y,this.onPadValuesChangedObservable.notifyObservers(this.pad))}_setButtonValue(e,i,s){if(e||(e={pressed:!1,touched:!1,value:0}),!i){this._buttons[s]={pressed:e.pressed,touched:e.touched,value:e.value};return}this._checkChanges(e,i),this._changes.changed&&(this._onButtonStateChange&&this._onButtonStateChange(this.index,s,e),this._handleButtonChange(s,e,this._changes)),this._buttons[s].pressed=e.pressed,this._buttons[s].touched=e.touched,this._buttons[s].value=e.value<1e-8?0:e.value}_checkChanges(e,i){return this._changes.pressChanged=e.pressed!==i.pressed,this._changes.touchChanged=e.touched!==i.touched,this._changes.valueChanged=e.value!==i.value,this._changes.changed=this._changes.pressChanged||this._changes.touchChanged||this._changes.valueChanged,this._changes}dispose(){super.dispose(),this._defaultModel=null,this.onTriggerStateChangedObservable.clear(),this.onMainButtonStateChangedObservable.clear(),this.onSecondaryButtonStateChangedObservable.clear(),this.onPadStateChangedObservable.clear(),this.onPadValuesChangedObservable.clear()}}Yt.prototype.createDynamicTexture=function(l,e,i,s){const n=new Bs(this,or.Dynamic);return n.baseWidth=l,n.baseHeight=e,i&&(l=this.needPOTTextures?Yt.GetExponentOfTwo(l,this._caps.maxTextureSize):l,e=this.needPOTTextures?Yt.GetExponentOfTwo(e,this._caps.maxTextureSize):e),n.width=l,n.height=e,n.isReady=!1,n.generateMipMaps=i,n.samplingMode=s,this.updateTextureSamplingMode(s,n),this._internalTexturesCache.push(n),n},Yt.prototype.updateDynamicTexture=function(l,e,i,s=!1,n,a=!1,p=!1){if(!l)return;const _=this._gl,g=_.TEXTURE_2D,y=this._bindTextureDirectly(g,l,!0,a);this._unpackFlipY(i===void 0?l.invertY:i),s&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);const b=this._getWebGLTextureType(l.type),v=this._getInternalFormat(n||l.format),S=this._getRGBABufferInternalSizedFormat(l.type,v);_.texImage2D(g,0,S,v,b,e),l.generateMipMaps&&_.generateMipmap(g),y||this._bindTextureDirectly(g,null),s&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),l.isReady=!0};class eu extends Oe{constructor(e,i,s=null,n=!1,a=3,p=5,_){super(null,s,!n,_,a,void 0,void 0,void 0,void 0,p),this.name=e,this.wrapU=Oe.CLAMP_ADDRESSMODE,this.wrapV=Oe.CLAMP_ADDRESSMODE,this._generateMipMaps=n;const g=this._getEngine();if(!g)return;i.getContext?(this._canvas=i,this._texture=g.createDynamicTexture(i.width,i.height,n,a)):(this._canvas=g.createCanvas(1,1),i.width||i.width===0?this._texture=g.createDynamicTexture(i.width,i.height,n,a):this._texture=g.createDynamicTexture(i,i,n,a));const y=this.getSize();this._canvas.width!==y.width&&(this._canvas.width=y.width),this._canvas.height!==y.height&&(this._canvas.height=y.height),this._context=this._canvas.getContext("2d")}getClassName(){return"DynamicTexture"}get canRescale(){return!0}_recreate(e){this._canvas.width=e.width,this._canvas.height=e.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(e.width,e.height,this._generateMipMaps,this.samplingMode)}scale(e){const i=this.getSize();i.width*=e,i.height*=e,this._recreate(i)}scaleTo(e,i){const s=this.getSize();s.width=e,s.height=i,this._recreate(s)}getContext(){return this._context}clear(){const e=this.getSize();this._context.fillRect(0,0,e.width,e.height)}update(e,i=!1,s=!1){this._getEngine().updateDynamicTexture(this._texture,this._canvas,e===void 0?!0:e,i,this._format||void 0,void 0,s)}drawText(e,i,s,n,a,p,_,g=!0){const y=this.getSize();if(p&&(this._context.fillStyle=p,this._context.fillRect(0,0,y.width,y.height)),this._context.font=n,i==null){const b=this._context.measureText(e);i=(y.width-b.width)/2}if(s==null){const b=parseInt(n.replace(/\D/g,""));s=y.height/2+b/3.65}this._context.fillStyle=a||"",this._context.fillText(e,i,s),g&&this.update(_)}clone(){const e=this.getScene();if(!e)return this;const i=this.getSize(),s=new eu(this.name,i,e,this._generateMipMaps);return s.hasAlpha=this.hasAlpha,s.level=this.level,s.wrapU=this.wrapU,s.wrapV=this.wrapV,s}serialize(){const e=this.getScene();e&&!e.isReady()&&Ie.Warn("The scene must be ready before serializing the dynamic texture");const i=super.serialize();return eu._IsCanvasElement(this._canvas)&&(i.base64String=this._canvas.toDataURL()),i.invertY=this._invertY,i.samplingMode=this.samplingMode,i}static _IsCanvasElement(e){return e.toDataURL!==void 0}_rebuild(){this.update()}}const KI="imageProcessingPixelShader",jI=`varying vec2 vUV;
uniform sampler2D textureSampler;
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec4 result=texture2D(textureSampler,vUV);
#ifdef IMAGEPROCESSING
#ifndef FROMLINEARSPACE
result.rgb=toLinearSpace(result.rgb);
#endif
result=applyImageProcessing(result);
#else
#ifdef FROMLINEARSPACE
result=applyImageProcessing(result);
#endif
#endif
gl_FragColor=result;
}`;Ye.ShadersStore[KI]=jI;const Wq={name:KI,shader:jI};class qI extends lr{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){e.applyByPostProcess=!0,this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e,i=!1){if(e!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e)this._imageProcessingConfiguration=e;else{let s=null;const n=this.getEngine(),a=this.getCamera();if(a)s=a.getScene();else if(n&&n.scenes){const p=n.scenes;s=p[p.length-1]}else s=Zt.LastCreatedScene;s?this._imageProcessingConfiguration=s.imageProcessingConfiguration:this._imageProcessingConfiguration=new Oi}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateParameters()})),i||this._updateParameters()}}get isSupported(){const e=this.getEffect();return!e||e.isSupported}get colorCurves(){return this.imageProcessingConfiguration.colorCurves}set colorCurves(e){this.imageProcessingConfiguration.colorCurves=e}get colorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set colorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get colorGradingTexture(){return this.imageProcessingConfiguration.colorGradingTexture}set colorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get colorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set colorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get exposure(){return this.imageProcessingConfiguration.exposure}set exposure(e){this.imageProcessingConfiguration.exposure=e}get toneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set toneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get toneMappingType(){return this._imageProcessingConfiguration.toneMappingType}set toneMappingType(e){this._imageProcessingConfiguration.toneMappingType=e}get contrast(){return this.imageProcessingConfiguration.contrast}set contrast(e){this.imageProcessingConfiguration.contrast=e}get vignetteStretch(){return this.imageProcessingConfiguration.vignetteStretch}set vignetteStretch(e){this.imageProcessingConfiguration.vignetteStretch=e}get vignetteCentreX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCentreX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteCentreY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCentreY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCenterY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCenterX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteWeight(){return this.imageProcessingConfiguration.vignetteWeight}set vignetteWeight(e){this.imageProcessingConfiguration.vignetteWeight=e}get vignetteColor(){return this.imageProcessingConfiguration.vignetteColor}set vignetteColor(e){this.imageProcessingConfiguration.vignetteColor=e}get vignetteCameraFov(){return this.imageProcessingConfiguration.vignetteCameraFov}set vignetteCameraFov(e){this.imageProcessingConfiguration.vignetteCameraFov=e}get vignetteBlendMode(){return this.imageProcessingConfiguration.vignetteBlendMode}set vignetteBlendMode(e){this.imageProcessingConfiguration.vignetteBlendMode=e}get vignetteEnabled(){return this.imageProcessingConfiguration.vignetteEnabled}set vignetteEnabled(e){this.imageProcessingConfiguration.vignetteEnabled=e}get ditheringIntensity(){return this.imageProcessingConfiguration.ditheringIntensity}set ditheringIntensity(e){this.imageProcessingConfiguration.ditheringIntensity=e}get ditheringEnabled(){return this.imageProcessingConfiguration.ditheringEnabled}set ditheringEnabled(e){this.imageProcessingConfiguration.ditheringEnabled=e}get fromLinearSpace(){return this._fromLinearSpace}set fromLinearSpace(e){this._fromLinearSpace!==e&&(this._fromLinearSpace=e,this._updateParameters())}constructor(e,i,s=null,n,a,p,_=0,g){super(e,"imageProcessing",[],[],i,s,n,a,p,null,_,"postprocess",null,!0),this._fromLinearSpace=!0,this._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:!1,TONEMAPPING_ACES:!1,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,DITHER:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1,SKIPFINALCOLORCLAMP:!1},g?(g.applyByPostProcess=!0,this._attachImageProcessingConfiguration(g,!0),this._updateParameters()):(this._attachImageProcessingConfiguration(null,!0),this.imageProcessingConfiguration.applyByPostProcess=!0),this.onApply=y=>{this.imageProcessingConfiguration.bind(y,this.aspectRatio)}}getClassName(){return"ImageProcessingPostProcess"}_updateParameters(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);let e="";for(const n in this._defines)this._defines[n]&&(e+=`#define ${n};\r
`);const i=["textureSampler"],s=["scale"];Oi&&(Oi.PrepareSamplers(i,this._defines),Oi.PrepareUniforms(s,this._defines)),this.updateEffect(e,s,i)}dispose(e){super.dispose(e),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)}}J([xe()],qI.prototype,"_fromLinearSpace",void 0);const cz=Object.freeze(new Ve(0,0,0,0)),hz=Object.freeze(j.Zero()),uz=Object.freeze(ii.Zero()),dz=Object.freeze(Aa.Zero()),fz=Object.freeze(qe.Black());class pz{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(e,i,s,n){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._ratioOffset=0,this._previousDelay=0,this._previousRatio=0,this._targetIsArray=!1,this._animation=i,this._target=e,this._scene=s,this._host=n,this._activeTargets=[],i._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===Ce.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=fe.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,this._minFrame!==0){const p={frame:0,value:this._minValue};this._keys.splice(0,0,p)}if(this._target instanceof Array){let p=0;for(const _ of this._target)this._preparePath(_,p),this._getOriginalValues(p),p++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];const a=i.getEvents();a&&a.length>0&&a.forEach(p=>{this._events.push(p._clone())}),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(e,i=0){const s=this._animation.targetPropertyPath;if(s.length>1){let n=e[s[0]];for(let a=1;a<s.length-1;a++)n=n[s[a]];this._targetPath=s[s.length-1],this._activeTargets[i]=n}else this._targetPath=s[0],this._activeTargets[i]=e}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let i=0;for(const s of this._target)this._originalValue[i]!==void 0&&this._setValue(s,this._activeTargets[i],this._originalValue[i],-1,i),i++}else this._originalValue[0]!==void 0&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let i=0;i<this._events.length;i++)this._events[i].isDone=!1}isStopped(){return this._stopped}dispose(){const e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,i){if(this._targetIsArray){for(let s=0;s<this._target.length;s++){const n=this._target[s];this._setValue(n,this._activeTargets[s],e,i,s)}return}this._setValue(this._target,this._directTarget,e,i,0)}_getOriginalValues(e=0){let i;const s=this._activeTargets[e];s.getRestPose&&this._targetPath==="_matrix"?i=s.getRestPose():i=s[this._targetPath],i&&i.clone?this._originalValue[e]=i.clone():this._originalValue[e]=i}_setValue(e,i,s,n,a){if(this._currentActiveTarget=i,this._weight=n,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){const _=i[this._targetPath];_.clone?this._originalBlendValue=_.clone():this._originalBlendValue=_}this._originalBlendValue.m?Ce.AllowMatrixDecomposeForInterpolation?this._currentValue?fe.DecomposeLerpToRef(this._originalBlendValue,s,this._blendingFactor,this._currentValue):this._currentValue=fe.DecomposeLerp(this._originalBlendValue,s,this._blendingFactor):this._currentValue?fe.LerpToRef(this._originalBlendValue,s,this._blendingFactor,this._currentValue):this._currentValue=fe.Lerp(this._originalBlendValue,s,this._blendingFactor):this._currentValue=Ce._UniversalLerp(this._originalBlendValue,s,this._blendingFactor);const p=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=p}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(s):this._currentValue=s:s?.clone?this._currentValue=s.clone():this._currentValue=s;n!==-1?this._scene._registerTargetForLateAnimationBinding(this,this._originalValue[a]):i[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e){const i=this._animation.getKeys();e<i[0].frame?e=i[0].frame:e>i[i.length-1].frame&&(e=i[i.length-1].frame);const s=this._events;if(s.length)for(let a=0;a<s.length;a++)s[a].onlyOnce||(s[a].isDone=s[a].frame<e);this._currentFrame=e;const n=this._animation._interpolate(e,this._animationState);this.setValue(n,-1)}_prepareForSpeedRatioChange(e){const i=this._previousDelay*(this._animation.framePerSecond*e)/1e3;this._ratioOffset=this._previousRatio-i}animate(e,i,s,n,a,p=-1){const _=this._animation,g=_.targetPropertyPath;if(!g||g.length<1)return this._stopped=!0,!1;let y=!0;(i<this._minFrame||i>this._maxFrame)&&(i=this._minFrame),(s<this._minFrame||s>this._maxFrame)&&(s=this._maxFrame);const b=s-i;let v;const S=e*(_.framePerSecond*a)/1e3+this._ratioOffset;let M=0;if(this._previousDelay=e,this._previousRatio=S,!n&&s>=i&&S>=b)y=!1,M=_._getKeyValue(this._maxValue);else if(!n&&i>=s&&S<=b)y=!1,M=_._getKeyValue(this._minValue);else if(this._animationState.loopMode!==Ce.ANIMATIONLOOPMODE_CYCLE){const k=s.toString()+i.toString();if(!this._offsetsCache[k]){this._animationState.repeatCount=0,this._animationState.loopMode=Ce.ANIMATIONLOOPMODE_CYCLE;const G=_._interpolate(i,this._animationState),H=_._interpolate(s,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),_.dataType){case Ce.ANIMATIONTYPE_FLOAT:this._offsetsCache[k]=H-G;break;case Ce.ANIMATIONTYPE_QUATERNION:this._offsetsCache[k]=H.subtract(G);break;case Ce.ANIMATIONTYPE_VECTOR3:this._offsetsCache[k]=H.subtract(G);break;case Ce.ANIMATIONTYPE_VECTOR2:this._offsetsCache[k]=H.subtract(G);break;case Ce.ANIMATIONTYPE_SIZE:this._offsetsCache[k]=H.subtract(G);break;case Ce.ANIMATIONTYPE_COLOR3:this._offsetsCache[k]=H.subtract(G);break;default:break}this._highLimitsCache[k]=H}M=this._highLimitsCache[k],v=this._offsetsCache[k]}if(v===void 0)switch(_.dataType){case Ce.ANIMATIONTYPE_FLOAT:v=0;break;case Ce.ANIMATIONTYPE_QUATERNION:v=cz;break;case Ce.ANIMATIONTYPE_VECTOR3:v=hz;break;case Ce.ANIMATIONTYPE_VECTOR2:v=uz;break;case Ce.ANIMATIONTYPE_SIZE:v=dz;break;case Ce.ANIMATIONTYPE_COLOR3:v=fz}let F;if(this._host&&this._host.syncRoot){const k=this._host.syncRoot,G=(k.masterFrame-k.fromFrame)/(k.toFrame-k.fromFrame);F=i+(s-i)*G}else S>0&&i>s||S<0&&i<s?F=y&&b!==0?s+S%b:i:F=y&&b!==0?i+S%b:s;const L=this._events;if(a>0&&this.currentFrame>F||a<0&&this.currentFrame<F){this._onLoop();for(let k=0;k<L.length;k++)L[k].onlyOnce||(L[k].isDone=!1);this._animationState.key=a>0?0:_.getKeys().length-1}this._currentFrame=F,this._animationState.repeatCount=b===0?0:S/b>>0,this._animationState.highLimitValue=M,this._animationState.offsetValue=v;const N=_._interpolate(F,this._animationState);if(this.setValue(N,p),L.length){for(let k=0;k<L.length;k++)if(b>0&&F>=L[k].frame&&L[k].frame>=i||b<0&&F<=L[k].frame&&L[k].frame<=i){const G=L[k];G.isDone||(G.onlyOnce&&(L.splice(k,1),k--),G.isDone=!0,G.action(F))}}return y||(this._stopped=!0),y}}class $i extends vr{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){this._needToCompose=!1,e.updateFlag!==this._localMatrix.updateFlag&&(this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}constructor(e,i,s=null,n=null,a=null,p=null,_=null){super(e,i.getScene()),this.name=e,this.children=new Array,this.animations=new Array,this._index=null,this._absoluteTransform=new fe,this._invertedAbsoluteTransform=new fe,this._scalingDeterminant=1,this._worldTransform=new fe,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=i,this._localMatrix=n?n.clone():fe.Identity(),this._restPose=a||this._localMatrix.clone(),this._baseMatrix=p||this._localMatrix.clone(),this._index=_,i.bones.push(this),this.setParent(s,!1),(p||n)&&this._updateDifferenceMatrix()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,i=!0){if(this.parent!==e){if(this.parent){const s=this.parent.children.indexOf(this);s!==-1&&this.parent.children.splice(s,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),i&&this._updateDifferenceMatrix(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBaseMatrix(){return this._baseMatrix}getRestPose(){return this._restPose}setRestPose(e){this._restPose.copyFrom(e)}getBindPose(){return this._baseMatrix}setBindPose(e){this.updateMatrix(e)}getWorldMatrix(){return this._worldTransform}returnToRest(){var e;if(this._linkedTransformNode){const i=ge.Vector3[0],s=ge.Quaternion[0],n=ge.Vector3[1];this.getRestPose().decompose(i,s,n),this._linkedTransformNode.position.copyFrom(n),this._linkedTransformNode.rotationQuaternion=(e=this._linkedTransformNode.rotationQuaternion)!==null&&e!==void 0?e:Ve.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(s),this._linkedTransformNode.scaling.copyFrom(i)}else this._matrix=this._restPose}getInvertedAbsoluteTransform(){return this._invertedAbsoluteTransform}getAbsoluteTransform(){return this._absoluteTransform}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){!this._needToDecompose||(this._needToDecompose=!1,this._localScaling||(this._localScaling=j.Zero(),this._localRotation=Ve.Zero(),this._localPosition=j.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){if(!!this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,fe.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}}updateMatrix(e,i=!0,s=!0){this._baseMatrix.copyFrom(e),i&&this._updateDifferenceMatrix(),s?this._matrix=e:this.markAsDirty()}_updateDifferenceMatrix(e,i=!0){if(e||(e=this._baseMatrix),this.parent?e.multiplyToRef(this.parent._absoluteTransform,this._absoluteTransform):this._absoluteTransform.copyFrom(e),this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform),i)for(let s=0;s<this.children.length;s++)this.children[s]._updateDifferenceMatrix();this._scalingDeterminant=this._absoluteTransform.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}translate(e,i=Ki.LOCAL,s){const n=this.getLocalMatrix();if(i==Ki.LOCAL)n.addAtIndex(12,e.x),n.addAtIndex(13,e.y),n.addAtIndex(14,e.z);else{let a=null;s&&(a=s.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const p=$i._TmpMats[0],_=$i._TmpVecs[0];this.parent?s&&a?(p.copyFrom(this.parent.getAbsoluteTransform()),p.multiplyToRef(a,p)):p.copyFrom(this.parent.getAbsoluteTransform()):fe.IdentityToRef(p),p.setTranslationFromFloats(0,0,0),p.invert(),j.TransformCoordinatesToRef(e,p,_),n.addAtIndex(12,_.x),n.addAtIndex(13,_.y),n.addAtIndex(14,_.z)}this._markAsDirtyAndDecompose()}setPosition(e,i=Ki.LOCAL,s){const n=this.getLocalMatrix();if(i==Ki.LOCAL)n.setTranslationFromFloats(e.x,e.y,e.z);else{let a=null;s&&(a=s.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const p=$i._TmpMats[0],_=$i._TmpVecs[0];this.parent?(s&&a?(p.copyFrom(this.parent.getAbsoluteTransform()),p.multiplyToRef(a,p)):p.copyFrom(this.parent.getAbsoluteTransform()),p.invert()):fe.IdentityToRef(p),j.TransformCoordinatesToRef(e,p,_),n.setTranslationFromFloats(_.x,_.y,_.z)}this._markAsDirtyAndDecompose()}setAbsolutePosition(e,i){this.setPosition(e,Ki.WORLD,i)}scale(e,i,s,n=!1){const a=this.getLocalMatrix(),p=$i._TmpMats[0];fe.ScalingToRef(e,i,s,p),p.multiplyToRef(a,a),p.invert();for(const _ of this.children){const g=_.getLocalMatrix();g.multiplyToRef(p,g),g.multiplyAtIndex(12,e),g.multiplyAtIndex(13,i),g.multiplyAtIndex(14,s),_._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),n)for(const _ of this.children)_.scale(e,i,s,n)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,i,s,n=Ki.LOCAL,a){if(n===Ki.LOCAL){const g=$i._TmpQuat;Ve.RotationYawPitchRollToRef(e,i,s,g),this.setRotationQuaternion(g,n,a);return}const p=$i._TmpMats[0];if(!this._getNegativeRotationToRef(p,a))return;const _=$i._TmpMats[1];fe.RotationYawPitchRollToRef(e,i,s,_),p.multiplyToRef(_,_),this._rotateWithMatrix(_,n,a)}rotate(e,i,s=Ki.LOCAL,n){const a=$i._TmpMats[0];a.setTranslationFromFloats(0,0,0),fe.RotationAxisToRef(e,i,a),this._rotateWithMatrix(a,s,n)}setAxisAngle(e,i,s=Ki.LOCAL,n){if(s===Ki.LOCAL){const _=$i._TmpQuat;Ve.RotationAxisToRef(e,i,_),this.setRotationQuaternion(_,s,n);return}const a=$i._TmpMats[0];if(!this._getNegativeRotationToRef(a,n))return;const p=$i._TmpMats[1];fe.RotationAxisToRef(e,i,p),a.multiplyToRef(p,p),this._rotateWithMatrix(p,s,n)}setRotation(e,i=Ki.LOCAL,s){this.setYawPitchRoll(e.y,e.x,e.z,i,s)}setRotationQuaternion(e,i=Ki.LOCAL,s){if(i===Ki.LOCAL){this._decompose(),this._localRotation.copyFrom(e),this._markAsDirtyAndCompose();return}const n=$i._TmpMats[0];if(!this._getNegativeRotationToRef(n,s))return;const a=$i._TmpMats[1];fe.FromQuaternionToRef(e,a),n.multiplyToRef(a,a),this._rotateWithMatrix(a,i,s)}setRotationMatrix(e,i=Ki.LOCAL,s){if(i===Ki.LOCAL){const p=$i._TmpQuat;Ve.FromRotationMatrixToRef(e,p),this.setRotationQuaternion(p,i,s);return}const n=$i._TmpMats[0];if(!this._getNegativeRotationToRef(n,s))return;const a=$i._TmpMats[1];a.copyFrom(e),n.multiplyToRef(e,a),this._rotateWithMatrix(a,i,s)}_rotateWithMatrix(e,i=Ki.LOCAL,s){const n=this.getLocalMatrix(),a=n.m[12],p=n.m[13],_=n.m[14],g=this.getParent(),y=$i._TmpMats[3],b=$i._TmpMats[4];g&&i==Ki.WORLD?(s?(y.copyFrom(s.getWorldMatrix()),g.getAbsoluteTransform().multiplyToRef(y,y)):y.copyFrom(g.getAbsoluteTransform()),b.copyFrom(y),b.invert(),n.multiplyToRef(y,n),n.multiplyToRef(e,n),n.multiplyToRef(b,n)):i==Ki.WORLD&&s?(y.copyFrom(s.getWorldMatrix()),b.copyFrom(y),b.invert(),n.multiplyToRef(y,n),n.multiplyToRef(e,n),n.multiplyToRef(b,n)):n.multiplyToRef(e,n),n.setTranslationFromFloats(a,p,_),this.computeAbsoluteTransforms(),this._markAsDirtyAndDecompose()}_getNegativeRotationToRef(e,i){const s=$i._TmpMats[2];return e.copyFrom(this.getAbsoluteTransform()),i?(e.multiplyToRef(i.getWorldMatrix(),e),fe.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,s)):fe.IdentityToRef(s),e.invert(),isNaN(e.m[0])?!1:(s.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(s,e),!0)}getPosition(e=Ki.LOCAL,i=null){const s=j.Zero();return this.getPositionToRef(e,i,s),s}getPositionToRef(e=Ki.LOCAL,i,s){if(e==Ki.LOCAL){const n=this.getLocalMatrix();s.x=n.m[12],s.y=n.m[13],s.z=n.m[14]}else{let n=null;i&&(n=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();let a=$i._TmpMats[0];i&&n?(a.copyFrom(this.getAbsoluteTransform()),a.multiplyToRef(n,a)):a=this.getAbsoluteTransform(),s.x=a.m[12],s.y=a.m[13],s.z=a.m[14]}}getAbsolutePosition(e=null){const i=j.Zero();return this.getPositionToRef(Ki.WORLD,e,i),i}getAbsolutePositionToRef(e,i){this.getPositionToRef(Ki.WORLD,e,i)}computeAbsoluteTransforms(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteTransform,this._absoluteTransform);else{this._absoluteTransform.copyFrom(this._localMatrix);const s=this._skeleton.getPoseMatrix();s&&this._absoluteTransform.multiplyToRef(s,this._absoluteTransform)}const e=this.children,i=e.length;for(let s=0;s<i;s++)e[s].computeAbsoluteTransforms()}getDirection(e,i=null){const s=j.Zero();return this.getDirectionToRef(e,i,s),s}getDirectionToRef(e,i=null,s){let n=null;i&&(n=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const a=$i._TmpMats[0];a.copyFrom(this.getAbsoluteTransform()),i&&n&&a.multiplyToRef(n,a),j.TransformNormalToRef(e,a,s),s.normalize()}getRotation(e=Ki.LOCAL,i=null){const s=j.Zero();return this.getRotationToRef(e,i,s),s}getRotationToRef(e=Ki.LOCAL,i=null,s){const n=$i._TmpQuat;this.getRotationQuaternionToRef(e,i,n),n.toEulerAnglesToRef(s)}getRotationQuaternion(e=Ki.LOCAL,i=null){const s=Ve.Identity();return this.getRotationQuaternionToRef(e,i,s),s}getRotationQuaternionToRef(e=Ki.LOCAL,i=null,s){if(e==Ki.LOCAL)this._decompose(),s.copyFrom(this._localRotation);else{const n=$i._TmpMats[0],a=this.getAbsoluteTransform();i?a.multiplyToRef(i.getWorldMatrix(),n):n.copyFrom(a),n.multiplyAtIndex(0,this._scalingDeterminant),n.multiplyAtIndex(1,this._scalingDeterminant),n.multiplyAtIndex(2,this._scalingDeterminant),n.decompose(void 0,s,void 0)}}getRotationMatrix(e=Ki.LOCAL,i){const s=fe.Identity();return this.getRotationMatrixToRef(e,i,s),s}getRotationMatrixToRef(e=Ki.LOCAL,i,s){if(e==Ki.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(s);else{const n=$i._TmpMats[0],a=this.getAbsoluteTransform();i?a.multiplyToRef(i.getWorldMatrix(),n):n.copyFrom(a),n.multiplyAtIndex(0,this._scalingDeterminant),n.multiplyAtIndex(1,this._scalingDeterminant),n.multiplyAtIndex(2,this._scalingDeterminant),n.getRotationMatrixToRef(s)}}getAbsolutePositionFromLocal(e,i=null){const s=j.Zero();return this.getAbsolutePositionFromLocalToRef(e,i,s),s}getAbsolutePositionFromLocalToRef(e,i=null,s){let n=null;i&&(n=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();let a=$i._TmpMats[0];i&&n?(a.copyFrom(this.getAbsoluteTransform()),a.multiplyToRef(n,a)):a=this.getAbsoluteTransform(),j.TransformCoordinatesToRef(e,a,s)}getLocalPositionFromAbsolute(e,i=null){const s=j.Zero();return this.getLocalPositionFromAbsoluteToRef(e,i,s),s}getLocalPositionFromAbsoluteToRef(e,i=null,s){let n=null;i&&(n=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const a=$i._TmpMats[0];a.copyFrom(this.getAbsoluteTransform()),i&&n&&a.multiplyToRef(n,a),a.invert(),j.TransformCoordinatesToRef(e,a,s)}setCurrentPoseAsRest(){this.setRestPose(this.getLocalMatrix())}}$i._TmpVecs=As.BuildArray(2,j.Zero),$i._TmpQuat=Ve.Identity(),$i._TmpMats=As.BuildArray(5,fe.Identity);class ZI{get syncRoot(){return this._syncRoot}get masterFrame(){return this._runtimeAnimations.length===0?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){if(e===-1){this._weight=-1;return}this._weight=Math.min(Math.max(e,0),1)}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let i=0;i<this._runtimeAnimations.length;i++)this._runtimeAnimations[i]._prepareForSpeedRatioChange(e);this._speedRatio=e,this._goToFrame!==null&&this.goToFrame(this._goToFrame)}constructor(e,i,s=0,n=100,a=!1,p=1,_,g,y,b=!1){this.target=i,this.fromFrame=s,this.toFrame=n,this.loopAnimation=a,this.onAnimationEnd=_,this.onAnimationLoop=y,this.isAdditive=b,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new Re,this.onAnimationLoopObservable=new Re,this._scene=e,g&&this.appendAnimations(i,g),this._speedRatio=p,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){const i=this._scene._activeAnimatables.indexOf(this);i>-1&&(this._scene._activeAnimatables.splice(i,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,i){for(let s=0;s<i.length;s++){const n=i[s],a=new pz(e,n,this._scene,this);a._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(a)}}getAnimationByTargetProperty(e){const i=this._runtimeAnimations;for(let s=0;s<i.length;s++)if(i[s].animation.targetProperty===e)return i[s].animation;return null}getRuntimeAnimationByTargetProperty(e){const i=this._runtimeAnimations;for(let s=0;s<i.length;s++)if(i[s].animation.targetProperty===e)return i[s];return null}reset(){const e=this._runtimeAnimations;for(let i=0;i<e.length;i++)e[i].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){const i=this._runtimeAnimations;for(let s=0;s<i.length;s++)i[s].animation.enableBlending=!0,i[s].animation.blendingSpeed=e}disableBlending(){const e=this._runtimeAnimations;for(let i=0;i<e.length;i++)e[i].animation.enableBlending=!1}goToFrame(e){var i;const s=this._runtimeAnimations;if(s[0]){const n=s[0].animation.framePerSecond;this._frameToSyncFromJump=(i=this._frameToSyncFromJump)!==null&&i!==void 0?i:s[0].currentFrame;const a=this.speedRatio===0?0:(e-this._frameToSyncFromJump)/n*1e3/this.speedRatio;this._manualJumpDelay=-a}for(let n=0;n<s.length;n++)s[n].goToFrame(e);this._goToFrame=e}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,i,s=!1){if(e||i){const n=this._scene._activeAnimatables.indexOf(this);if(n>-1){const a=this._runtimeAnimations;for(let p=a.length-1;p>=0;p--){const _=a[p];e&&_.animation.name!=e||i&&!i(_.target)||(_.dispose(),a.splice(p,1))}a.length==0&&(s||this._scene._activeAnimatables.splice(n,1),this._raiseOnAnimationEnd())}}else{const n=this._scene._activeAnimatables.indexOf(this);n>-1&&(s||this._scene._activeAnimatables.splice(n,1),this._runtimeAnimations.length=0,this._raiseOnAnimationEnd())}}waitAsync(){return new Promise(e=>{this.onAnimationEndObservable.add(()=>{e(this)},void 0,void 0,this,!0)})}_animate(e){if(this._paused)return this.animationStarted=!1,this._pausedDelay===null&&(this._pausedDelay=e),!0;if(this._localDelayOffset===null?(this._localDelayOffset=e,this._pausedDelay=null):this._pausedDelay!==null&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),this._manualJumpDelay!==null&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,this._weight===0)return!0;let i=!1;const s=this._runtimeAnimations;let n;for(n=0;n<s.length;n++){const p=s[n].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);i=i||p}if(this.animationStarted=i,!i){if(this.disposeOnEnd)for(n=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(n,1),n=0;n<s.length;n++)s[n].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return i}}Nt.prototype._animate=function(){if(!this.animationsEnabled)return;const l=na.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=l}this.deltaTime=this.useConstantAnimationDeltaTime?16:(l-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=l;const e=this._activeAnimatables;if(e.length===0)return;this._animationTime+=this.deltaTime;const i=this._animationTime;for(let s=0;s<e.length;s++){const n=e[s];!n._animate(i)&&n.disposeOnEnd&&s--}this._processLateAnimationBindings()},Nt.prototype.beginWeightedAnimation=function(l,e,i,s=1,n,a=1,p,_,g,y,b=!1){const v=this.beginAnimation(l,e,i,n,a,p,_,!1,g,y,b);return v.weight=s,v},Nt.prototype.beginAnimation=function(l,e,i,s,n=1,a,p,_=!0,g,y,b=!1){e>i&&n>0&&(n*=-1),_&&this.stopAnimation(l,void 0,g),p||(p=new ZI(this,l,e,i,s,n,a,void 0,y,b));const v=g?g(l):!0;if(l.animations&&v&&p.appendAnimations(l,l.animations),l.getAnimatables){const S=l.getAnimatables();for(let M=0;M<S.length;M++)this.beginAnimation(S[M],e,i,s,n,a,p,_,g,y)}return p.reset(),p},Nt.prototype.beginHierarchyAnimation=function(l,e,i,s,n,a=1,p,_,g=!0,y,b,v=!1){const S=l.getDescendants(e),M=[];M.push(this.beginAnimation(l,i,s,n,a,p,_,g,y,void 0,v));for(const F of S)M.push(this.beginAnimation(F,i,s,n,a,p,_,g,y,void 0,v));return M},Nt.prototype.beginDirectAnimation=function(l,e,i,s,n,a,p,_,g=!1){if(a===void 0&&(a=1),i>s&&a>0)a*=-1;else if(s>i&&a<0){const b=s;s=i,i=b}return new ZI(this,l,i,s,n,a,p,e,_,g)},Nt.prototype.beginDirectHierarchyAnimation=function(l,e,i,s,n,a,p,_,g,y=!1){const b=l.getDescendants(e),v=[];v.push(this.beginDirectAnimation(l,i,s,n,a,p,_,g,y));for(const S of b)v.push(this.beginDirectAnimation(S,i,s,n,a,p,_,g,y));return v},Nt.prototype.getAnimatableByTarget=function(l){for(let e=0;e<this._activeAnimatables.length;e++)if(this._activeAnimatables[e].target===l)return this._activeAnimatables[e];return null},Nt.prototype.getAllAnimatablesByTarget=function(l){const e=[];for(let i=0;i<this._activeAnimatables.length;i++)this._activeAnimatables[i].target===l&&e.push(this._activeAnimatables[i]);return e},Nt.prototype.stopAnimation=function(l,e,i){const s=this.getAllAnimatablesByTarget(l);for(const n of s)n.stop(e,i)},Nt.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let l=0;l<this._activeAnimatables.length;l++)this._activeAnimatables[l].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(const l of this.animationGroups)l.stop()},Nt.prototype._registerTargetForLateAnimationBinding=function(l,e){const i=l.target;this._registeredForLateAnimationBindings.pushNoDuplicate(i),i._lateAnimationHolders||(i._lateAnimationHolders={}),i._lateAnimationHolders[l.targetPath]||(i._lateAnimationHolders[l.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:e}),l.isAdditive?(i._lateAnimationHolders[l.targetPath].additiveAnimations.push(l),i._lateAnimationHolders[l.targetPath].totalAdditiveWeight+=l.weight):(i._lateAnimationHolders[l.targetPath].animations.push(l),i._lateAnimationHolders[l.targetPath].totalWeight+=l.weight)},Nt.prototype._processLateAnimationBindingsForMatrices=function(l){if(l.totalWeight===0&&l.totalAdditiveWeight===0)return l.originalValue;let e=1;const i=ge.Vector3[0],s=ge.Vector3[1],n=ge.Quaternion[0];let a=0;const p=l.animations[0],_=l.originalValue;let g=1,y=!1;if(l.totalWeight<1)g=1-l.totalWeight,_.decompose(s,n,i);else{if(a=1,e=l.totalWeight,g=p.weight/e,g==1)if(l.totalAdditiveWeight)y=!0;else return p.currentValue;p.currentValue.decompose(s,n,i)}if(!y){s.scaleInPlace(g),i.scaleInPlace(g),n.scaleInPlace(g);for(let v=a;v<l.animations.length;v++){const S=l.animations[v];if(S.weight===0)continue;g=S.weight/e;const M=ge.Vector3[2],F=ge.Vector3[3],L=ge.Quaternion[1];S.currentValue.decompose(F,L,M),F.scaleAndAddToRef(g,s),L.scaleAndAddToRef(Ve.Dot(n,L)>0?g:-g,n),M.scaleAndAddToRef(g,i)}n.normalize()}for(let v=0;v<l.additiveAnimations.length;v++){const S=l.additiveAnimations[v];if(S.weight===0)continue;const M=ge.Vector3[2],F=ge.Vector3[3],L=ge.Quaternion[1];S.currentValue.decompose(F,L,M),F.multiplyToRef(s,F),j.LerpToRef(s,F,S.weight,s),n.multiplyToRef(L,L),Ve.SlerpToRef(n,L,S.weight,n),M.scaleAndAddToRef(S.weight,i)}const b=p?p._animationState.workValue:ge.Matrix[0].clone();return fe.ComposeToRef(s,n,i,b),b},Nt.prototype._processLateAnimationBindingsForQuaternions=function(l,e){if(l.totalWeight===0&&l.totalAdditiveWeight===0)return e;const i=l.animations[0],s=l.originalValue;let n=e;if(l.totalWeight===0&&l.totalAdditiveWeight>0)n.copyFrom(s);else if(l.animations.length===1){if(Ve.SlerpToRef(s,i.currentValue,Math.min(1,l.totalWeight),n),l.totalAdditiveWeight===0)return n}else if(l.animations.length>1){let a=1,p,_;if(l.totalWeight<1){const y=1-l.totalWeight;p=[],_=[],p.push(s),_.push(y)}else{if(l.animations.length===2&&(Ve.SlerpToRef(l.animations[0].currentValue,l.animations[1].currentValue,l.animations[1].weight/l.totalWeight,e),l.totalAdditiveWeight===0))return e;p=[],_=[],a=l.totalWeight}for(let y=0;y<l.animations.length;y++){const b=l.animations[y];p.push(b.currentValue),_.push(b.weight/a)}let g=0;for(let y=0;y<p.length;){if(!y){Ve.SlerpToRef(p[y],p[y+1],_[y+1]/(_[y]+_[y+1]),e),n=e,g=_[y]+_[y+1],y+=2;continue}g+=_[y],Ve.SlerpToRef(n,p[y],_[y]/g,n),y++}}for(let a=0;a<l.additiveAnimations.length;a++){const p=l.additiveAnimations[a];p.weight!==0&&(n.multiplyToRef(p.currentValue,ge.Quaternion[0]),Ve.SlerpToRef(n,ge.Quaternion[0],p.weight,n))}return n},Nt.prototype._processLateAnimationBindings=function(){if(!!this._registeredForLateAnimationBindings.length){for(let l=0;l<this._registeredForLateAnimationBindings.length;l++){const e=this._registeredForLateAnimationBindings.data[l];for(const i in e._lateAnimationHolders){const s=e._lateAnimationHolders[i],n=s.animations[0],a=s.originalValue;if(a==null)continue;const p=Ce.AllowMatrixDecomposeForInterpolation&&a.m;let _=e[i];if(p)_=this._processLateAnimationBindingsForMatrices(s);else if(a.w!==void 0)_=this._processLateAnimationBindingsForQuaternions(s,_||Ve.Identity());else{let y=0,b=1;if(s.totalWeight<1)n&&a.scale?_=a.scale(1-s.totalWeight):n?_=a*(1-s.totalWeight):a.clone?_=a.clone():_=a;else if(n){b=s.totalWeight;const v=n.weight/b;v!==1?n.currentValue.scale?_=n.currentValue.scale(v):_=n.currentValue*v:_=n.currentValue,y=1}for(let v=y;v<s.animations.length;v++){const S=s.animations[v],M=S.weight/b;if(M)S.currentValue.scaleAndAddToRef?S.currentValue.scaleAndAddToRef(M,_):_+=S.currentValue*M;else continue}for(let v=0;v<s.additiveAnimations.length;v++){const S=s.additiveAnimations[v],M=S.weight;if(M)S.currentValue.scaleAndAddToRef?S.currentValue.scaleAndAddToRef(M,_):_+=S.currentValue*M;else continue}}e[i]=_}e._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}},$i.prototype.copyAnimationRange=function(l,e,i,s=!1,n=null){this.animations.length===0&&(this.animations.push(new Ce(this.name,"_matrix",l.animations[0].framePerSecond,Ce.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const a=l.animations[0].getRange(e);if(!a)return!1;const p=a.from,_=a.to,g=l.animations[0].getKeys(),y=l.length,b=l.getParent(),v=this.getParent(),S=s&&b&&y&&this.length&&y!==this.length,M=S&&v&&b?v.length/b.length:1,F=s&&!v&&n&&(n.x!==1||n.y!==1||n.z!==1),L=this.animations[0].getKeys();let N,k,G;for(let H=0,z=g.length;H<z;H++)N=g[H],N.frame>=p&&N.frame<=_&&(s?(G=N.value.clone(),S?(k=G.getTranslation(),G.setTranslation(k.scaleInPlace(M))):F&&n?(k=G.getTranslation(),G.setTranslation(k.multiplyInPlace(n))):G=N.value):G=N.value,L.push({frame:N.frame+i,value:G}));return this.animations[0].createRange(e,p+i,_+i),!0};class QI{get isFixedFoveationSupported(){return this.layerType=="XRWebGLLayer"&&typeof this.layer.fixedFoveation=="number"}get fixedFoveation(){return this.isFixedFoveationSupported?this.layer.fixedFoveation:null}set fixedFoveation(e){if(this.isFixedFoveationSupported){const i=Math.max(0,Math.min(1,e||0));this.layer.fixedFoveation=i}}constructor(e,i,s,n,a){this.getWidth=e,this.getHeight=i,this.layer=s,this.layerType=n,this.createRenderTargetTextureProvider=a}}class $I{constructor(e,i){this._scene=e,this.layerWrapper=i,this._renderTargetTextures=new Array,this._engine=e.getEngine()}_createInternalTexture(e,i){const s=new Bs(this._engine,or.Unknown,!0);return s.width=e.width,s.height=e.height,s._hardwareTexture=new jm(i,this._engine._gl),s.isReady=!0,s}_createRenderTargetTexture(e,i,s,n,a,p){if(!this._engine)throw new Error("Engine is disposed");const _={width:e,height:i},g=p?new A_(this._scene,_):new zn("XR renderTargetTexture",_,this._scene),y=g.renderTarget;if(y._samples=g.samples,(s||!n)&&(y._framebuffer=s),n)if(p)y._colorTextureArray=n;else{const b=this._createInternalTexture(_,n);y.setTexture(b,0),g._texture=b}return a&&(p?y._depthStencilTextureArray=a:y._depthStencilTexture=this._createInternalTexture(_,a)),g.disableRescaling(),typeof XRWebGLBinding<"u"&&(g.skipInitialClear=!0),this._renderTargetTextures.push(g),g}_destroyRenderTargetTexture(e){this._renderTargetTextures.splice(this._renderTargetTextures.indexOf(e),1),e.dispose()}getFramebufferDimensions(){return this._framebufferDimensions}dispose(){this._renderTargetTextures.forEach(e=>e.dispose()),this._renderTargetTextures.length=0}}class JI extends QI{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",i=>new mz(i.scene,this)),this.layer=e}}class mz extends $I{constructor(e,i){super(e,i),this.layerWrapper=i,this._layer=i.layer,this._framebufferDimensions={framebufferWidth:this._layer.framebufferWidth,framebufferHeight:this._layer.framebufferHeight}}trySetViewportForView(e,i){const s=this._layer.getViewport(i);if(!s)return!1;const n=this._framebufferDimensions.framebufferWidth,a=this._framebufferDimensions.framebufferHeight;return e.x=s.x/n,e.y=s.y/a,e.width=s.width/n,e.height=s.height/a,!0}getRenderTargetTextureForEye(e){const i=this._layer.framebufferWidth,s=this._layer.framebufferHeight,n=this._layer.framebuffer;return(!this._rtt||i!==this._framebufferDimensions.framebufferWidth||s!==this._framebufferDimensions.framebufferHeight||n!==this._framebuffer)&&(this._rtt=this._createRenderTargetTexture(i,s,n),this._framebufferDimensions.framebufferWidth=i,this._framebufferDimensions.framebufferHeight=s,this._framebuffer=n),this._rtt}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}}class V2{static GetDefaults(e){const i=new V2;return i.canvasOptions={antialias:!0,depth:!0,stencil:e?e.isStencilEnable:!0,alpha:!0,framebufferScaleFactor:1},i.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",i}}class _z{constructor(e,i=V2.GetDefaults()){if(this._options=i,this._canvas=null,this._engine=null,this.xrLayer=null,this._xrLayerWrapper=null,this.onXRLayerInitObservable=new Re,this._engine=e.scene.getEngine(),this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),i.canvasElement)this._setManagedOutputCanvas(i.canvasElement);else{const s=document.createElement("canvas");s.style.cssText=this._options.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this._setManagedOutputCanvas(s)}e.onXRSessionInit.add(()=>{this._addCanvas()}),e.onXRSessionEnded.add(()=>{this._removeCanvas()})}dispose(){this._removeCanvas(),this._setManagedOutputCanvas(null)}async initializeXRLayerAsync(e){const i=()=>(this.xrLayer=new XRWebGLLayer(e,this.canvasContext,this._options.canvasOptions),this._xrLayerWrapper=new JI(this.xrLayer),this.onXRLayerInitObservable.notifyObservers(this.xrLayer),this.xrLayer);return this.canvasContext.makeXRCompatible?this.canvasContext.makeXRCompatible().then(()=>{},()=>{Le.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly.")}).then(()=>i()):Promise.resolve(i())}_addCanvas(){this._canvas&&this._engine&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.appendChild(this._canvas),this.xrLayer?this._setCanvasSize(!0):this.onXRLayerInitObservable.addOnce(()=>{this._setCanvasSize(!0)})}_removeCanvas(){this._canvas&&this._engine&&document.body.contains(this._canvas)&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.removeChild(this._canvas),this._setCanvasSize(!1)}_setCanvasSize(e=!0,i=this._xrLayerWrapper){!this._canvas||!this._engine||(e?i&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=i.getWidth()+"px",this._canvas.style.height=i.getHeight()+"px"):this._engine.setSize(i.getWidth(),i.getHeight())):this._originalCanvasSize&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=this._originalCanvasSize.width+"px",this._canvas.style.height=this._originalCanvasSize.height+"px"):this._engine.setSize(this._originalCanvasSize.width,this._originalCanvasSize.height)))}_setManagedOutputCanvas(e){this._removeCanvas(),e?(this._originalCanvasSize={width:e.offsetWidth,height:e.offsetHeight},this._canvas=e,this.canvasContext=this._canvas.getContext("webgl2"),this.canvasContext||(this.canvasContext=this._canvas.getContext("webgl"))):(this._canvas=null,this.canvasContext=null)}}class gz extends QI{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",i=>new yz(i,this)),this.layer=e}}class yz extends $I{constructor(e,i){super(e.scene,i),this.layerWrapper=i,this._nativeRTTProvider=navigator.xr.getNativeRenderTargetProvider(e.session,this._createRenderTargetTexture.bind(this),this._destroyRenderTargetTexture.bind(this)),this._nativeLayer=i.layer}trySetViewportForView(e){return e.x=0,e.y=0,e.width=1,e.height=1,!0}getRenderTargetTextureForEye(e){return this._nativeRTTProvider.getRenderTargetForEye(e)}getRenderTargetTextureForView(e){return this._nativeRTTProvider.getRenderTargetForEye(e.eye)}getFramebufferDimensions(){return{framebufferWidth:this._nativeLayer.framebufferWidth,framebufferHeight:this._nativeLayer.framebufferHeight}}}class bz{constructor(e){this._nativeRenderTarget=navigator.xr.getWebXRRenderTarget(e.scene.getEngine())}async initializeXRLayerAsync(e){return await this._nativeRenderTarget.initializeXRLayerAsync(e),this.xrLayer=this._nativeRenderTarget.xrLayer,this.xrLayer}dispose(){}}class G2{constructor(e){this.scene=e,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new Re,this.onXRReferenceSpaceChanged=new Re,this.onXRSessionEnded=new Re,this.onXRSessionInit=new Re,this.inXRFrameLoop=!1,this.inXRSession=!1,this._engine=e.getEngine(),this._onEngineDisposedObserver=this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),e.onDisposeObservable.addOnce(()=>{this.dispose()})}get referenceSpace(){return this._referenceSpace}set referenceSpace(e){this._referenceSpace=e,this.onXRReferenceSpaceChanged.notifyObservers(this._referenceSpace)}get sessionMode(){return this._sessionMode}dispose(){var e;this.inXRSession&&this.exitXRAsync(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear(),(e=this._engine)===null||e===void 0||e.onDisposeObservable.remove(this._onEngineDisposedObserver),this._engine=null}exitXRAsync(){return this.session&&this.inXRSession?(this.inXRSession=!1,this.session.end().catch(()=>{Ie.Warn("Could not end XR session.")})):Promise.resolve()}trySetViewportForView(e,i){var s;return((s=this._baseLayerRTTProvider)===null||s===void 0?void 0:s.trySetViewportForView(e,i))||!1}getRenderTargetTextureForEye(e){var i;return((i=this._baseLayerRTTProvider)===null||i===void 0?void 0:i.getRenderTargetTextureForEye(e))||null}getRenderTargetTextureForView(e){var i;return((i=this._baseLayerRTTProvider)===null||i===void 0?void 0:i.getRenderTargetTextureForView(e))||null}getWebXRRenderTarget(e){const i=this.scene.getEngine();return this._xrNavigator.xr.native?new bz(this):(e=e||V2.GetDefaults(i),e.canvasElement=e.canvasElement||i.getRenderingCanvas()||void 0,new _z(this,e))}initializeAsync(){return this._xrNavigator=navigator,this._xrNavigator.xr?Promise.resolve():Promise.reject("WebXR not available")}initializeSessionAsync(e="immersive-vr",i={}){return this._xrNavigator.xr.requestSession(e,i).then(s=>(this.session=s,this._sessionMode=e,this.onXRSessionInit.notifyObservers(s),this.inXRSession=!0,this.session.addEventListener("end",()=>{var n;this.inXRSession=!1,this.onXRSessionEnded.notifyObservers(null),this._engine&&(this._engine.framebufferDimensionsObject=null,this._engine.restoreDefaultFramebuffer(),this._engine.customAnimationFrameRequester=null,this._engine._renderLoop()),this.isNative&&((n=this._baseLayerRTTProvider)===null||n===void 0||n.dispose()),this._baseLayerRTTProvider=null,this._baseLayerWrapper=null},{once:!0}),this.session))}isSessionSupportedAsync(e){return G2.IsSessionSupportedAsync(e)}resetReferenceSpace(){this.referenceSpace=this.baseReferenceSpace}runXRRenderLoop(){var e;!this.inXRSession||!this._engine||(this._engine.customAnimationFrameRequester={requestAnimationFrame:this.session.requestAnimationFrame.bind(this.session),renderFunction:(i,s)=>{var n;!this.inXRSession||!this._engine||(this.currentFrame=s,this.currentTimestamp=i,s&&(this.inXRFrameLoop=!0,this._engine.framebufferDimensionsObject=((n=this._baseLayerRTTProvider)===null||n===void 0?void 0:n.getFramebufferDimensions())||null,this.onXRFrameObservable.notifyObservers(s),this._engine._renderLoop(),this._engine.framebufferDimensionsObject=null,this.inXRFrameLoop=!1))}},this._engine.framebufferDimensionsObject=((e=this._baseLayerRTTProvider)===null||e===void 0?void 0:e.getFramebufferDimensions())||null,typeof window<"u"&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this._engine._frameHandler),this._engine._renderLoop())}setReferenceSpaceTypeAsync(e="local-floor"){return this.session.requestReferenceSpace(e).then(i=>i,i=>(Ie.Error("XR.requestReferenceSpace failed for the following reason: "),Ie.Error(i),Ie.Log('Defaulting to universally-supported "viewer" reference space type.'),this.session.requestReferenceSpace("viewer").then(s=>{const n=new XRRigidTransform({x:0,y:-this.defaultHeightCompensation,z:0});return s.getOffsetReferenceSpace(n)},s=>{throw Ie.Error(s),'XR initialization failed: required "viewer" reference space type not supported.'}))).then(i=>this.session.requestReferenceSpace("viewer").then(s=>(this.viewerReferenceSpace=s,i))).then(i=>(this.referenceSpace=this.baseReferenceSpace=i,this.referenceSpace))}updateRenderStateAsync(e){return Promise.resolve(this.session.updateRenderState(e))}_setBaseLayerWrapper(e){var i,s;this.isNative&&((i=this._baseLayerRTTProvider)===null||i===void 0||i.dispose()),this._baseLayerWrapper=e,this._baseLayerRTTProvider=((s=this._baseLayerWrapper)===null||s===void 0?void 0:s.createRenderTargetTextureProvider(this))||null}updateRenderState(e){e.baseLayer&&this._setBaseLayerWrapper(this.isNative?new gz(e.baseLayer):new JI(e.baseLayer)),this.session.updateRenderState(e)}static IsSessionSupportedAsync(e){if(!navigator.xr)return Promise.resolve(!1);const i=navigator.xr.isSessionSupported||navigator.xr.supportsSession;return i?i.call(navigator.xr,e).then(s=>{const n=typeof s>"u"?!0:s;return Promise.resolve(n)}).catch(s=>(Ie.Warn(s),Promise.resolve(!1))):Promise.resolve(!1)}get isNative(){var e;return(e=this._xrNavigator.xr.native)!==null&&e!==void 0?e:!1}get currentFrameRate(){var e;return(e=this.session)===null||e===void 0?void 0:e.frameRate}get supportedFrameRates(){var e;return(e=this.session)===null||e===void 0?void 0:e.supportedFrameRates}updateTargetFrameRate(e){return this.session.updateTargetFrameRate(e)}runInXRFrame(e,i=!0){this.inXRFrameLoop?e():(this.inXRSession||!i)&&this.onXRFrameObservable.addOnce(e)}get isFixedFoveationSupported(){var e;return((e=this._baseLayerWrapper)===null||e===void 0?void 0:e.isFixedFoveationSupported)||!1}get fixedFoveation(){var e;return((e=this._baseLayerWrapper)===null||e===void 0?void 0:e.fixedFoveation)||null}set fixedFoveation(e){const i=Math.max(0,Math.min(1,e||0));this._baseLayerWrapper&&(this._baseLayerWrapper.fixedFoveation=i)}}var ns;(function(l){l[l.ENTERING_XR=0]="ENTERING_XR",l[l.EXITING_XR=1]="EXITING_XR",l[l.IN_XR=2]="IN_XR",l[l.NOT_IN_XR=3]="NOT_IN_XR"})(ns||(ns={}));var Nc;(function(l){l[l.NOT_TRACKING=0]="NOT_TRACKING",l[l.TRACKING_LOST=1]="TRACKING_LOST",l[l.TRACKING=2]="TRACKING"})(Nc||(Nc={}));function eS(l){const e=l.height||2;let i=l.diameterTop===0?0:l.diameterTop||l.diameter||1,s=l.diameterBottom===0?0:l.diameterBottom||l.diameter||1;i=i||1e-5,s=s||1e-5;const n=l.tessellation||24,a=l.subdivisions||1,p=!!l.hasRings,_=!!l.enclose,g=l.cap===0?0:l.cap||Qe.CAP_ALL,y=l.arc&&(l.arc<=0||l.arc>1)?1:l.arc||1,b=l.sideOrientation===0?0:l.sideOrientation||Mt.DEFAULTSIDE,v=l.faceUV||new Array(3),S=l.faceColors,M=y!==1&&_?2:0,F=p?a:1,L=2+(1+M)*F;let N;for(N=0;N<L;N++)S&&S[N]===void 0&&(S[N]=new pi(1,1,1,1));for(N=0;N<L;N++)v&&v[N]===void 0&&(v[N]=new xr(0,0,1,1));const k=new Array,G=new Array,H=new Array,z=new Array,W=new Array,Y=Math.PI*2*y/n;let Z,Q,se;const $=(s-i)/2/e,oe=j.Zero(),ue=j.Zero(),de=j.Zero(),ye=j.Zero(),_e=j.Zero(),we=oa.Y;let Pe,Ee,We,et=1,ke=1,$e=0,pt=0;for(Pe=0;Pe<=a;Pe++)for(Q=Pe/a,se=(Q*(i-s)+s)/2,et=p&&Pe!==0&&Pe!==a?2:1,We=0;We<et;We++){for(p&&(ke+=We),_&&(ke+=2*We),Ee=0;Ee<=n;Ee++)Z=Ee*Y,oe.x=Math.cos(-Z)*se,oe.y=-e/2+Q*e,oe.z=Math.sin(-Z)*se,i===0&&Pe===a?(ue.x=H[H.length-(n+1)*3],ue.y=H[H.length-(n+1)*3+1],ue.z=H[H.length-(n+1)*3+2]):(ue.x=oe.x,ue.z=oe.z,ue.y=Math.sqrt(ue.x*ue.x+ue.z*ue.z)*$,ue.normalize()),Ee===0&&(de.copyFrom(oe),ye.copyFrom(ue)),G.push(oe.x,oe.y,oe.z),H.push(ue.x,ue.y,ue.z),p?pt=$e!==ke?v[ke].y:v[ke].w:pt=v[ke].y+(v[ke].w-v[ke].y)*Q,z.push(v[ke].x+(v[ke].z-v[ke].x)*Ee/n,wr.UseOpenGLOrientationForUV?1-pt:pt),S&&W.push(S[ke].r,S[ke].g,S[ke].b,S[ke].a);y!==1&&_&&(G.push(oe.x,oe.y,oe.z),G.push(0,oe.y,0),G.push(0,oe.y,0),G.push(de.x,de.y,de.z),j.CrossToRef(we,ue,_e),_e.normalize(),H.push(_e.x,_e.y,_e.z,_e.x,_e.y,_e.z),j.CrossToRef(ye,we,_e),_e.normalize(),H.push(_e.x,_e.y,_e.z,_e.x,_e.y,_e.z),p?pt=$e!==ke?v[ke+1].y:v[ke+1].w:pt=v[ke+1].y+(v[ke+1].w-v[ke+1].y)*Q,z.push(v[ke+1].x,wr.UseOpenGLOrientationForUV?1-pt:pt),z.push(v[ke+1].z,wr.UseOpenGLOrientationForUV?1-pt:pt),p?pt=$e!==ke?v[ke+2].y:v[ke+2].w:pt=v[ke+2].y+(v[ke+2].w-v[ke+2].y)*Q,z.push(v[ke+2].x,wr.UseOpenGLOrientationForUV?1-pt:pt),z.push(v[ke+2].z,wr.UseOpenGLOrientationForUV?1-pt:pt),S&&(W.push(S[ke+1].r,S[ke+1].g,S[ke+1].b,S[ke+1].a),W.push(S[ke+1].r,S[ke+1].g,S[ke+1].b,S[ke+1].a),W.push(S[ke+2].r,S[ke+2].g,S[ke+2].b,S[ke+2].a),W.push(S[ke+2].r,S[ke+2].g,S[ke+2].b,S[ke+2].a))),$e!==ke&&($e=ke)}const Xe=y!==1&&_?n+4:n;for(Pe=0,ke=0;ke<a;ke++){let li=0,Ot=0,Gt=0,bi=0;for(Ee=0;Ee<n;Ee++)li=Pe*(Xe+1)+Ee,Ot=(Pe+1)*(Xe+1)+Ee,Gt=Pe*(Xe+1)+(Ee+1),bi=(Pe+1)*(Xe+1)+(Ee+1),k.push(li,Ot,Gt),k.push(bi,Gt,Ot);y!==1&&_&&(k.push(li+2,Ot+2,Gt+2),k.push(bi+2,Gt+2,Ot+2),k.push(li+4,Ot+4,Gt+4),k.push(bi+4,Gt+4,Ot+4)),Pe=p?Pe+2:Pe+1}const Tt=li=>{const Ot=li?i/2:s/2;if(Ot===0)return;let Gt,bi,si;const oi=li?v[L-1]:v[0];let ci=null;S&&(ci=li?S[L-1]:S[0]);const Li=G.length/3,hi=li?e/2:-e/2,mi=new j(0,hi,0);G.push(mi.x,mi.y,mi.z),H.push(0,li?1:-1,0);const cr=oi.y+(oi.w-oi.y)*.5;z.push(oi.x+(oi.z-oi.x)*.5,wr.UseOpenGLOrientationForUV?1-cr:cr),ci&&W.push(ci.r,ci.g,ci.b,ci.a);const Ui=new ii(.5,.5);for(si=0;si<=n;si++){Gt=Math.PI*2*si*y/n;const Ii=Math.cos(-Gt),Cr=Math.sin(-Gt);bi=new j(Ii*Ot,hi,Cr*Ot);const an=new ii(Ii*Ui.x+.5,Cr*Ui.y+.5);G.push(bi.x,bi.y,bi.z),H.push(0,li?1:-1,0);const un=oi.y+(oi.w-oi.y)*an.y;z.push(oi.x+(oi.z-oi.x)*an.x,wr.UseOpenGLOrientationForUV?1-un:un),ci&&W.push(ci.r,ci.g,ci.b,ci.a)}for(si=0;si<n;si++)li?(k.push(Li),k.push(Li+(si+2)),k.push(Li+(si+1))):(k.push(Li),k.push(Li+(si+1)),k.push(Li+(si+2)))};(g===Qe.CAP_START||g===Qe.CAP_ALL)&&Tt(!1),(g===Qe.CAP_END||g===Qe.CAP_ALL)&&Tt(!0),Mt._ComputeSides(b,G,k,H,z,l.frontUVs,l.backUVs);const fi=new Mt;return fi.indices=k,fi.positions=G,fi.normals=H,fi.uvs=z,S&&(fi.colors=W),fi}function tu(l,e={},i){const s=new Qe(l,i);return e.sideOrientation=Qe._GetDefaultSideOrientation(e.sideOrientation),s._originalBuilderSideOrientation=e.sideOrientation,eS(e).applyToMesh(s,e.updatable),s}const zq={CreateCylinder:tu};Mt.CreateCylinder=eS,Qe.CreateCylinder=(l,e,i,s,n,a,p,_,g)=>((p===void 0||!(p instanceof Nt))&&(p!==void 0&&(g=_||Qe.DEFAULTSIDE,_=p),p=a,a=1),tu(l,{height:e,diameterTop:i,diameterBottom:s,tessellation:n,subdivisions:a,sideOrientation:g,updatable:_},p));function tS(l){const e=[],i=[],s=[],n=[],a=l.diameter||1,p=l.thickness||.5,_=l.tessellation||16,g=l.sideOrientation===0?0:l.sideOrientation||Mt.DEFAULTSIDE,y=_+1;for(let v=0;v<=_;v++){const S=v/_,M=v*Math.PI*2/_-Math.PI/2,F=fe.Translation(a/2,0,0).multiply(fe.RotationY(M));for(let L=0;L<=_;L++){const N=1-L/_,k=L*Math.PI*2/_+Math.PI,G=Math.cos(k),H=Math.sin(k);let z=new j(G,H,0),W=z.scale(p/2);const Y=new ii(S,N);W=j.TransformCoordinates(W,F),z=j.TransformNormal(z,F),i.push(W.x,W.y,W.z),s.push(z.x,z.y,z.z),n.push(Y.x,wr.UseOpenGLOrientationForUV?1-Y.y:Y.y);const Z=(v+1)%y,Q=(L+1)%y;e.push(v*y+L),e.push(v*y+Q),e.push(Z*y+L),e.push(v*y+Q),e.push(Z*y+Q),e.push(Z*y+L)}}Mt._ComputeSides(g,i,e,s,n,l.frontUVs,l.backUVs);const b=new Mt;return b.indices=e,b.positions=i,b.normals=s,b.uvs=n,b}function Tl(l,e={},i){const s=new Qe(l,i);return e.sideOrientation=Qe._GetDefaultSideOrientation(e.sideOrientation),s._originalBuilderSideOrientation=e.sideOrientation,tS(e).applyToMesh(s,e.updatable),s}const Hq={CreateTorus:Tl};Mt.CreateTorus=tS,Qe.CreateTorus=(l,e,i,s,n,a,p)=>Tl(l,{diameter:e,thickness:i,tessellation:s,sideOrientation:p,updatable:a},n),Qe._GroundMeshParser=(l,e)=>iu.Parse(l,e);class iu extends Qe{constructor(e,i){super(e,i),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(e,i=32){this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e);const s=this;s.createOrUpdateSubmeshesOctree&&s.createOrUpdateSubmeshesOctree(i)}getHeightAtCoordinates(e,i){const s=this.getWorldMatrix(),n=ge.Matrix[5];s.invertToRef(n);const a=ge.Vector3[8];if(j.TransformCoordinatesFromFloatsToRef(e,0,i,n,a),e=a.x,i=a.z,e<this._minX||e>=this._maxX||i<=this._minZ||i>this._maxZ)return this.position.y;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());const p=this._getFacetAt(e,i),_=-(p.x*e+p.z*i+p.w)/p.y;return j.TransformCoordinatesFromFloatsToRef(0,_,0,s,a),a.y}getNormalAtCoordinates(e,i){const s=new j(0,1,0);return this.getNormalAtCoordinatesToRef(e,i,s),s}getNormalAtCoordinatesToRef(e,i,s){const n=this.getWorldMatrix(),a=ge.Matrix[5];n.invertToRef(a);const p=ge.Vector3[8];if(j.TransformCoordinatesFromFloatsToRef(e,0,i,a,p),e=p.x,i=p.z,e<this._minX||e>this._maxX||i<this._minZ||i>this._maxZ)return this;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());const _=this._getFacetAt(e,i);return j.TransformNormalFromFloatsToRef(_.x,_.y,_.z,n,s),this}updateCoordinateHeights(){return(!this._heightQuads||this._heightQuads.length==0)&&this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(e,i){const s=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),n=Math.floor(-(i+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),a=this._heightQuads[n*this._subdivisionsX+s];let p;return i<a.slope.x*e+a.slope.y?p=a.facet1:p=a.facet2,p}_initHeightQuads(){const e=this._subdivisionsX,i=this._subdivisionsY;this._heightQuads=new Array;for(let s=0;s<i;s++)for(let n=0;n<e;n++){const a={slope:ii.Zero(),facet1:new xr(0,0,0,0),facet2:new xr(0,0,0,0)};this._heightQuads[s*e+n]=a}return this}_computeHeightQuads(){const e=this.getVerticesData(te.PositionKind);if(!e)return this;const i=ge.Vector3[3],s=ge.Vector3[2],n=ge.Vector3[1],a=ge.Vector3[0],p=ge.Vector3[4],_=ge.Vector3[5],g=ge.Vector3[6],y=ge.Vector3[7],b=ge.Vector3[8];let v=0,S=0,M=0,F=0,L=0,N=0,k=0;const G=this._subdivisionsX,H=this._subdivisionsY;for(let z=0;z<H;z++)for(let W=0;W<G;W++){v=W*3,S=z*(G+1)*3,M=(z+1)*(G+1)*3,i.x=e[S+v],i.y=e[S+v+1],i.z=e[S+v+2],s.x=e[S+v+3],s.y=e[S+v+4],s.z=e[S+v+5],n.x=e[M+v],n.y=e[M+v+1],n.z=e[M+v+2],a.x=e[M+v+3],a.y=e[M+v+4],a.z=e[M+v+5],F=(a.z-i.z)/(a.x-i.x),L=i.z-F*i.x,s.subtractToRef(i,p),n.subtractToRef(i,_),a.subtractToRef(i,g),j.CrossToRef(g,_,y),j.CrossToRef(p,g,b),y.normalize(),b.normalize(),N=-(y.x*i.x+y.y*i.y+y.z*i.z),k=-(b.x*s.x+b.y*s.y+b.z*s.z);const Y=this._heightQuads[z*G+W];Y.slope.copyFromFloats(F,L),Y.facet1.copyFromFloats(y.x,y.y,y.z,N),Y.facet2.copyFromFloats(b.x,b.y,b.z,k)}return this}serialize(e){super.serialize(e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height}static Parse(e,i){const s=new iu(e.name,i);return s._subdivisionsX=e.subdivisionsX||1,s._subdivisionsY=e.subdivisionsY||1,s._minX=e.minX,s._maxX=e.maxX,s._minZ=e.minZ,s._maxZ=e.maxZ,s._width=e.width,s._height=e.height,s}}function iS(l){const e=[],i=[],s=[],n=[];let a,p;const _=l.width||1,g=l.height||1,y=l.subdivisionsX||l.subdivisions||1,b=l.subdivisionsY||l.subdivisions||1;for(a=0;a<=b;a++)for(p=0;p<=y;p++){const S=new j(p*_/y-_/2,0,(b-a)*g/b-g/2),M=new j(0,1,0);i.push(S.x,S.y,S.z),s.push(M.x,M.y,M.z),n.push(p/y,wr.UseOpenGLOrientationForUV?a/b:1-a/b)}for(a=0;a<b;a++)for(p=0;p<y;p++)e.push(p+1+(a+1)*(y+1)),e.push(p+1+a*(y+1)),e.push(p+a*(y+1)),e.push(p+(a+1)*(y+1)),e.push(p+1+(a+1)*(y+1)),e.push(p+a*(y+1));const v=new Mt;return v.indices=e,v.positions=i,v.normals=s,v.uvs=n,v}function rS(l){const e=l.xmin!==void 0&&l.xmin!==null?l.xmin:-1,i=l.zmin!==void 0&&l.zmin!==null?l.zmin:-1,s=l.xmax!==void 0&&l.xmax!==null?l.xmax:1,n=l.zmax!==void 0&&l.zmax!==null?l.zmax:1,a=l.subdivisions||{w:1,h:1},p=l.precision||{w:1,h:1},_=new Array,g=new Array,y=new Array,b=new Array;let v,S,M,F;a.h=a.h<1?1:a.h,a.w=a.w<1?1:a.w,p.w=p.w<1?1:p.w,p.h=p.h<1?1:p.h;const L={w:(s-e)/a.w,h:(n-i)/a.h};function N(G,H,z,W){const Y=g.length/3,Z=p.w+1;for(v=0;v<p.h;v++)for(S=0;S<p.w;S++){const $=[Y+S+v*Z,Y+(S+1)+v*Z,Y+(S+1)+(v+1)*Z,Y+S+(v+1)*Z];_.push($[1]),_.push($[2]),_.push($[3]),_.push($[0]),_.push($[1]),_.push($[3])}const Q=j.Zero(),se=new j(0,1,0);for(v=0;v<=p.h;v++)for(Q.z=v*(W-H)/p.h+H,S=0;S<=p.w;S++)Q.x=S*(z-G)/p.w+G,Q.y=0,g.push(Q.x,Q.y,Q.z),y.push(se.x,se.y,se.z),b.push(S/p.w,v/p.h)}for(M=0;M<a.h;M++)for(F=0;F<a.w;F++)N(e+F*L.w,i+M*L.h,e+(F+1)*L.w,i+(M+1)*L.h);const k=new Mt;return k.indices=_,k.positions=g,k.normals=y,k.uvs=b,k}function sS(l){const e=[],i=[],s=[],n=[];let a,p;const _=l.colorFilter||new qe(.3,.59,.11),g=l.alphaFilter||0;let y=!1;if(l.minHeight>l.maxHeight){y=!0;const v=l.maxHeight;l.maxHeight=l.minHeight,l.minHeight=v}for(a=0;a<=l.subdivisions;a++)for(p=0;p<=l.subdivisions;p++){const v=new j(p*l.width/l.subdivisions-l.width/2,0,(l.subdivisions-a)*l.height/l.subdivisions-l.height/2),S=(v.x+l.width/2)/l.width*(l.bufferWidth-1)|0,M=(1-(v.z+l.height/2)/l.height)*(l.bufferHeight-1)|0,F=(S+M*l.bufferWidth)*4;let L=l.buffer[F]/255,N=l.buffer[F+1]/255,k=l.buffer[F+2]/255;const G=l.buffer[F+3]/255;y&&(L=1-L,N=1-N,k=1-k);const H=L*_.r+N*_.g+k*_.b;G>=g?v.y=l.minHeight+(l.maxHeight-l.minHeight)*H:v.y=l.minHeight-rr,i.push(v.x,v.y,v.z),s.push(0,0,0),n.push(p/l.subdivisions,1-a/l.subdivisions)}for(a=0;a<l.subdivisions;a++)for(p=0;p<l.subdivisions;p++){const v=p+1+(a+1)*(l.subdivisions+1),S=p+1+a*(l.subdivisions+1),M=p+a*(l.subdivisions+1),F=p+(a+1)*(l.subdivisions+1),L=i[v*3+1]>=l.minHeight,N=i[S*3+1]>=l.minHeight,k=i[M*3+1]>=l.minHeight;L&&N&&k&&(e.push(v),e.push(S),e.push(M)),i[F*3+1]>=l.minHeight&&L&&k&&(e.push(F),e.push(v),e.push(M))}Mt.ComputeNormals(i,e,s);const b=new Mt;return b.indices=e,b.positions=i,b.normals=s,b.uvs=n,b}function W2(l,e={},i){const s=new iu(l,i);return s._setReady(!1),s._subdivisionsX=e.subdivisionsX||e.subdivisions||1,s._subdivisionsY=e.subdivisionsY||e.subdivisions||1,s._width=e.width||1,s._height=e.height||1,s._maxX=s._width/2,s._maxZ=s._height/2,s._minX=-s._maxX,s._minZ=-s._maxZ,iS(e).applyToMesh(s,e.updatable),s._setReady(!0),s}function nS(l,e,i=null){const s=new Qe(l,i);return rS(e).applyToMesh(s,e.updatable),s}function aS(l,e,i={},s=null){const n=i.width||10,a=i.height||10,p=i.subdivisions||1,_=i.minHeight||0,g=i.maxHeight||1,y=i.colorFilter||new qe(.3,.59,.11),b=i.alphaFilter||0,v=i.updatable,S=i.onReady;s=s||Zt.LastCreatedScene;const M=new iu(l,s);M._subdivisionsX=p,M._subdivisionsY=p,M._width=n,M._height=a,M._maxX=M._width/2,M._maxZ=M._height/2,M._minX=-M._maxX,M._minZ=-M._maxZ,M._setReady(!1);const F=L=>{const N=L.width,k=L.height;if(s.isDisposed)return;const G=s?.getEngine().resizeImageBitmap(L,N,k);sS({width:n,height:a,subdivisions:p,minHeight:_,maxHeight:g,colorFilter:y,buffer:G,bufferWidth:N,bufferHeight:k,alphaFilter:b}).applyToMesh(M,v),S&&S(M),M._setReady(!0)};return Le.LoadImage(e,F,()=>{},s.offlineProvider),M}const Xq={CreateGround:W2,CreateGroundFromHeightMap:aS,CreateTiledGround:nS};Mt.CreateGround=iS,Mt.CreateTiledGround=rS,Mt.CreateGroundFromHeightMap=sS,Qe.CreateGround=(l,e,i,s,n,a)=>W2(l,{width:e,height:i,subdivisions:s,updatable:a},n),Qe.CreateTiledGround=(l,e,i,s,n,a,p,_,g)=>nS(l,{xmin:e,zmin:i,xmax:s,zmax:n,subdivisions:a,precision:p,updatable:g},_),Qe.CreateGroundFromHeightMap=(l,e,i,s,n,a,p,_,g,y,b)=>aS(l,e,{width:i,height:s,subdivisions:n,minHeight:a,maxHeight:p,updatable:g,onReady:y,alphaFilter:b},_);class ru{constructor(e,i=null){if(this.scene=e,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=ru._IdCounter++,i)this._gazeTracker=i.clone("gazeTracker");else{this._gazeTracker=Tl("gazeTracker",{diameter:.0035,thickness:.0025,tessellation:20,updatable:!1},e),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;const s=new ot("targetMat",e);s.specularColor=qe.Black(),s.emissiveColor=new qe(.7,.7,.7),s.backFaceCulling=!1,this._gazeTracker.material=s}}_getForwardRay(e){return new wi(j.Zero(),new j(0,0,e))}_selectionPointerDown(){this._pointerDownOnMeshAsked=!0,this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})}_selectionPointerUp(){this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1}_activatePointer(){this._activePointer=!0}_deactivatePointer(){this._activePointer=!1}_updatePointerDistance(e=100){}dispose(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()}}ru._IdCounter=0;class vz extends ru{constructor(e,i,s){super(i,s),this.webVRController=e,this._laserPointer=tu("laserPointer",{updatable:!1,height:1,diameterTop:.004,diameterBottom:2e-4,tessellation:20,subdivisions:1},i);const n=new ot("laserPointerMat",i);if(n.emissiveColor=new qe(.7,.7,.7),n.alpha=.6,this._laserPointer.material=n,this._laserPointer.rotation.x=Math.PI/2,this._laserPointer.position.z=-.5,this._laserPointer.isVisible=!1,this._laserPointer.isPickable=!1,!e.mesh){const a=new Qe("preloadControllerMesh",i),p=new Qe(R2.POINTING_POSE,i);p.rotation.x=-.7,a.addChild(p),e.attachToMesh(a)}this._setLaserPointerParent(e.mesh),this._meshAttachedObserver=e._meshAttachedObservable.add(a=>{this._setLaserPointerParent(a)})}_getForwardRay(e){return this.webVRController.getForwardRay(e)}_activatePointer(){super._activatePointer(),this._laserPointer.isVisible=!0}_deactivatePointer(){super._deactivatePointer(),this._laserPointer.isVisible=!1}_setLaserPointerColor(e){this._laserPointer.material.emissiveColor=e}_setLaserPointerLightingDisabled(e){this._laserPointer.material.disableLighting=e}_setLaserPointerParent(e){const i=a=>{a.isPickable=!1,a.getChildMeshes().forEach(p=>{i(p)})};i(e);const s=e.getChildren(void 0,!1);let n=e;this.webVRController._pointingPoseNode=null;for(let a=0;a<s.length;a++)if(s[a].name&&s[a].name.indexOf(R2.POINTING_POSE)>=0){n=s[a],this.webVRController._pointingPoseNode=n;break}this._laserPointer.parent=n}_updatePointerDistance(e=100){this._laserPointer.scaling.y=e,this._laserPointer.position.z=-e/2}dispose(){super.dispose(),this._laserPointer.dispose(),this._meshAttachedObserver&&this.webVRController._meshAttachedObservable.remove(this._meshAttachedObserver)}}class oS extends ru{constructor(e,i){super(i),this._getCamera=e}_getForwardRay(e){const i=this._getCamera();return i?i.getForwardRay(e):new wi(j.Zero(),j.Forward())}}class Yq{}class Bc{get onEnteringVR(){return this.onEnteringVRObservable}get onExitingVR(){return this.onExitingVRObservable}get onControllerMeshLoaded(){return this.onControllerMeshLoadedObservable}get teleportationTarget(){return this._teleportationTarget}set teleportationTarget(e){e&&(e.name="teleportationTarget",this._isDefaultTeleportationTarget=!1,this._teleportationTarget=e)}get gazeTrackerMesh(){return this._cameraGazer._gazeTracker}set gazeTrackerMesh(e){e&&(this._cameraGazer._gazeTracker&&this._cameraGazer._gazeTracker.dispose(),this._leftController&&this._leftController._gazeTracker&&this._leftController._gazeTracker.dispose(),this._rightController&&this._rightController._gazeTracker&&this._rightController._gazeTracker.dispose(),this._cameraGazer._gazeTracker=e,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name="gazeTracker",this._leftController&&(this._leftController._gazeTracker=this._cameraGazer._gazeTracker.clone("gazeTracker")),this._rightController&&(this._rightController._gazeTracker=this._cameraGazer._gazeTracker.clone("gazeTracker")))}get leftControllerGazeTrackerMesh(){return this._leftController?this._leftController._gazeTracker:null}get rightControllerGazeTrackerMesh(){return this._rightController?this._rightController._gazeTracker:null}get displayGaze(){return this._displayGaze}set displayGaze(e){this._displayGaze=e,e||(this._cameraGazer._gazeTracker.isVisible=!1,this._leftController&&(this._leftController._gazeTracker.isVisible=!1),this._rightController&&(this._rightController._gazeTracker.isVisible=!1))}get displayLaserPointer(){return this._displayLaserPointer}set displayLaserPointer(e){this._displayLaserPointer=e,e?(this._rightController&&this._rightController._activatePointer(),this._leftController&&this._leftController._activatePointer()):(this._rightController&&(this._rightController._deactivatePointer(),this._rightController._gazeTracker.isVisible=!1),this._leftController&&(this._leftController._deactivatePointer(),this._leftController._gazeTracker.isVisible=!1))}get deviceOrientationCamera(){return this._deviceOrientationCamera}get currentVRCamera(){return this._webVRready?this._webVRCamera:this._scene.activeCamera}get webVRCamera(){return this._webVRCamera}get vrDeviceOrientationCamera(){return this._vrDeviceOrientationCamera}get vrButton(){return this._btnVR}get _teleportationRequestInitiated(){return this._cameraGazer._teleportationRequestInitiated||this._leftController!==null&&this._leftController._teleportationRequestInitiated||this._rightController!==null&&this._rightController._teleportationRequestInitiated}constructor(e,i={}){if(this.webVROptions=i,this._webVRsupported=!1,this._webVRready=!1,this._webVRrequesting=!1,this._webVRpresenting=!1,this._fullscreenVRpresenting=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new Re,this.onAfterEnteringVRObservable=new Re,this.onExitingVRObservable=new Re,this.onControllerMeshLoadedObservable=new Re,this._useCustomVRButton=!1,this._teleportationRequested=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._teleportationMode=Bc.TELEPORTATIONMODE_CONSTANTTIME,this._teleportationTime=122,this._teleportationSpeed=20,this._rotationAllowed=!0,this._teleportBackwardsVector=new j(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor="#444444",this._teleportationBorderColor="#FFFFFF",this._rotationAngle=0,this._haloCenter=new j(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this._leftController=null,this._rightController=null,this._gazeColor=new qe(.7,.7,.7),this._laserColor=new qe(.7,.7,.7),this._pickedLaserColor=new qe(.2,.2,1),this._pickedGazeColor=new qe(0,0,1),this.onNewMeshSelected=new Re,this.onMeshSelectedWithController=new Re,this.onNewMeshPicked=new Re,this.onBeforeCameraTeleport=new Re,this.onAfterCameraTeleport=new Re,this.onSelectedMeshUnselected=new Re,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._interactionsRequested=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this._onResize=()=>{this._moveButtonToBottomRight(),this._fullscreenVRpresenting&&this._webVRready&&this.exitVR()},this._onFullscreenChange=()=>{this._fullscreenVRpresenting=!!document.fullscreenElement,!this._fullscreenVRpresenting&&this._inputElement&&(this.exitVR(),!this._useCustomVRButton&&this._btnVR&&(this._btnVR.style.top=this._inputElement.offsetTop+this._inputElement.offsetHeight-70+"px",this._btnVR.style.left=this._inputElement.offsetLeft+this._inputElement.offsetWidth-100+"px",this._updateButtonVisibility()))},this._cachedAngularSensibility={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this._beforeRender=()=>{this._leftController&&this._leftController._activePointer&&this._castRayAndSelectObject(this._leftController),this._rightController&&this._rightController._activePointer&&this._castRayAndSelectObject(this._rightController),this._noControllerIsActive&&(this._scene.getEngine().isPointerLock||this.enableGazeEvenWhenNoPointerLock)?this._castRayAndSelectObject(this._cameraGazer):this._cameraGazer._gazeTracker.isVisible=!1},this._onNewGamepadConnected=n=>{if(n.type!==kr.POSE_ENABLED)n.leftStick&&n.onleftstickchanged(a=>{this._teleportationInitialized&&this.teleportationEnabled&&(!this._leftController&&!this._rightController||this._leftController&&!this._leftController._activePointer&&this._rightController&&!this._rightController._activePointer)&&(this._checkTeleportWithRay(a,this._cameraGazer),this._checkTeleportBackwards(a,this._cameraGazer))}),n.rightStick&&n.onrightstickchanged(a=>{this._teleportationInitialized&&this._checkRotate(a,this._cameraGazer)}),n.type===kr.XBOX&&(n.onbuttondown(a=>{this._interactionsEnabled&&a===xa.A&&this._cameraGazer._selectionPointerDown()}),n.onbuttonup(a=>{this._interactionsEnabled&&a===xa.A&&this._cameraGazer._selectionPointerUp()}));else{const a=n,p=new vz(a,this._scene,this._cameraGazer._gazeTracker);a.hand==="right"||this._leftController&&this._leftController.webVRController!=a?this._rightController=p:this._leftController=p,this._tryEnableInteractionOnController(p)}},this._tryEnableInteractionOnController=n=>{this._interactionsRequested&&!n._interactionsEnabled&&this._enableInteractionOnController(n),this._teleportationRequested&&!n._teleportationEnabled&&this._enableTeleportationOnController(n)},this._onNewGamepadDisconnected=n=>{n instanceof lz&&(n.hand==="left"&&this._leftController!=null&&(this._leftController.dispose(),this._leftController=null),n.hand==="right"&&this._rightController!=null&&(this._rightController.dispose(),this._rightController=null))},this._workingVector=j.Zero(),this._workingQuaternion=Ve.Identity(),this._workingMatrix=fe.Identity(),Ie.Warn("WebVR is deprecated. Please avoid using this experience helper and use the WebXR experience helper instead"),this._scene=e,this._inputElement=e.getEngine().getInputElement(),!("getVRDisplays"in navigator)&&i.useXR===void 0&&(i.useXR=!0),i.createFallbackVRDeviceOrientationFreeCamera===void 0&&(i.createFallbackVRDeviceOrientationFreeCamera=!0),i.createDeviceOrientationCamera===void 0&&(i.createDeviceOrientationCamera=!0),i.laserToggle===void 0&&(i.laserToggle=!0),i.defaultHeight===void 0&&(i.defaultHeight=1.7),i.useCustomVRButton&&(this._useCustomVRButton=!0,i.customVRButton&&(this._btnVR=i.customVRButton)),i.rayLength&&(this._rayLength=i.rayLength),this._defaultHeight=i.defaultHeight,i.positionScale&&(this._rayLength*=i.positionScale,this._defaultHeight*=i.positionScale),this._hasEnteredVR=!1,this._scene.activeCamera?this._position=this._scene.activeCamera.position.clone():this._position=new j(0,this._defaultHeight,0),i.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new E_("deviceOrientationVRHelper",this._position.clone(),e),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof rs&&this._scene.activeCamera.rotation)){const n=this._scene.activeCamera;n.rotationQuaternion?this._deviceOrientationCamera.rotationQuaternion.copyFrom(n.rotationQuaternion):this._deviceOrientationCamera.rotationQuaternion.copyFrom(Ve.RotationYawPitchRoll(n.rotation.y,n.rotation.x,n.rotation.z)),this._deviceOrientationCamera.rotation=n.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._inputElement&&this._scene.activeCamera.attachControl()}else this._existingCamera=this._scene.activeCamera;this.webVROptions.useXR&&navigator.xr?G2.IsSessionSupportedAsync("immersive-vr").then(n=>{n?(Ie.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),e.createDefaultXRExperienceAsync({floorMeshes:i.floorMeshes||[]}).then(a=>{this.xr=a,this.xrTestDone=!0,this._cameraGazer=new oS(()=>this.xr.baseExperience.camera,e),this.xr.baseExperience.onStateChangedObservable.add(p=>{switch(p){case ns.ENTERING_XR:this.onEnteringVRObservable.notifyObservers(this),this._interactionsEnabled||this.xr.pointerSelection.detach(),this.xr.pointerSelection.displayLaserPointer=this._displayLaserPointer;break;case ns.EXITING_XR:this.onExitingVRObservable.notifyObservers(this),this._scene.getEngine().resize();break;case ns.IN_XR:this._hasEnteredVR=!0;break;case ns.NOT_IN_XR:this._hasEnteredVR=!1;break}})})):this._completeVRInit(e,i)}):this._completeVRInit(e,i)}_completeVRInit(e,i){if(this.xrTestDone=!0,i.createFallbackVRDeviceOrientationFreeCamera&&(i.useMultiview&&(i.vrDeviceOrientationCameraMetrics||(i.vrDeviceOrientationCameraMetrics=Jh.GetDefault()),i.vrDeviceOrientationCameraMetrics.multiviewEnabled=!0),this._vrDeviceOrientationCamera=new YI("VRDeviceOrientationVRHelper",this._position,this._scene,!0,i.vrDeviceOrientationCameraMetrics),this._vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._webVRCamera=new C_("WebVRHelper",this._position,this._scene,i),this._webVRCamera.useStandingMatrix(),this._cameraGazer=new oS(()=>this.currentVRCamera,e),!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON"),this._btnVR.className="babylonVRicon",this._btnVR.id="babylonVRiconbtn",this._btnVR.title="Click to switch to VR";const n=window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png";let a=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+n+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";a+=".babylonVRicon.vrdisplaypresenting { display: none; }";const p=document.createElement("style");p.appendChild(document.createTextNode(a)),document.getElementsByTagName("head")[0].appendChild(p),this._moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener("click",()=>{this.isInVRMode?this._scene.getEngine().disableVR():this.enterVR()});const s=this._scene.getEngine().getHostWindow();!s||(s.addEventListener("resize",this._onResize),document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),i.createFallbackVRDeviceOrientationFreeCamera?this._displayVRButton():this._scene.getEngine().onVRDisplayChangedObservable.add(n=>{n.vrDisplay&&this._displayVRButton()}),this._onKeyDown=n=>{n.keyCode===27&&this.isInVRMode&&this.exitVR()},document.addEventListener("keydown",this._onKeyDown),this._scene.onPrePointerObservable.add(()=>{this._hasEnteredVR&&this.exitVROnDoubleTap&&(this.exitVR(),this._fullscreenVRpresenting&&this._scene.getEngine().exitFullscreen())},Lt.POINTERDOUBLETAP,!1),this._onVRDisplayChangedBind=n=>this._onVRDisplayChanged(n),this._onVrDisplayPresentChangeBind=()=>this._onVrDisplayPresentChange(),this._onVRRequestPresentStart=()=>{this._webVRrequesting=!0,this._updateButtonVisibility()},this._onVRRequestPresentComplete=()=>{this._webVRrequesting=!1,this._updateButtonVisibility()},e.getEngine().onVRDisplayChangedObservable.add(this._onVRDisplayChangedBind),e.getEngine().onVRRequestPresentStart.add(this._onVRRequestPresentStart),e.getEngine().onVRRequestPresentComplete.add(this._onVRRequestPresentComplete),s.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),e.onDisposeObservable.add(()=>{this.dispose()}),this._webVRCamera.onControllerMeshLoadedObservable.add(n=>this._onDefaultMeshLoaded(n)),this._scene.gamepadManager.onGamepadConnectedObservable.add(this._onNewGamepadConnected),this._scene.gamepadManager.onGamepadDisconnectedObservable.add(this._onNewGamepadDisconnected),this._updateButtonVisibility(),this._circleEase=new tz,this._circleEase.setEasingMode(sn.EASINGMODE_EASEINOUT),this._teleportationEasing=this._circleEase,e.onPointerObservable.add(n=>{this._interactionsEnabled&&e.activeCamera===this.vrDeviceOrientationCamera&&n.event.pointerType==="mouse"&&(n.type===Lt.POINTERDOWN?this._cameraGazer._selectionPointerDown():n.type===Lt.POINTERUP&&this._cameraGazer._selectionPointerUp())}),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))}_onDefaultMeshLoaded(e){this._leftController&&this._leftController.webVRController==e&&e.mesh&&this._leftController._setLaserPointerParent(e.mesh),this._rightController&&this._rightController.webVRController==e&&e.mesh&&this._rightController._setLaserPointerParent(e.mesh);try{this.onControllerMeshLoadedObservable.notifyObservers(e)}catch(i){Ie.Warn("Error in your custom logic onControllerMeshLoaded: "+i)}}get isInVRMode(){return this.xr&&this.webVROptions.useXR&&this.xr.baseExperience.state===ns.IN_XR||this._webVRpresenting||this._fullscreenVRpresenting}_onVrDisplayPresentChange(){const e=this._scene.getEngine().getVRDevice();if(e){const i=this._webVRpresenting;this._webVRpresenting=e.isPresenting,i&&!this._webVRpresenting&&this.exitVR()}else Ie.Warn("Detected VRDisplayPresentChange on an unknown VRDisplay. Did you can enterVR on the vrExperienceHelper?");this._updateButtonVisibility()}_onVRDisplayChanged(e){this._webVRsupported=e.vrSupported,this._webVRready=!!e.vrDisplay,this._webVRpresenting=e.vrDisplay&&e.vrDisplay.isPresenting,this._updateButtonVisibility()}_moveButtonToBottomRight(){if(this._inputElement&&!this._useCustomVRButton&&this._btnVR){const e=this._inputElement.getBoundingClientRect();this._btnVR.style.top=e.top+e.height-70+"px",this._btnVR.style.left=e.left+e.width-100+"px"}}_displayVRButton(){!this._useCustomVRButton&&!this._btnVRDisplayed&&this._btnVR&&(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)}_updateButtonVisibility(){!this._btnVR||this._useCustomVRButton||(this._btnVR.className="babylonVRicon",this.isInVRMode?this._btnVR.className+=" vrdisplaypresenting":(this._webVRready&&(this._btnVR.className+=" vrdisplayready"),this._webVRsupported&&(this._btnVR.className+=" vrdisplaysupported"),this._webVRrequesting&&(this._btnVR.className+=" vrdisplayrequesting")))}enterVR(){if(this.xr){this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);return}if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(e){Ie.Warn("Error in your custom logic onEnteringVR: "+e)}if(this._scene.activeCamera){if(this._position=this._scene.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=Ve.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this.webVRCamera){const e=this.webVRCamera.deviceRotationQuaternion.toEulerAngles().y,s=Ve.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles().y-e,n=this.webVRCamera.rotationQuaternion.toEulerAngles().y;this.webVRCamera.rotationQuaternion=Ve.FromEulerAngles(0,n+s,0)}this._existingCamera=this._scene.activeCamera,this._existingCamera.angularSensibilityX&&(this._cachedAngularSensibility.angularSensibilityX=this._existingCamera.angularSensibilityX,this._existingCamera.angularSensibilityX=Number.MAX_VALUE),this._existingCamera.angularSensibilityY&&(this._cachedAngularSensibility.angularSensibilityY=this._existingCamera.angularSensibilityY,this._existingCamera.angularSensibilityY=Number.MAX_VALUE),this._existingCamera.angularSensibility&&(this._cachedAngularSensibility.angularSensibility=this._existingCamera.angularSensibility,this._existingCamera.angularSensibility=Number.MAX_VALUE)}this._webVRrequesting||(this._webVRready?this._webVRpresenting||(this._scene.getEngine().onVRRequestPresentComplete.addOnce(e=>{this.onAfterEnteringVRObservable.notifyObservers({success:e})}),this._webVRCamera.position=this._position,this._scene.activeCamera=this._webVRCamera):this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this._updateButtonVisibility(),this._vrDeviceOrientationCamera.onViewMatrixChangedObservable.addOnce(()=>{this.onAfterEnteringVRObservable.notifyObservers({success:!0})})),this._scene.activeCamera&&this._inputElement&&this._scene.activeCamera.attachControl(),this._interactionsEnabled&&this._scene.registerBeforeRender(this._beforeRender),this._displayLaserPointer&&[this._leftController,this._rightController].forEach(e=>{e&&e._activatePointer()}),this._hasEnteredVR=!0)}exitVR(){if(this.xr){this.xr.baseExperience.exitXRAsync();return}if(this._hasEnteredVR){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(i){Ie.Warn("Error in your custom logic onExitingVR: "+i)}this._webVRpresenting&&this._scene.getEngine().disableVR(),this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._cachedAngularSensibility.angularSensibilityX&&(this._deviceOrientationCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._deviceOrientationCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._deviceOrientationCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera,this._inputElement&&this._scene.activeCamera.attachControl(),this._cachedAngularSensibility.angularSensibilityX&&(this._existingCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._existingCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._existingCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)),this._updateButtonVisibility(),this._interactionsEnabled&&(this._scene.unregisterBeforeRender(this._beforeRender),this._cameraGazer._gazeTracker.isVisible=!1,this._leftController&&(this._leftController._gazeTracker.isVisible=!1),this._rightController&&(this._rightController._gazeTracker.isVisible=!1)),this._scene.getEngine().resize(),[this._leftController,this._rightController].forEach(i=>{i&&i._deactivatePointer()}),this._hasEnteredVR=!1;const e=this._scene.getEngine();e._onVrDisplayPresentChange&&e._onVrDisplayPresentChange()}}get position(){return this._position}set position(e){this._position=e,this._scene.activeCamera&&(this._scene.activeCamera.position=e)}enableInteractions(){if(!this._interactionsEnabled){if(this._interactionsRequested=!0,this.xr){this.xr.baseExperience.state===ns.IN_XR&&this.xr.pointerSelection.attach();return}this._leftController&&this._enableInteractionOnController(this._leftController),this._rightController&&this._enableInteractionOnController(this._rightController),this.raySelectionPredicate=e=>e.isVisible&&(e.isPickable||e.name===this._floorMeshName),this.meshSelectionPredicate=()=>!0,this._raySelectionPredicate=e=>this._isTeleportationFloor(e)||e.name.indexOf("gazeTracker")===-1&&e.name.indexOf("teleportationTarget")===-1&&e.name.indexOf("torusTeleportation")===-1?this.raySelectionPredicate(e):!1,this._interactionsEnabled=!0}}get _noControllerIsActive(){return!(this._leftController&&this._leftController._activePointer)&&!(this._rightController&&this._rightController._activePointer)}_isTeleportationFloor(e){for(let i=0;i<this._floorMeshesCollection.length;i++)if(this._floorMeshesCollection[i].id===e.id)return!0;return!!(this._floorMeshName&&e.name===this._floorMeshName)}addFloorMesh(e){!this._floorMeshesCollection||this._floorMeshesCollection.indexOf(e)>-1||this._floorMeshesCollection.push(e)}removeFloorMesh(e){if(!this._floorMeshesCollection)return;const i=this._floorMeshesCollection.indexOf(e);i!==-1&&this._floorMeshesCollection.splice(i,1)}enableTeleportation(e={}){if(!this._teleportationInitialized){if(this._teleportationRequested=!0,this.enableInteractions(),this.webVROptions.useXR&&(e.floorMeshes||e.floorMeshName)){const s=e.floorMeshes||[];if(!s.length){const n=this._scene.getMeshByName(e.floorMeshName);n&&s.push(n)}if(this.xr){s.forEach(n=>{this.xr.teleportation.addFloorMesh(n)}),this.xr.teleportation.attached||this.xr.teleportation.attach();return}else if(!this.xrTestDone){const n=()=>{this.xrTestDone&&(this._scene.unregisterBeforeRender(n),this.xr?this.xr.teleportation.attached||this.xr.teleportation.attach():this.enableTeleportation(e))};this._scene.registerBeforeRender(n);return}}e.floorMeshName&&(this._floorMeshName=e.floorMeshName),e.floorMeshes&&(this._floorMeshesCollection=e.floorMeshes),e.teleportationMode&&(this._teleportationMode=e.teleportationMode),e.teleportationTime&&e.teleportationTime>0&&(this._teleportationTime=e.teleportationTime),e.teleportationSpeed&&e.teleportationSpeed>0&&(this._teleportationSpeed=e.teleportationSpeed),e.easingFunction!==void 0&&(this._teleportationEasing=e.easingFunction),this._leftController!=null&&this._enableTeleportationOnController(this._leftController),this._rightController!=null&&this._enableTeleportationOnController(this._rightController);const i=new Oi;i.vignetteColor=new pi(0,0,0,0),i.vignetteEnabled=!0,this._postProcessMove=new qI("postProcessMove",1,this._webVRCamera,void 0,void 0,void 0,void 0,i),this._webVRCamera.detachPostProcess(this._postProcessMove),this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&(this._createTeleportationCircles(),this._teleportationTarget.scaling.scaleInPlace(this._webVRCamera.deviceScaleFactor))}}_enableInteractionOnController(e){e.webVRController.mesh&&(e._interactionsEnabled=!0,this.isInVRMode&&this._displayLaserPointer&&e._activatePointer(),this.webVROptions.laserToggle&&e.webVRController.onMainButtonStateChangedObservable.add(s=>{this._displayLaserPointer&&s.value===1&&(e._activePointer?e._deactivatePointer():e._activatePointer(),this.displayGaze&&(e._gazeTracker.isVisible=e._activePointer))}),e.webVRController.onTriggerStateChangedObservable.add(s=>{let n=e;this._noControllerIsActive&&(n=this._cameraGazer),n._pointerDownOnMeshAsked?s.value<this._padSensibilityDown&&n._selectionPointerUp():s.value>this._padSensibilityUp&&n._selectionPointerDown()}))}_checkTeleportWithRay(e,i){this._teleportationRequestInitiated&&!i._teleportationRequestInitiated||(i._teleportationRequestInitiated?Math.sqrt(e.y*e.y+e.x*e.x)<this._padSensibilityDown&&(this._teleportActive&&this.teleportCamera(this._haloCenter),i._teleportationRequestInitiated=!1):e.y<-this._padSensibilityUp&&i._dpadPressed&&(i._activatePointer(),i._teleportationRequestInitiated=!0))}_checkRotate(e,i){i._teleportationRequestInitiated||(i._rotationLeftAsked?e.x>-this._padSensibilityDown&&(i._rotationLeftAsked=!1):e.x<-this._padSensibilityUp&&i._dpadPressed&&(i._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),i._rotationRightAsked?e.x<this._padSensibilityDown&&(i._rotationRightAsked=!1):e.x>this._padSensibilityUp&&i._dpadPressed&&(i._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))}_checkTeleportBackwards(e,i){if(!i._teleportationRequestInitiated)if(e.y>this._padSensibilityUp&&i._dpadPressed){if(!i._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;let s=Ve.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),n=this.currentVRCamera.position;this.currentVRCamera.devicePosition&&this.currentVRCamera.deviceRotationQuaternion&&(s=this.currentVRCamera.deviceRotationQuaternion,n=this.currentVRCamera.devicePosition),s.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,Ve.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),j.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);const a=new wi(n,this._workingVector),p=this._scene.pickWithRay(a,this._raySelectionPredicate);p&&p.pickedPoint&&p.pickedMesh&&this._isTeleportationFloor(p.pickedMesh)&&p.distance<5&&this.teleportCamera(p.pickedPoint),i._teleportationBackRequestInitiated=!0}}else i._teleportationBackRequestInitiated=!1}_enableTeleportationOnController(e){e.webVRController.mesh&&(e._interactionsEnabled||this._enableInteractionOnController(e),e._interactionsEnabled=!0,e._teleportationEnabled=!0,e.webVRController.controllerType===Kh.VIVE&&(e._dpadPressed=!1,e.webVRController.onPadStateChangedObservable.add(s=>{e._dpadPressed=s.pressed,e._dpadPressed||(e._rotationLeftAsked=!1,e._rotationRightAsked=!1,e._teleportationBackRequestInitiated=!1)})),e.webVRController.onPadValuesChangedObservable.add(s=>{this.teleportationEnabled&&(this._checkTeleportBackwards(s,e),this._checkTeleportWithRay(s,e)),this._checkRotate(s,e)}))}_createTeleportationCircles(){this._teleportationTarget=W2("teleportationTarget",{width:2,height:2,subdivisions:2},this._scene),this._teleportationTarget.isPickable=!1;const e=512,i=new eu("DynamicTexture",e,this._scene,!0);i.hasAlpha=!0;const s=i.getContext(),n=e/2,a=e/2,p=200;s.beginPath(),s.arc(n,a,p,0,2*Math.PI,!1),s.fillStyle=this._teleportationFillColor,s.fill(),s.lineWidth=10,s.strokeStyle=this._teleportationBorderColor,s.stroke(),s.closePath(),i.update();const _=new ot("TextPlaneMaterial",this._scene);_.diffuseTexture=i,this._teleportationTarget.material=_;const g=Tl("torusTeleportation",{diameter:.75,thickness:.1,tessellation:25,updatable:!1},this._scene);g.isPickable=!1,g.parent=this._teleportationTarget;const y=new Ce("animationInnerCircle","position.y",30,Ce.ANIMATIONTYPE_FLOAT,Ce.ANIMATIONLOOPMODE_CYCLE),b=[];b.push({frame:0,value:0}),b.push({frame:30,value:.4}),b.push({frame:60,value:0}),y.setKeys(b);const v=new hI;v.setEasingMode(sn.EASINGMODE_EASEINOUT),y.setEasingFunction(v),g.animations=[],g.animations.push(y),this._scene.beginAnimation(g,0,60,!0),this._hideTeleportationTarget()}_displayTeleportationTarget(){this._teleportActive=!0,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!0,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!0))}_hideTeleportationTarget(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))}_rotateCamera(e){if(!(this.currentVRCamera instanceof Vn))return;e?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];const i=Ve.FromRotationMatrix(fe.RotationY(Math.PI/4*this._rotationAngle)),s=new Ce("animationRotation","rotationQuaternion",90,Ce.ANIMATIONTYPE_QUATERNION,Ce.ANIMATIONLOOPMODE_CONSTANT),n=[];n.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),n.push({frame:6,value:i}),s.setKeys(n),s.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(s),this._postProcessMove.animations=[];const a=new Ce("animationPP","vignetteWeight",90,Ce.ANIMATIONTYPE_FLOAT,Ce.ANIMATIONLOOPMODE_CONSTANT),p=[];p.push({frame:0,value:0}),p.push({frame:3,value:4}),p.push({frame:6,value:0}),a.setKeys(p),a.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(a);const _=new Ce("animationPP2","vignetteStretch",90,Ce.ANIMATIONTYPE_FLOAT,Ce.ANIMATIONLOOPMODE_CONSTANT),g=[];g.push({frame:0,value:0}),g.push({frame:3,value:10}),g.push({frame:6,value:0}),_.setKeys(g),_.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(_),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._webVRCamera.attachPostProcess(this._postProcessMove),this._scene.beginAnimation(this._postProcessMove,0,6,!1,1,()=>{this._webVRCamera.detachPostProcess(this._postProcessMove)}),this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}_moveTeleportationSelectorTo(e,i,s){if(e.pickedPoint){i._teleportationRequestInitiated&&(this._displayTeleportationTarget(),this._haloCenter.copyFrom(e.pickedPoint),this._teleportationTarget.position.copyFrom(e.pickedPoint));const n=this._convertNormalToDirectionOfRay(e.getNormal(!0,!1),s);if(n){const a=j.Cross(oa.Y,n),p=j.Cross(n,a);j.RotationFromAxisToRef(p,n,a,this._teleportationTarget.rotation)}this._teleportationTarget.position.y+=.1}}teleportCamera(e){if(!(this.currentVRCamera instanceof Vn))return;this.webVRCamera.leftCamera?(this._workingVector.copyFrom(this.webVRCamera.leftCamera.globalPosition),this._workingVector.subtractInPlace(this.webVRCamera.position),e.subtractToRef(this._workingVector,this._workingVector)):this._workingVector.copyFrom(e),this.isInVRMode?this._workingVector.y+=this.webVRCamera.deviceDistanceToRoomGround()*this._webVRCamera.deviceScaleFactor:this._workingVector.y+=this._defaultHeight,this.onBeforeCameraTeleport.notifyObservers(this._workingVector);const i=90;let s,n;if(this._teleportationMode==Bc.TELEPORTATIONMODE_CONSTANTSPEED){n=i;const S=j.Distance(this.currentVRCamera.position,this._workingVector);s=this._teleportationSpeed/S}else n=Math.round(this._teleportationTime*i/1e3),s=1;this.currentVRCamera.animations=[];const a=new Ce("animationCameraTeleportation","position",i,Ce.ANIMATIONTYPE_VECTOR3,Ce.ANIMATIONLOOPMODE_CONSTANT),p=[{frame:0,value:this.currentVRCamera.position},{frame:n,value:this._workingVector}];a.setKeys(p),a.setEasingFunction(this._teleportationEasing),this.currentVRCamera.animations.push(a),this._postProcessMove.animations=[];const _=Math.round(n/2),g=new Ce("animationPP","vignetteWeight",i,Ce.ANIMATIONTYPE_FLOAT,Ce.ANIMATIONLOOPMODE_CONSTANT),y=[];y.push({frame:0,value:0}),y.push({frame:_,value:8}),y.push({frame:n,value:0}),g.setKeys(y),this._postProcessMove.animations.push(g);const b=new Ce("animationPP2","vignetteStretch",i,Ce.ANIMATIONTYPE_FLOAT,Ce.ANIMATIONLOOPMODE_CONSTANT),v=[];v.push({frame:0,value:0}),v.push({frame:_,value:10}),v.push({frame:n,value:0}),b.setKeys(v),this._postProcessMove.animations.push(b),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._webVRCamera.attachPostProcess(this._postProcessMove),this._scene.beginAnimation(this._postProcessMove,0,n,!1,s,()=>{this._webVRCamera.detachPostProcess(this._postProcessMove)}),this._scene.beginAnimation(this.currentVRCamera,0,n,!1,s,()=>{this.onAfterCameraTeleport.notifyObservers(this._workingVector)}),this._hideTeleportationTarget()}_convertNormalToDirectionOfRay(e,i){return e&&Math.acos(j.Dot(e,i.direction))<Math.PI/2&&e.scaleInPlace(-1),e}_castRayAndSelectObject(e){if(!(this.currentVRCamera instanceof Vn))return;const i=e._getForwardRay(this._rayLength),s=this._scene.pickWithRay(i,this._raySelectionPredicate);if(s&&this._scene.simulatePointerMove(s,{pointerId:e._id}),e._currentHit=s,s&&s.pickedPoint){if(this._displayGaze){let n=1;e._gazeTracker.isVisible=!0,e._isActionableMesh&&(n=3),this.updateGazeTrackerScale&&(e._gazeTracker.scaling.x=s.distance*n,e._gazeTracker.scaling.y=s.distance*n,e._gazeTracker.scaling.z=s.distance*n);const a=this._convertNormalToDirectionOfRay(s.getNormal(),i),p=.002;if(a){const _=j.Cross(oa.Y,a),g=j.Cross(a,_);j.RotationFromAxisToRef(g,a,_,e._gazeTracker.rotation)}e._gazeTracker.position.copyFrom(s.pickedPoint),e._gazeTracker.position.x<0?e._gazeTracker.position.x+=p:e._gazeTracker.position.x-=p,e._gazeTracker.position.y<0?e._gazeTracker.position.y+=p:e._gazeTracker.position.y-=p,e._gazeTracker.position.z<0?e._gazeTracker.position.z+=p:e._gazeTracker.position.z-=p}e._updatePointerDistance(s.distance)}else e._updatePointerDistance(),e._gazeTracker.isVisible=!1;if(s&&s.pickedMesh){if(this._teleportationInitialized&&this._isTeleportationFloor(s.pickedMesh)&&s.pickedPoint){e._currentMeshSelected&&!this._isTeleportationFloor(e._currentMeshSelected)&&this._notifySelectedMeshUnselected(e._currentMeshSelected),e._currentMeshSelected=null,e._teleportationRequestInitiated&&this._moveTeleportationSelectorTo(s,e,i);return}if(s.pickedMesh!==e._currentMeshSelected)if(this.meshSelectionPredicate(s.pickedMesh)){this.onNewMeshPicked.notifyObservers(s),e._currentMeshSelected=s.pickedMesh,s.pickedMesh.isPickable&&s.pickedMesh.actionManager?(this.changeGazeColor(this._pickedGazeColor),this.changeLaserColor(this._pickedLaserColor),e._isActionableMesh=!0):(this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor),e._isActionableMesh=!1);try{this.onNewMeshSelected.notifyObservers(s.pickedMesh);const n=e;n.webVRController&&this.onMeshSelectedWithController.notifyObservers({mesh:s.pickedMesh,controller:n.webVRController})}catch(n){Ie.Warn("Error while raising onNewMeshSelected or onMeshSelectedWithController: "+n)}}else this._notifySelectedMeshUnselected(e._currentMeshSelected),e._currentMeshSelected=null,this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor)}else this._notifySelectedMeshUnselected(e._currentMeshSelected),e._currentMeshSelected=null,this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor)}_notifySelectedMeshUnselected(e){e&&this.onSelectedMeshUnselected.notifyObservers(e)}setLaserColor(e,i=this._pickedLaserColor){this._laserColor=e,this._pickedLaserColor=i}setLaserLightingState(e=!0){this._leftController&&this._leftController._setLaserPointerLightingDisabled(!e),this._rightController&&this._rightController._setLaserPointerLightingDisabled(!e)}setGazeColor(e,i=this._pickedGazeColor){this._gazeColor=e,this._pickedGazeColor=i}changeLaserColor(e){!this.updateControllerLaserColor||(this._leftController&&this._leftController._setLaserPointerColor(e),this._rightController&&this._rightController._setLaserPointerColor(e))}changeGazeColor(e){!this.updateGazeTrackerColor||!this._cameraGazer._gazeTracker.material||(this._cameraGazer._gazeTracker.material.emissiveColor=e,this._leftController&&(this._leftController._gazeTracker.material.emissiveColor=e),this._rightController&&(this._rightController._gazeTracker.material.emissiveColor=e))}dispose(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._webVRCamera&&this._webVRCamera.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this._leftController&&this._leftController.dispose(),this._rightController&&this._rightController.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this.xr&&this.xr.dispose(),this._floorMeshesCollection.length=0,document.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),window.removeEventListener("resize",this._onResize),document.removeEventListener("fullscreenchange",this._onFullscreenChange),this._scene.getEngine().onVRDisplayChangedObservable.removeCallback(this._onVRDisplayChangedBind),this._scene.getEngine().onVRRequestPresentStart.removeCallback(this._onVRRequestPresentStart),this._scene.getEngine().onVRRequestPresentComplete.removeCallback(this._onVRRequestPresentComplete),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.gamepadManager.onGamepadDisconnectedObservable.removeCallback(this._onNewGamepadDisconnected),this._scene.unregisterBeforeRender(this._beforeRender)}getClassName(){return"VRExperienceHelper"}}Bc.TELEPORTATIONMODE_CONSTANTTIME=0,Bc.TELEPORTATIONMODE_CONSTANTSPEED=1;const Tz=542327876,xS=131072,lS=512,cS=4,hS=64,uS=131072;function z2(l){return l.charCodeAt(0)+(l.charCodeAt(1)<<8)+(l.charCodeAt(2)<<16)+(l.charCodeAt(3)<<24)}function Ez(l){return String.fromCharCode(l&255,l>>8&255,l>>16&255,l>>24&255)}const dS=z2("DXT1"),fS=z2("DXT3"),pS=z2("DXT5"),R_=z2("DX10"),mS=113,_S=116,gS=2,yS=10,Az=88,I_=31,Cz=0,Rz=1,bS=2,vS=3,S_=4,TS=7,M_=20,ES=21,Iz=22,Sz=23,Mz=24,Pz=25,Oz=26,wz=28,Dz=32;class sr{static GetDDSInfo(e){const i=new Int32Array(e.buffer,e.byteOffset,I_),s=new Int32Array(e.buffer,e.byteOffset,I_+4);let n=1;i[bS]&xS&&(n=Math.max(1,i[TS]));const a=i[ES],p=a===R_?s[Dz]:0;let _=0;switch(a){case mS:_=2;break;case _S:_=1;break;case R_:if(p===yS){_=2;break}if(p===gS){_=1;break}}return{width:i[S_],height:i[vS],mipmapCount:n,isFourCC:(i[M_]&cS)===cS,isRGB:(i[M_]&hS)===hS,isLuminance:(i[M_]&uS)===uS,isCube:(i[wz]&lS)===lS,isCompressed:a===dS||a===fS||a===pS,dxgiFormat:p,textureType:_}}static _GetHalfFloatAsFloatRGBAArrayBuffer(e,i,s,n,a,p){const _=new Float32Array(n),g=new Uint16Array(a,s);let y=0;for(let b=0;b<i;b++)for(let v=0;v<e;v++){const S=(v+b*e)*4;_[y]=R0(g[S]),_[y+1]=R0(g[S+1]),_[y+2]=R0(g[S+2]),sr.StoreLODInAlphaChannel?_[y+3]=p:_[y+3]=R0(g[S+3]),y+=4}return _}static _GetHalfFloatRGBAArrayBuffer(e,i,s,n,a,p){if(sr.StoreLODInAlphaChannel){const _=new Uint16Array(n),g=new Uint16Array(a,s);let y=0;for(let b=0;b<i;b++)for(let v=0;v<e;v++){const S=(v+b*e)*4;_[y]=g[S],_[y+1]=g[S+1],_[y+2]=g[S+2],_[y+3]=_l(p),y+=4}return _}return new Uint16Array(a,s,n)}static _GetFloatRGBAArrayBuffer(e,i,s,n,a,p){if(sr.StoreLODInAlphaChannel){const _=new Float32Array(n),g=new Float32Array(a,s);let y=0;for(let b=0;b<i;b++)for(let v=0;v<e;v++){const S=(v+b*e)*4;_[y]=g[S],_[y+1]=g[S+1],_[y+2]=g[S+2],_[y+3]=p,y+=4}return _}return new Float32Array(a,s,n)}static _GetFloatAsHalfFloatRGBAArrayBuffer(e,i,s,n,a,p){const _=new Uint16Array(n),g=new Float32Array(a,s);let y=0;for(let b=0;b<i;b++)for(let v=0;v<e;v++)_[y]=_l(g[y]),_[y+1]=_l(g[y+1]),_[y+2]=_l(g[y+2]),sr.StoreLODInAlphaChannel?_[y+3]=_l(p):_[y+3]=_l(g[y+3]),y+=4;return _}static _GetFloatAsUIntRGBAArrayBuffer(e,i,s,n,a,p){const _=new Uint8Array(n),g=new Float32Array(a,s);let y=0;for(let b=0;b<i;b++)for(let v=0;v<e;v++){const S=(v+b*e)*4;_[y]=at.Clamp(g[S])*255,_[y+1]=at.Clamp(g[S+1])*255,_[y+2]=at.Clamp(g[S+2])*255,sr.StoreLODInAlphaChannel?_[y+3]=p:_[y+3]=at.Clamp(g[S+3])*255,y+=4}return _}static _GetHalfFloatAsUIntRGBAArrayBuffer(e,i,s,n,a,p){const _=new Uint8Array(n),g=new Uint16Array(a,s);let y=0;for(let b=0;b<i;b++)for(let v=0;v<e;v++){const S=(v+b*e)*4;_[y]=at.Clamp(R0(g[S]))*255,_[y+1]=at.Clamp(R0(g[S+1]))*255,_[y+2]=at.Clamp(R0(g[S+2]))*255,sr.StoreLODInAlphaChannel?_[y+3]=p:_[y+3]=at.Clamp(R0(g[S+3]))*255,y+=4}return _}static _GetRGBAArrayBuffer(e,i,s,n,a,p,_,g,y){const b=new Uint8Array(n),v=new Uint8Array(a,s);let S=0;for(let M=0;M<i;M++)for(let F=0;F<e;F++){const L=(F+M*e)*4;b[S]=v[L+p],b[S+1]=v[L+_],b[S+2]=v[L+g],b[S+3]=v[L+y],S+=4}return b}static _ExtractLongWordOrder(e){return e===0||e===255||e===-16777216?0:1+sr._ExtractLongWordOrder(e>>8)}static _GetRGBArrayBuffer(e,i,s,n,a,p,_,g){const y=new Uint8Array(n),b=new Uint8Array(a,s);let v=0;for(let S=0;S<i;S++)for(let M=0;M<e;M++){const F=(M+S*e)*3;y[v]=b[F+p],y[v+1]=b[F+_],y[v+2]=b[F+g],v+=3}return y}static _GetLuminanceArrayBuffer(e,i,s,n,a){const p=new Uint8Array(n),_=new Uint8Array(a,s);let g=0;for(let y=0;y<i;y++)for(let b=0;b<e;b++){const v=b+y*e;p[g]=_[v],g++}return p}static UploadDDSLevels(e,i,s,n,a,p,_=-1,g,y=!0){let b=null;n.sphericalPolynomial&&(b=new Array);const v=!!e.getCaps().s3tc;i.generateMipMaps=a;const S=new Int32Array(s.buffer,s.byteOffset,I_);let M,F,L,N=0,k,G,H,z,W=0,Y=1;if(S[Cz]!==Tz){Ie.Error("Invalid magic number in DDS header");return}if(!n.isFourCC&&!n.isRGB&&!n.isLuminance){Ie.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");return}if(n.isCompressed&&!v){Ie.Error("Compressed textures are not supported on this platform.");return}let Z=S[Iz];k=S[Rz]+4;let Q=!1;if(n.isFourCC)switch(M=S[ES],M){case dS:Y=8,W=33777;break;case fS:Y=16,W=33778;break;case pS:Y=16,W=33779;break;case mS:Q=!0,Z=64;break;case _S:Q=!0,Z=128;break;case R_:{k+=5*4;let _e=!1;switch(n.dxgiFormat){case yS:Q=!0,Z=64,_e=!0;break;case gS:Q=!0,Z=128,_e=!0;break;case Az:n.isRGB=!0,n.isFourCC=!1,Z=32,_e=!0;break}if(_e)break}default:console.error("Unsupported FourCC code:",Ez(M));return}const se=sr._ExtractLongWordOrder(S[Sz]),$=sr._ExtractLongWordOrder(S[Mz]),oe=sr._ExtractLongWordOrder(S[Pz]),ue=sr._ExtractLongWordOrder(S[Oz]);Q&&(W=e._getRGBABufferInternalSizedFormat(n.textureType)),H=1,S[bS]&xS&&a!==!1&&(H=Math.max(1,S[TS]));const de=g||0,ye=e.getCaps();for(let _e=de;_e<p;_e++){for(F=S[S_],L=S[vS],z=0;z<H;++z){if(_===-1||_===z){const we=_===-1?z:0;if(!n.isCompressed&&n.isFourCC){i.format=5,N=F*L*4;let Pe=null;if(e._badOS||e._badDesktopOS||!ye.textureHalfFloat&&!ye.textureFloat)Z===128?(Pe=sr._GetFloatAsUIntRGBAArrayBuffer(F,L,s.byteOffset+k,N,s.buffer,we),b&&we==0&&b.push(sr._GetFloatRGBAArrayBuffer(F,L,s.byteOffset+k,N,s.buffer,we))):Z===64&&(Pe=sr._GetHalfFloatAsUIntRGBAArrayBuffer(F,L,s.byteOffset+k,N,s.buffer,we),b&&we==0&&b.push(sr._GetHalfFloatAsFloatRGBAArrayBuffer(F,L,s.byteOffset+k,N,s.buffer,we))),i.type=0;else{const Ee=ye.textureFloat&&(y&&ye.textureFloatLinearFiltering||!y),We=ye.textureHalfFloat&&(y&&ye.textureHalfFloatLinearFiltering||!y),et=(Z===128||Z===64&&!We)&&Ee?1:(Z===64||Z===128&&!Ee)&&We?2:0;let ke,$e=null;switch(Z){case 128:{switch(et){case 1:ke=sr._GetFloatRGBAArrayBuffer,$e=null;break;case 2:ke=sr._GetFloatAsHalfFloatRGBAArrayBuffer,$e=sr._GetFloatRGBAArrayBuffer;break;case 0:ke=sr._GetFloatAsUIntRGBAArrayBuffer,$e=sr._GetFloatRGBAArrayBuffer;break}break}default:{switch(et){case 1:ke=sr._GetHalfFloatAsFloatRGBAArrayBuffer,$e=null;break;case 2:ke=sr._GetHalfFloatRGBAArrayBuffer,$e=sr._GetHalfFloatAsFloatRGBAArrayBuffer;break;case 0:ke=sr._GetHalfFloatAsUIntRGBAArrayBuffer,$e=sr._GetHalfFloatAsFloatRGBAArrayBuffer;break}break}}i.type=et,Pe=ke(F,L,s.byteOffset+k,N,s.buffer,we),b&&we==0&&b.push($e?$e(F,L,s.byteOffset+k,N,s.buffer,we):Pe)}Pe&&e._uploadDataToTextureDirectly(i,Pe,_e,we)}else if(n.isRGB)i.type=0,Z===24?(i.format=4,N=F*L*3,G=sr._GetRGBArrayBuffer(F,L,s.byteOffset+k,N,s.buffer,se,$,oe),e._uploadDataToTextureDirectly(i,G,_e,we)):(i.format=5,N=F*L*4,G=sr._GetRGBAArrayBuffer(F,L,s.byteOffset+k,N,s.buffer,se,$,oe,ue),e._uploadDataToTextureDirectly(i,G,_e,we));else if(n.isLuminance){const Pe=e._getUnpackAlignement(),Ee=F;N=Math.floor((F+Pe-1)/Pe)*Pe*(L-1)+Ee,G=sr._GetLuminanceArrayBuffer(F,L,s.byteOffset+k,N,s.buffer),i.format=1,i.type=0,e._uploadDataToTextureDirectly(i,G,_e,we)}else N=Math.max(4,F)/4*Math.max(4,L)/4*Y,G=new Uint8Array(s.buffer,s.byteOffset+k,N),i.type=0,e._uploadCompressedDataToTextureDirectly(i,W,F,L,G,_e,we)}k+=Z?F*L*(Z/8):N,F*=.5,L*=.5,F=Math.max(1,F),L=Math.max(1,L)}if(g!==void 0)break}b&&b.length>0?n.sphericalPolynomial=b_.ConvertCubeMapToSphericalPolynomial({size:S[S_],right:b[0],left:b[1],up:b[2],down:b[3],front:b[4],back:b[5],format:5,type:1,gammaSpace:!1}):n.sphericalPolynomial=void 0}}sr.StoreLODInAlphaChannel=!1,Yt.prototype.createPrefilteredCubeTexture=function(l,e,i,s,n=null,a=null,p,_=null,g=!0){const y=b=>{if(!b){n&&n(null);return}const v=b.texture;if(g?b.info.sphericalPolynomial&&(v._sphericalPolynomial=b.info.sphericalPolynomial):v._sphericalPolynomial=new Cx,v._source=or.CubePrefiltered,this.getCaps().textureLOD){n&&n(v);return}const S=3,M=this._gl,F=b.width;if(!F)return;const L=[];for(let N=0;N<S;N++){const k=N/(S-1),G=1-k,H=s,z=at.Log2(F)*i+s,W=H+(z-H)*G,Y=Math.round(Math.min(Math.max(W,0),z)),Z=new Bs(this,or.Temp);if(Z.type=v.type,Z.format=v.format,Z.width=Math.pow(2,Math.max(at.Log2(F)-Y,0)),Z.height=Z.width,Z.isCube=!0,Z._cachedWrapU=0,Z._cachedWrapV=0,this._bindTextureDirectly(M.TEXTURE_CUBE_MAP,Z,!0),Z.samplingMode=2,M.texParameteri(M.TEXTURE_CUBE_MAP,M.TEXTURE_MAG_FILTER,M.LINEAR),M.texParameteri(M.TEXTURE_CUBE_MAP,M.TEXTURE_MIN_FILTER,M.LINEAR),M.texParameteri(M.TEXTURE_CUBE_MAP,M.TEXTURE_WRAP_S,M.CLAMP_TO_EDGE),M.texParameteri(M.TEXTURE_CUBE_MAP,M.TEXTURE_WRAP_T,M.CLAMP_TO_EDGE),b.isDDS){const se=b.info,$=b.data;this._unpackFlipY(se.isCompressed),sr.UploadDDSLevels(this,Z,$,se,!0,6,Y)}else Ie.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(M.TEXTURE_CUBE_MAP,null);const Q=new er(e);Q._isCube=!0,Q._texture=Z,Z.isReady=!0,L.push(Q)}v._lodTextureHigh=L[2],v._lodTextureMid=L[1],v._lodTextureLow=L[0],n&&n(v)};return this.createCubeTexture(l,e,null,!1,y,a,p,_,g,i,s)};class Fz{constructor(){this.supportCascades=!0}canLoad(e){return e.endsWith(".dds")}loadCubeData(e,i,s,n){const a=i.getEngine();let p,_=!1,g=1e3;if(Array.isArray(e))for(let y=0;y<e.length;y++){const b=e[y];p=sr.GetDDSInfo(b),i.width=p.width,i.height=p.height,_=(p.isRGB||p.isLuminance||p.mipmapCount>1)&&i.generateMipMaps,a._unpackFlipY(p.isCompressed),sr.UploadDDSLevels(a,i,b,p,_,6,-1,y),!p.isFourCC&&p.mipmapCount===1?a.generateMipMapsForCubemap(i):g=p.mipmapCount-1}else{const y=e;p=sr.GetDDSInfo(y),i.width=p.width,i.height=p.height,s&&(p.sphericalPolynomial=new Cx),_=(p.isRGB||p.isLuminance||p.mipmapCount>1)&&i.generateMipMaps,a._unpackFlipY(p.isCompressed),sr.UploadDDSLevels(a,i,y,p,_,6),!p.isFourCC&&p.mipmapCount===1?a.generateMipMapsForCubemap(i,!1):g=p.mipmapCount-1}a._setCubeMapTextureParams(i,_,g),i.isReady=!0,i.onLoadedObservable.notifyObservers(i),i.onLoadedObservable.clear(),n&&n({isDDS:!0,width:i.width,info:p,data:e,texture:i})}loadData(e,i,s){const n=sr.GetDDSInfo(e),a=(n.isRGB||n.isLuminance||n.mipmapCount>1)&&i.generateMipMaps&&n.width>>n.mipmapCount-1===1;s(n.width,n.height,a,n.isFourCC,()=>{sr.UploadDDSLevels(i.getEngine(),i,e,n,a,1)})}}Ae._TextureLoaders.push(new Fz);const AS="rgbdEncodePixelShader",CS=`varying vec2 vUV;
uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);
}`;Ye.ShadersStore[AS]=CS;const Kq={name:AS,shader:CS},P_="image/png",O_=2,su=[134,22,135,150,246,214,150,54];function RS(l){const e=new DataView(l.buffer,l.byteOffset,l.byteLength);let i=0;for(let p=0;p<su.length;p++)if(e.getUint8(i++)!==su[p])return Ie.Error("Not a babylon environment map"),null;let s="",n=0;for(;n=e.getUint8(i++);)s+=String.fromCharCode(n);let a=JSON.parse(s);return a=H2(a),a.specular&&(a.specular.specularDataPosition=i,a.specular.lodGenerationScale=a.specular.lodGenerationScale||.8),a}function H2(l){if(l.version>O_)throw new Error(`Unsupported babylon environment map version "${l.version}". Latest supported version is "${O_}".`);return l.version===2||(l={...l,version:2,imageType:P_}),l}async function Lz(l,e={}){var i;const s=l.getInternalTexture();if(!s)return Promise.reject("The cube texture is invalid.");const n=(i=e.imageType)!==null&&i!==void 0?i:P_,a=s.getEngine();if(l.textureType!==2&&l.textureType!==1&&l.textureType!==0&&l.textureType!==0&&l.textureType!==7&&l.textureType!==-1)return Promise.reject("The cube texture should allow HDR (Full Float or Half Float).");let p=1;if(!a.getCaps().textureFloatRender&&(p=2,!a.getCaps().textureHalfFloatRender))return Promise.reject("Env texture can only be created when the browser supports half float or full float rendering.");const _=s.width,g=new Nt(a),y={};a.flushFramebuffer();const b=at.ILog2(s.width);for(let W=0;W<=b;W++){const Y=Math.pow(2,b-W);for(let Z=0;Z<6;Z++){let Q=await l.readPixels(Z,W,void 0,!1);if(Q&&Q.byteLength===Q.length){const ue=new Float32Array(Q.byteLength*4);for(let de=0;de<Q.byteLength;de++)ue[de]=Q[de]/255,ue[de]=Math.pow(ue[de],2.2);Q=ue}else if(Q&&l.gammaSpace){const ue=Q;for(let de=0;de<ue.length;de++)ue[de]=Math.pow(ue[de],2.2)}const se=a.createRawTexture(Q,Y,Y,5,!1,!0,1,null,p);await g_.EncodeTextureToRGBD(se,g,p);const $=await a._readTexturePixels(se,Y,Y),oe=await ln.DumpDataAsync(Y,Y,$,n,void 0,!1,!0,e.imageQuality);y[W*6+Z]=oe,se.dispose()}}g.dispose();const v={version:O_,width:_,imageType:n,irradiance:Nz(l),specular:{mipmaps:[],lodGenerationScale:l.lodGenerationScale}};let S=0;for(let W=0;W<=b;W++)for(let Y=0;Y<6;Y++){const Z=y[W*6+Y].byteLength;v.specular.mipmaps.push({length:Z,position:S}),S+=Z}const M=JSON.stringify(v),F=new ArrayBuffer(M.length+1),L=new Uint8Array(F);for(let W=0,Y=M.length;W<Y;W++)L[W]=M.charCodeAt(W);L[M.length]=0;const N=su.length+S+F.byteLength,k=new ArrayBuffer(N),G=new Uint8Array(k),H=new DataView(k);let z=0;for(let W=0;W<su.length;W++)H.setUint8(z++,su[W]);G.set(new Uint8Array(F),z),z+=F.byteLength;for(let W=0;W<=b;W++)for(let Y=0;Y<6;Y++){const Z=y[W*6+Y];G.set(new Uint8Array(Z),z),z+=Z.byteLength}return k}function Nz(l){const e=l.sphericalPolynomial;return e==null?null:{x:[e.x.x,e.x.y,e.x.z],y:[e.y.x,e.y.y,e.y.z],z:[e.z.x,e.z.y,e.z.z],xx:[e.xx.x,e.xx.y,e.xx.z],yy:[e.yy.x,e.yy.y,e.yy.z],zz:[e.zz.x,e.zz.y,e.zz.z],yz:[e.yz.x,e.yz.y,e.yz.z],zx:[e.zx.x,e.zx.y,e.zx.z],xy:[e.xy.x,e.xy.y,e.xy.z]}}function IS(l,e){e=H2(e);const i=e.specular;let s=at.Log2(e.width);if(s=Math.round(s)+1,i.mipmaps.length!==6*s)throw new Error(`Unsupported specular mipmaps number "${i.mipmaps.length}"`);const n=new Array(s);for(let a=0;a<s;a++){n[a]=new Array(6);for(let p=0;p<6;p++){const _=i.mipmaps[a*6+p];n[a][p]=new Uint8Array(l.buffer,l.byteOffset+i.specularDataPosition+_.position,_.length)}}return n}function SS(l,e,i){i=H2(i);const s=i.specular;if(!s)return Promise.resolve();l._lodGenerationScale=s.lodGenerationScale;const n=IS(e,i);return X2(l,n,i.imageType)}function MS(l,e,i,s,n,a,p,_,g,y,b){return new Promise((v,S)=>{if(i){const M=e.createTexture(null,!0,!0,null,1,null,F=>{S(F)},l);s.getEffect().executeWhenCompiled(()=>{s.externalTextureSamplerBinding=!0,s.onApply=F=>{F._bindTexture("textureSampler",M),F.setFloat2("scale",1,e._features.needsInvertingBitmap&&l instanceof ImageBitmap?-1:1)},e.scenes.length&&(e.scenes[0].postProcessManager.directRender([s],y,!0,a,p),e.restoreDefaultFramebuffer(),M.dispose(),URL.revokeObjectURL(n),v())})}else{if(e._uploadImageToTexture(b,l,a,p),_){const M=g[p];M&&e._uploadImageToTexture(M._texture,l,a,0)}v()}})}function X2(l,e,i=P_){if(!Le.IsExponentOfTwo(l.width))throw new Error("Texture size must be a power of two");const s=at.ILog2(l.width)+1,n=l.getEngine();let a=!1,p=!1,_=null,g=null,y=null;const b=n.getCaps();if(l.format=5,l.type=0,l.generateMipMaps=!0,l._cachedAnisotropicFilteringLevel=null,n.updateTextureSamplingMode(3,l),b.textureLOD?n._features.supportRenderAndCopyToLodForFloatTextures?b.textureHalfFloatRender&&b.textureHalfFloatLinearFiltering?(a=!0,l.type=2):b.textureFloatRender&&b.textureFloatLinearFiltering&&(a=!0,l.type=1):a=!1:(a=!1,p=!0,y={}),a)_=new lr("rgbdDecode","rgbdDecode",null,null,1,null,3,n,!1,void 0,l.type,void 0,null,!1),l._isRGBD=!1,l.invertY=!1,g=n.createRenderTargetCubeTexture(l.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:l.type,format:5});else if(l._isRGBD=!0,l.invertY=!0,p){const M=l._lodGenerationScale,F=l._lodGenerationOffset;for(let L=0;L<3;L++){const N=L/2,k=1-N,G=F,H=(s-1)*M+F,z=G+(H-G)*k,W=Math.round(Math.min(Math.max(z,0),H)),Y=new Bs(n,or.Temp);Y.isCube=!0,Y.invertY=!0,Y.generateMipMaps=!1,n.updateTextureSamplingMode(2,Y);const Z=new er(null);switch(Z._isCube=!0,Z._texture=Y,y[W]=Z,L){case 0:l._lodTextureLow=Z;break;case 1:l._lodTextureMid=Z;break;case 2:l._lodTextureHigh=Z;break}}}const v=[];for(let S=0;S<e.length;S++)for(let M=0;M<6;M++){const F=e[S][M],L=new Blob([F],{type:i}),N=URL.createObjectURL(L);let k;if(typeof Image>"u"||n._features.forceBitmapOverHTMLImageElement)k=n.createImageBitmap(L,{premultiplyAlpha:"none"}).then(G=>MS(G,n,a,_,N,M,S,p,y,g,l));else{const G=new Image;G.src=N,k=new Promise((H,z)=>{G.onload=()=>{MS(G,n,a,_,N,M,S,p,y,g,l).then(()=>H()).catch(W=>{z(W)})},G.onerror=W=>{z(W)}})}v.push(k)}if(e.length<s){let S;const M=Math.pow(2,s-1-e.length),F=M*M*4;switch(l.type){case 0:{S=new Uint8Array(F);break}case 2:{S=new Uint16Array(F);break}case 1:{S=new Float32Array(F);break}}for(let L=e.length;L<s;L++)for(let N=0;N<6;N++)n._uploadArrayBufferViewToTexture(l,S,N,L)}return Promise.all(v).then(()=>{g&&(n._releaseTexture(l),g._swapAndDie(l)),_&&_.dispose(),p&&(l._lodTextureHigh&&l._lodTextureHigh._texture&&(l._lodTextureHigh._texture.isReady=!0),l._lodTextureMid&&l._lodTextureMid._texture&&(l._lodTextureMid._texture.isReady=!0),l._lodTextureLow&&l._lodTextureLow._texture&&(l._lodTextureLow._texture.isReady=!0))})}function PS(l,e){e=H2(e);const i=e.irradiance;if(!i)return;const s=new Cx;j.FromArrayToRef(i.x,0,s.x),j.FromArrayToRef(i.y,0,s.y),j.FromArrayToRef(i.z,0,s.z),j.FromArrayToRef(i.xx,0,s.xx),j.FromArrayToRef(i.yy,0,s.yy),j.FromArrayToRef(i.zz,0,s.zz),j.FromArrayToRef(i.yz,0,s.yz),j.FromArrayToRef(i.zx,0,s.zx),j.FromArrayToRef(i.xy,0,s.xy),l._sphericalPolynomial=s}function Bz(l,e,i,s,n){const a=l.getEngine().createRawCubeTexture(null,l.width,l.format,l.type,l.generateMipMaps,l.invertY,l.samplingMode,l._compression),p=X2(a,e).then(()=>l);return l.onRebuildCallback=_=>({proxy:p,isReady:!0,isAsync:!0}),l._source=or.CubeRawRGBD,l._bufferViewArrayArray=e,l._lodGenerationScale=s,l._lodGenerationOffset=n,l._sphericalPolynomial=i,X2(l,e).then(()=>(l.isReady=!0,l))}const jq={GetEnvInfo:RS,CreateEnvTextureAsync:Lz,CreateImageDataArrayBufferViews:IS,UploadEnvLevelsAsync:SS,UploadLevelsAsync:X2,UploadEnvSpherical:PS};class kz{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".env")}loadCubeData(e,i,s,n,a){if(Array.isArray(e))return;const p=RS(e);if(p){i.width=p.width,i.height=p.width;try{PS(i,p),SS(i,e,p).then(()=>{i.isReady=!0,i.onLoadedObservable.notifyObservers(i),i.onLoadedObservable.clear(),n&&n()},_=>{a?.("Can not upload environment levels",_)})}catch(_){a?.("Can not upload environment file",_)}}else a&&a("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}Ae._TextureLoaders.push(new kz);class Mn{constructor(e,i){if(this.data=e,this.isInvalid=!1,!Mn.IsValid(e)){this.isInvalid=!0,Ie.Error("texture missing KTX identifier");return}const s=Uint32Array.BYTES_PER_ELEMENT,n=new DataView(this.data.buffer,this.data.byteOffset+12,13*s),p=n.getUint32(0,!0)===67305985;if(this.glType=n.getUint32(1*s,p),this.glTypeSize=n.getUint32(2*s,p),this.glFormat=n.getUint32(3*s,p),this.glInternalFormat=n.getUint32(4*s,p),this.glBaseInternalFormat=n.getUint32(5*s,p),this.pixelWidth=n.getUint32(6*s,p),this.pixelHeight=n.getUint32(7*s,p),this.pixelDepth=n.getUint32(8*s,p),this.numberOfArrayElements=n.getUint32(9*s,p),this.numberOfFaces=n.getUint32(10*s,p),this.numberOfMipmapLevels=n.getUint32(11*s,p),this.bytesOfKeyValueData=n.getUint32(12*s,p),this.glType!==0){Ie.Error("only compressed formats currently supported"),this.isInvalid=!0;return}else this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels);if(this.pixelHeight===0||this.pixelDepth!==0){Ie.Error("only 2D textures currently supported"),this.isInvalid=!0;return}if(this.numberOfArrayElements!==0){Ie.Error("texture arrays not currently supported"),this.isInvalid=!0;return}if(this.numberOfFaces!==i){Ie.Error("number of faces expected"+i+", but found "+this.numberOfFaces),this.isInvalid=!0;return}this.loadType=Mn.COMPRESSED_2D}uploadLevels(e,i){switch(this.loadType){case Mn.COMPRESSED_2D:this._upload2DCompressedLevels(e,i);break;case Mn.TEX_2D:case Mn.COMPRESSED_3D:case Mn.TEX_3D:}}_upload2DCompressedLevels(e,i){let s=Mn.HEADER_LEN+this.bytesOfKeyValueData,n=this.pixelWidth,a=this.pixelHeight;const p=i?this.numberOfMipmapLevels:1;for(let _=0;_<p;_++){const g=new Int32Array(this.data.buffer,this.data.byteOffset+s,1)[0];s+=4;for(let y=0;y<this.numberOfFaces;y++){const b=new Uint8Array(this.data.buffer,this.data.byteOffset+s,g);e.getEngine()._uploadCompressedDataToTextureDirectly(e,e.format,n,a,b,y,_),s+=g,s+=3-(g+3)%4}n=Math.max(1,n*.5),a=Math.max(1,a*.5)}}static IsValid(e){if(e.byteLength>=12){const i=new Uint8Array(e.buffer,e.byteOffset,12);if(i[0]===171&&i[1]===75&&i[2]===84&&i[3]===88&&i[4]===32&&i[5]===49&&i[6]===49&&i[7]===187&&i[8]===13&&i[9]===10&&i[10]===26&&i[11]===10)return!0}return!1}}Mn.HEADER_LEN=12+13*4,Mn.COMPRESSED_2D=0,Mn.COMPRESSED_3D=1,Mn.TEX_2D=2,Mn.TEX_3D=3;class Uz{constructor(e){this._pendingActions=new Array,this._workerInfos=e.map(i=>({workerPromise:Promise.resolve(i),idle:!0}))}dispose(){for(const e of this._workerInfos)e.workerPromise.then(i=>{i.terminate()});this._workerInfos.length=0,this._pendingActions.length=0}push(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)}_executeOnIdleWorker(e){for(const i of this._workerInfos)if(i.idle)return this._execute(i,e),!0;return!1}_execute(e,i){e.idle=!1,e.workerPromise.then(s=>{i(s,()=>{const n=this._pendingActions.shift();n?this._execute(e,n):e.idle=!0})})}}class nu extends Uz{constructor(e,i,s=nu.DefaultOptions){super([]),this._maxWorkers=e,this._createWorkerAsync=i,this._options=s}push(e){if(!this._executeOnIdleWorker(e))if(this._workerInfos.length<this._maxWorkers){const i={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(i),this._execute(i,e)}else this._pendingActions.push(e)}_execute(e,i){e.timeoutId&&(clearTimeout(e.timeoutId),delete e.timeoutId),super._execute(e,(s,n)=>{i(s,()=>{n(),e.idle&&(e.timeoutId=setTimeout(()=>{e.workerPromise.then(p=>{p.terminate()});const a=this._workerInfos.indexOf(e);a!==-1&&this._workerInfos.splice(a,1)},this._options.idleTimeElapsedBeforeRelease))})})}}nu.DefaultOptions={idleTimeElapsedBeforeRelease:1e3};var OS;(function(l){l[l.ETC1S=0]="ETC1S",l[l.UASTC4x4=1]="UASTC4x4"})(OS||(OS={}));var au;(function(l){l[l.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",l[l.BC7_RGBA=1]="BC7_RGBA",l[l.BC3_RGBA=2]="BC3_RGBA",l[l.BC1_RGB=3]="BC1_RGB",l[l.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",l[l.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",l[l.ETC2_RGBA=6]="ETC2_RGBA",l[l.ETC1_RGB=7]="ETC1_RGB",l[l.RGBA32=8]="RGBA32",l[l.R8=9]="R8",l[l.RG8=10]="RG8"})(au||(au={}));var w_;(function(l){l[l.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",l[l.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",l[l.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",l[l.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",l[l.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",l[l.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",l[l.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",l[l.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",l[l.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",l[l.RGBA8Format=32856]="RGBA8Format",l[l.R8Format=33321]="R8Format",l[l.RG8Format=33323]="RG8Format"})(w_||(w_={}));function O0(l){return l?Le.GetAbsoluteUrl(l):null}function D_(l){l.wasmUASTCToASTC!==null&&(KTX2DECODER.LiteTranscoder_UASTC_ASTC.WasmModuleURL=l.wasmUASTCToASTC),l.wasmUASTCToBC7!==null&&(KTX2DECODER.LiteTranscoder_UASTC_BC7.WasmModuleURL=l.wasmUASTCToBC7),l.wasmUASTCToRGBA_UNORM!==null&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=l.wasmUASTCToRGBA_UNORM),l.wasmUASTCToRGBA_SRGB!==null&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=l.wasmUASTCToRGBA_SRGB),l.wasmUASTCToR8_UNORM!==null&&(KTX2DECODER.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=l.wasmUASTCToR8_UNORM),l.wasmUASTCToRG8_UNORM!==null&&(KTX2DECODER.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=l.wasmUASTCToRG8_UNORM),l.jsMSCTranscoder!==null&&(KTX2DECODER.MSCTranscoder.JSModuleURL=l.jsMSCTranscoder),l.wasmMSCTranscoder!==null&&(KTX2DECODER.MSCTranscoder.WasmModuleURL=l.wasmMSCTranscoder),l.wasmZSTDDecoder!==null&&(KTX2DECODER.ZSTDDecoder.WasmModuleURL=l.wasmZSTDDecoder)}class Vz{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(e){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==e&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=e,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(e){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==e&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=e,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(e){this._forceRGBA!==e&&(this._forceRGBA=e,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(e){this._forceR8!==e&&(this._forceR8=e,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(e){this._forceRG8!==e&&(this._forceRG8=e,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(e){this._bypassTranscoders!==e&&(this._bypassTranscoders=e,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const e={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(e.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[au.BC1_RGB,au.BC3_RGBA],yes:{transcodeFormat:au.RGBA32,engineFormat:w_.RGBA8Format,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=e,e}}class Cs{static GetDefaultNumWorkers(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}static _Initialize(e){if(Cs._WorkerPoolPromise||Cs._DecoderModulePromise)return;const i={jsDecoderModule:Le.GetAbsoluteUrl(this.URLConfig.jsDecoderModule),wasmUASTCToASTC:O0(this.URLConfig.wasmUASTCToASTC),wasmUASTCToBC7:O0(this.URLConfig.wasmUASTCToBC7),wasmUASTCToRGBA_UNORM:O0(this.URLConfig.wasmUASTCToRGBA_UNORM),wasmUASTCToRGBA_SRGB:O0(this.URLConfig.wasmUASTCToRGBA_SRGB),wasmUASTCToR8_UNORM:O0(this.URLConfig.wasmUASTCToR8_UNORM),wasmUASTCToRG8_UNORM:O0(this.URLConfig.wasmUASTCToRG8_UNORM),jsMSCTranscoder:O0(this.URLConfig.jsMSCTranscoder),wasmMSCTranscoder:O0(this.URLConfig.wasmMSCTranscoder),wasmZSTDDecoder:O0(this.URLConfig.wasmZSTDDecoder)};e&&typeof Worker=="function"&&typeof URL<"u"?Cs._WorkerPoolPromise=new Promise(s=>{const n=`${D_}(${Gz})()`,a=URL.createObjectURL(new Blob([n],{type:"application/javascript"}));s(new nu(e,()=>new Promise((p,_)=>{const g=new Worker(a),y=v=>{g.removeEventListener("error",y),g.removeEventListener("message",b),_(v)},b=v=>{v.data.action==="init"&&(g.removeEventListener("error",y),g.removeEventListener("message",b),p(g))};g.addEventListener("error",y),g.addEventListener("message",b),g.postMessage({action:"init",urls:i})})))}):typeof KTX2DECODER>"u"?Cs._DecoderModulePromise=Le.LoadScriptAsync(i.jsDecoderModule).then(()=>(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,D_(i),new KTX2DECODER.KTX2Decoder)):(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,Cs._DecoderModulePromise=Promise.resolve(new KTX2DECODER.KTX2Decoder))}constructor(e,i=Cs.DefaultNumWorkers){this._engine=e,Cs._Initialize(i)}uploadAsync(e,i,s){const n=this._engine.getCaps(),a={astc:!!n.astc,bptc:!!n.bptc,s3tc:!!n.s3tc,pvrtc:!!n.pvrtc,etc2:!!n.etc2,etc1:!!n.etc1};if(Cs._WorkerPoolPromise)return Cs._WorkerPoolPromise.then(p=>new Promise((_,g)=>{p.push((y,b)=>{const v=F=>{y.removeEventListener("error",v),y.removeEventListener("message",S),g(F),b()},S=F=>{if(F.data.action==="decoded"){if(y.removeEventListener("error",v),y.removeEventListener("message",S),!F.data.success)g({message:F.data.msg});else try{this._createTexture(F.data.decodedData,i,s),_()}catch(L){g({message:L})}b()}};y.addEventListener("error",v),y.addEventListener("message",S),y.postMessage({action:"setDefaultDecoderOptions",options:Cs.DefaultDecoderOptions._getKTX2DecoderOptions()});const M=new Uint8Array(e.byteLength);M.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),y.postMessage({action:"decode",data:M,caps:a,options:s},[M.buffer])})}));if(Cs._DecoderModulePromise)return Cs._DecoderModulePromise.then(p=>(Cs.DefaultDecoderOptions.isDirty&&(KTX2DECODER.KTX2Decoder.DefaultDecoderOptions=Cs.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise((_,g)=>{p.decode(e,n).then(y=>{this._createTexture(y,i),_()}).catch(y=>{g({message:y})})})));throw new Error("KTX2 decoder module is not available")}_createTexture(e,i,s){this._engine._bindTextureDirectly(3553,i),s&&(s.transcodedFormat=e.transcodedFormat,s.isInGammaSpace=e.isInGammaSpace,s.hasAlpha=e.hasAlpha,s.transcoderName=e.transcoderName);let a=!0;switch(e.transcodedFormat){case 32856:i.type=0,i.format=5;break;case 33321:i.type=0,i.format=6;break;case 33323:i.type=0,i.format=7;break;default:i.format=e.transcodedFormat,a=!1;break}if(i._gammaSpace=e.isInGammaSpace,i.generateMipMaps=e.mipmaps.length>1,e.errors)throw new Error("KTX2 container - could not transcode the data. "+e.errors);for(let p=0;p<e.mipmaps.length;++p){const _=e.mipmaps[p];if(!_||!_.data)throw new Error("KTX2 container - could not transcode one of the image");a?(i.width=_.width,i.height=_.height,this._engine._uploadDataToTextureDirectly(i,_.data,0,p,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(i,e.transcodedFormat,_.width,_.height,_.data,0,p)}i._extension=".ktx2",i.width=e.mipmaps[0].width,i.height=e.mipmaps[0].height,i.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(e){if(e.byteLength>=12){const i=new Uint8Array(e.buffer,e.byteOffset,12);if(i[0]===171&&i[1]===75&&i[2]===84&&i[3]===88&&i[4]===32&&i[5]===50&&i[6]===48&&i[7]===187&&i[8]===13&&i[9]===10&&i[10]===26&&i[11]===10)return!0}return!1}}Cs.URLConfig={jsDecoderModule:"https://preview.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},Cs.DefaultNumWorkers=Cs.GetDefaultNumWorkers(),Cs.DefaultDecoderOptions=new Vz;function Gz(){let l;onmessage=e=>{if(!!e.data)switch(e.data.action){case"init":{const i=e.data.urls;importScripts(i.jsDecoderModule),D_(i),l=new KTX2DECODER.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":{KTX2DECODER.KTX2Decoder.DefaultDecoderOptions=e.data.options;break}case"decode":l.decode(e.data.data,e.data.caps,e.data.options).then(i=>{const s=[];for(let n=0;n<i.mipmaps.length;++n){const a=i.mipmaps[n];a&&a.data&&s.push(a.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:i},s)}).catch(i=>{postMessage({action:"decoded",success:!1,msg:i})});break}}}function Wz(l){switch(l){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}class zz{constructor(){this.supportCascades=!1}canLoad(e,i){return e.endsWith(".ktx")||e.endsWith(".ktx2")||i==="image/ktx"||i==="image/ktx2"}loadCubeData(e,i,s,n){if(Array.isArray(e))return;i._invertVScale=!i.invertY;const a=i.getEngine(),p=new Mn(e,6),_=p.numberOfMipmapLevels>1&&i.generateMipMaps;a._unpackFlipY(!0),p.uploadLevels(i,i.generateMipMaps),i.width=p.pixelWidth,i.height=p.pixelHeight,a._setCubeMapTextureParams(i,_,p.numberOfMipmapLevels-1),i.isReady=!0,i.onLoadedObservable.notifyObservers(i),i.onLoadedObservable.clear(),n&&n()}loadData(e,i,s,n){if(Mn.IsValid(e)){i._invertVScale=!i.invertY;const a=new Mn(e,1),p=Wz(a.glInternalFormat);p?(i.format=p,i._useSRGBBuffer=i.getEngine()._getUseSRGBBuffer(!0,i.generateMipMaps),i._gammaSpace=!0):i.format=a.glInternalFormat,s(a.pixelWidth,a.pixelHeight,i.generateMipMaps,!0,()=>{a.uploadLevels(i,i.generateMipMaps)},a.isInvalid)}else Cs.IsValid(e)?new Cs(i.getEngine()).uploadAsync(e,i,n).then(()=>{s(i.width,i.height,i.generateMipMaps,!0,()=>{},!1)},p=>{Ie.Warn(`Failed to load KTX2 texture data: ${p.message}`),s(0,0,!1,!1,()=>{},!0)}):(Ie.Error("texture missing KTX identifier"),s(0,0,!1,!1,()=>{},!0))}}Ae._TextureLoaders.unshift(new zz);class ou extends Vn{constructor(e,i,s){super(e,j.Zero(),i),this._xrSessionManager=s,this._firstFrame=!1,this._referenceQuaternion=Ve.Identity(),this._referencedPosition=new j,this._trackingState=Nc.NOT_TRACKING,this.onBeforeCameraTeleport=new Re,this.onAfterCameraTeleport=new Re,this.onTrackingStateChanged=new Re,this.compensateOnFirstFrame=!0,this._rotate180=new Ve(0,1,0,0),this.minZ=.1,this.rotationQuaternion=new Ve,this.cameraRigMode=wt.RIG_MODE_CUSTOM,this.updateUpVectorFromRotation=!0,this._updateNumberOfRigCameras(1),this.freezeProjectionMatrix(),this._xrSessionManager.onXRSessionInit.add(()=>{this._referencedPosition.copyFromFloats(0,0,0),this._referenceQuaternion.copyFromFloats(0,0,0,1),this._firstFrame=this.compensateOnFirstFrame}),this._xrSessionManager.onXRFrameObservable.add(()=>{this._firstFrame&&this._updateFromXRSession(),this._updateReferenceSpace(),this._updateFromXRSession()},void 0,!0)}get trackingState(){return this._trackingState}_setTrackingState(e){this._trackingState!==e&&(this._trackingState=e,this.onTrackingStateChanged.notifyObservers(e))}get realWorldHeight(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.baseReferenceSpace);return e&&e.transform?e.transform.position.y:0}_updateForDualEyeDebugging(){this._updateNumberOfRigCameras(2),this.rigCameras[0].viewport=new Za(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new Za(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null}setTransformationFromNonVRCamera(e=this.getScene().activeCamera,i=!0){if(!e||e===this)return;e.computeWorldMatrix().decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,Ve.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this._firstFrame=!0,i&&this._xrSessionManager.resetReferenceSpace()}getClassName(){return"WebXRCamera"}setTarget(e){const i=ge.Vector3[1];e.subtractToRef(this.position,i),i.y=0,i.normalize();const s=Math.atan2(i.x,i.z);this.rotationQuaternion.toEulerAnglesToRef(i),Ve.FromEulerAnglesToRef(i.x,s,i.z,this.rotationQuaternion)}dispose(){super.dispose(),this._lastXRViewerPose=void 0}_updateFromXRSession(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.referenceSpace);if(this._lastXRViewerPose=e||void 0,!e){this._setTrackingState(Nc.NOT_TRACKING);return}const i=e.emulatedPosition?Nc.TRACKING_LOST:Nc.TRACKING;if(this._setTrackingState(i),this.minZ!==this._cache.minZ||this.maxZ!==this._cache.maxZ){const s={depthFar:this.maxZ||1e4,depthNear:this.minZ};this._xrSessionManager.updateRenderState(s),this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ}if(e.transform){const s=e.transform.orientation;if(e.transform.orientation.x===void 0)return;const n=e.transform.position;this._referencedPosition.set(n.x,n.y,n.z),this._referenceQuaternion.set(s.x,s.y,s.z,s.w),this._scene.useRightHandedSystem||(this._referencedPosition.z*=-1,this._referenceQuaternion.z*=-1,this._referenceQuaternion.w*=-1),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this._referenceQuaternion),this.position.copyFrom(this._referencedPosition))}this.rigCameras.length!==e.views.length&&this._updateNumberOfRigCameras(e.views.length),e.views.forEach((s,n)=>{var a;const p=this.rigCameras[n];!p.isLeftCamera&&!p.isRightCamera&&(s.eye==="right"?p._isRightCamera=!0:s.eye==="left"&&(p._isLeftCamera=!0));const _=s.transform.position,g=s.transform.orientation;p.parent=this.parent,p.position.set(_.x,_.y,_.z),p.rotationQuaternion.set(g.x,g.y,g.z,g.w),this._scene.useRightHandedSystem?p.rotationQuaternion.multiplyInPlace(this._rotate180):(p.position.z*=-1,p.rotationQuaternion.z*=-1,p.rotationQuaternion.w*=-1),fe.FromFloat32ArrayToRefScaled(s.projectionMatrix,0,1,p._projectionMatrix),this._scene.useRightHandedSystem||p._projectionMatrix.toggleProjectionMatrixHandInPlace(),n===0&&this._projectionMatrix.copyFrom(p._projectionMatrix);const y=this._xrSessionManager.getRenderTargetTextureForView(s);this._renderingMultiview=((a=y?._texture)===null||a===void 0?void 0:a.isMultiview)||!1,this._renderingMultiview?n==0&&(this._xrSessionManager.trySetViewportForView(this.viewport,s),this.outputRenderTarget=y):(this._xrSessionManager.trySetViewportForView(p.viewport,s),p.outputRenderTarget=y||this._xrSessionManager.getRenderTargetTextureForView(s)),p.layerMask=this.layerMask})}_updateNumberOfRigCameras(e=1){for(;this.rigCameras.length<e;){const i=new rs("XR-RigCamera: "+this.rigCameras.length,j.Zero(),this.getScene());i.minZ=.1,i.rotationQuaternion=new Ve,i.updateUpVectorFromRotation=!0,i.isRigCamera=!0,i.rigParent=this,i.freezeProjectionMatrix(),this.rigCameras.push(i)}for(;this.rigCameras.length>e;){const i=this.rigCameras.pop();i&&i.dispose()}}_updateReferenceSpace(){if(!this.position.equals(this._referencedPosition)||!this.rotationQuaternion.equals(this._referenceQuaternion)){const e=ge.Matrix[0],i=ge.Matrix[1],s=ge.Matrix[2];fe.ComposeToRef(ou._ScaleReadOnly,this._referenceQuaternion,this._referencedPosition,e),fe.ComposeToRef(ou._ScaleReadOnly,this.rotationQuaternion,this.position,i),e.invert().multiplyToRef(i,s),s.invert(),this._scene.useRightHandedSystem||s.toggleModelMatrixHandInPlace(),s.decompose(void 0,this._referenceQuaternion,this._referencedPosition);const n=new XRRigidTransform({x:this._referencedPosition.x,y:this._referencedPosition.y,z:this._referencedPosition.z},{x:this._referenceQuaternion.x,y:this._referenceQuaternion.y,z:this._referenceQuaternion.z,w:this._referenceQuaternion.w});this._xrSessionManager.referenceSpace=this._xrSessionManager.referenceSpace.getOffsetReferenceSpace(n)}}}ou._ScaleReadOnly=j.One();class Dr{}Dr.ANCHOR_SYSTEM="xr-anchor-system",Dr.BACKGROUND_REMOVER="xr-background-remover",Dr.HIT_TEST="xr-hit-test",Dr.MESH_DETECTION="xr-mesh-detection",Dr.PHYSICS_CONTROLLERS="xr-physics-controller",Dr.PLANE_DETECTION="xr-plane-detection",Dr.POINTER_SELECTION="xr-controller-pointer-selection",Dr.TELEPORTATION="xr-controller-teleportation",Dr.FEATURE_POINTS="xr-feature-points",Dr.HAND_TRACKING="xr-hand-tracking",Dr.IMAGE_TRACKING="xr-image-tracking",Dr.NEAR_INTERACTION="xr-near-interaction",Dr.DOM_OVERLAY="xr-dom-overlay",Dr.MOVEMENT="xr-controller-movement",Dr.LIGHT_ESTIMATION="xr-light-estimation",Dr.EYE_TRACKING="xr-eye-tracking",Dr.WALKING_LOCOMOTION="xr-walking-locomotion",Dr.LAYERS="xr-layers",Dr.DEPTH_SENSING="xr-depth-sensing";class To{constructor(e){this._xrSessionManager=e,this._features={},this._xrSessionManager.onXRSessionInit.add(()=>{this.getEnabledFeatures().forEach(i=>{const s=this._features[i];s.enabled&&!s.featureImplementation.attached&&!s.featureImplementation.disableAutoAttach&&this.attachFeature(i)})}),this._xrSessionManager.onXRSessionEnded.add(()=>{this.getEnabledFeatures().forEach(i=>{const s=this._features[i];s.enabled&&s.featureImplementation.attached&&this.detachFeature(i)})})}static AddWebXRFeature(e,i,s=1,n=!1){this._AvailableFeatures[e]=this._AvailableFeatures[e]||{latest:s},s>this._AvailableFeatures[e].latest&&(this._AvailableFeatures[e].latest=s),n&&(this._AvailableFeatures[e].stable=s),this._AvailableFeatures[e][s]=i}static ConstructFeature(e,i=1,s,n){const a=this._AvailableFeatures[e][i];if(!a)throw new Error("feature not found");return a(s,n)}static GetAvailableFeatures(){return Object.keys(this._AvailableFeatures)}static GetAvailableVersions(e){return Object.keys(this._AvailableFeatures[e])}static GetLatestVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].latest||-1}static GetStableVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].stable||-1}attachFeature(e){const i=this._features[e];i&&i.enabled&&!i.featureImplementation.attached&&i.featureImplementation.attach()}detachFeature(e){const i=this._features[e];i&&i.featureImplementation.attached&&i.featureImplementation.detach()}disableFeature(e){const i=typeof e=="string"?e:e.Name,s=this._features[i];return s&&s.enabled?(s.enabled=!1,this.detachFeature(i),s.featureImplementation.dispose(),delete this._features[i],!0):!1}dispose(){this.getEnabledFeatures().forEach(e=>{this.disableFeature(e)})}enableFeature(e,i="latest",s={},n=!0,a=!0){const p=typeof e=="string"?e:e.Name;let _=0;if(typeof i=="string"){if(!i)throw new Error(`Error in provided version - ${p} (${i})`);if(i==="stable"?_=To.GetStableVersionOfFeature(p):i==="latest"?_=To.GetLatestVersionOfFeature(p):_=+i,_===-1||isNaN(_))throw new Error(`feature not found - ${p} (${i})`)}else _=i;const g=To._ConflictingFeatures[p];if(g!==void 0&&this.getEnabledFeatures().indexOf(g)!==-1)throw new Error(`Feature ${p} cannot be enabled while ${g} is enabled.`);const y=this._features[p],b=To.ConstructFeature(p,_,this._xrSessionManager,s);if(!b)throw new Error(`feature not found - ${p}`);y&&this.disableFeature(p);const v=b();if(v.dependsOn&&!v.dependsOn.every(M=>!!this._features[M]))throw new Error(`Dependant features missing. Make sure the following features are enabled - ${v.dependsOn.join(", ")}`);if(v.isCompatible())return this._features[p]={featureImplementation:v,enabled:!0,version:_,required:a},n?this._xrSessionManager.session&&!this._features[p].featureImplementation.attached&&this.attachFeature(p):this._features[p].featureImplementation.disableAutoAttach=!0,this._features[p].featureImplementation;if(a)throw new Error("required feature not compatible");return Le.Warn(`Feature ${p} not compatible with the current environment/browser and was not enabled.`),v}getEnabledFeature(e){return this._features[e]&&this._features[e].featureImplementation}getEnabledFeatures(){return Object.keys(this._features)}async _extendXRSessionInitObject(e){const i=this.getEnabledFeatures();for(const s of i){const n=this._features[s],a=n.featureImplementation.xrNativeFeatureName;if(a&&(n.required?(e.requiredFeatures=e.requiredFeatures||[],e.requiredFeatures.indexOf(a)===-1&&e.requiredFeatures.push(a)):(e.optionalFeatures=e.optionalFeatures||[],e.optionalFeatures.indexOf(a)===-1&&e.optionalFeatures.push(a))),n.featureImplementation.getXRSessionInitExtension){const p=await n.featureImplementation.getXRSessionInitExtension();e={...e,...p}}}return e}}To._AvailableFeatures={},To._ConflictingFeatures={[Dr.TELEPORTATION]:Dr.MOVEMENT,[Dr.MOVEMENT]:Dr.TELEPORTATION};class F_{constructor(e){this._scene=e,this._nonVRCamera=null,this._attachedToElement=!1,this._spectatorCamera=null,this._originalSceneAutoClear=!0,this._supported=!1,this._spectatorMode=!1,this._lastTimestamp=0,this.onInitialXRPoseSetObservable=new Re,this.onStateChangedObservable=new Re,this.state=ns.NOT_IN_XR,this.sessionManager=new G2(e),this.camera=new ou("webxr",e,this.sessionManager),this.featuresManager=new To(this.sessionManager),e.onDisposeObservable.addOnce(()=>{this.dispose()})}static CreateAsync(e){const i=new F_(e);return i.sessionManager.initializeAsync().then(()=>(i._supported=!0,i)).catch(s=>{throw i._setState(ns.NOT_IN_XR),i.dispose(),s})}dispose(){var e;this.exitXRAsync(),this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),(e=this._spectatorCamera)===null||e===void 0||e.dispose(),this._nonVRCamera&&(this._scene.activeCamera=this._nonVRCamera)}async enterXRAsync(e,i,s=this.sessionManager.getWebXRRenderTarget(),n={}){var a,p,_;if(!this._supported)throw"WebXR not supported in this browser or environment";this._setState(ns.ENTERING_XR),i!=="viewer"&&i!=="local"&&(n.optionalFeatures=n.optionalFeatures||[],n.optionalFeatures.push(i)),n=await this.featuresManager._extendXRSessionInitObject(n),e==="immersive-ar"&&i!=="unbounded"&&Ie.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode");try{await this.sessionManager.initializeSessionAsync(e,n),await this.sessionManager.setReferenceSpaceTypeAsync(i);const g=await s.initializeXRLayerAsync(this.sessionManager.session),y={depthFar:this.camera.maxZ||1e4,depthNear:this.camera.minZ};return this.featuresManager.getEnabledFeature(Dr.LAYERS)||(y.baseLayer=g),this.sessionManager.updateRenderState(y),this.sessionManager.runXRRenderLoop(),this._originalSceneAutoClear=this._scene.autoClear,this._nonVRCamera=this._scene.activeCamera,this._attachedToElement=!!(!((p=(a=this._nonVRCamera)===null||a===void 0?void 0:a.inputs)===null||p===void 0)&&p.attachedToElement),(_=this._nonVRCamera)===null||_===void 0||_.detachControl(),this._scene.activeCamera=this.camera,e!=="immersive-ar"?this._nonXRToXRCamera():(this._scene.autoClear=!1,this.camera.compensateOnFirstFrame=!1,this.camera.position.set(0,0,0),this.camera.rotationQuaternion.set(0,0,0,1)),this.sessionManager.onXRSessionEnded.addOnce(()=>{this.state!==ns.EXITING_XR&&this._setState(ns.EXITING_XR),this.camera.rigCameras.forEach(b=>{b.outputRenderTarget=null}),this._scene.autoClear=this._originalSceneAutoClear,this._scene.activeCamera=this._nonVRCamera,this._attachedToElement&&this._nonVRCamera&&this._nonVRCamera.attachControl(!!this._nonVRCamera.inputs.noPreventDefault),e!=="immersive-ar"&&this.camera.compensateOnFirstFrame&&(this._nonVRCamera.setPosition?this._nonVRCamera.setPosition(this.camera.position):this._nonVRCamera.position.copyFrom(this.camera.position)),this._setState(ns.NOT_IN_XR)}),this.sessionManager.onXRFrameObservable.addOnce(()=>{this._setState(ns.IN_XR)}),this.sessionManager}catch(g){throw console.log(g),console.log(g.message),this._setState(ns.NOT_IN_XR),g}}exitXRAsync(){return this.state!==ns.IN_XR?Promise.resolve():(this._setState(ns.EXITING_XR),this.sessionManager.exitXRAsync())}enableSpectatorMode(e){this._spectatorMode||(this._spectatorMode=!0,this._switchSpectatorMode(e))}disableSpecatatorMode(){this._spectatorMode&&(this._spectatorMode=!1,this._switchSpectatorMode())}_switchSpectatorMode(e){const i=e?.fps?e.fps:1e3,s=1/i*1e3,n=e?.preferredCameraIndex?e?.preferredCameraIndex:0,a=()=>{this._spectatorCamera&&this.sessionManager.currentTimestamp-this._lastTimestamp>=s&&(this._lastTimestamp=this.sessionManager.currentTimestamp,this._spectatorCamera.position.copyFrom(this.camera.rigCameras[n].globalPosition),this._spectatorCamera.rotationQuaternion.copyFrom(this.camera.rigCameras[n].absoluteRotation))};if(this._spectatorMode){if(n>=this.camera.rigCameras.length)throw new Error("the preferred camera index is beyond the length of rig camera array.");const p=()=>{this.state===ns.IN_XR?(this._spectatorCamera=new M2("webxr-spectator",j.Zero(),this._scene),this._spectatorCamera.rotationQuaternion=new Ve,this._scene.activeCameras=[this.camera,this._spectatorCamera],this.sessionManager.onXRFrameObservable.add(a),this._scene.onAfterRenderCameraObservable.add(_=>{_===this.camera&&(this._scene.getEngine().framebufferDimensionsObject=null)})):this.state===ns.EXITING_XR&&(this.sessionManager.onXRFrameObservable.removeCallback(a),this._scene.activeCameras=null)};this.onStateChangedObservable.add(p),p()}else this.sessionManager.onXRFrameObservable.removeCallback(a),this._scene.activeCameras=[this.camera]}_nonXRToXRCamera(){this.camera.setTransformationFromNonVRCamera(this._nonVRCamera),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)}_setState(e){this.state!==e&&(this.state=e,this.onStateChangedObservable.notifyObservers(this.state))}}class Ko{constructor(e,i,s=-1,n=[]){this.id=e,this.type=i,this._buttonIndex=s,this._axesIndices=n,this._axes={x:0,y:0},this._changes={},this._currentValue=0,this._hasChanges=!1,this._pressed=!1,this._touched=!1,this.onAxisValueChangedObservable=new Re,this.onButtonStateChangedObservable=new Re}get axes(){return this._axes}get changes(){return this._changes}get hasChanges(){return this._hasChanges}get pressed(){return this._pressed}get touched(){return this._touched}get value(){return this._currentValue}dispose(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()}isAxes(){return this._axesIndices.length!==0}isButton(){return this._buttonIndex!==-1}update(e){let i=!1,s=!1;if(this._hasChanges=!1,this._changes={},this.isButton()){const n=e.buttons[this._buttonIndex];if(!n)return;this._currentValue!==n.value&&(this.changes.value={current:n.value,previous:this._currentValue},i=!0,this._currentValue=n.value),this._touched!==n.touched&&(this.changes.touched={current:n.touched,previous:this._touched},i=!0,this._touched=n.touched),this._pressed!==n.pressed&&(this.changes.pressed={current:n.pressed,previous:this._pressed},i=!0,this._pressed=n.pressed)}this.isAxes()&&(this._axes.x!==e.axes[this._axesIndices[0]]&&(this.changes.axes={current:{x:e.axes[this._axesIndices[0]],y:this._axes.y},previous:{x:this._axes.x,y:this._axes.y}},this._axes.x=e.axes[this._axesIndices[0]],s=!0),this._axes.y!==e.axes[this._axesIndices[1]]&&(this.changes.axes?this.changes.axes.current.y=e.axes[this._axesIndices[1]]:this.changes.axes={current:{x:this._axes.x,y:e.axes[this._axesIndices[1]]},previous:{x:this._axes.x,y:this._axes.y}},this._axes.y=e.axes[this._axesIndices[1]],s=!0)),i&&(this._hasChanges=!0,this.onButtonStateChangedObservable.notifyObservers(this)),s&&(this._hasChanges=!0,this.onAxisValueChangedObservable.notifyObservers(this._axes))}}Ko.BUTTON_TYPE="button",Ko.SQUEEZE_TYPE="squeeze",Ko.THUMBSTICK_TYPE="thumbstick",Ko.TOUCHPAD_TYPE="touchpad",Ko.TRIGGER_TYPE="trigger";class wS{constructor(e,i,s,n,a=!1,p){this.scene=e,this.layout=i,this.gamepadObject=s,this.handedness=n,this._doNotLoadControllerMesh=a,this._controllerCache=p,this._initComponent=_=>{if(!_)return;const g=this.layout.components[_],y=g.type,b=g.gamepadIndices.button,v=[];g.gamepadIndices.xAxis!==void 0&&g.gamepadIndices.yAxis!==void 0&&v.push(g.gamepadIndices.xAxis,g.gamepadIndices.yAxis),this.components[_]=new Ko(_,y,b,v)},this._modelReady=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new Re,i.components&&Object.keys(i.components).forEach(this._initComponent)}dispose(){this.getComponentIds().forEach(e=>this.getComponent(e).dispose()),this.rootMesh&&(this.rootMesh.getChildren(void 0,!0).forEach(e=>{e.setEnabled(!1)}),this.rootMesh.dispose(!!this._controllerCache,!this._controllerCache))}getAllComponentsOfType(e){return this.getComponentIds().map(i=>this.components[i]).filter(i=>i.type===e)}getComponent(e){return this.components[e]}getComponentIds(){return Object.keys(this.components)}getComponentOfType(e){return this.getAllComponentsOfType(e)[0]||null}getMainComponent(){return this.getComponent(this.layout.selectComponentId)}async loadModel(){const e=!this._getModelLoadingConstraints();let i=this._getGenericFilenameAndPath();return e?Ie.Warn("Falling back to generic models"):i=this._getFilenameAndPath(),new Promise((s,n)=>{const a=p=>{e?this._getGenericParentMesh(p):this._setRootMesh(p),this._processLoadedModel(p),this._modelReady=!0,this.onModelLoadedObservable.notifyObservers(this),s(!0)};if(this._controllerCache){const p=this._controllerCache.filter(_=>_.filename===i.filename&&_.path===i.path);if(p[0]){p[0].meshes.forEach(_=>_.setEnabled(!0)),a(p[0].meshes);return}}ki.ImportMesh("",i.path,i.filename,this.scene,p=>{this._controllerCache&&this._controllerCache.push({...i,meshes:p}),a(p)},null,(p,_)=>{Ie.Log(_),Ie.Warn(`Failed to retrieve controller model of type ${this.profileId} from the remote server: ${i.path}${i.filename}`),n(_)})})}updateFromXRFrame(e){this.getComponentIds().forEach(i=>this.getComponent(i).update(this.gamepadObject)),this.updateModel(e)}get handness(){return this.handedness}pulse(e,i,s=0){return this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[s]?this.gamepadObject.hapticActuators[s].pulse(e,i):Promise.resolve(!1)}_getChildByName(e,i){return e.getChildren(s=>s.name===i,!1)[0]}_getImmediateChildByName(e,i){return e.getChildren(s=>s.name==i,!0)[0]}_lerpTransform(e,i,s){if(!e.minMesh||!e.maxMesh||!e.valueMesh||!e.minMesh.rotationQuaternion||!e.maxMesh.rotationQuaternion||!e.valueMesh.rotationQuaternion)return;const n=s?i*.5+.5:i;Ve.SlerpToRef(e.minMesh.rotationQuaternion,e.maxMesh.rotationQuaternion,n,e.valueMesh.rotationQuaternion),j.LerpToRef(e.minMesh.position,e.maxMesh.position,n,e.valueMesh.position)}updateModel(e){!this._modelReady||this._updateModel(e)}_getGenericFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getGenericParentMesh(e){this.rootMesh=new Qe(this.profileId+" "+this.handedness,this.scene),e.forEach(i=>{i.parent||(i.isPickable=!1,i.setParent(this.rootMesh))}),this.rootMesh.rotationQuaternion=Ve.FromEulerAngles(0,Math.PI,0)}}class xu extends wS{constructor(e,i,s){super(e,Hz[s],i,s),this.profileId=xu.ProfileId}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){this.rootMesh=new Qe(this.profileId+" "+this.handedness,this.scene),e.forEach(i=>{i.isPickable=!1,i.parent||i.setParent(this.rootMesh)}),this.rootMesh.rotationQuaternion=Ve.FromEulerAngles(0,Math.PI,0)}_updateModel(){}}xu.ProfileId="generic-trigger";const Hz={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}};function DS(l){const e=l.segments||32,i=l.diameterX||l.diameter||1,s=l.diameterY||l.diameter||1,n=l.diameterZ||l.diameter||1,a=l.arc&&(l.arc<=0||l.arc>1)?1:l.arc||1,p=l.slice&&l.slice<=0?1:l.slice||1,_=l.sideOrientation===0?0:l.sideOrientation||Mt.DEFAULTSIDE,g=!!l.dedupTopBottomIndices,y=new j(i/2,s/2,n/2),b=2+e,v=2*b,S=[],M=[],F=[],L=[];for(let k=0;k<=b;k++){const G=k/b,H=G*Math.PI*p;for(let z=0;z<=v;z++){const W=z/v,Y=W*Math.PI*2*a,Z=fe.RotationZ(-H),Q=fe.RotationY(Y),se=j.TransformCoordinates(j.Up(),Z),$=j.TransformCoordinates(se,Q),oe=$.multiply(y),ue=$.divide(y).normalize();M.push(oe.x,oe.y,oe.z),F.push(ue.x,ue.y,ue.z),L.push(W,wr.UseOpenGLOrientationForUV?1-G:G)}if(k>0){const z=M.length/3;for(let W=z-2*(v+1);W+v+2<z;W++)g?(k>1&&(S.push(W),S.push(W+1),S.push(W+v+1)),(k<b||p<1)&&(S.push(W+v+1),S.push(W+1),S.push(W+v+2))):(S.push(W),S.push(W+1),S.push(W+v+1),S.push(W+v+1),S.push(W+1),S.push(W+v+2))}}Mt._ComputeSides(_,M,S,F,L,l.frontUVs,l.backUVs);const N=new Mt;return N.indices=S,N.positions=M,N.normals=F,N.uvs=L,N}function lu(l,e={},i=null){const s=new Qe(l,i);return e.sideOrientation=Qe._GetDefaultSideOrientation(e.sideOrientation),s._originalBuilderSideOrientation=e.sideOrientation,DS(e).applyToMesh(s,e.updatable),s}const qq={CreateSphere:lu};Mt.CreateSphere=DS,Qe.CreateSphere=(l,e,i,s,n,a)=>lu(l,{segments:e,diameterX:i,diameterY:i,diameterZ:i,sideOrientation:a,updatable:n},s);class Xz extends wS{constructor(e,i,s,n,a){super(e,s.layouts[i.handedness||"none"],i.gamepad,i.handedness,void 0,a),this._repositoryUrl=n,this.controllerCache=a,this._buttonMeshMapping={},this._touchDots={},this.profileId=s.profileId}dispose(){super.dispose(),this.controllerCache||Object.keys(this._touchDots).forEach(e=>{this._touchDots[e].dispose()})}_getFilenameAndPath(){return{filename:this.layout.assetPath,path:`${this._repositoryUrl}/profiles/${this.profileId}/`}}_getModelLoadingConstraints(){const e=ki.IsPluginForExtensionAvailable(".glb");return e||Ie.Warn("glTF / glb loader was not registered, using generic controller instead"),e}_processLoadedModel(e){this.getComponentIds().forEach(i=>{const s=this.layout.components[i];this._buttonMeshMapping[i]={mainMesh:this._getChildByName(this.rootMesh,s.rootNodeName),states:{}},Object.keys(s.visualResponses).forEach(n=>{const a=s.visualResponses[n];if(a.valueNodeProperty==="transform")this._buttonMeshMapping[i].states[n]={valueMesh:this._getChildByName(this.rootMesh,a.valueNodeName),minMesh:this._getChildByName(this.rootMesh,a.minNodeName),maxMesh:this._getChildByName(this.rootMesh,a.maxNodeName)};else{const p=s.type===Ko.TOUCHPAD_TYPE&&s.touchPointNodeName?s.touchPointNodeName:a.valueNodeName;if(this._buttonMeshMapping[i].states[n]={valueMesh:this._getChildByName(this.rootMesh,p)},s.type===Ko.TOUCHPAD_TYPE&&!this._touchDots[n]){const _=lu(n+"dot",{diameter:.0015,segments:8},this.scene);_.material=new ot(n+"mat",this.scene),_.material.diffuseColor=qe.Red(),_.parent=this._buttonMeshMapping[i].states[n].valueMesh||null,_.isVisible=!1,this._touchDots[n]=_}}})})}_setRootMesh(e){this.rootMesh=new Qe(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;let i;for(let s=0;s<e.length;s++){const n=e[s];n.isPickable=!1,n.parent||(i=n)}i&&i.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(oa.Y,Math.PI,Ki.WORLD)}_updateModel(e){this.disableAnimation||this.getComponentIds().forEach(i=>{const s=this.getComponent(i);if(!s.hasChanges)return;const n=this._buttonMeshMapping[i],a=this.layout.components[i];Object.keys(a.visualResponses).forEach(p=>{const _=a.visualResponses[p];let g=s.value;if(_.componentProperty==="xAxis"?g=s.axes.x:_.componentProperty==="yAxis"&&(g=s.axes.y),_.valueNodeProperty==="transform")this._lerpTransform(n.states[p],g,_.componentProperty!=="button");else{const y=n.states[p].valueMesh;y&&(y.isVisible=s.touched||s.pressed),this._touchDots[p]&&(this._touchDots[p].isVisible=s.touched||s.pressed)}})})}}const L_=[];class hn{static ClearProfilesCache(){this._ProfilesList=null,this._ProfileLoadingPromises={}}static DefaultFallbacks(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("generic-hand-select",["generic-trigger"])}static FindFallbackWithProfileId(e){const i=this._Fallbacks[e]||[];return i.unshift(e),i}static GetMotionControllerWithXRInput(e,i,s){const n=[];if(s&&n.push(s),n.push(...e.profiles||[]),n.length&&!n[0]&&n.pop(),e.gamepad&&e.gamepad.id)switch(e.gamepad.id){case(e.gamepad.id.match(/oculus touch/gi)?e.gamepad.id:void 0):n.push("oculus-touch-v2");break}const a=n.indexOf("windows-mixed-reality");if(a!==-1&&n.splice(a,0,"microsoft-mixed-reality"),n.length||n.push("generic-trigger"),this.UseOnlineRepository){const p=this.PrioritizeOnlineRepository?this._LoadProfileFromRepository:this._LoadProfilesFromAvailableControllers,_=this.PrioritizeOnlineRepository?this._LoadProfilesFromAvailableControllers:this._LoadProfileFromRepository;return p.call(this,n,e,i).catch(()=>_.call(this,n,e,i))}else return this._LoadProfilesFromAvailableControllers(n,e,i)}static RegisterController(e,i){this._AvailableControllers[e]=i}static RegisterFallbacksForProfileId(e,i){this._Fallbacks[e]?this._Fallbacks[e].push(...i):this._Fallbacks[e]=i}static UpdateProfilesList(){return this._ProfilesList=Le.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1).then(e=>JSON.parse(e.toString())),this._ProfilesList}static ClearControllerCache(){L_.forEach(e=>{e.meshes.forEach(i=>{i.dispose(!1,!0)})}),L_.length=0}static _LoadProfileFromRepository(e,i,s){return Promise.resolve().then(()=>this._ProfilesList?this._ProfilesList:this.UpdateProfilesList()).then(n=>{for(let a=0;a<e.length;++a)if(!!e[a]&&n[e[a]])return e[a];throw new Error(`neither controller ${e[0]} nor all fallbacks were found in the repository,`)}).then(n=>(this._ProfileLoadingPromises[n]||(this._ProfileLoadingPromises[n]=Le.LoadFileAsync(`${this.BaseRepositoryUrl}/profiles/${n}/profile.json`,!1).then(a=>JSON.parse(a))),this._ProfileLoadingPromises[n])).then(n=>new Xz(s,i,n,this.BaseRepositoryUrl,this.DisableControllerCache?void 0:L_))}static _LoadProfilesFromAvailableControllers(e,i,s){for(let n=0;n<e.length;++n){if(!e[n])continue;const a=this.FindFallbackWithProfileId(e[n]);for(let p=0;p<a.length;++p){const _=this._AvailableControllers[a[p]];if(_)return Promise.resolve(_(i,s))}}throw new Error("no controller requested was found in the available controllers list")}}hn._AvailableControllers={},hn._Fallbacks={},hn._ProfileLoadingPromises={},hn.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist",hn.PrioritizeOnlineRepository=!0,hn.UseOnlineRepository=!0,hn.DisableControllerCache=!0,hn.RegisterController(xu.ProfileId,(l,e)=>new xu(e,l.gamepad,l.handedness)),hn.DefaultFallbacks();let Yz=0;class Kz{constructor(e,i,s={}){this._scene=e,this.inputSource=i,this._options=s,this._tmpVector=new j,this._disposed=!1,this.onDisposeObservable=new Re,this.onMeshLoadedObservable=new Re,this.onMotionControllerInitObservable=new Re,this._uniqueId=`controller-${Yz++}-${i.targetRayMode}-${i.handedness}`,this.pointer=new Ds(`${this._uniqueId}-pointer`,e),this.pointer.rotationQuaternion=new Ve,this.inputSource.gripSpace&&(this.grip=new Ds(`${this._uniqueId}-grip`,this._scene),this.grip.rotationQuaternion=new Ve),this._tmpVector.set(0,0,this._scene.useRightHandedSystem?-1:1),this.inputSource.gamepad&&this.inputSource.targetRayMode==="tracked-pointer"&&hn.GetMotionControllerWithXRInput(i,e,this._options.forceControllerProfile).then(n=>{this.motionController=n,this.onMotionControllerInitObservable.notifyObservers(n),!this._options.doNotLoadControllerMesh&&!this.motionController._doNotLoadControllerMesh&&this.motionController.loadModel().then(a=>{var p;a&&this.motionController&&this.motionController.rootMesh&&(this._options.renderingGroupId&&(this.motionController.rootMesh.renderingGroupId=this._options.renderingGroupId,this.motionController.rootMesh.getChildMeshes(!1).forEach(_=>_.renderingGroupId=this._options.renderingGroupId)),this.onMeshLoadedObservable.notifyObservers(this.motionController.rootMesh),this.motionController.rootMesh.parent=this.grip||this.pointer,this.motionController.disableAnimation=!!this._options.disableMotionControllerAnimation),this._disposed&&((p=this.motionController)===null||p===void 0||p.dispose())})},()=>{Le.Warn("Could not find a matching motion controller for the registered input source")})}get uniqueId(){return this._uniqueId}dispose(){this.grip&&this.grip.dispose(!0),this.motionController&&this.motionController.dispose(),this.pointer.dispose(!0),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._disposed=!0}getWorldPointerRayToRef(e,i=!1){const s=i&&this.grip?this.grip:this.pointer;j.TransformNormalToRef(this._tmpVector,s.getWorldMatrix(),e.direction),e.direction.normalize(),e.origin.copyFrom(s.absolutePosition),e.length=1e3}updateFromXRFrame(e,i,s){const n=e.getPose(this.inputSource.targetRaySpace,i);if(this._lastXRPose=n,n){const a=n.transform.position;this.pointer.position.set(a.x,a.y,a.z);const p=n.transform.orientation;this.pointer.rotationQuaternion.set(p.x,p.y,p.z,p.w),this._scene.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1),this.pointer.parent=s.parent}if(this.inputSource.gripSpace&&this.grip){const a=e.getPose(this.inputSource.gripSpace,i);if(a){const p=a.transform.position,_=a.transform.orientation;this.grip.position.set(p.x,p.y,p.z),this.grip.rotationQuaternion.set(_.x,_.y,_.z,_.w),this._scene.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}this.grip.parent=s.parent}this.motionController&&this.motionController.updateFromXRFrame(e)}}class jz{constructor(e,i,s={}){if(this.xrSessionManager=e,this.xrCamera=i,this._options=s,this.controllers=[],this.onControllerAddedObservable=new Re,this.onControllerRemovedObservable=new Re,this._onInputSourcesChange=n=>{this._addAndRemoveControllers(n.added,n.removed)},this._sessionEndedObserver=this.xrSessionManager.onXRSessionEnded.add(()=>{this._addAndRemoveControllers([],this.controllers.map(n=>n.inputSource))}),this._sessionInitObserver=this.xrSessionManager.onXRSessionInit.add(n=>{n.addEventListener("inputsourceschange",this._onInputSourcesChange)}),this._frameObserver=this.xrSessionManager.onXRFrameObservable.add(n=>{this.controllers.forEach(a=>{a.updateFromXRFrame(n,this.xrSessionManager.referenceSpace,this.xrCamera)})}),this._options.customControllersRepositoryURL&&(hn.BaseRepositoryUrl=this._options.customControllersRepositoryURL),hn.UseOnlineRepository=!this._options.disableOnlineControllerRepository,hn.UseOnlineRepository)try{hn.UpdateProfilesList().catch(()=>{hn.UseOnlineRepository=!1})}catch{hn.UseOnlineRepository=!1}}_addAndRemoveControllers(e,i){const s=this.controllers.map(p=>p.inputSource);for(const p of e)if(s.indexOf(p)===-1){const _=new Kz(this.xrSessionManager.scene,p,{...this._options.controllerOptions||{},forceControllerProfile:this._options.forceInputProfile,doNotLoadControllerMesh:this._options.doNotLoadControllerMeshes,disableMotionControllerAnimation:this._options.disableControllerAnimation});this.controllers.push(_),this.onControllerAddedObservable.notifyObservers(_)}const n=[],a=[];this.controllers.forEach(p=>{i.indexOf(p.inputSource)===-1?n.push(p):a.push(p)}),this.controllers=n,a.forEach(p=>{this.onControllerRemovedObservable.notifyObservers(p),p.dispose()})}dispose(){this.controllers.forEach(e=>{e.dispose()}),this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver),this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver),this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear(),hn.ClearControllerCache()}}class N_{constructor(e){this._xrSessionManager=e,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this.xrNativeFeatureName=""}get attached(){return this._attached}attach(e){if(this.isDisposed)return!1;if(e)this.attached&&this.detach();else if(this.attached)return!1;return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,i=>this._onXRFrame(i)),!0}detach(){return this._attached?(this._attached=!1,this._removeOnDetach.forEach(e=>{e.observable.remove(e.observer)}),!0):(this.disableAutoAttach=!0,!1)}dispose(){this.detach(),this.isDisposed=!0}isCompatible(){return!0}_addNewAttachObserver(e,i){this._removeOnDetach.push({observable:e,observer:e.add(i)})}}class Xr{getRenderCamera(e){if(this._renderCamera)return this._renderCamera;{let i;return this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?i=this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:i=this.originalScene.activeCamera,e&&i&&i.isRigCamera?i.rigParent:i}}setRenderCamera(e){this._renderCamera=e}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new P0("shared gizmo light",new j(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=qe.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return Xr._DefaultUtilityLayer==null?Xr._CreateDefaultUtilityLayerFromScene(Zt.LastCreatedScene):Xr._DefaultUtilityLayer}static _CreateDefaultUtilityLayerFromScene(e){return Xr._DefaultUtilityLayer=new Xr(e),Xr._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{Xr._DefaultUtilityLayer=null}),Xr._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return Xr._DefaultKeepDepthUtilityLayer==null&&(Xr._DefaultKeepDepthUtilityLayer=new Xr(Zt.LastCreatedScene),Xr._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,Xr._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{Xr._DefaultKeepDepthUtilityLayer=null})),Xr._DefaultKeepDepthUtilityLayer}constructor(e,i=!0){this.originalScene=e,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new Re,this.utilityLayerScene=new Nt(e.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=e.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),i&&(this._originalPointerObserver=e.onPrePointerObservable.add(s=>{if(!this.utilityLayerScene.activeCamera||!this.pickingEnabled||!this.processAllEvents&&s.type!==Lt.POINTERMOVE&&s.type!==Lt.POINTERUP&&s.type!==Lt.POINTERDOWN&&s.type!==Lt.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=e.pointerX,this.utilityLayerScene.pointerY=e.pointerY;const n=s.event;if(e.isPointerCaptured(n.pointerId)){this._pointerCaptures[n.pointerId]=!1;return}const a=_=>{let g=null;if(s.nearInteractionPickingInfo)s.nearInteractionPickingInfo.pickedMesh.getScene()==_?g=s.nearInteractionPickingInfo:g=new In;else if(_!==this.utilityLayerScene&&s.originalPickingInfo)g=s.originalPickingInfo;else{let y=null;this._renderCamera&&(y=_._activeCamera,_._activeCamera=this._renderCamera,s.ray=null),g=s.ray?_.pickWithRay(s.ray):_.pick(e.pointerX,e.pointerY),y&&(_._activeCamera=y)}return g},p=a(this.utilityLayerScene);if(!s.ray&&p&&(s.ray=p.ray),this.utilityLayerScene.onPrePointerObservable.notifyObservers(s),this.onlyCheckPointerDownEvents&&s.type!=Lt.POINTERDOWN){s.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new qa(s.type,s.event,p),s.type),s.type===Lt.POINTERUP&&this._pointerCaptures[n.pointerId]&&(this._pointerCaptures[n.pointerId]=!1);return}if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)p&&p.hit&&(s.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new qa(s.type,s.event,p),s.type),s.skipOnPointerObservable=!0);else{const _=a(e),g=s.event;_&&p&&(p.distance===0&&_.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(_.pickedMesh)?(this._notifyObservers(s,_,g),s.skipOnPointerObservable=!0):s.type===Lt.POINTERDOWN?this._pointerCaptures[g.pointerId]=!0:(s.type===Lt.POINTERMOVE||s.type===Lt.POINTERUP)&&(this._lastPointerEvents[g.pointerId]&&(this.onPointerOutObservable.notifyObservers(g.pointerId),delete this._lastPointerEvents[g.pointerId]),this._notifyObservers(s,_,g)):!this._pointerCaptures[g.pointerId]&&(p.distance<_.distance||_.distance===0)?(this._notifyObservers(s,p,g),s.skipOnPointerObservable||(s.skipOnPointerObservable=p.distance>0)):!this._pointerCaptures[g.pointerId]&&p.distance>=_.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(_.pickedMesh)?(this._notifyObservers(s,_,g),s.skipOnPointerObservable=!0):((s.type===Lt.POINTERMOVE||s.type===Lt.POINTERUP)&&this._lastPointerEvents[g.pointerId]&&(this.onPointerOutObservable.notifyObservers(g.pointerId),delete this._lastPointerEvents[g.pointerId]),this._notifyObservers(s,p,g))),s.type===Lt.POINTERUP&&this._pointerCaptures[g.pointerId]&&(this._pointerCaptures[g.pointerId]=!1))}}),this._originalPointerObserver&&e.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add(s=>{this.shouldRender&&s==this.getRenderCamera()&&this.render()}),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add(()=>{this.dispose()}),this._updateCamera()}_notifyObservers(e,i,s){e.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new qa(e.type,e.event,i),e.type),this._lastPointerEvents[s.pointerId]=!0)}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){const e=this.utilityLayerScene.activeCamera.getScene(),i=this.utilityLayerScene.activeCamera;i._scene=this.utilityLayerScene,i.leftCamera&&(i.leftCamera._scene=this.utilityLayerScene),i.rightCamera&&(i.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),i._scene=e,i.leftCamera&&(i.leftCamera._scene=e),i.rightCamera&&(i.rightCamera._scene=e)}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}}Xr._DefaultUtilityLayer=null,Xr._DefaultKeepDepthUtilityLayer=null;class jo extends N_{constructor(e,i){super(e),this._options=i,this._attachController=s=>{if(this._controllers[s.uniqueId])return;const{laserPointer:n,selectionMesh:a}=this._generateNewMeshPair(s.pointer);switch(this._controllers[s.uniqueId]={xrController:s,laserPointer:n,selectionMesh:a,meshUnderPointer:null,pick:null,tmpRay:new wi(new j,new j),disabledByNearInteraction:!1,id:jo._IdCounter++},this._attachedController?!this._options.enablePointerSelectionOnAllControllers&&this._options.preferredHandedness&&s.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=s.uniqueId):this._options.enablePointerSelectionOnAllControllers||(this._attachedController=s.uniqueId),s.inputSource.targetRayMode){case"tracked-pointer":return this._attachTrackedPointerRayMode(s);case"gaze":return this._attachGazeMode(s);case"screen":return this._attachScreenRayMode(s)}},this._controllers={},this._tmpVectorForPickCompare=new j,this.disablePointerLighting=!0,this.disableSelectionMeshLighting=!0,this.displayLaserPointer=!0,this.displaySelectionMesh=!0,this.laserPointerPickedColor=new qe(.9,.9,.9),this.laserPointerDefaultColor=new qe(.7,.7,.7),this.selectionMeshDefaultColor=new qe(.8,.8,.8),this.selectionMeshPickedColor=new qe(.3,.3,1),this._identityMatrix=fe.Identity(),this._screenCoordinatesRef=j.Zero(),this._viewportRef=new Za(0,0,0,0),this._scene=this._xrSessionManager.scene}attach(){if(!super.attach())return!1;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._scene.constantlyUpdateMeshUnderPointer=!0,this._options.gazeCamera){const e=this._options.gazeCamera,{laserPointer:i,selectionMesh:s}=this._generateNewMeshPair(e);this._controllers.camera={webXRCamera:e,laserPointer:i,selectionMesh:s,meshUnderPointer:null,pick:null,tmpRay:new wi(new j,new j),disabledByNearInteraction:!1,id:jo._IdCounter++},this._attachGazeMode()}return!0}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),!0):!1}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const i=Object.keys(this._controllers);for(let s=0;s<i.length;++s)if(this._controllers[i[s]].id===e)return this._controllers[i[s]].xrController||null;return null}_getPointerSelectionDisabledByPointerId(e){const i=Object.keys(this._controllers);for(let s=0;s<i.length;++s)if(this._controllers[i[s]].id===e)return this._controllers[i[s]].disabledByNearInteraction;return!0}_setPointerSelectionDisabledByPointerId(e,i){const s=Object.keys(this._controllers);for(let n=0;n<s.length;++n)if(this._controllers[s[n]].id===e){this._controllers[s[n]].disabledByNearInteraction=i;return}}_onXRFrame(e){Object.keys(this._controllers).forEach(i=>{const s=this._controllers[i];if(!this._options.enablePointerSelectionOnAllControllers&&i!==this._attachedController||s.disabledByNearInteraction){s.selectionMesh.isVisible=!1,s.laserPointer.isVisible=!1,s.pick=null;return}s.laserPointer.isVisible=this.displayLaserPointer;let n;if(s.xrController)n=s.xrController.pointer.position,s.xrController.getWorldPointerRayToRef(s.tmpRay);else if(s.webXRCamera)n=s.webXRCamera.position,s.webXRCamera.getForwardRayToRef(s.tmpRay);else return;if(this._options.maxPointerDistance&&(s.tmpRay.length=this._options.maxPointerDistance),!this._options.disableScenePointerVectorUpdate&&n){const g=this._xrSessionManager.scene,y=this._options.xrInput.xrCamera;y&&(y.viewport.toGlobalToRef(g.getEngine().getRenderWidth(),g.getEngine().getRenderHeight(),this._viewportRef),j.ProjectToRef(n,this._identityMatrix,g.getTransformMatrix(),this._viewportRef,this._screenCoordinatesRef),typeof this._screenCoordinatesRef.x=="number"&&typeof this._screenCoordinatesRef.y=="number"&&!isNaN(this._screenCoordinatesRef.x)&&!isNaN(this._screenCoordinatesRef.y)&&(g.pointerX=this._screenCoordinatesRef.x,g.pointerY=this._screenCoordinatesRef.y,s.screenCoordinates={x:this._screenCoordinatesRef.x,y:this._screenCoordinatesRef.y}))}let a=null;this._utilityLayerScene&&(a=this._utilityLayerScene.pickWithRay(s.tmpRay,this._utilityLayerScene.pointerMovePredicate||this.raySelectionPredicate));const p=this._scene.pickWithRay(s.tmpRay,this._scene.pointerMovePredicate||this.raySelectionPredicate);!a||!a.hit?s.pick=p:!p||!p.hit||a.distance<p.distance?s.pick=a:s.pick=p,s.pick&&s.xrController&&(s.pick.aimTransform=s.xrController.pointer,s.pick.gripTransform=s.xrController.grip||null);const _=s.pick;if(_&&_.pickedPoint&&_.hit){this._updatePointerDistance(s.laserPointer,_.distance),s.selectionMesh.position.copyFrom(_.pickedPoint),s.selectionMesh.scaling.x=Math.sqrt(_.distance),s.selectionMesh.scaling.y=Math.sqrt(_.distance),s.selectionMesh.scaling.z=Math.sqrt(_.distance);const g=this._convertNormalToDirectionOfRay(_.getNormal(!0),s.tmpRay),y=.001;if(s.selectionMesh.position.copyFrom(_.pickedPoint),g){const b=j.Cross(oa.Y,g),v=j.Cross(g,b);j.RotationFromAxisToRef(v,g,b,s.selectionMesh.rotation),s.selectionMesh.position.addInPlace(g.scale(y))}s.selectionMesh.isVisible=this.displaySelectionMesh,s.meshUnderPointer=_.pickedMesh}else s.selectionMesh.isVisible=!1,this._updatePointerDistance(s.laserPointer,1),s.meshUnderPointer=null})}get _utilityLayerScene(){return this._options.customUtilityLayerScene||Xr.DefaultUtilityLayer.utilityLayerScene}_attachGazeMode(e){const i=this._controllers[e&&e.uniqueId||"camera"],s=this._options.timeToSelect||3e3,n=this._options.useUtilityLayer?this._utilityLayerScene:this._scene;let a=new In;const p=Tl("selection",{diameter:.0035*15,thickness:.0025*6,tessellation:20},n);p.isVisible=!1,p.isPickable=!1,p.parent=i.selectionMesh;let _=0,g=!1;const y={pointerId:i.id,pointerType:"xr"};i.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{if(!!i.pick){if(this._augmentPointerInit(y,i.id,i.screenCoordinates),i.laserPointer.material.alpha=0,p.isVisible=!1,i.pick.hit)if(this._pickingMoved(a,i.pick))g&&(this._options.disablePointerUpOnTouchOut||this._scene.simulatePointerUp(i.pick,y)),g=!1,_=0;else if(_>s/10&&(p.isVisible=!0),_+=this._scene.getEngine().getDeltaTime(),_>=s)this._scene.simulatePointerDown(i.pick,y),g=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(i.pick,y),p.isVisible=!1;else{const b=1-_/s;p.scaling.set(b,b,b)}else g=!1,_=0;this._scene.simulatePointerMove(i.pick,y),a=i.pick}}),this._options.renderingGroupId!==void 0&&(p.renderingGroupId=this._options.renderingGroupId),e&&e.onDisposeObservable.addOnce(()=>{i.pick&&!this._options.disablePointerUpOnTouchOut&&g&&(this._scene.simulatePointerUp(i.pick,y),i.finalPointerUpTriggered=!0),p.dispose()})}_attachScreenRayMode(e){const i=this._controllers[e.uniqueId];let s=!1;const n={pointerId:i.id,pointerType:"xr"};i.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{this._augmentPointerInit(n,i.id,i.screenCoordinates),!(!i.pick||this._options.disablePointerUpOnTouchOut&&s)&&(s?this._scene.simulatePointerMove(i.pick,n):(this._scene.simulatePointerDown(i.pick,n),i.pointerDownTriggered=!0,s=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(i.pick,n)))}),e.onDisposeObservable.addOnce(()=>{this._augmentPointerInit(n,i.id,i.screenCoordinates),this._xrSessionManager.runInXRFrame(()=>{i.pick&&!i.finalPointerUpTriggered&&s&&!this._options.disablePointerUpOnTouchOut&&(this._scene.simulatePointerUp(i.pick,n),i.finalPointerUpTriggered=!0)})})}_attachTrackedPointerRayMode(e){const i=this._controllers[e.uniqueId];if(this._options.forceGazeMode)return this._attachGazeMode(e);const s={pointerId:i.id,pointerType:"xr"};if(i.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{i.laserPointer.material.disableLighting=this.disablePointerLighting,i.selectionMesh.material.disableLighting=this.disableSelectionMeshLighting,i.pick&&(this._augmentPointerInit(s,i.id,i.screenCoordinates),this._scene.simulatePointerMove(i.pick,s))}),e.inputSource.gamepad){const n=a=>{this._options.overrideButtonId&&(i.selectionComponent=a.getComponent(this._options.overrideButtonId)),i.selectionComponent||(i.selectionComponent=a.getMainComponent()),i.onButtonChangedObserver=i.selectionComponent.onButtonStateChangedObservable.add(p=>{if(p.changes.pressed){const _=p.changes.pressed.current;i.pick?(this._options.enablePointerSelectionOnAllControllers||e.uniqueId===this._attachedController)&&(this._augmentPointerInit(s,i.id,i.screenCoordinates),_?(this._scene.simulatePointerDown(i.pick,s),i.pointerDownTriggered=!0,i.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,i.laserPointer.material.emissiveColor=this.laserPointerPickedColor):(this._scene.simulatePointerUp(i.pick,s),i.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,i.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)):_&&!this._options.enablePointerSelectionOnAllControllers&&!this._options.disableSwitchOnClick&&(this._attachedController=e.uniqueId)}})};e.motionController?n(e.motionController):e.onMotionControllerInitObservable.add(n)}else{const n=p=>{this._augmentPointerInit(s,i.id,i.screenCoordinates),i.xrController&&p.inputSource===i.xrController.inputSource&&i.pick&&(this._scene.simulatePointerDown(i.pick,s),i.pointerDownTriggered=!0,i.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,i.laserPointer.material.emissiveColor=this.laserPointerPickedColor)},a=p=>{this._augmentPointerInit(s,i.id,i.screenCoordinates),i.xrController&&p.inputSource===i.xrController.inputSource&&i.pick&&(this._scene.simulatePointerUp(i.pick,s),i.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,i.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)};i.eventListeners={selectend:a,selectstart:n},this._xrSessionManager.session.addEventListener("selectstart",n),this._xrSessionManager.session.addEventListener("selectend",a)}}_convertNormalToDirectionOfRay(e,i){return e&&Math.acos(j.Dot(e,i.direction))<Math.PI/2&&e.scaleInPlace(-1),e}_detachController(e){const i=this._controllers[e];if(!!i){if(i.selectionComponent&&i.onButtonChangedObserver&&i.selectionComponent.onButtonStateChangedObservable.remove(i.onButtonChangedObserver),i.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(i.onFrameObserver),i.eventListeners&&Object.keys(i.eventListeners).forEach(s=>{const n=i.eventListeners&&i.eventListeners[s];n&&this._xrSessionManager.session.removeEventListener(s,n)}),!i.finalPointerUpTriggered&&i.pointerDownTriggered){const s={pointerId:i.id,pointerType:"xr"};this._xrSessionManager.runInXRFrame(()=>{this._augmentPointerInit(s,i.id,i.screenCoordinates),this._scene.simulatePointerUp(i.pick||new In,s),i.finalPointerUpTriggered=!0})}this._xrSessionManager.scene.onBeforeRenderObservable.addOnce(()=>{try{if(i.selectionMesh.dispose(),i.laserPointer.dispose(),delete this._controllers[e],this._attachedController===e){const s=Object.keys(this._controllers);s.length?this._attachedController=s[0]:this._attachedController=""}}catch{Le.Warn("controller already detached.")}})}}_generateNewMeshPair(e){const i=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Xr.DefaultUtilityLayer.utilityLayerScene:this._scene,s=this._options.customLasterPointerMeshGenerator?this._options.customLasterPointerMeshGenerator():tu("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},i);s.parent=e;const n=new ot("laserPointerMat",i);n.emissiveColor=this.laserPointerDefaultColor,n.alpha=.7,s.material=n,s.rotation.x=Math.PI/2,this._updatePointerDistance(s,1),s.isPickable=!1,s.isVisible=!1;const a=this._options.customSelectionMeshGenerator?this._options.customSelectionMeshGenerator():Tl("gazeTracker",{diameter:.0035*3,thickness:.0025*3,tessellation:20},i);a.bakeCurrentTransformIntoVertices(),a.isPickable=!1,a.isVisible=!1;const p=new ot("targetMat",i);return p.specularColor=qe.Black(),p.emissiveColor=this.selectionMeshDefaultColor,p.backFaceCulling=!1,a.material=p,this._options.renderingGroupId!==void 0&&(s.renderingGroupId=this._options.renderingGroupId,a.renderingGroupId=this._options.renderingGroupId),{laserPointer:s,selectionMesh:a}}_pickingMoved(e,i){var s;if(!e.hit||!i.hit||!e.pickedMesh||!e.pickedPoint||!i.pickedMesh||!i.pickedPoint||e.pickedMesh!==i.pickedMesh)return!0;(s=e.pickedPoint)===null||s===void 0||s.subtractToRef(i.pickedPoint,this._tmpVectorForPickCompare),this._tmpVectorForPickCompare.set(Math.abs(this._tmpVectorForPickCompare.x),Math.abs(this._tmpVectorForPickCompare.y),Math.abs(this._tmpVectorForPickCompare.z));const n=(this._options.gazeModePointerMovedFactor||1)*.01*i.distance;return this._tmpVectorForPickCompare.length()>n}_updatePointerDistance(e,i=100){e.scaling.y=i,this._scene.useRightHandedSystem&&(i*=-1),e.position.z=i/2+.05}_augmentPointerInit(e,i,s){e.pointerId=i,e.pointerType="xr",s&&(e.screenX=s.x,e.screenY=s.y)}get lasterPointerDefaultColor(){return this.laserPointerDefaultColor}}jo._IdCounter=200,jo.Name=Dr.POINTER_SELECTION,jo.Version=1,To.AddWebXRFeature(jo.Name,(l,e)=>()=>new jo(l,e),jo.Version,!0);var Ke;(function(l){l[l.Float=1]="Float",l[l.Int=2]="Int",l[l.Vector2=4]="Vector2",l[l.Vector3=8]="Vector3",l[l.Vector4=16]="Vector4",l[l.Color3=32]="Color3",l[l.Color4=64]="Color4",l[l.Matrix=128]="Matrix",l[l.Object=256]="Object",l[l.AutoDetect=1024]="AutoDetect",l[l.BasedOnInput=2048]="BasedOnInput",l[l.All=4095]="All"})(Ke||(Ke={}));var Ct;(function(l){l[l.Vertex=1]="Vertex",l[l.Fragment=2]="Fragment",l[l.Neutral=4]="Neutral",l[l.VertexAndFragment=3]="VertexAndFragment"})(Ct||(Ct={}));class FS{constructor(){this.supportUniformBuffers=!1,this.attributes=new Array,this.uniforms=new Array,this.constants=new Array,this.samplers=new Array,this.functions={},this.extensions={},this.counters={},this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}finalize(e){const i=e.sharedData.emitComments,s=this.target===Ct.Fragment;this.compilationString=`\r
${i?`//Entry point\r
`:""}void main(void) {\r
${this.compilationString}`,this._constantDeclaration&&(this.compilationString=`\r
${i?`//Constants\r
`:""}${this._constantDeclaration}\r
${this.compilationString}`);let n="";for(const a in this.functions)n+=this.functions[a]+`\r
`;this.compilationString=`\r
${n}\r
${this.compilationString}`,!s&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}\r
${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}\r
${this._injectAtEnd}`),this.compilationString=`${this.compilationString}\r
}`,this.sharedData.varyingDeclaration&&(this.compilationString=`\r
${i?`//Varyings\r
`:""}${this.sharedData.varyingDeclaration}\r
${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`\r
${i?`//Samplers\r
`:""}${this._samplerDeclaration}\r
${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`\r
${i?`//Uniforms\r
`:""}${this._uniformDeclaration}\r
${this.compilationString}`),this._attributeDeclaration&&!s&&(this.compilationString=`\r
${i?`//Attributes\r
`:""}${this._attributeDeclaration}\r
${this.compilationString}`),this.compilationString=`precision highp float;\r
`+this.compilationString,this.compilationString=`#if defined(WEBGL2) || defines(WEBGPU)\r
precision highp sampler2DArray;\r
#endif\r
`+this.compilationString;for(const a in this.extensions){const p=this.extensions[a];this.compilationString=`\r
${p}\r
${this.compilationString}`}this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return e=e.replace(/[^a-zA-Z_]+/g,""),this.sharedData.variableNames[e]===void 0?(this.sharedData.variableNames[e]=0,e==="output"||e==="texture"?e+this.sharedData.variableNames[e]:e):(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return this.sharedData.defineNames[e]===void 0?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2D ${e};\r
`,this.samplers.push(e))}_emit2DArraySampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2DArray ${e};\r
`,this.samplers.push(e))}_getGLType(e){switch(e){case Ke.Float:return"float";case Ke.Int:return"int";case Ke.Vector2:return"vec2";case Ke.Color3:case Ke.Vector3:return"vec3";case Ke.Color4:case Ke.Vector4:return"vec4";case Ke.Matrix:return"mat4"}return""}_emitExtension(e,i,s=""){this.extensions[e]||(s&&(i=`#if ${s}\r
${i}\r
#endif`),this.extensions[e]=i)}_emitFunction(e,i,s){this.functions[e]||(this.sharedData.emitComments&&(i=s+`\r
`+i),this.functions[e]=i)}_emitCodeFromInclude(e,i,s){if(s&&s.repeatKey)return`#include<${e}>${s.substitutionVars?"("+s.substitutionVars+")":""}[0..${s.repeatKey}]\r
`;let n=ir.IncludesShadersStore[e]+`\r
`;if(this.sharedData.emitComments&&(n=i+`\r
`+n),!s)return n;if(s.replaceStrings)for(let a=0;a<s.replaceStrings.length;a++){const p=s.replaceStrings[a];n=n.replace(p.search,p.replace)}return n}_emitFunctionFromInclude(e,i,s,n=""){const a=e+n;if(!this.functions[a]){if(!s||!s.removeAttributes&&!s.removeUniforms&&!s.removeVaryings&&!s.removeIfDef&&!s.replaceStrings){s&&s.repeatKey?this.functions[a]=`#include<${e}>${s.substitutionVars?"("+s.substitutionVars+")":""}[0..${s.repeatKey}]\r
`:this.functions[a]=`#include<${e}>${s?.substitutionVars?"("+s?.substitutionVars+")":""}\r
`,this.sharedData.emitComments&&(this.functions[a]=i+`\r
`+this.functions[a]);return}if(this.functions[a]=ir.IncludesShadersStore[e],this.sharedData.emitComments&&(this.functions[a]=i+`\r
`+this.functions[a]),s.removeIfDef&&(this.functions[a]=this.functions[a].replace(/^\s*?#ifdef.+$/gm,""),this.functions[a]=this.functions[a].replace(/^\s*?#endif.*$/gm,""),this.functions[a]=this.functions[a].replace(/^\s*?#else.*$/gm,""),this.functions[a]=this.functions[a].replace(/^\s*?#elif.*$/gm,"")),s.removeAttributes&&(this.functions[a]=this.functions[a].replace(/^\s*?attribute.+$/gm,"")),s.removeUniforms&&(this.functions[a]=this.functions[a].replace(/^\s*?uniform.+$/gm,"")),s.removeVaryings&&(this.functions[a]=this.functions[a].replace(/^\s*?varying.+$/gm,"")),s.replaceStrings)for(let p=0;p<s.replaceStrings.length;p++){const _=s.replaceStrings[p];this.functions[a]=this.functions[a].replace(_.search,_.replace)}}}_registerTempVariable(e){return this.sharedData.temps.indexOf(e)!==-1?!1:(this.sharedData.temps.push(e),!0)}_emitVaryingFromString(e,i,s="",n=!1){return this.sharedData.varyings.indexOf(e)!==-1?!1:(this.sharedData.varyings.push(e),s&&(s.startsWith("defined(")?this.sharedData.varyingDeclaration+=`#if ${s}\r
`:this.sharedData.varyingDeclaration+=`${n?"#ifndef":"#ifdef"} ${s}\r
`),this.sharedData.varyingDeclaration+=`varying ${i} ${e};\r
`,s&&(this.sharedData.varyingDeclaration+=`#endif\r
`),!0)}_emitUniformFromString(e,i,s="",n=!1){this.uniforms.indexOf(e)===-1&&(this.uniforms.push(e),s&&(s.startsWith("defined(")?this._uniformDeclaration+=`#if ${s}\r
`:this._uniformDeclaration+=`${n?"#ifndef":"#ifdef"} ${s}\r
`),this._uniformDeclaration+=`uniform ${i} ${e};\r
`,s&&(this._uniformDeclaration+=`#endif\r
`))}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}}class qz{constructor(){this.temps=new Array,this.varyings=new Array,this.varyingDeclaration="",this.inputBlocks=new Array,this.textureBlocks=new Array,this.bindableBlocks=new Array,this.forcedBindableBlocks=new Array,this.blocksWithFallbacks=new Array,this.blocksWithDefines=new Array,this.repeatableContentBlocks=new Array,this.dynamicUniformBlocks=new Array,this.blockingBlocks=new Array,this.animatedInputs=new Array,this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}emitErrors(){let e="";!this.checks.emitVertex&&!this.allowEmptyVertexProgram&&(e+=`NodeMaterial does not have a vertex output. You need to at least add a block that generates a glPosition value.\r
`),this.checks.emitFragment||(e+=`NodeMaterial does not have a fragment output. You need to at least add a block that generates a glFragColor value.\r
`);for(const i of this.checks.notConnectedNonOptionalInputs)e+=`input ${i.name} from block ${i.ownerBlock.name}[${i.ownerBlock.getClassName()}] is not connected and is not optional.\r
`;if(e)throw`Build of NodeMaterial failed:\r
`+e}}var Eo;(function(l){l[l.Compatible=0]="Compatible",l[l.TypeIncompatible=1]="TypeIncompatible",l[l.TargetIncompatible=2]="TargetIncompatible",l[l.HierarchyIssue=3]="HierarchyIssue"})(Eo||(Eo={}));var cu;(function(l){l[l.Input=0]="Input",l[l.Output=1]="Output"})(cu||(cu={}));class hu{static AreEquivalentTypes(e,i){switch(e){case Ke.Vector3:{if(i===Ke.Color3)return!0;break}case Ke.Vector4:{if(i===Ke.Color4)return!0;break}case Ke.Color3:{if(i===Ke.Vector3)return!0;break}case Ke.Color4:{if(i===Ke.Vector4)return!0;break}}return!1}get direction(){return this._direction}get associatedVariableName(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.associatedVariableName:this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}get type(){if(this._type===Ke.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type}if(this._type===Ke.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get target(){return!this._prioritizeVertex||!this._ownerBlock?this._target:this._target!==Ct.VertexAndFragment?this._target:this._ownerBlock.target===Ct.Fragment?Ct.Fragment:Ct.Vertex}set target(e){this._target=e}get isConnected(){return this.connectedPoint!==null||this.hasEndpoints}get isConnectedToInputBlock(){return this.connectedPoint!==null&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return this._endpoints.length===0?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===Ct.Vertex||(e.ownerBlock.target===Ct.Neutral||e.ownerBlock.target===Ct.VertexAndFragment)&&e.ownerBlock.outputs.some(i=>i.isDirectlyConnectedToVertexOutput))return!0;return!1}get isConnectedInVertexShader(){if(this.target===Ct.Vertex)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===Ct.Vertex||e.target===Ct.Vertex||(e.ownerBlock.target===Ct.Neutral||e.ownerBlock.target===Ct.VertexAndFragment)&&e.ownerBlock.outputs.some(i=>i.isConnectedInVertexShader))return!0;return!1}get isConnectedInFragmentShader(){if(this.target===Ct.Fragment)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===Ct.Fragment||(e.ownerBlock.target===Ct.Neutral||e.ownerBlock.target===Ct.VertexAndFragment)&&e.ownerBlock.outputs.some(i=>i.isConnectedInFragmentShader))return!0;return!1}createCustomInputBlock(){return null}constructor(e,i,s){this._connectedPoint=null,this._endpoints=new Array,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this._linkedConnectionSource=null,this._acceptedConnectionPointType=null,this._type=Ke.Float,this._enforceAssociatedVariableName=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=new Array,this.excludedConnectionPointTypes=new Array,this.onConnectionObservable=new Re,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=Ct.VertexAndFragment,this._ownerBlock=i,this.name=e,this._direction=s}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===Eo.Compatible}checkCompatibilityState(e){const i=this._ownerBlock,s=e.ownerBlock;if(i.target===Ct.Fragment){if(s.target===Ct.Vertex)return Eo.TargetIncompatible;for(const p of s.outputs)if(p.ownerBlock.target!=Ct.Neutral&&p.isConnectedInVertexShader)return Eo.TargetIncompatible}if(this.type!==e.type&&e.innerType!==Ke.AutoDetect)return hu.AreEquivalentTypes(this.type,e.type)||e.acceptedConnectionPointTypes&&e.acceptedConnectionPointTypes.indexOf(this.type)!==-1||e._acceptedConnectionPointType&&hu.AreEquivalentTypes(e._acceptedConnectionPointType.type,this.type)?Eo.Compatible:Eo.TypeIncompatible;if(e.excludedConnectionPointTypes&&e.excludedConnectionPointTypes.indexOf(this.type)!==-1)return Eo.TypeIncompatible;let n=s,a=i;return this.direction===cu.Input&&(n=i,a=s),n.isAnAncestorOf(a)?Eo.HierarchyIssue:Eo.Compatible}connectTo(e,i=!1){if(!i&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const i=this._endpoints.indexOf(e);return i===-1?this:(this._endpoints.splice(i,1),e._connectedPoint=null,this._enforceAssociatedVariableName=!1,e._enforceAssociatedVariableName=!1,this)}addExcludedConnectionPointFromAllowedTypes(e){let i=1;for(;i<Ke.All;)e&i||this.excludedConnectionPointTypes.push(i),i=i<<1}serialize(e=!0){const i={};return i.name=this.name,i.displayName=this.displayName,e&&this.connectedPoint&&(i.inputName=this.name,i.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,i.targetConnectionName=this.connectedPoint.name,i.isExposedOnFrame=!0,i.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(i.isExposedOnFrame=!0,i.exposedPortPosition=this.exposedPortPosition),i}dispose(){this.onConnectionObservable.clear()}}class Ca{get name(){return this._name}set name(e){!this.validateBlockName(e)||(this._name=e)}get isUnique(){return this._isUnique}get isFinalMerger(){return this._isFinalMerger}get isInput(){return this._isInput}get buildId(){return this._buildId}set buildId(e){this._buildId=e}get target(){return this._target}set target(e){(this._target&e)===0&&(this._target=e)}get inputs(){return this._inputs}get outputs(){return this._outputs}getInputByName(e){const i=this._inputs.filter(s=>s.name===e);return i.length?i[0]:null}getOutputByName(e){const i=this._outputs.filter(s=>s.name===e);return i.length?i[0]:null}constructor(e,i=Ct.Vertex,s=!1,n=!1){this._isFinalMerger=!1,this._isInput=!1,this._name="",this._isUnique=!1,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=i,this._originalTargetIsNeutral=i===Ct.Neutral,this._isFinalMerger=s,this._isInput=n,this._name=e,this.uniqueId=n_.UniqueId}_setInitialTarget(e){this._target=e,this._originalTargetIsNeutral=e===Ct.Neutral}initialize(e){}bind(e,i,s,n){}_declareOutput(e,i){return`${i._getGLType(e.type)} ${e.associatedVariableName}`}_writeVariable(e){return e.connectedPoint?`${e.associatedVariableName}`:"0."}_writeFloat(e){let i=e.toString();return i.indexOf(".")===-1&&(i+=".0"),`${i}`}getClassName(){return"NodeMaterialBlock"}registerInput(e,i,s=!1,n,a){return a=a??new hu(e,this,cu.Input),a.type=i,a.isOptional=s,n&&(a.target=n),this._inputs.push(a),this}registerOutput(e,i,s,n){return n=n??new hu(e,this,cu.Output),n.type=i,s&&(n.target=s),this._outputs.push(n),this}getFirstAvailableInput(e=null){for(const i of this._inputs)if(!i.connectedPoint&&(!e||e.type===i.type||i.type===Ke.AutoDetect))return i;return null}getFirstAvailableOutput(e=null){for(const i of this._outputs)if(!e||!e.target||e.target===Ct.Neutral||(e.target&i.target)!==0)return i;return null}getSiblingOutput(e){const i=this._outputs.indexOf(e);return i===-1||i>=this._outputs.length?null:this._outputs[i+1]}isAnAncestorOf(e){for(const i of this._outputs)if(!!i.hasEndpoints){for(const s of i.endpoints)if(s.ownerBlock===e||s.ownerBlock.isAnAncestorOf(e))return!0}return!1}connectTo(e,i){if(this._outputs.length===0)return;let s=i&&i.output?this.getOutputByName(i.output):this.getFirstAvailableOutput(e),n=!0;for(;n;){const a=i&&i.input?e.getInputByName(i.input):e.getFirstAvailableInput(s);if(s&&a&&s.canConnectTo(a))s.connectTo(a),n=!1;else if(s)s=this.getSiblingOutput(s);else throw"Unable to find a compatible match"}return this}_buildBlock(e){}updateUniformsAndSamples(e,i,s,n){}provideFallbacks(e,i){}initializeDefines(e,i,s,n=!1){}prepareDefines(e,i,s,n=!1,a){}autoConfigure(e){}replaceRepeatableContent(e,i,s,n){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return this.isInput||this.isFinalMerger||this._outputs.some(e=>e.isDirectlyConnectedToVertexOutput)||this.target===Ct.Vertex?!1:!!((this.target===Ct.VertexAndFragment||this.target===Ct.Neutral)&&this._outputs.some(e=>e.isConnectedInVertexShader))}isReady(e,i,s,n=!1){return!0}_linkConnectionTypes(e,i,s=!1){s?this._inputs[i]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[i],this._inputs[i]._linkedConnectionSource=this._inputs[e]}_processBuild(e,i,s,n){e.build(i,n);const a=i._vertexState!=null,p=e._buildTarget===Ct.Vertex&&e.target!==Ct.VertexAndFragment;if(a&&((e.target&e._buildTarget)===0||(e.target&s.target)===0||this.target!==Ct.VertexAndFragment&&p)&&(!e.isInput&&i.target!==e._buildTarget||e.isInput&&e.isAttribute&&!e._noContextSwitch)){const _=s.connectedPoint;i._vertexState._emitVaryingFromString("v_"+_.associatedVariableName,i._getGLType(_.type))&&(i._vertexState.compilationString+=`${"v_"+_.associatedVariableName} = ${_.associatedVariableName};\r
`),s.associatedVariableName="v_"+_.associatedVariableName,s._enforceAssociatedVariableName=!0}}validateBlockName(e){const i=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"];for(const s of i)if(e===s)return!1;return!0}build(e,i){if(this._buildId===e.sharedData.buildId)return!0;if(!this.isInput)for(const s of this._outputs)s.associatedVariableName||(s.associatedVariableName=e._getFreeVariableName(s.name));for(const s of this._inputs){if(!s.connectedPoint){s.isOptional||e.sharedData.checks.notConnectedNonOptionalInputs.push(s);continue}if(this.target!==Ct.Neutral&&((s.target&this.target)===0||(s.target&e.target)===0))continue;const n=s.connectedPoint.ownerBlock;n&&n!==this&&this._processBuild(n,e,s,i)}if(this._buildId===e.sharedData.buildId)return!0;if(e.sharedData.verbose&&console.log(`${e.target===Ct.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(e.target){case Ct.Vertex:e.sharedData.checks.emitVertex=!0;break;case Ct.Fragment:e.sharedData.checks.emitFragment=!0;break}!this.isInput&&e.sharedData.emitComments&&(e.compilationString+=`\r
//${this.name}\r
`),this._buildBlock(e),this._buildId=e.sharedData.buildId,this._buildTarget=e.target;for(const s of this._outputs)if((s.target&e.target)!==0)for(const n of s.endpoints){const a=n.ownerBlock;a&&(a.target&e.target)!==0&&i.indexOf(a)!==-1&&this._processBuild(a,e,n,i)}return!1}_inputRename(e){return e}_outputRename(e){return e}_dumpPropertiesCode(){const e=this._codeVariableName;return`${e}.visibleInInspector = ${this.visibleInInspector};\r
${e}.visibleOnFrame = ${this.visibleOnFrame};\r
${e}.target = ${this.target};\r
`}_dumpCode(e,i){i.push(this);let s;const n=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=n||`${this.getClassName()}_${this.uniqueId}`,e.indexOf(this._codeVariableName)!==-1){let a=0;do a++,this._codeVariableName=n+a;while(e.indexOf(this._codeVariableName)!==-1)}e.push(this._codeVariableName),s=`\r
// ${this.getClassName()}\r
`,this.comments&&(s+=`// ${this.comments}\r
`),s+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");\r
`,s+=this._dumpPropertiesCode();for(const a of this.inputs){if(!a.isConnected)continue;const _=a.connectedPoint.ownerBlock;i.indexOf(_)===-1&&(s+=_._dumpCode(e,i))}for(const a of this.outputs)if(!!a.hasEndpoints)for(const p of a.endpoints){const _=p.ownerBlock;_&&i.indexOf(_)===-1&&(s+=_._dumpCode(e,i))}return s}_dumpCodeForOutputConnections(e){let i="";if(e.indexOf(this)!==-1)return i;e.push(this);for(const s of this.inputs){if(!s.isConnected)continue;const n=s.connectedPoint,a=n.ownerBlock;i+=a._dumpCodeForOutputConnections(e),i+=`${a._codeVariableName}.${a._outputRename(n.name)}.connectTo(${this._codeVariableName}.${this._inputRename(s.name)});\r
`}return i}clone(e,i=""){const s=this.serialize(),n=Ka(s.customType);if(n){const a=new n;return a._deserialize(s,e,i),a}return null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleInInspector=this.visibleInInspector,e.visibleOnFrame=this.visibleOnFrame,e.target=this.target,e.inputs=[],e.outputs=[];for(const i of this.inputs)e.inputs.push(i.serialize());for(const i of this.outputs)e.outputs.push(i.serialize(!1));return e}_deserialize(e,i,s){var n;this.name=e.name,this.comments=e.comments,this.visibleInInspector=!!e.visibleInInspector,this.visibleOnFrame=!!e.visibleOnFrame,this._target=(n=e.target)!==null&&n!==void 0?n:this.target,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const i=e.inputs,s=e.outputs;i&&i.forEach((n,a)=>{n.displayName&&(this.inputs[a].displayName=n.displayName),n.isExposedOnFrame&&(this.inputs[a].isExposedOnFrame=n.isExposedOnFrame,this.inputs[a].exposedPortPosition=n.exposedPortPosition)}),s&&s.forEach((n,a)=>{n.displayName&&(this.outputs[a].displayName=n.displayName),n.isExposedOnFrame&&(this.outputs[a].isExposedOnFrame=n.isExposedOnFrame,this.outputs[a].exposedPortPosition=n.exposedPortPosition)})}dispose(){for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose()}}class B_ extends Ca{constructor(e){super(e,Ct.Neutral),this.complementW=1,this.complementZ=0,this.target=Ct.Vertex,this.registerInput("vector",Ke.AutoDetect),this.registerInput("transform",Ke.Matrix),this.registerOutput("output",Ke.Vector4),this.registerOutput("xyz",Ke.Vector3),this._inputs[0].onConnectionObservable.add(i=>{if(i.ownerBlock.isInput){const s=i.ownerBlock;(s.name==="normal"||s.name==="tangent")&&(this.complementW=0)}})}getClassName(){return"TransformBlock"}get vector(){return this._inputs[0]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}get transform(){return this._inputs[1]}_buildBlock(e){super._buildBlock(e);const i=this.vector,s=this.transform;if(i.connectedPoint){if(this.complementW===0){const n=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",n),e.sharedData.blocksWithDefines.push(this);const a=e._getFreeVariableName(`${s.associatedVariableName}_NUS`);switch(e.compilationString+=`mat3 ${a} = mat3(${s.associatedVariableName});\r
`,e.compilationString+=`#ifdef NONUNIFORMSCALING\r
`,e.compilationString+=`${a} = transposeMat3(inverseMat3(${a}));\r
`,e.compilationString+=`#endif\r
`,i.connectedPoint.type){case Ke.Vector2:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${a} * vec3(${i.associatedVariableName}, ${this._writeFloat(this.complementZ)}), ${this._writeFloat(this.complementW)});\r
`;break;case Ke.Vector3:case Ke.Color3:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${a} * ${i.associatedVariableName}, ${this._writeFloat(this.complementW)});\r
`;break;default:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${a} * ${i.associatedVariableName}.xyz, ${this._writeFloat(this.complementW)});\r
`;break}}else{const n=s.associatedVariableName;switch(i.connectedPoint.type){case Ke.Vector2:e.compilationString+=this._declareOutput(this.output,e)+` = ${n} * vec4(${i.associatedVariableName}, ${this._writeFloat(this.complementZ)}, ${this._writeFloat(this.complementW)});\r
`;break;case Ke.Vector3:case Ke.Color3:e.compilationString+=this._declareOutput(this.output,e)+` = ${n} * vec4(${i.associatedVariableName}, ${this._writeFloat(this.complementW)});\r
`;break;default:e.compilationString+=this._declareOutput(this.output,e)+` = ${n} * ${i.associatedVariableName};\r
`;break}}this.xyz.hasEndpoints&&(e.compilationString+=this._declareOutput(this.xyz,e)+` = ${this.output.associatedVariableName}.xyz;\r
`)}return this}prepareDefines(e,i,s){e.nonUniformScaling&&s.setValue("NONUNIFORMSCALING",!0)}serialize(){const e=super.serialize();return e.complementZ=this.complementZ,e.complementW=this.complementW,e}_deserialize(e,i,s){super._deserialize(e,i,s),this.complementZ=e.complementZ!==void 0?e.complementZ:0,this.complementW=e.complementW!==void 0?e.complementW:1}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.complementZ = ${this.complementZ};\r
`;return e+=`${this._codeVariableName}.complementW = ${this.complementW};\r
`,e}}ur("BABYLON.TransformBlock",B_);class Y2 extends Ca{constructor(e){super(e,Ct.Vertex,!0),this.registerInput("vector",Ke.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this._inputs[0]}_isLogarithmicDepthEnabled(e){for(const i of e)if(i.useLogarithmicDepth)return!0;return!1}_buildBlock(e){super._buildBlock(e);const i=this.vector;return e.compilationString+=`gl_Position = ${i.associatedVariableName};\r
`,this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes)&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.compilationString+=`vFragmentDepth = 1.0 + gl_Position.w;\r
`,e.compilationString+=`gl_Position.z = log2(max(0.000001, vFragmentDepth)) * logarithmicDepthConstant;\r
`),this}}ur("BABYLON.VertexOutputBlock",Y2);var Sx;(function(l){l[l.Boolean=0]="Boolean",l[l.Float=1]="Float",l[l.Int=2]="Int",l[l.Vector2=3]="Vector2",l[l.List=4]="List"})(Sx||(Sx={}));function uu(l,e=Sx.Boolean,i="PROPERTIES",s){return(n,a)=>{let p=n._propStore;p||(p=[],n._propStore=p),p.push({propertyName:a,displayName:l,type:e,groupName:i,options:s??{}})}}class Mx extends Ca{constructor(e){super(e,Ct.Fragment,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",Ke.Color4,!0),this.registerInput("rgb",Ke.AutoDetect,!0),this.registerInput("a",Ke.Float,!0),this.rgb.addExcludedConnectionPointFromAllowedTypes(Ke.Color3|Ke.Vector3|Ke.Float)}getClassName(){return"FragmentOutputBlock"}initialize(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")}get rgba(){return this._inputs[0]}get rgb(){return this._inputs[1]}get a(){return this._inputs[2]}prepareDefines(e,i,s){s.setValue(this._linearDefineName,this.convertToLinearSpace,!0),s.setValue(this._gammaDefineName,this.convertToGammaSpace,!0)}bind(e,i,s){this.useLogarithmicDepth&&s&&nt.BindLogDepth(void 0,e,s.getScene())}_buildBlock(e){super._buildBlock(e);const i=this.rgba,s=this.rgb,n=this.a;e.sharedData.hints.needAlphaBlending=i.isConnected||n.isConnected,e.sharedData.blocksWithDefines.push(this),this.useLogarithmicDepth&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.sharedData.bindableBlocks.push(this)),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");const a=`//${this.name}`;if(e._emitFunctionFromInclude("helperFunctions",a),i.connectedPoint)n.isConnected?e.compilationString+=`gl_FragColor = vec4(${i.associatedVariableName}.rgb, ${n.associatedVariableName});\r
`:e.compilationString+=`gl_FragColor = ${i.associatedVariableName};\r
`;else if(s.connectedPoint){let p="1.0";n.connectedPoint&&(p=n.associatedVariableName),s.connectedPoint.type===Ke.Float?e.compilationString+=`gl_FragColor = vec4(${s.associatedVariableName}, ${s.associatedVariableName}, ${s.associatedVariableName}, ${p});\r
`:e.compilationString+=`gl_FragColor = vec4(${s.associatedVariableName}, ${p});\r
`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(i);return e.compilationString+=`#ifdef ${this._linearDefineName}\r
`,e.compilationString+=`gl_FragColor = toLinearSpace(gl_FragColor);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef ${this._gammaDefineName}\r
`,e.compilationString+=`gl_FragColor = toGammaSpace(gl_FragColor);\r
`,e.compilationString+=`#endif\r
`,this.useLogarithmicDepth&&(e.compilationString+=`gl_FragDepthEXT = log2(vFragmentDepth) * logarithmicDepthConstant * 0.5;\r
`),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\r
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\r
`,e+=`${this._codeVariableName}.useLogarithmicDepth = ${this.useLogarithmicDepth};\r
`,e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e}_deserialize(e,i,s){var n;super._deserialize(e,i,s),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=e.convertToLinearSpace,this.useLogarithmicDepth=(n=e.useLogarithmicDepth)!==null&&n!==void 0?n:!1}}J([uu("Convert to gamma space",Sx.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Mx.prototype,"convertToGammaSpace",void 0),J([uu("Convert to linear space",Sx.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Mx.prototype,"convertToLinearSpace",void 0),J([uu("Use logarithmic depth",Sx.Boolean,"PROPERTIES")],Mx.prototype,"useLogarithmicDepth",void 0),ur("BABYLON.FragmentOutputBlock",Mx);var Gs;(function(l){l[l.Uniform=0]="Uniform",l[l.Attribute=1]="Attribute",l[l.Varying=2]="Varying",l[l.Undefined=3]="Undefined"})(Gs||(Gs={}));var _r;(function(l){l[l.World=1]="World",l[l.View=2]="View",l[l.Projection=3]="Projection",l[l.ViewProjection=4]="ViewProjection",l[l.WorldView=5]="WorldView",l[l.WorldViewProjection=6]="WorldViewProjection",l[l.CameraPosition=7]="CameraPosition",l[l.FogColor=8]="FogColor",l[l.DeltaTime=9]="DeltaTime",l[l.CameraParameters=10]="CameraParameters",l[l.MaterialAlpha=11]="MaterialAlpha"})(_r||(_r={}));var Px;(function(l){l[l.None=0]="None",l[l.Time=1]="Time",l[l.RealTime=2]="RealTime"})(Px||(Px={}));const Zz={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},k_={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},LS={particle_texturemask:!0};class Yn extends Ca{get type(){if(this._type===Ke.AutoDetect){if(this.isUniform&&this.value!=null){if(!isNaN(this.value))return this._type=Ke.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=Ke.Vector2,this._type;case"Vector3":return this._type=Ke.Vector3,this._type;case"Vector4":return this._type=Ke.Vector4,this._type;case"Color3":return this._type=Ke.Color3,this._type;case"Color4":return this._type=Ke.Color4,this._type;case"Matrix":return this._type=Ke.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"position":case"normal":case"particle_positionw":return this._type=Ke.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":return this._type=Ke.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"matricesIndicesExtra":case"matricesWeightsExtra":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=Ke.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":return this._type=Ke.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case _r.World:case _r.WorldView:case _r.WorldViewProjection:case _r.View:case _r.ViewProjection:case _r.Projection:return this._type=Ke.Matrix,this._type;case _r.CameraPosition:return this._type=Ke.Vector3,this._type;case _r.FogColor:return this._type=Ke.Color3,this._type;case _r.DeltaTime:case _r.MaterialAlpha:return this._type=Ke.Float,this._type;case _r.CameraParameters:return this._type=Ke.Vector4,this._type}}return this._type}constructor(e,i=Ct.Vertex,s=Ke.AutoDetect){super(e,i,!1,!0),this._mode=Gs.Undefined,this._animationType=Px.None,this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this._systemValue=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new Re,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._type=s,this.setDefaultValue(),this.registerOutput("output",s)}validateBlockName(e){return this.isAttribute?!0:super.validateBlockName(e)}get output(){return this._outputs[0]}setAsAttribute(e){return this._mode=Gs.Attribute,e&&(this.name=e),this}setAsSystemValue(e){return this.systemValue=e,this}get value(){return this._storedValue}set value(e){this.type===Ke.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=Gs.Uniform,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e,this._mode=Gs.Uniform}get associatedVariableName(){return this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get animationType(){return this._animationType}set animationType(e){this._animationType=e}get isUndefined(){return this._mode===Gs.Undefined}get isUniform(){return this._mode===Gs.Uniform}set isUniform(e){this._mode=e?Gs.Uniform:Gs.Undefined,this.associatedVariableName=""}get isAttribute(){return this._mode===Gs.Attribute}set isAttribute(e){this._mode=e?Gs.Attribute:Gs.Undefined,this.associatedVariableName=""}get isVarying(){return this._mode===Gs.Varying}set isVarying(e){this._mode=e?Gs.Varying:Gs.Undefined,this.associatedVariableName=""}get isSystemValue(){return this._systemValue!=null}get systemValue(){return this._systemValue}set systemValue(e){this._mode=Gs.Uniform,this.associatedVariableName="",this._systemValue=e}getClassName(){return"InputBlock"}animate(e){switch(this._animationType){case Px.Time:{this.type===Ke.Float&&(this.value+=e.getAnimationRatio()*.01);break}case Px.RealTime:{this.type===Ke.Float&&(this.value=(na.Now-e.getEngine().startTime)/1e3);break}}}_emitDefine(e){return e[0]==="!"?`#ifndef ${e.substring(1)}\r
`:`#ifdef ${e}\r
`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case Ke.Float:this.value=0;break;case Ke.Vector2:this.value=ii.Zero();break;case Ke.Vector3:this.value=j.Zero();break;case Ke.Vector4:this.value=xr.Zero();break;case Ke.Color3:this.value=qe.White();break;case Ke.Color4:this.value=new pi(1,1,1,1);break;case Ke.Matrix:this.value=fe.Identity();break}}_emitConstant(e){switch(this.type){case Ke.Float:return`${e._emitFloat(this.value)}`;case Ke.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case Ke.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case Ke.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case Ke.Color3:return ji.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&ji.Color3[0].toGammaSpaceToRef(ji.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&ji.Color3[0].toLinearSpaceToRef(ji.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec3(${ji.Color3[0].r}, ${ji.Color3[0].g}, ${ji.Color3[0].b})`;case Ke.Color4:return ji.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&ji.Color4[0].toGammaSpaceToRef(ji.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&ji.Color4[0].toLinearSpaceToRef(ji.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec4(${ji.Color4[0].r}, ${ji.Color4[0].g}, ${ji.Color4[0].b}, ${ji.Color4[0].a})`}return""}get _noContextSwitch(){return k_[this.name]}_emit(e,i){var s;if(this.isUniform){if(this.associatedVariableName||(this.associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(e.constants.indexOf(this.associatedVariableName)!==-1)return;e.constants.push(this.associatedVariableName),e._constantDeclaration+=this._declareOutput(this.output,e)+` = ${this._emitConstant(e)};\r
`;return}if(e.uniforms.indexOf(this.associatedVariableName)!==-1)return;e.uniforms.push(this.associatedVariableName),i&&(e._uniformDeclaration+=this._emitDefine(i)),e._uniformDeclaration+=`uniform ${e._getGLType(this.type)} ${this.associatedVariableName};\r
`,i&&(e._uniformDeclaration+=`#endif\r
`);const n=e.sharedData.hints;if(this._systemValue!==null&&this._systemValue!==void 0)switch(this._systemValue){case _r.WorldView:n.needWorldViewMatrix=!0;break;case _r.WorldViewProjection:n.needWorldViewProjectionMatrix=!0;break}else this._animationType!==Px.None&&e.sharedData.animatedInputs.push(this);return}if(this.isAttribute){if(this.associatedVariableName=(s=Zz[this.name])!==null&&s!==void 0?s:this.name,this.target===Ct.Vertex&&e._vertexState){k_[this.name]?LS[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),i):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),i):this._emit(e._vertexState,i);return}if(e.attributes.indexOf(this.associatedVariableName)!==-1)return;e.attributes.push(this.associatedVariableName),k_[this.name]?LS[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),i):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),i):(i&&(e._attributeDeclaration+=this._emitDefine(i)),e._attributeDeclaration+=`attribute ${e._getGLType(this.type)} ${this.associatedVariableName};\r
`,i&&(e._attributeDeclaration+=`#endif\r
`))}}_transmitWorld(e,i,s,n){if(!this._systemValue)return;const a=this.associatedVariableName;switch(this._systemValue){case _r.World:e.setMatrix(a,i);break;case _r.WorldView:e.setMatrix(a,s);break;case _r.WorldViewProjection:e.setMatrix(a,n);break}}_transmit(e,i,s){if(this.isAttribute)return;const n=this.associatedVariableName;if(this._systemValue){switch(this._systemValue){case _r.World:case _r.WorldView:case _r.WorldViewProjection:return;case _r.View:e.setMatrix(n,i.getViewMatrix());break;case _r.Projection:e.setMatrix(n,i.getProjectionMatrix());break;case _r.ViewProjection:e.setMatrix(n,i.getTransformMatrix());break;case _r.CameraPosition:i.bindEyePosition(e,n,!0);break;case _r.FogColor:e.setColor3(n,i.fogColor);break;case _r.DeltaTime:e.setFloat(n,i.deltaTime/1e3);break;case _r.CameraParameters:i.activeCamera&&e.setFloat4(n,i.getEngine().hasOriginBottomLeft?-1:1,i.activeCamera.minZ,i.activeCamera.maxZ,1/i.activeCamera.maxZ);break;case _r.MaterialAlpha:e.setFloat(n,s.alpha);break}return}const a=this._valueCallback?this._valueCallback():this._storedValue;if(a!==null)switch(this.type){case Ke.Float:e.setFloat(n,a);break;case Ke.Int:e.setInt(n,a);break;case Ke.Color3:ji.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&ji.Color3[0].toGammaSpaceToRef(ji.Color3[0],i.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&ji.Color3[0].toLinearSpaceToRef(ji.Color3[0],i.getEngine().useExactSrgbConversions),e.setColor3(n,ji.Color3[0]);break;case Ke.Color4:ji.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&ji.Color4[0].toGammaSpaceToRef(ji.Color4[0],i.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&ji.Color4[0].toLinearSpaceToRef(ji.Color4[0],i.getEngine().useExactSrgbConversions),e.setDirectColor4(n,ji.Color4[0]);break;case Ke.Vector2:e.setVector2(n,a);break;case Ke.Vector3:e.setVector3(n,a);break;case Ke.Vector4:e.setVector4(n,a);break;case Ke.Matrix:e.setMatrix(n,a);break}}_buildBlock(e){super._buildBlock(e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isAttribute)return super._dumpPropertiesCode()+`${e}.setAsAttribute("${this.name}");\r
`;if(this.isSystemValue)return super._dumpPropertiesCode()+`${e}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${_r[this._systemValue]});\r
`;if(this.isUniform){const i=[];let s="";switch(this.type){case Ke.Float:s=`${this.value}`;break;case Ke.Vector2:s=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case Ke.Vector3:s=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case Ke.Vector4:s=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case Ke.Color3:s=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(s+=".toGammaSpace()"),this.convertToLinearSpace&&(s+=".toLinearSpace()");break;case Ke.Color4:s=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(s+=".toGammaSpace()"),this.convertToLinearSpace&&(s+=".toLinearSpace()");break;case Ke.Matrix:s=`BABYLON.Matrix.FromArray([${this.value.m}])`;break}return i.push(`${e}.value = ${s}`),this.type===Ke.Float&&i.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`,`${e}.isBoolean = ${this.isBoolean}`,`${e}.matrixMode = ${this.matrixMode}`,`${e}.animationType = BABYLON.AnimatedInputBlockTypes.${Px[this.animationType]}`),i.push(`${e}.isConstant = ${this.isConstant}`),i.push(""),super._dumpPropertiesCode()+i.join(`;\r
`)}return super._dumpPropertiesCode()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){const e=super.serialize();return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this._storedValue!=null&&this._mode===Gs.Uniform&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e,i,s){if(this._mode=e.mode,super._deserialize(e,i,s),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.name==="tangent"&&e.mode===Gs.Attribute&&e.type===Ke.Vector3&&(this._type=Ke.Vector4),!!e.valueType)if(e.valueType==="number")this._storedValue=e.value;else{const n=Ka(e.valueType);n&&(this._storedValue=n.FromArray(e.value))}}}ur("BABYLON.InputBlock",Yn);class NS extends Ca{constructor(e){super(e,Ct.VertexAndFragment),this._samplerName="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",Ke.AutoDetect,!1,Ct.VertexAndFragment),this.registerOutput("rgba",Ke.Color4,Ct.Neutral),this.registerOutput("rgb",Ke.Color3,Ct.Neutral),this.registerOutput("r",Ke.Float,Ct.Neutral),this.registerOutput("g",Ke.Float,Ct.Neutral),this.registerOutput("b",Ke.Float,Ct.Neutral),this.registerOutput("a",Ke.Float,Ct.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Ke.Vector2|Ke.Vector3|Ke.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?Ct.VertexAndFragment:Ct.Fragment}prepareDefines(e,i,s){s.setValue(this._linearDefineName,this.convertToGammaSpace,!0),s.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_injectVertexCode(e){const i=this.uv;if(i.connectedPoint.ownerBlock.isInput&&(i.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(i.associatedVariableName,"vec2")),this._mainUVName="vMain"+i.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+=`${this._mainUVName} = ${i.associatedVariableName}.xy;\r
`,!!this._outputs.some(s=>s.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const s of this._outputs)s.hasEndpoints&&this._writeOutput(e,s,s.name,!0)}}_writeTextureRead(e,i=!1){const s=this.uv;if(i){if(e.target===Ct.Fragment)return;e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${s.associatedVariableName});\r
`;return}if(this.uv.ownerBlock.target===Ct.Fragment){e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${s.associatedVariableName});\r
`;return}e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this._mainUVName});\r
`}_writeOutput(e,i,s,n=!1){if(n){if(e.target===Ct.Fragment)return;e.compilationString+=`${this._declareOutput(i,e)} = ${this._tempTextureRead}.${s};\r
`;return}if(this.uv.ownerBlock.target===Ct.Fragment){e.compilationString+=`${this._declareOutput(i,e)} = ${this._tempTextureRead}.${s};\r
`;return}e.compilationString+=`${this._declareOutput(i,e)} = ${this._tempTextureRead}.${s};\r
`,e.compilationString+=`#ifdef ${this._linearDefineName}\r
`,e.compilationString+=`${i.associatedVariableName} = toGammaSpace(${i.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef ${this._gammaDefineName}\r
`,e.compilationString+=`${i.associatedVariableName} = toLinearSpace(${i.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`}_buildBlock(e){if(super._buildBlock(e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),e.target!==Ct.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(!this._outputs.some(s=>s.isConnectedInFragmentShader))return;e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const i=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",i),this._writeTextureRead(e);for(const s of this._outputs)s.hasEndpoints&&this._writeOutput(e,s,s.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,i,s){super._deserialize(e,i,s),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(s=e.texture.url.indexOf("data:")===0?"":s,this.texture=Oe.Parse(e.texture,i,s))}}ur("BABYLON.CurrentScreenBlock",NS);class BS extends Ca{constructor(e){super(e,Ct.Fragment),this._samplerName="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",Ke.AutoDetect,!1,Ct.VertexAndFragment),this.registerOutput("rgba",Ke.Color4,Ct.Neutral),this.registerOutput("rgb",Ke.Color3,Ct.Neutral),this.registerOutput("r",Ke.Float,Ct.Neutral),this.registerOutput("g",Ke.Float,Ct.Neutral),this.registerOutput("b",Ke.Float,Ct.Neutral),this.registerOutput("a",Ke.Float,Ct.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Ke.Vector2|Ke.Vector3|Ke.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("diffuseSampler")}autoConfigure(e){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate(s=>s.isAttribute&&s.name==="particle_uv");i||(i=new Yn("uv"),i.setAsAttribute("particle_uv")),i.output.connectTo(this.uv)}}prepareDefines(e,i,s){s.setValue(this._linearDefineName,this.convertToGammaSpace,!0),s.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_writeOutput(e,i,s){e.compilationString+=`${this._declareOutput(i,e)} = ${this._tempTextureRead}.${s};\r
`,e.compilationString+=`#ifdef ${this._linearDefineName}\r
`,e.compilationString+=`${i.associatedVariableName} = toGammaSpace(${i.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef ${this._gammaDefineName}\r
`,e.compilationString+=`${i.associatedVariableName} = toLinearSpace(${i.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`}_buildBlock(e){if(super._buildBlock(e),e.target===Ct.Vertex)return;this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const i=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",i),e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this.uv.associatedVariableName});\r
`;for(const s of this._outputs)s.hasEndpoints&&this._writeOutput(e,s,s.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,i,s){super._deserialize(e,i,s),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(s=e.texture.url.indexOf("data:")===0?"":s,this.texture=Oe.Parse(e.texture,i,s))}}ur("BABYLON.ParticleTextureBlock",BS);class kS extends Ca{constructor(e){super(e,Ct.Fragment),this._isUnique=!0,this.registerInput("color",Ke.Color4,!1,Ct.Fragment),this.registerOutput("rampColor",Ke.Color4,Ct.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this._inputs[0]}get rampColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor"),e._excludeVariableName("finalAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==Ct.Vertex)return e._emit2DSampler("rampSampler"),e._emitVaryingFromString("remapRanges","vec4","RAMPGRADIENT"),e.compilationString+=`
            #ifdef RAMPGRADIENT
                vec4 baseColor = ${this.color.associatedVariableName};
                float alpha = ${this.color.associatedVariableName}.a;

                float remappedColorIndex = clamp((alpha - remapRanges.x) / remapRanges.y, 0.0, 1.0);

                vec4 rampColor = texture2D(rampSampler, vec2(1.0 - remappedColorIndex, 0.));
                baseColor.rgb *= rampColor.rgb;

                // Remapped alpha
                float finalAlpha = baseColor.a;
                baseColor.a = clamp((alpha * rampColor.a - remapRanges.z) / remapRanges.w, 0.0, 1.0);

                ${this._declareOutput(this.rampColor,e)} = baseColor;
            #else
                ${this._declareOutput(this.rampColor,e)} = ${this.color.associatedVariableName};
            #endif
        `,this}}ur("BABYLON.ParticleRampGradientBlock",kS);class US extends Ca{constructor(e){super(e,Ct.Fragment),this._isUnique=!0,this.registerInput("color",Ke.Color4,!1,Ct.Fragment),this.registerInput("alphaTexture",Ke.Float,!1,Ct.Fragment),this.registerInput("alphaColor",Ke.Float,!1,Ct.Fragment),this.registerOutput("blendColor",Ke.Color4,Ct.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this._inputs[0]}get alphaTexture(){return this._inputs[1]}get alphaColor(){return this._inputs[2]}get blendColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("sourceAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==Ct.Vertex)return e.compilationString+=`
            #ifdef BLENDMULTIPLYMODE
                ${this._declareOutput(this.blendColor,e)};
                float sourceAlpha = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};
                ${this.blendColor.associatedVariableName}.rgb = ${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha);
                ${this.blendColor.associatedVariableName}.a = ${this.color.associatedVariableName}.a;
            #else
                ${this._declareOutput(this.blendColor,e)} = ${this.color.associatedVariableName};
            #endif
        `,this}}ur("BABYLON.ParticleBlendMultiplyBlock",US);class K2 extends Ca{constructor(e){super(e,Ct.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",Ke.Vector4,!0),this.registerInput("xyz ",Ke.Vector3,!0),this.registerInput("xy ",Ke.Vector2,!0),this.registerInput("zw ",Ke.Vector2,!0),this.registerInput("x",Ke.Float,!0),this.registerInput("y",Ke.Float,!0),this.registerInput("z",Ke.Float,!0),this.registerInput("w",Ke.Float,!0),this.registerOutput("xyzw",Ke.Vector4),this.registerOutput("xyz",Ke.Vector3),this.registerOutput("xy",Ke.Vector2),this.registerOutput("zw",Ke.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get x(){return this._inputs[4]}get y(){return this._inputs[5]}get z(){return this._inputs[6]}get w(){return this._inputs[7]}get xyzw(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}_inputRename(e){return e==="xyzw "?"xyzwIn":e==="xyz "?"xyzIn":e==="xy "?"xyIn":e==="zw "?"zwIn":e}_buildSwizzle(e){const i=this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle;return"."+i.substr(0,e)}_buildBlock(e){super._buildBlock(e);const i=this.x,s=this.y,n=this.z,a=this.w,p=this.xyIn,_=this.zwIn,g=this.xyzIn,y=this.xyzwIn,b=this._outputs[0],v=this._outputs[1],S=this._outputs[2],M=this._outputs[3];return y.isConnected?(b.hasEndpoints&&(e.compilationString+=this._declareOutput(b,e)+` = ${y.associatedVariableName}${this._buildSwizzle(4)};\r
`),v.hasEndpoints&&(e.compilationString+=this._declareOutput(v,e)+` = ${y.associatedVariableName}${this._buildSwizzle(3)};\r
`),S.hasEndpoints&&(e.compilationString+=this._declareOutput(S,e)+` = ${y.associatedVariableName}${this._buildSwizzle(2)};\r
`)):g.isConnected?(b.hasEndpoints&&(e.compilationString+=this._declareOutput(b,e)+` = vec4(${g.associatedVariableName}, ${a.isConnected?this._writeVariable(a):"0.0"})${this._buildSwizzle(4)};\r
`),v.hasEndpoints&&(e.compilationString+=this._declareOutput(v,e)+` = ${g.associatedVariableName}${this._buildSwizzle(3)};\r
`),S.hasEndpoints&&(e.compilationString+=this._declareOutput(S,e)+` = ${g.associatedVariableName}${this._buildSwizzle(2)};\r
`)):p.isConnected?(b.hasEndpoints&&(_.isConnected?e.compilationString+=this._declareOutput(b,e)+` = vec4(${p.associatedVariableName}, ${_.associatedVariableName})${this._buildSwizzle(4)};\r
`:e.compilationString+=this._declareOutput(b,e)+` = vec4(${p.associatedVariableName}, ${n.isConnected?this._writeVariable(n):"0.0"}, ${a.isConnected?this._writeVariable(a):"0.0"})${this._buildSwizzle(4)};\r
`),v.hasEndpoints&&(e.compilationString+=this._declareOutput(v,e)+` = vec3(${p.associatedVariableName}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(3)};\r
`),S.hasEndpoints&&(e.compilationString+=this._declareOutput(S,e)+` = ${p.associatedVariableName}${this._buildSwizzle(2)};\r
`),M.hasEndpoints&&(_.isConnected?e.compilationString+=this._declareOutput(M,e)+` = ${_.associatedVariableName}${this._buildSwizzle(2)};\r
`:e.compilationString+=this._declareOutput(M,e)+` = vec2(${n.isConnected?this._writeVariable(n):"0.0"}, ${a.isConnected?this._writeVariable(a):"0.0"})${this._buildSwizzle(2)};\r
`)):(b.hasEndpoints&&(_.isConnected?e.compilationString+=this._declareOutput(b,e)+` = vec4(${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${_.associatedVariableName})${this._buildSwizzle(4)};\r
`:e.compilationString+=this._declareOutput(b,e)+` = vec4(${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"}, ${a.isConnected?this._writeVariable(a):"0.0"})${this._buildSwizzle(4)};\r
`),v.hasEndpoints&&(e.compilationString+=this._declareOutput(v,e)+` = vec3(${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(3)};\r
`),S.hasEndpoints&&(e.compilationString+=this._declareOutput(S,e)+` = vec2(${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(2)};\r
`),M.hasEndpoints&&(_.isConnected?e.compilationString+=this._declareOutput(M,e)+` = ${_.associatedVariableName}${this._buildSwizzle(2)};\r
`:e.compilationString+=this._declareOutput(M,e)+` = vec2(${n.isConnected?this._writeVariable(n):"0.0"}, ${a.isConnected?this._writeVariable(a):"0.0"})${this._buildSwizzle(2)};\r
`)),this}serialize(){const e=super.serialize();return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e}_deserialize(e,i,s){var n,a,p,_;super._deserialize(e,i,s),this.xSwizzle=(n=e.xSwizzle)!==null&&n!==void 0?n:"x",this.ySwizzle=(a=e.ySwizzle)!==null&&a!==void 0?a:"y",this.zSwizzle=(p=e.zSwizzle)!==null&&p!==void 0?p:"z",this.wSwizzle=(_=e.wSwizzle)!==null&&_!==void 0?_:"w"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.xSwizzle = "${this.xSwizzle}";\r
`,e+=`${this._codeVariableName}.ySwizzle = "${this.ySwizzle}";\r
`,e+=`${this._codeVariableName}.zSwizzle = "${this.zSwizzle}";\r
`,e+=`${this._codeVariableName}.wSwizzle = "${this.wSwizzle}";\r
`,e}}ur("BABYLON.VectorMergerBlock",K2);class j2 extends Ca{constructor(e){super(e,Ct.Neutral),this.sourceRange=new ii(-1,1),this.targetRange=new ii(0,1),this.registerInput("input",Ke.AutoDetect),this.registerInput("sourceMin",Ke.Float,!0),this.registerInput("sourceMax",Ke.Float,!0),this.registerInput("targetMin",Ke.Float,!0),this.registerInput("targetMax",Ke.Float,!0),this.registerOutput("output",Ke.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const i=this._outputs[0],s=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),n=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),a=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),p=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=this._declareOutput(i,e)+` = ${a} + (${this._inputs[0].associatedVariableName} - ${s}) * (${p} - ${a}) / (${n} - ${s});\r
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});\r
`;return e+=`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});\r
`,e}serialize(){const e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,i,s){super._deserialize(e,i,s),this.sourceRange=ii.FromArray(e.sourceRange),this.targetRange=ii.FromArray(e.targetRange)}}J([uu("From",Sx.Vector2)],j2.prototype,"sourceRange",void 0),J([uu("To",Sx.Vector2)],j2.prototype,"targetRange",void 0),ur("BABYLON.RemapBlock",j2);class U_ extends Ca{constructor(e){super(e,Ct.Neutral),this.registerInput("left",Ke.AutoDetect),this.registerInput("right",Ke.AutoDetect),this.registerOutput("output",Ke.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MultiplyBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};\r
`,this}}ur("BABYLON.MultiplyBlock",U_);var Ra;(function(l){l[l.Material=0]="Material",l[l.PostProcess=1]="PostProcess",l[l.Particle=2]="Particle",l[l.ProceduralTexture=3]="ProceduralTexture"})(Ra||(Ra={}));class V_{constructor(){this.direction1=new j(0,1,0),this.direction2=new j(0,1,0),this.minEmitBox=new j(-.5,-.5,-.5),this.maxEmitBox=new j(.5,.5,.5)}startDirectionFunction(e,i,s,n){const a=at.RandomRange(this.direction1.x,this.direction2.x),p=at.RandomRange(this.direction1.y,this.direction2.y),_=at.RandomRange(this.direction1.z,this.direction2.z);if(n){i.x=a,i.y=p,i.z=_;return}j.TransformNormalFromFloatsToRef(a,p,_,e,i)}startPositionFunction(e,i,s,n){const a=at.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),p=at.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),_=at.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);if(n){i.x=a,i.y=p,i.z=_;return}j.TransformCoordinatesFromFloatsToRef(a,p,_,e,i)}clone(){const e=new V_;return Ya.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2),e.setVector3("minEmitBox",this.minEmitBox),e.setVector3("maxEmitBox",this.maxEmitBox)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3),e.addUniform("minEmitBox",3),e.addUniform("maxEmitBox",3)}getEffectDefines(){return"#define BOXEMITTER"}getClassName(){return"BoxParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e}parse(e){j.FromArrayToRef(e.direction1,0,this.direction1),j.FromArrayToRef(e.direction2,0,this.direction2),j.FromArrayToRef(e.minEmitBox,0,this.minEmitBox),j.FromArrayToRef(e.maxEmitBox,0,this.maxEmitBox)}}class G_{get radius(){return this._radius}set radius(e){this._radius=e,this._buildHeight()}get angle(){return this._angle}set angle(e){this._angle=e,this._buildHeight()}_buildHeight(){this._angle!==0?this._height=this._radius/Math.tan(this._angle/2):this._height=1}constructor(e=1,i=Math.PI,s=0){this.directionRandomizer=s,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=i,this.radius=e}startDirectionFunction(e,i,s,n){n?ge.Vector3[0].copyFrom(s._localPosition).normalize():s.position.subtractToRef(e.getTranslation(),ge.Vector3[0]).normalize();const a=at.RandomRange(0,this.directionRandomizer),p=at.RandomRange(0,this.directionRandomizer),_=at.RandomRange(0,this.directionRandomizer);i.x=ge.Vector3[0].x+a,i.y=ge.Vector3[0].y+p,i.z=ge.Vector3[0].z+_,i.normalize()}startPositionFunction(e,i,s,n){const a=at.RandomRange(0,Math.PI*2);let p;this.emitFromSpawnPointOnly?p=1e-4:(p=at.RandomRange(0,this.heightRange),p=1-p*p);let _=this._radius-at.RandomRange(0,this._radius*this.radiusRange);_=_*p;const g=_*Math.sin(a),y=_*Math.cos(a),b=p*this._height;if(n){i.x=g,i.y=b,i.z=y;return}j.TransformCoordinatesFromFloatsToRef(g,b,y,e,i)}clone(){const e=new G_(this._radius,this._angle,this.directionRandomizer);return Ya.DeepCopy(this,e),e}applyToShader(e){e.setFloat2("radius",this._radius,this.radiusRange),e.setFloat("coneAngle",this._angle),e.setFloat2("height",this._height,this.heightRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",2),e.addUniform("coneAngle",1),e.addUniform("height",2),e.addUniform("directionRandomizer",1)}getEffectDefines(){let e="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(e+=`
#define CONEEMITTERSPAWNPOINT`),e}getClassName(){return"ConeParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this._radius,e.angle=this._angle,e.directionRandomizer=this.directionRandomizer,e.radiusRange=this.radiusRange,e.heightRange=this.heightRange,e.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,e}parse(e){this.radius=e.radius,this.angle=e.angle,this.directionRandomizer=e.directionRandomizer,this.radiusRange=e.radiusRange!==void 0?e.radiusRange:1,this.heightRange=e.radiusRange!==void 0?e.heightRange:1,this.emitFromSpawnPointOnly=e.emitFromSpawnPointOnly!==void 0?e.emitFromSpawnPointOnly:!1}}class q2{constructor(e=1,i=1,s=1,n=0){this.radius=e,this.height=i,this.radiusRange=s,this.directionRandomizer=n,this._tempVector=j.Zero()}startDirectionFunction(e,i,s,n,a){s.position.subtractToRef(e.getTranslation(),this._tempVector),this._tempVector.normalize(),j.TransformNormalToRef(this._tempVector,a,this._tempVector);const p=at.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2);let _=Math.atan2(this._tempVector.x,this._tempVector.z);if(_+=at.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=p,this._tempVector.x=Math.sin(_),this._tempVector.z=Math.cos(_),this._tempVector.normalize(),n){i.copyFrom(this._tempVector);return}j.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,e,i)}startPositionFunction(e,i,s,n){const a=at.RandomRange(-this.height/2,this.height/2),p=at.RandomRange(0,2*Math.PI),_=at.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),g=Math.sqrt(_)*this.radius,y=g*Math.cos(p),b=g*Math.sin(p);if(n){i.copyFromFloats(y,a,b);return}j.TransformCoordinatesFromFloatsToRef(y,a,b,e,i)}clone(){const e=new q2(this.radius,this.directionRandomizer);return Ya.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define CYLINDEREMITTER"}getClassName(){return"CylinderParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.height=this.height,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.height=e.height,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class W_ extends q2{constructor(e=1,i=1,s=1,n=new j(0,1,0),a=new j(0,1,0)){super(e,i,s),this.direction1=n,this.direction2=a}startDirectionFunction(e,i){const s=at.RandomRange(this.direction1.x,this.direction2.x),n=at.RandomRange(this.direction1.y,this.direction2.y),a=at.RandomRange(this.direction1.z,this.direction2.z);j.TransformNormalFromFloatsToRef(s,n,a,e,i)}clone(){const e=new W_(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return Ya.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define CYLINDEREMITTER
#define DIRECTEDCYLINDEREMITTER`}getClassName(){return"CylinderDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class z_{constructor(e=1,i=1,s=0){this.radius=e,this.radiusRange=i,this.directionRandomizer=s}startDirectionFunction(e,i,s,n){const a=s.position.subtract(e.getTranslation()).normalize(),p=at.RandomRange(0,this.directionRandomizer),_=at.RandomRange(0,this.directionRandomizer),g=at.RandomRange(0,this.directionRandomizer);if(a.x+=p,a.y+=_,a.z+=g,a.normalize(),n){i.copyFrom(a);return}j.TransformNormalFromFloatsToRef(a.x,a.y,a.z,e,i)}startPositionFunction(e,i,s,n){const a=this.radius-at.RandomRange(0,this.radius*this.radiusRange),p=at.RandomRange(0,1),_=at.RandomRange(0,2*Math.PI),g=Math.acos(2*p-1),y=a*Math.cos(_)*Math.sin(g),b=a*Math.cos(g),v=a*Math.sin(_)*Math.sin(g);if(n){i.copyFromFloats(y,Math.abs(b),v);return}j.TransformCoordinatesFromFloatsToRef(y,Math.abs(b),v,e,i)}clone(){const e=new z_(this.radius,this.directionRandomizer);return Ya.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define HEMISPHERICEMITTER"}getClassName(){return"HemisphericParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class H_{constructor(){this.direction1=new j(0,1,0),this.direction2=new j(0,1,0)}startDirectionFunction(e,i,s,n){const a=at.RandomRange(this.direction1.x,this.direction2.x),p=at.RandomRange(this.direction1.y,this.direction2.y),_=at.RandomRange(this.direction1.z,this.direction2.z);if(n){i.copyFromFloats(a,p,_);return}j.TransformNormalFromFloatsToRef(a,p,_,e,i)}startPositionFunction(e,i,s,n){if(n){i.copyFromFloats(0,0,0);return}j.TransformCoordinatesFromFloatsToRef(0,0,0,e,i)}clone(){const e=new H_;return Ya.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define POINTEMITTER"}getClassName(){return"PointParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){j.FromArrayToRef(e.direction1,0,this.direction1),j.FromArrayToRef(e.direction2,0,this.direction2)}}class Z2{constructor(e=1,i=1,s=0){this.radius=e,this.radiusRange=i,this.directionRandomizer=s}startDirectionFunction(e,i,s,n){const a=s.position.subtract(e.getTranslation()).normalize(),p=at.RandomRange(0,this.directionRandomizer),_=at.RandomRange(0,this.directionRandomizer),g=at.RandomRange(0,this.directionRandomizer);if(a.x+=p,a.y+=_,a.z+=g,a.normalize(),n){i.copyFrom(a);return}j.TransformNormalFromFloatsToRef(a.x,a.y,a.z,e,i)}startPositionFunction(e,i,s,n){const a=this.radius-at.RandomRange(0,this.radius*this.radiusRange),p=at.RandomRange(0,1),_=at.RandomRange(0,2*Math.PI),g=Math.acos(2*p-1),y=a*Math.cos(_)*Math.sin(g),b=a*Math.cos(g),v=a*Math.sin(_)*Math.sin(g);if(n){i.copyFromFloats(y,b,v);return}j.TransformCoordinatesFromFloatsToRef(y,b,v,e,i)}clone(){const e=new Z2(this.radius,this.directionRandomizer);return Ya.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define SPHEREEMITTER"}getClassName(){return"SphereParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class X_ extends Z2{constructor(e=1,i=new j(0,1,0),s=new j(0,1,0)){super(e),this.direction1=i,this.direction2=s}startDirectionFunction(e,i){const s=at.RandomRange(this.direction1.x,this.direction2.x),n=at.RandomRange(this.direction1.y,this.direction2.y),a=at.RandomRange(this.direction1.z,this.direction2.z);j.TransformNormalFromFloatsToRef(s,n,a,e,i)}clone(){const e=new X_(this.radius,this.direction1,this.direction2);return Ya.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define SPHEREEMITTER
#define DIRECTEDSPHEREEMITTER`}getClassName(){return"SphereDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class VS{constructor(){this.particlePositionGenerator=()=>{},this.particleDestinationGenerator=()=>{}}startDirectionFunction(e,i,s,n){const a=TmpVectors.Vector3[0];if(this.particleDestinationGenerator){this.particleDestinationGenerator(-1,s,a);const p=TmpVectors.Vector3[1];a.subtractToRef(s.position,p),p.scaleToRef(1/s.lifeTime,a)}else a.set(0,0,0);if(n){i.copyFrom(a);return}Vector3.TransformNormalToRef(a,e,i)}startPositionFunction(e,i,s,n){const a=TmpVectors.Vector3[0];if(this.particlePositionGenerator?this.particlePositionGenerator(-1,s,a):a.set(0,0,0),n){i.copyFrom(a);return}Vector3.TransformCoordinatesToRef(a,e,i)}clone(){const e=new VS;return DeepCopier.DeepCopy(this,e),e}applyToShader(e){}buildUniformLayout(e){}getEffectDefines(){return"#define CUSTOMEMITTER"}getClassName(){return"CustomParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e}parse(e){}}class GS{get mesh(){return this._mesh}set mesh(e){this._mesh!==e&&(this._mesh=e,e?(this._indices=e.getIndices(),this._positions=e.getVerticesData(VertexBuffer.PositionKind),this._normals=e.getVerticesData(VertexBuffer.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))}constructor(e=null){this._indices=null,this._positions=null,this._normals=null,this._storedNormal=Vector3.Zero(),this._mesh=null,this.direction1=new Vector3(0,1,0),this.direction2=new Vector3(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=e}startDirectionFunction(e,i,s,n){if(this.useMeshNormalsForDirection&&this._normals){Vector3.TransformNormalToRef(this._storedNormal,e,i);return}const a=Scalar.RandomRange(this.direction1.x,this.direction2.x),p=Scalar.RandomRange(this.direction1.y,this.direction2.y),_=Scalar.RandomRange(this.direction1.z,this.direction2.z);if(n){i.copyFromFloats(a,p,_);return}Vector3.TransformNormalFromFloatsToRef(a,p,_,e,i)}startPositionFunction(e,i,s,n){if(!this._indices||!this._positions)return;const a=3*Math.random()*(this._indices.length/3)|0,p=Math.random(),_=Math.random()*(1-p),g=1-p-_,y=this._indices[a],b=this._indices[a+1],v=this._indices[a+2],S=TmpVectors.Vector3[0],M=TmpVectors.Vector3[1],F=TmpVectors.Vector3[2],L=TmpVectors.Vector3[3];Vector3.FromArrayToRef(this._positions,y*3,S),Vector3.FromArrayToRef(this._positions,b*3,M),Vector3.FromArrayToRef(this._positions,v*3,F),L.x=p*S.x+_*M.x+g*F.x,L.y=p*S.y+_*M.y+g*F.y,L.z=p*S.z+_*M.z+g*F.z,n?i.copyFromFloats(L.x,L.y,L.z):Vector3.TransformCoordinatesFromFloatsToRef(L.x,L.y,L.z,e,i),this.useMeshNormalsForDirection&&this._normals&&(Vector3.FromArrayToRef(this._normals,y*3,S),Vector3.FromArrayToRef(this._normals,b*3,M),Vector3.FromArrayToRef(this._normals,v*3,F),this._storedNormal.x=p*S.x+_*M.x+g*F.x,this._storedNormal.y=p*S.y+_*M.y+g*F.y,this._storedNormal.z=p*S.z+_*M.z+g*F.z)}clone(){const e=new GS(this.mesh);return DeepCopier.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return""}getClassName(){return"MeshParticleEmitter"}serialize(){var e;const i={};return i.type=this.getClassName(),i.direction1=this.direction1.asArray(),i.direction2=this.direction2.asArray(),i.meshId=(e=this.mesh)===null||e===void 0?void 0:e.id,i.useMeshNormalsForDirection=this.useMeshNormalsForDirection,i}parse(e,i){Vector3.FromArrayToRef(e.direction1,0,this.direction1),Vector3.FromArrayToRef(e.direction2,0,this.direction2),e.meshId&&i&&(this.mesh=i.getLastMeshById(e.meshId)),this.useMeshNormalsForDirection=e.useMeshNormalsForDirection}}class w0{get noiseTexture(){return this._noiseTexture}set noiseTexture(e){this._noiseTexture!==e&&(this._noiseTexture=e,this._reset())}get isAnimationSheetEnabled(){return this._isAnimationSheetEnabled}set isAnimationSheetEnabled(e){this._isAnimationSheetEnabled!=e&&(this._isAnimationSheetEnabled=e,this._reset())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this._scene}_hasTargetStopDurationDependantGradient(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0}getDragGradients(){return this._dragGradients}getLimitVelocityGradients(){return this._limitVelocityGradients}getColorGradients(){return this._colorGradients}getSizeGradients(){return this._sizeGradients}getColorRemapGradients(){return this._colorRemapGradients}getAlphaRemapGradients(){return this._alphaRemapGradients}getLifeTimeGradients(){return this._lifeTimeGradients}getAngularSpeedGradients(){return this._angularSpeedGradients}getVelocityGradients(){return this._velocityGradients}getStartSizeGradients(){return this._startSizeGradients}getEmitRateGradients(){return this._emitRateGradients}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:j.Zero()}set direction1(e){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=e)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:j.Zero()}set direction2(e){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=e)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:j.Zero()}set minEmitBox(e){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=e)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:j.Zero()}set maxEmitBox(e){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=e)}get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._reset())}get isBillboardBased(){return this._isBillboardBased}set isBillboardBased(e){this._isBillboardBased!==e&&(this._isBillboardBased=e,this._reset())}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(!e&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=e)}_reset(){}_removeGradientAndTexture(e,i,s){if(!i)return this;let n=0;for(const a of i){if(a.gradient===e){i.splice(n,1);break}n++}return s&&s.dispose(),this}constructor(e){this.animations=[],this.renderingGroupId=0,this.emitter=j.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this._wasDispatched=!1,this._rootUrl="",this.noiseStrength=new j(10,10,10),this.onAnimationEnd=null,this.blendMode=w0.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new ii(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new j(0,0,0),this._useLogarithmicDepth=!1,this.gravity=j.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new pi(1,1,1,1),this.color2=new pi(1,1,1,1),this.colorDead=new pi(0,0,0,1),this.textureMask=new pi(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new L9,this.id=e,this.name=e}createPointEmitter(e,i){const s=new H_;return s.direction1=e,s.direction2=i,this.particleEmitterType=s,s}createHemisphericEmitter(e=1,i=1){const s=new z_(e,i);return this.particleEmitterType=s,s}createSphereEmitter(e=1,i=1){const s=new Z2(e,i);return this.particleEmitterType=s,s}createDirectedSphereEmitter(e=1,i=new j(0,1,0),s=new j(0,1,0)){const n=new X_(e,i,s);return this.particleEmitterType=n,n}createCylinderEmitter(e=1,i=1,s=1,n=0){const a=new q2(e,i,s,n);return this.particleEmitterType=a,a}createDirectedCylinderEmitter(e=1,i=1,s=1,n=new j(0,1,0),a=new j(0,1,0)){const p=new W_(e,i,s,n,a);return this.particleEmitterType=p,p}createConeEmitter(e=1,i=Math.PI/4){const s=new G_(e,i);return this.particleEmitterType=s,s}createBoxEmitter(e,i,s,n){const a=new V_;return this.particleEmitterType=a,this.direction1=e,this.direction2=i,this.minEmitBox=s,this.maxEmitBox=n,a}}w0.BLENDMODE_ONEONE=0,w0.BLENDMODE_STANDARD=1,w0.BLENDMODE_ADD=2,w0.BLENDMODE_MULTIPLY=3,w0.BLENDMODE_MULTIPLYADD=4;class WS extends Ca{constructor(e){super(e,Ct.Neutral),this.registerInput("rgba",Ke.Color4,!0),this.registerInput("rgb ",Ke.Color3,!0),this.registerOutput("rgb",Ke.Color3),this.registerOutput("r",Ke.Float),this.registerOutput("g",Ke.Float),this.registerOutput("b",Ke.Float),this.registerOutput("a",Ke.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this._inputs[0]}get rgbIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get r(){return this._outputs[1]}get g(){return this._outputs[2]}get b(){return this._outputs[3]}get a(){return this._outputs[4]}_inputRename(e){return e==="rgb "?"rgbIn":e}_outputRename(e){return e==="rgb"?"rgbOut":e}_buildBlock(e){super._buildBlock(e);const i=this.rgba.isConnected?this.rgba:this.rgbIn;if(!i.isConnected)return;const s=this._outputs[0],n=this._outputs[1],a=this._outputs[2],p=this._outputs[3],_=this._outputs[4];return s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+` = ${i.associatedVariableName}.rgb;\r
`),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${i.associatedVariableName}.r;\r
`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = ${i.associatedVariableName}.g;\r
`),p.hasEndpoints&&(e.compilationString+=this._declareOutput(p,e)+` = ${i.associatedVariableName}.b;\r
`),_.hasEndpoints&&(e.compilationString+=this._declareOutput(_,e)+` = ${i.associatedVariableName}.a;\r
`),this}}ur("BABYLON.ColorSplitterBlock",WS);class Qz{constructor(e){this.name=Vt.NAME_PROCEDURALTEXTURE,this.scene=e,this.scene.proceduralTextures=new Array}register(){this.scene._beforeClearStage.registerStep(Vt.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)}rebuild(){}dispose(){}_beforeClear(){if(this.scene.proceduralTexturesEnabled){Le.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let e=0;e<this.scene.proceduralTextures.length;e++){const i=this.scene.proceduralTextures[e];i._shouldRender()&&i.render()}Le.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}}}const zS="proceduralVertexShader",HS=`attribute vec2 position;
varying vec2 vPosition;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vPosition=position;
vUV=position*madd+madd;
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;Ye.ShadersStore[zS]=HS;const Zq={name:zS,shader:HS};class D0 extends Oe{constructor(e,i,s,n,a=null,p=!0,_=!1,g=0){super(null,n,!p),this.isEnabled=!0,this.autoClear=!0,this.onGeneratedObservable=new Re,this.onBeforeGenerationObservable=new Re,this.nodeMaterialSource=null,this._textures={},this._currentRefreshId=-1,this._frameId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._matrices={},this._fallbackTextureUsed=!1,this._cachedDefines=null,this._contentUpdateId=-1,this._rtWrapper=null,n=this.getScene()||Zt.LastCreatedScene;let y=n._getComponent(Vt.NAME_PROCEDURALTEXTURE);y||(y=new Qz(n),n._addComponent(y)),n.proceduralTextures.push(this),this._fullEngine=n.getEngine(),this.name=e,this.isRenderTarget=!0,this._size=i,this._textureType=g,this._generateMipMaps=p,this._drawWrapper=new ul(this._fullEngine),this.setFragment(s),this._fallbackTexture=a;const b=this._createRtWrapper(_,i,p,g);this._texture=b.texture;const v=[];v.push(1,1),v.push(-1,1),v.push(-1,-1),v.push(1,-1),this._vertexBuffers[te.PositionKind]=new te(this._fullEngine,v,te.PositionKind,!1,!1,2),this._createIndexBuffer()}_createRtWrapper(e,i,s,n){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(i,{generateMipMaps:s,generateDepthBuffer:!1,generateStencilBuffer:!1,type:n}),this.setFloat("face",0)):this._rtWrapper=this._fullEngine.createRenderTargetTexture(i,{generateMipMaps:s,generateDepthBuffer:!1,generateStencilBuffer:!1,type:n}),this._rtWrapper}getEffect(){return this._drawWrapper.effect}_setEffect(e){this._drawWrapper.effect=e}getContent(){return this._contentData&&this._frameId===this._contentUpdateId?this._contentData:(this._contentData?this._contentData.then(e=>{this._contentData=this.readPixels(0,0,e),this._contentUpdateId=this._frameId}):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId),this._contentData)}_createIndexBuffer(){const e=this._fullEngine,i=[];i.push(0),i.push(1),i.push(2),i.push(0),i.push(2),i.push(3),this._indexBuffer=e.createIndexBuffer(i)}_rebuild(){const e=this._vertexBuffers[te.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===zn.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=zn.REFRESHRATE_RENDER_ONCE)}reset(){var e;(e=this._drawWrapper.effect)===null||e===void 0||e.dispose()}_getDefines(){return""}isReady(){const e=this._fullEngine;let i;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;const s=this._getDefines();return this._drawWrapper.effect&&s===this._cachedDefines&&this._drawWrapper.effect.isReady()?!0:(this._fragment.fragmentElement!==void 0?i={vertex:"procedural",fragmentElement:this._fragment.fragmentElement}:i={vertex:"procedural",fragment:this._fragment},this._cachedDefines!==s&&(this._cachedDefines=s,this._drawWrapper.effect=e.createEffect(i,[te.PositionKind],this._uniforms,this._samplers,s,void 0,void 0,()=>{var n;(n=this._rtWrapper)===null||n===void 0||n.dispose(),this._rtWrapper=this._texture=null,this._fallbackTexture&&(this._texture=this._fallbackTexture._texture,this._texture&&this._texture.incrementReferences()),this._fallbackTextureUsed=!0})),this._drawWrapper.effect.isReady())}resetRefreshCounter(){this._currentRefreshId=-1}setFragment(e){this._fragment=e}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}_shouldRender(){return!this.isEnabled||!this.isReady()||!this._texture?(this._texture&&(this._texture.isReady=!1),!1):this._fallbackTextureUsed?!1:this._currentRefreshId===-1?(this._currentRefreshId=1,this._frameId++,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this._size}resize(e,i){if(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)return;const s=this._texture.isCube;this._rtWrapper.dispose();const n=this._createRtWrapper(s,e,i,this._textureType);this._texture=n.texture,this._size=e,this._generateMipMaps=i}_checkUniform(e){this._uniforms.indexOf(e)===-1&&this._uniforms.push(e)}setTexture(e,i){return this._samplers.indexOf(e)===-1&&this._samplers.push(e),this._textures[e]=i,this}setFloat(e,i){return this._checkUniform(e),this._floats[e]=i,this}setInt(e,i){return this._checkUniform(e),this._ints[e]=i,this}setFloats(e,i){return this._checkUniform(e),this._floatsArrays[e]=i,this}setColor3(e,i){return this._checkUniform(e),this._colors3[e]=i,this}setColor4(e,i){return this._checkUniform(e),this._colors4[e]=i,this}setVector2(e,i){return this._checkUniform(e),this._vectors2[e]=i,this}setVector3(e,i){return this._checkUniform(e),this._vectors3[e]=i,this}setMatrix(e,i){return this._checkUniform(e),this._matrices[e]=i,this}render(e){var i,s;const n=this.getScene();if(!n)return;const a=this._fullEngine;if(a.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),a.setState(!1),!this.nodeMaterialSource){for(const _ in this._textures)this._drawWrapper.effect.setTexture(_,this._textures[_]);for(const _ in this._ints)this._drawWrapper.effect.setInt(_,this._ints[_]);for(const _ in this._floats)this._drawWrapper.effect.setFloat(_,this._floats[_]);for(const _ in this._floatsArrays)this._drawWrapper.effect.setArray(_,this._floatsArrays[_]);for(const _ in this._colors3)this._drawWrapper.effect.setColor3(_,this._colors3[_]);for(const _ in this._colors4){const g=this._colors4[_];this._drawWrapper.effect.setFloat4(_,g.r,g.g,g.b,g.a)}for(const _ in this._vectors2)this._drawWrapper.effect.setVector2(_,this._vectors2[_]);for(const _ in this._vectors3)this._drawWrapper.effect.setVector3(_,this._vectors3[_]);for(const _ in this._matrices)this._drawWrapper.effect.setMatrix(_,this._matrices[_])}if(!this._texture||!this._rtWrapper)return;(i=a._debugPushGroup)===null||i===void 0||i.call(a,`procedural texture generation for ${this.name}`,1);const p=a.currentViewport;if(this.isCube)for(let _=0;_<6;_++)a.bindFramebuffer(this._rtWrapper,_,void 0,void 0,!0),a.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",_),this.autoClear&&a.clear(n.clearColor,!0,!1,!1),a.drawElementsType(Be.TriangleFillMode,0,6);else a.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0),a.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this.autoClear&&a.clear(n.clearColor,!0,!1,!1),a.drawElementsType(Be.TriangleFillMode,0,6);a.unBindFramebuffer(this._rtWrapper,this.isCube),p&&a.setViewport(p),this.isCube&&a.generateMipMapsForCubemap(this._texture),(s=a._debugPopGroup)===null||s===void 0||s.call(a,1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}clone(){const e=this.getSize(),i=new D0(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.coordinatesMode=this.coordinatesMode,i}dispose(){const e=this.getScene();if(!e)return;const i=e.proceduralTextures.indexOf(this);i>=0&&e.proceduralTextures.splice(i,1);const s=this._vertexBuffers[te.PositionKind];s&&(s.dispose(),this._vertexBuffers[te.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose()}}J([xe()],D0.prototype,"isEnabled",void 0),J([xe()],D0.prototype,"autoClear",void 0),J([xe()],D0.prototype,"_generateMipMaps",void 0),J([xe()],D0.prototype,"_size",void 0),J([xe()],D0.prototype,"refreshRate",null),ur("BABYLON.ProceduralTexture",D0);var as;(function(l){l[l.Cos=0]="Cos",l[l.Sin=1]="Sin",l[l.Abs=2]="Abs",l[l.Exp=3]="Exp",l[l.Exp2=4]="Exp2",l[l.Round=5]="Round",l[l.Floor=6]="Floor",l[l.Ceiling=7]="Ceiling",l[l.Sqrt=8]="Sqrt",l[l.Log=9]="Log",l[l.Tan=10]="Tan",l[l.ArcTan=11]="ArcTan",l[l.ArcCos=12]="ArcCos",l[l.ArcSin=13]="ArcSin",l[l.Fract=14]="Fract",l[l.Sign=15]="Sign",l[l.Radians=16]="Radians",l[l.Degrees=17]="Degrees"})(as||(as={}));class XS extends Ca{constructor(e){super(e,Ct.Neutral),this.operation=as.Cos,this.registerInput("input",Ke.AutoDetect),this.registerOutput("output",Ke.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const i=this._outputs[0];let s="";switch(this.operation){case as.Cos:{s="cos";break}case as.Sin:{s="sin";break}case as.Abs:{s="abs";break}case as.Exp:{s="exp";break}case as.Exp2:{s="exp2";break}case as.Round:{s="round";break}case as.Floor:{s="floor";break}case as.Ceiling:{s="ceil";break}case as.Sqrt:{s="sqrt";break}case as.Log:{s="log";break}case as.Tan:{s="tan";break}case as.ArcTan:{s="atan";break}case as.ArcCos:{s="acos";break}case as.ArcSin:{s="asin";break}case as.Fract:{s="fract";break}case as.Sign:{s="sign";break}case as.Radians:{s="radians";break}case as.Degrees:{s="degrees";break}}return e.compilationString+=this._declareOutput(i,e)+` = ${s}(${this.input.associatedVariableName});\r
`,this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e,i,s){super._deserialize(e,i,s),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${as[this.operation]};\r
`}}ur("BABYLON.TrigonometryBlock",XS);const Y_={effect:null,subMesh:null};class Q2 extends ja{constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.EXPOSURE=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.rebuild()}setValue(e,i,s=!1){this[e]===void 0&&this._keys.push(e),s&&this[e]!==i&&this.markAsUnprocessed(),this[e]=i}}class os extends qh{static _BlockIsTextureBlock(e){return e.getClassName()==="TextureBlock"||e.getClassName()==="ReflectionTextureBaseBlock"||e.getClassName()==="RefractionBlock"||e.getClassName()==="CurrentScreenBlock"||e.getClassName()==="ParticleTextureBlock"||e.getClassName()==="ImageSourceBlock"||e.getClassName()==="TriPlanarBlock"||e.getClassName()==="BiPlanarBlock"}_getGlobalNodeMaterialEditor(){if(typeof NODEEDITOR<"u")return NODEEDITOR;if(typeof BABYLON<"u"&&typeof BABYLON.NodeEditor<"u")return BABYLON}get options(){return this._options}set options(e){this._options=e}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}constructor(e,i,s={}){super(e,i||Zt.LastCreatedScene),this._buildId=os._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new fe,this._cachedWorldViewProjectionMatrix=new fe,this._optimizers=new Array,this._animationFrame=-1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new Re,this._vertexOutputNodes=new Array,this._fragmentOutputNodes=new Array,this.attachedBlocks=new Array,this._mode=Ra.Material,this.forceAlphaBlending=!1,this._options={emitComments:!1,...s},this._attachImageProcessingConfiguration(null)}getClassName(){return"NodeMaterial"}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}getBlockByName(e){let i=null;for(const s of this.attachedBlocks)if(s.name===e)if(!i)i=s;else return Le.Warn("More than one block was found with the name `"+e+"`"),i;return i}getBlockByPredicate(e){for(const i of this.attachedBlocks)if(e(i))return i;return null}getInputBlockByPredicate(e){for(const i of this.attachedBlocks)if(i.isInput&&e(i))return i;return null}getInputBlocks(){const e=[];for(const i of this.attachedBlocks)i.isInput&&e.push(i);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){const i=this._optimizers.indexOf(e);if(i!==-1)return this._optimizers.splice(i,1),this}addOutputNode(e){if(e.target===null)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return(e.target&Ct.Vertex)!==0&&this._addVertexOutputNode(e),(e.target&Ct.Fragment)!==0&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return e.target===null?this:((e.target&Ct.Vertex)!==0&&this._removeVertexOutputNode(e),(e.target&Ct.Fragment)!==0&&this._removeFragmentOutputNode(e),this)}_addVertexOutputNode(e){if(this._vertexOutputNodes.indexOf(e)===-1)return e.target=Ct.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){const i=this._vertexOutputNodes.indexOf(e);if(i!==-1)return this._vertexOutputNodes.splice(i,1),this}_addFragmentOutputNode(e){if(this._fragmentOutputNodes.indexOf(e)===-1)return e.target=Ct.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){const i=this._fragmentOutputNodes.indexOf(e);if(i!==-1)return this._fragmentOutputNodes.splice(i,1),this}needAlphaBlending(){return this.ignoreAlpha?!1:this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_initializeBlock(e,i,s,n=!0){if(e.initialize(i),n&&e.autoConfigure(this),e._preparationId=this._buildId,this.attachedBlocks.indexOf(e)===-1){if(e.isUnique){const a=e.getClassName();for(const p of this.attachedBlocks)if(p.getClassName()===a)throw`Cannot have multiple blocks of type ${a} in the same NodeMaterial`}this.attachedBlocks.push(e)}for(const a of e.inputs){a.associatedVariableName="";const p=a.connectedPoint;if(p){const _=p.ownerBlock;_!==e&&((_.target===Ct.VertexAndFragment||i.target===Ct.Fragment&&_.target===Ct.Vertex&&_._preparationId!==this._buildId)&&s.push(_),this._initializeBlock(_,i,s,n))}}for(const a of e.outputs)a.associatedVariableName=""}_resetDualBlocks(e,i){e.target===Ct.VertexAndFragment&&(e.buildId=i);for(const s of e.inputs){const n=s.connectedPoint;if(n){const a=n.ownerBlock;a!==e&&this._resetDualBlocks(a,i)}}}removeBlock(e){const i=this.attachedBlocks.indexOf(e);i>-1&&this.attachedBlocks.splice(i,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,i=!0,s=!0){this._buildWasSuccessful=!1;const n=this.getScene().getEngine(),a=this._mode===Ra.Particle;if(this._vertexOutputNodes.length===0&&!a)throw"You must define at least one vertexOutputNode";if(this._fragmentOutputNodes.length===0)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new FS,this._vertexCompilationState.supportUniformBuffers=n.supportsUniformBuffers,this._vertexCompilationState.target=Ct.Vertex,this._fragmentCompilationState=new FS,this._fragmentCompilationState.supportUniformBuffers=n.supportsUniformBuffers,this._fragmentCompilationState.target=Ct.Fragment,this._sharedData=new qz,this._sharedData.fragmentOutputNodes=this._fragmentOutputNodes,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=a;const p=[],_=[];for(const y of this._vertexOutputNodes)p.push(y),this._initializeBlock(y,this._vertexCompilationState,_,s);for(const y of this._fragmentOutputNodes)_.push(y),this._initializeBlock(y,this._fragmentCompilationState,p,s);this.optimize();for(const y of p)y.build(this._vertexCompilationState,p);this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(const y of _)this._resetDualBlocks(y,this._buildId-1);for(const y of _)y.build(this._fragmentCompilationState,_);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),i&&(this._buildId=os._BuildIdGenerator++),this._sharedData.emitErrors(),e&&(console.log("Vertex shader:"),console.log(this._vertexCompilationState.compilationString),console.log("Fragment shader:"),console.log(this._fragmentCompilationState.compilationString)),this._buildWasSuccessful=!0,this.onBuildObservable.notifyObservers(this);const g=this.getScene().meshes;for(const y of g)if(!!y.subMeshes)for(const b of y.subMeshes){if(b.getMaterial()!==this||!b.materialDefines)continue;const v=b.materialDefines;v.markAllAsDirty(),v.reset()}}optimize(){for(const e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,i){const s=i.NORMAL,n=i.TANGENT;i.NORMAL=e.isVerticesDataPresent(te.NormalKind),i.TANGENT=e.isVerticesDataPresent(te.TangentKind);let a=!1;for(let p=1;p<=6;++p){const _=i["UV"+p];i["UV"+p]=e.isVerticesDataPresent(`uv${p===1?"":p}`),a=a||i["UV"+p]!==_}(s!==i.NORMAL||n!==i.TANGENT||a)&&i.markAsAttributesDirty()}createPostProcess(e,i=1,s=1,n,a,p=0,_=5){return this.mode!==Ra.PostProcess?(console.log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,i,s,n,a,p,_)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,i,s=1,n=1,a,p,_=0,g=5){let y=this.name+this._buildId;const b=new Q2,v=new Ds(y+"PostProcess",this.getScene());let S=this._buildId;return this._processDefines(v,b),ir.RegisterShader(y,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),e?e.updateEffect(b.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,y,y):e=new lr(this.name+"PostProcess",y,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,s,i,n,a,p,b.toString(),_,y,{maxSimultaneousLights:this.maxSimultaneousLights},!1,g),e.nodeMaterialSource=this,e.onApplyObservable.add(M=>{S!==this._buildId&&(delete ir.ShadersStore[y+"VertexShader"],delete ir.ShadersStore[y+"PixelShader"],y=this.name+this._buildId,b.markAllAsDirty(),S=this._buildId),this._processDefines(v,b)&&(ir.RegisterShader(y,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),pc.SetImmediate(()=>e.updateEffect(b.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,y,y))),this._checkInternals(M)}),e}createProceduralTexture(e,i){if(this.mode!==Ra.ProceduralTexture)return console.log("Incompatible material mode"),null;let s=this.name+this._buildId;const n=new D0(s,e,null,i),a=new Ds(s+"Procedural",this.getScene());a.reservedDataStore={hidden:!0};const p=new Q2,_=this._processDefines(a,p);ir.RegisterShader(s,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString);let g=this.getScene().getEngine().createEffect({vertexElement:s,fragmentElement:s},[te.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,p.toString(),_?.fallbacks,void 0);n.nodeMaterialSource=this,n._setEffect(g);let y=this._buildId;return n.onBeforeGenerationObservable.add(()=>{y!==this._buildId&&(delete ir.ShadersStore[s+"VertexShader"],delete ir.ShadersStore[s+"PixelShader"],s=this.name+this._buildId,p.markAllAsDirty(),y=this._buildId);const b=this._processDefines(a,p);b&&(ir.RegisterShader(s,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),pc.SetImmediate(()=>{g=this.getScene().getEngine().createEffect({vertexElement:s,fragmentElement:s},[te.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,p.toString(),b?.fallbacks,void 0),n._setEffect(g)})),this._checkInternals(g)}),n}_createEffectForParticles(e,i,s,n,a,p,_,g=""){let y=this.name+this._buildId+"_"+i;p||(p=new Q2),_||(_=this.getScene().getMeshByName(this.name+"Particle"),_||(_=new Ds(this.name+"Particle",this.getScene()),_.reservedDataStore={hidden:!0}));let b=this._buildId;const v=[];let S=g;if(!a){const M=this._processDefines(_,p);ir.RegisterShader(y,this._fragmentCompilationState._builtCompilationString),e.fillDefines(v,i),S=v.join(`
`),a=this.getScene().getEngine().createEffectForParticles(y,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,p.toString()+`
`+S,M?.fallbacks,s,n,e),e.setCustomEffect(a,i)}a.onBindObservable.add(M=>{b!==this._buildId&&(delete ir.ShadersStore[y+"PixelShader"],y=this.name+this._buildId+"_"+i,p.markAllAsDirty(),b=this._buildId),v.length=0,e.fillDefines(v,i);const F=v.join(`
`);F!==S&&(p.markAllAsDirty(),S=F);const L=this._processDefines(_,p);if(L){ir.RegisterShader(y,this._fragmentCompilationState._builtCompilationString),M=this.getScene().getEngine().createEffectForParticles(y,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,p.toString()+`
`+S,L?.fallbacks,s,n,e),e.setCustomEffect(M,i),this._createEffectForParticles(e,i,s,n,M,p,_,g);return}this._checkInternals(M)})}_checkInternals(e){if(this._sharedData.animatedInputs){const i=this.getScene(),s=i.getFrameId();if(this._animationFrame!==s){for(const n of this._sharedData.animatedInputs)n.animate(i);this._animationFrame=s}}for(const i of this._sharedData.bindableBlocks)i.bind(e,this);for(const i of this._sharedData.inputBlocks)i._transmit(e,this.getScene(),this)}createEffectForParticles(e,i,s){if(this.mode!==Ra.Particle){console.log("Incompatible material mode");return}this._createEffectForParticles(e,w0.BLENDMODE_ONEONE,i,s),this._createEffectForParticles(e,w0.BLENDMODE_MULTIPLY,i,s)}createAsShadowDepthWrapper(e){if(this.mode!==Ra.Material){console.log("Incompatible material mode");return}e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene())}_processDefines(e,i,s=!1,n){let a=null;const p=this.getScene();if(nt.PrepareDefinesForCamera(p,i)&&i.markAsMiscDirty(),this._sharedData.blocksWithDefines.forEach(_=>{_.initializeDefines(e,this,i,s)}),this._sharedData.blocksWithDefines.forEach(_=>{_.prepareDefines(e,this,i,s,n)}),i.isDirty){const _=i._areLightsDisposed;i.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach(S=>{S.replaceRepeatableContent(this._vertexCompilationState,this._fragmentCompilationState,e,i)});const g=[];this._sharedData.dynamicUniformBlocks.forEach(S=>{S.updateUniformsAndSamples(this._vertexCompilationState,this,i,g)});const y=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach(S=>{y.indexOf(S)===-1&&y.push(S)});const b=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach(S=>{b.indexOf(S)===-1&&b.push(S)});const v=new Zh;this._sharedData.blocksWithFallbacks.forEach(S=>{S.provideFallbacks(e,v)}),a={lightDisposed:_,uniformBuffers:g,mergedUniforms:y,mergedSamplers:b,fallbacks:v}}return a}isReadyForSubMesh(e,i,s=!1){if(!this._buildWasSuccessful)return!1;const n=this.getScene();if(this._sharedData.animatedInputs){const g=n.getFrameId();if(this._animationFrame!==g){for(const y of this._sharedData.animatedInputs)y.animate(n);this._animationFrame=g}}if(i.effect&&this.isFrozen&&i.effect._wasPreviouslyReady&&i.effect._wasPreviouslyUsingInstances===s)return!0;i.materialDefines||(i.materialDefines=new Q2);const a=i.materialDefines;if(this._isReadyForSubMesh(i))return!0;const p=n.getEngine();if(this._prepareDefinesForAttributes(e,a),this._sharedData.blockingBlocks.some(g=>!g.isReady(e,this,a,s)))return!1;const _=this._processDefines(e,a,s,i);if(_){const g=i.effect,y=a.toString();let b=p.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:_.mergedUniforms,uniformBuffersNames:_.uniformBuffers,samplers:_.mergedSamplers,defines:y,fallbacks:_.fallbacks,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:a.NUM_MORPH_INFLUENCERS}},p);if(b)if(this._onEffectCreatedObservable&&(Y_.effect=b,Y_.subMesh=i,this._onEffectCreatedObservable.notifyObservers(Y_)),this.allowShaderHotSwapping&&g&&!b.isReady()){if(b=g,a.markAsUnprocessed(),_.lightDisposed)return a._areLightsDisposed=!0,!1}else n.resetCachedMaterial(),i.setEffect(b,a,this._materialContext)}return!i.effect||!i.effect.isReady()?!1:(a._renderId=n.getRenderId(),i.effect._wasPreviouslyReady=!0,i.effect._wasPreviouslyUsingInstances=s,this._checkScenePerformancePriority(),!0)}get compiledShaders(){return`// Vertex shader\r
${this._vertexCompilationState.compilationString}\r
\r
// Fragment shader\r
${this._fragmentCompilationState.compilationString}`}bindOnlyWorldMatrix(e){const i=this.getScene();if(!this._activeEffect)return;const s=this._sharedData.hints;s.needWorldViewMatrix&&e.multiplyToRef(i.getViewMatrix(),this._cachedWorldViewMatrix),s.needWorldViewProjectionMatrix&&e.multiplyToRef(i.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(const n of this._sharedData.inputBlocks)n._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,i,s){const n=this.getScene(),a=s.effect;if(!a)return;this._activeEffect=a,this.bindOnlyWorldMatrix(e);const p=this._mustRebind(n,a,i.visibility),_=this._sharedData;if(p){for(const g of _.bindableBlocks)g.bind(a,this,i,s);for(const g of _.forcedBindableBlocks)g.bind(a,this,i,s);for(const g of _.inputBlocks)g._transmit(a,n,this)}else if(!this.isFrozen)for(const g of _.forcedBindableBlocks)g.bind(a,this,i,s);this._afterBind(i,this._activeEffect)}getActiveTextures(){const e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter(i=>i.texture).map(i=>i.texture)),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}getAllTextureBlocks(){const e=[];for(const i of this.attachedBlocks)os._BlockIsTextureBlock(i)&&e.push(i);return e}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(const i of this._sharedData.textureBlocks)if(i.texture===e)return!0;return!1}dispose(e,i,s){if(i)for(const n of this.getTextureBlocks().filter(a=>a.texture).map(a=>a.texture))n.dispose();for(const n of this.attachedBlocks)n.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,i,s)}_createNodeEditor(){this.BJSNODEMATERIALEDITOR.NodeEditor.Show({nodeMaterial:this})}edit(e){return new Promise(i=>{if(this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),typeof this.BJSNODEMATERIALEDITOR>"u"){const s=e&&e.editorURL?e.editorURL:os.EditorURL;Le.LoadScript(s,()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(),i()})}else this._createNodeEditor(),i()})}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0}setToDefault(){this.clear(),this.editorData=null;const e=new Yn("Position");e.setAsAttribute("position");const i=new Yn("World");i.setAsSystemValue(_r.World);const s=new B_("WorldPos");e.connectTo(s),i.connectTo(s);const n=new Yn("ViewProjection");n.setAsSystemValue(_r.ViewProjection);const a=new B_("WorldPos * ViewProjectionTransform");s.connectTo(a),n.connectTo(a);const p=new Y2("VertexOutput");a.connectTo(p);const _=new Yn("color");_.value=new pi(.8,.8,.8,1);const g=new Mx("FragmentOutput");_.connectTo(g),this.addOutputNode(p),this.addOutputNode(g),this._mode=Ra.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;const e=new Yn("Position");e.setAsAttribute("position2d");const i=new Yn("Constant1");i.isConstant=!0,i.value=1;const s=new K2("Position3D");e.connectTo(s),i.connectTo(s,{input:"w"});const n=new Y2("VertexOutput");s.connectTo(n);const a=new Yn("Scale");a.visibleInInspector=!0,a.value=new ii(1,1);const p=new j2("uv0");e.connectTo(p);const _=new U_("UV scale");p.connectTo(_),a.connectTo(_);const g=new NS("CurrentScreen");_.connectTo(g),g.texture=new Oe("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());const y=new Mx("FragmentOutput");g.connectTo(y,{output:"rgba"}),this.addOutputNode(n),this.addOutputNode(y),this._mode=Ra.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;const e=new Yn("Position");e.setAsAttribute("position2d");const i=new Yn("Constant1");i.isConstant=!0,i.value=1;const s=new K2("Position3D");e.connectTo(s),i.connectTo(s,{input:"w"});const n=new Y2("VertexOutput");s.connectTo(n);const a=new Yn("Time");a.value=0,a.min=0,a.max=0,a.isBoolean=!1,a.matrixMode=0,a.animationType=Px.Time,a.isConstant=!1;const p=new Yn("Color3");p.value=new qe(1,1,1),p.isConstant=!1;const _=new Mx("FragmentOutput"),g=new K2("VectorMerger");g.visibleInInspector=!1;const y=new XS("Cos");y.operation=as.Cos,e.connectTo(g),a.output.connectTo(y.input),y.output.connectTo(g.z),g.xyzOut.connectTo(_.rgb),this.addOutputNode(n),this.addOutputNode(_),this._mode=Ra.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;const e=new Yn("uv");e.setAsAttribute("particle_uv");const i=new BS("ParticleTexture");e.connectTo(i);const s=new Yn("Color");s.setAsAttribute("particle_color");const n=new U_("Texture * Color");i.connectTo(n),s.connectTo(n);const a=new kS("ParticleRampGradient");n.connectTo(a);const p=new WS("ColorSplitter");s.connectTo(p);const _=new US("ParticleBlendMultiply");a.connectTo(_),i.connectTo(_,{output:"a"}),p.connectTo(_,{output:"a"});const g=new Mx("FragmentOutput");_.connectTo(g),this.addOutputNode(g),this._mode=Ra.Particle}async loadAsync(e,i=""){return os.ParseFromFileAsync("",e,this.getScene(),i,!0,this)}_gatherBlocks(e,i){if(i.indexOf(e)===-1){i.push(e);for(const s of e.inputs){const n=s.connectedPoint;if(n){const a=n.ownerBlock;a!==e&&this._gatherBlocks(a,i)}}}}generateCode(){let e=[];const i=[],s=["const","var","let"];for(const p of this._vertexOutputNodes)this._gatherBlocks(p,i);const n=[];for(const p of this._fragmentOutputNodes)this._gatherBlocks(p,n);let a=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");\r
`;for(const p of i)p.isInput&&e.indexOf(p)===-1&&(a+=p._dumpCode(s,e));for(const p of n)p.isInput&&e.indexOf(p)===-1&&(a+=p._dumpCode(s,e));e=[],a+=`\r
// Connections\r
`;for(const p of this._vertexOutputNodes)a+=p._dumpCodeForOutputConnections(e);for(const p of this._fragmentOutputNodes)a+=p._dumpCodeForOutputConnections(e);a+=`\r
// Output nodes\r
`;for(const p of this._vertexOutputNodes)a+=`nodeMaterial.addOutputNode(${p._codeVariableName});\r
`;for(const p of this._fragmentOutputNodes)a+=`nodeMaterial.addOutputNode(${p._codeVariableName});\r
`;return a+=`nodeMaterial.build();\r
`,a}serialize(e){const i=e?{}:Kt.Serialize(this);i.editorData=JSON.parse(JSON.stringify(this.editorData));let s=[];if(e)s=e;else{i.customType="BABYLON.NodeMaterial",i.outputNodes=[];for(const n of this._vertexOutputNodes)this._gatherBlocks(n,s),i.outputNodes.push(n.uniqueId);for(const n of this._fragmentOutputNodes)this._gatherBlocks(n,s),i.outputNodes.indexOf(n.uniqueId)===-1&&i.outputNodes.push(n.uniqueId)}i.blocks=[];for(const n of s)i.blocks.push(n.serialize());if(!e)for(const n of this.attachedBlocks)s.indexOf(n)===-1&&i.blocks.push(n.serialize());return i}_restoreConnections(e,i,s){for(const n of e.outputs)for(const a of i.blocks){const p=s[a.id];if(!!p){for(const _ of a.inputs)if(s[_.targetBlockId]===e&&_.targetConnectionName===n.name){const g=p.getInputByName(_.inputName);if(!g||g.isConnected)continue;n.connectTo(g,!0),this._restoreConnections(p,i,s);continue}}}}parseSerializedObject(e,i="",s=!1){var n;s||this.clear();const a={};for(const p of e.blocks){const _=Ka(p.customType);if(_){const g=new _;g._deserialize(p,this.getScene(),i),a[p.id]=g,this.attachedBlocks.push(g)}}for(let p=0;p<e.blocks.length;p++){const _=e.blocks[p],g=a[_.id];!g||g.inputs.length&&!s||this._restoreConnections(g,e,a)}if(e.outputNodes)for(const p of e.outputNodes)this.addOutputNode(a[p]);if(e.locations||e.editorData&&e.editorData.locations){const p=e.locations||e.editorData.locations;for(const g of p)a[g.blockId]&&(g.blockId=a[g.blockId].uniqueId);s&&this.editorData&&this.editorData.locations&&p.concat(this.editorData.locations),e.locations?this.editorData={locations:p}:(this.editorData=e.editorData,this.editorData.locations=p);const _=[];for(const g in a)_[g]=a[g].uniqueId;this.editorData.map=_}this.comment=e.comment,e.forceAlphaBlending!==void 0&&(this.forceAlphaBlending=e.forceAlphaBlending),s||(this._mode=(n=e.mode)!==null&&n!==void 0?n:Ra.Material)}loadFromSerialization(e,i="",s=!1){this.parseSerializedObject(e,i,s)}clone(e,i=!1){const s=this.serialize(),n=Kt.Clone(()=>new os(e,this.getScene(),this.options),this);return n.id=e,n.name=e,n.parseSerializedObject(s),n._buildId=this._buildId,n.build(!1,!i),n}static Parse(e,i,s=""){const n=Kt.Parse(()=>new os(e.name,i),e,i,s);return n.parseSerializedObject(e,s),n.build(),n}static async ParseFromFileAsync(e,i,s,n="",a=!1,p){const _=p??new os(e,s),g=await s._loadFileAsync(i),y=JSON.parse(g);return _.parseSerializedObject(y,n),a||_.build(),_}static ParseFromSnippetAsync(e,i=Zt.LastCreatedScene,s="",n,a=!1){return e==="_BLANK"?Promise.resolve(os.CreateDefault("blank",i)):new Promise((p,_)=>{const g=new en;g.addEventListener("readystatechange",()=>{if(g.readyState==4)if(g.status==200){const y=JSON.parse(JSON.parse(g.responseText).jsonPayload),b=JSON.parse(y.nodeMaterial);n||(n=Kt.Parse(()=>new os(e,i),b,i,s),n.uniqueId=i.getUniqueId()),n.parseSerializedObject(b),n.snippetId=e;try{a||n.build(),p(n)}catch(v){_(v)}}else _("Unable to load the snippet "+e)}),g.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),g.send()})}static CreateDefault(e,i){const s=new os(e,i);return s.setToDefault(),s.build(),s}}os._BuildIdGenerator=0,os.EditorURL=`https://unpkg.com/babylonjs-node-editor@${Ae.Version}/babylon.nodeEditor.js`,os.SnippetUrl="https://snippet.babylonjs.com",os.IgnoreTexturesAtLoadTime=!1,J([xe()],os.prototype,"ignoreAlpha",void 0),J([xe()],os.prototype,"maxSimultaneousLights",void 0),J([xe("mode")],os.prototype,"_mode",void 0),J([xe("comment")],os.prototype,"comment",void 0),J([xe()],os.prototype,"forceAlphaBlending",void 0),ur("BABYLON.NodeMaterial",os),Sn.prototype._projectOnTrianglesToRef=function(l,e,i,s,n,a){const p=ge.Vector3[0],_=ge.Vector3[1];let g=1/0;for(let y=this.indexStart;y<this.indexStart+this.indexCount-(3-s);y+=s){const b=i[y],v=i[y+1],S=i[y+2];if(n&&S===4294967295){y+=2;continue}const M=e[b],F=e[v],L=e[S];if(!M||!F||!L)continue;const N=j.ProjectOnTriangleToRef(l,M,F,L,_);N<g&&(p.copyFrom(_),g=N)}return a.copyFrom(p),g},Sn.prototype._projectOnUnIndexedTrianglesToRef=function(l,e,i,s){const n=ge.Vector3[0],a=ge.Vector3[1];let p=1/0;for(let _=this.verticesStart;_<this.verticesStart+this.verticesCount;_+=3){const g=e[_],y=e[_+1],b=e[_+2],v=j.ProjectOnTriangleToRef(l,g,y,b,a);v<p&&(n.copyFrom(a),p=v)}return s.copyFrom(n),p},Sn.prototype.projectToRef=function(l,e,i,s){const n=this.getMaterial();if(!n)return-1;let a=3,p=!1;switch(n.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:a=1,p=!0;break;default:break}return n.fillMode===4?-1:!i.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(l,e,i,s):this._projectOnTrianglesToRef(l,e,i,a,p,s)};var ca;(function(l){l[l.DEHYDRATED=0]="DEHYDRATED",l[l.HOVER=1]="HOVER",l[l.TOUCH=2]="TOUCH"})(ca||(ca={}));var El;(function(l){l[l.DISABLED=0]="DISABLED",l[l.CENTERED_ON_CONTROLLER=1]="CENTERED_ON_CONTROLLER",l[l.CENTERED_IN_FRONT=2]="CENTERED_IN_FRONT"})(El||(El={}));class qo extends N_{constructor(e,i){super(e),this._options=i,this._tmpRay=new wi(new j,new j),this._attachController=s=>{if(this._controllers[s.uniqueId])return;const{touchCollisionMesh:n,touchCollisionMeshFunction:a,hydrateCollisionMeshFunction:p}=this._generateNewTouchPointMesh(),_=this._generateVisualCue();switch(this._controllers[s.uniqueId]={xrController:s,meshUnderPointer:null,nearInteractionTargetMesh:null,pick:null,stalePick:null,touchCollisionMesh:n,touchCollisionMeshFunction:a,hydrateCollisionMeshFunction:p,currentAnimationState:ca.DEHYDRATED,grabRay:new wi(new j,new j),hoverInteraction:!1,nearInteraction:!1,grabInteraction:!1,id:qo._IdCounter++,pickedPointVisualCue:_},this._attachedController?!this._options.enableNearInteractionOnAllControllers&&this._options.preferredHandedness&&s.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=s.uniqueId):this._options.enableNearInteractionOnAllControllers||(this._attachedController=s.uniqueId),s.inputSource.targetRayMode){case"tracked-pointer":return this._attachNearInteractionMode(s);case"gaze":return null;case"screen":return null}},this._controllers={},this._farInteractionFeature=null,this.selectionMeshDefaultColor=new qe(.8,.8,.8),this.selectionMeshPickedColor=new qe(.3,.3,1),this._hoverRadius=.1,this._pickRadius=.02,this._controllerPickRadius=.03,this._nearGrabLengthScale=5,this._scene=this._xrSessionManager.scene,this._options.nearInteractionControllerMode===void 0&&(this._options.nearInteractionControllerMode=El.CENTERED_IN_FRONT),this._options.farInteractionFeature&&(this._farInteractionFeature=this._options.farInteractionFeature)}attach(){return super.attach()?(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._scene.constantlyUpdateMeshUnderPointer=!0,!0):!1}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),!0):!1}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const i=Object.keys(this._controllers);for(let s=0;s<i.length;++s)if(this._controllers[i[s]].id===e)return this._controllers[i[s]].xrController||null;return null}setFarInteractionFeature(e){this._farInteractionFeature=e}_nearPickPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearPickable}_nearGrabPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearGrabbable}_nearInteractionPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&(e.isNearPickable||e.isNearGrabbable)}_controllerAvailablePredicate(e,i){let s=e;for(;s;){if(s.reservedDataStore&&s.reservedDataStore.nearInteraction&&s.reservedDataStore.nearInteraction.excludedControllerId===i)return!1;s=s.parent}return!0}_handleTransitionAnimation(e,i){var s;if(!(e.currentAnimationState===i||this._options.nearInteractionControllerMode!==El.CENTERED_IN_FRONT||!!(!((s=e.xrController)===null||s===void 0)&&s.inputSource.hand))){if(i>e.currentAnimationState)switch(e.currentAnimationState){case ca.DEHYDRATED:if(e.hydrateCollisionMeshFunction(!0),i===ca.HOVER)break;case ca.HOVER:if(e.touchCollisionMeshFunction(!0),i===ca.TOUCH)break}else switch(e.currentAnimationState){case ca.TOUCH:if(e.touchCollisionMeshFunction(!1),i===ca.HOVER)break;case ca.HOVER:if(e.hydrateCollisionMeshFunction(!1),i===ca.DEHYDRATED)break}e.currentAnimationState=i}}_processTouchPoint(e,i,s){var n;const a=this._controllers[e];a.grabRay.origin.copyFrom(i),s.toEulerAnglesToRef(ge.Vector3[0]),a.grabRay.direction.copyFrom(ge.Vector3[0]),this._options.nearInteractionControllerMode===El.CENTERED_IN_FRONT&&!(!((n=a.xrController)===null||n===void 0)&&n.inputSource.hand)&&(a.xrController.getWorldPointerRayToRef(this._tmpRay),a.grabRay.origin.addInPlace(this._tmpRay.direction.scale(.05))),a.grabRay.length=this._nearGrabLengthScale*this._hoverRadius,a.touchCollisionMesh.position.copyFrom(a.grabRay.origin)}_onXRFrame(e){Object.keys(this._controllers).forEach(i=>{var s;const n=this._controllers[i],a=(s=n.xrController)===null||s===void 0?void 0:s.inputSource.hand;if(!this._options.enableNearInteractionOnAllControllers&&i!==this._attachedController||!n.xrController||!a&&(!this._options.nearInteractionControllerMode||!n.xrController.inputSource.gamepad)){n.pick=null;return}if(n.hoverInteraction=!1,n.nearInteraction=!1,n.xrController){if(a){const y=a.get("index-finger-tip");if(y){const b=e.getJointPose(y,this._xrSessionManager.referenceSpace);if(b&&b.transform){const v=this._scene.useRightHandedSystem?1:-1;ge.Vector3[0].set(b.transform.position.x,b.transform.position.y,b.transform.position.z*v),ge.Quaternion[0].set(b.transform.orientation.x,b.transform.orientation.y,b.transform.orientation.z*v,b.transform.orientation.w*v),this._processTouchPoint(i,ge.Vector3[0],ge.Quaternion[0])}}}else if(n.xrController.inputSource.gamepad&&this._options.nearInteractionControllerMode!==El.DISABLED){let y=n.xrController.pointer;n.xrController.grip&&this._options.nearInteractionControllerMode===El.CENTERED_ON_CONTROLLER&&(y=n.xrController.grip),this._processTouchPoint(i,y.position,y.rotationQuaternion)}}else return;const p=(y,b)=>{let v=null;return!b||!b.hit?v=y:!y||!y.hit||b.distance<y.distance?v=b:v=y,v},_=y=>{let b=new In,v=!1;const S=y&&y.pickedPoint&&y.hit;return y?.pickedPoint&&(v=y.pickedPoint.x===0&&y.pickedPoint.y===0&&y.pickedPoint.z===0),S&&!v&&(b=y),b};if(!n.grabInteraction){let y=null,b=null;this._options.useUtilityLayer&&this._utilityLayerScene&&(b=this._pickWithSphere(n,this._hoverRadius,this._utilityLayerScene,M=>this._nearInteractionPredicate(M)));const v=this._pickWithSphere(n,this._hoverRadius,this._scene,M=>this._nearInteractionPredicate(M)),S=p(v,b);if(S&&S.hit&&(y=_(S),y.hit&&(n.hoverInteraction=!0)),n.hoverInteraction){let M=null;const F=a?this._pickRadius:this._controllerPickRadius;this._options.useUtilityLayer&&this._utilityLayerScene&&(M=this._pickWithSphere(n,F,this._utilityLayerScene,G=>this._nearPickPredicate(G)));const L=this._pickWithSphere(n,F,this._scene,G=>this._nearPickPredicate(G)),N=p(L,M),k=_(N);k.hit&&(y=k,n.nearInteraction=!0)}n.stalePick=n.pick,n.pick=y,n.pick&&n.pick.pickedPoint&&n.pick.hit?(n.meshUnderPointer=n.pick.pickedMesh,n.pickedPointVisualCue.position.copyFrom(n.pick.pickedPoint),n.pickedPointVisualCue.isVisible=!0,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(n.id,!0)):(n.meshUnderPointer=null,n.pickedPointVisualCue.isVisible=!1,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(n.id,!1))}let g=ca.DEHYDRATED;n.grabInteraction||n.nearInteraction?g=ca.TOUCH:n.hoverInteraction&&(g=ca.HOVER),this._handleTransitionAnimation(n,g)})}get _utilityLayerScene(){return this._options.customUtilityLayerScene||Xr.DefaultUtilityLayer.utilityLayerScene}_generateVisualCue(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Xr.DefaultUtilityLayer.utilityLayerScene:this._scene,i=lu("nearInteraction",{diameter:.0035*3},e);i.bakeCurrentTransformIntoVertices(),i.isPickable=!1,i.isVisible=!1,i.rotationQuaternion=Ve.Identity();const s=new ot("targetMat",e);return s.specularColor=qe.Black(),s.emissiveColor=this.selectionMeshDefaultColor,s.backFaceCulling=!1,i.material=s,i}_isControllerReadyForNearInteraction(e){return this._farInteractionFeature?this._farInteractionFeature._getPointerSelectionDisabledByPointerId(e):!0}_attachNearInteractionMode(e){const i=this._controllers[e.uniqueId],s={pointerId:i.id,pointerType:"xr-near"};i.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{!this._options.enableNearInteractionOnAllControllers&&e.uniqueId!==this._attachedController||!i.xrController||!i.xrController.inputSource.hand&&(!this._options.nearInteractionControllerMode||!i.xrController.inputSource.gamepad)||(i.pick&&(i.pick.ray=i.grabRay),i.pick&&this._isControllerReadyForNearInteraction(i.id)&&this._scene.simulatePointerMove(i.pick,s),i.nearInteraction&&i.pick&&i.pick.hit?i.nearInteractionTargetMesh||(this._scene.simulatePointerDown(i.pick,s),i.nearInteractionTargetMesh=i.meshUnderPointer):i.nearInteractionTargetMesh&&i.stalePick&&(this._scene.simulatePointerUp(i.stalePick,s),i.nearInteractionTargetMesh=null))});const n=a=>{this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController&&this._isControllerReadyForNearInteraction(i.id)?(i.pick&&(i.pick.ray=i.grabRay),a&&i.pick&&i.meshUnderPointer&&this._nearGrabPredicate(i.meshUnderPointer)?(i.grabInteraction=!0,i.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(i.pick,s)):!a&&i.pick&&i.grabInteraction&&(this._scene.simulatePointerUp(i.pick,s),i.grabInteraction=!1,i.pickedPointVisualCue.isVisible=!0)):a&&!this._options.enableNearInteractionOnAllControllers&&!this._options.disableSwitchOnClick&&(this._attachedController=e.uniqueId)};if(e.inputSource.gamepad){const a=p=>{i.squeezeComponent=p.getComponent("grasp"),i.squeezeComponent?i.onSqueezeButtonChangedObserver=i.squeezeComponent.onButtonStateChangedObservable.add(_=>{if(_.changes.pressed){const g=_.changes.pressed.current;n(g)}}):(i.selectionComponent=p.getMainComponent(),i.onButtonChangedObserver=i.selectionComponent.onButtonStateChangedObservable.add(_=>{if(_.changes.pressed){const g=_.changes.pressed.current;n(g)}}))};e.motionController?a(e.motionController):e.onMotionControllerInitObservable.add(a)}else{const a=_=>{i.xrController&&_.inputSource===i.xrController.inputSource&&i.pick&&this._isControllerReadyForNearInteraction(i.id)&&i.meshUnderPointer&&this._nearGrabPredicate(i.meshUnderPointer)&&(i.grabInteraction=!0,i.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(i.pick,s))},p=_=>{i.xrController&&_.inputSource===i.xrController.inputSource&&i.pick&&this._isControllerReadyForNearInteraction(i.id)&&(this._scene.simulatePointerUp(i.pick,s),i.grabInteraction=!1,i.pickedPointVisualCue.isVisible=!0)};i.eventListeners={selectend:p,selectstart:a},this._xrSessionManager.session.addEventListener("selectstart",a),this._xrSessionManager.session.addEventListener("selectend",p)}}_detachController(e){const i=this._controllers[e];if(!!i&&(i.squeezeComponent&&i.onSqueezeButtonChangedObserver&&i.squeezeComponent.onButtonStateChangedObservable.remove(i.onSqueezeButtonChangedObserver),i.selectionComponent&&i.onButtonChangedObserver&&i.selectionComponent.onButtonStateChangedObservable.remove(i.onButtonChangedObserver),i.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(i.onFrameObserver),i.eventListeners&&Object.keys(i.eventListeners).forEach(s=>{const n=i.eventListeners&&i.eventListeners[s];n&&this._xrSessionManager.session.removeEventListener(s,n)}),i.touchCollisionMesh.dispose(),i.pickedPointVisualCue.dispose(),this._xrSessionManager.runInXRFrame(()=>{const s={pointerId:i.id,pointerType:"xr-near"};this._scene.simulatePointerUp(new In,s)}),delete this._controllers[e],this._attachedController===e)){const s=Object.keys(this._controllers);s.length?this._attachedController=s[0]:this._attachedController=""}}_generateNewTouchPointMesh(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Xr.DefaultUtilityLayer.utilityLayerScene:this._scene,i=lu("PickSphere",{diameter:1},e);i.isVisible=!1,this._options.motionControllerOrbMaterial?i.material=this._options.motionControllerOrbMaterial:os.ParseFromSnippetAsync("8RUNKL#3",e).then(Z=>{i.material=Z});const s=new sz;s.setEasingMode(sn.EASINGMODE_EASEINOUT);const n=new j(this._controllerPickRadius,this._controllerPickRadius,this._controllerPickRadius),a=this._controllerPickRadius*(4/3),p=new j(a,a,a),_=this._controllerPickRadius*(7/6),g=new j(_,_,_),y=this._controllerPickRadius*(4/5),b=new j(y,y,y),v=this._controllerPickRadius*(3/2),S=new j(v,v,v),M=[{frame:0,value:n},{frame:10,value:S},{frame:18,value:p}],F=[{frame:0,value:p},{frame:10,value:b},{frame:18,value:n}],L=[{frame:0,value:j.ZeroReadOnly},{frame:12,value:g},{frame:15,value:n}],N=[{frame:0,value:n},{frame:10,value:j.ZeroReadOnly},{frame:15,value:j.ZeroReadOnly}],k=new Ce("touch","scaling",60,Ce.ANIMATIONTYPE_VECTOR3,Ce.ANIMATIONLOOPMODE_CONSTANT),G=new Ce("release","scaling",60,Ce.ANIMATIONTYPE_VECTOR3,Ce.ANIMATIONLOOPMODE_CONSTANT),H=new Ce("hydrate","scaling",60,Ce.ANIMATIONTYPE_VECTOR3,Ce.ANIMATIONLOOPMODE_CONSTANT),z=new Ce("dehydrate","scaling",60,Ce.ANIMATIONTYPE_VECTOR3,Ce.ANIMATIONLOOPMODE_CONSTANT);return k.setEasingFunction(s),G.setEasingFunction(s),H.setEasingFunction(s),z.setEasingFunction(s),k.setKeys(M),G.setKeys(F),H.setKeys(L),z.setKeys(N),{touchCollisionMesh:i,touchCollisionMeshFunction:Z=>{const Q=Z?k:G;e.beginDirectAnimation(i,[Q],0,18,!1,1)},hydrateCollisionMeshFunction:Z=>{const Q=Z?H:z;Z&&(i.isVisible=!0),e.beginDirectAnimation(i,[Q],0,15,!1,1,()=>{Z||(i.isVisible=!1)})}}}_pickWithSphere(e,i,s,n){const a=new In;if(a.distance=1/0,e.touchCollisionMesh&&e.xrController){const p=e.touchCollisionMesh.position,_=A0.CreateFromCenterAndRadius(p,i);for(let g=0;g<s.meshes.length;g++){const y=s.meshes[g];if(!n(y)||!this._controllerAvailablePredicate(y,e.xrController.uniqueId))continue;const b=qo.PickMeshWithSphere(y,_);b&&b.hit&&b.distance<a.distance&&(a.hit=b.hit,a.pickedMesh=y,a.pickedPoint=b.pickedPoint,a.aimTransform=e.xrController.pointer,a.gripTransform=e.xrController.grip||null,a.originMesh=e.touchCollisionMesh,a.distance=b.distance)}}return a}static PickMeshWithSphere(e,i,s=!1){const n=e.subMeshes,a=new In,p=e.getBoundingInfo();if(!e._generatePointsArray()||!e.subMeshes||!p||!s&&!A0.Intersects(p.boundingSphere,i))return a;const _=ge.Vector3[0],g=ge.Vector3[1];let y=1/0,b,v,S;const M=ge.Vector3[2],F=ge.Matrix[0];F.copyFrom(e.getWorldMatrix()),F.invert(),j.TransformCoordinatesToRef(i.center,F,M);for(let L=0;L<n.length;L++)n[L].projectToRef(M,e._positions,e.getIndices(),g),j.TransformCoordinatesToRef(g,e.getWorldMatrix(),g),b=j.Distance(g,i.center),S=j.Distance(g,e.getAbsolutePosition()),v=j.Distance(i.center,e.getAbsolutePosition()),v!==-1&&S!==-1&&S>v&&(b=0,g.copyFrom(i.center)),b!==-1&&b<y&&(y=b,_.copyFrom(g));return y<i.radius&&(a.hit=!0,a.distance=y,a.pickedMesh=e,a.pickedPoint=_.clone()),a}}qo._IdCounter=200,qo.Name=Dr.NEAR_INTERACTION,qo.Version=1,To.AddWebXRFeature(qo.Name,(l,e)=>()=>new qo(l,e),qo.Version,!0);class $z{constructor(e,i,s){this.element=e,this.sessionMode=i,this.referenceSpaceType=s}update(e){}}class Qq{}class K_{constructor(e,i){if(this._scene=e,this.options=i,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new Re,this._onSessionGranted=n=>{this._helper&&this._enterXRWithButtonIndex(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),!i.ignoreSessionGrantedEvent&&navigator.xr&&navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),typeof window<"u"&&window.location&&window.location.protocol==="http:"&&window.location.hostname!=="localhost")throw Le.Warn("WebXR can only be served over HTTPS"),new Error("WebXR can only be served over HTTPS");if(i.customButtons)this._buttons=i.customButtons;else{this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;";const n=i.sessionMode||"immersive-vr",a=i.referenceSpaceType||"local-floor";let _=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(typeof SVGSVGElement>"u"?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";_+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';const g=document.createElement("style");g.appendChild(document.createTextNode(_)),document.getElementsByTagName("head")[0].appendChild(g);const y=document.createElement("button");y.className="babylonVRicon",y.title=`${n} - ${a}`,this._buttons.push(new $z(y,n,a)),this._buttons[this._buttons.length-1].update=function(b){this.element.style.display=b===null||b===this?"":"none",y.className="babylonVRicon"+(b===this?" vrdisplaypresenting":"")},this._updateButtons(null)}const s=e.getEngine().getInputElement();s&&s.parentNode&&(s.parentNode.appendChild(this.overlay),e.onDisposeObservable.addOnce(()=>{this.dispose()}))}async setHelperAsync(e,i){this._helper=e,this._renderTarget=i;const s=this._buttons.map(a=>e.sessionManager.isSessionSupportedAsync(a.sessionMode));e.onStateChangedObservable.add(a=>{a==ns.NOT_IN_XR&&this._updateButtons(null)}),(await Promise.all(s)).forEach((a,p)=>{a?(this.overlay.appendChild(this._buttons[p].element),this._buttons[p].element.onclick=this._enterXRWithButtonIndex.bind(this,p)):Le.Warn(`Session mode "${this._buttons[p].sessionMode}" not supported in browser`)})}static async CreateAsync(e,i,s){const n=new K_(e,s);return await n.setHelperAsync(i,s.renderTarget||void 0),n}async _enterXRWithButtonIndex(e=0){if(this._helper.state==ns.IN_XR)await this._helper.exitXRAsync(),this._updateButtons(null);else if(this._helper.state==ns.NOT_IN_XR)try{await this._helper.enterXRAsync(this._buttons[e].sessionMode,this._buttons[e].referenceSpaceType,this._renderTarget,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures}),this._updateButtons(this._buttons[e])}catch(i){this._updateButtons(null);const s=this._buttons[e].element,n=s.title;s.title="Error entering XR session : "+n,s.classList.add("xr-error"),this.options.onError&&this.options.onError(i)}}dispose(){const e=this._scene.getEngine().getInputElement();e&&e.parentNode&&e.parentNode.contains(this.overlay)&&e.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)}_updateButtons(e){this._activeButton=e,this._buttons.forEach(i=>{i.update(this._activeButton)}),this.activeButtonChangedObservable.notifyObservers(this._activeButton)}}Qe._instancedMeshFactory=(l,e)=>{const i=new j_(l,e);if(e.instancedBuffers){i.instancedBuffers={};for(const s in e.instancedBuffers)i.instancedBuffers[s]=e.instancedBuffers[s]}return i};class j_ extends Ds{constructor(e,i){super(e,i.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,i.addInstance(this),this._sourceMesh=i,this._unIndexed=i._unIndexed,this.position.copyFrom(i.position),this.rotation.copyFrom(i.rotation),this.scaling.copyFrom(i.scaling),i.rotationQuaternion&&(this.rotationQuaternion=i.rotationQuaternion.clone()),this.animations=i.animations.slice();for(const s of i.getAnimationRanges())s!=null&&this.createAnimationRange(s.name,s.from,s.to);this.infiniteDistance=i.infiniteDistance,this.setPivotMatrix(i.getPivotMatrix()),this.refreshBoundingInfo(!0,!0),this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){var i;((i=this._sourceMesh)===null||i===void 0?void 0:i.receiveShadows)!==e&&Le.Warn("Setting receiveShadows on an instanced mesh has no effect")}get material(){return this._sourceMesh.material}set material(e){var i;((i=this._sourceMesh)===null||i===void 0?void 0:i.material)!==e&&Le.Warn("Setting material on an instanced mesh has no effect")}get visibility(){return this._sourceMesh.visibility}set visibility(e){var i;((i=this._sourceMesh)===null||i===void 0?void 0:i.visibility)!==e&&Le.Warn("Setting visibility on an instanced mesh has no effect")}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){var i;((i=this._sourceMesh)===null||i===void 0?void 0:i.skeleton)!==e&&Le.Warn("Setting skeleton on an instanced mesh has no effect")}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){!this._sourceMesh||e===this._sourceMesh.renderingGroupId||Ie.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,i,s){return this._sourceMesh.getVerticesData(e,i,s)}setVerticesData(e,i,s,n){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,i,s,n),this.sourceMesh}updateVerticesData(e,i,s,n){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,i,s,n),this.sourceMesh}setIndices(e,i=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,i),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,i=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const s=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getPositionData(e,i),s),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,i){if(super._activate(e,i),this._sourceMesh.subMeshes||Ie.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),i){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD.billboardMode!==Jt.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new fe);const e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,ge.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(ge.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;const i=this.sourceMesh.getLODLevels();if(!i||i.length===0)this._currentLOD=this.sourceMesh;else{const s=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,s.boundingSphere)}return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,i=null,s,n){const a=(n||this._sourceMesh).createInstance(e);if(Ya.DeepCopy(this,a,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),i&&(a.parent=i),!s)for(let p=0;p<this.getScene().meshes.length;p++){const _=this.getScene().meshes[p];_.parent===this&&_.clone(_.name,a)}return a.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(a),a}dispose(e,i=!1){this._sourceMesh.removeInstance(this),super.dispose(e,i)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,i,s){const n=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,i&&i.newSourcedMesh);n&&s&&s(this,n);for(const a of this.getChildTransformNodes(!0))a.instantiateHierarchy(n,i,s);return n}}Qe.prototype.registerInstancedBuffer=function(l,e){var i,s;if((s=(i=this._userInstancedBuffersStorage)===null||i===void 0?void 0:i.vertexBuffers[l])===null||s===void 0||s.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(const n of this.instances)n.instancedBuffers={};this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0})}this.instancedBuffers[l]=null,this._userInstancedBuffersStorage.strides[l]=e,this._userInstancedBuffersStorage.sizes[l]=e*32,this._userInstancedBuffersStorage.data[l]=new Float32Array(this._userInstancedBuffersStorage.sizes[l]),this._userInstancedBuffersStorage.vertexBuffers[l]=new te(this.getEngine(),this._userInstancedBuffersStorage.data[l],l,!0,!1,e,!0);for(const n of this.instances)n.instancedBuffers[l]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()},Qe.prototype._processInstancedBuffers=function(l,e){const i=l?l.length:0;for(const s in this.instancedBuffers){let n=this._userInstancedBuffersStorage.sizes[s];const a=this._userInstancedBuffersStorage.strides[s],p=(i+1)*a;for(;n<p;)n*=2;this._userInstancedBuffersStorage.data[s].length!=n&&(this._userInstancedBuffersStorage.data[s]=new Float32Array(n),this._userInstancedBuffersStorage.sizes[s]=n,this._userInstancedBuffersStorage.vertexBuffers[s]&&(this._userInstancedBuffersStorage.vertexBuffers[s].dispose(),this._userInstancedBuffersStorage.vertexBuffers[s]=null));const _=this._userInstancedBuffersStorage.data[s];let g=0;if(e){const y=this.instancedBuffers[s];y.toArray?y.toArray(_,g):y.copyToArray?y.copyToArray(_,g):_[g]=y,g+=a}for(let y=0;y<i;y++){const v=l[y].instancedBuffers[s];v.toArray?v.toArray(_,g):v.copyToArray?v.copyToArray(_,g):_[g]=v,g+=a}this._userInstancedBuffersStorage.vertexBuffers[s]?this._userInstancedBuffersStorage.vertexBuffers[s].updateDirectly(_,0):(this._userInstancedBuffersStorage.vertexBuffers[s]=new te(this.getEngine(),this._userInstancedBuffersStorage.data[s],s,!0,!1,a,!0),this._invalidateInstanceVertexArrayObject())}},Qe.prototype._invalidateInstanceVertexArrayObject=function(){if(!(!this._userInstancedBuffersStorage||this._userInstancedBuffersStorage.vertexArrayObjects===void 0)){for(const l in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[l]);this._userInstancedBuffersStorage.vertexArrayObjects={}}},Qe.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(const l in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[l]&&this._userInstancedBuffersStorage.vertexBuffers[l].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};const q_={effect:null,subMesh:null};class Zo extends qh{constructor(e,i,s,n={},a=!0){super(e,i,a),this._textures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._uints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new fe,this._cachedWorldViewProjectionMatrix=new fe,this._multiview=!1,this._shaderPath=s,this._options={needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1,...n}}get shaderPath(){return this._shaderPath}set shaderPath(e){this._shaderPath=e}get options(){return this._options}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(e){this._options.uniforms.indexOf(e)===-1&&this._options.uniforms.push(e)}setTexture(e,i){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._textures[e]=i,this}setTextureArray(e,i){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=i,this}setExternalTexture(e,i){return this._options.externalTextures.indexOf(e)===-1&&this._options.externalTextures.push(e),this._externalTextures[e]=i,this}setFloat(e,i){return this._checkUniform(e),this._floats[e]=i,this}setInt(e,i){return this._checkUniform(e),this._ints[e]=i,this}setUInt(e,i){return this._checkUniform(e),this._uints[e]=i,this}setFloats(e,i){return this._checkUniform(e),this._floatsArrays[e]=i,this}setColor3(e,i){return this._checkUniform(e),this._colors3[e]=i,this}setColor3Array(e,i){return this._checkUniform(e),this._colors3Arrays[e]=i.reduce((s,n)=>(n.toArray(s,s.length),s),[]),this}setColor4(e,i){return this._checkUniform(e),this._colors4[e]=i,this}setColor4Array(e,i){return this._checkUniform(e),this._colors4Arrays[e]=i.reduce((s,n)=>(n.toArray(s,s.length),s),[]),this}setVector2(e,i){return this._checkUniform(e),this._vectors2[e]=i,this}setVector3(e,i){return this._checkUniform(e),this._vectors3[e]=i,this}setVector4(e,i){return this._checkUniform(e),this._vectors4[e]=i,this}setQuaternion(e,i){return this._checkUniform(e),this._quaternions[e]=i,this}setQuaternionArray(e,i){return this._checkUniform(e),this._quaternionsArrays[e]=i.reduce((s,n)=>(n.toArray(s,s.length),s),[]),this}setMatrix(e,i){return this._checkUniform(e),this._matrices[e]=i,this}setMatrices(e,i){this._checkUniform(e);const s=new Float32Array(i.length*16);for(let n=0;n<i.length;n++)i[n].copyToArray(s,n*16);return this._matrixArrays[e]=s,this}setMatrix3x3(e,i){return this._checkUniform(e),this._matrices3x3[e]=i,this}setMatrix2x2(e,i){return this._checkUniform(e),this._matrices2x2[e]=i,this}setArray2(e,i){return this._checkUniform(e),this._vectors2Arrays[e]=i,this}setArray3(e,i){return this._checkUniform(e),this._vectors3Arrays[e]=i,this}setArray4(e,i){return this._checkUniform(e),this._vectors4Arrays[e]=i,this}setUniformBuffer(e,i){return this._options.uniformBuffers.indexOf(e)===-1&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=i,this}setTextureSampler(e,i){return this._options.samplerObjects.indexOf(e)===-1&&this._options.samplerObjects.push(e),this._textureSamplers[e]=i,this}setStorageBuffer(e,i){return this._options.storageBuffers.indexOf(e)===-1&&this._options.storageBuffers.push(e),this._storageBuffers[e]=i,this}isReadyForSubMesh(e,i,s){return this.isReady(e,s,i)}isReady(e,i,s){var n,a,p,_;const g=s&&this._storeEffectOnSubMeshes;if(this.isFrozen)if(g){if(s.effect&&s.effect._wasPreviouslyReady)return!0}else{const se=this._drawWrapper.effect;if(se&&se._wasPreviouslyReady&&se._wasPreviouslyUsingInstances===i)return!0}const y=this.getScene(),b=y.getEngine(),v=[],S=[],M=new Zh;let F=this._shaderPath,L=this._options.uniforms,N=this._options.uniformBuffers,k=this._options.samplers;b.getCaps().multiview&&y.activeCamera&&y.activeCamera.outputRenderTarget&&y.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,v.push("#define MULTIVIEW"),this._options.uniforms.indexOf("viewProjection")!==-1&&this._options.uniforms.indexOf("viewProjectionR")===-1&&this._options.uniforms.push("viewProjectionR"));for(let se=0;se<this._options.defines.length;se++){const $=this._options.defines[se].indexOf("#define")===0?this._options.defines[se]:`#define ${this._options.defines[se]}`;v.push($)}for(let se=0;se<this._options.attributes.length;se++)S.push(this._options.attributes[se]);if(e&&e.isVerticesDataPresent(te.ColorKind)&&(S.push(te.ColorKind),v.push("#define VERTEXCOLOR")),i&&(v.push("#define INSTANCES"),nt.PushAttributesForInstances(S),e?.hasThinInstances&&(v.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(te.ColorInstanceKind)&&(S.push(te.ColorInstanceKind),v.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){S.push(te.MatricesIndicesKind),S.push(te.MatricesWeightsKind),e.numBoneInfluencers>4&&(S.push(te.MatricesIndicesExtraKind),S.push(te.MatricesWeightsExtraKind));const se=e.skeleton;v.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),M.addCPUSkinningFallback(0,e),se.isUsingTextureForMatrices?(v.push("#define BONETEXTURE"),this._options.uniforms.indexOf("boneTextureWidth")===-1&&this._options.uniforms.push("boneTextureWidth"),this._options.samplers.indexOf("boneSampler")===-1&&this._options.samplers.push("boneSampler")):(v.push("#define BonesPerMesh "+(se.bones.length+1)),this._options.uniforms.indexOf("mBones")===-1&&this._options.uniforms.push("mBones"))}else v.push("#define NUM_BONE_INFLUENCERS 0");let G=0;const H=e?e.morphTargetManager:null;if(H){const se=H.supportsUVs&&v.indexOf("#define UV1")!==-1,$=H.supportsTangents&&v.indexOf("#define TANGENT")!==-1,oe=H.supportsNormals&&v.indexOf("#define NORMAL")!==-1;G=H.numInfluencers,se&&v.push("#define MORPHTARGETS_UV"),$&&v.push("#define MORPHTARGETS_TANGENT"),oe&&v.push("#define MORPHTARGETS_NORMAL"),G>0&&v.push("#define MORPHTARGETS"),H.isUsingTextureForTargets&&(v.push("#define MORPHTARGETS_TEXTURE"),this._options.uniforms.indexOf("morphTargetTextureIndices")===-1&&this._options.uniforms.push("morphTargetTextureIndices"),this._options.samplers.indexOf("morphTargets")===-1&&this._options.samplers.push("morphTargets")),v.push("#define NUM_MORPH_INFLUENCERS "+G);for(let ue=0;ue<G;ue++)S.push(te.PositionKind+ue),oe&&S.push(te.NormalKind+ue),$&&S.push(te.TangentKind+ue),se&&S.push(te.UVKind+"_"+ue);G>0&&(L=L.slice(),L.push("morphTargetInfluences"),L.push("morphTargetTextureInfo"),L.push("morphTargetTextureIndices"))}else v.push("#define NUM_MORPH_INFLUENCERS 0");if(e){const se=e.bakedVertexAnimationManager;se&&se.isEnabled&&(v.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),this._options.uniforms.indexOf("bakedVertexAnimationSettings")===-1&&this._options.uniforms.push("bakedVertexAnimationSettings"),this._options.uniforms.indexOf("bakedVertexAnimationTextureSizeInverted")===-1&&this._options.uniforms.push("bakedVertexAnimationTextureSizeInverted"),this._options.uniforms.indexOf("bakedVertexAnimationTime")===-1&&this._options.uniforms.push("bakedVertexAnimationTime"),this._options.samplers.indexOf("bakedVertexAnimationTexture")===-1&&this._options.samplers.push("bakedVertexAnimationTexture")),nt.PrepareAttributesForBakedVertexAnimation(S,e,v)}for(const se in this._textures)if(!this._textures[se].isReady())return!1;e&&this._shouldTurnAlphaTestOn(e)&&v.push("#define ALPHATEST"),this._options.useClipPlane!==!1&&(O2(L),Z9(this,y,v)),this.customShaderNameResolve&&(L=L.slice(),N=N.slice(),k=k.slice(),F=this.customShaderNameResolve(F,L,N,k,v,S));const z=g?s._getDrawWrapper():this._drawWrapper,W=(n=z?.effect)!==null&&n!==void 0?n:null,Y=(a=z?.defines)!==null&&a!==void 0?a:null,Z=v.join(`
`);let Q=W;return Y!==Z&&(Q=b.createEffect(F,{attributes:S,uniformsNames:L,uniformBuffersNames:N,samplers:k,defines:Z,fallbacks:M,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:G},shaderLanguage:this._options.shaderLanguage},b),g?s.setEffect(Q,Z,this._materialContext):z&&z.setEffect(Q,Z),this._onEffectCreatedObservable&&(q_.effect=Q,q_.subMesh=(p=s??e?.subMeshes[0])!==null&&p!==void 0?p:null,this._onEffectCreatedObservable.notifyObservers(q_))),Q._wasPreviouslyUsingInstances=!!i,!((_=!Q?.isReady())!==null&&_!==void 0)||_?!1:(W!==Q&&y.resetCachedMaterial(),Q._wasPreviouslyReady=!0,!0)}bindOnlyWorldMatrix(e,i){const s=this.getScene(),n=i??this.getEffect();!n||(this._options.uniforms.indexOf("world")!==-1&&n.setMatrix("world",e),this._options.uniforms.indexOf("worldView")!==-1&&(e.multiplyToRef(s.getViewMatrix(),this._cachedWorldViewMatrix),n.setMatrix("worldView",this._cachedWorldViewMatrix)),this._options.uniforms.indexOf("worldViewProjection")!==-1&&(e.multiplyToRef(s.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),n.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)))}bindForSubMesh(e,i,s){var n;this.bind(e,i,(n=s._drawWrapperOverride)===null||n===void 0?void 0:n.effect,s)}bind(e,i,s,n){var a;const p=n&&this._storeEffectOnSubMeshes,_=s??(p?n.effect:this.getEffect());if(!_)return;this._activeEffect=_,this.bindOnlyWorldMatrix(e,s);const g=this._options.uniformBuffers;let y=!1;if(_&&g&&g.length>0&&this.getScene().getEngine().supportsUniformBuffers)for(let v=0;v<g.length;++v)switch(g[v]){case"Mesh":i&&(i.getMeshUniformBuffer().bindToEffect(_,"Mesh"),i.transferToEffect(e));break;case"Scene":nt.BindSceneUniformBuffer(_,this.getScene().getSceneUniformBuffer()),this.getScene().finalizeSceneUbo(),y=!0;break}const b=i&&p?this._mustRebind(this.getScene(),_,i.visibility):this.getScene().getCachedMaterial()!==this;if(_&&b){!y&&this._options.uniforms.indexOf("view")!==-1&&_.setMatrix("view",this.getScene().getViewMatrix()),!y&&this._options.uniforms.indexOf("projection")!==-1&&_.setMatrix("projection",this.getScene().getProjectionMatrix()),!y&&this._options.uniforms.indexOf("viewProjection")!==-1&&(_.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this._multiview&&_.setMatrix("viewProjectionR",this.getScene()._transformMatrixR)),this.getScene().activeCamera&&this._options.uniforms.indexOf("cameraPosition")!==-1&&_.setVector3("cameraPosition",this.getScene().activeCamera.globalPosition),nt.BindBonesParameters(i,_),w2(_,this,this.getScene());let v;for(v in this._textures)_.setTexture(v,this._textures[v]);for(v in this._textureArrays)_.setTextureArray(v,this._textureArrays[v]);for(v in this._externalTextures)_.setExternalTexture(v,this._externalTextures[v]);for(v in this._ints)_.setInt(v,this._ints[v]);for(v in this._uints)_.setUInt(v,this._uints[v]);for(v in this._floats)_.setFloat(v,this._floats[v]);for(v in this._floatsArrays)_.setArray(v,this._floatsArrays[v]);for(v in this._colors3)_.setColor3(v,this._colors3[v]);for(v in this._colors3Arrays)_.setArray3(v,this._colors3Arrays[v]);for(v in this._colors4){const S=this._colors4[v];_.setFloat4(v,S.r,S.g,S.b,S.a)}for(v in this._colors4Arrays)_.setArray4(v,this._colors4Arrays[v]);for(v in this._vectors2)_.setVector2(v,this._vectors2[v]);for(v in this._vectors3)_.setVector3(v,this._vectors3[v]);for(v in this._vectors4)_.setVector4(v,this._vectors4[v]);for(v in this._quaternions)_.setQuaternion(v,this._quaternions[v]);for(v in this._matrices)_.setMatrix(v,this._matrices[v]);for(v in this._matrixArrays)_.setMatrices(v,this._matrixArrays[v]);for(v in this._matrices3x3)_.setMatrix3x3(v,this._matrices3x3[v]);for(v in this._matrices2x2)_.setMatrix2x2(v,this._matrices2x2[v]);for(v in this._vectors2Arrays)_.setArray2(v,this._vectors2Arrays[v]);for(v in this._vectors3Arrays)_.setArray3(v,this._vectors3Arrays[v]);for(v in this._vectors4Arrays)_.setArray4(v,this._vectors4Arrays[v]);for(v in this._quaternionsArrays)_.setArray4(v,this._quaternionsArrays[v]);for(v in this._uniformBuffers){const S=this._uniformBuffers[v].getBuffer();S&&_.bindUniformBuffer(S,v)}for(v in this._textureSamplers)_.setTextureSampler(v,this._textureSamplers[v]);for(v in this._storageBuffers)_.setStorageBuffer(v,this._storageBuffers[v])}if(_&&i&&(b||!this.isFrozen)){const v=i.morphTargetManager;v&&v.numInfluencers>0&&nt.BindMorphTargetParameters(i,_);const S=i.bakedVertexAnimationManager;S&&S.isEnabled&&((a=i.bakedVertexAnimationManager)===null||a===void 0||a.bind(_,!!_._wasPreviouslyUsingInstances))}this._afterBind(i,_)}getActiveTextures(){const e=super.getActiveTextures();for(const i in this._textures)e.push(this._textures[i]);for(const i in this._textureArrays){const s=this._textureArrays[i];for(let n=0;n<s.length;n++)e.push(s[n])}return e}hasTexture(e){if(super.hasTexture(e))return!0;for(const i in this._textures)if(this._textures[i]===e)return!0;for(const i in this._textureArrays){const s=this._textureArrays[i];for(let n=0;n<s.length;n++)if(s[n]===e)return!0}return!1}clone(e){const i=Kt.Clone(()=>new Zo(e,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes),this);i.name=e,i.id=e,typeof i._shaderPath=="object"&&(i._shaderPath={...i._shaderPath}),this._options={...this._options},Object.keys(this._options).forEach(s=>{const n=this._options[s];Array.isArray(n)&&(this._options[s]=n.slice(0))}),this.stencil.copyTo(i.stencil);for(const s in this._textures)i.setTexture(s,this._textures[s]);for(const s in this._textureArrays)i.setTextureArray(s,this._textureArrays[s]);for(const s in this._externalTextures)i.setExternalTexture(s,this._externalTextures[s]);for(const s in this._ints)i.setInt(s,this._ints[s]);for(const s in this._uints)i.setUInt(s,this._uints[s]);for(const s in this._floats)i.setFloat(s,this._floats[s]);for(const s in this._floatsArrays)i.setFloats(s,this._floatsArrays[s]);for(const s in this._colors3)i.setColor3(s,this._colors3[s]);for(const s in this._colors3Arrays)i._colors3Arrays[s]=this._colors3Arrays[s];for(const s in this._colors4)i.setColor4(s,this._colors4[s]);for(const s in this._colors4Arrays)i._colors4Arrays[s]=this._colors4Arrays[s];for(const s in this._vectors2)i.setVector2(s,this._vectors2[s]);for(const s in this._vectors3)i.setVector3(s,this._vectors3[s]);for(const s in this._vectors4)i.setVector4(s,this._vectors4[s]);for(const s in this._quaternions)i.setQuaternion(s,this._quaternions[s]);for(const s in this._quaternionsArrays)i._quaternionsArrays[s]=this._quaternionsArrays[s];for(const s in this._matrices)i.setMatrix(s,this._matrices[s]);for(const s in this._matrixArrays)i._matrixArrays[s]=this._matrixArrays[s].slice();for(const s in this._matrices3x3)i.setMatrix3x3(s,this._matrices3x3[s]);for(const s in this._matrices2x2)i.setMatrix2x2(s,this._matrices2x2[s]);for(const s in this._vectors2Arrays)i.setArray2(s,this._vectors2Arrays[s]);for(const s in this._vectors3Arrays)i.setArray3(s,this._vectors3Arrays[s]);for(const s in this._vectors4Arrays)i.setArray4(s,this._vectors4Arrays[s]);for(const s in this._uniformBuffers)i.setUniformBuffer(s,this._uniformBuffers[s]);for(const s in this._textureSamplers)i.setTextureSampler(s,this._textureSamplers[s]);for(const s in this._storageBuffers)i.setStorageBuffer(s,this._storageBuffers[s]);return i}dispose(e,i,s){if(i){let n;for(n in this._textures)this._textures[n].dispose();for(n in this._textureArrays){const a=this._textureArrays[n];for(let p=0;p<a.length;p++)a[p].dispose()}}this._textures={},super.dispose(e,i,s)}serialize(){const e=Kt.Serialize(this);e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes;let i;e.stencil=this.stencil.serialize(),e.textures={};for(i in this._textures)e.textures[i]=this._textures[i].serialize();e.textureArrays={};for(i in this._textureArrays){e.textureArrays[i]=[];const s=this._textureArrays[i];for(let n=0;n<s.length;n++)e.textureArrays[i].push(s[n].serialize())}e.ints={};for(i in this._ints)e.ints[i]=this._ints[i];e.uints={};for(i in this._uints)e.uints[i]=this._uints[i];e.floats={};for(i in this._floats)e.floats[i]=this._floats[i];e.FloatArrays={};for(i in this._floatsArrays)e.FloatArrays[i]=this._floatsArrays[i];e.colors3={};for(i in this._colors3)e.colors3[i]=this._colors3[i].asArray();e.colors3Arrays={};for(i in this._colors3Arrays)e.colors3Arrays[i]=this._colors3Arrays[i];e.colors4={};for(i in this._colors4)e.colors4[i]=this._colors4[i].asArray();e.colors4Arrays={};for(i in this._colors4Arrays)e.colors4Arrays[i]=this._colors4Arrays[i];e.vectors2={};for(i in this._vectors2)e.vectors2[i]=this._vectors2[i].asArray();e.vectors3={};for(i in this._vectors3)e.vectors3[i]=this._vectors3[i].asArray();e.vectors4={};for(i in this._vectors4)e.vectors4[i]=this._vectors4[i].asArray();e.quaternions={};for(i in this._quaternions)e.quaternions[i]=this._quaternions[i].asArray();e.matrices={};for(i in this._matrices)e.matrices[i]=this._matrices[i].asArray();e.matrixArray={};for(i in this._matrixArrays)e.matrixArray[i]=this._matrixArrays[i];e.matrices3x3={};for(i in this._matrices3x3)e.matrices3x3[i]=this._matrices3x3[i];e.matrices2x2={};for(i in this._matrices2x2)e.matrices2x2[i]=this._matrices2x2[i];e.vectors2Arrays={};for(i in this._vectors2Arrays)e.vectors2Arrays[i]=this._vectors2Arrays[i];e.vectors3Arrays={};for(i in this._vectors3Arrays)e.vectors3Arrays[i]=this._vectors3Arrays[i];e.vectors4Arrays={};for(i in this._vectors4Arrays)e.vectors4Arrays[i]=this._vectors4Arrays[i];e.quaternionsArrays={};for(i in this._quaternionsArrays)e.quaternionsArrays[i]=this._quaternionsArrays[i];return e}static Parse(e,i,s){const n=Kt.Parse(()=>new Zo(e.name,i,e.shaderPath,e.options,e.storeEffectOnSubMeshes),e,i,s);let a;e.stencil&&n.stencil.parse(e.stencil,i,s);for(a in e.textures)n.setTexture(a,Oe.Parse(e.textures[a],i,s));for(a in e.textureArrays){const p=e.textureArrays[a],_=new Array;for(let g=0;g<p.length;g++)_.push(Oe.Parse(p[g],i,s));n.setTextureArray(a,_)}for(a in e.ints)n.setInt(a,e.ints[a]);for(a in e.uints)n.setUInt(a,e.uints[a]);for(a in e.floats)n.setFloat(a,e.floats[a]);for(a in e.floatsArrays)n.setFloats(a,e.floatsArrays[a]);for(a in e.colors3)n.setColor3(a,qe.FromArray(e.colors3[a]));for(a in e.colors3Arrays){const p=e.colors3Arrays[a].reduce((_,g,y)=>(y%3===0?_.push([g]):_[_.length-1].push(g),_),[]).map(_=>qe.FromArray(_));n.setColor3Array(a,p)}for(a in e.colors4)n.setColor4(a,pi.FromArray(e.colors4[a]));for(a in e.colors4Arrays){const p=e.colors4Arrays[a].reduce((_,g,y)=>(y%4===0?_.push([g]):_[_.length-1].push(g),_),[]).map(_=>pi.FromArray(_));n.setColor4Array(a,p)}for(a in e.vectors2)n.setVector2(a,ii.FromArray(e.vectors2[a]));for(a in e.vectors3)n.setVector3(a,j.FromArray(e.vectors3[a]));for(a in e.vectors4)n.setVector4(a,xr.FromArray(e.vectors4[a]));for(a in e.quaternions)n.setQuaternion(a,Ve.FromArray(e.quaternions[a]));for(a in e.matrices)n.setMatrix(a,fe.FromArray(e.matrices[a]));for(a in e.matrixArray)n._matrixArrays[a]=new Float32Array(e.matrixArray[a]);for(a in e.matrices3x3)n.setMatrix3x3(a,e.matrices3x3[a]);for(a in e.matrices2x2)n.setMatrix2x2(a,e.matrices2x2[a]);for(a in e.vectors2Arrays)n.setArray2(a,e.vectors2Arrays[a]);for(a in e.vectors3Arrays)n.setArray3(a,e.vectors3Arrays[a]);for(a in e.vectors4Arrays)n.setArray4(a,e.vectors4Arrays[a]);for(a in e.quaternionsArrays)n.setArray4(a,e.quaternionsArrays[a]);return n}static ParseFromFileAsync(e,i,s,n=""){return new Promise((a,p)=>{const _=new en;_.addEventListener("readystatechange",()=>{if(_.readyState==4)if(_.status==200){const g=JSON.parse(_.responseText),y=this.Parse(g,s||Zt.LastCreatedScene,n);e&&(y.name=e),a(y)}else p("Unable to load the ShaderMaterial")}),_.open("GET",i),_.send()})}static ParseFromSnippetAsync(e,i,s=""){return new Promise((n,a)=>{const p=new en;p.addEventListener("readystatechange",()=>{if(p.readyState==4)if(p.status==200){const _=JSON.parse(JSON.parse(p.responseText).jsonPayload),g=JSON.parse(_.shaderMaterial),y=this.Parse(g,i||Zt.LastCreatedScene,s);y.snippetId=e,n(y)}else a("Unable to load the snippet "+e)}),p.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),p.send()})}}Zo.SnippetUrl="https://snippet.babylonjs.com",Zo.CreateFromSnippetAsync=Zo.ParseFromSnippetAsync,ur("BABYLON.ShaderMaterial",Zo);const YS="colorPixelShader",KS=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
#define VERTEXCOLOR
varying vec4 vColor;
#else
uniform vec4 color;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
gl_FragColor=vColor;
#else
gl_FragColor=color;
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}`;Ye.ShadersStore[YS]=KS;const $q={name:YS,shader:KS},jS="colorVertexShader",qS=`attribute vec3 position;
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(position,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
#include<clipPlaneVertex>
#include<vertexColorMixing>
#define CUSTOM_VERTEX_MAIN_END
}`;Ye.ShadersStore[jS]=qS;const Jq={name:jS,shader:qS};Qe._LinesMeshParser=(l,e)=>kc.Parse(l,e);class kc extends Qe{_isShaderMaterial(e){return e.getClassName()==="ShaderMaterial"}constructor(e,i=null,s=null,n=null,a,p,_,g){super(e,i,s,n,a),this.useVertexColor=p,this.useVertexAlpha=_,this.color=new qe(1,1,1),this.alpha=1,n&&(this.color=n.color.clone(),this.alpha=n.alpha,this.useVertexColor=n.useVertexColor,this.useVertexAlpha=n.useVertexAlpha),this.intersectionThreshold=.1;const y=[],b={attributes:[te.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:!0,defines:y,useClipPlane:null};_===!1?b.needAlphaBlending=!1:b.defines.push("#define VERTEXALPHA"),p?(b.defines.push("#define VERTEXCOLOR"),b.attributes.push(te.ColorKind)):(b.uniforms.push("color"),this._color4=new pi),g?this.material=g:(this.material=new Zo("colorShader",this.getScene(),"color",b,!1),this.material.doNotSerialize=!0)}isReady(){return this._lineMaterial.isReady(this,!!this._userInstancedBuffersStorage)?super.isReady():!1}getClassName(){return"LinesMesh"}get material(){return this._lineMaterial}set material(e){this._lineMaterial=e,this._lineMaterial.fillMode=Be.LineListDrawMode}get checkCollisions(){return!1}set checkCollisions(e){}_bind(e,i){if(!this._geometry)return this;const s=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(this._userInstancedBuffersStorage?this._geometry._bind(i,s,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects):this._geometry._bind(i,s),!this.useVertexColor&&this._isShaderMaterial(this._lineMaterial)){const{r:n,g:a,b:p}=this.color;this._color4.set(n,a,p,this.alpha),this._lineMaterial.setColor4("color",this._color4)}return this}_draw(e,i,s){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const n=this.getScene().getEngine();return this._unIndexed?n.drawArraysType(Be.LineListDrawMode,e.verticesStart,e.verticesCount,s):n.drawElementsType(Be.LineListDrawMode,e.indexStart,e.indexCount,s),this}dispose(e,i=!1,s){s||this._lineMaterial.dispose(!1,!1,!0),super.dispose(e)}clone(e,i=null,s){return new kc(e,this.getScene(),i,this,s)}createInstance(e){const i=new Jz(e,this);if(this.instancedBuffers){i.instancedBuffers={};for(const s in this.instancedBuffers)i.instancedBuffers[s]=this.instancedBuffers[s]}return i}serialize(e){super.serialize(e),e.color=this.color.asArray(),e.alpha=this.alpha}static Parse(e,i){const s=new kc(e.name,i);return s.color=qe.FromArray(e.color),s.alpha=e.alpha,s}}class Jz extends j_{constructor(e,i){super(e,i),this.intersectionThreshold=i.intersectionThreshold}getClassName(){return"InstancedLinesMesh"}}function ZS(l){const e=[],i=[],s=l.lines,n=l.colors,a=[];let p=0;for(let g=0;g<s.length;g++){const y=s[g];for(let b=0;b<y.length;b++){if(i.push(y[b].x,y[b].y,y[b].z),n){const v=n[g];a.push(v[b].r,v[b].g,v[b].b,v[b].a)}b>0&&(e.push(p-1),e.push(p)),p++}}const _=new Mt;return _.indices=e,_.positions=i,n&&(_.colors=a),_}function QS(l){const e=l.dashSize||3,i=l.gapSize||1,s=l.dashNb||200,n=l.points,a=new Array,p=new Array,_=j.Zero();let g=0,y=0,b=0,v=0,S=0,M=0,F=0;for(F=0;F<n.length-1;F++)n[F+1].subtractToRef(n[F],_),g+=_.length();for(b=g/s,v=e*b/(e+i),F=0;F<n.length-1;F++){n[F+1].subtractToRef(n[F],_),y=Math.floor(_.length()/b),_.normalize();for(let N=0;N<y;N++)S=b*N,a.push(n[F].x+S*_.x,n[F].y+S*_.y,n[F].z+S*_.z),a.push(n[F].x+(S+v)*_.x,n[F].y+(S+v)*_.y,n[F].z+(S+v)*_.z),p.push(M,M+1),M+=2}const L=new Mt;return L.positions=a,L.indices=p,L}function $S(l,e,i){const s=e.instance,n=e.lines,a=e.colors;if(s){const y=s.getVerticesData(te.PositionKind);let b,v;a&&(b=s.getVerticesData(te.ColorKind));let S=0,M=0;for(let F=0;F<n.length;F++){const L=n[F];for(let N=0;N<L.length;N++)y[S]=L[N].x,y[S+1]=L[N].y,y[S+2]=L[N].z,a&&b&&(v=a[F],b[M]=v[N].r,b[M+1]=v[N].g,b[M+2]=v[N].b,b[M+3]=v[N].a,M+=4),S+=3}return s.updateVerticesData(te.PositionKind,y,!1,!1),a&&b&&s.updateVerticesData(te.ColorKind,b,!1,!1),s}const p=!!a,_=new kc(l,i,null,void 0,void 0,p,e.useVertexAlpha,e.material);return ZS(e).applyToMesh(_,e.updatable),_}function Z_(l,e,i=null){const s=e.colors?[e.colors]:null;return $S(l,{lines:[e.points],updatable:e.updatable,instance:e.instance,colors:s,useVertexAlpha:e.useVertexAlpha,material:e.material},i)}function JS(l,e,i=null){const s=e.points,n=e.instance,a=e.gapSize||1,p=e.dashSize||3;if(n){const y=b=>{const v=j.Zero(),S=b.length/6;let M=0,F=0,L=0,N=0,k=0,G=0,H=0,z=0;for(H=0;H<s.length-1;H++)s[H+1].subtractToRef(s[H],v),M+=v.length();L=M/S;const W=n._creationDataStorage.dashSize,Y=n._creationDataStorage.gapSize;for(N=W*L/(W+Y),H=0;H<s.length-1;H++)for(s[H+1].subtractToRef(s[H],v),F=Math.floor(v.length()/L),v.normalize(),z=0;z<F&&G<b.length;)k=L*z,b[G]=s[H].x+k*v.x,b[G+1]=s[H].y+k*v.y,b[G+2]=s[H].z+k*v.z,b[G+3]=s[H].x+(k+N)*v.x,b[G+4]=s[H].y+(k+N)*v.y,b[G+5]=s[H].z+(k+N)*v.z,G+=6,z++;for(;G<b.length;)b[G]=s[H].x,b[G+1]=s[H].y,b[G+2]=s[H].z,G+=3};return(e.dashNb||e.dashSize||e.gapSize||e.useVertexAlpha||e.material)&&Ie.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),n.updateMeshPositions(y,!1),n}const _=new kc(l,i,null,void 0,void 0,void 0,e.useVertexAlpha,e.material);return QS(e).applyToMesh(_,e.updatable),_._creationDataStorage=new ZW,_._creationDataStorage.dashSize=p,_._creationDataStorage.gapSize=a,_}const eZ={CreateDashedLines:JS,CreateLineSystem:$S,CreateLines:Z_};Mt.CreateLineSystem=ZS,Mt.CreateDashedLines=QS,Qe.CreateLines=(l,e,i=null,s=!1,n=null)=>Z_(l,{points:e,updatable:s,instance:n},i),Qe.CreateDashedLines=(l,e,i,s,n,a=null,p,_)=>JS(l,{points:e,dashSize:i,gapSize:s,dashNb:n,updatable:p,instance:_},a);var Al;(function(l){l[l.INIT=0]="INIT",l[l.STARTED=1]="STARTED",l[l.ENDED=2]="ENDED"})(Al||(Al={}));function eM(l){var e;let i=0;const s=Date.now();l.observableParameters=(e=l.observableParameters)!==null&&e!==void 0?e:{};const n=l.contextObservable.add(a=>{const p=Date.now();i=p-s;const _={startTime:s,currentTime:p,deltaTime:i,completeRate:i/l.timeout,payload:a};l.onTick&&l.onTick(_),l.breakCondition&&l.breakCondition()&&(l.contextObservable.remove(n),l.onAborted&&l.onAborted(_)),i>=l.timeout&&(l.contextObservable.remove(n),l.onEnded&&l.onEnded(_))},l.observableParameters.mask,l.observableParameters.insertFirst,l.observableParameters.scope);return n}class tZ{constructor(e){var i,s;this.onEachCountObservable=new Observable,this.onTimerAbortedObservable=new Observable,this.onTimerEndedObservable=new Observable,this.onStateChangedObservable=new Observable,this._observer=null,this._breakOnNextTick=!1,this._tick=n=>{const a=Date.now();this._timer=a-this._startTime;const p={startTime:this._startTime,currentTime:a,deltaTime:this._timer,completeRate:this._timer/this._timeToEnd,payload:n},_=this._breakOnNextTick||this._breakCondition(p);_||this._timer>=this._timeToEnd?this._stop(p,_):this.onEachCountObservable.notifyObservers(p)},this._setState(Al.INIT),this._contextObservable=e.contextObservable,this._observableParameters=(i=e.observableParameters)!==null&&i!==void 0?i:{},this._breakCondition=(s=e.breakCondition)!==null&&s!==void 0?s:()=>!1,this._timeToEnd=e.timeout,e.onEnded&&this.onTimerEndedObservable.add(e.onEnded),e.onTick&&this.onEachCountObservable.add(e.onTick),e.onAborted&&this.onTimerAbortedObservable.add(e.onAborted)}set breakCondition(e){this._breakCondition=e}clearObservables(){this.onEachCountObservable.clear(),this.onTimerAbortedObservable.clear(),this.onTimerEndedObservable.clear(),this.onStateChangedObservable.clear()}start(e=this._timeToEnd){if(this._state===Al.STARTED)throw new Error("Timer already started. Please stop it before starting again");this._timeToEnd=e,this._startTime=Date.now(),this._timer=0,this._observer=this._contextObservable.add(this._tick,this._observableParameters.mask,this._observableParameters.insertFirst,this._observableParameters.scope),this._setState(Al.STARTED)}stop(){this._state===Al.STARTED&&(this._breakOnNextTick=!0)}dispose(){this._observer&&this._contextObservable.remove(this._observer),this.clearObservables()}_setState(e){this._state=e,this.onStateChangedObservable.notifyObservers(this._state)}_stop(e,i=!1){this._contextObservable.remove(this._observer),this._setState(Al.ENDED),i?this.onTimerAbortedObservable.notifyObservers(e):this.onTimerEndedObservable.notifyObservers(e)}}class Uc extends N_{get rotationEnabled(){return this._rotationEnabled}set rotationEnabled(e){if(this._rotationEnabled=e,this._options.teleportationTargetMesh){const i=this._options.teleportationTargetMesh.getChildMeshes(!1,s=>s.name==="rotationCone");i[0]&&i[0].setEnabled(e)}}get teleportationTargetMesh(){return this._options.teleportationTargetMesh||null}constructor(e,i){super(e),this._options=i,this._controllers={},this._snappedToPoint=!1,this._cachedColor4White=new pi(1,1,1,1),this._tmpRay=new wi(new j,new j),this._tmpVector=new j,this._tmpQuaternion=new Ve,this.skipNextTeleportation=!1,this.backwardsMovementEnabled=!0,this.backwardsTeleportationDistance=.7,this.parabolicCheckRadius=5,this.parabolicRayEnabled=!0,this.straightRayEnabled=!0,this.rotationAngle=Math.PI/8,this.onTargetMeshPositionUpdatedObservable=new Re,this.teleportationEnabled=!0,this._rotationEnabled=!0,this._attachController=s=>{if(this._controllers[s.uniqueId]||this._options.forceHandedness&&s.inputSource.handedness!==this._options.forceHandedness)return;this._controllers[s.uniqueId]={xrController:s,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0,blocked:!1}};const n=this._controllers[s.uniqueId];if(n.xrController.inputSource.targetRayMode==="tracked-pointer"&&n.xrController.inputSource.gamepad){const a=()=>{if(s.motionController){const p=s.motionController.getComponentOfType(Ko.THUMBSTICK_TYPE)||s.motionController.getComponentOfType(Ko.TOUCHPAD_TYPE);if(!p||this._options.useMainComponentOnly){const _=s.motionController.getMainComponent();if(!_)return;n.teleportationComponent=_,n.onButtonChangedObserver=_.onButtonStateChangedObservable.add(()=>{if(!!this.teleportationEnabled&&_.changes.pressed)if(_.changes.pressed.current){n.teleportationState.forward=!0,this._currentTeleportationControllerId=n.xrController.uniqueId,n.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,n.teleportationState.currentRotation=0;const g=this._options.timeToTeleport||3e3;eM({timeout:g,contextObservable:this._xrSessionManager.onXRFrameObservable,breakCondition:()=>!_.pressed,onEnded:()=>{this._currentTeleportationControllerId===n.xrController.uniqueId&&n.teleportationState.forward&&this._teleportForward(s.uniqueId)}})}else n.teleportationState.forward=!1,this._currentTeleportationControllerId=""})}else n.teleportationComponent=p,n.onAxisChangedObserver=p.onAxisValueChangedObservable.add(_=>{if(_.y<=.7&&n.teleportationState.backwards&&(n.teleportationState.backwards=!1),_.y>.7&&!n.teleportationState.forward&&this.backwardsMovementEnabled&&!this.snapPointsOnly&&!n.teleportationState.backwards){n.teleportationState.backwards=!0,this._tmpQuaternion.copyFrom(this._options.xrInput.xrCamera.rotationQuaternion),this._tmpQuaternion.toEulerAnglesToRef(this._tmpVector),this._tmpVector.x=0,this._tmpVector.z=0,Ve.FromEulerVectorToRef(this._tmpVector,this._tmpQuaternion),this._tmpVector.set(0,0,this.backwardsTeleportationDistance*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),this._tmpVector.rotateByQuaternionToRef(this._tmpQuaternion,this._tmpVector),this._tmpVector.addInPlace(this._options.xrInput.xrCamera.position),this._tmpRay.origin.copyFrom(this._tmpVector),this._tmpRay.length=this._options.xrInput.xrCamera.realWorldHeight+.1,this._tmpRay.direction.set(0,-1,0);const g=this._xrSessionManager.scene.pickWithRay(this._tmpRay,y=>this._floorMeshes.indexOf(y)!==-1);g&&g.pickedPoint&&(this._options.xrInput.xrCamera.position.x=g.pickedPoint.x,this._options.xrInput.xrCamera.position.z=g.pickedPoint.z)}if(_.y<-.7&&!this._currentTeleportationControllerId&&!n.teleportationState.rotating&&this.teleportationEnabled&&(n.teleportationState.forward=!0,this._currentTeleportationControllerId=n.xrController.uniqueId,n.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),_.x){if(n.teleportationState.forward)this._currentTeleportationControllerId===n.xrController.uniqueId&&(this.rotationEnabled?setTimeout(()=>{n.teleportationState.currentRotation=Math.atan2(_.x,_.y*(this._xrSessionManager.scene.useRightHandedSystem?1:-1))}):n.teleportationState.currentRotation=0);else if(!n.teleportationState.rotating&&Math.abs(_.x)>.7){n.teleportationState.rotating=!0;const g=this.rotationAngle*(_.x>0?1:-1)*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);Ve.FromEulerAngles(0,g,0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion)}}else n.teleportationState.rotating=!1;_.x===0&&_.y===0&&(n.teleportationState.blocked&&(n.teleportationState.blocked=!1,this._setTargetMeshVisibility(!1)),n.teleportationState.forward&&this._teleportForward(s.uniqueId))})}};s.motionController?a():s.onMotionControllerInitObservable.addOnce(()=>{a()})}else this._xrSessionManager.scene.onPointerObservable.add(a=>{if(a.type===Lt.POINTERDOWN){n.teleportationState.forward=!0,this._currentTeleportationControllerId=n.xrController.uniqueId,n.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,n.teleportationState.currentRotation=0;const p=this._options.timeToTeleport||3e3;eM({timeout:p,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===n.xrController.uniqueId&&n.teleportationState.forward&&this._teleportForward(s.uniqueId)}})}else a.type===Lt.POINTERUP&&(n.teleportationState.forward=!1,this._currentTeleportationControllerId="")})},this._options.teleportationTargetMesh||this._createDefaultTargetMesh(),this._floorMeshes=this._options.floorMeshes||[],this._snapToPositions=this._options.snapPositions||[],this._blockedRayColor=this._options.blockedRayColor||new pi(1,0,0,.75),this._setTargetMeshVisibility(!1)}get snapPointsOnly(){return!!this._options.snapPointsOnly}set snapPointsOnly(e){this._options.snapPointsOnly=e}addFloorMesh(e){this._floorMeshes.push(e)}addBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[],this._options.pickBlockerMeshes.push(e)}addSnapPoint(e){this._snapToPositions.push(e)}attach(){return super.attach()?(this._currentTeleportationControllerId="",this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),!0):!1}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),this._setTargetMeshVisibility(!1),this._currentTeleportationControllerId="",this._controllers={},!0):!1}dispose(){super.dispose(),this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.dispose(!1,!0)}removeFloorMesh(e){const i=this._floorMeshes.indexOf(e);i!==-1&&this._floorMeshes.splice(i,1)}removeBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[];const i=this._options.pickBlockerMeshes.indexOf(e);i!==-1&&this._options.pickBlockerMeshes.splice(i,1)}removeFloorMeshByName(e){const i=this._xrSessionManager.scene.getMeshByName(e);i&&this.removeFloorMesh(i)}removeSnapPoint(e){let i=this._snapToPositions.indexOf(e);if(i===-1){for(let s=0;s<this._snapToPositions.length;++s)if(this._snapToPositions[s].equals(e)){i=s;break}}return i!==-1?(this._snapToPositions.splice(i,1),!0):!1}setSelectionFeature(e){this._selectionFeature=e}_onXRFrame(e){const i=this._xrSessionManager.currentFrame,s=this._xrSessionManager.scene;if(!this.attach||!i)return;const n=this._options.teleportationTargetMesh;if(this._currentTeleportationControllerId){if(!n)return;n.rotationQuaternion=n.rotationQuaternion||new Ve;const a=this._controllers[this._currentTeleportationControllerId];if(a&&a.teleportationState.forward){Ve.RotationYawPitchRollToRef(a.teleportationState.currentRotation+a.teleportationState.baseRotation,0,0,n.rotationQuaternion);let p=!1;if(a.xrController.getWorldPointerRayToRef(this._tmpRay),this.straightRayEnabled){const _=s.pickWithRay(this._tmpRay,g=>{if(this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(g)!==-1)return!0;const y=this._floorMeshes.indexOf(g);return y===-1?!1:this._floorMeshes[y].absolutePosition.y<this._options.xrInput.xrCamera.globalPosition.y});if(_&&_.pickedMesh&&this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(_.pickedMesh)!==-1){a.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1),this._showParabolicPath(_);return}else _&&_.pickedPoint&&(a.teleportationState.blocked=!1,p=!0,this._setTargetMeshPosition(_),this._setTargetMeshVisibility(!0),this._showParabolicPath(_))}if(this.parabolicRayEnabled&&!p){const _=a.xrController.pointer.rotationQuaternion.toEulerAngles().x,g=1+(Math.PI/2-Math.abs(_)),y=this.parabolicCheckRadius*g;this._tmpRay.origin.addToRef(this._tmpRay.direction.scale(y*2),this._tmpVector),this._tmpVector.y=this._tmpRay.origin.y,this._tmpRay.origin.addInPlace(this._tmpRay.direction.scale(y)),this._tmpVector.subtractToRef(this._tmpRay.origin,this._tmpRay.direction),this._tmpRay.direction.normalize();const b=s.pickWithRay(this._tmpRay,v=>this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(v)!==-1?!0:this._floorMeshes.indexOf(v)!==-1);if(b&&b.pickedMesh&&this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(b.pickedMesh)!==-1){a.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1),this._showParabolicPath(b);return}else b&&b.pickedPoint&&(a.teleportationState.blocked=!1,p=!0,this._setTargetMeshPosition(b),this._setTargetMeshVisibility(!0),this._showParabolicPath(b))}this._setTargetMeshVisibility(p)}else this._setTargetMeshVisibility(!1)}else this._disposeBezierCurve(),this._setTargetMeshVisibility(!1)}_createDefaultTargetMesh(){this._options.defaultTargetMeshOptions=this._options.defaultTargetMeshOptions||{};const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Xr.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,i=W2("teleportationTarget",{width:2,height:2,subdivisions:2},e);if(i.isPickable=!1,this._options.defaultTargetMeshOptions.teleportationCircleMaterial)i.material=this._options.defaultTargetMeshOptions.teleportationCircleMaterial;else{const p=new eu("teleportationPlaneDynamicTexture",512,e,!0);p.hasAlpha=!0;const _=p.getContext(),g=512/2,y=512/2,b=200;_.beginPath(),_.arc(g,y,b,0,2*Math.PI,!1),_.fillStyle=this._options.defaultTargetMeshOptions.teleportationFillColor||"#444444",_.fill(),_.lineWidth=10,_.strokeStyle=this._options.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",_.stroke(),_.closePath(),p.update();const v=new ot("teleportationPlaneMaterial",e);v.diffuseTexture=p,i.material=v}const s=Tl("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},e);if(s.isPickable=!1,s.parent=i,!this._options.defaultTargetMeshOptions.disableAnimation){const a=new Ce("animationInnerCircle","position.y",30,Ce.ANIMATIONTYPE_FLOAT,Ce.ANIMATIONLOOPMODE_CYCLE),p=[];p.push({frame:0,value:0}),p.push({frame:30,value:.4}),p.push({frame:60,value:0}),a.setKeys(p);const _=new hI;_.setEasingMode(sn.EASINGMODE_EASEINOUT),a.setEasingFunction(_),s.animations=[],s.animations.push(a),e.beginAnimation(s,0,60,!0)}const n=tu("rotationCone",{diameterTop:0,tessellation:4},e);if(n.isPickable=!1,n.scaling.set(.5,.12,.2),n.rotate(oa.X,Math.PI/2),n.position.z=.6,n.parent=s,this._options.defaultTargetMeshOptions.torusArrowMaterial)s.material=this._options.defaultTargetMeshOptions.torusArrowMaterial,n.material=this._options.defaultTargetMeshOptions.torusArrowMaterial;else{const a=new ot("torusConsMat",e);a.disableLighting=!!this._options.defaultTargetMeshOptions.disableLighting,a.disableLighting?a.emissiveColor=new qe(.3,.3,1):a.diffuseColor=new qe(.3,.3,1),a.alpha=.9,s.material=a,n.material=a,this._teleportationRingMaterial=a}this._options.renderingGroupId!==void 0&&(i.renderingGroupId=this._options.renderingGroupId,s.renderingGroupId=this._options.renderingGroupId,n.renderingGroupId=this._options.renderingGroupId),this._options.teleportationTargetMesh=i,this._setTargetMeshVisibility(!1)}_detachController(e){const i=this._controllers[e];!i||(i.teleportationComponent&&(i.onAxisChangedObserver&&i.teleportationComponent.onAxisValueChangedObservable.remove(i.onAxisChangedObserver),i.onButtonChangedObserver&&i.teleportationComponent.onButtonStateChangedObservable.remove(i.onButtonChangedObserver)),delete this._controllers[e])}_findClosestSnapPointWithRadius(e,i=this._options.snapToPositionRadius||.8){let s=null,n=Number.MAX_VALUE;if(this._snapToPositions.length){const a=i*i;this._snapToPositions.forEach(p=>{const _=j.DistanceSquared(p,e);_<=a&&_<n&&(n=_,s=p)})}return s}_setTargetMeshPosition(e){const i=e.pickedPoint;if(!this._options.teleportationTargetMesh||!i)return;const s=this._findClosestSnapPointWithRadius(i);this._snappedToPoint=!!s,this.snapPointsOnly&&!this._snappedToPoint&&this._teleportationRingMaterial?this._teleportationRingMaterial.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this._snappedToPoint&&this._teleportationRingMaterial&&this._teleportationRingMaterial.diffuseColor.set(.3,.3,1),this._options.teleportationTargetMesh.position.copyFrom(s||i),this._options.teleportationTargetMesh.position.y+=.01,this.onTargetMeshPositionUpdatedObservable.notifyObservers(e)}_setTargetMeshVisibility(e,i){!this._options.teleportationTargetMesh||this._options.teleportationTargetMesh.isVisible===e&&!i||(this._options.teleportationTargetMesh.isVisible=e,this._options.teleportationTargetMesh.getChildren(void 0,!1).forEach(s=>{s.isVisible=e}),e?this._selectionFeature&&this._selectionFeature.detach():(this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null),this._selectionFeature&&this._selectionFeature.attach()))}_disposeBezierCurve(){this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null)}_showParabolicPath(e){if(!e.pickedPoint||!this._currentTeleportationControllerId)return;const i=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Xr.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,s=this._controllers[this._currentTeleportationControllerId],n=I0.CreateQuadraticBezier(s.xrController.pointer.absolutePosition,e.ray.origin,e.pickedPoint,25),a=s.teleportationState.blocked?this._blockedRayColor:void 0,p=new Array(26).fill(a||this._cachedColor4White);this._options.generateRayPathMesh?this._quadraticBezierCurve=this._options.generateRayPathMesh(n.getPoints(),e):this._quadraticBezierCurve=Z_("teleportation path line",{points:n.getPoints(),instance:this._quadraticBezierCurve,updatable:!0,colors:p},i),this._quadraticBezierCurve.isPickable=!1,this._options.renderingGroupId!==void 0&&(this._quadraticBezierCurve.renderingGroupId=this._options.renderingGroupId)}_teleportForward(e){const i=this._controllers[e];if(!(!i||!i.teleportationState.forward||!this.teleportationEnabled)&&(i.teleportationState.forward=!1,this._currentTeleportationControllerId="",!(this.snapPointsOnly&&!this._snappedToPoint))){if(this.skipNextTeleportation){this.skipNextTeleportation=!1;return}if(this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible){const s=this._options.xrInput.xrCamera.realWorldHeight;this._options.xrInput.xrCamera.onBeforeCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position),this._options.xrInput.xrCamera.position.copyFrom(this._options.teleportationTargetMesh.position),this._options.xrInput.xrCamera.position.y+=s,Ve.FromEulerAngles(0,i.teleportationState.currentRotation-(this._xrSessionManager.scene.useRightHandedSystem?Math.PI:0),0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this._options.xrInput.xrCamera.onAfterCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position)}}}}Uc.Name=Dr.TELEPORTATION,Uc.Version=1,To.AddWebXRFeature(Uc.Name,(l,e)=>()=>new Uc(l,e),Uc.Version,!0);class iZ{}class Q_{constructor(){}static CreateAsync(e,i={}){const s=new Q_;if(e.onDisposeObservable.addOnce(()=>{s.dispose()}),!i.disableDefaultUI){const n={renderTarget:s.renderTarget,...i.uiOptions||{}};i.optionalFeatures&&(typeof i.optionalFeatures=="boolean"?n.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:n.optionalFeatures=i.optionalFeatures),s.enterExitUI=new K_(e,n)}return F_.CreateAsync(e).then(n=>{if(s.baseExperience=n,i.ignoreNativeCameraTransformation&&(s.baseExperience.camera.compensateOnFirstFrame=!1),s.input=new jz(n.sessionManager,n.camera,{controllerOptions:{renderingGroupId:i.renderingGroupId},...i.inputOptions||{}}),!i.disablePointerSelection){const a={...i.pointerSelectionOptions,xrInput:s.input,renderingGroupId:i.renderingGroupId};s.pointerSelection=s.baseExperience.featuresManager.enableFeature(jo.Name,i.useStablePlugins?"stable":"latest",a),i.disableTeleportation||(s.teleportation=s.baseExperience.featuresManager.enableFeature(Uc.Name,i.useStablePlugins?"stable":"latest",{floorMeshes:i.floorMeshes,xrInput:s.input,renderingGroupId:i.renderingGroupId,...i.teleportationOptions}),s.teleportation.setSelectionFeature(s.pointerSelection))}if(i.disableNearInteraction||(s.nearInteraction=s.baseExperience.featuresManager.enableFeature(qo.Name,i.useStablePlugins?"stable":"latest",{xrInput:s.input,farInteractionFeature:s.pointerSelection,renderingGroupId:i.renderingGroupId,useUtilityLayer:!0,enableNearInteractionOnAllControllers:!0,...i.nearInteractionOptions})),s.renderTarget=s.baseExperience.sessionManager.getWebXRRenderTarget(i.outputCanvasOptions),!i.disableDefaultUI)return s.enterExitUI.setHelperAsync(s.baseExperience,s.renderTarget)}).then(()=>s).catch(n=>(Ie.Error("Error initializing XR"),Ie.Error(n),s))}dispose(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()}}var rZ=!0;Nt.prototype.createDefaultLight=function(l=!1){if(l&&this.lights)for(let e=0;e<this.lights.length;e++)this.lights[e].dispose();this.lights.length===0&&new P0("default light",j.Up(),this)},Nt.prototype.createDefaultCamera=function(l=!1,e=!1,i=!1){if(e&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){const s=this.getWorldExtends(g=>g.isVisible&&g.isEnabled()),n=s.max.subtract(s.min),a=s.min.add(n.scale(.5));let p,_=n.length()*1.5;if(isFinite(_)||(_=1,a.copyFromFloats(0,0,0)),l){const g=new Tr("default camera",-(Math.PI/2),Math.PI/2,_,a,this);g.lowerRadiusLimit=_*.01,g.wheelPrecision=100/_,p=g}else{const g=new Vn("default camera",new j(a.x,a.y,-_),this);g.setTarget(a),p=g}p.minZ=_*.01,p.maxZ=_*1e3,p.speed=_*.2,this.activeCamera=p,i&&p.attachControl()}},Nt.prototype.createDefaultCameraOrLight=function(l=!1,e=!1,i=!1){this.createDefaultLight(e),this.createDefaultCamera(l,e,i)},Nt.prototype.createDefaultSkybox=function(l,e=!1,i=1e3,s=0,n=!0){if(!l)return Ie.Warn("Can not create default skybox without environment texture."),null;n&&l&&(this.environmentTexture=l);const a=U2("hdrSkyBox",{size:i},this);if(e){const p=new Et("skyBox",this);p.backFaceCulling=!1,p.reflectionTexture=l.clone(),p.reflectionTexture&&(p.reflectionTexture.coordinatesMode=Oe.SKYBOX_MODE),p.microSurface=1-s,p.disableLighting=!0,p.twoSidedLighting=!0,a.material=p}else{const p=new ot("skyBox",this);p.backFaceCulling=!1,p.reflectionTexture=l.clone(),p.reflectionTexture&&(p.reflectionTexture.coordinatesMode=Oe.SKYBOX_MODE),p.disableLighting=!0,a.material=p}return a.isPickable=!1,a.infiniteDistance=!0,a.ignoreCameraMaxZ=!0,a},Nt.prototype.createDefaultEnvironment=function(l){return vl?new vl(l,this):null},Nt.prototype.createDefaultVRExperience=function(l={}){return new Bc(this,l)},Nt.prototype.createDefaultXRExperienceAsync=function(l={}){return Q_.CreateAsync(this,l).then(e=>e)};class eH extends Xh{}class tH{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){this.rootNodes.slice(0).forEach(e=>{e.dispose()}),this.rootNodes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0}}class iH extends Xh{constructor(e){super(),this._wasAddedToScene=!1,e=e||Zt.LastCreatedScene,e&&(this.scene=e,this.sounds=[],this.effectLayers=[],this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.reflectionProbes=[],e.onDisposeObservable.add(()=>{this._wasAddedToScene||this.dispose()}),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{for(const i of this.geometries)i._rebuild();for(const i of this.meshes)i._rebuild();for(const i of this.particleSystems)i.rebuild();for(const i of this.textures)i._rebuild()}))}_topologicalSort(e){const i=new Map;for(const _ of e)i.set(_.uniqueId,_);const s={dependsOn:new Map,dependedBy:new Map};for(const _ of e){const g=_.uniqueId;s.dependsOn.set(g,new Set),s.dependedBy.set(g,new Set)}for(const _ of e){const g=_.uniqueId,y=s.dependsOn.get(g);if(_ instanceof j_){const v=_.sourceMesh;i.has(v.uniqueId)&&(y.add(v.uniqueId),s.dependedBy.get(v.uniqueId).add(g))}const b=s.dependedBy.get(g);for(const v of _.getDescendants()){const S=v.uniqueId;i.has(S)&&(b.add(S),s.dependsOn.get(S).add(g))}}const n=[],a=[];for(const _ of e){const g=_.uniqueId;s.dependsOn.get(g).size===0&&(a.push(_),i.delete(g))}const p=a;for(;p.length>0;){const _=p.shift();n.push(_);const g=s.dependedBy.get(_.uniqueId);for(const y of Array.from(g.values())){const b=s.dependsOn.get(y);b.delete(_.uniqueId),b.size===0&&i.get(y)&&(p.push(i.get(y)),i.delete(y))}}return i.size>0&&(console.error("SceneSerializer._topologicalSort: There were unvisited nodes:"),i.forEach(_=>console.error(_.name))),n}_addNodeAndDescendantsToList(e,i,s,n){if(!(!s||n&&!n(s)||i.has(s.uniqueId))){e.push(s),i.add(s.uniqueId);for(const a of s.getDescendants(!0))this._addNodeAndDescendantsToList(e,i,a,n)}}_isNodeInContainer(e){return e instanceof Qe&&this.meshes.indexOf(e)!==-1||e instanceof Jt&&this.transformNodes.indexOf(e)!==-1||e instanceof Ei&&this.lights.indexOf(e)!==-1||e instanceof wt&&this.cameras.indexOf(e)!==-1}_isValidHierarchy(){for(const e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return Ie.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return Ie.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return Ie.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return Ie.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,i=!1,s){this._isValidHierarchy()||Le.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");const n={},a={},p=new tH,_=[],g=[],y={doNotInstantiate:!0,...s},b=(L,N)=>{if(n[L.uniqueId]=N.uniqueId,a[N.uniqueId]=N,e&&(N.name=e(L.name)),N instanceof Qe){const k=N;if(k.morphTargetManager){const G=L.morphTargetManager;k.morphTargetManager=G.clone();for(let H=0;H<G.numTargets;H++){const z=G.getTarget(H),W=k.morphTargetManager.getTarget(H);n[z.uniqueId]=W.uniqueId,a[W.uniqueId]=W}}}},v=[],S=new Set;for(const L of this.transformNodes)L.parent===null&&this._addNodeAndDescendantsToList(v,S,L,y.predicate);for(const L of this.meshes)L.parent===null&&this._addNodeAndDescendantsToList(v,S,L,y.predicate);const M=this._topologicalSort(v),F=(L,N)=>{if(b(L,N),L.parent){const k=n[L.parent.uniqueId],G=a[k];G?N.parent=G:N.parent=L.parent}if(N.position.copyFrom(L.position),N.rotation.copyFrom(L.rotation),N.scaling.copyFrom(L.scaling),N.material){const k=N;if(k.material)if(i){const G=L.material;if(g.indexOf(G)===-1){let H=G.clone(e?e(G.name):"Clone of "+G.name);if(g.push(G),n[G.uniqueId]=H.uniqueId,a[H.uniqueId]=H,G.getClassName()==="MultiMaterial"){const z=G;for(const W of z.subMaterials)!W||(H=W.clone(e?e(W.name):"Clone of "+W.name),g.push(W),n[W.uniqueId]=H.uniqueId,a[H.uniqueId]=H);z.subMaterials=z.subMaterials.map(W=>W&&a[n[W.uniqueId]])}}k.getClassName()!=="InstancedMesh"&&(k.material=a[n[G.uniqueId]])}else k.material.getClassName()==="MultiMaterial"?this.scene.multiMaterials.indexOf(k.material)===-1&&this.scene.addMultiMaterial(k.material):this.scene.materials.indexOf(k.material)===-1&&this.scene.addMaterial(k.material)}N.parent===null&&p.rootNodes.push(N)};return M.forEach(L=>{if(L.getClassName()==="InstancedMesh"){const N=L,k=N.sourceMesh,G=n[k.uniqueId],z=(typeof G=="number"?a[G]:k).createInstance(N.name);F(N,z)}else{let N=!0;L.getClassName()==="TransformNode"||L.skeleton||L.getTotalVertices()===0?N=!1:y.doNotInstantiate&&(typeof y.doNotInstantiate=="function"?N=!y.doNotInstantiate(L):N=!y.doNotInstantiate);const k=N?L.createInstance(`instance of ${L.name}`):L.clone(`Clone of ${L.name}`,null,!0);if(!k)throw new Error(`Could not clone or instantiate node on Asset Container ${L.name}`);F(L,k)}}),this.skeletons.forEach(L=>{if(y.predicate&&!y.predicate(L))return;const N=L.clone(e?e(L.name):"Clone of "+L.name);for(const k of this.meshes)if(k.skeleton===L&&!k.isAnInstance){const G=a[n[k.uniqueId]];if(!G||G.isAnInstance||(G.skeleton=N,_.indexOf(N)!==-1))continue;_.push(N);for(const H of N.bones)H._linkedTransformNode&&(H._linkedTransformNode=a[n[H._linkedTransformNode.uniqueId]])}p.skeletons.push(N)}),this.animationGroups.forEach(L=>{if(y.predicate&&!y.predicate(L))return;const N=L.clone(e?e(L.name):"Clone of "+L.name,k=>a[n[k.uniqueId]]||k);p.animationGroups.push(N)}),p}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||Le.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){this.cameras.forEach(i=>{e&&!e(i)||this.scene.addCamera(i)}),this.lights.forEach(i=>{e&&!e(i)||this.scene.addLight(i)}),this.meshes.forEach(i=>{e&&!e(i)||this.scene.addMesh(i)}),this.skeletons.forEach(i=>{e&&!e(i)||this.scene.addSkeleton(i)}),this.animations.forEach(i=>{e&&!e(i)||this.scene.addAnimation(i)}),this.animationGroups.forEach(i=>{e&&!e(i)||this.scene.addAnimationGroup(i)}),this.multiMaterials.forEach(i=>{e&&!e(i)||this.scene.addMultiMaterial(i)}),this.materials.forEach(i=>{e&&!e(i)||this.scene.addMaterial(i)}),this.morphTargetManagers.forEach(i=>{e&&!e(i)||this.scene.addMorphTargetManager(i)}),this.geometries.forEach(i=>{e&&!e(i)||this.scene.addGeometry(i)}),this.transformNodes.forEach(i=>{e&&!e(i)||this.scene.addTransformNode(i)}),this.actionManagers.forEach(i=>{e&&!e(i)||this.scene.addActionManager(i)}),this.textures.forEach(i=>{e&&!e(i)||this.scene.addTexture(i)}),this.reflectionProbes.forEach(i=>{e&&!e(i)||this.scene.addReflectionProbe(i)})}removeAllFromScene(){this._isValidHierarchy()||Le.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){this.cameras.forEach(i=>{e&&!e(i)||this.scene.removeCamera(i)}),this.lights.forEach(i=>{e&&!e(i)||this.scene.removeLight(i)}),this.meshes.forEach(i=>{e&&!e(i)||this.scene.removeMesh(i)}),this.skeletons.forEach(i=>{e&&!e(i)||this.scene.removeSkeleton(i)}),this.animations.forEach(i=>{e&&!e(i)||this.scene.removeAnimation(i)}),this.animationGroups.forEach(i=>{e&&!e(i)||this.scene.removeAnimationGroup(i)}),this.multiMaterials.forEach(i=>{e&&!e(i)||this.scene.removeMultiMaterial(i)}),this.materials.forEach(i=>{e&&!e(i)||this.scene.removeMaterial(i)}),this.morphTargetManagers.forEach(i=>{e&&!e(i)||this.scene.removeMorphTargetManager(i)}),this.geometries.forEach(i=>{e&&!e(i)||this.scene.removeGeometry(i)}),this.transformNodes.forEach(i=>{e&&!e(i)||this.scene.removeTransformNode(i)}),this.actionManagers.forEach(i=>{e&&!e(i)||this.scene.removeActionManager(i)}),this.textures.forEach(i=>{e&&!e(i)||this.scene.removeTexture(i)}),this.reflectionProbes.forEach(i=>{e&&!e(i)||this.scene.removeReflectionProbe(i)})}dispose(){this.cameras.slice(0).forEach(e=>{e.dispose()}),this.cameras.length=0,this.lights.slice(0).forEach(e=>{e.dispose()}),this.lights.length=0,this.meshes.slice(0).forEach(e=>{e.dispose()}),this.meshes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach(e=>{e.dispose()}),this.multiMaterials.length=0,this.materials.slice(0).forEach(e=>{e.dispose()}),this.materials.length=0,this.geometries.slice(0).forEach(e=>{e.dispose()}),this.geometries.length=0,this.transformNodes.slice(0).forEach(e=>{e.dispose()}),this.transformNodes.length=0,this.actionManagers.slice(0).forEach(e=>{e.dispose()}),this.actionManagers.length=0,this.textures.slice(0).forEach(e=>{e.dispose()}),this.textures.length=0,this.reflectionProbes.slice(0).forEach(e=>{e.dispose()}),this.reflectionProbes.length=0,this.morphTargetManagers.slice(0).forEach(e=>{e.dispose()}),this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,i,s){if(!(!e||!i))for(const n of e){let a=!0;if(s){for(const p of s)if(n===p){a=!1;break}}a&&(i.push(n),n._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,e===void 0&&(e=new eH);for(const i in this)Object.prototype.hasOwnProperty.call(this,i)&&(this[i]=this[i]||(i==="_environmentTexture"?null:[]),this._moveAssets(this.scene[i],this[i],e[i]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const e=new Qe("assetContainerRootMesh",this.scene);return this.meshes.forEach(i=>{i.parent||e.addChild(i)}),this.meshes.unshift(e),e}mergeAnimationsTo(e=Zt.LastCreatedScene,i,s=null){if(!e)return Ie.Error("No scene available to merge animations to"),[];const n=s||(_=>{let g=null;const y=_.animations.length?_.animations[0].targetProperty:"",b=_.name.split(".").join("").split("_primitive")[0];switch(y){case"position":case"rotationQuaternion":g=e.getTransformNodeByName(_.name)||e.getTransformNodeByName(b);break;case"influence":g=e.getMorphTargetByName(_.name)||e.getMorphTargetByName(b);break;default:g=e.getNodeByName(_.name)||e.getNodeByName(b)}return g});this.getNodes().forEach(_=>{const g=n(_);if(g!==null){for(const y of _.animations){const b=g.animations.filter(v=>v.targetProperty===y.targetProperty);for(const v of b){const S=g.animations.indexOf(v,0);S>-1&&g.animations.splice(S,1)}}g.animations=g.animations.concat(_.animations)}});const p=new Array;return this.animationGroups.slice().forEach(_=>{p.push(_.clone(_.name,n)),_.animatables.forEach(g=>{g.stop()})}),i.forEach(_=>{const g=n(_.target);g&&(e.beginAnimation(g,_.fromFrame,_.toFrame,_.loopAnimation,_.speedRatio,_.onAnimationEnd?_.onAnimationEnd:void 0,void 0,!0,void 0,_.onAnimationLoop?_.onAnimationLoop:void 0),e.stopAnimation(_.target))}),p}}class $_{constructor(e){this.byteOffset=0,this.buffer=e}loadAsync(e){return this.buffer.readAsync(this.byteOffset,e).then(i=>{this._dataView=new DataView(i.buffer,i.byteOffset,i.byteLength),this._dataByteOffset=0})}readUint32(){const e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e}readUint8Array(e){const i=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,i}readString(e){return hE(this.readUint8Array(e))}skipBytes(e){this._dataByteOffset+=e,this.byteOffset+=e}}function J_(l,e,i,s){const n={externalResourceFunction:a=>s(a).then(p=>new Uint8Array(p))};return i&&(n.uri=e==="file:"?i:e+i),l instanceof ArrayBuffer?GLTFValidator.validateBytes(new Uint8Array(l),n):GLTFValidator.validateString(l,n)}function rH(){const l=[];onmessage=e=>{const i=e.data;switch(i.id){case"init":{importScripts(i.url);break}case"validate":{J_(i.data,i.rootUrl,i.fileName,s=>new Promise((n,a)=>{const p=l.length;l.push({resolve:n,reject:a}),postMessage({id:"getExternalResource",index:p,uri:s})})).then(s=>{postMessage({id:"validate.resolve",value:s})},s=>{postMessage({id:"validate.reject",reason:s})});break}case"getExternalResource.resolve":{l[i.index].resolve(i.value);break}case"getExternalResource.reject":{l[i.index].reject(i.reason);break}}}}class tM{static ValidateAsync(e,i,s,n){return typeof Worker=="function"?new Promise((a,p)=>{const _=`${J_}(${rH})()`,g=URL.createObjectURL(new Blob([_],{type:"application/javascript"})),y=new Worker(g),b=S=>{y.removeEventListener("error",b),y.removeEventListener("message",v),p(S)},v=S=>{const M=S.data;switch(M.id){case"getExternalResource":{n(M.uri).then(F=>{y.postMessage({id:"getExternalResource.resolve",index:M.index,value:F},[F])},F=>{y.postMessage({id:"getExternalResource.reject",index:M.index,reason:F})});break}case"validate.resolve":{y.removeEventListener("error",b),y.removeEventListener("message",v),a(M.value),y.terminate();break}case"validate.reject":y.removeEventListener("error",b),y.removeEventListener("message",v),p(M.reason),y.terminate()}};y.addEventListener("error",b),y.addEventListener("message",v),y.postMessage({id:"init",url:this.Configuration.url}),y.postMessage({id:"validate",data:e,rootUrl:i,fileName:s})}):(this._LoadScriptPromise||(this._LoadScriptPromise=Le.LoadScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>J_(e,i,s,n)))}}tM.Configuration={url:"https://preview.babylonjs.com/gltf_validator.js"};function iM(l,e,i){try{return Promise.resolve(new Uint8Array(l,e,i))}catch(s){return Promise.reject(s)}}var du;(function(l){l[l.AUTO=0]="AUTO",l[l.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"})(du||(du={}));var Vc;(function(l){l[l.NONE=0]="NONE",l[l.FIRST=1]="FIRST",l[l.ALL=2]="ALL"})(Vc||(Vc={}));var ha;(function(l){l[l.LOADING=0]="LOADING",l[l.READY=1]="READY",l[l.COMPLETE=2]="COMPLETE"})(ha||(ha={}));class Rr{constructor(){this.onParsedObservable=new Re,this.coordinateSystemMode=du.AUTO,this.animationStartMode=Vc.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable=new Re,this.onSkinLoadedObservable=new Re,this.onTextureLoadedObservable=new Re,this.onMaterialLoadedObservable=new Re,this.onCameraLoadedObservable=new Re,this.onCompleteObservable=new Re,this.onErrorObservable=new Re,this.onDisposeObservable=new Re,this.onExtensionLoadedObservable=new Re,this.validate=!1,this.onValidatedObservable=new Re,this._loader=null,this._state=null,this._requests=new Array,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this.onLoaderStateChangedObservable=new Re,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(e)}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e)}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e)}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e)}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e)}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,i,s,n,a,p){this._progressCallback=n;const _=i.name?"file:":Le.GetFolderPath(i),g=i.name||Le.GetFilename(i);if(a){if(this.useRangeRequests){this.validate&&Ie.Warn("glTF validation is not supported when range requests are enabled");const y={abort:()=>{},onCompleteObservable:new Re},b={readAsync:(v,S)=>new Promise((M,F)=>{this._loadFile(e,i,L=>{M(new Uint8Array(L))},!0,L=>{F(L)},L=>{L.setRequestHeader("Range",`bytes=${v}-${v+S-1}`)})}),byteLength:0};return this._unpackBinaryAsync(new $_(b)).then(v=>{y.onCompleteObservable.notifyObservers(y),s(v)},p?v=>p(void 0,v):void 0),y}return this._loadFile(e,i,y=>{this._validate(e,y,_,g),this._unpackBinaryAsync(new $_({readAsync:(b,v)=>iM(y,b,v),byteLength:y.byteLength})).then(b=>{s(b)},p?b=>p(void 0,b):void 0)},!0,p)}return this._loadFile(e,i,y=>{this._validate(e,y,_,g),s({json:this._parseJson(y)})},a,p)}importMeshAsync(e,i,s,n,a,p){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(s),this.onParsedObservable.clear(),this._log(`Loading ${p||""}`),this._loader=this._getLoader(s),this._loader.importMeshAsync(e,i,null,s,n,a,p)))}loadAsync(e,i,s,n,a){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(i),this.onParsedObservable.clear(),this._log(`Loading ${a||""}`),this._loader=this._getLoader(i),this._loader.loadAsync(e,i,s,n,a)))}loadAssetContainerAsync(e,i,s,n,a){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(i),this.onParsedObservable.clear(),this._log(`Loading ${a||""}`),this._loader=this._getLoader(i);const p=new iH(e),_=[];this.onMaterialLoadedObservable.add(v=>{_.push(v)});const g=[];this.onTextureLoadedObservable.add(v=>{g.push(v)});const y=[];this.onCameraLoadedObservable.add(v=>{y.push(v)});const b=[];return this.onMeshLoadedObservable.add(v=>{v.morphTargetManager&&b.push(v.morphTargetManager)}),this._loader.importMeshAsync(null,e,p,i,s,n,a).then(v=>(Array.prototype.push.apply(p.geometries,v.geometries),Array.prototype.push.apply(p.meshes,v.meshes),Array.prototype.push.apply(p.particleSystems,v.particleSystems),Array.prototype.push.apply(p.skeletons,v.skeletons),Array.prototype.push.apply(p.animationGroups,v.animationGroups),Array.prototype.push.apply(p.materials,_),Array.prototype.push.apply(p.textures,g),Array.prototype.push.apply(p.lights,v.lights),Array.prototype.push.apply(p.transformNodes,v.transformNodes),Array.prototype.push.apply(p.cameras,y),Array.prototype.push.apply(p.morphTargetManagers,b),p))})}canDirectLoad(e){return e.indexOf("asset")!==-1&&e.indexOf("version")!==-1||e.startsWith("data:base64,"+Rr._MagicBase64Encoded)||e.startsWith("data:;base64,"+Rr._MagicBase64Encoded)||e.startsWith("data:application/octet-stream;base64,"+Rr._MagicBase64Encoded)||e.startsWith("data:model/gltf-binary;base64,"+Rr._MagicBase64Encoded)}directLoad(e,i){if(i.startsWith("base64,"+Rr._MagicBase64Encoded)||i.startsWith(";base64,"+Rr._MagicBase64Encoded)||i.startsWith("application/octet-stream;base64,"+Rr._MagicBase64Encoded)||i.startsWith("model/gltf-binary;base64,"+Rr._MagicBase64Encoded)){const s=Wh(i);return this._validate(e,s),this._unpackBinaryAsync(new $_({readAsync:(n,a)=>iM(s,n,a),byteLength:s.byteLength}))}return this._validate(e,i),Promise.resolve({json:this._parseJson(i)})}createPlugin(){return new Rr}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((e,i)=>{this.onCompleteObservable.addOnce(()=>{e()}),this.onErrorObservable.addOnce(s=>{i(s)})})}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(ha[this._state]))}_loadFile(e,i,s,n,a,p){const _=e._loadFile(i,s,g=>{this._onProgress(g,_)},!0,n,a,p);return _.onCompleteObservable.add(g=>{this._requests.splice(this._requests.indexOf(g),1)}),this._requests.push(_),_}_onProgress(e,i){if(!this._progressCallback)return;i._lengthComputable=e.lengthComputable,i._loaded=e.loaded,i._total=e.total;let s=!0,n=0,a=0;for(const p of this._requests){if(p._lengthComputable===void 0||p._loaded===void 0||p._total===void 0)return;s=s&&p._lengthComputable,n+=p._loaded,a+=p._total}this._progressCallback({lengthComputable:s,loaded:n,total:s?a:0})}_validate(e,i,s="",n=""){!this.validate||(this._startPerformanceCounter("Validate JSON"),tM.ValidateAsync(i,s,n,a=>this.preprocessUrlAsync(s+a).then(p=>e._loadFileAsync(p,void 0,!0,!0))).then(a=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(a),this.onValidatedObservable.clear()},a=>{this._endPerformanceCounter("Validate JSON"),Le.Warn(`Failed to validate: ${a.message}`),this.onValidatedObservable.clear()}))}_getLoader(e){const i=e.json.asset||{};this._log(`Asset version: ${i.version}`),i.minVersion&&this._log(`Asset minimum version: ${i.minVersion}`),i.generator&&this._log(`Asset generator: ${i.generator}`);const s=Rr._parseVersion(i.version);if(!s)throw new Error("Invalid version: "+i.version);if(i.minVersion!==void 0){const p=Rr._parseVersion(i.minVersion);if(!p)throw new Error("Invalid minimum version: "+i.minVersion);if(Rr._compareVersion(p,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+i.minVersion)}const a={1:Rr._CreateGLTF1Loader,2:Rr._CreateGLTF2Loader}[s.major];if(!a)throw new Error("Unsupported version: "+i.version);return a(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);const i=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),i}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then(()=>{const i={Magic:1179937895},s=e.readUint32();if(s!==i.Magic)throw new Wo("Unexpected magic: "+s,_x.GLTFLoaderUnexpectedMagicError);const n=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${n}`);const a=e.readUint32();!this.useRangeRequests&&a!==e.buffer.byteLength&&Ie.Warn(`Length in header does not match actual data length: ${a} != ${e.buffer.byteLength}`);let p;switch(n){case 1:{p=this._unpackBinaryV1Async(e,a);break}case 2:{p=this._unpackBinaryV2Async(e,a);break}default:throw new Error("Unsupported version: "+n)}return this._endPerformanceCounter("Unpack Binary"),p})}_unpackBinaryV1Async(e,i){const s={JSON:0},n=e.readUint32(),a=e.readUint32();if(a!==s.JSON)throw new Error(`Unexpected content format: ${a}`);const p=i-e.byteOffset,_={json:this._parseJson(e.readString(n)),bin:null};if(p!==0){const g=e.byteOffset;_.bin={readAsync:(y,b)=>e.buffer.readAsync(g+y,b),byteLength:p}}return Promise.resolve(_)}_unpackBinaryV2Async(e,i){const s={JSON:1313821514,BIN:5130562},n=e.readUint32();if(e.readUint32()!==s.JSON)throw new Error("First chunk format is not JSON");return e.byteOffset+n===i?e.loadAsync(n).then(()=>({json:this._parseJson(e.readString(n)),bin:null})):e.loadAsync(n+8).then(()=>{const p={json:this._parseJson(e.readString(n)),bin:null},_=()=>{const g=e.readUint32();switch(e.readUint32()){case s.JSON:throw new Error("Unexpected JSON chunk");case s.BIN:{const b=e.byteOffset;p.bin={readAsync:(v,S)=>e.buffer.readAsync(b+v,S),byteLength:g},e.skipBytes(g);break}default:{e.skipBytes(g);break}}return e.byteOffset!==i?e.loadAsync(8).then(_):Promise.resolve(p)};return _()})}static _parseVersion(e){if(e==="1.0"||e==="1.0.1")return{major:1,minor:0};const i=(e+"").match(/^(\d+)\.(\d+)/);return i?{major:parseInt(i[1]),minor:parseInt(i[2])}:null}static _compareVersion(e,i){return e.major>i.major?1:e.major<i.major?-1:e.minor>i.minor?1:e.minor<i.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){const i=Rr._logSpaces.substr(0,this._logIndentLevel*2);Ie.Log(`${i}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){Le.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){Le.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}}Rr.IncrementalLoading=!0,Rr.HomogeneousCoordinates=!1,Rr._MagicBase64Encoded="Z2xURg",Rr._logSpaces="                                ",ki&&ki.RegisterPlugin(new Rr);var Ox;(function(l){l[l.BYTE=5120]="BYTE",l[l.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",l[l.SHORT=5122]="SHORT",l[l.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",l[l.FLOAT=5126]="FLOAT"})(Ox||(Ox={}));var eg;(function(l){l[l.FRAGMENT=35632]="FRAGMENT",l[l.VERTEX=35633]="VERTEX"})(eg||(eg={}));var Kn;(function(l){l[l.BYTE=5120]="BYTE",l[l.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",l[l.SHORT=5122]="SHORT",l[l.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",l[l.INT=5124]="INT",l[l.UNSIGNED_INT=5125]="UNSIGNED_INT",l[l.FLOAT=5126]="FLOAT",l[l.FLOAT_VEC2=35664]="FLOAT_VEC2",l[l.FLOAT_VEC3=35665]="FLOAT_VEC3",l[l.FLOAT_VEC4=35666]="FLOAT_VEC4",l[l.INT_VEC2=35667]="INT_VEC2",l[l.INT_VEC3=35668]="INT_VEC3",l[l.INT_VEC4=35669]="INT_VEC4",l[l.BOOL=35670]="BOOL",l[l.BOOL_VEC2=35671]="BOOL_VEC2",l[l.BOOL_VEC3=35672]="BOOL_VEC3",l[l.BOOL_VEC4=35673]="BOOL_VEC4",l[l.FLOAT_MAT2=35674]="FLOAT_MAT2",l[l.FLOAT_MAT3=35675]="FLOAT_MAT3",l[l.FLOAT_MAT4=35676]="FLOAT_MAT4",l[l.SAMPLER_2D=35678]="SAMPLER_2D"})(Kn||(Kn={}));var fu;(function(l){l[l.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",l[l.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",l[l.REPEAT=10497]="REPEAT"})(fu||(fu={}));var Ao;(function(l){l[l.NEAREST=9728]="NEAREST",l[l.LINEAR=9728]="LINEAR",l[l.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",l[l.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",l[l.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",l[l.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(Ao||(Ao={}));var rM;(function(l){l[l.ALPHA=6406]="ALPHA",l[l.RGB=6407]="RGB",l[l.RGBA=6408]="RGBA",l[l.LUMINANCE=6409]="LUMINANCE",l[l.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"})(rM||(rM={}));var tg;(function(l){l[l.FRONT=1028]="FRONT",l[l.BACK=1029]="BACK",l[l.FRONT_AND_BACK=1032]="FRONT_AND_BACK"})(tg||(tg={}));var Vr;(function(l){l[l.ZERO=0]="ZERO",l[l.ONE=1]="ONE",l[l.SRC_COLOR=768]="SRC_COLOR",l[l.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",l[l.DST_COLOR=774]="DST_COLOR",l[l.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",l[l.SRC_ALPHA=770]="SRC_ALPHA",l[l.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",l[l.DST_ALPHA=772]="DST_ALPHA",l[l.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",l[l.CONSTANT_COLOR=32769]="CONSTANT_COLOR",l[l.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",l[l.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",l[l.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",l[l.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"})(Vr||(Vr={})),Yt.prototype.updateRawTexture=function(l,e,i,s,n=null,a=0,p=!1){if(!l)return;const _=this._getRGBABufferInternalSizedFormat(a,i,p),g=this._getInternalFormat(i),y=this._getWebGLTextureType(a);this._bindTextureDirectly(this._gl.TEXTURE_2D,l,!0),this._unpackFlipY(s===void 0?!0:!!s),this._doNotHandleContextLost||(l._bufferView=e,l.format=i,l.type=a,l.invertY=s,l._compression=n),l.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[n],l.width,l.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,_,l.width,l.height,0,g,y,e),l.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),l.isReady=!0},Yt.prototype.createRawTexture=function(l,e,i,s,n,a,p,_=null,g=0,y=0,b=!1){const v=new Bs(this,or.Raw);v.baseWidth=e,v.baseHeight=i,v.width=e,v.height=i,v.format=s,v.generateMipMaps=n,v.samplingMode=p,v.invertY=a,v._compression=_,v.type=g,v._useSRGBBuffer=this._getUseSRGBBuffer(b,!n),this._doNotHandleContextLost||(v._bufferView=l),this.updateRawTexture(v,l,s,a,_,g,v._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,v,!0);const S=this._getSamplingParameters(p,n);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,S.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,S.min),n&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(v),v},Yt.prototype.createRawCubeTexture=function(l,e,i,s,n,a,p,_=null){const g=this._gl,y=new Bs(this,or.CubeRaw);y.isCube=!0,y.format=i,y.type=s,this._doNotHandleContextLost||(y._bufferViewArray=l);const b=this._getWebGLTextureType(s);let v=this._getInternalFormat(i);v===g.RGB&&(v=g.RGBA),b===g.FLOAT&&!this._caps.textureFloatLinearFiltering?(n=!1,p=1,Ie.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):b===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering?(n=!1,p=1,Ie.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):b===g.FLOAT&&!this._caps.textureFloatRender?(n=!1,Ie.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):b===g.HALF_FLOAT&&!this._caps.colorBufferFloat&&(n=!1,Ie.Warn("Render to half float textures is not supported. Mipmap generation forced to false."));const S=e,M=S;if(y.width=S,y.height=M,y.invertY=a,y._compression=_,!this.needPOTTextures||Le.IsExponentOfTwo(y.width)&&Le.IsExponentOfTwo(y.height)||(n=!1),l)this.updateRawCubeTexture(y,l,i,s,a,_);else{const N=this._getRGBABufferInternalSizedFormat(s),k=0;this._bindTextureDirectly(g.TEXTURE_CUBE_MAP,y,!0);for(let G=0;G<6;G++)_?g.compressedTexImage2D(g.TEXTURE_CUBE_MAP_POSITIVE_X+G,k,this.getCaps().s3tc[_],y.width,y.height,0,void 0):g.texImage2D(g.TEXTURE_CUBE_MAP_POSITIVE_X+G,k,N,y.width,y.height,0,v,b,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,y,!0),l&&n&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const L=this._getSamplingParameters(p,n);return g.texParameteri(g.TEXTURE_CUBE_MAP,g.TEXTURE_MAG_FILTER,L.mag),g.texParameteri(g.TEXTURE_CUBE_MAP,g.TEXTURE_MIN_FILTER,L.min),g.texParameteri(g.TEXTURE_CUBE_MAP,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_CUBE_MAP,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE),this._bindTextureDirectly(g.TEXTURE_CUBE_MAP,null),y.generateMipMaps=n,y.samplingMode=p,y.isReady=!0,y},Yt.prototype.updateRawCubeTexture=function(l,e,i,s,n,a=null,p=0){l._bufferViewArray=e,l.format=i,l.type=s,l.invertY=n,l._compression=a;const _=this._gl,g=this._getWebGLTextureType(s);let y=this._getInternalFormat(i);const b=this._getRGBABufferInternalSizedFormat(s);let v=!1;y===_.RGB&&(y=_.RGBA,v=!0),this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,l,!0),this._unpackFlipY(n===void 0?!0:!!n),l.width%4!==0&&_.pixelStorei(_.UNPACK_ALIGNMENT,1);for(let M=0;M<6;M++){let F=e[M];a?_.compressedTexImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_X+M,p,this.getCaps().s3tc[a],l.width,l.height,0,F):(v&&(F=sM(F,l.width,l.height,s)),_.texImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_X+M,p,b,l.width,l.height,0,y,g,F))}(!this.needPOTTextures||Le.IsExponentOfTwo(l.width)&&Le.IsExponentOfTwo(l.height))&&l.generateMipMaps&&p===0&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),l.isReady=!0},Yt.prototype.createRawCubeTextureFromUrl=function(l,e,i,s,n,a,p,_,g=null,y=null,b=3,v=!1){const S=this._gl,M=this.createRawCubeTexture(null,i,s,n,!a,v,b,null);e?.addPendingData(M),M.url=l,this._internalTexturesCache.push(M);const F=(N,k)=>{e?.removePendingData(M),y&&N&&y(N.status+" "+N.statusText,k)},L=N=>{const k=M.width,G=p(N);if(!!G){if(_){const H=this._getWebGLTextureType(n);let z=this._getInternalFormat(s);const W=this._getRGBABufferInternalSizedFormat(n);let Y=!1;z===S.RGB&&(z=S.RGBA,Y=!0),this._bindTextureDirectly(S.TEXTURE_CUBE_MAP,M,!0),this._unpackFlipY(!1);const Z=_(G);for(let Q=0;Q<Z.length;Q++){const se=k>>Q;for(let $=0;$<6;$++){let oe=Z[Q][$];Y&&(oe=sM(oe,se,se,n)),S.texImage2D($,Q,W,se,se,0,z,H,oe)}}this._bindTextureDirectly(S.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(M,G,s,n,v);M.isReady=!0,e?.removePendingData(M),M.onLoadedObservable.notifyObservers(M),M.onLoadedObservable.clear(),g&&g()}};return this._loadFile(l,N=>{L(N)},void 0,e?.offlineProvider,!0,F),M};function sM(l,e,i,s){let n,a=1;s===1?n=new Float32Array(e*i*4):s===2?(n=new Uint16Array(e*i*4),a=15360):s===7?n=new Uint32Array(e*i*4):n=new Uint8Array(e*i*4);for(let p=0;p<e;p++)for(let _=0;_<i;_++){const g=(_*e+p)*3,y=(_*e+p)*4;n[y+0]=l[g+0],n[y+1]=l[g+1],n[y+2]=l[g+2],n[y+3]=a}return n}function nM(l){return function(e,i,s,n,a,p,_,g,y=null,b=0){const v=l?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,S=l?or.Raw3D:or.Raw2DArray,M=new Bs(this,S);M.baseWidth=i,M.baseHeight=s,M.baseDepth=n,M.width=i,M.height=s,M.depth=n,M.format=a,M.type=b,M.generateMipMaps=p,M.samplingMode=g,l?M.is3D=!0:M.is2DArray=!0,this._doNotHandleContextLost||(M._bufferView=e),l?this.updateRawTexture3D(M,e,a,_,y,b):this.updateRawTexture2DArray(M,e,a,_,y,b),this._bindTextureDirectly(v,M,!0);const F=this._getSamplingParameters(g,p);return this._gl.texParameteri(v,this._gl.TEXTURE_MAG_FILTER,F.mag),this._gl.texParameteri(v,this._gl.TEXTURE_MIN_FILTER,F.min),p&&this._gl.generateMipmap(v),this._bindTextureDirectly(v,null),this._internalTexturesCache.push(M),M}}Yt.prototype.createRawTexture2DArray=nM(!1),Yt.prototype.createRawTexture3D=nM(!0);function aM(l){return function(e,i,s,n,a=null,p=0){const _=l?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,g=this._getWebGLTextureType(p),y=this._getInternalFormat(s),b=this._getRGBABufferInternalSizedFormat(p,s);this._bindTextureDirectly(_,e,!0),this._unpackFlipY(n===void 0?!0:!!n),this._doNotHandleContextLost||(e._bufferView=i,e.format=s,e.invertY=n,e._compression=a),e.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),a&&i?this._gl.compressedTexImage3D(_,0,this.getCaps().s3tc[a],e.width,e.height,e.depth,0,i):this._gl.texImage3D(_,0,b,e.width,e.height,e.depth,0,y,g,i),e.generateMipMaps&&this._gl.generateMipmap(_),this._bindTextureDirectly(_,null),e.isReady=!0}}Yt.prototype.updateRawTexture2DArray=aM(!1),Yt.prototype.updateRawTexture3D=aM(!0);class Co extends Oe{constructor(e,i,s,n,a,p=!0,_=!1,g=3,y=0,b,v){super(null,a,!p,_,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,b),this.format=n,this._engine&&(!this._engine._caps.textureFloatLinearFiltering&&y===1&&(g=1),!this._engine._caps.textureHalfFloatLinearFiltering&&y===2&&(g=1),this._texture=this._engine.createRawTexture(e,i,s,n,p,_,g,null,y,b??0,v??!1),this.wrapU=Oe.CLAMP_ADDRESSMODE,this.wrapV=Oe.CLAMP_ADDRESSMODE)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer)}static CreateLuminanceTexture(e,i,s,n,a=!0,p=!1,_=3){return new Co(e,i,s,1,n,a,p,_)}static CreateLuminanceAlphaTexture(e,i,s,n,a=!0,p=!1,_=3){return new Co(e,i,s,2,n,a,p,_)}static CreateAlphaTexture(e,i,s,n,a=!0,p=!1,_=3){return new Co(e,i,s,0,n,a,p,_)}static CreateRGBTexture(e,i,s,n,a=!0,p=!1,_=3,g=0,y=0,b=!1){return new Co(e,i,s,4,n,a,p,_,g,y,b)}static CreateRGBATexture(e,i,s,n,a=!0,p=!1,_=3,g=0,y=0,b=!1){return new Co(e,i,s,5,n,a,p,_,g,y,b)}static CreateRGBAStorageTexture(e,i,s,n,a=!0,p=!1,_=3,g=0,y=!1){return new Co(e,i,s,5,n,a,p,_,g,1,y)}static CreateRTexture(e,i,s,n,a=!0,p=!1,_=Oe.TRILINEAR_SAMPLINGMODE,g=1){return new Co(e,i,s,6,n,a,p,_,g)}static CreateRStorageTexture(e,i,s,n,a=!0,p=!1,_=Oe.TRILINEAR_SAMPLINGMODE,g=1){return new Co(e,i,s,6,n,a,p,_,g,1)}}class Gc{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,i,s){this.name=e,this.id=i,this.bones=new Array,this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=fe.Identity(),this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new Re,this.bones=[],this._scene=s||Zt.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const n=this._scene.getEngine().getCaps();this._canUseTextureForBones=n.textureFloat&&n.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(e=>!e.getParent())}getTransformMatrices(e){return this.needInitialSkinMatrix?(e._bonesTransformMatrices||this.prepare(),e._bonesTransformMatrices):((!this._transformMatrices||this._isDirty)&&this.prepare(),this._transformMatrices)}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let i=`Name: ${this.name}, nBones: ${this.bones.length}`;if(i+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){i+=", Ranges: {";let s=!0;for(const n in this._ranges)s&&(i+=", ",s=!1),i+=n;i+="}"}return i}getBoneIndexByName(e){for(let i=0,s=this.bones.length;i<s;i++)if(this.bones[i].name===e)return i;return-1}createAnimationRange(e,i,s){if(!this._ranges[e]){this._ranges[e]=new Lc(e,i,s);for(let n=0,a=this.bones.length;n<a;n++)this.bones[n].animations[0]&&this.bones[n].animations[0].createRange(e,i,s)}}deleteAnimationRange(e,i=!0){for(let s=0,n=this.bones.length;s<n;s++)this.bones[s].animations[0]&&this.bones[s].animations[0].deleteRange(e,i);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let i;for(i in this._ranges)e.push(this._ranges[i]);return e}copyAnimationRange(e,i,s=!1){if(this._ranges[i]||!e.getAnimationRange(i))return!1;let n=!0;const a=this._getHighestAnimationFrame()+1,p={},_=e.bones;let g,y;for(y=0,g=_.length;y<g;y++)p[_[y].name]=_[y];this.bones.length!==_.length&&(Ie.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${_.length}`),n=!1);const b=s&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(y=0,g=this.bones.length;y<g;y++){const S=this.bones[y].name,M=p[S];M?n=n&&this.bones[y].copyAnimationRange(M,i,a,s,b):(Ie.Warn("copyAnimationRange: not same rig, missing source bone "+S),n=!1)}const v=e.getAnimationRange(i);return v&&(this._ranges[i]=new Lc(i,v.from+a,v.to+a)),n}returnToRest(){for(const e of this.bones)e._index!==-1&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let i=0,s=this.bones.length;i<s;i++)if(this.bones[i].animations[0]){const n=this.bones[i].animations[0].getHighestFrame();e<n&&(e=n)}return e}beginAnimation(e,i,s,n){const a=this.getAnimationRange(e);return a?this._scene.beginAnimation(this,a.from,a.to,i,s,n):null}static MakeAnimationAdditive(e,i=0,s){const n=e.getAnimationRange(s);if(!n)return null;const a=e._scene.getAllAnimatablesByTarget(e);let p=null;for(let g=0;g<a.length;g++){const y=a[g];if(y.fromFrame===n?.from&&y.toFrame===n?.to){p=y;break}}const _=e.getAnimatables();for(let g=0;g<_.length;g++){const b=_[g].animations;if(!!b)for(let v=0;v<b.length;v++)Ce.MakeAnimationAdditive(b[v],i,s)}return p&&(p.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){const i=this._meshesWithPoseMatrix.indexOf(e);i>-1&&this._meshesWithPoseMatrix.splice(i,1)}_computeTransformMatrices(e,i){this.onBeforeComputeObservable.notifyObservers(this);for(let s=0;s<this.bones.length;s++){const n=this.bones[s];n._childUpdateId++;const a=n.getParent();if(a?n.getLocalMatrix().multiplyToRef(a.getWorldMatrix(),n.getWorldMatrix()):i?n.getLocalMatrix().multiplyToRef(i,n.getWorldMatrix()):n.getWorldMatrix().copyFrom(n.getLocalMatrix()),n._index!==-1){const p=n._index===null?s:n._index;n.getInvertedAbsoluteTransform().multiplyToArray(n.getWorldMatrix(),e,p*16)}}this._identity.copyToArray(e,this.bones.length*16)}prepare(){if(this._numBonesWithLinkedTransformNode>0){for(const e of this.bones)if(e._linkedTransformNode){const i=e._linkedTransformNode;e.position=i.position,i.rotationQuaternion?e.rotationQuaternion=i.rotationQuaternion:e.rotation=i.rotation,e.scaling=i.scaling}}if(this.needInitialSkinMatrix)for(const e of this._meshesWithPoseMatrix){const i=e.getPoseMatrix();let s=this._isDirty;if((!e._bonesTransformMatrices||e._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(e._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),s=!0),!!s){if(this._synchronizedWithMesh!==e){this._synchronizedWithMesh=e;for(const n of this.bones)n.getParent()||(n.getBaseMatrix().multiplyToRef(i,ge.Matrix[1]),n._updateDifferenceMatrix(ge.Matrix[1]));if(this.isUsingTextureForMatrices){const n=(this.bones.length+1)*4;(!e._transformMatrixTexture||e._transformMatrixTexture.getSize().width!==n)&&(e._transformMatrixTexture&&e._transformMatrixTexture.dispose(),e._transformMatrixTexture=Co.CreateRGBATexture(e._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(e._bonesTransformMatrices,i),this.isUsingTextureForMatrices&&e._transformMatrixTexture&&e._transformMatrixTexture.update(e._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=Co.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,i){const s=new Gc(e,i||e,this._scene);s.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let n=0;n<this.bones.length;n++){const a=this.bones[n];let p=null;const _=a.getParent();if(_){const y=this.bones.indexOf(_);p=s.bones[y]}const g=new $i(a.name,s,p,a.getBaseMatrix().clone(),a.getRestPose().clone());g._index=a._index,a._linkedTransformNode&&g.linkTransformNode(a._linkedTransformNode),Ya.DeepCopy(a.animations,g.animations)}if(this._ranges){s._ranges={};for(const n in this._ranges){const a=this._ranges[n];a&&(s._ranges[n]=a.clone())}}return this._isDirty=!0,s}enableBlending(e=.01){this.bones.forEach(i=>{i.animations.forEach(s=>{s.enableBlending=!0,s.blendingSpeed=e})})}dispose(){if(this._meshesWithPoseMatrix.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){var e;const i={};i.name=this.name,i.id=this.id,this.dimensionsAtRest&&(i.dimensionsAtRest=this.dimensionsAtRest.asArray()),i.bones=[],i.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let s=0;s<this.bones.length;s++){const n=this.bones[s],a=n.getParent(),p={parentBoneIndex:a?this.bones.indexOf(a):-1,index:n.getIndex(),name:n.name,id:n.id,matrix:n.getBaseMatrix().toArray(),rest:n.getRestPose().toArray(),linkedTransformNodeId:(e=n.getTransformNode())===null||e===void 0?void 0:e.id};i.bones.push(p),n.length&&(p.length=n.length),n.metadata&&(p.metadata=n.metadata),n.animations&&n.animations.length>0&&(p.animation=n.animations[0].serialize()),i.ranges=[];for(const _ in this._ranges){const g=this._ranges[_];if(!g)continue;const y={};y.name=_,y.from=g.from,y.to=g.to,i.ranges.push(y)}}return i}static Parse(e,i){const s=new Gc(e.name,e.id,i);e.dimensionsAtRest&&(s.dimensionsAtRest=j.FromArray(e.dimensionsAtRest)),s.needInitialSkinMatrix=e.needInitialSkinMatrix;let n;for(n=0;n<e.bones.length;n++){const a=e.bones[n],p=e.bones[n].index;let _=null;a.parentBoneIndex>-1&&(_=s.bones[a.parentBoneIndex]);const g=a.rest?fe.FromArray(a.rest):null,y=new $i(a.name,s,_,fe.FromArray(a.matrix),g,null,p);a.id!==void 0&&a.id!==null&&(y.id=a.id),a.length&&(y.length=a.length),a.metadata&&(y.metadata=a.metadata),a.animation&&y.animations.push(Ce.Parse(a.animation)),a.linkedTransformNodeId!==void 0&&a.linkedTransformNodeId!==null&&(s._hasWaitingData=!0,y._waitingTransformNodeId=a.linkedTransformNodeId)}if(e.ranges)for(n=0;n<e.ranges.length;n++){const a=e.ranges[n];s.createAnimationRange(a.name,a.from,a.to)}return s}computeAbsoluteTransforms(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteTransforms(),this._absoluteTransformIsDirty=!1)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){const e=new Array,i=new Array(this.bones.length);for(let s=0;s<this.bones.length;s++)this._sortBones(s,e,i);this.bones=e}_sortBones(e,i,s){if(s[e])return;s[e]=!0;const n=this.bones[e];if(!n)return;n._index===void 0&&(n._index=e);const a=n.getParent();a&&this._sortBones(this.bones.indexOf(a),i,s),i.push(n)}setCurrentPoseAsRest(){this.bones.forEach(e=>{e.setCurrentPoseAsRest()})}}vr.AddNodeConstructor("Light_Type_1",(l,e)=>()=>new Ja(l,j.Zero(),e));class Ja extends gl{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}constructor(e,i,s){super(e,s),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=i.scale(-1),this.direction=i}getClassName(){return"DirectionalLight"}getTypeID(){return Ei.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,i,s){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,i,s)}_setDefaultFixedFrustumShadowProjectionMatrix(e){const i=this.getScene().activeCamera;!i||fe.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,this.shadowMinZ!==void 0?this.shadowMinZ:i.minZ,this.shadowMaxZ!==void 0?this.shadowMaxZ:i.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,i,s){const n=this.getScene().activeCamera;if(!n)return;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){const b=j.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE;let v=Number.MAX_VALUE,S=Number.MIN_VALUE;for(let M=0;M<s.length;M++){const F=s[M];if(!F)continue;const N=F.getBoundingInfo().boundingBox;for(let k=0;k<N.vectorsWorld.length;k++)j.TransformCoordinatesToRef(N.vectorsWorld[k],i,b),b.x<this._orthoLeft&&(this._orthoLeft=b.x),b.y<this._orthoBottom&&(this._orthoBottom=b.y),b.x>this._orthoRight&&(this._orthoRight=b.x),b.y>this._orthoTop&&(this._orthoTop=b.y),this.autoCalcShadowZBounds&&(b.z<v&&(v=b.z),b.z>S&&(S=b.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=v,this._shadowMaxZ=S)}const a=this._orthoRight-this._orthoLeft,p=this._orthoTop-this._orthoBottom,_=this.shadowMinZ!==void 0?this.shadowMinZ:n.minZ,g=this.shadowMaxZ!==void 0?this.shadowMaxZ:n.maxZ,y=this.getScene().getEngine().useReverseDepthBuffer;fe.OrthoOffCenterLHToRef(this._orthoLeft-a*this.shadowOrthoScale,this._orthoRight+a*this.shadowOrthoScale,this._orthoBottom-p*this.shadowOrthoScale,this._orthoTop+p*this.shadowOrthoScale,y?g:_,y?_:g,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,i){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,i),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,i),this)}transferToNodeMaterialEffect(e,i){return this.computeTransformedInformation()?(e.setFloat3(i,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(i,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(e){const i=this._scene.getEngine();return!i.useReverseDepthBuffer&&i.isNDCHalfZRange?0:1}getDepthMaxZ(e){const i=this._scene.getEngine();return i.useReverseDepthBuffer&&i.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,i){e["DIRLIGHT"+i]=!0}}J([xe()],Ja.prototype,"shadowFrustumSize",null),J([xe()],Ja.prototype,"shadowOrthoScale",null),J([xe()],Ja.prototype,"autoUpdateExtends",void 0),J([xe()],Ja.prototype,"autoCalcShadowZBounds",void 0),J([xe("orthoLeft")],Ja.prototype,"_orthoLeft",void 0),J([xe("orthoRight")],Ja.prototype,"_orthoRight",void 0),J([xe("orthoTop")],Ja.prototype,"_orthoTop",void 0),J([xe("orthoBottom")],Ja.prototype,"_orthoBottom",void 0),vr.AddNodeConstructor("Light_Type_2",(l,e)=>()=>new jn(l,j.Zero(),j.Zero(),0,0,e));class jn extends gl{get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(e*.5),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues()}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(jn._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(()=>{this._markMeshesAsLightDirty()}):jn._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()})))}static _IsProceduralTexture(e){return e.onGeneratedObservable!==void 0}static _IsTexture(e){return e.onLoadObservable!==void 0}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0}constructor(e,i,s,n,a,p){super(e,p),this._innerAngle=0,this._projectionTextureMatrix=fe.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=j.Up(),this._projectionTextureViewLightDirty=!0,this._projectionTextureProjectionLightDirty=!0,this._projectionTextureDirty=!0,this._projectionTextureViewTargetVector=j.Zero(),this._projectionTextureViewLightMatrix=fe.Zero(),this._projectionTextureProjectionLightMatrix=fe.Zero(),this._projectionTextureScalingMatrix=fe.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=i,this.direction=s,this.angle=n,this.exponent=a}getClassName(){return"SpotLight"}getTypeID(){return Ei.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=!0}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=!0}_setDefaultShadowProjectionMatrix(e,i,s){const n=this.getScene().activeCamera;if(!n)return;this._shadowAngleScale=this._shadowAngleScale||1;const a=this._shadowAngleScale*this._angle,p=this.shadowMinZ!==void 0?this.shadowMinZ:n.minZ,_=this.shadowMaxZ!==void 0?this.shadowMaxZ:n.maxZ,g=this.getScene().getEngine().useReverseDepthBuffer;fe.PerspectiveFovLHToRef(a,1,g?_:p,g?p:_,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,g)}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.position.addToRef(this.direction,this._projectionTextureViewTargetVector),fe.LookAtLHToRef(this.position,this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;const e=this.projectionTextureLightFar,i=this.projectionTextureLightNear,s=e/(e-i),n=-s*i,a=1/Math.tan(this._angle/2),p=1;fe.FromValuesToRef(a/p,0,0,0,0,a,0,0,0,0,s,1,0,0,n,0,this._projectionTextureProjectionLightMatrix)}_computeProjectionTextureMatrix(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof Oe){const e=this._projectionTexture.uScale/2,i=this._projectionTexture.vScale/2;fe.FromValuesToRef(e,0,0,0,0,i,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(this._innerAngle*.5)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale}transferTexturesToEffect(e,i){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+i,this._projectionTextureMatrix),e.setTexture("projectionLightSampler"+i,this.projectionTexture)),this}transferToEffect(e,i){let s;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,i),s=j.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,i),s=j.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",s.x,s.y,s.z,this._cosHalfAngle,i),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,i),this}transferToNodeMaterialEffect(e,i){let s;return this.computeTransformedInformation()?s=j.Normalize(this.transformedDirection):s=j.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(i,-s.x,-s.y,-s.z):e.setFloat3(i,s.x,s.y,s.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose()}getDepthMinZ(e){const i=this._scene.getEngine(),s=this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ;return i.useReverseDepthBuffer&&i.isNDCHalfZRange?s:this._scene.getEngine().isNDCHalfZRange?0:s}getDepthMaxZ(e){const i=this._scene.getEngine(),s=this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ;return i.useReverseDepthBuffer&&i.isNDCHalfZRange?0:s}prepareLightSpecificDefines(e,i){e["SPOTLIGHT"+i]=!0,e["PROJECTEDLIGHTTEXTURE"+i]=!!(this.projectionTexture&&this.projectionTexture.isReady())}}J([xe()],jn.prototype,"angle",null),J([xe()],jn.prototype,"innerAngle",null),J([xe()],jn.prototype,"shadowAngleScale",null),J([xe()],jn.prototype,"exponent",void 0),J([xe()],jn.prototype,"projectionTextureLightNear",null),J([xe()],jn.prototype,"projectionTextureLightFar",null),J([xe()],jn.prototype,"projectionTextureUpDirection",null),J([qi("projectedLightTexture")],jn.prototype,"_projectionTexture",void 0);class fs{static SetMatrix(e,i,s,n,a){let p=null;if(s.semantic==="MODEL"?p=i.getWorldMatrix():s.semantic==="PROJECTION"?p=e.getProjectionMatrix():s.semantic==="VIEW"?p=e.getViewMatrix():s.semantic==="MODELVIEWINVERSETRANSPOSE"?p=fe.Transpose(i.getWorldMatrix().multiply(e.getViewMatrix()).invert()):s.semantic==="MODELVIEW"?p=i.getWorldMatrix().multiply(e.getViewMatrix()):s.semantic==="MODELVIEWPROJECTION"?p=i.getWorldMatrix().multiply(e.getTransformMatrix()):s.semantic==="MODELINVERSE"?p=i.getWorldMatrix().invert():s.semantic==="VIEWINVERSE"?p=e.getViewMatrix().invert():s.semantic==="PROJECTIONINVERSE"?p=e.getProjectionMatrix().invert():s.semantic==="MODELVIEWINVERSE"?p=i.getWorldMatrix().multiply(e.getViewMatrix()).invert():s.semantic==="MODELVIEWPROJECTIONINVERSE"?p=i.getWorldMatrix().multiply(e.getTransformMatrix()).invert():s.semantic==="MODELINVERSETRANSPOSE"&&(p=fe.Transpose(i.getWorldMatrix().invert())),p)switch(s.type){case Kn.FLOAT_MAT2:a.setMatrix2x2(n,fe.GetAsMatrix2x2(p));break;case Kn.FLOAT_MAT3:a.setMatrix3x3(n,fe.GetAsMatrix3x3(p));break;case Kn.FLOAT_MAT4:a.setMatrix(n,p);break;default:break}}static SetUniform(e,i,s,n){switch(n){case Kn.FLOAT:return e.setFloat(i,s),!0;case Kn.FLOAT_VEC2:return e.setVector2(i,ii.FromArray(s)),!0;case Kn.FLOAT_VEC3:return e.setVector3(i,j.FromArray(s)),!0;case Kn.FLOAT_VEC4:return e.setVector4(i,xr.FromArray(s)),!0;default:return!1}}static GetWrapMode(e){switch(e){case fu.CLAMP_TO_EDGE:return Oe.CLAMP_ADDRESSMODE;case fu.MIRRORED_REPEAT:return Oe.MIRROR_ADDRESSMODE;case fu.REPEAT:return Oe.WRAP_ADDRESSMODE;default:return Oe.WRAP_ADDRESSMODE}}static GetByteStrideFromType(e){switch(e.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(e){switch(e){case Ao.LINEAR:case Ao.LINEAR_MIPMAP_NEAREST:case Ao.LINEAR_MIPMAP_LINEAR:return Oe.TRILINEAR_SAMPLINGMODE;case Ao.NEAREST:case Ao.NEAREST_MIPMAP_NEAREST:return Oe.NEAREST_SAMPLINGMODE;default:return Oe.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(e,i,s,n,a){s=i.byteOffset+s;const p=e.loadedBufferViews[i.buffer];if(s+n>p.byteLength)throw new Error("Buffer access is out of range");const _=p.buffer;switch(s+=p.byteOffset,a){case Ox.BYTE:return new Int8Array(_,s,n);case Ox.UNSIGNED_BYTE:return new Uint8Array(_,s,n);case Ox.SHORT:return new Int16Array(_,s,n);case Ox.UNSIGNED_SHORT:return new Uint16Array(_,s,n);default:return new Float32Array(_,s,n)}}static GetBufferFromAccessor(e,i){const s=e.bufferViews[i.bufferView],n=i.count*fs.GetByteStrideFromType(i);return fs.GetBufferFromBufferView(e,s,i.byteOffset,n,i.componentType)}static DecodeBufferToText(e){let i="";const s=e.byteLength;for(let n=0;n<s;++n)i+=String.fromCharCode(e[n]);return i}static GetDefaultMaterial(e){if(!fs._DefaultMaterial){ir.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join(`
`),ir.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join(`
`);const i={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},s={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};fs._DefaultMaterial=new Zo("GLTFDefaultMaterial",e,i,s),fs._DefaultMaterial.setColor4("u_emission",new pi(.5,.5,.5,1))}return fs._DefaultMaterial}}fs._DefaultMaterial=null;class be{}be.ALPHA_DISABLE=0,be.ALPHA_ADD=1,be.ALPHA_COMBINE=2,be.ALPHA_SUBTRACT=3,be.ALPHA_MULTIPLY=4,be.ALPHA_MAXIMIZED=5,be.ALPHA_ONEONE=6,be.ALPHA_PREMULTIPLIED=7,be.ALPHA_PREMULTIPLIED_PORTERDUFF=8,be.ALPHA_INTERPOLATE=9,be.ALPHA_SCREENMODE=10,be.ALPHA_ONEONE_ONEONE=11,be.ALPHA_ALPHATOCOLOR=12,be.ALPHA_REVERSEONEMINUS=13,be.ALPHA_SRC_DSTONEMINUSSRCALPHA=14,be.ALPHA_ONEONE_ONEZERO=15,be.ALPHA_EXCLUSION=16,be.ALPHA_LAYER_ACCUMULATE=17,be.ALPHA_EQUATION_ADD=0,be.ALPHA_EQUATION_SUBSTRACT=1,be.ALPHA_EQUATION_REVERSE_SUBTRACT=2,be.ALPHA_EQUATION_MAX=3,be.ALPHA_EQUATION_MIN=4,be.ALPHA_EQUATION_DARKEN=5,be.DELAYLOADSTATE_NONE=0,be.DELAYLOADSTATE_LOADED=1,be.DELAYLOADSTATE_LOADING=2,be.DELAYLOADSTATE_NOTLOADED=4,be.NEVER=512,be.ALWAYS=519,be.LESS=513,be.EQUAL=514,be.LEQUAL=515,be.GREATER=516,be.GEQUAL=518,be.NOTEQUAL=517,be.KEEP=7680,be.ZERO=0,be.REPLACE=7681,be.INCR=7682,be.DECR=7683,be.INVERT=5386,be.INCR_WRAP=34055,be.DECR_WRAP=34056,be.TEXTURE_CLAMP_ADDRESSMODE=0,be.TEXTURE_WRAP_ADDRESSMODE=1,be.TEXTURE_MIRROR_ADDRESSMODE=2,be.TEXTURE_CREATIONFLAG_STORAGE=1,be.TEXTUREFORMAT_ALPHA=0,be.TEXTUREFORMAT_LUMINANCE=1,be.TEXTUREFORMAT_LUMINANCE_ALPHA=2,be.TEXTUREFORMAT_RGB=4,be.TEXTUREFORMAT_RGBA=5,be.TEXTUREFORMAT_RED=6,be.TEXTUREFORMAT_R=6,be.TEXTUREFORMAT_RG=7,be.TEXTUREFORMAT_RED_INTEGER=8,be.TEXTUREFORMAT_R_INTEGER=8,be.TEXTUREFORMAT_RG_INTEGER=9,be.TEXTUREFORMAT_RGB_INTEGER=10,be.TEXTUREFORMAT_RGBA_INTEGER=11,be.TEXTUREFORMAT_BGRA=12,be.TEXTUREFORMAT_DEPTH24_STENCIL8=13,be.TEXTUREFORMAT_DEPTH32_FLOAT=14,be.TEXTUREFORMAT_DEPTH16=15,be.TEXTUREFORMAT_DEPTH24=16,be.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17,be.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18,be.TEXTUREFORMAT_STENCIL8=19,be.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492,be.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493,be.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495,be.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494,be.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779,be.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919,be.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778,be.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918,be.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777,be.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776,be.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917,be.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916,be.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808,be.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840,be.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196,be.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492,be.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493,be.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494,be.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495,be.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496,be.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497,be.TEXTURETYPE_UNSIGNED_BYTE=0,be.TEXTURETYPE_UNSIGNED_INT=0,be.TEXTURETYPE_FLOAT=1,be.TEXTURETYPE_HALF_FLOAT=2,be.TEXTURETYPE_BYTE=3,be.TEXTURETYPE_SHORT=4,be.TEXTURETYPE_UNSIGNED_SHORT=5,be.TEXTURETYPE_INT=6,be.TEXTURETYPE_UNSIGNED_INTEGER=7,be.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,be.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,be.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,be.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,be.TEXTURETYPE_UNSIGNED_INT_24_8=12,be.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,be.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,be.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,be.TEXTURETYPE_UNDEFINED=16,be.TEXTURE_2D=3553,be.TEXTURE_2D_ARRAY=35866,be.TEXTURE_CUBE_MAP=34067,be.TEXTURE_CUBE_MAP_ARRAY=3735928559,be.TEXTURE_3D=32879,be.TEXTURE_NEAREST_SAMPLINGMODE=1,be.TEXTURE_NEAREST_NEAREST=1,be.TEXTURE_BILINEAR_SAMPLINGMODE=2,be.TEXTURE_LINEAR_LINEAR=2,be.TEXTURE_TRILINEAR_SAMPLINGMODE=3,be.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,be.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,be.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,be.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,be.TEXTURE_NEAREST_LINEAR=7,be.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,be.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,be.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,be.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,be.TEXTURE_LINEAR_NEAREST=12,be.TEXTURE_EXPLICIT_MODE=0,be.TEXTURE_SPHERICAL_MODE=1,be.TEXTURE_PLANAR_MODE=2,be.TEXTURE_CUBIC_MODE=3,be.TEXTURE_PROJECTION_MODE=4,be.TEXTURE_SKYBOX_MODE=5,be.TEXTURE_INVCUBIC_MODE=6,be.TEXTURE_EQUIRECTANGULAR_MODE=7,be.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,be.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,be.TEXTURE_FILTERING_QUALITY_OFFLINE=4096,be.TEXTURE_FILTERING_QUALITY_HIGH=64,be.TEXTURE_FILTERING_QUALITY_MEDIUM=16,be.TEXTURE_FILTERING_QUALITY_LOW=8,be.SCALEMODE_FLOOR=1,be.SCALEMODE_NEAREST=2,be.SCALEMODE_CEILING=3,be.MATERIAL_TextureDirtyFlag=1,be.MATERIAL_LightDirtyFlag=2,be.MATERIAL_FresnelDirtyFlag=4,be.MATERIAL_AttributesDirtyFlag=8,be.MATERIAL_MiscDirtyFlag=16,be.MATERIAL_PrePassDirtyFlag=32,be.MATERIAL_AllDirtyFlag=63,be.MATERIAL_TriangleFillMode=0,be.MATERIAL_WireFrameFillMode=1,be.MATERIAL_PointFillMode=2,be.MATERIAL_PointListDrawMode=3,be.MATERIAL_LineListDrawMode=4,be.MATERIAL_LineLoopDrawMode=5,be.MATERIAL_LineStripDrawMode=6,be.MATERIAL_TriangleStripDrawMode=7,be.MATERIAL_TriangleFanDrawMode=8,be.MATERIAL_ClockWiseSideOrientation=0,be.MATERIAL_CounterClockWiseSideOrientation=1,be.ACTION_NothingTrigger=0,be.ACTION_OnPickTrigger=1,be.ACTION_OnLeftPickTrigger=2,be.ACTION_OnRightPickTrigger=3,be.ACTION_OnCenterPickTrigger=4,be.ACTION_OnPickDownTrigger=5,be.ACTION_OnDoublePickTrigger=6,be.ACTION_OnPickUpTrigger=7,be.ACTION_OnPickOutTrigger=16,be.ACTION_OnLongPressTrigger=8,be.ACTION_OnPointerOverTrigger=9,be.ACTION_OnPointerOutTrigger=10,be.ACTION_OnEveryFrameTrigger=11,be.ACTION_OnIntersectionEnterTrigger=12,be.ACTION_OnIntersectionExitTrigger=13,be.ACTION_OnKeyDownTrigger=14,be.ACTION_OnKeyUpTrigger=15,be.PARTICLES_BILLBOARDMODE_Y=2,be.PARTICLES_BILLBOARDMODE_ALL=7,be.PARTICLES_BILLBOARDMODE_STRETCHED=8,be.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9,be.MESHES_CULLINGSTRATEGY_STANDARD=0,be.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,be.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,be.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,be.SCENELOADER_NO_LOGGING=0,be.SCENELOADER_MINIMAL_LOGGING=1,be.SCENELOADER_SUMMARY_LOGGING=2,be.SCENELOADER_DETAILED_LOGGING=3,be.PREPASS_IRRADIANCE_TEXTURE_TYPE=0,be.PREPASS_POSITION_TEXTURE_TYPE=1,be.PREPASS_VELOCITY_TEXTURE_TYPE=2,be.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3,be.PREPASS_COLOR_TEXTURE_TYPE=4,be.PREPASS_DEPTH_TEXTURE_TYPE=5,be.PREPASS_NORMAL_TEXTURE_TYPE=6,be.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7,be.BUFFER_CREATIONFLAG_READ=1,be.BUFFER_CREATIONFLAG_WRITE=2,be.BUFFER_CREATIONFLAG_READWRITE=3,be.BUFFER_CREATIONFLAG_UNIFORM=4,be.BUFFER_CREATIONFLAG_VERTEX=8,be.BUFFER_CREATIONFLAG_INDEX=16,be.BUFFER_CREATIONFLAG_STORAGE=32,be.RENDERPASS_MAIN=0,be.INPUT_ALT_KEY=18,be.INPUT_CTRL_KEY=17,be.INPUT_META_KEY1=91,be.INPUT_META_KEY2=92,be.INPUT_META_KEY3=93,be.INPUT_SHIFT_KEY=16,be.SNAPSHOTRENDERING_STANDARD=0,be.SNAPSHOTRENDERING_FAST=1,be.PERSPECTIVE_CAMERA=0,be.ORTHOGRAPHIC_CAMERA=1,be.FOVMODE_VERTICAL_FIXED=0,be.FOVMODE_HORIZONTAL_FIXED=1,be.RIG_MODE_NONE=0,be.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,be.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,be.RIG_MODE_STEREOSCOPIC_INTERLACED=14,be.RIG_MODE_VR=20,be.RIG_MODE_WEBVR=21,be.RIG_MODE_CUSTOM=22,be.MAX_SUPPORTED_UV_SETS=6,be.GL_ALPHA_EQUATION_ADD=32774,be.GL_ALPHA_EQUATION_MIN=32775,be.GL_ALPHA_EQUATION_MAX=32776,be.GL_ALPHA_EQUATION_SUBTRACT=32778,be.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779,be.GL_ALPHA_FUNCTION_SRC=768,be.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769,be.GL_ALPHA_FUNCTION_SRC_ALPHA=770,be.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771,be.GL_ALPHA_FUNCTION_DST_ALPHA=772,be.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773,be.GL_ALPHA_FUNCTION_DST_COLOR=774,be.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775,be.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776,be.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769,be.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770,be.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771,be.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772,be.SnippetUrl="https://snippet.babylonjs.com";var wx;(function(l){l[l.IDENTIFIER=1]="IDENTIFIER",l[l.UNKNOWN=2]="UNKNOWN",l[l.END_OF_INPUT=3]="END_OF_INPUT"})(wx||(wx={}));class oM{constructor(e){this._pos=0,this.currentToken=wx.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}getNextToken(){if(this.isEnd())return wx.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=wx.UNKNOWN,this.currentString==="_"||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=wx.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||this.currentString==="_");)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}}const xM=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],lM=["world","view","projection","worldView","worldViewProjection","mBones"],sH=["translation","rotation","scale"],nH=["position","rotationQuaternion","scaling"],aH=(l,e)=>{for(const i in l){const s=l[i];e.buffers[i]=s,e.buffersCount++}},oH=(l,e)=>{for(const i in l){const s=l[i];e.shaders[i]=s,e.shaderscount++}},Pn=(l,e,i)=>{for(const s in l){const n=l[s];i[e][s]=n}},xH=l=>{if(!!l)for(let e=0;e<l.length/2;e++)l[e*2+1]=1-l[e*2+1]},cM=l=>{if(l.semantic==="NORMAL")return"normal";if(l.semantic==="POSITION")return"position";if(l.semantic==="JOINT")return"matricesIndices";if(l.semantic==="WEIGHT")return"matricesWeights";if(l.semantic==="COLOR")return"color";if(l.semantic&&l.semantic.indexOf("TEXCOORD_")!==-1){const e=Number(l.semantic.split("_")[1]);return"uv"+(e===0?"":e+1)}return null},lH=l=>{for(const e in l.animations){const i=l.animations[e];if(!i.channels||!i.samplers)continue;let s=null;for(let n=0;n<i.channels.length;n++){const a=i.channels[n],p=i.samplers[a.sampler];if(!p)continue;let _=null,g=null;i.parameters?(_=i.parameters[p.input],g=i.parameters[p.output]):(_=p.input,g=p.output);const y=fs.GetBufferFromAccessor(l,l.accessors[_]),b=fs.GetBufferFromAccessor(l,l.accessors[g]),v=a.target.id;let S=l.scene.getNodeById(v);if(S===null&&(S=l.scene.getNodeByName(v)),S===null){Le.Warn("Creating animation named "+e+". But cannot find node named "+v+" to attach to");continue}const M=S instanceof $i;let F=a.target.path;const L=sH.indexOf(F);L!==-1&&(F=nH[L]);let N=Ce.ANIMATIONTYPE_MATRIX;M||(F==="rotationQuaternion"?(N=Ce.ANIMATIONTYPE_QUATERNION,S.rotationQuaternion=new Ve):N=Ce.ANIMATIONTYPE_VECTOR3);let k=null;const G=[];let H=0,z=!1;M&&s&&s.getKeys().length===y.length&&(k=s,z=!0),z||(l.scene._blockEntityCollection=!!l.assetContainer,k=new Ce(e,M?"_matrix":F,1,N,Ce.ANIMATIONLOOPMODE_CYCLE),l.scene._blockEntityCollection=!1);for(let W=0;W<y.length;W++){let Y=null;if(F==="rotationQuaternion"?(Y=Ve.FromArray([b[H],b[H+1],b[H+2],b[H+3]]),H+=4):(Y=j.FromArray([b[H],b[H+1],b[H+2]]),H+=3),M){const Z=S;let Q=j.Zero(),se=new Ve,$=j.Zero(),oe=Z.getBaseMatrix();z&&s&&(oe=s.getKeys()[W].value),oe.decompose($,se,Q),F==="position"?Q=Y:F==="rotationQuaternion"?se=Y:$=Y,Y=fe.Compose($,se,Q)}z?s&&(s.getKeys()[W].value=Y):G.push({frame:y[W],value:Y})}!z&&k&&(k.setKeys(G),S.animations.push(k)),s=k,l.scene.stopAnimation(S),l.scene.beginAnimation(S,0,y[y.length-1],!0,1)}}},ig=l=>{let e=null;if(l.translation||l.rotation||l.scale){const i=j.FromArray(l.scale||[1,1,1]),s=Ve.FromArray(l.rotation||[0,0,0,1]),n=j.FromArray(l.translation||[0,0,0]);e=fe.Compose(i,s,n)}else e=fe.FromArray(l.matrix);return e},hM=(l,e,i,s)=>{for(let a=0;a<s.bones.length;a++)if(s.bones[a].name===i)return s.bones[a];const n=l.nodes;for(const a in n){const p=n[a];if(!p.jointName)continue;const _=p.children;for(let g=0;g<_.length;g++){const y=l.nodes[_[g]];if(!!y.jointName&&y.jointName===i){const b=ig(p),v=new $i(p.name||"",s,hM(l,e,p.jointName,s),b);return v.id=a,v}}}return null},cH=(l,e)=>{for(let i=0;i<l.length;i++){const s=l[i];for(let n=0;n<s.node.children.length;n++)if(s.node.children[n]===e)return s.bone}return null},rg=(l,e)=>{const i=l.nodes;let s=i[e];if(s)return{node:s,id:e};for(const n in i)if(s=i[n],s.jointName===e)return{node:s,id:n};return null},hH=(l,e)=>{for(let i=0;i<l.jointNames.length;i++)if(l.jointNames[i]===e)return!0;return!1},uH=(l,e,i,s)=>{for(const n in l.nodes){const a=l.nodes[n],p=n;if(!a.jointName||hH(i,a.jointName))continue;const _=ig(a),g=new $i(a.name||"",e,null,_);g.id=p,s.push({bone:g,node:a,id:p})}for(let n=0;n<s.length;n++){const a=s[n],p=a.node.children;for(let _=0;_<p.length;_++){let g=null;for(let y=0;y<s.length;y++)if(s[y].id===p[_]){g=s[y];break}g&&(g.bone._parent=a.bone,a.bone.children.push(g.bone))}}},dH=(l,e,i,s)=>{if(s||(s=new Gc(e.name||"","",l.scene)),!e.babylonSkeleton)return s;const n=[],a=[];uH(l,s,e,n),s.bones=[];for(let _=0;_<e.jointNames.length;_++){const g=rg(l,e.jointNames[_]);if(!g)continue;const y=g.node;if(!y){Le.Warn("Joint named "+e.jointNames[_]+" does not exist");continue}const b=g.id,v=l.scene.getBoneById(b);if(v){s.bones.push(v);continue}let S=!1,M=null;for(let N=0;N<_;N++){const k=rg(l,e.jointNames[N]);if(!k)continue;const G=k.node;if(!G){Le.Warn("Joint named "+e.jointNames[N]+" does not exist when looking for parent");continue}const H=G.children;if(!!H){S=!1;for(let z=0;z<H.length;z++)if(H[z]===b){M=hM(l,e,e.jointNames[N],s),S=!0;break}if(S)break}}const F=ig(y);!M&&n.length>0&&(M=cH(n,b),M&&a.indexOf(M)===-1&&a.push(M));const L=new $i(y.jointName||"",s,M,F);L.id=b}const p=s.bones;s.bones=[];for(let _=0;_<e.jointNames.length;_++){const g=rg(l,e.jointNames[_]);if(!!g){for(let y=0;y<p.length;y++)if(p[y].id===g.id){s.bones.push(p[y]);break}}}s.prepare();for(let _=0;_<a.length;_++)s.bones.push(a[_]);return s},uM=(l,e,i,s,n)=>{if(n||(l.scene._blockEntityCollection=!!l.assetContainer,n=new Qe(e.name||"",l.scene),n._parentContainer=l.assetContainer,l.scene._blockEntityCollection=!1,n.id=s),!e.babylonNode)return n;const a=[];let p=null;const _=new Array,g=new Array,y=new Array,b=new Array;for(let M=0;M<i.length;M++){const F=i[M],L=l.meshes[F];if(!!L)for(let N=0;N<L.primitives.length;N++){const k=new Mt,G=L.primitives[N];G.mode;const H=G.attributes;let z=null,W=null;for(const Z in H)if(z=l.accessors[H[Z]],W=fs.GetBufferFromAccessor(l,z),Z==="NORMAL")k.normals=new Float32Array(W.length),k.normals.set(W);else if(Z==="POSITION"){if(Rr.HomogeneousCoordinates){k.positions=new Float32Array(W.length-W.length/4);for(let Q=0;Q<W.length;Q+=4)k.positions[Q]=W[Q],k.positions[Q+1]=W[Q+1],k.positions[Q+2]=W[Q+2]}else k.positions=new Float32Array(W.length),k.positions.set(W);g.push(k.positions.length)}else if(Z.indexOf("TEXCOORD_")!==-1){const Q=Number(Z.split("_")[1]),se=te.UVKind+(Q===0?"":Q+1),$=new Float32Array(W.length);$.set(W),xH($),k.set($,se)}else Z==="JOINT"?(k.matricesIndices=new Float32Array(W.length),k.matricesIndices.set(W)):Z==="WEIGHT"?(k.matricesWeights=new Float32Array(W.length),k.matricesWeights.set(W)):Z==="COLOR"&&(k.colors=new Float32Array(W.length),k.colors.set(W));if(z=l.accessors[G.indices],z)W=fs.GetBufferFromAccessor(l,z),k.indices=new Int32Array(W.length),k.indices.set(W),b.push(k.indices.length);else{const Z=[];for(let Q=0;Q<k.positions.length/3;Q++)Z.push(Q);k.indices=new Int32Array(Z),b.push(k.indices.length)}p?p.merge(k):p=k;const Y=l.scene.getMaterialById(G.material);a.push(Y===null?fs.GetDefaultMaterial(l.scene):Y),_.push(_.length===0?0:_[_.length-1]+g[g.length-2]),y.push(y.length===0?0:y[y.length-1]+b[b.length-2])}}let v;l.scene._blockEntityCollection=!!l.assetContainer,a.length>1?(v=new yl("multimat"+s,l.scene),v.subMaterials=a):v=new ot("multimat"+s,l.scene),a.length===1&&(v=a[0]),v._parentContainer=l.assetContainer,n.material||(n.material=v),new cn(s,l.scene,p,!1,n),n.computeWorldMatrix(!0),l.scene._blockEntityCollection=!1,n.subMeshes=[];let S=0;for(let M=0;M<i.length;M++){const F=i[M],L=l.meshes[F];if(!!L)for(let N=0;N<L.primitives.length;N++)L.primitives[N].mode,Sn.AddToMesh(S,_[S],g[S],y[S],b[S],n,n,!0),S++}return n},sg=(l,e,i,s)=>{l.position&&(l.position=e),(l.rotationQuaternion||l.rotation)&&(l.rotationQuaternion=i),l.scaling&&(l.scaling=s)},fH=(l,e)=>{if(e.matrix){const i=new j(0,0,0),s=new Ve,n=new j(0,0,0);fe.FromArray(e.matrix).decompose(n,s,i),sg(l,i,s,n)}else e.translation&&e.rotation&&e.scale&&sg(l,j.FromArray(e.translation),Ve.FromArray(e.rotation),j.FromArray(e.scale));l.computeWorldMatrix(!0)},pH=(l,e,i)=>{let s=null;if(l.importOnlyMeshes&&(e.skin||e.meshes)&&l.importMeshesNames&&l.importMeshesNames.length>0&&l.importMeshesNames.indexOf(e.name||"")===-1)return null;if(e.skin){if(e.meshes){const n=l.skins[e.skin],a=uM(l,e,e.meshes,i,e.babylonNode);a.skeleton=l.scene.getLastSkeletonById(e.skin),a.skeleton===null&&(a.skeleton=dH(l,n,a,n.babylonSkeleton),n.babylonSkeleton||(n.babylonSkeleton=a.skeleton)),s=a}}else if(e.meshes)s=uM(l,e,e.mesh?[e.mesh]:e.meshes,i,e.babylonNode);else if(e.light&&!e.babylonNode&&!l.importOnlyMeshes){const n=l.lights[e.light];if(n){if(n.type==="ambient"){const a=n[n.type],p=new P0(e.light,j.Zero(),l.scene);p.name=e.name||"",a.color&&(p.diffuse=qe.FromArray(a.color)),s=p}else if(n.type==="directional"){const a=n[n.type],p=new Ja(e.light,j.Zero(),l.scene);p.name=e.name||"",a.color&&(p.diffuse=qe.FromArray(a.color)),s=p}else if(n.type==="point"){const a=n[n.type],p=new Fc(e.light,j.Zero(),l.scene);p.name=e.name||"",a.color&&(p.diffuse=qe.FromArray(a.color)),s=p}else if(n.type==="spot"){const a=n[n.type],p=new jn(e.light,j.Zero(),j.Zero(),0,0,l.scene);p.name=e.name||"",a.color&&(p.diffuse=qe.FromArray(a.color)),a.fallOfAngle&&(p.angle=a.fallOfAngle),a.fallOffExponent&&(p.exponent=a.fallOffExponent),s=p}}}else if(e.camera&&!e.babylonNode&&!l.importOnlyMeshes){const n=l.cameras[e.camera];if(n){if(l.scene._blockEntityCollection=!!l.assetContainer,n.type==="orthographic"){const a=new Vn(e.camera,j.Zero(),l.scene,!1);a.name=e.name||"",a.mode=wt.ORTHOGRAPHIC_CAMERA,a.attachControl(),s=a,a._parentContainer=l.assetContainer}else if(n.type==="perspective"){const a=n[n.type],p=new Vn(e.camera,j.Zero(),l.scene,!1);p.name=e.name||"",p.attachControl(),a.aspectRatio||(a.aspectRatio=l.scene.getEngine().getRenderWidth()/l.scene.getEngine().getRenderHeight()),a.znear&&a.zfar&&(p.maxZ=a.zfar,p.minZ=a.znear),s=p,p._parentContainer=l.assetContainer}l.scene._blockEntityCollection=!1}}if(!e.jointName){if(e.babylonNode)return e.babylonNode;if(s===null){l.scene._blockEntityCollection=!!l.assetContainer;const n=new Qe(e.name||"",l.scene);n._parentContainer=l.assetContainer,l.scene._blockEntityCollection=!1,e.babylonNode=n,s=n}}if(s!==null){if(e.matrix&&s instanceof Qe)fH(s,e);else{const n=e.translation||[0,0,0],a=e.rotation||[0,0,0,1],p=e.scale||[1,1,1];sg(s,j.FromArray(n),Ve.FromArray(a),j.FromArray(p))}s.updateCache(!0),e.babylonNode=s}return s},pu=(l,e,i,s=!1)=>{const n=l.nodes[e];let a=null;if(l.importOnlyMeshes&&!s&&l.importMeshesNames?l.importMeshesNames.indexOf(n.name||"")!==-1||l.importMeshesNames.length===0?s=!0:s=!1:s=!0,!n.jointName&&s&&(a=pH(l,n,e),a!==null&&(a.id=e,a.parent=i)),n.children)for(let p=0;p<n.children.length;p++)pu(l,n.children[p],a,s)},dM=l=>{let e=l.currentScene;if(e)for(let i=0;i<e.nodes.length;i++)pu(l,e.nodes[i],null);else for(const i in l.scenes){e=l.scenes[i];for(let s=0;s<e.nodes.length;s++)pu(l,e.nodes[s],null)}lH(l);for(let i=0;i<l.scene.skeletons.length;i++){const s=l.scene.skeletons[i];l.scene.beginAnimation(s,0,Number.MAX_VALUE,!0,1)}},mH=(l,e,i,s,n,a,p)=>{const _=a.values||n.parameters;for(const g in i){const y=i[g],b=y.type;if(b===Kn.FLOAT_MAT2||b===Kn.FLOAT_MAT3||b===Kn.FLOAT_MAT4){if(y.semantic&&!y.source&&!y.node)fs.SetMatrix(e.scene,l,y,g,s.getEffect());else if(y.semantic&&(y.source||y.node)){let v=e.scene.getNodeByName(y.source||y.node||"");if(v===null&&(v=e.scene.getNodeById(y.source||y.node||"")),v===null)continue;fs.SetMatrix(e.scene,v,y,g,s.getEffect())}}else{const v=_[n.uniforms[g]];if(!v)continue;if(b===Kn.SAMPLER_2D){const S=e.textures[a.values?v:y.value].babylonTexture;if(S==null)continue;s.getEffect().setTexture(g,S)}else fs.SetUniform(s.getEffect(),g,v,b)}}p(s)},_H=(l,e,i,s,n)=>{const a=s.values||i.parameters,p=i.uniforms;for(const _ in n){const g=n[_],y=g.type;let b=a[p[_]];if(b===void 0&&(b=g.value),!b)continue;const v=S=>M=>{g.value&&S&&(e.setTexture(S,M),delete n[S])};y===Kn.SAMPLER_2D?Ws.LoadTextureAsync(l,s.values?b:g.value,v(_),()=>v(null)):g.value&&fs.SetUniform(e,_,s.values?b:g.value,y)&&delete n[_]}},gH=(l,e,i)=>(s,n)=>{e.dispose(!0),i("Cannot compile program named "+l.name+". Error: "+n+". Default material will be applied")},yH=(l,e,i,s,n,a)=>p=>{_H(l,e,i,s,n),e.onBind=_=>{mH(_,l,n,e,i,s,a)}},fM=(l,e,i)=>{for(const s in e.uniforms){const n=e.uniforms[s],a=e.parameters[n];if(l.currentIdentifier===s&&a.semantic&&!a.source&&!a.node){const p=xM.indexOf(a.semantic);if(p!==-1)return delete i[s],lM[p]}}return l.currentIdentifier},pM=l=>{for(const e in l.materials)Ws.LoadMaterialAsync(l,e,()=>{},()=>{})};class F0{static CreateRuntime(e,i,s){const n={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:i,rootUrl:s,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&Pn(e.extensions,"extensions",n),e.extensionsUsed&&Pn(e.extensionsUsed,"extensionsUsed",n),e.buffers&&aH(e.buffers,n),e.bufferViews&&Pn(e.bufferViews,"bufferViews",n),e.accessors&&Pn(e.accessors,"accessors",n),e.meshes&&Pn(e.meshes,"meshes",n),e.lights&&Pn(e.lights,"lights",n),e.cameras&&Pn(e.cameras,"cameras",n),e.nodes&&Pn(e.nodes,"nodes",n),e.images&&Pn(e.images,"images",n),e.textures&&Pn(e.textures,"textures",n),e.shaders&&oH(e.shaders,n),e.programs&&Pn(e.programs,"programs",n),e.samplers&&Pn(e.samplers,"samplers",n),e.techniques&&Pn(e.techniques,"techniques",n),e.materials&&Pn(e.materials,"materials",n),e.animations&&Pn(e.animations,"animations",n),e.skins&&Pn(e.skins,"skins",n),e.scenes&&(n.scenes=e.scenes),e.scene&&e.scenes&&(n.currentScene=e.scenes[e.scene]),n}static LoadBufferAsync(e,i,s,n,a){const p=e.buffers[i];Le.IsBase64(p.uri)?setTimeout(()=>s(new Uint8Array(Le.DecodeBase64(p.uri)))):Le.LoadFile(e.rootUrl+p.uri,_=>s(new Uint8Array(_)),a,void 0,!0,_=>{_&&n(_.status+" "+_.statusText)})}static LoadTextureBufferAsync(e,i,s,n){const a=e.textures[i];if(!a||!a.source){n("");return}if(a.babylonTexture){s(null);return}const p=e.images[a.source];Le.IsBase64(p.uri)?setTimeout(()=>s(new Uint8Array(Le.DecodeBase64(p.uri)))):Le.LoadFile(e.rootUrl+p.uri,_=>s(new Uint8Array(_)),void 0,void 0,!0,_=>{_&&n(_.status+" "+_.statusText)})}static CreateTextureAsync(e,i,s,n){const a=e.textures[i];if(a.babylonTexture){n(a.babylonTexture);return}const p=e.samplers[a.sampler],_=p.minFilter===Ao.NEAREST_MIPMAP_NEAREST||p.minFilter===Ao.NEAREST_MIPMAP_LINEAR||p.minFilter===Ao.LINEAR_MIPMAP_NEAREST||p.minFilter===Ao.LINEAR_MIPMAP_LINEAR,g=Oe.BILINEAR_SAMPLINGMODE,y=s==null?new Blob:new Blob([s]),b=URL.createObjectURL(y),v=()=>URL.revokeObjectURL(b),S=new Oe(b,e.scene,!_,!0,g,v,v);p.wrapS!==void 0&&(S.wrapU=fs.GetWrapMode(p.wrapS)),p.wrapT!==void 0&&(S.wrapV=fs.GetWrapMode(p.wrapT)),S.name=i,a.babylonTexture=S,n(S)}static LoadShaderStringAsync(e,i,s,n){const a=e.shaders[i];if(Le.IsBase64(a.uri)){const p=atob(a.uri.split(",")[1]);s&&s(p)}else Le.LoadFile(e.rootUrl+a.uri,s,void 0,void 0,!1,p=>{p&&n&&n(p.status+" "+p.statusText)})}static LoadMaterialAsync(e,i,s,n){const a=e.materials[i];if(!a.technique){n&&n("No technique found.");return}const p=e.techniques[a.technique];if(!p){e.scene._blockEntityCollection=!!e.assetContainer;const Y=new ot(i,e.scene);Y._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,Y.diffuseColor=new qe(.5,.5,.5),Y.sideOrientation=Be.CounterClockWiseSideOrientation,s(Y);return}const _=e.programs[p.program],g=p.states,y=ir.ShadersStore[_.vertexShader+"VertexShader"],b=ir.ShadersStore[_.fragmentShader+"PixelShader"];let v="",S="";const M=new oM(y),F=new oM(b),L={},N=[],k=[],G=[];for(const Y in p.uniforms){const Z=p.uniforms[Y],Q=p.parameters[Z];if(L[Y]=Q,Q.semantic&&!Q.node&&!Q.source){const se=xM.indexOf(Q.semantic);se!==-1?(N.push(lM[se]),delete L[Y]):N.push(Y)}else Q.type===Kn.SAMPLER_2D?G.push(Y):N.push(Y)}for(const Y in p.attributes){const Z=p.attributes[Y],Q=p.parameters[Z];if(Q.semantic){const se=cM(Q);se&&k.push(se)}}for(;!M.isEnd()&&M.getNextToken();){if(M.currentToken!==wx.IDENTIFIER){v+=M.currentString;continue}let Z=!1;for(const Q in p.attributes){const se=p.attributes[Q],$=p.parameters[se];if(M.currentIdentifier===Q&&$.semantic){v+=cM($),Z=!0;break}}Z||(v+=fM(M,p,L))}for(;!F.isEnd()&&F.getNextToken();){if(F.currentToken!==wx.IDENTIFIER){S+=F.currentString;continue}S+=fM(F,p,L)}const H={vertex:_.vertexShader+i,fragment:_.fragmentShader+i},z={attributes:k,uniforms:N,samplers:G,needAlphaBlending:g&&g.enable&&g.enable.indexOf(3042)!==-1};ir.ShadersStore[_.vertexShader+i+"VertexShader"]=v,ir.ShadersStore[_.fragmentShader+i+"PixelShader"]=S;const W=new Zo(i,e.scene,H,z);if(W.onError=gH(_,W,n),W.onCompiled=yH(e,W,p,a,L,s),W.sideOrientation=Be.CounterClockWiseSideOrientation,g&&g.functions){const Y=g.functions;Y.cullFace&&Y.cullFace[0]!==tg.BACK&&(W.backFaceCulling=!1);const Z=Y.blendFuncSeparate;Z&&(Z[0]===Vr.SRC_ALPHA&&Z[1]===Vr.ONE_MINUS_SRC_ALPHA&&Z[2]===Vr.ONE&&Z[3]===Vr.ONE?W.alphaMode=be.ALPHA_COMBINE:Z[0]===Vr.ONE&&Z[1]===Vr.ONE&&Z[2]===Vr.ZERO&&Z[3]===Vr.ONE?W.alphaMode=be.ALPHA_ONEONE:Z[0]===Vr.SRC_ALPHA&&Z[1]===Vr.ONE&&Z[2]===Vr.ZERO&&Z[3]===Vr.ONE?W.alphaMode=be.ALPHA_ADD:Z[0]===Vr.ZERO&&Z[1]===Vr.ONE_MINUS_SRC_COLOR&&Z[2]===Vr.ONE&&Z[3]===Vr.ONE?W.alphaMode=be.ALPHA_SUBTRACT:Z[0]===Vr.DST_COLOR&&Z[1]===Vr.ZERO&&Z[2]===Vr.ONE&&Z[3]===Vr.ONE?W.alphaMode=be.ALPHA_MULTIPLY:Z[0]===Vr.SRC_ALPHA&&Z[1]===Vr.ONE_MINUS_SRC_COLOR&&Z[2]===Vr.ONE&&Z[3]===Vr.ONE&&(W.alphaMode=be.ALPHA_MAXIMIZED))}}}class L0{static RegisterExtension(e){if(L0.Extensions[e.name]){Le.Error('Tool with the same name "'+e.name+'" already exists');return}L0.Extensions[e.name]=e}dispose(){}_importMeshAsync(e,i,s,n,a,p,_,g){return i.useRightHandedSystem=!0,Ws.LoadRuntimeAsync(i,s,n,y=>{y.assetContainer=a,y.importOnlyMeshes=!0,e===""?y.importMeshesNames=[]:typeof e=="string"?y.importMeshesNames=[e]:e&&!(e instanceof Array)?y.importMeshesNames=[e]:(y.importMeshesNames=[],Le.Warn("Argument meshesNames must be of type string or string[]")),this._createNodes(y);const b=new Array,v=new Array;for(const S in y.nodes){const M=y.nodes[S];M.babylonNode instanceof Ds&&b.push(M.babylonNode)}for(const S in y.skins){const M=y.skins[S];M.babylonSkeleton instanceof Gc&&v.push(M.babylonSkeleton)}this._loadBuffersAsync(y,()=>{this._loadShadersAsync(y,()=>{pM(y),dM(y),!Rr.IncrementalLoading&&p&&p(b,v)})}),Rr.IncrementalLoading&&p&&p(b,v)},g),!0}importMeshAsync(e,i,s,n,a,p){return new Promise((_,g)=>{this._importMeshAsync(e,i,n,a,s,(y,b)=>{_({meshes:y,particleSystems:[],skeletons:b,animationGroups:[],lights:[],transformNodes:[],geometries:[]})},p,y=>{g(new Error(y))})})}_loadAsync(e,i,s,n,a,p){e.useRightHandedSystem=!0,Ws.LoadRuntimeAsync(e,i,s,_=>{Ws.LoadRuntimeExtensionsAsync(_,()=>{this._createNodes(_),this._loadBuffersAsync(_,()=>{this._loadShadersAsync(_,()=>{pM(_),dM(_),Rr.IncrementalLoading||n()})}),Rr.IncrementalLoading&&n()},p)},p)}loadAsync(e,i,s,n){return new Promise((a,p)=>{this._loadAsync(e,i,s,()=>{a()},n,_=>{p(new Error(_))})})}_loadShadersAsync(e,i){let s=!1;const n=(a,p)=>{Ws.LoadShaderStringAsync(e,a,_=>{_ instanceof ArrayBuffer||(e.loadedShaderCount++,_&&(ir.ShadersStore[a+(p.type===eg.VERTEX?"VertexShader":"PixelShader")]=_),e.loadedShaderCount===e.shaderscount&&i())},()=>{Le.Error("Error when loading shader program named "+a+" located at "+p.uri)})};for(const a in e.shaders){s=!0;const p=e.shaders[a];p?n.bind(this,a,p)():Le.Error("No shader named: "+a)}s||i()}_loadBuffersAsync(e,i){let s=!1;const n=(a,p)=>{Ws.LoadBufferAsync(e,a,_=>{e.loadedBufferCount++,_&&(_.byteLength!=e.buffers[a].byteLength&&Le.Error("Buffer named "+a+" is length "+_.byteLength+". Expected: "+p.byteLength),e.loadedBufferViews[a]=_),e.loadedBufferCount===e.buffersCount&&i()},()=>{Le.Error("Error when loading buffer named "+a+" located at "+p.uri)})};for(const a in e.buffers){s=!0;const p=e.buffers[a];p?n.bind(this,a,p)():Le.Error("No buffer named: "+a)}s||i()}_createNodes(e){let i=e.currentScene;if(i)for(let s=0;s<i.nodes.length;s++)pu(e,i.nodes[s],null);else for(const s in e.scenes){i=e.scenes[s];for(let n=0;n<i.nodes.length;n++)pu(e,i.nodes[n],null)}}}L0.Extensions={};class Ws{constructor(e){this._name=e}get name(){return this._name}loadRuntimeAsync(e,i,s,n,a){return!1}loadRuntimeExtensionsAsync(e,i,s){return!1}loadBufferAsync(e,i,s,n,a){return!1}loadTextureBufferAsync(e,i,s,n){return!1}createTextureAsync(e,i,s,n,a){return!1}loadShaderStringAsync(e,i,s,n){return!1}loadMaterialAsync(e,i,s,n){return!1}static LoadRuntimeAsync(e,i,s,n,a){Ws._ApplyExtensions(p=>p.loadRuntimeAsync(e,i,s,n,a),()=>{setTimeout(()=>{!n||n(F0.CreateRuntime(i.json,e,s))})})}static LoadRuntimeExtensionsAsync(e,i,s){Ws._ApplyExtensions(n=>n.loadRuntimeExtensionsAsync(e,i,s),()=>{setTimeout(()=>{i()})})}static LoadBufferAsync(e,i,s,n,a){Ws._ApplyExtensions(p=>p.loadBufferAsync(e,i,s,n,a),()=>{F0.LoadBufferAsync(e,i,s,n,a)})}static LoadTextureAsync(e,i,s,n){Ws._LoadTextureBufferAsync(e,i,a=>{a&&Ws._CreateTextureAsync(e,i,a,s,n)},n)}static LoadShaderStringAsync(e,i,s,n){Ws._ApplyExtensions(a=>a.loadShaderStringAsync(e,i,s,n),()=>{F0.LoadShaderStringAsync(e,i,s,n)})}static LoadMaterialAsync(e,i,s,n){Ws._ApplyExtensions(a=>a.loadMaterialAsync(e,i,s,n),()=>{F0.LoadMaterialAsync(e,i,s,n)})}static _LoadTextureBufferAsync(e,i,s,n){Ws._ApplyExtensions(a=>a.loadTextureBufferAsync(e,i,s,n),()=>{F0.LoadTextureBufferAsync(e,i,s,n)})}static _CreateTextureAsync(e,i,s,n,a){Ws._ApplyExtensions(p=>p.createTextureAsync(e,i,s,n,a),()=>{F0.CreateTextureAsync(e,i,s,n)})}static _ApplyExtensions(e,i){for(const s in L0.Extensions){const n=L0.Extensions[s];if(e(n))return}i()}}Rr._CreateGLTF1Loader=()=>new L0;const bH="binary_glTF";class vH extends Ws{constructor(){super("KHR_binary_glTF")}loadRuntimeAsync(e,i,s,n){const a=i.json.extensionsUsed;return!a||a.indexOf(this.name)===-1||!i.bin?!1:(this._bin=i.bin,n(F0.CreateRuntime(i.json,e,s)),!0)}loadBufferAsync(e,i,s,n){return e.extensionsUsed.indexOf(this.name)===-1||i!==bH?!1:(this._bin.readAsync(0,this._bin.byteLength).then(s,a=>n(a.message)),!0)}loadTextureBufferAsync(e,i,s){const n=e.textures[i],a=e.images[n.source];if(!a.extensions||!(this.name in a.extensions))return!1;const p=a.extensions[this.name],_=e.bufferViews[p.bufferView],g=fs.GetBufferFromBufferView(e,_,0,_.byteLength,Ox.UNSIGNED_BYTE);return s(g),!0}loadShaderStringAsync(e,i,s){const n=e.shaders[i];if(!n.extensions||!(this.name in n.extensions))return!1;const a=n.extensions[this.name],p=e.bufferViews[a.bufferView],_=fs.GetBufferFromBufferView(e,p,0,p.byteLength,Ox.UNSIGNED_BYTE);return setTimeout(()=>{const g=fs.DecodeBufferToText(_);s(g)}),!0}}L0.RegisterExtension(new vH);class TH extends Ws{constructor(){super("KHR_materials_common")}loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;const i=e.extensions[this.name];if(!i)return!1;const s=i.lights;if(s)for(const n in s){const a=s[n];switch(a.type){case"ambient":{const p=new P0(a.name,new j(0,1,0),e.scene),_=a.ambient;_&&(p.diffuse=qe.FromArray(_.color||[1,1,1]));break}case"point":{const p=new Fc(a.name,new j(10,10,10),e.scene),_=a.point;_&&(p.diffuse=qe.FromArray(_.color||[1,1,1]));break}case"directional":{const p=new Ja(a.name,new j(0,-1,0),e.scene),_=a.directional;_&&(p.diffuse=qe.FromArray(_.color||[1,1,1]));break}case"spot":{const p=a.spot;if(p){const _=new jn(a.name,new j(0,10,0),new j(0,-1,0),p.fallOffAngle||Math.PI,p.fallOffExponent||0,e.scene);_.diffuse=qe.FromArray(p.color||[1,1,1])}break}default:Le.Warn('GLTF Material Common extension: light type "'+a.type+"\u201D not supported");break}}return!1}loadMaterialAsync(e,i,s,n){const a=e.materials[i];if(!a||!a.extensions)return!1;const p=a.extensions[this.name];if(!p)return!1;const _=new ot(i,e.scene);return _.sideOrientation=Be.CounterClockWiseSideOrientation,p.technique==="CONSTANT"&&(_.disableLighting=!0),_.backFaceCulling=p.doubleSided===void 0?!1:!p.doubleSided,_.alpha=p.values.transparency===void 0?1:p.values.transparency,_.specularPower=p.values.shininess===void 0?0:p.values.shininess,typeof p.values.ambient=="string"?this._loadTexture(e,p.values.ambient,_,"ambientTexture",n):_.ambientColor=qe.FromArray(p.values.ambient||[0,0,0]),typeof p.values.diffuse=="string"?this._loadTexture(e,p.values.diffuse,_,"diffuseTexture",n):_.diffuseColor=qe.FromArray(p.values.diffuse||[0,0,0]),typeof p.values.emission=="string"?this._loadTexture(e,p.values.emission,_,"emissiveTexture",n):_.emissiveColor=qe.FromArray(p.values.emission||[0,0,0]),typeof p.values.specular=="string"?this._loadTexture(e,p.values.specular,_,"specularTexture",n):_.specularColor=qe.FromArray(p.values.specular||[0,0,0]),!0}_loadTexture(e,i,s,n,a){F0.LoadTextureBufferAsync(e,i,p=>{F0.CreateTextureAsync(e,i,p,_=>s[n]=_)},a)}}L0.RegisterExtension(new TH);class mu{get resolve(){return this._resolve}get reject(){return this._reject}constructor(){this.promise=new Promise((e,i)=>{this._resolve=e,this._reject=i})}}class EH{getClassName(){return"TargetedAnimation"}serialize(){const e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}}class $2{get from(){return this._from}get to(){return this._to}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let i=0;i<this._animatables.length;i++){const s=this._animatables[i];s.speedRatio=this._speedRatio}}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let i=0;i<this._animatables.length;i++){const s=this._animatables[i];s.loopAnimation=this._loopAnimation}}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let i=0;i<this._animatables.length;i++){const s=this._animatables[i];s.isAdditive=this._isAdditive}}}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}constructor(e,i=null){this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._parentContainer=null,this.onAnimationEndObservable=new Re,this.onAnimationLoopObservable=new Re,this.onAnimationGroupLoopObservable=new Re,this.onAnimationGroupEndObservable=new Re,this.onAnimationGroupPauseObservable=new Re,this.onAnimationGroupPlayObservable=new Re,this.metadata=null,this._animationLoopFlags=[],this._scene=i||Zt.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}addTargetedAnimation(e,i){const s=new EH;s.animation=e,s.target=i;const n=e.getKeys();return this._from>n[0].frame&&(this._from=n[0].frame),this._to<n[n.length-1].frame&&(this._to=n[n.length-1].frame),this._targetedAnimations.push(s),s}normalize(e=null,i=null){e==null&&(e=this._from),i==null&&(i=this._to);for(let s=0;s<this._targetedAnimations.length;s++){const a=this._targetedAnimations[s].animation.getKeys(),p=a[0],_=a[a.length-1];if(p.frame>e){const g={frame:e,value:p.value,inTangent:p.inTangent,outTangent:p.outTangent,interpolation:p.interpolation};a.splice(0,0,g)}if(_.frame<i){const g={frame:i,value:_.value,inTangent:_.inTangent,outTangent:_.outTangent,interpolation:_.interpolation};a.push(g)}}return this._from=e,this._to=i,this}_processLoop(e,i,s){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(i),!this._animationLoopFlags[s]&&(this._animationLoopFlags[s]=!0,this._animationLoopCount++,this._animationLoopCount===this._targetedAnimations.length&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,i=1,s,n,a){if(this._isStarted||this._targetedAnimations.length===0)return this;this._loopAnimation=e,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let p=0;p<this._targetedAnimations.length;p++){const _=this._targetedAnimations[p],g=this._scene.beginDirectAnimation(_.target,[_.animation],s!==void 0?s:this._from,n!==void 0?n:this._to,e,i,void 0,void 0,a!==void 0?a:this._isAdditive);g.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(_),this._checkAnimationGroupEnded(g)},this._processLoop(g,_,p),this._animatables.push(g)}return this._speedRatio=i,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length===this._targetedAnimations.length?(e!==void 0&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this._isPaused=!1,this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(){if(!this._isStarted)return this;const e=this._animatables.slice();for(let s=0;s<e.length;s++)e[s].stop(void 0,void 0,!0);let i=0;for(let s=0;s<this._scene._activeAnimatables.length;s++){const n=this._scene._activeAnimatables[s];n._runtimeAnimations.length>0&&(this._scene._activeAnimatables[i++]=n)}return this._scene._activeAnimatables.length=i,this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let i=0;i<this._animatables.length;i++){const s=this._animatables[i];s.weight=e}return this}syncAllAnimationsWith(e){for(let i=0;i<this._animatables.length;i++)this._animatables[i].syncWith(e);return this}goToFrame(e){if(!this._isStarted)return this;for(let i=0;i<this._animatables.length;i++)this._animatables[i].goToFrame(e);return this}dispose(){this._targetedAnimations.length=0,this._animatables.length=0;const e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){const i=this._parentContainer.animationGroups.indexOf(this);i>-1&&this._parentContainer.animationGroups.splice(i,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e){const i=this._animatables.indexOf(e);i>-1&&this._animatables.splice(i,1),this._animatables.length===0&&(this._isStarted=!1,this.onAnimationGroupEndObservable.notifyObservers(this))}clone(e,i,s=!1){const n=new $2(e||this.name,this._scene);for(const a of this._targetedAnimations)n.addTargetedAnimation(s?a.animation.clone():a.animation,i?i(a.target):a.target);return n}serialize(){const e={};e.name=this.name,e.from=this.from,e.to=this.to,e.targetedAnimations=[];for(let i=0;i<this.targetedAnimations.length;i++){const s=this.targetedAnimations[i];e.targetedAnimations[i]=s.serialize()}return Bi&&Bi.HasTags(this)&&(e.tags=Bi.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,i){const s=new $2(e.name,i);for(let n=0;n<e.targetedAnimations.length;n++){const a=e.targetedAnimations[n],p=Ce.Parse(a.animation),_=a.targetId;if(a.animation.property==="influence"){const g=i.getMorphTargetById(_);g&&s.addTargetedAnimation(p,g)}else{const g=i.getNodeById(_);g!=null&&s.addTargetedAnimation(p,g)}}return e.from!==null&&e.to!==null&&s.normalize(e.from,e.to),Bi&&Bi.AddTagsTo(s,e.tags),e.metadata!==void 0&&(s.metadata=e.metadata),s}static MakeAnimationAdditive(e,i=0,s,n=!1,a){let p=e;n&&(p=e.clone(a||p.name));const _=p.targetedAnimations;for(let g=0;g<_.length;g++){const y=_[g];Ce.MakeAnimationAdditive(y.animation,i,s)}return p.isAdditive=!0,p}getClassName(){return"AnimationGroup"}toString(e){let i="Name: "+this.name;return i+=", type: "+this.getClassName(),e&&(i+=", from: "+this._from,i+=", to: "+this._to,i+=", isStarted: "+this._isStarted,i+=", speedRatio: "+this._speedRatio,i+=", targetedAnimations length: "+this._targetedAnimations.length,i+=", animatables length: "+this._animatables),i}}class Cl{get influence(){return this._influence}set influence(e){if(this._influence===e)return;const i=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(i===0||e===0)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,i=0,s=null){this.name=e,this.animations=new Array,this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new Re,this._onDataLayoutChanged=new Re,this._animationPropertiesOverride=null,this._scene=s||Zt.LastCreatedScene,this.influence=i,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}setPositions(e){const i=this.hasPositions;this._positions=e,i!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){const i=this.hasNormals;this._normals=e,i!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){const i=this.hasTangents;this._tangents=e,i!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){const i=this.hasUVs;this._uvs=e,i!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}clone(){const e=Kt.Clone(()=>new Cl(this.name,this.influence,this._scene),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e}serialize(){const e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),this.id!=null&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),Kt.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,i){const s=new Cl(e.name,e.influence);if(s.setPositions(e.positions),e.id!=null&&(s.id=e.id),e.normals&&s.setNormals(e.normals),e.tangents&&s.setTangents(e.tangents),e.uvs&&s.setUVs(e.uvs),e.animations){for(let n=0;n<e.animations.length;n++){const a=e.animations[n],p=Ka("BABYLON.Animation");p&&s.animations.push(p.Parse(a))}e.autoAnimate&&i&&i.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return s}static FromMesh(e,i,s){i||(i=e.name);const n=new Cl(i,s,e.getScene());return n.setPositions(e.getVerticesData(te.PositionKind)),e.isVerticesDataPresent(te.NormalKind)&&n.setNormals(e.getVerticesData(te.NormalKind)),e.isVerticesDataPresent(te.TangentKind)&&n.setTangents(e.getVerticesData(te.TangentKind)),e.isVerticesDataPresent(te.UVKind)&&n.setUVs(e.getVerticesData(te.UVKind)),n}}J([xe()],Cl.prototype,"id",void 0);class ng extends Oe{get depth(){return this._depth}constructor(e,i,s,n,a,p,_=!0,g=!1,y=Oe.TRILINEAR_SAMPLINGMODE,b=0){super(null,p,!_,g),this.format=a,this._texture=p.getEngine().createRawTexture2DArray(e,i,s,n,a,_,g,y,null,b),this._depth=n,this.is2DArray=!0}update(e){!this._texture||this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,i,s,n,a,p=!0,_=!1,g=3,y=0){return new ng(e,i,s,n,5,a,p,_,g,y)}}class Dx{set areUpdatesFrozen(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(!0)))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(e=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new Ps(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._parentContainer=null,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._useTextureToStoreTargets=!0,e||(e=Zt.LastCreatedScene),this._scene=e,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();const i=this._scene.getEngine().getCaps();this._canUseTextureForTargets=i.canUseGLVertexID&&i.textureFloat&&i.maxVertexTextureImageUnits>0&&i.texture2DArrayMaxLayerCount>1}}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(e){this._useTextureToStoreTargets=e}get isUsingTextureForTargets(){var e;return Dx.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!(!((e=this._scene)===null||e===void 0)&&e.getEngine().getCaps().disableMorphTargetTexture)}getActiveTarget(e){return this._activeTargets.data[e]}getTarget(e){return this._targets[e]}addTarget(e){this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add(i=>{this._syncActiveTargets(i)})),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add(()=>{this._syncActiveTargets(!0)})),this._syncActiveTargets(!0)}removeTarget(e){const i=this._targets.indexOf(e);i>=0&&(this._targets.splice(i,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(i,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(i,1)[0]),this._syncActiveTargets(!0)),this._scene&&this._scene.stopAnimation(e)}_bind(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture)}clone(){const e=new Dx(this._scene);for(const i of this._targets)e.addTarget(i.clone());return e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e}serialize(){const e={};e.id=this.uniqueId,e.targets=[];for(const i of this._targets)e.targets.push(i.serialize());return e}_syncActiveTargets(e){if(this.areUpdatesFrozen)return;let i=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,this._scene&&this._targets.length>this._scene.getEngine().getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1),(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let s=-1;for(const n of this._targets){if(s++,n.influence===0&&this.optimizeInfluencers)continue;if(this._activeTargets.length>=Dx.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(n),this._morphTargetTextureIndices[i]=s,this._tempInfluences[i++]=n.influence,this._supportsNormals=this._supportsNormals&&n.hasNormals,this._supportsTangents=this._supportsTangents&&n.hasTangents,this._supportsUVs=this._supportsUVs&&n.hasUVs;const a=n.getPositions();if(a){const p=a.length/3;if(this._vertexCount===0)this._vertexCount=p;else if(this._vertexCount!==p){Ie.Error("Incompatible target. Targets must all have the same vertices count.");return}}}(!this._influences||this._influences.length!==i)&&(this._influences=new Float32Array(i));for(let n=0;n<i;n++)this._influences[n]=this._tempInfluences[n];e&&this.synchronize()}synchronize(){if(!(!this._scene||this.areUpdatesFrozen)){if(this.isUsingTextureForTargets&&this._vertexCount){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride,this._textureHeight=1;const e=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>e&&(this._textureHeight=Math.ceil(this._textureWidth/e),this._textureWidth=e);let i=!0;if(this._targetStoreTexture){const s=this._targetStoreTexture.getSize();s.width===this._textureWidth&&s.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(i=!1)}if(i){this._targetStoreTexture&&this._targetStoreTexture.dispose();const s=this._targets.length,n=new Float32Array(s*this._textureWidth*this._textureHeight*4);let a=0;for(let p=0;p<s;p++){const _=this._targets[p],g=_.getPositions(),y=_.getNormals(),b=_.getUVs(),v=_.getTangents();if(!g){p===0&&Ie.Error("Invalid morph target. Target must have positions.");return}a=p*this._textureWidth*this._textureHeight*4;for(let S=0;S<this._vertexCount;S++)n[a]=g[S*3],n[a+1]=g[S*3+1],n[a+2]=g[S*3+2],a+=4,y&&(n[a]=y[S*3],n[a+1]=y[S*3+1],n[a+2]=y[S*3+2],a+=4),b&&(n[a]=b[S*2],n[a+1]=b[S*2+1],a+=4),v&&(n[a]=v[S*3],n[a+1]=v[S*3+1],n[a+2]=v[S*3+2],a+=4)}this._targetStoreTexture=ng.CreateRGBATexture(n,this._textureWidth,this._textureHeight,s,this._scene,!1,!1,1,1)}}for(const e of this._scene.meshes)e.morphTargetManager===this&&e._syncGeometryWithMorphTargetManager()}}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){const e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}for(const e of this._targets)this._scene.stopAnimation(e)}}static Parse(e,i){const s=new Dx(i);s._uniqueId=e.id;for(const n of e.targets)s.addTarget(Cl.Parse(n,i));return s}}Dx.EnableTextureStorage=!0,Dx.MaxActiveMorphTargetsInVertexAttributeMode=8;function mM(l,e,i,s){return j.FromArray(e,i).scaleInPlace(s)}function AH(l,e,i,s){return Ve.FromArray(e,i).scaleInPlace(s)}function CH(l,e,i,s){const n=new Array(l._numMorphTargets);for(let a=0;a<n.length;a++)n[a]=e[i++]*s;return n}class _u{constructor(e,i,s,n){this.type=e,this.name=i,this.getValue=s,this.getStride=n}_buildAnimation(e,i,s){const n=new Ce(e,this.name,i,this.type);return n.setKeys(s),n}}class ag extends _u{buildAnimations(e,i,s,n,a){a(e._babylonTransformNode,this._buildAnimation(i,s,n))}}class RH extends _u{buildAnimations(e,i,s,n,a){if(e._numMorphTargets)for(let p=0;p<e._numMorphTargets;p++){const _=new Ce(`${i}_${p}`,this.name,s,this.type);if(_.setKeys(n.map(g=>({frame:g.frame,inTangent:g.inTangent?g.inTangent[p]:void 0,value:g.value[p],outTangent:g.outTangent?g.outTangent[p]:void 0,interpolation:g.interpolation}))),e._primitiveBabylonMeshes){for(const g of e._primitiveBabylonMeshes)if(g.morphTargetManager){const y=g.morphTargetManager.getTarget(p),b=_.clone();y.animations.push(b),a(y,b)}}}}}const gu={translation:[new ag(Ce.ANIMATIONTYPE_VECTOR3,"position",mM,()=>3)],rotation:[new ag(Ce.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",AH,()=>4)],scale:[new ag(Ce.ANIMATIONTYPE_VECTOR3,"scaling",mM,()=>3)],weights:[new RH(Ce.ANIMATIONTYPE_FLOAT,"influence",CH,l=>l._numMorphTargets)]};function _M(...l){const e=i=>i&&typeof i=="object";return l.reduce((i,s)=>(Object.keys(s).forEach(n=>{const a=i[n],p=s[n];Array.isArray(a)&&Array.isArray(p)?i[n]=a.concat(...p):e(a)&&e(p)?i[n]=_M(a,p):i[n]=p}),i),{})}class $t{static Get(e,i,s){if(!i||s==null||!i[s])throw new Error(`${e}: Failed to find index (${s})`);return i[s]}static Assign(e){if(e)for(let i=0;i<e.length;i++)e[i].index=i}}class Pt{static RegisterExtension(e,i){Pt.UnregisterExtension(e)&&Ie.Warn(`Extension with the name '${e}' already exists`),Pt._RegisteredExtensions[e]={factory:i}}static UnregisterExtension(e){return Pt._RegisteredExtensions[e]?(delete Pt._RegisteredExtensions[e],!0):!1}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=e}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(e=>e.dispose&&e.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}importMeshAsync(e,i,s,n,a,p,_=""){return Promise.resolve().then(()=>{this._babylonScene=i,this._assetContainer=s,this._loadData(n);let g=null;if(e){const y={};if(this._gltf.nodes)for(const v of this._gltf.nodes)v.name&&(y[v.name]=v.index);g=(e instanceof Array?e:[e]).map(v=>{const S=y[v];if(S===void 0)throw new Error(`Failed to find node '${v}'`);return S})}return this._loadAsync(a,_,g,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries()}))})}loadAsync(e,i,s,n,a=""){return Promise.resolve().then(()=>(this._babylonScene=e,this._loadData(i),this._loadAsync(s,a,null,()=>{})))}_loadAsync(e,i,s,n){return Promise.resolve().then(()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&i?e:`${e}${Date.now()}/`,this._fileName=i,this._loadExtensions(),this._checkExtensions();const a=`${ha[ha.LOADING]} => ${ha[ha.READY]}`,p=`${ha[ha.LOADING]} => ${ha[ha.COMPLETE]}`;this._parent._startPerformanceCounter(a),this._parent._startPerformanceCounter(p),this._parent._setState(ha.LOADING),this._extensionsOnLoading();const _=new Array,g=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials){if(s)_.push(this.loadSceneAsync("/nodes",{nodes:s,index:-1}));else if(this._gltf.scene!=null||this._gltf.scenes&&this._gltf.scenes[0]){const b=$t.Get("/scene",this._gltf.scenes,this._gltf.scene||0);_.push(this.loadSceneAsync(`/scenes/${b.index}`,b))}}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let b=0;b<this._gltf.materials.length;++b){const v=this._gltf.materials[b],S="/materials/"+b,M=Be.TriangleFillMode;_.push(this._loadMaterialAsync(S,v,null,M,()=>{}))}return this._babylonScene.blockMaterialDirtyMechanism=g,this._parent.compileMaterials&&_.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&_.push(this._compileShadowGeneratorsAsync()),Promise.all(_).then(()=>(this._rootBabylonMesh&&this._rootBabylonMesh.setEnabled(!0),this._extensionsOnReady(),this._parent._setState(ha.READY),this._startAnimations(),n())).then(b=>(this._parent._endPerformanceCounter(a),Le.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(p),this._parent._setState(ha.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},v=>{this._parent.onErrorObservable.notifyObservers(v),this._parent.onErrorObservable.clear(),this.dispose()})}),b))}).catch(a=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(a),this._parent.onErrorObservable.clear(),this.dispose()),a})}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){const i=this._gltf.buffers;if(i&&i[0]&&!i[0].uri){const s=i[0];(s.byteLength<e.bin.byteLength-3||s.byteLength>e.bin.byteLength)&&Ie.Warn(`Binary buffer length (${s.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else Ie.Warn("Unexpected BIN chunk")}}_setupData(){if($t.Assign(this._gltf.accessors),$t.Assign(this._gltf.animations),$t.Assign(this._gltf.buffers),$t.Assign(this._gltf.bufferViews),$t.Assign(this._gltf.cameras),$t.Assign(this._gltf.images),$t.Assign(this._gltf.materials),$t.Assign(this._gltf.meshes),$t.Assign(this._gltf.nodes),$t.Assign(this._gltf.samplers),$t.Assign(this._gltf.scenes),$t.Assign(this._gltf.skins),$t.Assign(this._gltf.textures),this._gltf.nodes){const e={};for(const s of this._gltf.nodes)if(s.children)for(const n of s.children)e[n]=s.index;const i=this._createRootNode();for(const s of this._gltf.nodes){const n=e[s.index];s.parent=n===void 0?i:this._gltf.nodes[n]}}}_loadExtensions(){for(const e in Pt._RegisteredExtensions){const i=Pt._RegisteredExtensions[e].factory(this);i.name!==e&&Ie.Warn(`The name of the glTF loader extension instance does not match the registered name: ${i.name} !== ${e}`),this._extensions.push(i),this._parent.onExtensionLoadedObservable.notifyObservers(i)}this._extensions.sort((e,i)=>(e.order||Number.MAX_VALUE)-(i.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear()}_checkExtensions(){if(this._gltf.extensionsRequired){for(const e of this._gltf.extensionsRequired)if(!this._extensions.some(s=>s.name===e&&s.enabled))throw new Error(`Require extension ${e} is not available`)}}_createRootNode(){this._babylonScene._blockEntityCollection=!!this._assetContainer,this._rootBabylonMesh=new Qe("__root__",this._babylonScene),this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);const e={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case du.AUTO:{this._babylonScene.useRightHandedSystem||(e.rotation=[0,1,0,0],e.scale=[1,1,-1],Pt._LoadTransform(e,this._rootBabylonMesh));break}case du.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),e}loadSceneAsync(e,i){const s=this._extensionsLoadSceneAsync(e,i);if(s)return s;const n=new Array;if(this.logOpen(`${e} ${i.name||""}`),i.nodes)for(const a of i.nodes){const p=$t.Get(`${e}/nodes/${a}`,this._gltf.nodes,a);n.push(this.loadNodeAsync(`/nodes/${p.index}`,p,_=>{_.parent=this._rootBabylonMesh}))}for(const a of this._postSceneLoadActions)a();return n.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(n).then(()=>{})}_forEachPrimitive(e,i){if(e._primitiveBabylonMeshes)for(const s of e._primitiveBabylonMeshes)i(s)}_getGeometries(){const e=new Array,i=this._gltf.nodes;if(i)for(const s of i)this._forEachPrimitive(s,n=>{const a=n.geometry;a&&e.indexOf(a)===-1&&e.push(a)});return e}_getMeshes(){const e=new Array;this._rootBabylonMesh&&e.push(this._rootBabylonMesh);const i=this._gltf.nodes;if(i)for(const s of i)this._forEachPrimitive(s,n=>{e.push(n)});return e}_getTransformNodes(){const e=new Array,i=this._gltf.nodes;if(i)for(const s of i)s._babylonTransformNode&&s._babylonTransformNode.getClassName()==="TransformNode"&&e.push(s._babylonTransformNode),s._babylonTransformNodeForSkin&&e.push(s._babylonTransformNodeForSkin);return e}_getSkeletons(){const e=new Array,i=this._gltf.skins;if(i)for(const s of i)s._data&&e.push(s._data.babylonSkeleton);return e}_getAnimationGroups(){const e=new Array,i=this._gltf.animations;if(i)for(const s of i)s._babylonAnimationGroup&&e.push(s._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case Vc.NONE:break;case Vc.FIRST:{const e=this._getAnimationGroups();e.length!==0&&e[0].start(!0);break}case Vc.ALL:{const e=this._getAnimationGroups();for(const i of e)i.start(!0);break}default:{Ie.Error(`Invalid animation start mode (${this._parent.animationStartMode})`);return}}}loadNodeAsync(e,i,s=()=>{}){const n=this._extensionsLoadNodeAsync(e,i,s);if(n)return n;if(i._babylonTransformNode)throw new Error(`${e}: Invalid recursive node hierarchy`);const a=new Array;this.logOpen(`${e} ${i.name||""}`);const p=_=>{if(Pt.AddPointerMetadata(_,e),Pt._LoadTransform(i,_),i.camera!=null){const g=$t.Get(`${e}/camera`,this._gltf.cameras,i.camera);a.push(this.loadCameraAsync(`/cameras/${g.index}`,g,y=>{y.parent=_}))}if(i.children)for(const g of i.children){const y=$t.Get(`${e}/children/${g}`,this._gltf.nodes,g);a.push(this.loadNodeAsync(`/nodes/${y.index}`,y,b=>{b.parent=_}))}s(_)};if(i.mesh==null||i.skin!=null){const _=i.name||`node${i.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const g=new Jt(_,this._babylonScene);g._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i.mesh==null?i._babylonTransformNode=g:i._babylonTransformNodeForSkin=g,p(g)}if(i.mesh!=null)if(i.skin==null){const _=$t.Get(`${e}/mesh`,this._gltf.meshes,i.mesh);a.push(this._loadMeshAsync(`/meshes/${_.index}`,i,_,p))}else{const _=$t.Get(`${e}/mesh`,this._gltf.meshes,i.mesh);a.push(this._loadMeshAsync(`/meshes/${_.index}`,i,_,g=>{const y=i._babylonTransformNodeForSkin;g.metadata=_M(y.metadata,g.metadata||{});const b=$t.Get(`${e}/skin`,this._gltf.skins,i.skin);a.push(this._loadSkinAsync(`/skins/${b.index}`,i,b,v=>{this._forEachPrimitive(i,S=>{S.skeleton=v}),this._postSceneLoadActions.push(()=>{if(b.skeleton!=null){const S=$t.Get(`/skins/${b.index}/skeleton`,this._gltf.nodes,b.skeleton).parent;i.index===S.index?g.parent=y.parent:g.parent=S._babylonTransformNode}else g.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:y,skinnedNode:g})})}))}))}return this.logClose(),Promise.all(a).then(()=>(this._forEachPrimitive(i,_=>{_.geometry&&_.geometry.useBoundingInfoFromGeometry?_._updateBoundingInfo():_.refreshBoundingInfo(!0)}),i._babylonTransformNode))}_loadMeshAsync(e,i,s,n){const a=s.primitives;if(!a||!a.length)throw new Error(`${e}: Primitives are missing`);a[0].index==null&&$t.Assign(a);const p=new Array;this.logOpen(`${e} ${s.name||""}`);const _=i.name||`node${i.index}`;if(a.length===1){const g=s.primitives[0];p.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${g.index}`,_,i,s,g,y=>{i._babylonTransformNode=y,i._primitiveBabylonMeshes=[y]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,i._babylonTransformNode=new Jt(_,this._babylonScene),i._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i._primitiveBabylonMeshes=[];for(const g of a)p.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${g.index}`,`${_}_primitive${g.index}`,i,s,g,y=>{y.parent=i._babylonTransformNode,i._primitiveBabylonMeshes.push(y)}))}return n(i._babylonTransformNode),this.logClose(),Promise.all(p).then(()=>i._babylonTransformNode)}_loadMeshPrimitiveAsync(e,i,s,n,a,p){const _=this._extensionsLoadMeshPrimitiveAsync(e,i,s,n,a,p);if(_)return _;this.logOpen(`${e}`);const g=this._disableInstancedMesh===0&&this._parent.createInstances&&s.skin==null&&!n.primitives[0].targets;let y,b;if(g&&a._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,y=a._instanceData.babylonSourceMesh.createInstance(i),y._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,b=a._instanceData.promise;else{const v=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const S=new Qe(i,this._babylonScene);S._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,S.overrideMaterialSideOrientation=this._babylonScene.useRightHandedSystem?Be.CounterClockWiseSideOrientation:Be.ClockWiseSideOrientation,this._createMorphTargets(e,s,n,a,S),v.push(this._loadVertexDataAsync(e,a,S).then(F=>this._loadMorphTargetsAsync(e,a,S,F).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,F.applyToMesh(S),F._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})));const M=Pt._GetDrawMode(e,a.mode);if(a.material==null){let F=this._defaultBabylonMaterialData[M];F||(F=this._createDefaultMaterial("__GLTFLoader._default",M),this._parent.onMaterialLoadedObservable.notifyObservers(F),this._defaultBabylonMaterialData[M]=F),S.material=F}else if(!this.parent.skipMaterials){const F=$t.Get(`${e}/material`,this._gltf.materials,a.material);v.push(this._loadMaterialAsync(`/materials/${F.index}`,F,S,M,L=>{S.material=L}))}b=Promise.all(v),g&&(a._instanceData={babylonSourceMesh:S,promise:b}),y=S}return Pt.AddPointerMetadata(y,e),this._parent.onMeshLoadedObservable.notifyObservers(y),p(y),this.logClose(),b.then(()=>y)}_loadVertexDataAsync(e,i,s){const n=this._extensionsLoadVertexDataAsync(e,i,s);if(n)return n;const a=i.attributes;if(!a)throw new Error(`${e}: Attributes are missing`);const p=new Array,_=new cn(s.name,this._babylonScene);if(i.indices==null)s.isUnIndexed=!0;else{const y=$t.Get(`${e}/indices`,this._gltf.accessors,i.indices);p.push(this._loadIndicesAccessorAsync(`/accessors/${y.index}`,y).then(b=>{_.setIndices(b)}))}const g=(y,b,v)=>{if(a[y]==null)return;s._delayInfo=s._delayInfo||[],s._delayInfo.indexOf(b)===-1&&s._delayInfo.push(b);const S=$t.Get(`${e}/attributes/${y}`,this._gltf.accessors,a[y]);p.push(this._loadVertexAccessorAsync(`/accessors/${S.index}`,S,b).then(M=>{if(M.getKind()===te.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!s.skeleton&&S.min&&S.max){const F=ge.Vector3[0].copyFromFloats(...S.min),L=ge.Vector3[1].copyFromFloats(...S.max);if(S.normalized&&S.componentType!==5126){let N=1;switch(S.componentType){case 5120:N=127;break;case 5121:N=255;break;case 5122:N=32767;break;case 5123:N=65535;break}const k=1/N;F.scaleInPlace(k),L.scaleInPlace(k)}_._boundingInfo=new la(F,L),_.useBoundingInfoFromGeometry=!0}_.setVerticesBuffer(M,S.count)})),b==te.MatricesIndicesExtraKind&&(s.numBoneInfluencers=8),v&&v(S)};return g("POSITION",te.PositionKind),g("NORMAL",te.NormalKind),g("TANGENT",te.TangentKind),g("TEXCOORD_0",te.UVKind),g("TEXCOORD_1",te.UV2Kind),g("TEXCOORD_2",te.UV3Kind),g("TEXCOORD_3",te.UV4Kind),g("TEXCOORD_4",te.UV5Kind),g("TEXCOORD_5",te.UV6Kind),g("JOINTS_0",te.MatricesIndicesKind),g("WEIGHTS_0",te.MatricesWeightsKind),g("JOINTS_1",te.MatricesIndicesExtraKind),g("WEIGHTS_1",te.MatricesWeightsExtraKind),g("COLOR_0",te.ColorKind,y=>{y.type==="VEC4"&&(s.hasVertexAlpha=!0)}),Promise.all(p).then(()=>_)}_createMorphTargets(e,i,s,n,a){if(!n.targets)return;if(i._numMorphTargets==null)i._numMorphTargets=n.targets.length;else if(n.targets.length!==i._numMorphTargets)throw new Error(`${e}: Primitives do not have the same number of targets`);const p=s.extras?s.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,a.morphTargetManager=new Dx(this._babylonScene),a.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,a.morphTargetManager.areUpdatesFrozen=!0;for(let _=0;_<n.targets.length;_++){const g=i.weights?i.weights[_]:s.weights?s.weights[_]:0,y=p?p[_]:`morphTarget${_}`;a.morphTargetManager.addTarget(new Cl(y,g,a.getScene()))}}_loadMorphTargetsAsync(e,i,s,n){if(!i.targets)return Promise.resolve();const a=new Array,p=s.morphTargetManager;for(let _=0;_<p.numTargets;_++){const g=p.getTarget(_);a.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${_}`,n,i.targets[_],g))}return Promise.all(a).then(()=>{p.areUpdatesFrozen=!1})}_loadMorphTargetVertexDataAsync(e,i,s,n){const a=new Array,p=(_,g,y)=>{if(s[_]==null)return;const b=i.getVertexBuffer(g);if(!b)return;const v=$t.Get(`${e}/${_}`,this._gltf.accessors,s[_]);a.push(this._loadFloatAccessorAsync(`/accessors/${v.index}`,v).then(S=>{y(b,S)}))};return p("POSITION",te.PositionKind,(_,g)=>{const y=new Float32Array(g.length);_.forEach(g.length,(b,v)=>{y[v]=g[v]+b}),n.setPositions(y)}),p("NORMAL",te.NormalKind,(_,g)=>{const y=new Float32Array(g.length);_.forEach(y.length,(b,v)=>{y[v]=g[v]+b}),n.setNormals(y)}),p("TANGENT",te.TangentKind,(_,g)=>{const y=new Float32Array(g.length/3*4);let b=0;_.forEach(g.length/3*4,(v,S)=>{(S+1)%4!==0&&(y[b]=g[b]+v,b++)}),n.setTangents(y)}),Promise.all(a).then(()=>{})}static _LoadTransform(e,i){if(e.skin!=null)return;let s=j.Zero(),n=Ve.Identity(),a=j.One();e.matrix?fe.FromArray(e.matrix).decompose(a,n,s):(e.translation&&(s=j.FromArray(e.translation)),e.rotation&&(n=Ve.FromArray(e.rotation)),e.scale&&(a=j.FromArray(e.scale))),i.position=s,i.rotationQuaternion=n,i.scaling=a}_loadSkinAsync(e,i,s,n){const a=this._extensionsLoadSkinAsync(e,i,s);if(a)return a;if(s._data)return n(s._data.babylonSkeleton),s._data.promise;const p=`skeleton${s.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const _=new Gc(s.name||p,p,this._babylonScene);_._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,s,_);const g=this._loadSkinInverseBindMatricesDataAsync(e,s).then(y=>{this._updateBoneMatrices(_,y)});return s._data={babylonSkeleton:_,promise:g},n(_),g}_loadBones(e,i,s){if(i.skeleton==null||this._parent.alwaysComputeSkeletonRootNode){const a=this._findSkeletonRootNode(`${e}/joints`,i.joints);if(a)if(i.skeleton===void 0)i.skeleton=a.index;else{const p=(g,y)=>{for(;y.parent;y=y.parent)if(y.parent===g)return!0;return!1},_=$t.Get(`${e}/skeleton`,this._gltf.nodes,i.skeleton);_!==a&&!p(_,a)&&(Ie.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),i.skeleton=a.index)}else Ie.Warn(`${e}: Failed to find common root`)}const n={};for(const a of i.joints){const p=$t.Get(`${e}/joints/${a}`,this._gltf.nodes,a);this._loadBone(p,i,s,n)}}_findSkeletonRootNode(e,i){if(i.length===0)return null;const s={};for(const a of i){const p=new Array;let _=$t.Get(`${e}/${a}`,this._gltf.nodes,a);for(;_.index!==-1;)p.unshift(_),_=_.parent;s[a]=p}let n=null;for(let a=0;;++a){let p=s[i[0]];if(a>=p.length)return n;const _=p[a];for(let g=1;g<i.length;++g)if(p=s[i[g]],a>=p.length||_!==p[a])return n;n=_}}_loadBone(e,i,s,n){let a=n[e.index];if(a)return a;let p=null;e.index!==i.skeleton&&(e.parent&&e.parent.index!==-1?p=this._loadBone(e.parent,i,s,n):i.skeleton!==void 0&&Ie.Warn(`/skins/${i.index}/skeleton: Skeleton node is not a common root`));const _=i.joints.indexOf(e.index);return a=new $i(e.name||`joint${e.index}`,s,p,this._getNodeMatrix(e),null,null,_),n[e.index]=a,this._postSceneLoadActions.push(()=>{a.linkTransformNode(e._babylonTransformNode)}),a}_loadSkinInverseBindMatricesDataAsync(e,i){if(i.inverseBindMatrices==null)return Promise.resolve(null);const s=$t.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,i.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${s.index}`,s)}_updateBoneMatrices(e,i){for(const s of e.bones){const n=fe.Identity(),a=s._index;i&&a!==-1&&(fe.FromArrayToRef(i,a*16,n),n.invertToRef(n));const p=s.getParent();p&&n.multiplyToRef(p.getInvertedAbsoluteTransform(),n),s.updateMatrix(n,!1,!1),s._updateDifferenceMatrix(void 0,!1)}}_getNodeMatrix(e){return e.matrix?fe.FromArray(e.matrix):fe.Compose(e.scale?j.FromArray(e.scale):j.One(),e.rotation?Ve.FromArray(e.rotation):Ve.Identity(),e.translation?j.FromArray(e.translation):j.Zero())}loadCameraAsync(e,i,s=()=>{}){const n=this._extensionsLoadCameraAsync(e,i,s);if(n)return n;const a=new Array;this.logOpen(`${e} ${i.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const p=new Vn(i.name||`camera${i.index}`,j.Zero(),this._babylonScene,!1);switch(p._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,p.ignoreParentScaling=!0,i._babylonCamera=p,p.rotation=new j(0,Math.PI,0),i.type){case"perspective":{const _=i.perspective;if(!_)throw new Error(`${e}: Camera perspective properties are missing`);p.fov=_.yfov,p.minZ=_.znear,p.maxZ=_.zfar||0;break}case"orthographic":{if(!i.orthographic)throw new Error(`${e}: Camera orthographic properties are missing`);p.mode=wt.ORTHOGRAPHIC_CAMERA,p.orthoLeft=-i.orthographic.xmag,p.orthoRight=i.orthographic.xmag,p.orthoBottom=-i.orthographic.ymag,p.orthoTop=i.orthographic.ymag,p.minZ=i.orthographic.znear,p.maxZ=i.orthographic.zfar;break}default:throw new Error(`${e}: Invalid camera type (${i.type})`)}return Pt.AddPointerMetadata(p,e),this._parent.onCameraLoadedObservable.notifyObservers(p),s(p),this.logClose(),Promise.all(a).then(()=>p)}_loadAnimationsAsync(){const e=this._gltf.animations;if(!e)return Promise.resolve();const i=new Array;for(let s=0;s<e.length;s++){const n=e[s];i.push(this.loadAnimationAsync(`/animations/${n.index}`,n).then(a=>{a.targetedAnimations.length===0&&a.dispose()}))}return Promise.all(i).then(()=>{})}loadAnimationAsync(e,i){const s=this._extensionsLoadAnimationAsync(e,i);if(s)return s;this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new $2(i.name||`animation${i.index}`,this._babylonScene);n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i._babylonAnimationGroup=n;const a=new Array;$t.Assign(i.channels),$t.Assign(i.samplers);for(const p of i.channels)a.push(this._loadAnimationChannelAsync(`${e}/channels/${p.index}`,e,i,p,(_,g)=>{_.animations=_.animations||[],_.animations.push(g),n.addTargetedAnimation(g,_)}));return Promise.all(a).then(()=>(n.normalize(0),n))}_loadAnimationChannelAsync(e,i,s,n,a){const p=this._extensionsLoadAnimationChannelAsync(e,i,s,n,a);if(p)return p;if(n.target.node==null)return Promise.resolve();const _=$t.Get(`${e}/target/node`,this._gltf.nodes,n.target.node);if(n.target.path==="weights"&&!_._numMorphTargets||n.target.path!=="weights"&&!_._babylonTransformNode)return Promise.resolve();let g;switch(n.target.path){case"translation":{g=gu.translation;break}case"rotation":{g=gu.rotation;break}case"scale":{g=gu.scale;break}case"weights":{g=gu.weights;break}default:throw new Error(`${e}/target/path: Invalid value (${n.target.path})`)}const y={target:_,properties:g};return this._loadAnimationChannelFromTargetInfoAsync(e,i,s,n,y,a)}_loadAnimationChannelFromTargetInfoAsync(e,i,s,n,a,p){const _=this.parent.targetFps,g=1/_,y=$t.Get(`${e}/sampler`,s.samplers,n.sampler);return this._loadAnimationSamplerAsync(`${i}/samplers/${n.sampler}`,y).then(b=>{let v=0;for(const S of a.properties){const M=S.getStride(a.target),F=b.input,L=b.output,N=new Array(F.length);let k=0;switch(b.interpolation){case"STEP":{for(let G=0;G<F.length;G++){const H=S.getValue(a.target,L,k,1);k+=M,N[G]={frame:F[G]*_,value:H,interpolation:B2.STEP}}break}case"CUBICSPLINE":{for(let G=0;G<F.length;G++){const H=S.getValue(a.target,L,k,g);k+=M;const z=S.getValue(a.target,L,k,1);k+=M;const W=S.getValue(a.target,L,k,g);k+=M,N[G]={frame:F[G]*_,inTangent:H,value:z,outTangent:W}}break}case"LINEAR":{for(let G=0;G<F.length;G++){const H=S.getValue(a.target,L,k,1);k+=M,N[G]={frame:F[G]*_,value:H}}break}}if(k>0){const G=`${s.name||`animation${s.index}`}_channel${n.index}_${v}`;S.buildAnimations(a.target,G,_,N,(H,z)=>{++v,p(H,z)})}}})}_loadAnimationSamplerAsync(e,i){if(i._data)return i._data;const s=i.interpolation||"LINEAR";switch(s){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${i.interpolation})`)}const n=$t.Get(`${e}/input`,this._gltf.accessors,i.input),a=$t.Get(`${e}/output`,this._gltf.accessors,i.output);return i._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${n.index}`,n),this._loadFloatAccessorAsync(`/accessors/${a.index}`,a)]).then(([p,_])=>({input:p,interpolation:s,output:_})),i._data}loadBufferAsync(e,i,s,n){const a=this._extensionsLoadBufferAsync(e,i,s,n);if(a)return a;if(!i._data)if(i.uri)i._data=this.loadUriAsync(`${e}/uri`,i,i.uri);else{if(!this._bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);i._data=this._bin.readAsync(0,i.byteLength)}return i._data.then(p=>{try{return new Uint8Array(p.buffer,p.byteOffset+s,n)}catch(_){throw new Error(`${e}: ${_.message}`)}})}loadBufferViewAsync(e,i){const s=this._extensionsLoadBufferViewAsync(e,i);if(s)return s;if(i._data)return i._data;const n=$t.Get(`${e}/buffer`,this._gltf.buffers,i.buffer);return i._data=this.loadBufferAsync(`/buffers/${n.index}`,n,i.byteOffset||0,i.byteLength),i._data}_loadAccessorAsync(e,i,s){if(i._data)return i._data;const n=Pt._GetNumComponents(e,i.type),a=n*te.GetTypeByteLength(i.componentType),p=n*i.count;if(i.bufferView==null)i._data=Promise.resolve(new s(p));else{const _=$t.Get(`${e}/bufferView`,this._gltf.bufferViews,i.bufferView);i._data=this.loadBufferViewAsync(`/bufferViews/${_.index}`,_).then(g=>{if(i.componentType===5126&&!i.normalized&&(!_.byteStride||_.byteStride===a))return Pt._GetTypedArray(e,i.componentType,g,i.byteOffset,p);{const y=new s(p);return te.ForEach(g,i.byteOffset||0,_.byteStride||a,n,i.componentType,y.length,i.normalized||!1,(b,v)=>{y[v]=b}),y}})}if(i.sparse){const _=i.sparse;i._data=i._data.then(g=>{const y=g,b=$t.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,_.indices.bufferView),v=$t.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,_.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${b.index}`,b),this.loadBufferViewAsync(`/bufferViews/${v.index}`,v)]).then(([S,M])=>{const F=Pt._GetTypedArray(`${e}/sparse/indices`,_.indices.componentType,S,_.indices.byteOffset,_.count),L=n*_.count;let N;if(i.componentType===5126&&!i.normalized)N=Pt._GetTypedArray(`${e}/sparse/values`,i.componentType,M,_.values.byteOffset,L);else{const G=Pt._GetTypedArray(`${e}/sparse/values`,i.componentType,M,_.values.byteOffset,L);N=new s(L),te.ForEach(G,0,a,n,i.componentType,N.length,i.normalized||!1,(H,z)=>{N[z]=H})}let k=0;for(let G=0;G<F.length;G++){let H=F[G]*n;for(let z=0;z<n;z++)y[H++]=N[k++]}return y})})}return i._data}_loadFloatAccessorAsync(e,i){return this._loadAccessorAsync(e,i,Float32Array)}_loadIndicesAccessorAsync(e,i){if(i.type!=="SCALAR")throw new Error(`${e}/type: Invalid value ${i.type}`);if(i.componentType!==5121&&i.componentType!==5123&&i.componentType!==5125)throw new Error(`${e}/componentType: Invalid value ${i.componentType}`);if(i._data)return i._data;if(i.sparse){const s=Pt._GetTypedArrayConstructor(`${e}/componentType`,i.componentType);i._data=this._loadAccessorAsync(e,i,s)}else{const s=$t.Get(`${e}/bufferView`,this._gltf.bufferViews,i.bufferView);i._data=this.loadBufferViewAsync(`/bufferViews/${s.index}`,s).then(n=>Pt._GetTypedArray(e,i.componentType,n,i.byteOffset,i.count))}return i._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;const i=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then(s=>new bc(i,s,!1)),e._babylonBuffer}_loadVertexAccessorAsync(e,i,s){var n;if(!((n=i._babylonVertexBuffer)===null||n===void 0)&&n[s])return i._babylonVertexBuffer[s];i._babylonVertexBuffer||(i._babylonVertexBuffer={});const a=this._babylonScene.getEngine();if(i.sparse)i._babylonVertexBuffer[s]=this._loadFloatAccessorAsync(e,i).then(p=>new te(a,p,s,!1));else if(s===te.MatricesIndicesKind||s===te.MatricesIndicesExtraKind)i._babylonVertexBuffer[s]=this._loadFloatAccessorAsync(e,i).then(p=>new te(a,p,s,!1));else{const p=$t.Get(`${e}/bufferView`,this._gltf.bufferViews,i.bufferView);i._babylonVertexBuffer[s]=this._loadVertexBufferViewAsync(p).then(_=>{const g=Pt._GetNumComponents(e,i.type);return new te(a,_,s,!1,!1,p.byteStride,!1,i.byteOffset,g,i.componentType,i.normalized,!0,1,!0)})}return i._babylonVertexBuffer[s]}_loadMaterialMetallicRoughnessPropertiesAsync(e,i,s){if(!(s instanceof Et))throw new Error(`${e}: Material type not supported`);const n=new Array;return i&&(i.baseColorFactor?(s.albedoColor=qe.FromArray(i.baseColorFactor),s.alpha=i.baseColorFactor[3]):s.albedoColor=qe.White(),s.metallic=i.metallicFactor==null?1:i.metallicFactor,s.roughness=i.roughnessFactor==null?1:i.roughnessFactor,i.baseColorTexture&&n.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,i.baseColorTexture,a=>{a.name=`${s.name} (Base Color)`,s.albedoTexture=a})),i.metallicRoughnessTexture&&(i.metallicRoughnessTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,i.metallicRoughnessTexture,a=>{a.name=`${s.name} (Metallic Roughness)`,s.metallicTexture=a})),s.useMetallnessFromMetallicTextureBlue=!0,s.useRoughnessFromMetallicTextureGreen=!0,s.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(n).then(()=>{})}_loadMaterialAsync(e,i,s,n,a=()=>{}){const p=this._extensionsLoadMaterialAsync(e,i,s,n,a);if(p)return p;i._data=i._data||{};let _=i._data[n];if(!_){this.logOpen(`${e} ${i.name||""}`);const g=this.createMaterial(e,i,n);_={babylonMaterial:g,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,i,g)},i._data[n]=_,Pt.AddPointerMetadata(g,e),this._parent.onMaterialLoadedObservable.notifyObservers(g),this.logClose()}return s&&(_.babylonMeshes.push(s),s.onDisposeObservable.addOnce(()=>{const g=_.babylonMeshes.indexOf(s);g!==-1&&_.babylonMeshes.splice(g,1)})),a(_.babylonMaterial),_.promise.then(()=>_.babylonMaterial)}_createDefaultMaterial(e,i){this._babylonScene._blockEntityCollection=!!this._assetContainer;const s=new Et(e,this._babylonScene);return s._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,s.fillMode=i,s.enableSpecularAntiAliasing=!0,s.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,s.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,s.transparencyMode=Et.PBRMATERIAL_OPAQUE,s.metallic=1,s.roughness=1,s}createMaterial(e,i,s){const n=this._extensionsCreateMaterial(e,i,s);if(n)return n;const a=i.name||`material${i.index}`;return this._createDefaultMaterial(a,s)}loadMaterialPropertiesAsync(e,i,s){const n=this._extensionsLoadMaterialPropertiesAsync(e,i,s);if(n)return n;const a=new Array;return a.push(this.loadMaterialBasePropertiesAsync(e,i,s)),i.pbrMetallicRoughness&&a.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,i.pbrMetallicRoughness,s)),this.loadMaterialAlphaProperties(e,i,s),Promise.all(a).then(()=>{})}loadMaterialBasePropertiesAsync(e,i,s){if(!(s instanceof Et))throw new Error(`${e}: Material type not supported`);const n=new Array;return s.emissiveColor=i.emissiveFactor?qe.FromArray(i.emissiveFactor):new qe(0,0,0),i.doubleSided&&(s.backFaceCulling=!1,s.twoSidedLighting=!0),i.normalTexture&&(i.normalTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/normalTexture`,i.normalTexture,a=>{a.name=`${s.name} (Normal)`,s.bumpTexture=a})),s.invertNormalMapX=!this._babylonScene.useRightHandedSystem,s.invertNormalMapY=this._babylonScene.useRightHandedSystem,i.normalTexture.scale!=null&&s.bumpTexture&&(s.bumpTexture.level=i.normalTexture.scale),s.forceIrradianceInFragment=!0),i.occlusionTexture&&(i.occlusionTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,i.occlusionTexture,a=>{a.name=`${s.name} (Occlusion)`,s.ambientTexture=a})),s.useAmbientInGrayScale=!0,i.occlusionTexture.strength!=null&&(s.ambientTextureStrength=i.occlusionTexture.strength)),i.emissiveTexture&&n.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,i.emissiveTexture,a=>{a.name=`${s.name} (Emissive)`,s.emissiveTexture=a})),Promise.all(n).then(()=>{})}loadMaterialAlphaProperties(e,i,s){if(!(s instanceof Et))throw new Error(`${e}: Material type not supported`);switch(i.alphaMode||"OPAQUE"){case"OPAQUE":{s.transparencyMode=Et.PBRMATERIAL_OPAQUE;break}case"MASK":{s.transparencyMode=Et.PBRMATERIAL_ALPHATEST,s.alphaCutOff=i.alphaCutoff==null?.5:i.alphaCutoff,s.albedoTexture&&(s.albedoTexture.hasAlpha=!0);break}case"BLEND":{s.transparencyMode=Et.PBRMATERIAL_ALPHABLEND,s.albedoTexture&&(s.albedoTexture.hasAlpha=!0,s.useAlphaFromAlbedoTexture=!0);break}default:throw new Error(`${e}/alphaMode: Invalid value (${i.alphaMode})`)}}loadTextureInfoAsync(e,i,s=()=>{}){const n=this._extensionsLoadTextureInfoAsync(e,i,s);if(n)return n;if(this.logOpen(`${e}`),i.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${i.texCoord})`);const a=$t.Get(`${e}/index`,this._gltf.textures,i.index);a._textureInfo=i;const p=this._loadTextureAsync(`/textures/${i.index}`,a,_=>{_.coordinatesIndex=i.texCoord||0,Pt.AddPointerMetadata(_,e),this._parent.onTextureLoadedObservable.notifyObservers(_),s(_)});return this.logClose(),p}_loadTextureAsync(e,i,s=()=>{}){const n=this._extensionsLoadTextureAsync(e,i,s);if(n)return n;this.logOpen(`${e} ${i.name||""}`);const a=i.sampler==null?Pt.DefaultSampler:$t.Get(`${e}/sampler`,this._gltf.samplers,i.sampler),p=$t.Get(`${e}/source`,this._gltf.images,i.source),_=this._createTextureAsync(e,a,p,s,void 0,!i._textureInfo.nonColorData);return this.logClose(),_}_createTextureAsync(e,i,s,n=()=>{},a,p){const _=this._loadSampler(`/samplers/${i.index}`,i),g=new Array,y=new mu;this._babylonScene._blockEntityCollection=!!this._assetContainer;const b={noMipmap:_.noMipMaps,invertY:!1,samplingMode:_.samplingMode,onLoad:()=>{this._disposed||y.resolve()},onError:(S,M)=>{this._disposed||y.reject(new Error(`${e}: ${M&&M.message?M.message:S||"Failed to load texture"}`))},mimeType:s.mimeType,loaderOptions:a,useSRGBBuffer:!!p&&this._parent.useSRGBBuffers},v=new Oe(null,this._babylonScene,b);return v._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,g.push(y.promise),g.push(this.loadImageAsync(`/images/${s.index}`,s).then(S=>{const M=s.uri||`${this._fileName}#image${s.index}`,F=`data:${this._uniqueRootUrl}${M}`;v.updateURL(F,S)})),v.wrapU=_.wrapU,v.wrapV=_.wrapV,n(v),Promise.all(g).then(()=>v)}_loadSampler(e,i){return i._data||(i._data={noMipMaps:i.minFilter===9728||i.minFilter===9729,samplingMode:Pt._GetTextureSamplingMode(e,i),wrapU:Pt._GetTextureWrapMode(`${e}/wrapS`,i.wrapS),wrapV:Pt._GetTextureWrapMode(`${e}/wrapT`,i.wrapT)}),i._data}loadImageAsync(e,i){if(!i._data){if(this.logOpen(`${e} ${i.name||""}`),i.uri)i._data=this.loadUriAsync(`${e}/uri`,i,i.uri);else{const s=$t.Get(`${e}/bufferView`,this._gltf.bufferViews,i.bufferView);i._data=this.loadBufferViewAsync(`/bufferViews/${s.index}`,s)}this.logClose()}return i._data}loadUriAsync(e,i,s){const n=this._extensionsLoadUriAsync(e,i,s);if(n)return n;if(!Pt._ValidateUri(s))throw new Error(`${e}: '${s}' is invalid`);if(p2(s)){const a=new Uint8Array(Wh(s));return this.log(`${e}: Decoded ${s.substr(0,64)}... (${a.length} bytes)`),Promise.resolve(a)}return this.log(`${e}: Loading ${s}`),this._parent.preprocessUrlAsync(this._rootUrl+s).then(a=>new Promise((p,_)=>{this._parent._loadFile(this._babylonScene,a,g=>{this._disposed||(this.log(`${e}: Loaded ${s} (${g.byteLength} bytes)`),p(new Uint8Array(g)))},!0,g=>{_(new Vh(`${e}: Failed to load '${s}'${g?": "+g.status+" "+g.statusText:""}`,g))})}))}static AddPointerMetadata(e,i){e.metadata=e.metadata||{};const s=e._internalMetadata=e._internalMetadata||{},n=s.gltf=s.gltf||{};(n.pointers=n.pointers||[]).push(i)}static _GetTextureWrapMode(e,i){switch(i=i??10497,i){case 33071:return Oe.CLAMP_ADDRESSMODE;case 33648:return Oe.MIRROR_ADDRESSMODE;case 10497:return Oe.WRAP_ADDRESSMODE;default:return Ie.Warn(`${e}: Invalid value (${i})`),Oe.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,i){const s=i.magFilter==null?9729:i.magFilter,n=i.minFilter==null?9987:i.minFilter;if(s===9729)switch(n){case 9728:return Oe.LINEAR_NEAREST;case 9729:return Oe.LINEAR_LINEAR;case 9984:return Oe.LINEAR_NEAREST_MIPNEAREST;case 9985:return Oe.LINEAR_LINEAR_MIPNEAREST;case 9986:return Oe.LINEAR_NEAREST_MIPLINEAR;case 9987:return Oe.LINEAR_LINEAR_MIPLINEAR;default:return Ie.Warn(`${e}/minFilter: Invalid value (${n})`),Oe.LINEAR_LINEAR_MIPLINEAR}else switch(s!==9728&&Ie.Warn(`${e}/magFilter: Invalid value (${s})`),n){case 9728:return Oe.NEAREST_NEAREST;case 9729:return Oe.NEAREST_LINEAR;case 9984:return Oe.NEAREST_NEAREST_MIPNEAREST;case 9985:return Oe.NEAREST_LINEAR_MIPNEAREST;case 9986:return Oe.NEAREST_NEAREST_MIPLINEAR;case 9987:return Oe.NEAREST_LINEAR_MIPLINEAR;default:return Ie.Warn(`${e}/minFilter: Invalid value (${n})`),Oe.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,i){switch(i){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(`${e}: Invalid component type ${i}`)}}static _GetTypedArray(e,i,s,n,a){const p=s.buffer;n=s.byteOffset+(n||0);const _=Pt._GetTypedArrayConstructor(`${e}/componentType`,i),g=te.GetTypeByteLength(i);return n%g!==0?(Ie.Warn(`${e}: Copying buffer as byte offset (${n}) is not a multiple of component type byte length (${g})`),new _(p.slice(n,n+a*g),0)):new _(p,n,a)}static _GetNumComponents(e,i){switch(i){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${e}: Invalid type (${i})`)}static _ValidateUri(e){return Le.IsBase64(e)||e.indexOf("..")===-1}static _GetDrawMode(e,i){switch(i==null&&(i=4),i){case 0:return Be.PointListDrawMode;case 1:return Be.LineListDrawMode;case 2:return Be.LineLoopDrawMode;case 3:return Be.LineStripDrawMode;case 4:return Be.TriangleFillMode;case 5:return Be.TriangleStripDrawMode;case 6:return Be.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${i})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const e=new Array;if(this._gltf.materials){for(const i of this._gltf.materials)if(i._data)for(const s in i._data){const n=i._data[s];for(const a of n.babylonMeshes){a.computeWorldMatrix(!0);const p=n.babylonMaterial;e.push(p.forceCompilationAsync(a)),e.push(p.forceCompilationAsync(a,{useInstances:!0})),this._parent.useClipPlane&&(e.push(p.forceCompilationAsync(a,{clipPlane:!0})),e.push(p.forceCompilationAsync(a,{clipPlane:!0,useInstances:!0})))}}}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const e=new Array,i=this._babylonScene.lights;for(const s of i){const n=s.getShadowGenerator();n&&e.push(n.forceCompilationAsync())}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(e){for(const i of this._extensions)i.enabled&&e(i)}_applyExtensions(e,i,s){for(const n of this._extensions)if(n.enabled){const a=`${n.name}.${i}`,p=e;p._activeLoaderExtensionFunctions=p._activeLoaderExtensionFunctions||{};const _=p._activeLoaderExtensionFunctions;if(!_[a]){_[a]=!0;try{const g=s(n);if(g)return g}finally{delete _[a]}}}return null}_extensionsOnLoading(){this._forEachExtensions(e=>e.onLoading&&e.onLoading())}_extensionsOnReady(){this._forEachExtensions(e=>e.onReady&&e.onReady())}_extensionsLoadSceneAsync(e,i){return this._applyExtensions(i,"loadScene",s=>s.loadSceneAsync&&s.loadSceneAsync(e,i))}_extensionsLoadNodeAsync(e,i,s){return this._applyExtensions(i,"loadNode",n=>n.loadNodeAsync&&n.loadNodeAsync(e,i,s))}_extensionsLoadCameraAsync(e,i,s){return this._applyExtensions(i,"loadCamera",n=>n.loadCameraAsync&&n.loadCameraAsync(e,i,s))}_extensionsLoadVertexDataAsync(e,i,s){return this._applyExtensions(i,"loadVertexData",n=>n._loadVertexDataAsync&&n._loadVertexDataAsync(e,i,s))}_extensionsLoadMeshPrimitiveAsync(e,i,s,n,a,p){return this._applyExtensions(a,"loadMeshPrimitive",_=>_._loadMeshPrimitiveAsync&&_._loadMeshPrimitiveAsync(e,i,s,n,a,p))}_extensionsLoadMaterialAsync(e,i,s,n,a){return this._applyExtensions(i,"loadMaterial",p=>p._loadMaterialAsync&&p._loadMaterialAsync(e,i,s,n,a))}_extensionsCreateMaterial(e,i,s){return this._applyExtensions(i,"createMaterial",n=>n.createMaterial&&n.createMaterial(e,i,s))}_extensionsLoadMaterialPropertiesAsync(e,i,s){return this._applyExtensions(i,"loadMaterialProperties",n=>n.loadMaterialPropertiesAsync&&n.loadMaterialPropertiesAsync(e,i,s))}_extensionsLoadTextureInfoAsync(e,i,s){return this._applyExtensions(i,"loadTextureInfo",n=>n.loadTextureInfoAsync&&n.loadTextureInfoAsync(e,i,s))}_extensionsLoadTextureAsync(e,i,s){return this._applyExtensions(i,"loadTexture",n=>n._loadTextureAsync&&n._loadTextureAsync(e,i,s))}_extensionsLoadAnimationAsync(e,i){return this._applyExtensions(i,"loadAnimation",s=>s.loadAnimationAsync&&s.loadAnimationAsync(e,i))}_extensionsLoadAnimationChannelAsync(e,i,s,n,a){return this._applyExtensions(s,"loadAnimationChannel",p=>p._loadAnimationChannelAsync&&p._loadAnimationChannelAsync(e,i,s,n,a))}_extensionsLoadSkinAsync(e,i,s){return this._applyExtensions(s,"loadSkin",n=>n._loadSkinAsync&&n._loadSkinAsync(e,i,s))}_extensionsLoadUriAsync(e,i,s){return this._applyExtensions(i,"loadUri",n=>n._loadUriAsync&&n._loadUriAsync(e,i,s))}_extensionsLoadBufferViewAsync(e,i){return this._applyExtensions(i,"loadBufferView",s=>s.loadBufferViewAsync&&s.loadBufferViewAsync(e,i))}_extensionsLoadBufferAsync(e,i,s,n){return this._applyExtensions(i,"loadBuffer",a=>a.loadBufferAsync&&a.loadBufferAsync(e,i,s,n))}static LoadExtensionAsync(e,i,s,n){if(!i.extensions)return null;const p=i.extensions[s];return p?n(`${e}/extensions/${s}`,p):null}static LoadExtraAsync(e,i,s,n){if(!i.extras)return null;const p=i.extras[s];return p?n(`${e}/extras/${s}`,p):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(e)!==-1}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}}Pt._RegisteredExtensions={},Pt.DefaultSampler={index:-1},Rr._CreateGLTF2Loader=l=>new Pt(l);class og extends nn{constructor(e,i,s,n=5,a=0,p=!1,_=!1,g=3,y=null){super("",e),this._texture=e.getEngine().createRawCubeTexture(i,s,n,a,p,_,g,y)}update(e,i,s,n,a=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,i,s,n,a)}updateRGBDAsync(e,i=null,s=.8,n=0){return Bz(this._texture,e,i,s,n).then(()=>{})}clone(){return Kt.Clone(()=>{const e=this.getScene(),i=this._texture,s=new og(e,i._bufferViewArray,i.width,i.format,i.type,i.generateMipMaps,i.invertY,i.samplingMode,i._compression);return i.source===or.CubeRawRGBD&&s.updateRGBDAsync(i._bufferViewArrayArray,i._sphericalPolynomial,i._lodGenerationScale,i._lodGenerationOffset),s},this)}}const xg="EXT_lights_image_based";class IH{constructor(e){this.name=xg,this._loader=e,this.enabled=this._loader.isExtensionUsed(xg)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const i=e[this.name];this._lights=i.lights}}loadSceneAsync(e,i){return Pt.LoadExtensionAsync(e,i,this.name,(s,n)=>{const a=new Array;a.push(this._loader.loadSceneAsync(e,i)),this._loader.logOpen(`${s}`);const p=$t.Get(`${s}/light`,this._lights,n.light);return a.push(this._loadLightAsync(`/extensions/${this.name}/lights/${n.light}`,p).then(_=>{this._loader.babylonScene.environmentTexture=_})),this._loader.logClose(),Promise.all(a).then(()=>{})})}_loadLightAsync(e,i){if(!i._loaded){const s=new Array;this._loader.logOpen(`${e}`);const n=new Array(i.specularImages.length);for(let a=0;a<i.specularImages.length;a++){const p=i.specularImages[a];n[a]=new Array(p.length);for(let _=0;_<p.length;_++){const g=`${e}/specularImages/${a}/${_}`;this._loader.logOpen(`${g}`);const y=p[_],b=$t.Get(g,this._loader.gltf.images,y);s.push(this._loader.loadImageAsync(`/images/${y}`,b).then(v=>{n[a][_]=v})),this._loader.logClose()}}this._loader.logClose(),i._loaded=Promise.all(s).then(()=>{const a=new og(this._loader.babylonScene,null,i.specularImageSize);if(a.name=i.name||"environment",i._babylonTexture=a,i.intensity!=null&&(a.level=i.intensity),i.rotation){let y=Ve.FromArray(i.rotation);this._loader.babylonScene.useRightHandedSystem||(y=Ve.Inverse(y)),fe.FromQuaternionToRef(y,a.getReflectionTextureMatrix())}if(!i.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);const p=Sc.FromArray(i.irradianceCoefficients);p.scaleInPlace(i.intensity),p.convertIrradianceToLambertianRadiance();const _=Cx.FromHarmonics(p),g=(n.length-1)/at.Log2(i.specularImageSize);return a.updateRGBDAsync(n,_,g)})}return i._loaded.then(()=>i._babylonTexture)}}Pt.RegisterExtension(xg,l=>new IH(l)),Qe.prototype.thinInstanceAdd=function(l,e=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return Ie.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(l)?l.length:1);const i=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(l))for(let s=0;s<l.length;++s)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,l[s],s===l.length-1&&e);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,l,e);return i},Qe.prototype.thinInstanceAddSelf=function(l=!0){return this.thinInstanceAdd(fe.IdentityReadOnly,l)},Qe.prototype.thinInstanceRegisterAttribute=function(l,e){l===te.ColorKind&&(l=te.ColorInstanceKind),this.removeVerticesData(l),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[l]=e,this._userThinInstanceBuffersStorage.sizes[l]=e*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[l]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[l]),this._userThinInstanceBuffersStorage.vertexBuffers[l]=new te(this.getEngine(),this._userThinInstanceBuffersStorage.data[l],l,!0,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[l])},Qe.prototype.thinInstanceSetMatrixAt=function(l,e,i=!0){if(!this._thinInstanceDataStorage.matrixData||l>=this._thinInstanceDataStorage.instancesCount)return!1;const s=this._thinInstanceDataStorage.matrixData;return e.copyToArray(s,l*16),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[l]=e),i&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0},Qe.prototype.thinInstanceSetAttributeAt=function(l,e,i,s=!0){return l===te.ColorKind&&(l=te.ColorInstanceKind),!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[l]||e>=this._thinInstanceDataStorage.instancesCount?!1:(this._thinInstanceUpdateBufferSize(l,0),this._userThinInstanceBuffersStorage.data[l].set(i,e*this._userThinInstanceBuffersStorage.strides[l]),s&&this.thinInstanceBufferUpdated(l),!0)},Object.defineProperty(Qe.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(l){var e,i;const s=(e=this._thinInstanceDataStorage.matrixData)!==null&&e!==void 0?e:(i=this.source)===null||i===void 0?void 0:i._thinInstanceDataStorage.matrixData,n=s?s.length/16:0;l<=n&&(this._thinInstanceDataStorage.instancesCount=l)},enumerable:!0,configurable:!0}),Qe.prototype._thinInstanceCreateMatrixBuffer=function(l,e,i=!1){l===te.ColorKind&&(l=te.ColorInstanceKind);const s=new bc(this.getEngine(),e,!i,16,!1,!0);for(let n=0;n<4;n++)this.setVerticesBuffer(s.createVertexBuffer(l+n,n*4,4));return s},Qe.prototype.thinInstanceSetBuffer=function(l,e,i=0,s=!1){var n,a,p;i=i||16,l==="matrix"?((n=this._thinInstanceDataStorage.matrixBuffer)===null||n===void 0||n.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=e?e.length:32*i,this._thinInstanceDataStorage.matrixData=e,this._thinInstanceDataStorage.worldMatrices=null,e!==null?(this._thinInstanceDataStorage.instancesCount=e.length/i,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",e,s),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):l==="previousMatrix"?((a=this._thinInstanceDataStorage.previousMatrixBuffer)===null||a===void 0||a.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=e,e!==null&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",e,s))):(l===te.ColorKind&&(l=te.ColorInstanceKind),e===null?!((p=this._userThinInstanceBuffersStorage)===null||p===void 0)&&p.data[l]&&(this.removeVerticesData(l),delete this._userThinInstanceBuffersStorage.data[l],delete this._userThinInstanceBuffersStorage.strides[l],delete this._userThinInstanceBuffersStorage.sizes[l],delete this._userThinInstanceBuffersStorage.vertexBuffers[l]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[l]=e,this._userThinInstanceBuffersStorage.strides[l]=i,this._userThinInstanceBuffersStorage.sizes[l]=e.length,this._userThinInstanceBuffersStorage.vertexBuffers[l]=new te(this.getEngine(),e,l,!s,!1,i,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[l])))},Qe.prototype.thinInstanceBufferUpdated=function(l){var e,i,s;l==="matrix"?(e=this._thinInstanceDataStorage.matrixBuffer)===null||e===void 0||e.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount):l==="previousMatrix"?(i=this._thinInstanceDataStorage.previousMatrixBuffer)===null||i===void 0||i.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount):(l===te.ColorKind&&(l=te.ColorInstanceKind),!((s=this._userThinInstanceBuffersStorage)===null||s===void 0)&&s.vertexBuffers[l]&&this._userThinInstanceBuffersStorage.vertexBuffers[l].updateDirectly(this._userThinInstanceBuffersStorage.data[l],0))},Qe.prototype.thinInstancePartialBufferUpdate=function(l,e,i){var s;l==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(e,i):(l===te.ColorKind&&(l=te.ColorInstanceKind),!((s=this._userThinInstanceBuffersStorage)===null||s===void 0)&&s.vertexBuffers[l]&&this._userThinInstanceBuffersStorage.vertexBuffers[l].updateDirectly(e,i))},Qe.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];const l=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=new Array;for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e)this._thinInstanceDataStorage.worldMatrices[e]=fe.FromArray(l,e*16)}return this._thinInstanceDataStorage.worldMatrices},Qe.prototype.thinInstanceRefreshBoundingInfo=function(l=!1,e=!1,i=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;const s=this._thinInstanceDataStorage.boundingVectors;if(l||!this.rawBoundingInfo){s.length=0,this.refreshBoundingInfo(e,i);const p=this.getBoundingInfo();this.rawBoundingInfo=new la(p.minimum,p.maximum)}const n=this.getBoundingInfo(),a=this._thinInstanceDataStorage.matrixData;if(s.length===0)for(let p=0;p<n.boundingBox.vectors.length;++p)s.push(n.boundingBox.vectors[p].clone());ge.Vector3[0].setAll(Number.POSITIVE_INFINITY),ge.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let p=0;p<this._thinInstanceDataStorage.instancesCount;++p){fe.FromArrayToRef(a,p*16,ge.Matrix[0]);for(let _=0;_<s.length;++_)j.TransformCoordinatesToRef(s[_],ge.Matrix[0],ge.Vector3[2]),ge.Vector3[0].minimizeInPlace(ge.Vector3[2]),ge.Vector3[1].maximizeInPlace(ge.Vector3[2])}n.reConstruct(ge.Vector3[0],ge.Vector3[1]),this._updateBoundingInfo()},Qe.prototype._thinInstanceUpdateBufferSize=function(l,e=1){var i,s,n;l===te.ColorKind&&(l=te.ColorInstanceKind);const a=l==="matrix";if(!a&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[l]))return;const p=a?16:this._userThinInstanceBuffersStorage.strides[l],_=a?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[l];let g=a?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[l];const y=(this._thinInstanceDataStorage.instancesCount+e)*p;let b=_;for(;b<y;)b*=2;if(!g||_!=b){if(!g)g=new Float32Array(b);else{const v=new Float32Array(b);v.set(g,0),g=v}a?((i=this._thinInstanceDataStorage.matrixBuffer)===null||i===void 0||i.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",g,!1),this._thinInstanceDataStorage.matrixData=g,this._thinInstanceDataStorage.matrixBufferSize=b,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&((s=this._thinInstanceDataStorage.previousMatrixBuffer)===null||s===void 0||s.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",g,!1))):((n=this._userThinInstanceBuffersStorage.vertexBuffers[l])===null||n===void 0||n.dispose(),this._userThinInstanceBuffersStorage.data[l]=g,this._userThinInstanceBuffersStorage.sizes[l]=b,this._userThinInstanceBuffersStorage.vertexBuffers[l]=new te(this.getEngine(),g,l,!0,!1,p,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[l]))}},Qe.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})},Qe.prototype._disposeThinInstanceSpecificData=function(){var l;!((l=this._thinInstanceDataStorage)===null||l===void 0)&&l.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)};const lg="EXT_mesh_gpu_instancing";class SH{constructor(e){this.name=lg,this._loader=e,this.enabled=this._loader.isExtensionUsed(lg)}dispose(){this._loader=null}loadNodeAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,(n,a)=>{this._loader._disableInstancedMesh++;const p=this._loader.loadNodeAsync(`/nodes/${i.index}`,i,s);if(this._loader._disableInstancedMesh--,!i._primitiveBabylonMeshes)return p;const _=new Array;let g=0;const y=b=>{if(a.attributes[b]==null){_.push(Promise.resolve(null));return}const v=$t.Get(`${n}/attributes/${b}`,this._loader.gltf.accessors,a.attributes[b]);if(_.push(this._loader._loadFloatAccessorAsync(`/accessors/${v.bufferView}`,v)),g===0)g=v.count;else if(g!==v.count)throw new Error(`${n}/attributes: Instance buffer accessors do not have the same count.`)};return y("TRANSLATION"),y("ROTATION"),y("SCALE"),p.then(b=>Promise.all(_).then(([v,S,M])=>{const F=new Float32Array(g*16);ge.Vector3[0].copyFromFloats(0,0,0),ge.Quaternion[0].copyFromFloats(0,0,0,1),ge.Vector3[1].copyFromFloats(1,1,1);for(let L=0;L<g;++L)v&&j.FromArrayToRef(v,L*3,ge.Vector3[0]),S&&Ve.FromArrayToRef(S,L*4,ge.Quaternion[0]),M&&j.FromArrayToRef(M,L*3,ge.Vector3[1]),fe.ComposeToRef(ge.Vector3[1],ge.Quaternion[0],ge.Vector3[0],ge.Matrix[0]),ge.Matrix[0].copyToArray(F,L*16);for(const L of i._primitiveBabylonMeshes)L.thinInstanceSetBuffer("matrix",F,16,!0);return b}))})}}Pt.RegisterExtension(lg,l=>new SH(l));class N0{static get Default(){return N0._Default||(N0._Default=new N0),N0._Default}constructor(){const e=N0.Configuration.decoder;this._decoderModulePromise=Le.LoadScriptAsync(Le.GetAbsoluteUrl(e.url)).then(()=>MeshoptDecoder.ready)}dispose(){delete this._decoderModulePromise}decodeGltfBufferAsync(e,i,s,n,a){return this._decoderModulePromise.then(()=>{const p=new Uint8Array(i*s);return MeshoptDecoder.decodeGltfBuffer(p,i,s,e,n,a),p})}}N0.Configuration={decoder:{url:"https://preview.babylonjs.com/meshopt_decoder.js"}},N0._Default=null;const cg="EXT_meshopt_compression";class MH{constructor(e){this.name=cg,this.enabled=e.isExtensionUsed(cg),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,i){return Pt.LoadExtensionAsync(e,i,this.name,(s,n)=>{const a=i;if(a._meshOptData)return a._meshOptData;const p=$t.Get(`${e}/buffer`,this._loader.gltf.buffers,n.buffer);return a._meshOptData=this._loader.loadBufferAsync(`/buffers/${p.index}`,p,n.byteOffset||0,n.byteLength).then(_=>N0.Default.decodeGltfBufferAsync(_,n.count,n.byteStride,n.mode,n.filter)),a._meshOptData})}}Pt.RegisterExtension(cg,l=>new MH(l));const hg="EXT_texture_webp";class PH{constructor(e){this.name=hg,this._loader=e,this.enabled=e.isExtensionUsed(hg)}dispose(){this._loader=null}_loadTextureAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,(n,a)=>{const p=i.sampler==null?Pt.DefaultSampler:$t.Get(`${e}/sampler`,this._loader.gltf.samplers,i.sampler),_=$t.Get(`${n}/source`,this._loader.gltf.images,a.source);return this._loader._createTextureAsync(e,p,_,g=>{s(g)},void 0,!i._textureInfo.nonColorData)})}}Pt.RegisterExtension(hg,l=>new PH(l));function OH(l){return new Promise(e=>{DracoDecoderModule({wasmBinary:l}).then(i=>{e({module:i})})})}function ug(l,e,i,s,n,a){const p=new l.DecoderBuffer;p.Init(e,e.byteLength);const _=new l.Decoder;let g,y;try{const b=_.GetEncodedGeometryType(p);switch(b){case l.TRIANGULAR_MESH:g=new l.Mesh,y=_.DecodeBufferToMesh(p,g);break;case l.POINT_CLOUD:g=new l.PointCloud,y=_.DecodeBufferToPointCloud(p,g);break;default:throw new Error(`Invalid geometry type ${b}`)}if(!y.ok()||!g.ptr)throw new Error(y.error_msg());if(b===l.TRIANGULAR_MESH){const M=g.num_faces()*3,F=M*4,L=l._malloc(F);try{_.GetTrianglesUInt32Array(g,F,L);const N=new Uint32Array(M);N.set(new Uint32Array(l.HEAPF32.buffer,L,M)),s(N)}finally{l._free(L)}}const v=(S,M,F=1)=>{const L=M.num_components(),N=g.num_points(),k=N*L,G=k*Float32Array.BYTES_PER_ELEMENT,H=l._malloc(G);try{_.GetAttributeDataArrayForAllPoints(g,M,l.DT_FLOAT32,G,H);const z=new Float32Array(l.HEAPF32.buffer,H,k);if(S==="color"&&L===3){const W=new Float32Array(N*4);for(let Y=0,Z=0;Y<W.length;Y+=4,Z+=L)W[Y+0]=z[Z+0],W[Y+1]=z[Z+1],W[Y+2]=z[Z+2],W[Y+3]=1;n(S,W)}else{const W=new Float32Array(k);if(W.set(new Float32Array(l.HEAPF32.buffer,H,k)),F!==1)for(let Y=0;Y<W.length;Y++)W[Y]=W[Y]/F;n(S,W)}}finally{l._free(H)}};if(i)for(const S in i){const M=i[S],F=_.GetAttributeByUniqueId(g,M),L=a&&a[S]||1;v(S,F,L)}else{const S={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"};for(const M in S){const F=_.GetAttributeId(g,l[S[M]]);if(F!==-1){const L=_.GetAttribute(g,F);v(M,L)}}}}finally{g&&l.destroy(g),l.destroy(_),l.destroy(p)}}function wH(){let l;onmessage=e=>{const i=e.data;switch(i.id){case"init":{const s=i.decoder;s.url&&(importScripts(s.url),l=DracoDecoderModule({wasmBinary:s.wasmBinary})),postMessage("done");break}case"decodeMesh":{if(!l)throw new Error("Draco decoder module is not available");l.then(s=>{ug(s,i.dataView,i.attributes,n=>{postMessage({id:"indices",value:n},[n.buffer])},(n,a)=>{postMessage({id:n,value:a},[a.buffer])}),postMessage("done")});break}}}}class ua{static get DecoderAvailable(){const e=ua.Configuration.decoder;return!!(e.wasmUrl&&e.wasmBinaryUrl&&typeof WebAssembly=="object"||e.fallbackUrl)}static GetDefaultNumWorkers(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}static get Default(){return ua._Default||(ua._Default=new ua),ua._Default}constructor(e=ua.DefaultNumWorkers){const i=ua.Configuration.decoder,s=i.wasmUrl&&i.wasmBinaryUrl&&typeof WebAssembly=="object"?{url:Le.GetAbsoluteUrl(i.wasmUrl),wasmBinaryPromise:Le.LoadFileAsync(Le.GetAbsoluteUrl(i.wasmBinaryUrl))}:{url:Le.GetAbsoluteUrl(i.fallbackUrl),wasmBinaryPromise:Promise.resolve(void 0)};e&&typeof Worker=="function"&&typeof URL=="function"?this._workerPoolPromise=s.wasmBinaryPromise.then(n=>{const a=`${ug}(${wH})()`,p=URL.createObjectURL(new Blob([a],{type:"application/javascript"}));return new nu(e,()=>new Promise((_,g)=>{const y=new Worker(p),b=S=>{y.removeEventListener("error",b),y.removeEventListener("message",v),g(S)},v=S=>{S.data==="done"&&(y.removeEventListener("error",b),y.removeEventListener("message",v),_(y))};y.addEventListener("error",b),y.addEventListener("message",v),y.postMessage({id:"init",decoder:{url:s.url,wasmBinary:n}})}))}):this._decoderModulePromise=s.wasmBinaryPromise.then(n=>{if(!s.url)throw new Error("Draco decoder module is not available");return Le.LoadScriptAsync(s.url).then(()=>OH(n))})}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then(e=>{e.dispose()}),delete this._workerPoolPromise,delete this._decoderModulePromise}whenReadyAsync(){return this._workerPoolPromise?this._workerPoolPromise.then(()=>{}):this._decoderModulePromise?this._decoderModulePromise.then(()=>{}):Promise.resolve()}decodeMeshAsync(e,i,s){const n=e instanceof ArrayBuffer?new Uint8Array(e):e;if(this._workerPoolPromise)return this._workerPoolPromise.then(a=>new Promise((p,_)=>{a.push((g,y)=>{const b=new Mt,v=F=>{g.removeEventListener("error",v),g.removeEventListener("message",S),_(F),y()},S=F=>{if(F.data==="done")g.removeEventListener("error",v),g.removeEventListener("message",S),p(b),y();else if(F.data.id==="indices")b.indices=F.data.value;else{const L=s&&s[F.data.id]?s[F.data.id]:1;if(L!==1)for(let N=0;N<F.data.value.length;N++)F.data.value[N]=F.data.value[N]/L;b.set(F.data.value,F.data.id)}};g.addEventListener("error",v),g.addEventListener("message",S);const M=new Uint8Array(n.byteLength);M.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength)),g.postMessage({id:"decodeMesh",dataView:M,attributes:i},[M.buffer])})}));if(this._decoderModulePromise)return this._decoderModulePromise.then(a=>{const p=new Mt;return ug(a.module,n,i,_=>{p.indices=_},(_,g)=>{p.set(g,_)},s),p});throw new Error("Draco decoder module is not available")}}ua.Configuration={decoder:{wasmUrl:"https://preview.babylonjs.com/draco_wasm_wrapper_gltf.js",wasmBinaryUrl:"https://preview.babylonjs.com/draco_decoder_gltf.wasm",fallbackUrl:"https://preview.babylonjs.com/draco_decoder_gltf.js"}},ua.DefaultNumWorkers=ua.GetDefaultNumWorkers(),ua._Default=null;const dg="KHR_draco_mesh_compression";class DH{constructor(e){this.name=dg,this._loader=e,this.enabled=ua.DecoderAvailable&&this._loader.isExtensionUsed(dg)}dispose(){delete this.dracoCompression,this._loader=null}_loadVertexDataAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,(n,a)=>{if(i.mode!=null){if(i.mode!==5&&i.mode!==4)throw new Error(`${e}: Unsupported mode ${i.mode}`);if(i.mode===5)throw new Error(`${e}: Mode ${i.mode} is not currently supported`)}const p={},_={},g=(b,v)=>{const S=a.attributes[b];if(S===void 0||i.attributes[b]===void 0)return;p[v]=S;const M=$t.Get(`${e}/attributes/${b}`,this._loader.gltf.accessors,i.attributes[b]);if(M.normalized&&M.componentType!==5126){let F=1;switch(M.componentType){case 5120:F=127;break;case 5121:F=255;break;case 5122:F=32767;break;case 5123:F=65535;break}_[v]=F}s._delayInfo=s._delayInfo||[],s._delayInfo.indexOf(v)===-1&&s._delayInfo.push(v)};g("POSITION",te.PositionKind),g("NORMAL",te.NormalKind),g("TANGENT",te.TangentKind),g("TEXCOORD_0",te.UVKind),g("TEXCOORD_1",te.UV2Kind),g("TEXCOORD_2",te.UV3Kind),g("TEXCOORD_3",te.UV4Kind),g("TEXCOORD_4",te.UV5Kind),g("TEXCOORD_5",te.UV6Kind),g("JOINTS_0",te.MatricesIndicesKind),g("WEIGHTS_0",te.MatricesWeightsKind),g("COLOR_0",te.ColorKind);const y=$t.Get(n,this._loader.gltf.bufferViews,a.bufferView);return y._dracoBabylonGeometry||(y._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${y.index}`,y).then(b=>(this.dracoCompression||ua.Default).decodeMeshAsync(b,p,_).then(S=>{const M=new cn(s.name,this._loader.babylonScene);return S.applyToGeometry(M),M}).catch(S=>{throw new Error(`${e}: ${S.message}`)}))),y._dracoBabylonGeometry})}}Pt.RegisterExtension(dg,l=>new DH(l));const fg="KHR_lights_punctual";class FH{constructor(e){this.name=fg,this._loader=e,this.enabled=this._loader.isExtensionUsed(fg)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const i=e[this.name];this._lights=i.lights,$t.Assign(this._lights)}}loadNodeAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,(n,a)=>this._loader.loadNodeAsync(e,i,p=>{let _;const g=$t.Get(n,this._lights,a.light),y=g.name||p.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,g.type){case"directional":{_=new Ja(y,j.Backward(),this._loader.babylonScene);break}case"point":{_=new Fc(y,j.Zero(),this._loader.babylonScene);break}case"spot":{const b=new jn(y,j.Zero(),j.Backward(),0,1,this._loader.babylonScene);b.angle=(g.spot&&g.spot.outerConeAngle||Math.PI/4)*2,b.innerAngle=(g.spot&&g.spot.innerConeAngle||0)*2,_=b;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${n}: Invalid light type (${g.type})`)}_._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,g._babylonLight=_,_.falloffType=Ei.FALLOFF_GLTF,_.diffuse=g.color?qe.FromArray(g.color):qe.White(),_.intensity=g.intensity==null?1:g.intensity,_.range=g.range==null?Number.MAX_VALUE:g.range,_.parent=p,this._loader._babylonLights.push(_),Pt.AddPointerMetadata(_,n),s(p)}))}}Pt.RegisterExtension(fg,l=>new FH(l));const pg="KHR_materials_pbrSpecularGlossiness";class LH{constructor(e){this.name=pg,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(pg)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,(n,a)=>{const p=new Array;return p.push(this._loader.loadMaterialBasePropertiesAsync(e,i,s)),p.push(this._loadSpecularGlossinessPropertiesAsync(n,i,a,s)),this._loader.loadMaterialAlphaProperties(e,i,s),Promise.all(p).then(()=>{})})}_loadSpecularGlossinessPropertiesAsync(e,i,s,n){if(!(n instanceof Et))throw new Error(`${e}: Material type not supported`);const a=new Array;return n.metallic=null,n.roughness=null,s.diffuseFactor?(n.albedoColor=qe.FromArray(s.diffuseFactor),n.alpha=s.diffuseFactor[3]):n.albedoColor=qe.White(),n.reflectivityColor=s.specularFactor?qe.FromArray(s.specularFactor):qe.White(),n.microSurface=s.glossinessFactor==null?1:s.glossinessFactor,s.diffuseTexture&&a.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,s.diffuseTexture,p=>{p.name=`${n.name} (Diffuse)`,n.albedoTexture=p})),s.specularGlossinessTexture&&(a.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,s.specularGlossinessTexture,p=>{p.name=`${n.name} (Specular Glossiness)`,n.reflectivityTexture=p,n.reflectivityTexture.hasAlpha=!0})),n.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(a).then(()=>{})}}Pt.RegisterExtension(pg,l=>new LH(l));const mg="KHR_materials_unlit";class NH{constructor(e){this.name=mg,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(mg)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,()=>this._loadUnlitPropertiesAsync(e,i,s))}_loadUnlitPropertiesAsync(e,i,s){if(!(s instanceof Et))throw new Error(`${e}: Material type not supported`);const n=new Array;s.unlit=!0;const a=i.pbrMetallicRoughness;return a&&(a.baseColorFactor?(s.albedoColor=qe.FromArray(a.baseColorFactor),s.alpha=a.baseColorFactor[3]):s.albedoColor=qe.White(),a.baseColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,a.baseColorTexture,p=>{p.name=`${s.name} (Base Color)`,s.albedoTexture=p}))),i.doubleSided&&(s.backFaceCulling=!1,s.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,i,s),Promise.all(n).then(()=>{})}}Pt.RegisterExtension(mg,l=>new NH(l));const _g="KHR_materials_clearcoat";class BH{constructor(e){this.name=_g,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(_g)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,(n,a)=>{const p=new Array;return p.push(this._loader.loadMaterialPropertiesAsync(e,i,s)),p.push(this._loadClearCoatPropertiesAsync(n,a,s)),Promise.all(p).then(()=>{})})}_loadClearCoatPropertiesAsync(e,i,s){if(!(s instanceof Et))throw new Error(`${e}: Material type not supported`);const n=new Array;return s.clearCoat.isEnabled=!0,s.clearCoat.useRoughnessFromMainTexture=!1,s.clearCoat.remapF0OnInterfaceChange=!1,i.clearcoatFactor!=null?s.clearCoat.intensity=i.clearcoatFactor:s.clearCoat.intensity=0,i.clearcoatTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,i.clearcoatTexture,a=>{a.name=`${s.name} (ClearCoat Intensity)`,s.clearCoat.texture=a})),i.clearcoatRoughnessFactor!=null?s.clearCoat.roughness=i.clearcoatRoughnessFactor:s.clearCoat.roughness=0,i.clearcoatRoughnessTexture&&(i.clearcoatRoughnessTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,i.clearcoatRoughnessTexture,a=>{a.name=`${s.name} (ClearCoat Roughness)`,s.clearCoat.textureRoughness=a}))),i.clearcoatNormalTexture&&(i.clearcoatNormalTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,i.clearcoatNormalTexture,a=>{a.name=`${s.name} (ClearCoat Normal)`,s.clearCoat.bumpTexture=a})),s.invertNormalMapX=!s.getScene().useRightHandedSystem,s.invertNormalMapY=s.getScene().useRightHandedSystem,i.clearcoatNormalTexture.scale!=null&&(s.clearCoat.bumpTexture.level=i.clearcoatNormalTexture.scale)),Promise.all(n).then(()=>{})}}Pt.RegisterExtension(_g,l=>new BH(l));const gg="KHR_materials_iridescence";class kH{constructor(e){this.name=gg,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(gg)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,(n,a)=>{const p=new Array;return p.push(this._loader.loadMaterialPropertiesAsync(e,i,s)),p.push(this._loadIridescencePropertiesAsync(n,a,s)),Promise.all(p).then(()=>{})})}_loadIridescencePropertiesAsync(e,i,s){var n,a,p,_,g;if(!(s instanceof Et))throw new Error(`${e}: Material type not supported`);const y=new Array;return s.iridescence.isEnabled=!0,s.iridescence.intensity=(n=i.iridescenceFactor)!==null&&n!==void 0?n:0,s.iridescence.indexOfRefraction=(p=(a=i.iridescenceIor)!==null&&a!==void 0?a:i.iridescenceIOR)!==null&&p!==void 0?p:1.3,s.iridescence.minimumThickness=(_=i.iridescenceThicknessMinimum)!==null&&_!==void 0?_:100,s.iridescence.maximumThickness=(g=i.iridescenceThicknessMaximum)!==null&&g!==void 0?g:400,i.iridescenceTexture&&y.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,i.iridescenceTexture,b=>{b.name=`${s.name} (Iridescence Intensity)`,s.iridescence.texture=b})),i.iridescenceThicknessTexture&&y.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,i.iridescenceThicknessTexture,b=>{b.name=`${s.name} (Iridescence Thickness)`,s.iridescence.thicknessTexture=b})),Promise.all(y).then(()=>{})}}Pt.RegisterExtension(gg,l=>new kH(l));const yg="KHR_materials_emissive_strength";class UH{constructor(e){this.name=yg,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(yg)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,(n,a)=>this._loader.loadMaterialPropertiesAsync(e,i,s).then(()=>{this._loadEmissiveProperties(n,a,s)}))}_loadEmissiveProperties(e,i,s){if(!(s instanceof Et))throw new Error(`${e}: Material type not supported`);i.emissiveStrength!==void 0&&s.emissiveColor.scaleToRef(i.emissiveStrength,s.emissiveColor)}}Pt.RegisterExtension(yg,l=>new UH(l));const bg="KHR_materials_sheen";class VH{constructor(e){this.name=bg,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(bg)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,(n,a)=>{const p=new Array;return p.push(this._loader.loadMaterialPropertiesAsync(e,i,s)),p.push(this._loadSheenPropertiesAsync(n,a,s)),Promise.all(p).then(()=>{})})}_loadSheenPropertiesAsync(e,i,s){if(!(s instanceof Et))throw new Error(`${e}: Material type not supported`);const n=new Array;return s.sheen.isEnabled=!0,s.sheen.intensity=1,i.sheenColorFactor!=null?s.sheen.color=qe.FromArray(i.sheenColorFactor):s.sheen.color=qe.Black(),i.sheenColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,i.sheenColorTexture,a=>{a.name=`${s.name} (Sheen Color)`,s.sheen.texture=a})),i.sheenRoughnessFactor!==void 0?s.sheen.roughness=i.sheenRoughnessFactor:s.sheen.roughness=0,i.sheenRoughnessTexture&&(i.sheenRoughnessTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,i.sheenRoughnessTexture,a=>{a.name=`${s.name} (Sheen Roughness)`,s.sheen.textureRoughness=a}))),s.sheen.albedoScaling=!0,s.sheen.useRoughnessFromMainTexture=!1,Promise.all(n).then(()=>{})}}Pt.RegisterExtension(bg,l=>new VH(l));const vg="KHR_materials_specular";class GH{constructor(e){this.name=vg,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(vg)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,(n,a)=>{const p=new Array;return p.push(this._loader.loadMaterialPropertiesAsync(e,i,s)),p.push(this._loadSpecularPropertiesAsync(n,a,s)),Promise.all(p).then(()=>{})})}_loadSpecularPropertiesAsync(e,i,s){if(!(s instanceof Et))throw new Error(`${e}: Material type not supported`);const n=new Array;return i.specularFactor!==void 0&&(s.metallicF0Factor=i.specularFactor),i.specularColorFactor!==void 0&&(s.metallicReflectanceColor=qe.FromArray(i.specularColorFactor)),i.specularTexture&&(i.specularTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,i.specularTexture,a=>{a.name=`${s.name} (Specular F0 Strength)`,s.metallicReflectanceTexture=a,s.useOnlyMetallicFromMetallicReflectanceTexture=!0}))),i.specularColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,i.specularColorTexture,a=>{a.name=`${s.name} (Specular F0 Color)`,s.reflectanceTexture=a})),Promise.all(n).then(()=>{})}}Pt.RegisterExtension(vg,l=>new GH(l));const Tg="KHR_materials_ior";class J2{constructor(e){this.name=Tg,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(Tg)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,(n,a)=>{const p=new Array;return p.push(this._loader.loadMaterialPropertiesAsync(e,i,s)),p.push(this._loadIorPropertiesAsync(n,a,s)),Promise.all(p).then(()=>{})})}_loadIorPropertiesAsync(e,i,s){if(!(s instanceof Et))throw new Error(`${e}: Material type not supported`);return i.ior!==void 0?s.indexOfRefraction=i.ior:s.indexOfRefraction=J2._DEFAULT_IOR,Promise.resolve()}}J2._DEFAULT_IOR=1.5,Pt.RegisterExtension(Tg,l=>new J2(l));const qn="KHR_materials_variants";class Fx{constructor(e){this.name=qn,this._loader=e,this.enabled=this._loader.isExtensionUsed(qn)}dispose(){this._loader=null}static GetAvailableVariants(e){const i=this._GetExtensionMetadata(e);return i?Object.keys(i.variants):[]}getAvailableVariants(e){return Fx.GetAvailableVariants(e)}static SelectVariant(e,i){const s=this._GetExtensionMetadata(e);if(!s)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${qn} extension`);const n=a=>{const p=s.variants[a];if(p)for(const _ of p)_.mesh.material=_.material};if(i instanceof Array)for(const a of i)n(a);else n(i);s.lastSelected=i}selectVariant(e,i){return Fx.SelectVariant(e,i)}static Reset(e){const i=this._GetExtensionMetadata(e);if(!i)throw new Error(`Cannot reset on a glTF mesh that does not have the ${qn} extension`);for(const s of i.original)s.mesh.material=s.material;i.lastSelected=null}reset(e){return Fx.Reset(e)}static GetLastSelectedVariant(e){const i=this._GetExtensionMetadata(e);if(!i)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${qn} extension`);return i.lastSelected}getLastSelectedVariant(e){return Fx.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){var i,s;return((s=(i=e?._internalMetadata)===null||i===void 0?void 0:i.gltf)===null||s===void 0?void 0:s[qn])||null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const i=e[this.name];this._variants=i.variants}}_loadMeshPrimitiveAsync(e,i,s,n,a,p){return Pt.LoadExtensionAsync(e,a,this.name,(_,g)=>{const y=new Array;return y.push(this._loader._loadMeshPrimitiveAsync(e,i,s,n,a,b=>{if(p(b),b instanceof Qe){const v=Pt._GetDrawMode(e,a.mode),S=this._loader.rootBabylonMesh,M=S?S._internalMetadata=S._internalMetadata||{}:{},F=M.gltf=M.gltf||{},L=F[qn]=F[qn]||{lastSelected:null,original:[],variants:{}};L.original.push({mesh:b,material:b.material});for(let N=0;N<g.mappings.length;++N){const k=g.mappings[N],G=$t.Get(`${_}/mappings/${N}/material`,this._loader.gltf.materials,k.material);y.push(this._loader._loadMaterialAsync(`#/materials/${k.material}`,G,b,v,H=>{for(let z=0;z<k.variants.length;++z){const W=k.variants[z],Y=$t.Get(`/extensions/${qn}/variants/${W}`,this._variants,W);L.variants[Y.name]=L.variants[Y.name]||[],L.variants[Y.name].push({mesh:b,material:H}),b.onClonedObservable.add(Z=>{const Q=Z;let se=null,$=Q;do{if($=$.parent,!$)return;se=Fx._GetExtensionMetadata($)}while(se===null);if(S&&se===Fx._GetExtensionMetadata(S)){$._internalMetadata={};for(const oe in S._internalMetadata)$._internalMetadata[oe]=S._internalMetadata[oe];$._internalMetadata.gltf=[];for(const oe in S._internalMetadata.gltf)$._internalMetadata.gltf[oe]=S._internalMetadata.gltf[oe];$._internalMetadata.gltf[qn]={lastSelected:null,original:[],variants:{}};for(const oe of se.original)$._internalMetadata.gltf[qn].original.push({mesh:oe.mesh,material:oe.material});for(const oe in se.variants)if(Object.prototype.hasOwnProperty.call(se.variants,oe)){$._internalMetadata.gltf[qn].variants[oe]=[];for(const ue of se.variants[oe])$._internalMetadata.gltf[qn].variants[oe].push({mesh:ue.mesh,material:ue.material})}se=$._internalMetadata.gltf[qn]}for(const oe of se.original)oe.mesh===b&&(oe.mesh=Q);for(const oe of se.variants[Y.name])oe.mesh===b&&(oe.mesh=Q)})}}))}}})),Promise.all(y).then(([b])=>b)})}}Pt.RegisterExtension(qn,l=>new Fx(l));class Eg{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:be.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,i){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...Eg._GetDefaultOptions(),...e},this._scene=i,this._scene._transmissionHelper=this,this.onErrorObservable=new Re,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter(a=>this._options[a]!==e[a]).length)return;const s={...this._options,...e},n=this._options;this._options=s,s.renderSize!==n.renderSize||s.renderTargetTextureType!==n.renderTargetTextureType||s.generateMipmaps!==n.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=s.samples,this._opaqueRenderTarget.lodGenerationScale=s.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=s.lodGenerationOffset)}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return e?!!(e instanceof Et&&e.subSurface.isRefractionEnabled):!1}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),Le.SetImmediate(()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,this._transparentMeshesCache.indexOf(e)===-1&&this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.indexOf(e)===-1&&this._opaqueMeshesCache.push(e)})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let i=this._transparentMeshesCache.indexOf(e);i!==-1&&this._transparentMeshesCache.splice(i,1),i=this._opaqueMeshesCache.indexOf(e),i!==-1&&this._opaqueMeshesCache.splice(i,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){const i=this._transparentMeshesCache.indexOf(e),s=this._opaqueMeshesCache.indexOf(e);this._shouldRenderAsTransmission(e.material)?(e.material instanceof Et&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),s!==-1?(this._opaqueMeshesCache.splice(s,1),this._transparentMeshesCache.push(e)):i===-1&&this._transparentMeshesCache.push(e)):i!==-1?(this._transparentMeshesCache.splice(i,1),this._opaqueMeshesCache.push(e)):s===-1&&this._opaqueMeshesCache.push(e)}_setupRenderTargets(){var e,i;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new zn("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=(i=(e=this._options.clearColor)===null||e===void 0?void 0:e.clone())!==null&&i!==void 0?i:this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples;let s,n;this._opaqueRenderTarget.onBeforeBindObservable.add(a=>{n=this._scene.environmentIntensity,this._scene.environmentIntensity=1,s=this._scene.imageProcessingConfiguration.applyByPostProcess,this._options.clearColor?a.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(a.clearColor,this._scene.getEngine().useExactSrgbConversions),this._scene.imageProcessingConfiguration._applyByPostProcess=!0}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=n,this._scene.imageProcessingConfiguration._applyByPostProcess=s}),this._transparentMeshesCache.forEach(a=>{this._shouldRenderAsTransmission(a.material)&&(a.material.refractionTexture=this._opaqueRenderTarget)})}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}}const Ag="KHR_materials_transmission";class WH{constructor(e){this.name=Ag,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ag),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,(n,a)=>{const p=new Array;return p.push(this._loader.loadMaterialBasePropertiesAsync(e,i,s)),p.push(this._loader.loadMaterialPropertiesAsync(e,i,s)),p.push(this._loadTransparentPropertiesAsync(n,i,s,a)),Promise.all(p).then(()=>{})})}_loadTransparentPropertiesAsync(e,i,s,n){if(!(s instanceof Et))throw new Error(`${e}: Material type not supported`);const a=s;if(a.subSurface.isRefractionEnabled=!0,a.subSurface.volumeIndexOfRefraction=1,a.subSurface.useAlbedoToTintRefraction=!0,n.transmissionFactor!==void 0){a.subSurface.refractionIntensity=n.transmissionFactor;const p=a.getScene();a.subSurface.refractionIntensity&&!p._transmissionHelper&&new Eg({},a.getScene())}else return a.subSurface.refractionIntensity=0,a.subSurface.isRefractionEnabled=!1,Promise.resolve();return a.subSurface.minimumThickness=0,a.subSurface.maximumThickness=0,n.transmissionTexture?(n.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,n.transmissionTexture,void 0).then(p=>{a.subSurface.refractionIntensityTexture=p,a.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}Pt.RegisterExtension(Ag,l=>new WH(l));const Cg="KHR_materials_translucency";class zH{constructor(e){this.name=Cg,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(Cg),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,(n,a)=>{const p=new Array;return p.push(this._loader.loadMaterialBasePropertiesAsync(e,i,s)),p.push(this._loader.loadMaterialPropertiesAsync(e,i,s)),p.push(this._loadTranslucentPropertiesAsync(n,i,s,a)),Promise.all(p).then(()=>{})})}_loadTranslucentPropertiesAsync(e,i,s,n){if(!(s instanceof Et))throw new Error(`${e}: Material type not supported`);const a=s;if(a.subSurface.isTranslucencyEnabled=!0,a.subSurface.volumeIndexOfRefraction=1,a.subSurface.minimumThickness=0,a.subSurface.maximumThickness=0,a.subSurface.useAlbedoToTintTranslucency=!0,n.translucencyFactor!==void 0)a.subSurface.translucencyIntensity=n.translucencyFactor;else return a.subSurface.translucencyIntensity=0,a.subSurface.isTranslucencyEnabled=!1,Promise.resolve();return n.translucencyTexture?(n.translucencyTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/translucencyTexture`,n.translucencyTexture).then(p=>{a.subSurface.translucencyIntensityTexture=p})):Promise.resolve()}}Pt.RegisterExtension(Cg,l=>new zH(l));const Rg="KHR_materials_volume";class HH{constructor(e){this.name=Rg,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(Rg),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,(n,a)=>{const p=new Array;return p.push(this._loader.loadMaterialBasePropertiesAsync(e,i,s)),p.push(this._loader.loadMaterialPropertiesAsync(e,i,s)),p.push(this._loadVolumePropertiesAsync(n,i,s,a)),Promise.all(p).then(()=>{})})}_loadVolumePropertiesAsync(e,i,s,n){if(!(s instanceof Et))throw new Error(`${e}: Material type not supported`);if(!s.subSurface.isRefractionEnabled&&!s.subSurface.isTranslucencyEnabled||!n.thicknessFactor)return Promise.resolve();s.subSurface.volumeIndexOfRefraction=s.indexOfRefraction;const a=n.attenuationDistance!==void 0?n.attenuationDistance:Number.MAX_VALUE;return s.subSurface.tintColorAtDistance=a,n.attenuationColor!==void 0&&n.attenuationColor.length==3&&s.subSurface.tintColor.copyFromFloats(n.attenuationColor[0],n.attenuationColor[1],n.attenuationColor[2]),s.subSurface.minimumThickness=0,s.subSurface.maximumThickness=n.thicknessFactor,s.subSurface.useThicknessAsDepth=!0,n.thicknessTexture?(n.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,n.thicknessTexture).then(p=>{s.subSurface.thicknessTexture=p,s.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}Pt.RegisterExtension(Rg,l=>new HH(l));const Ig="KHR_mesh_quantization";class XH{constructor(e){this.name=Ig,this.enabled=e.isExtensionUsed(Ig)}dispose(){}}Pt.RegisterExtension(Ig,l=>new XH(l));const Sg="KHR_texture_basisu";class YH{constructor(e){this.name=Sg,this._loader=e,this.enabled=e.isExtensionUsed(Sg)}dispose(){this._loader=null}_loadTextureAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,(n,a)=>{const p=i.sampler==null?Pt.DefaultSampler:$t.Get(`${e}/sampler`,this._loader.gltf.samplers,i.sampler),_=$t.Get(`${n}/source`,this._loader.gltf.images,a.source);return this._loader._createTextureAsync(e,p,_,g=>{s(g)},i._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!i._textureInfo.nonColorData)})}}Pt.RegisterExtension(Sg,l=>new YH(l));const Mg="KHR_texture_transform";class KH{constructor(e){this.name=Mg,this._loader=e,this.enabled=this._loader.isExtensionUsed(Mg)}dispose(){this._loader=null}loadTextureInfoAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,(n,a)=>this._loader.loadTextureInfoAsync(e,i,p=>{if(!(p instanceof Oe))throw new Error(`${n}: Texture type not supported`);a.offset&&(p.uOffset=a.offset[0],p.vOffset=a.offset[1]),p.uRotationCenter=0,p.vRotationCenter=0,a.rotation&&(p.wAng=-a.rotation),a.scale&&(p.uScale=a.scale[0],p.vScale=a.scale[1]),a.texCoord!=null&&(p.coordinatesIndex=a.texCoord),s(p)}))}}Pt.RegisterExtension(Mg,l=>new KH(l));const Pg="KHR_xmp_json_ld";class jH{constructor(e){this.name=Pg,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(Pg)}dispose(){this._loader=null}onLoading(){var e,i,s;if(this._loader.rootBabylonMesh===null)return;const n=(e=this._loader.gltf.extensions)===null||e===void 0?void 0:e.KHR_xmp_json_ld,a=(s=(i=this._loader.gltf.asset)===null||i===void 0?void 0:i.extensions)===null||s===void 0?void 0:s.KHR_xmp_json_ld;if(n&&a){const p=+a.packet;n.packets&&p<n.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=n.packets[p])}}}Pt.RegisterExtension(Pg,l=>new jH(l));function Wc(l,e,i,s){return qe.FromArray(e,i).scale(s)}function qH(l,e,i,s){return e[i+3]*s}function Gr(l,e,i,s){return e[i]*s}function Og(l,e,i,s){return-e[i]*s}function ef(l,e,i,s){return e[i+1]*s}function gM(l,e,i,s){return e[i]*s*2}function wg(l){return{scale:[new Ir(Ce.ANIMATIONTYPE_FLOAT,`${l}.uScale`,Gr,()=>2),new Ir(Ce.ANIMATIONTYPE_FLOAT,`${l}.vScale`,ef,()=>2)],offset:[new Ir(Ce.ANIMATIONTYPE_FLOAT,`${l}.uOffset`,Gr,()=>2),new Ir(Ce.ANIMATIONTYPE_FLOAT,`${l}.vOffset`,ef,()=>2)],rotation:[new Ir(Ce.ANIMATIONTYPE_FLOAT,`${l}.wAng`,Og,()=>1)]}}class B0 extends _u{buildAnimations(e,i,s,n,a){a(e._babylonCamera,this._buildAnimation(i,s,n))}}class Ir extends _u{buildAnimations(e,i,s,n,a){for(const p in e._data)a(e._data[p].babylonMaterial,this._buildAnimation(i,s,n))}}class yu extends _u{buildAnimations(e,i,s,n,a){a(e._babylonLight,this._buildAnimation(i,s,n))}}const ZH={__array__:{__target__:!0,...gu}},QH={__array__:{__target__:!0,orthographic:{xmag:[new B0(Ce.ANIMATIONTYPE_FLOAT,"orthoLeft",Og,()=>1),new B0(Ce.ANIMATIONTYPE_FLOAT,"orthoRight",ef,()=>1)],ymag:[new B0(Ce.ANIMATIONTYPE_FLOAT,"orthoBottom",Og,()=>1),new B0(Ce.ANIMATIONTYPE_FLOAT,"orthoTop",ef,()=>1)],zfar:[new B0(Ce.ANIMATIONTYPE_FLOAT,"maxZ",Gr,()=>1)],znear:[new B0(Ce.ANIMATIONTYPE_FLOAT,"minZ",Gr,()=>1)]},perspective:{yfov:[new B0(Ce.ANIMATIONTYPE_FLOAT,"fov",Gr,()=>1)],zfar:[new B0(Ce.ANIMATIONTYPE_FLOAT,"maxZ",Gr,()=>1)],znear:[new B0(Ce.ANIMATIONTYPE_FLOAT,"minZ",Gr,()=>1)]}}},$H={__array__:{__target__:!0,pbrMetallicRoughness:{baseColorFactor:[new Ir(Ce.ANIMATIONTYPE_COLOR3,"albedoColor",Wc,()=>4),new Ir(Ce.ANIMATIONTYPE_FLOAT,"alpha",qH,()=>4)],metallicFactor:[new Ir(Ce.ANIMATIONTYPE_FLOAT,"metallic",Gr,()=>1)],roughnessFactor:[new Ir(Ce.ANIMATIONTYPE_FLOAT,"roughness",Gr,()=>1)],baseColorTexture:{extensions:{KHR_texture_transform:wg("albedoTexture")}}},emissiveFactor:[new Ir(Ce.ANIMATIONTYPE_COLOR3,"emissiveColor",Wc,()=>3)],normalTexture:{scale:[new Ir(Ce.ANIMATIONTYPE_FLOAT,"bumpTexture.level",Gr,()=>1)]},occlusionTexture:{strength:[new Ir(Ce.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",Gr,()=>1)],extensions:{KHR_texture_transform:wg("ambientTexture")}},emissiveTexture:{extensions:{KHR_texture_transform:wg("emissiveTexture")}},extensions:{KHR_materials_ior:{ior:[new Ir(Ce.ANIMATIONTYPE_FLOAT,"indexOfRefraction",Gr,()=>1)]},KHR_materials_clearcoat:{clearcoatFactor:[new Ir(Ce.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",Gr,()=>1)],clearcoatRoughnessFactor:[new Ir(Ce.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",Gr,()=>1)]},KHR_materials_sheen:{sheenColorFactor:[new Ir(Ce.ANIMATIONTYPE_COLOR3,"sheen.color",Wc,()=>3)],sheenRoughnessFactor:[new Ir(Ce.ANIMATIONTYPE_FLOAT,"sheen.roughness",Gr,()=>1)]},KHR_materials_specular:{specularFactor:[new Ir(Ce.ANIMATIONTYPE_FLOAT,"metallicF0Factor",Gr,()=>1)],specularColorFactor:[new Ir(Ce.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",Wc,()=>3)]},KHR_materials_emissive_strength:{emissiveStrength:[new Ir(Ce.ANIMATIONTYPE_FLOAT,"emissiveIntensity",Gr,()=>1)]},KHR_materials_transmission:{transmissionFactor:[new Ir(Ce.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",Gr,()=>1)]},KHR_materials_volume:{attenuationColor:[new Ir(Ce.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",Wc,()=>3)],attenuationDistance:[new Ir(Ce.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",Gr,()=>1)],thicknessFactor:[new Ir(Ce.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",Gr,()=>1)]},KHR_materials_iridescence:{iridescenceFactor:[new Ir(Ce.ANIMATIONTYPE_FLOAT,"iridescence.intensity",Gr,()=>1)],iridescenceIor:[new Ir(Ce.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",Gr,()=>1)],iridescenceThicknessMinimum:[new Ir(Ce.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",Gr,()=>1)],iridescenceThicknessMaximum:[new Ir(Ce.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",Gr,()=>1)]}}}},JH={KHR_lights_punctual:{lights:{__array__:{__target__:!0,color:[new yu(Ce.ANIMATIONTYPE_COLOR3,"diffuse",Wc,()=>3)],intensity:[new yu(Ce.ANIMATIONTYPE_FLOAT,"intensity",Gr,()=>1)],range:[new yu(Ce.ANIMATIONTYPE_FLOAT,"range",Gr,()=>1)],spot:{innerConeAngle:[new yu(Ce.ANIMATIONTYPE_FLOAT,"innerAngle",gM,()=>1)],outerConeAngle:[new yu(Ce.ANIMATIONTYPE_FLOAT,"angle",gM,()=>1)]}}}}},eX={nodes:ZH,materials:$H,cameras:QH,extensions:JH},Dg="KHR_animation_pointer";class tX{constructor(e){this.name=Dg,this._loader=e}get enabled(){return this._loader.isExtensionUsed(Dg)}dispose(){this._loader=null}_loadAnimationChannelAsync(e,i,s,n,a){var p;const _=(p=n.target.extensions)===null||p===void 0?void 0:p.KHR_animation_pointer;if(!_)return null;n.target.path!=="pointer"&&Ie.Warn(`${e}/target/path: Value (${n.target.path}) must be (pointer) when using the ${this.name} extension`),n.target.node!=null&&Ie.Warn(`${e}/target/node: Value (${n.target.node}) must not be present when using the ${this.name} extension`);const g=`${e}/extensions/${this.name}`,y=_.pointer;if(!y)throw new Error(`${g}: Pointer is missing`);const b=this._parseAnimationPointer(`${g}/pointer`,y);return b?this._loader._loadAnimationChannelFromTargetInfoAsync(e,i,s,n,b,a):(Ie.Warn(`${g}/pointer: Invalid pointer (${y}) skipped`),null)}_parseAnimationPointer(e,i){if(!i.startsWith("/"))return Ie.Warn(`${e}: Value (${i}) must start with a slash`),null;const s=i.split("/");s.shift();let n=eX,a=this._loader.gltf,p;for(const _ of s){if(n.__array__)n=n.__array__;else if(n=n[_],!n)return null;a=a&&a[_],n.__target__&&(p=a)}return!p||!Array.isArray(n)?null:{target:p,properties:n}}}Pt.RegisterExtension(Dg,l=>new tX(l));class Fg{constructor(e,i,s){this.frame=e,this.action=i,this.onlyOnce=s,this.isDone=!1}_clone(){return new Fg(this.frame,this.action,this.onlyOnce)}}class Rl{get loop(){return this._loop}set loop(e){e!==this._loop&&(this._loop=e,this.updateOptions({loop:e}))}get currentTime(){var e;if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;if(((e=Ae.audioEngine)===null||e===void 0?void 0:e.audioContext)&&(this.isPlaying||this.isPaused)){const i=this.isPaused?0:Ae.audioEngine.audioContext.currentTime-this._startTime;return this._currentTime+i}return 0}get spatialSound(){return this._spatialSound}set spatialSound(e){var i;this._spatialSound=e,this._spatialSound&&((i=Ae.audioEngine)===null||i===void 0?void 0:i.canUseWebAudio)&&Ae.audioEngine.audioContext&&this._createSpatialParameters()}constructor(e,i,s,n=null,a){var p,_,g,y,b;if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new Re,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._currentTime=0,this._position=j.Zero(),this._localDirection=new j(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=e,s=s||Zt.LastCreatedScene,!!s)if(this._scene=s,Rl._SceneComponentInitialization(s),this._readyToPlayCallback=n,this._customAttenuationFunction=(v,S,M,F,L)=>S<M?v*(1-S/M):0,a&&(this.autoplay=a.autoplay||!1,this._loop=a.loop||!1,a.volume!==void 0&&(this._volume=a.volume),this._spatialSound=(p=a.spatialSound)!==null&&p!==void 0?p:!1,this.maxDistance=(_=a.maxDistance)!==null&&_!==void 0?_:100,this.useCustomAttenuation=(g=a.useCustomAttenuation)!==null&&g!==void 0?g:!1,this.rolloffFactor=a.rolloffFactor||1,this.refDistance=a.refDistance||1,this.distanceModel=a.distanceModel||"linear",this._playbackRate=a.playbackRate||1,this._streaming=(y=a.streaming)!==null&&y!==void 0?y:!1,this._length=a.length,this._offset=a.offset),((b=Ae.audioEngine)===null||b===void 0?void 0:b.canUseWebAudio)&&Ae.audioEngine.audioContext){this._soundGain=Ae.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let v=!0;if(i)try{typeof i=="string"?this._urlType="String":i instanceof ArrayBuffer?this._urlType="ArrayBuffer":i instanceof HTMLMediaElement?this._urlType="MediaElement":i instanceof MediaStream?this._urlType="MediaStream":i instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(i)&&(this._urlType="Array");let S=[],M=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=Ae.audioEngine.audioContext.createMediaElementSource(i),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=Ae.audioEngine.audioContext.createMediaStreamSource(i),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":i.byteLength>0&&(M=!0,this._soundLoaded(i));break;case"AudioBuffer":this._audioBufferLoaded(i);break;case"String":S.push(i);case"Array":S.length===0&&(S=i);for(let F=0;F<S.length;F++){const L=S[F];if(M=a&&a.skipCodecCheck||L.indexOf(".mp3",L.length-4)!==-1&&Ae.audioEngine.isMP3supported||L.indexOf(".ogg",L.length-4)!==-1&&Ae.audioEngine.isOGGsupported||L.indexOf(".wav",L.length-4)!==-1||L.indexOf(".m4a",L.length-4)!==-1||L.indexOf(".mp4",L.length-4)!==-1||L.indexOf("blob:")!==-1,M){this._streaming?(this._htmlAudioElement=new Audio(L),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,Le.SetCorsBehavior(L,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback()}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(L,N=>{this._soundLoaded(N)},void 0,!0,!0,N=>{N&&Ie.Error("XHR "+N.status+" error on: "+L+"."),Ie.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)});break}}break;default:v=!1;break}v?M||(this._isReadyToPlay=!0,this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)):Ie.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch{Ie.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),Ae.audioEngine&&!Ae.audioEngine.WarnedWebAudioUnsupported&&(Ie.Error("Web Audio is not supported by your browser."),Ae.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)}dispose(){var e;!((e=Ae.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement)),this._streamingSource&&this._streamingSource.disconnect(),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null))}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}_audioBufferLoaded(e){var i;!(!((i=Ae.audioEngine)===null||i===void 0)&&i.audioContext)||(this._audioBuffer=e,this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback())}_soundLoaded(e){var i;!(!((i=Ae.audioEngine)===null||i===void 0)&&i.audioContext)||Ae.audioEngine.audioContext.decodeAudioData(e,s=>{this._audioBufferLoaded(s)},s=>{Ie.Error("Error while decoding audio data for: "+this.name+" / Error: "+s)})}setAudioBuffer(e){var i;!((i=Ae.audioEngine)===null||i===void 0)&&i.canUseWebAudio&&(this._audioBuffer=e,this._isReadyToPlay=!0)}updateOptions(e){var i,s,n,a,p,_,g,y,b,v;e&&(this.loop=(i=e.loop)!==null&&i!==void 0?i:this.loop,this.maxDistance=(s=e.maxDistance)!==null&&s!==void 0?s:this.maxDistance,this.useCustomAttenuation=(n=e.useCustomAttenuation)!==null&&n!==void 0?n:this.useCustomAttenuation,this.rolloffFactor=(a=e.rolloffFactor)!==null&&a!==void 0?a:this.rolloffFactor,this.refDistance=(p=e.refDistance)!==null&&p!==void 0?p:this.refDistance,this.distanceModel=(_=e.distanceModel)!==null&&_!==void 0?_:this.distanceModel,this._playbackRate=(g=e.playbackRate)!==null&&g!==void 0?g:this._playbackRate,this._length=(y=e.length)!==null&&y!==void 0?y:void 0,this._setOffset((b=e.offset)!==null&&b!==void 0?b:void 0),this.setVolume((v=e.volume)!==null&&v!==void 0?v:this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),this._offset!==void 0&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),this._length!==void 0&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(this._offset|0)+this._length))))}_createSpatialParameters(){var e,i;((e=Ae.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&Ae.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=(i=this._soundPanner)!==null&&i!==void 0?i:Ae.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))}_updateSpatialParameters(){this._spatialSound&&this._soundPanner&&(this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel))}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel()}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel()}_switchPanningModel(){var e;((e=Ae.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)}connectToSoundTrackAudioNode(e){var i;((i=Ae.audioEngine)===null||i===void 0?void 0:i.canUseWebAudio)&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(e),this._isOutputConnected=!0)}setDirectionalCone(e,i,s){if(i<e){Ie.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,this._coneOuterAngle=i,this._coneOuterGain=s,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){var i;if(e!=this._coneInnerAngle){if(this._coneOuterAngle<e){Ie.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,((i=Ae.audioEngine)===null||i===void 0?void 0:i.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){var i;if(e!=this._coneOuterAngle){if(e<this._coneInnerAngle){Ie.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e,((i=Ae.audioEngine)===null||i===void 0?void 0:i.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}}setPosition(e){var i;e.equals(this._position)||(this._position.copyFrom(e),((i=Ae.audioEngine)===null||i===void 0?void 0:i.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))}setLocalDirectionToMesh(e){var i;this._localDirection=e,((i=Ae.audioEngine)===null||i===void 0?void 0:i.canUseWebAudio)&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;const e=this._connectedTransformNode.getWorldMatrix(),i=j.TransformNormal(this._localDirection,e);i.normalize(),this._soundPanner.orientationX.value=i.x,this._soundPanner.orientationY.value=i.y,this._soundPanner.orientationZ.value=i.z}updateDistanceFromListener(){var e;if(((e=Ae.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){const i=this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,i,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(e){this._customAttenuationFunction=e}play(e,i,s){var n,a,p,_;if(this._isReadyToPlay&&this._scene.audioEnabled&&((n=Ae.audioEngine)===null||n===void 0?void 0:n.audioContext))try{let g=e?((a=Ae.audioEngine)===null||a===void 0?void 0:a.audioContext.currentTime)+e:(p=Ae.audioEngine)===null||p===void 0?void 0:p.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this._spatialSound&&this._soundPanner&&(!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(this._streamingSource||(this._streamingSource=Ae.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode),this._htmlAudioElement){const y=()=>{var b,v;if(!((b=Ae.audioEngine)===null||b===void 0)&&b.unlocked){const S=this._htmlAudioElement.play();S!==void 0&&S.catch(()=>{var M,F;(M=Ae.audioEngine)===null||M===void 0||M.lock(),(this.loop||this.autoplay)&&((F=Ae.audioEngine)===null||F===void 0||F.onAudioUnlockedObservable.addOnce(()=>{y()}))})}else(this.loop||this.autoplay)&&((v=Ae.audioEngine)===null||v===void 0||v.onAudioUnlockedObservable.addOnce(()=>{y()}))};y()}}else{const y=()=>{var b,v,S,M;if(!((b=Ae.audioEngine)===null||b===void 0)&&b.audioContext){if(s=s||this._length,i!==void 0&&this._setOffset(i),this._soundSource){const F=this._soundSource;F.onended=()=>{F.disconnect()}}if(this._soundSource=(v=Ae.audioEngine)===null||v===void 0?void 0:v.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,i!==void 0&&(this._soundSource.loopStart=i),s!==void 0&&(this._soundSource.loopEnd=(i|0)+s),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended()},g=e?((S=Ae.audioEngine)===null||S===void 0?void 0:S.audioContext.currentTime)+e:Ae.audioEngine.audioContext.currentTime;const F=((this.isPaused?this.currentTime:0)+((M=this._offset)!==null&&M!==void 0?M:0))%this._soundSource.buffer.duration;this._soundSource.start(g,F,this.loop?void 0:s)}}};((_=Ae.audioEngine)===null||_===void 0?void 0:_.audioContext.state)==="suspended"?setTimeout(()=>{var b;((b=Ae.audioEngine)===null||b===void 0?void 0:b.audioContext.state)==="suspended"?(Ae.audioEngine.lock(),(this.loop||this.autoplay)&&Ae.audioEngine.onAudioUnlockedObservable.addOnce(()=>{y()})):y()},500):y()}this._startTime=g,this.isPlaying=!0,this.isPaused=!1}catch(g){Ie.Error("Error while trying to play audio: "+this.name+", "+g.message)}}_onended(){this.isPlaying=!1,this._startTime=0,this._currentTime=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(e){var i;if(this.isPlaying){if(this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource.disconnect(),this.isPlaying=!1;else if(((i=Ae.audioEngine)===null||i===void 0?void 0:i.audioContext)&&this._soundSource){const s=e?Ae.audioEngine.audioContext.currentTime+e:void 0;this._soundSource.onended=()=>{this.isPlaying=!1,this.isPaused=!1,this._startTime=0,this._currentTime=0,this._soundSource&&(this._soundSource.onended=()=>{}),this._onended()},this._soundSource.stop(s)}}else this.isPaused&&(this.isPaused=!1,this._startTime=0,this._currentTime=0)}pause(){var e;this.isPlaying&&(this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource.disconnect(),this.isPlaying=!1,this.isPaused=!0):((e=Ae.audioEngine)===null||e===void 0?void 0:e.audioContext)&&this._soundSource&&(this._soundSource.onended=()=>{},this._soundSource.stop(),this.isPlaying=!1,this.isPaused=!0,this._currentTime+=Ae.audioEngine.audioContext.currentTime-this._startTime))}setVolume(e,i){var s;((s=Ae.audioEngine)===null||s===void 0?void 0:s.canUseWebAudio)&&this._soundGain&&(i&&Ae.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(Ae.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,Ae.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(e,Ae.audioEngine.audioContext.currentTime+i)):this._soundGain.gain.value=e),this._volume=e}setPlaybackRate(e){this._playbackRate=e,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))}getPlaybackRate(){return this._playbackRate}getVolume(){return this._volume}attachToMesh(e){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=e,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=i=>this._onRegisterAfterWorldMatrixUpdate(i),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(e){var i;if(!e.getBoundingInfo)this.setPosition(e.absolutePosition);else{const n=e.getBoundingInfo();this.setPosition(n.boundingSphere.centerWorld)}((i=Ae.audioEngine)===null||i===void 0?void 0:i.canUseWebAudio)&&this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(this._streaming)return null;{const e=()=>{this._isReadyToPlay?(s._audioBuffer=this.getAudioBuffer(),s._isReadyToPlay=!0,s.autoplay&&s.play(0,this._offset,this._length)):setTimeout(e,300)},i={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},s=new Rl(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,i);return this.useCustomAttenuation&&s.setAttenuationFunction(this._customAttenuationFunction),s.setPosition(this._position),s.setPlaybackRate(this._playbackRate),e(),s}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){const e={name:this.name,url:this.name,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(e.connectedMeshId=this._connectedTransformNode.id),e.position=this._position.asArray(),e.refDistance=this.refDistance,e.distanceModel=this.distanceModel,e.isDirectional=this._isDirectional,e.localDirectionToMesh=this._localDirection.asArray(),e.coneInnerAngle=this._coneInnerAngle,e.coneOuterAngle=this._coneOuterAngle,e.coneOuterGain=this._coneOuterGain),e}static Parse(e,i,s,n){const a=e.name;let p;e.url?p=s+e.url:p=s+a;const _={autoplay:e.autoplay,loop:e.loop,volume:e.volume,spatialSound:e.spatialSound,maxDistance:e.maxDistance,rolloffFactor:e.rolloffFactor,refDistance:e.refDistance,distanceModel:e.distanceModel,playbackRate:e.playbackRate};let g;if(!n)g=new Rl(a,p,i,()=>{i.removePendingData(g)},_),i.addPendingData(g);else{const y=()=>{n._isReadyToPlay?(g._audioBuffer=n.getAudioBuffer(),g._isReadyToPlay=!0,g.autoplay&&g.play(0,g._offset,g._length)):setTimeout(y,300)};g=new Rl(a,new ArrayBuffer(0),i,null,_),y()}if(e.position){const y=j.FromArray(e.position);g.setPosition(y)}if(e.isDirectional&&(g.setDirectionalCone(e.coneInnerAngle||360,e.coneOuterAngle||360,e.coneOuterGain||0),e.localDirectionToMesh)){const y=j.FromArray(e.localDirectionToMesh);g.setLocalDirectionToMesh(y)}if(e.connectedMeshId){const y=i.getMeshById(e.connectedMeshId);y&&g.attachToMesh(y)}return e.metadata&&(g.metadata=e.metadata),g}_setOffset(e){this._offset!==e&&(this.isPaused&&(this.stop(),this.isPaused=!1),this._offset=e)}}Rl._SceneComponentInitialization=l=>{throw xi("AudioSceneComponent")};class iX{constructor(e,i,s){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],i.length!==s.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=s;let n=0;for(const p of s)n+=p;const a=n>0?1/n:0;for(let p=0;p<this._weights.length;p++)this._weights[p]*=a;this._sounds=i;for(const p of this._sounds)p.onEndedObservable.add(()=>{this._onended()})}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e){Ie.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e;for(const i of this._sounds)i.directionalConeInnerAngle=e}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle){Ie.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e;for(const i of this._sounds)i.directionalConeOuterAngle=e}}get volume(){return this._volume}set volume(e){if(e!==this._volume)for(const i of this._sounds)i.setVolume(e)}_onended(){this._currentIndex!==void 0&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPaused=!0,this._currentIndex!==void 0&&this._sounds[this._currentIndex].pause()}stop(){this.isPlaying=!1,this._currentIndex!==void 0&&this._sounds[this._currentIndex].stop()}play(e){if(!this.isPaused){this.stop();const s=Math.random();let n=0;for(let a=0;a<this._weights.length;a++)if(n+=this._weights[a],s<=n){this._currentIndex=a;break}}const i=this._sounds[this._currentIndex];i.isReady()?i.play(0,this.isPaused?void 0:e):i.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}}const Lg="MSFT_audio_emitter";class rX{constructor(e){this.name=Lg,this._loader=e,this.enabled=this._loader.isExtensionUsed(Lg)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const i=e[this.name];this._clips=i.clips,this._emitters=i.emitters,$t.Assign(this._clips),$t.Assign(this._emitters)}}loadSceneAsync(e,i){return Pt.LoadExtensionAsync(e,i,this.name,(s,n)=>{const a=new Array;a.push(this._loader.loadSceneAsync(e,i));for(const p of n.emitters){const _=$t.Get(`${s}/emitters`,this._emitters,p);if(_.refDistance!=null||_.maxDistance!=null||_.rolloffFactor!=null||_.distanceModel!=null||_.innerAngle!=null||_.outerAngle!=null)throw new Error(`${s}: Direction or Distance properties are not allowed on emitters attached to a scene`);a.push(this._loadEmitterAsync(`${s}/emitters/${_.index}`,_))}return Promise.all(a).then(()=>{})})}loadNodeAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,(n,a)=>{const p=new Array;return this._loader.loadNodeAsync(n,i,_=>{for(const g of a.emitters){const y=$t.Get(`${n}/emitters`,this._emitters,g);p.push(this._loadEmitterAsync(`${n}/emitters/${y.index}`,y).then(()=>{for(const b of y._babylonSounds)b.attachToMesh(_),(y.innerAngle!=null||y.outerAngle!=null)&&(b.setLocalDirectionToMesh(j.Forward()),b.setDirectionalCone(2*Le.ToDegrees(y.innerAngle==null?Math.PI:y.innerAngle),2*Le.ToDegrees(y.outerAngle==null?Math.PI:y.outerAngle),0))}))}s(_)}).then(_=>Promise.all(p).then(()=>_))})}loadAnimationAsync(e,i){return Pt.LoadExtensionAsync(e,i,this.name,(s,n)=>this._loader.loadAnimationAsync(e,i).then(a=>{const p=new Array;$t.Assign(n.events);for(const _ of n.events)p.push(this._loadAnimationEventAsync(`${s}/events/${_.index}`,e,i,_,a));return Promise.all(p).then(()=>a)}))}_loadClipAsync(e,i){if(i._objectURL)return i._objectURL;let s;if(i.uri)s=this._loader.loadUriAsync(e,i,i.uri);else{const n=$t.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,i.bufferView);s=this._loader.loadBufferViewAsync(`/bufferViews/${n.index}`,n)}return i._objectURL=s.then(n=>URL.createObjectURL(new Blob([n],{type:i.mimeType}))),i._objectURL}_loadEmitterAsync(e,i){if(i._babylonSounds=i._babylonSounds||[],!i._babylonData){const s=new Array,n=i.name||`emitter${i.index}`,a={loop:!1,autoplay:!1,volume:i.volume==null?1:i.volume};for(let _=0;_<i.clips.length;_++){const g=`/extensions/${this.name}/clips`,y=$t.Get(g,this._clips,i.clips[_].clip);s.push(this._loadClipAsync(`${g}/${i.clips[_].clip}`,y).then(b=>{const v=i._babylonSounds[_]=new Rl(n,b,this._loader.babylonScene,null,a);v.refDistance=i.refDistance||1,v.maxDistance=i.maxDistance||256,v.rolloffFactor=i.rolloffFactor||1,v.distanceModel=i.distanceModel||"exponential"}))}const p=Promise.all(s).then(()=>{const _=i.clips.map(y=>y.weight||1),g=new iX(i.loop||!1,i._babylonSounds,_);i.innerAngle&&(g.directionalConeInnerAngle=2*Le.ToDegrees(i.innerAngle)),i.outerAngle&&(g.directionalConeOuterAngle=2*Le.ToDegrees(i.outerAngle)),i.volume&&(g.volume=i.volume),i._babylonData.sound=g});i._babylonData={loaded:p}}return i._babylonData.loaded}_getEventAction(e,i,s,n,a){switch(s){case"play":return p=>{const _=(a||0)+(p-n);i.play(_)};case"stop":return()=>{i.stop()};case"pause":return()=>{i.pause()};default:throw new Error(`${e}: Unsupported action ${s}`)}}_loadAnimationEventAsync(e,i,s,n,a){if(a.targetedAnimations.length==0)return Promise.resolve();const p=a.targetedAnimations[0],_=n.emitter,g=$t.Get(`/extensions/${this.name}/emitters`,this._emitters,_);return this._loadEmitterAsync(e,g).then(()=>{const y=g._babylonData.sound;if(y){const b=new Fg(n.time,this._getEventAction(e,y,n.action,n.time,n.startOffset));p.animation.addEvent(b),a.onAnimationGroupEndObservable.add(()=>{y.stop()}),a.onAnimationGroupPauseObservable.add(()=>{y.pause()})}})}}Pt.RegisterExtension(Lg,l=>new rX(l));const Ng="MSFT_lod";class sX{constructor(e){this.name=Ng,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new Re,this.onMaterialLODsLoadedObservable=new Re,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ng)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){const i=Promise.all(this._nodePromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())});this._loader._completePromises.push(i)}for(let e=0;e<this._materialPromiseLODs.length;e++){const i=Promise.all(this._materialPromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())});this._loader._completePromises.push(i)}}loadSceneAsync(e,i){const s=this._loader.loadSceneAsync(e,i);return this._loadBufferLOD(this._bufferLODs,0),s}loadNodeAsync(e,i,s){return Pt.LoadExtensionAsync(e,i,this.name,(n,a)=>{let p;const _=this._getLODs(n,i,this._loader.gltf.nodes,a.ids);this._loader.logOpen(`${n}`);for(let g=0;g<_.length;g++){const y=_[g];g!==0&&(this._nodeIndexLOD=g,this._nodeSignalLODs[g]=this._nodeSignalLODs[g]||new mu);const b=S=>{s(S),S.setEnabled(!1)},v=this._loader.loadNodeAsync(`/nodes/${y.index}`,y,b).then(S=>{if(g!==0){const M=_[g-1];M._babylonTransformNode&&(this._disposeTransformNode(M._babylonTransformNode),delete M._babylonTransformNode)}return S.setEnabled(!0),S});this._nodePromiseLODs[g]=this._nodePromiseLODs[g]||[],g===0?p=v:(this._nodeIndexLOD=null,this._nodePromiseLODs[g].push(v))}return this._loader.logClose(),p})}_loadMaterialAsync(e,i,s,n,a){return this._nodeIndexLOD?null:Pt.LoadExtensionAsync(e,i,this.name,(p,_)=>{let g;const y=this._getLODs(p,i,this._loader.gltf.materials,_.ids);this._loader.logOpen(`${p}`);for(let b=0;b<y.length;b++){const v=y[b];b!==0&&(this._materialIndexLOD=b);const S=this._loader._loadMaterialAsync(`/materials/${v.index}`,v,s,n,M=>{b===0&&a(M)}).then(M=>{if(b!==0){a(M);const F=y[b-1]._data;F[n]&&(this._disposeMaterials([F[n].babylonMaterial]),delete F[n])}return M});this._materialPromiseLODs[b]=this._materialPromiseLODs[b]||[],b===0?g=S:(this._materialIndexLOD=null,this._materialPromiseLODs[b].push(S))}return this._loader.logClose(),g})}_loadUriAsync(e,i,s){if(this._nodeIndexLOD!==null){this._loader.log("deferred");const n=this._nodeIndexLOD-1;return this._nodeSignalLODs[n]=this._nodeSignalLODs[n]||new mu,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(()=>this._loader.loadUriAsync(e,i,s))}else if(this._materialIndexLOD!==null){this._loader.log("deferred");const n=this._materialIndexLOD-1;return this._materialSignalLODs[n]=this._materialSignalLODs[n]||new mu,this._materialSignalLODs[n].promise.then(()=>this._loader.loadUriAsync(e,i,s))}return null}loadBufferAsync(e,i,s,n){if(this._loader.parent.useRangeRequests&&!i.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);const a=(p,_)=>{const g=s,y=g+n-1;let b=p[_];return b?(b.start=Math.min(b.start,g),b.end=Math.max(b.end,y)):(b={start:g,end:y,loaded:new mu},p[_]=b),b.loaded.promise.then(v=>new Uint8Array(v.buffer,v.byteOffset+s-b.start,n))};return this._loader.log("deferred"),this._nodeIndexLOD!==null?a(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?a(this._materialBufferLODs,this._materialIndexLOD):a(this._bufferLODs,0)}return null}_loadBufferLOD(e,i){const s=e[i];s&&(this._loader.log(`Loading buffer range [${s.start}-${s.end}]`),this._loader.bin.readAsync(s.start,s.end-s.start+1).then(n=>{s.loaded.resolve(n)},n=>{s.loaded.reject(n)}))}_getLODs(e,i,s,n){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");const a=new Array;for(let p=n.length-1;p>=0;p--)if(a.push($t.Get(`${e}/ids/${n[p]}`,s,n[p])),a.length===this.maxLODsToLoad)return a;return a.push(i),a}_disposeTransformNode(e){const i=new Array,s=e.material;s&&i.push(s);for(const a of e.getChildMeshes())a.material&&i.push(a.material);e.dispose();const n=i.filter(a=>this._loader.babylonScene.meshes.every(p=>p.material!=a));this._disposeMaterials(n)}_disposeMaterials(e){const i={};for(const s of e){for(const n of s.getActiveTextures())i[n.uniqueId]=n;s.dispose()}for(const s in i)for(const n of this._loader.babylonScene.materials)n.hasTexture(i[s])&&delete i[s];for(const s in i)i[s].dispose()}}Pt.RegisterExtension(Ng,l=>new sX(l));const Bg="MSFT_minecraftMesh";class nX{constructor(e){this.name=Bg,this._loader=e,this.enabled=this._loader.isExtensionUsed(Bg)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,i,s){return Pt.LoadExtraAsync(e,i,this.name,(n,a)=>{if(a){if(!(s instanceof Et))throw new Error(`${n}: Material type not supported`);const p=this._loader.loadMaterialPropertiesAsync(e,i,s);return s.needAlphaBlending()&&(s.forceDepthWrite=!0,s.separateCullingPass=!0),s.backFaceCulling=s.forceDepthWrite,s.twoSidedLighting=!0,p}return null})}}Pt.RegisterExtension(Bg,l=>new nX(l));const kg="MSFT_sRGBFactors";class aX{constructor(e){this.name=kg,this._loader=e,this.enabled=this._loader.isExtensionUsed(kg)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,i,s){return Pt.LoadExtraAsync(e,i,this.name,(n,a)=>{if(a){if(!(s instanceof Et))throw new Error(`${n}: Material type not supported`);const p=this._loader.loadMaterialPropertiesAsync(e,i,s),_=s.getScene().getEngine().useExactSrgbConversions;return s.albedoTexture||s.albedoColor.toLinearSpaceToRef(s.albedoColor,_),s.reflectivityTexture||s.reflectivityColor.toLinearSpaceToRef(s.reflectivityColor,_),p}return null})}}Pt.RegisterExtension(kg,l=>new aX(l));const yM="ExtrasAsMetadata";class oX{_assignExtras(e,i){if(i.extras&&Object.keys(i.extras).length>0){const s=e.metadata=e.metadata||{},n=s.gltf=s.gltf||{};n.extras=i.extras}}constructor(e){this.name=yM,this.enabled=!0,this._loader=e}dispose(){this._loader=null}loadNodeAsync(e,i,s){return this._loader.loadNodeAsync(e,i,n=>{this._assignExtras(n,i),s(n)})}loadCameraAsync(e,i,s){return this._loader.loadCameraAsync(e,i,n=>{this._assignExtras(n,i),s(n)})}createMaterial(e,i,s){const n=this._loader.createMaterial(e,i,s);return this._assignExtras(n,i),n}}Pt.RegisterExtension(yM,l=>new oX(l));class xX extends OW{constructor(e,i,s,n="onesie.glb",a){super(e,i,s),this.url=n,this.outfit=a,this.plugin=new kW(void 0,a),this.addPlugin(this.plugin)}plugin;model;light;ambient;lightInt=.5;ambientInt=.5;handsUp=!1;textModel;async load(){if(!(this.loaded||!this.scene))return await this.setupScene(this.scene),super.load()}async setupScene(e){await this.setModel(this.url),this.light=new Fc("pointLight",new j(0,0,0),e),this.light.intensity=this.lightInt,this.light.diffuse=new qe(1,1,1),this.light.specular=new qe(1,1,1),this.ambient=new P0("ambientLight",new j(0,1,0),e),this.ambient.intensity=this.ambientInt,this.ambient.diffuse=new qe(1,1,1),this.ambient.specular=new qe(1,1,1),this.ambient.groundColor=new qe(1,1,1),e.createDefaultEnvironment({createSkybox:!1,environmentTexture:"environment.env"}),e.clearColor=new pi(0,0,0,0),e.ambientColor=new qe(1,1,1);const i=await ki.LoadAssetContainerAsync("./","text.glb",e),s=i.meshes.find(n=>n.id==="Text");s&&(s.scaling.setAll(.075),s.rotate(j.Up(),Math.PI),s.rotate(j.Right(),Math.PI/2)),this.textModel=i.meshes.find(n=>n.id==="__root__"),i.addAllToScene()}async setModel(e){return this.setOutfit(e,this.outfit)}async setOutfit(e,i){this.model&&(this.scene?.removeMesh(this.model,!0),this.model.dispose(!0,!0)),delete this.model,this.url=e,this.outfit=i;const s=await ki.LoadAssetContainerAsync("",e,this.scene,void 0,".glb");this.model=s.meshes.find(n=>n.id==="__root__"),s.addAllToScene(),this.plugin.setOutfit(this.model,i)}async update(e,i){const s=e.poses&&e.poses.length>0?e.poses[0]:void 0;if(!s)return this.handsUp=!1,super.update(e,i);const{points:n}=s,a=new j(...n.hipL.metric),p=new j(...n.hipR.metric),_=new j(...n.shoulderL.metric),g=new j(...n.shoulderR.metric),y=new j(...n.elbowL.metric),b=new j(...n.elbowR.metric),v=new j(...n.wristL.metric),S=new j(...n.wristR.metric),M=_.subtract(a).normalize(),F=g.subtract(p).normalize(),L=y.subtract(_).normalize(),N=b.subtract(g).normalize(),k=v.subtract(y).normalize(),G=S.subtract(b).normalize(),H=j.Dot(M,L),z=j.Dot(F,N),W=j.Dot(k,L),Y=j.Dot(G,N),Z=Math.min(H,z,W,Y);Z>.8&&(this.handsUp=!0),Z<.7&&(this.handsUp=!1);const{textModel:Q}=this;if(Q){const se=j.Lerp(v,S,.5);Q.position=se,Q.setEnabled(this.handsUp)}await super.update(e,i)}}const zc=new K7;var bM=location.hostname==="localhost"?"l8vd8BEZ0y2AwDOZJ8JoiGt0JI8YN_jx":"0Z5FsOvFh_eUMORg00J167xogPRSut5c";const vM=new URLSearchParams(window.location.search);let Hc=vM.has("rear"),lX=vM.get("id");var Qo={data:{file:"https://ahmedlotfysuits.com/storage/app/public/product/suit-files/2023-10-30-653fff90f00df.glp",avatar:!1,outfit:{occluders:[/Head$/,/Body/]}}};let Lx="data",Il=Qo.data.avatar;function TM(){const l=document.createElement("div");l.className="spinner-container",l.id="spinner";const e=document.createElement("div");e.className="spinner";for(let i=0;i<6;i++){const s=document.createElement("div");s.className="spinner-dot",e.appendChild(s)}return l.appendChild(e),l}async function cX(){const l=document.getElementById("root");if(!l)return;const e=new xX(l,"crop",!Hc,Qo[Lx].file,Il?void 0:Qo[Lx].outfit),i=document.getElementById("camera-switch");i&&(i.onclick=async()=>{i.disabled=!0,Hc=!Hc,await zc.setup({size:{width:1920,height:1080},rear:Hc}),await zc.start(),e.setMirror(!Hc),i.disabled=!1});const s=document.getElementById("outfit-switch");s.checked=Il,s.onchange=async()=>{g.forEach(b=>{b.disabled=!0}),s.disabled=!0;const y=TM();document.body.appendChild(y),Il=s.checked,await e.setOutfit(Qo[Lx].file,Il?void 0:Qo[Lx].outfit),document.body.removeChild(y),g.forEach(b=>{b.disabled=!1}),s.disabled=!1};const a=navigator.userAgent.indexOf("Safari")>-1&&navigator.userAgent.indexOf("Chrome")<=-1?"mp4":"webm",p=new N7(e,"video/"+a),_=document.getElementById("record");_&&(_.onclick=()=>{p?.start(),setTimeout(async()=>{const y=await p?.stop();if(!y)return;const b=URL.createObjectURL(y),v=document.createElement("a");v.hidden=!0,v.href=b,v.download="capture."+a,v.click(),v.remove(),URL.revokeObjectURL(b)},1e4)});const g=document.getElementsByName("model");g.forEach(y=>{y.onchange=async()=>{if(y.checked&&Qo[y.value]){g.forEach(v=>{v.disabled=!0}),s.disabled=!0;const b=TM();document.body.appendChild(b),Lx=y.value,Il=Qo[Lx].avatar,await e.setOutfit(Qo[Lx].file,Il?void 0:Qo[Lx].outfit),s.checked=Il,document.body.removeChild(b),g.forEach(v=>{v.disabled=!1}),s.disabled=!1}}}),await Promise.all([zc.addRenderer(e),zc.init({token:bM})]),await zc.setup({size:{width:1920,height:1080},rear:Hc}),await zc.start(),document.getElementById("dots")?.remove()}var Ug={file:"",token:""};fetch("https://ahmedlotfysuits.com/api/v4/token_with_file/"+lX).then(l=>l.json()).then(l=>Ug=l).then(()=>{Qo.data={file:Ug.file,avatar:!1,outfit:{occluders:[/Head$/,/Body/]}},bM=Ug.token,cX()})})()})();
