import{SceneRenderer as d,ScenePlugin as Y,CanvasRenderer as E,ShaderPlugin as c,ShaderRenderer as h,ImageTexture as f}from'@geenee/armature';import{Engine as R}from'@babylonjs/core/Engines/engine';import{Scene as r}from'@babylonjs/core/scene';import{UniversalCamera as u}from'@babylonjs/core/Cameras/universalCamera';import{Vector3 as T,Quaternion as B}from'@babylonjs/core/Maths/math.vector';import{Color4 as A,Color3 as P}from'@babylonjs/core/Maths/math.color';import{Layer as i}from'@babylonjs/core/Layers/layer';import{BaseTexture as z}from'@babylonjs/core/Materials/Textures/baseTexture';import{meshReference as w,meshTriangles as o,meshUV as D}from'@geenee/bodytracking';import{VertexData as m}from'@babylonjs/core/Meshes/mesh.vertexData';import{VertexBuffer as O}from'@babylonjs/core/Buffers/buffer';import{TransformNode as x}from'@babylonjs/core/Meshes/transformNode';import{DilationShader as t}from'@geenee/bodyrenderers-common';import{RenderTargetTexture as K}from'@babylonjs/core/Materials/Textures/renderTargetTexture';import{StandardMaterial as V}from'@babylonjs/core/Materials/standardMaterial';import{AbstractMesh as X}from'@babylonjs/core/Meshes/abstractMesh';import{PBRMaterial as I}from'@babylonjs/core/Materials/PBR/pbrMaterial';var b=Object['defineProperty'],g=(dD,dm,dS)=>dm in dD?b(dD,dm,{'enumerable':!0x0,'configurable':!0x0,'writable':!0x0,'value':dS}):dD[dm]=dS,e=(dD,dm,dS)=>(g(dD,typeof dm!='symbol'?dm+'':dm,dS),dS);class W extends d{constructor(dD,dm,dS){super({'container':dD,'mode':dm,'layerCount':0x2,'mirror':dS}),e(this,'renderer'),e(this,'camera'),e(this,'cameraAngle',0xa/0xb4*Math['PI']);const dO=this['canvas']['layers'][0x1];this['renderer']=new R(dO,!0x0,{'alpha':!0x0,'preserveDrawingBuffer':!0x0},!0x0);const dx=window['devicePixelRatio'];this['renderer']['setSize'](dO['clientWidth']*dx,dO['clientHeight']*dx),this['canvas']['on']('resize',()=>{this['renderer']['setSize'](dO['clientWidth']*dx,dO['clientHeight']*dx);}),this['scene']=new r(this['renderer']),this['scene']['useRightHandedSystem']=!0x0,this['scene']['clearColor']=new A(0x0,0x0,0x0,0x0),this['camera']=new u('camera',new T(0x0,0x0,0x0),this['scene']),this['camera']['rotationQuaternion']=new B(0x1,0x0,0x0,0x0),this['camera']['fov']=this['cameraAngle'],this['camera']['minZ']=0.02,this['camera']['maxZ']=0x14;}['updateScene'](){var dD;(dD=this['scene'])==null||dD['render']();}['dispose'](){var dD;this['renderer']['dispose'](),this['camera']['dispose'](),(dD=this['scene'])==null||dD['dispose'](),super['dispose']();}['setupCamera'](dD,dm){super['setupCamera'](dD,dm),this['camera']['fov']=this['cameraAngle'],this['camera']['getProjectionMatrix'](!0x0);}}class J extends Y{}class s extends J{}class U extends J{}var p=Object['defineProperty'],n=(dD,dm,dS)=>dm in dD?p(dD,dm,{'enumerable':!0x0,'configurable':!0x0,'writable':!0x0,'value':dS}):dD[dm]=dS,L=(dD,dm,dS)=>(n(dD,typeof dm!='symbol'?dm+'':dm,dS),dS);class j extends d{constructor(dD,dm,dS){super({'container':dD,'mode':dm,'layerCount':0x1,'mirror':dS}),L(this,'renderer'),L(this,'layer'),L(this,'camera'),L(this,'cameraAngle',0xa/0xb4*Math['PI']);const dO=this['canvas']['layers'][0x0];this['renderer']=new R(dO,!0x0,{'alpha':!0x0,'preserveDrawingBuffer':!0x0},!0x0);const dx=window['devicePixelRatio'];this['renderer']['setSize'](dO['clientWidth']*dx,dO['clientHeight']*dx),this['canvas']['on']('resize',()=>{this['renderer']['setSize'](dO['clientWidth']*dx,dO['clientHeight']*dx);}),this['scene']=new r(this['renderer']),this['scene']['useRightHandedSystem']=!0x0,this['scene']['clearColor']=new A(0x0,0x0,0x0,0x0),this['camera']=new u('camera',new T(0x0,0x0,0x0),this['scene']),this['camera']['rotationQuaternion']=new B(0x1,0x0,0x0,0x0),this['camera']['fov']=this['cameraAngle'],this['camera']['minZ']=0.02,this['camera']['maxZ']=0x14,this['layer']=new i('video',null,this['scene'],!0x0);}['updateVideo'](dD){var dm;if(!this['current']||!this['shader'])return;this['shader']['process']([this['current']],{'flip':[0x1]});const dS=(dm=this['shader']['output'])==null?void 0x0:dm['texture']();return dS&&(this['layer']['texture']=new z(this['scene'],this['renderer']['wrapWebGLTexture'](dS))),E['prototype']['updateVideo']['call'](this,dD);}['updateScene'](){var dD;(dD=this['scene'])==null||dD['render']();}['dispose'](){var dD;this['layer']['dispose'](),this['camera']['dispose'](),(dD=this['scene'])==null||dD['dispose'](),this['renderer']['dispose'](),super['dispose']();}['setupVideo'](dD,dm){var dS,dO;E['prototype']['setupVideo']['call'](this,dD,dm);const {width:dx,height:dt}=this['videoSize'];(dS=this['input'])==null||dS['resize']({'width':dx,'height':dt}),(dO=this['shader'])==null||dO['resize']({'width':dx,'height':dt});}['setupCamera'](dD,dm){super['setupCamera'](dD,dm),this['camera']['fov']=this['cameraAngle'],this['camera']['getProjectionMatrix'](!0x0);}}class l extends j{}class k extends j{}class v extends J{constructor(dD,dm=!0x1){super(),this['node']=dD,this['shapeScale']=dm;}async['update'](dD,dm){if(!this['loaded'])return;const dS=dD['faces']&&dD['faces']['length']>0x0?dD['faces'][0x0]['transform']:void 0x0;if(!dS)return this['node']['setEnabled'](!0x1),super['update'](dD,dm);const dO=T['FromArray'](dS['translation']),dx=new T()['setAll'](dS['scale']),dt=T['FromArray'](dS['shapeScale'])['scale'](dS['scale']),dK=B['FromArray'](dS['rotation']);return this['node']['setEnabled'](!0x0),this['node']['rotationQuaternion']=dK,this['node']['position']=dO,this['node']['scaling']=this['shapeScale']?dt:dx,super['update'](dD,dm);}}class F extends J{constructor(dD,dm=0x0,dS=!0x1){super(),this['node']=dD,this['facePoint']=dm,this['shapeScale']=dS;}async['update'](dD,dm){if(!this['loaded'])return;const {transform:dS=void 0x0,metric:dO=void 0x0}=dD['faces']&&dD['faces']['length']>0x0?dD['faces'][0x0]:{};if(!dS||!dO)return this['node']['setEnabled'](!0x1),super['update'](dD,dm);const dx=T['FromArray'](dO[this['facePoint']]),dt=new T()['setAll'](dS['scale']),dK=T['FromArray'](dS['shapeScale'])['scale'](dS['scale']),dV=B['FromArray'](dS['rotation']);return this['node']['setEnabled'](!0x0),this['node']['rotationQuaternion']=dV,this['node']['position']=dx,this['node']['scaling']=this['shapeScale']?dK:dt,super['update'](dD,dm);}}var q=Object['defineProperty'],d0=(dD,dm,dS)=>dm in dD?q(dD,dm,{'enumerable':!0x0,'configurable':!0x0,'writable':!0x0,'value':dS}):dD[dm]=dS,d1=(dD,dm,dS)=>(d0(dD,typeof dm!='symbol'?dm+'':dm,dS),dS);class d2 extends J{constructor(dD){super(),this['mesh']=dD,d1(this,'pointCont',w['length']);}async['load'](dD){this['loaded']||(await super['load'](dD),await this['setMesh'](this['mesh']));}async['update'](dD,dm){var dS;if(!this['loaded'])return;const dO=dD['faces']&&dD['faces']['length']>0x0?dD['faces'][0x0]['metric']:void 0x0;return!dO||!this['mesh']?((dS=this['mesh'])==null||dS['setEnabled'](!0x1),super['update'](dD,dm)):(this['mesh']['setEnabled'](!0x0),this['mesh']['updateVerticesData'](O['PositionKind'],dO['slice'](0x0,this['pointCont'])['flat']()),super['update'](dD,dm));}async['setMesh'](dD){if(delete this['mesh'],this['mesh']=dD,!(!this['loaded']||!dD)){var dm=new m();dm['positions']=w['flat'](),dm['indices']=o['flat'](),dm['uvs']=D['flat'](),dm['normals']=[],m['ComputeNormals'](dm['positions'],dm['indices'],dm['normals']),dm['applyToMesh'](dD,!0x0),dD['renderingGroupId']=0x1;}}}var d3=Object['defineProperty'],d4=(dD,dm,dS)=>dm in dD?d3(dD,dm,{'enumerable':!0x0,'configurable':!0x0,'writable':!0x0,'value':dS}):dD[dm]=dS,d5=(dD,dm,dS)=>(d4(dD,typeof dm!='symbol'?dm+'':dm,dS),dS);class d6 extends s{constructor(dD,dm={'spineCurve':0.5,'neckAdjust':0.01,'headRatio':0.32,'shoulderDY':-0.01,'shoulderDZ':0.005}){super(),this['node']=dD,this['tune']=dm,d5(this,'skeleton'),d5(this,'skeletonNodes'),d5(this,'spineCurve'),d5(this,'avatarLength',0x1),d5(this,'alignScore',0.9),d5(this,'alignVisibility',0.9);}async['load'](dD){this['loaded']||(await super['load'](dD),await this['setNode'](this['node']));}['unload'](){this['loaded']&&(delete this['node'],delete this['skeletonNodes'],delete this['skeleton'],delete this['spineCurve'],super['unload']());}['setNode'](dD){var dm,dS;if(delete this['skeletonNodes'],delete this['skeleton'],delete this['spineCurve'],this['node']=dD,!this['loaded']||!dD)return;this['skeleton']=((dm=dD['getChildMeshes'](!0x1)['find'](dC=>dC['skeleton']))==null?void 0x0:dm['skeleton'])||void 0x0;const dO=(dS=this['skeleton'])==null?void 0x0:dS['bones'];if(!dO)return;const dx=dC=>{var dM;return(dM=dO['find'](Y0=>Y0['name']['toLowerCase']()['endsWith'](dC)))==null?void 0x0:dM['getTransformNode']();},dt={'hips':dx('hips'),'spine':dx('spine'),'spine1':dx('spine1'),'spine2':dx('spine2'),'neck':dx('neck'),'head':dx('head'),'headEnd':dx('headtop_end'),'shoulderL':dx('leftshoulder'),'shoulderR':dx('rightshoulder'),'armL':dx('leftarm'),'armR':dx('rightarm'),'foreArmL':dx('leftforearm'),'foreArmR':dx('rightforearm'),'handL':dx('lefthand'),'handR':dx('righthand'),'upLegL':dx('leftupleg'),'upLegR':dx('rightupleg'),'legL':dx('leftleg'),'legR':dx('rightleg'),'footL':dx('leftfoot'),'footR':dx('rightfoot'),'toeL':dx('lefttoebase'),'toeR':dx('righttoebase')};this['skeletonNodes']=dt;const dK=dt['hips']['absolutePosition'],dV=dt['armL']['absolutePosition'],dX=dt['armR']['absolutePosition'],dI=T['Lerp'](dV,dX,0.5)['subtract'](dK)['length'](),db=dV['subtract'](dK),dg=dX['subtract'](dK)['cross'](db)['normalize'](),de=dt['spine']['absolutePosition']['subtract'](dK),dW=T['Dot'](de,dg),dJ=de['subtract'](dg['scale'](dW))['length'](),ds=dt['spine1']['absolutePosition']['subtract'](dK),dU=T['Dot'](ds,dg),dp=ds['subtract'](dg['scale'](dU))['length'](),dn=dt['spine2']['absolutePosition']['subtract'](dK),da=T['Dot'](dn,dg),dL=dn['subtract'](dg['scale'](da))['length'](),dH=dt['head']['absolutePosition'],dj=dt['headEnd']['absolutePosition']['subtract'](dH)['length']();this['avatarLength']=dI,this['spineCurve']={'hips':[dK['x'],dK['y']],'spine':[dJ/dI,dW/dI],'spine1':[dp/dI,dU/dI],'spine2':[dL/dI,da/dI],'head':[dj/dI,0x0]};let {min:dl,max:dk}=dD['getHierarchyBoundingVectors']();const dv=dl['add'](dk)['scale'](0.5),dF=dk['subtract'](dl),dQ=Math['max'](dF['x'],dF['y'],dF['z'])*1.1*0.5,dq=new T(dQ,dQ,dQ);dl=dv['subtract'](dq),dk=dv['add'](dq),dD['getChildMeshes'](!0x1)['forEach'](dC=>{dC['buildBoundingInfo'](dl,dk);});}async['update'](dD,dm){var dS,dO;if(!this['loaded'])return;const dx=dD['poses']&&dD['poses']['length']>0x0?dD['poses'][0x0]['points']:void 0x0,{node:dt,skeletonNodes:dK,spineCurve:dV}=this;if(!dK||!dV||!dx||!dt)return dt==null||dt['setEnabled'](!0x1),super['update'](dD,dm);dt['setEnabled'](!0x0);const dX=this['estimateBones'](dx,dV),dI=((dS=this['spineCurve'])==null?void 0x0:dS['hips'])||[0x0,0x1],db=dX['hips']['rotation'],dg=dX['hips']['position']['add'](new T(-dI[0x0],-dI[0x1],0x0)['applyRotationQuaternionInPlace'](db));return this['alignBone']({'position':dg,'rotation':db},dt),(dO=this['skeleton'])==null||dO['returnToRest'](),this['updateSpine'](dX),this['updateHandL'](dX,dx),this['updateHandR'](dX,dx),this['updateLegL'](dX,dx),this['updateLegR'](dX,dx),super['update'](dD,dm);}['updateSpine'](dD){var dm;const {skeletonNodes:dS}=this;if(!dS)return;this['alignBone'](dD['hips'],dS['hips'],!0x1),this['alignBone'](dD['spine'],dS['spine']),this['alignBone'](dD['spine1'],dS['spine1']),this['alignBone'](dD['spine2'],dS['spine2']),this['alignBone'](dD['neck'],dS['neck'],!0x1),this['alignBone'](dD['head'],dS['head'],!0x1);const dO=(dm=this['skeleton'])==null?void 0x0:dm['bones']['find'](dx=>dx['name']['endsWith']('HeadEnd'));if(dO){const {head:dx,headEnd:dt}=dD,dK=dt['position']['subtract'](dx['position'])['length']();dS['head']['scaling']['setAll'](1.05*dK/dO['position']['length']());}this['alignBone'](dD['shoulderL'],dS['shoulderL'],!0x1),this['alignBone'](dD['shoulderR'],dS['shoulderR'],!0x1);}['updateHandL'](dD,dm){const {skeletonNodes:dS}=this;if(!dS)return;const {alignScore:dO,alignVisibility:dx}=this;this['alignBone'](dD['armL'],dS['armL']),!(dm['elbowL']['score']<dO&&dm['elbowL']['visibility']<dx)&&(this['alignBone'](dD['foreArmL'],dS['foreArmL']),this['alignBone'](dD['handL'],dS['handL']),dS['handL']['scaling']['setAll'](0.95));}['updateHandR'](dD,dm){const {skeletonNodes:dS}=this;if(!dS)return;const {alignScore:dO,alignVisibility:dx}=this;this['alignBone'](dD['armR'],dS['armR']),!(dm['elbowR']['score']<dO&&dm['elbowR']['visibility']<dx)&&(this['alignBone'](dD['foreArmR'],dS['foreArmR']),this['alignBone'](dD['handR'],dS['handR']),dS['handR']['scaling']['setAll'](0.95));}['updateLegL'](dD,dm){const {skeletonNodes:dS}=this;if(!dS)return;const {alignScore:dO,alignVisibility:dx}=this;dm['hipL']['score']<dO&&dm['hipL']['visibility']<dx||(this['alignBone'](dD['upLegL'],dS['upLegL'],!0x1),!(dm['kneeL']['score']<dO&&dm['kneeL']['visibility']<dx)&&(this['alignBone'](dD['legL'],dS['legL']),!(dm['ankleL']['score']<dO&&dm['ankleL']['visibility']<dx)&&(this['alignBone'](dD['footL'],dS['footL']),this['alignBone'](dD['toeL'],dS['toeL']))));}['updateLegR'](dD,dm){const {skeletonNodes:dS}=this;if(!dS)return;const {alignScore:dO,alignVisibility:dx}=this;dm['hipR']['score']<dO&&dm['hipR']['visibility']<dx||(this['alignBone'](dD['upLegR'],dS['upLegR'],!0x1),!(dm['kneeR']['score']<dO&&dm['kneeR']['visibility']<dx)&&(this['alignBone'](dD['legR'],dS['legR']),!(dm['ankleR']['score']<dO&&dm['ankleR']['visibility']<dx)&&(this['alignBone'](dD['footR'],dS['footR']),this['alignBone'](dD['toeR'],dS['toeR']))));}['estimateBones'](dD,dm){var dS;const dO=new T(...dD['hipL']['metric']),dx=new T(...dD['hipR']['metric']),dK=T['Lerp'](dO,dx,0.5),dV=dO['subtract'](dx)['normalize'](),dX=dV['negate'](),dI=new T(...dD['shoulderL']['metric']),db=new T(...dD['shoulderR']['metric']),dg=new T(...dD['elbowL']['metric']),dW=new T(...dD['elbowR']['metric']),dJ=T['Lerp'](dI,db,0.5),ds=dI['subtract'](db)['normalize'](),dU=dI['subtract'](dK),dp=db['subtract'](dK)['cross'](dU)['normalize']();if(this['tune']['shoulderDX']||this['tune']['shoulderDY']||this['tune']['shoulderDZ']){const E0=ds['scale'](this['tune']['shoulderDX']||0x0),E1=dJ['subtract'](dK)['normalize']()['scale'](this['tune']['shoulderDY']||0x0)['add'](dp['scale'](((dS=this['tune'])==null?void 0x0:dS['shoulderDZ'])||0x0));dI['addInPlace'](E1)['addInPlace'](E0),db['addInPlace'](E1)['addInPlace'](E0['negate']());}const dn=T['Lerp'](dI,db,0.5),da=dn['subtract'](dK)['normalize'](),dL=dg['subtract'](dI)['normalize'](),dH=dW['subtract'](db)['normalize']();let dj;if(this['tune']['neckAdjust']){const E2=Math['abs'](ds['x']);dj=da['scale'](E2*(T['Dot'](da,dL)*-this['tune']['neckAdjust']+T['Dot'](da,dH)*-this['tune']['neckAdjust'])),dn['addInPlace'](dj);}const dl=dn['subtract'](dK)['length'](),dk=this['tune']['shoulderOffset']||0.2,dv=T['Lerp'](dn,dI,dk),dF=T['Lerp'](dn,db,dk),dQ=new T(...dD['earL']['metric']),dq=new T(...dD['earR']['metric']),dC=T['Lerp'](dQ,dq,0.5),dM=new T(...dD['nose']['metric']),Y0=dC['subtract'](dM)['normalize'](),Y1=dQ['subtract'](dq)['normalize'](),Y2=Y1['cross'](Y0)['add'](Y0['scale'](0.05))['normalize'](),Y3=this['tune']['headRatio']||0.32,Y4=dm['head'][0x0]*dl,Y5=dC['add'](Y2['cross'](Y1)['scale'](0.025)),Y6=Y5['add'](Y2['scale'](-Y3*Y4)),Y7=Y5['add'](Y2['scale']((0x1-Y3)*Y4)),Y8=T['Lerp'](Y6,Y7,0x2),Y9=T['Lerp'](ds,Y1,0.5),Yd=dj?dI['add'](dj):dI['clone'](),YY=dj?db['add'](dj):db['clone'](),YE=T['Lerp'](dO,Yd,dm['spine'][0x0]),Yc=T['Lerp'](dx,YY,dm['spine'][0x0]),Yh=T['Lerp'](YE,Yc,0.5),Yf=YE['subtract'](Yc),YR=T['Lerp'](dO,Yd,dm['spine1'][0x0]),Yr=T['Lerp'](dx,YY,dm['spine1'][0x0]),YG=T['Lerp'](YR,Yr,0.5),YZ=YR['subtract'](Yr),Yu=T['Lerp'](dO,Yd,dm['spine2'][0x0]),YN=T['Lerp'](dx,YY,dm['spine2'][0x0]),YT=T['Lerp'](Yu,YN,0.5),YB=YR['subtract'](YN);if(this['tune']['spineCurve']){const E3=dI['subtract'](dK),E4=db['subtract'](dK)['cross'](E3)['normalize'](),E5=this['tune']['spineCurve']*dl;Yh['addInPlace'](E4['scale'](dm['spine'][0x1]*E5)),YG['addInPlace'](E4['scale'](dm['spine1'][0x1]*E5)),YT['addInPlace'](E4['scale'](dm['spine2'][0x1]*E5));}const Yy=new T(...dD['wristL']['metric']),YA=Yy['subtract'](dg)['normalize']()['subtract'](dL)['negate'](),YP=dp['clone'](),Yi=T['Lerp'](YA,YP,0.5),Yz=new T(...dD['indexL']['metric']),Yw=new T(...dD['pinkyL']['metric']),Yo=T['Lerp'](Yz,Yw,0.5),YD=Yw['subtract'](Yz),Ym=new T(...dD['wristR']['metric']),YS=Ym['subtract'](dW)['normalize']()['subtract'](dH),YO=dp['negate'](),Yx=T['Lerp'](YS,YO,0.5),YK=new T(...dD['indexR']['metric']),YV=new T(...dD['pinkyR']['metric']),YX=T['Lerp'](YK,YV,0.5),YI=YK['subtract'](YV),Yb=new T(...dD['kneeL']['metric']),Yg=new T(...dD['ankleL']['metric']),YW=new T(...dD['footIndexL']['metric']),YJ=new T(...dD['heelL']['metric']),Ys=Yg['subtract'](Yb)['normalize'](),YU=YW['subtract'](YJ)['normalize'](),Yp=Ys['cross'](YU)['normalize'](),Yn=T['Lerp'](YJ,YW,0.8),Ya=T['Lerp'](dX,Yp,0.2),YL=T['Lerp'](dX,Yp,0.6),YH=new T(...dD['kneeR']['metric']),Yj=new T(...dD['ankleR']['metric']),Yl=new T(...dD['footIndexR']['metric']),Yk=new T(...dD['heelR']['metric']),Yv=Yj['subtract'](YH)['normalize'](),YF=Yl['subtract'](Yk)['normalize'](),YQ=Yv['cross'](YF)['normalize'](),Yq=T['Lerp'](Yk,Yl,0.8),YC=T['Lerp'](dX,YQ,0.2),YM=T['Lerp'](dX,YQ,0.6);return{'hips':this['estimateBone'](dK,Yh,dV),'spine':this['estimateBone'](Yh,YG,Yf),'spine1':this['estimateBone'](YG,YT,YZ),'spine2':this['estimateBone'](YT,dn,YB),'neck':this['estimateBone'](dn,Y6,Y9),'head':this['estimateBone'](Y6,Y7,Y1),'headEnd':this['estimateBone'](Y7,Y8,Y1),'shoulderL':this['estimateBone'](dv,dI,YP),'armL':this['estimateBone'](dI,dg,Yi),'foreArmL':this['estimateBone'](dg,Yy,YA),'handL':this['estimateBone'](Yy,Yo,YD),'shoulderR':this['estimateBone'](dF,db,YO),'armR':this['estimateBone'](db,dW,Yx),'foreArmR':this['estimateBone'](dW,Ym,YS),'handR':this['estimateBone'](Ym,YX,YI),'upLegL':this['estimateBone'](dO,Yb,Ya),'legL':this['estimateBone'](Yb,Yg,YL),'footL':this['estimateBone'](Yg,Yn,Yp),'toeL':this['estimateBone'](Yn,YW,Yp),'upLegR':this['estimateBone'](dx,YH,YC),'legR':this['estimateBone'](YH,Yj,YM),'footR':this['estimateBone'](Yj,Yq,YQ),'toeR':this['estimateBone'](Yq,Yl,YQ)};}['estimateBone'](dD,dm,dS){const dO=dm['subtract'](dD)['normalize'](),dx=dS['clone']()['normalize']()['cross'](dO)['normalize'](),dt=dO['cross'](dx);return{'position':dD['clone'](),'rotation':B['RotationQuaternionFromAxis'](dt,dO,dx)};}['alignBone'](dD,dm,dS=!0x0){let dO=dD['rotation']['clone'](),dx=dD['position']['clone']();dm['parent']instanceof x&&(dx=T['TransformCoordinates'](dx,dm['parent']['computeWorldMatrix'](!0x0)['clone']()['invert']()),dO=dm['parent']['absoluteRotationQuaternion']['conjugate']()['multiply'](dO),dS&&(dm['parent']['scaling']['setAll'](dx['length']()/dm['position']['length']()),dx=T['TransformCoordinates'](dD['position']['clone'](),dm['parent']['computeWorldMatrix'](!0x0)['clone']()['invert']()))),dm['position']=dx,dm['rotationQuaternion']=dO;}}class d7 extends d6{constructor(dD,dm,dS={'spineCurve':0.5,'neckAdjust':0.01,'headRatio':0.32,'shoulderDY':-0.01,'shoulderDZ':0.005}){super(dD,dS),this['outfit']=dm;}['setNode'](dD){super['setNode'](dD);const {outfit:dm,node:dS}=this;!dm||!dS||dS['getChildMeshes']()['forEach'](dO=>{const dx=dt=>dt==null?void 0x0:dt['some'](dK=>typeof dK=='string'?dO['name']===dK:dK['test'](dO['name']));if(dx(dm['occluders'])){dO['material']&&(dO['material']['disableColorWrite']=!0x0,dO['material']['needDepthPrePass']=!0x0),dO['renderingGroupId']=0x0;return;}if(dx(dm['hidden'])){dO['setEnabled'](!0x1);return;}});}['setOutfit'](dD,dm){this['outfit']=dm,this['setNode'](dD);}}class d8 extends d6{constructor(dD,dm,dS,dO,dx={'spineCurve':0.5,'neckAdjust':0.01,'headRatio':0.32,'shoulderDY':-0.01,'shoulderDZ':0.005}){super(dD,dx),this['translation']=dm,this['rotation']=dS,this['scale']=dO;}async['update'](dD,dm){await super['update'](dD,dm);const dS=dD['poses']&&dD['poses']['length']>0x0?dD['poses'][0x0]['points']:void 0x0,{node:dO,translation:dx,rotation:dt,scale:dK}=this;if(!dO||!dS)return;const dV=new T(...dS['hipL']['metric']),dX=new T(...dS['hipR']['metric']),dI=T['Lerp'](dV,dX,0.5);dO['position']=dx?dI['add'](dx):dI,dt&&(dO['rotationQuaternion']=dt),dK&&(dO['scaling']=new T()['setAll'](dK));}['updateSpine'](dD){const {skeletonNodes:dm}=this;dm&&(this['alignBone'](dD['hips'],dm['hips']),this['alignBone'](dD['spine'],dm['spine']),this['alignBone'](dD['spine1'],dm['spine1']),this['alignBone'](dD['spine2'],dm['spine2']),this['alignBone'](dD['neck'],dm['neck']),this['alignBone'](dD['head'],dm['head']),this['alignBone'](dD['shoulderL'],dm['shoulderL']),this['alignBone'](dD['shoulderR'],dm['shoulderR']));}['alignBone'](dD,dm){let dS=dD['rotation']['clone']();dm['parent']instanceof x&&(dm['parent']['computeWorldMatrix'](!0x0),dS=dm['parent']['absoluteRotationQuaternion']['conjugate']()['multiply'](dS)),dm['rotationQuaternion']=dS;}}var d9=Object['defineProperty'],dd=(dD,dm,dS)=>dm in dD?d9(dD,dm,{'enumerable':!0x0,'configurable':!0x0,'writable':!0x0,'value':dS}):dD[dm]=dS,dY=(dD,dm,dS)=>(dd(dD,typeof dm!='symbol'?dm+'':dm,dS),dS);const dE=0.5,dc=0x40,dh=0x8,df=40.1,dR='\x0a\x20\x20\x20\x20precision\x20mediump\x20float;\x0a\x20\x20\x20\x20varying\x20vec2\x20coords;\x0a\x20\x20\x20\x20uniform\x20vec2\x20size;\x0a\x20\x20\x20\x20uniform\x20vec4\x20box;\x0a\x20\x20\x20\x20uniform\x20sampler2D\x20image;\x0a\x20\x20\x20\x20uniform\x20sampler2D\x20mask;\x0a\x0a\x20\x20\x20\x20float\x20readMask(vec2\x20coords,\x20float\x20dx,\x20float\x20dy)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20return\x20texture2D(mask,\x20(coords\x20+\x20vec2(dx,\x20dy)\x20/\x20size\x20-\x20box.xy)\x20/\x20box.zw).r;\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20vec4\x20readProp(vec2\x20coords,\x20float\x20dx,\x20float\x20ddx,\x20float\x20dy,\x20float\x20ddy)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20return\x20abs(dx)\x20+\x20abs(dy)<\x20'+df+'\x20&&\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20readMask(coords,\x20ddx,\x20ddy)\x20<\x20'+dE+'\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(ddx,\x20ddy)\x20/\x20size)\x20:\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(dx,\x20dy)\x20/\x20size);\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20float\x20traverse(vec2\x20coords,\x20float\x20dx,\x20float\x20dy)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20bool\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20d\x20=\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20di\x20=\x201;\x20di\x20<\x20'+dc+';\x20di++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20d\x20=\x20bg\x20?\x20d\x20:\x20float(di\x20*\x20'+dh+');\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x20d\x20*\x20dx,\x20d\x20*\x20dy)\x20<\x20'+dE+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20bool\x20bg1\x20=\x20bg;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20di\x20=\x201;\x20di\x20<\x20'+dh+';\x20di++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20float\x20d1\x20=\x20d\x20-\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg1\x20=\x20bg1\x20&&\x20readMask(coords,\x20d1\x20*\x20dx,\x20d1\x20*\x20dy)\x20<\x20'+dE+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20d\x20=\x20bg1\x20?\x20d1\x20:\x20d;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20return\x20bg\x20?\x20d\x20:\x20-1.0;\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20void\x20main()\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20bool\x20bg\x20=\x20texture2D(mask,\x20(coords\x20-\x20box.xy)\x20/\x20(box.zw)).r\x20<\x20'+dE+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20bool\x20bg1;\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20color\x20=\x20texture2D(image,\x20coords);\x0a\x20\x20\x20\x20\x20\x20\x20\x20if\x20(bg)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20x0\x20=\x20traverse(coords,\x20-1.0,\x200.0);\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20x0\x20>\x200.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cx0\x20=\x20bg\x20?\x20readProp(coords,\x20-x0,\x20-x0\x20*\x202.0\x20+\x201.0,\x200.0,\x200.0)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20x0\x20=\x20bg\x20?\x201.0\x20/\x20x0\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20x1\x20=\x20traverse(coords,\x201.0,\x200.0);\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20x1\x20>\x200.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cx1\x20=\x20bg\x20?\x20readProp(coords,\x20x1,\x20x1\x20*\x202.0\x20-\x201.0,\x200.0,\x200.0)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20x1\x20=\x20bg\x20?\x201.0\x20/\x20x1\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20y0\x20=\x20traverse(coords,\x200.0,\x20-1.0);\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20y0\x20>\x200.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cy0\x20=\x20bg\x20?\x20readProp(coords,\x200.0,\x200.0,\x20-y0,\x20-2.0\x20*\x20y0\x20+\x201.0)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20y0\x20=\x20bg\x20?\x201.0\x20/\x20y0\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20y1\x20=\x20traverse(coords,\x200.0,\x201.0);\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20y1\x20>\x200.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cy1\x20=\x20bg\x20?\x20readProp(coords,\x200.0,\x200.0,\x20y1,\x202.0\x20*\x20y1\x20+\x201.0)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20y1\x20=\x20bg\x20?\x201.0\x20/\x20y1\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20s\x20=\x201.0\x20/\x20(x0\x20+\x20x1\x20+\x20y0\x20+\x20y1);\x0a\x20\x20\x20\x20\x20\x20\x20\x20color\x20=\x20cx0\x20*\x20x0\x20*\x20s\x20+\x20cx1\x20*\x20x1\x20*\x20s\x20+\x20cy0\x20*\x20y0\x20*\x20s\x20+\x20cy1\x20*\x20y1\x20*\x20s;\x0a\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20color;\x0a\x20\x20\x20\x20}\x0a';class dr extends c{constructor(){super(['image','mask'],{'size':'2f','flip':'1f','box':'4f'},dR),dY(this,'maskTexture'),dY(this,'dilationShader');}async['load'](dD){const dm=dD instanceof h&&dD['shaderCtx'];if(this['loaded']||!dm)return;const dS={'width':0x100,'height':0x100};return this['maskTexture']=new f(dm,dS,!0x0),this['dilationShader']=new t(dm,dS,0x2),super['load'](dD);}['unload'](){var dD,dm;this['loaded']&&((dD=this['dilationShader'])==null||dD['dispose'](),delete this['dilationShader'],(dm=this['maskTexture'])==null||dm['dispose'](),delete this['maskTexture'],super['unload']());}async['process'](dD,dm){var dS,dO,dx,dt,dK,dV,dX,dI;const db=dD['poses']&&dD['poses']['length']>0x0&&dD['poses'][0x0]['mask'];if(!db)return!0x1;(dS=this['maskTexture'])==null||dS['resize'](db['size']),(dO=this['maskTexture'])==null||dO['update'](db['buffer']),(dx=this['dilationShader'])==null||dx['resize'](db['size']),(dK=this['dilationShader'])==null||dK['process']([((dt=this['maskTexture'])==null?void 0x0:dt['texture']())||null]);const dg=db['box'];return(dI=this['shader'])==null||dI['process']([dm,((dX=(dV=this['dilationShader'])==null?void 0x0:dV['output'])==null?void 0x0:dX['texture']())||null],{'box':[dg[0x0][0x0],dg[0x0][0x1],dg[0x1][0x0]-dg[0x0][0x0],dg[0x1][0x1]-dg[0x0][0x1]]}),!0x0;}}var dG=Object['defineProperty'],dZ=(dD,dm,dS)=>dm in dD?dG(dD,dm,{'enumerable':!0x0,'configurable':!0x0,'writable':!0x0,'value':dS}):dD[dm]=dS,du=(dD,dm,dS)=>(dZ(dD,typeof dm!='symbol'?dm+'':dm,dS),dS);const dN=0.5,dT=0x20,dB=0x8,dy=0x40,dA=20.1,dP='\x0a\x20\x20\x20\x20precision\x20mediump\x20float;\x0a\x20\x20\x20\x20varying\x20vec2\x20coords;\x0a\x20\x20\x20\x20uniform\x20vec2\x20size;\x0a\x20\x20\x20\x20uniform\x20vec4\x20box;\x0a\x20\x20\x20\x20uniform\x20sampler2D\x20image;\x0a\x20\x20\x20\x20uniform\x20sampler2D\x20mask;\x0a\x20\x20\x20\x20uniform\x20sampler2D\x20part;\x0a\x0a\x20\x20\x20\x20float\x20readMask(vec2\x20coords,\x20float\x20dx,\x20float\x20dy)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20return\x20texture2D(mask,\x20(coords\x20+\x20vec2(dx,\x20dy)\x20/\x20size\x20-\x20box.xy)\x20/\x20box.zw).r;\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20vec4\x20readPart(vec2\x20coords,\x20float\x20dx,\x20float\x20dy)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec2\x20offset\x20=\x20coords\x20+\x20vec2(dx,\x20dy)\x20/\x20size;\x0a\x20\x20\x20\x20\x20\x20\x20\x20return\x20texture2D(part,\x20vec2(offset.x,\x201.0\x20-\x20offset.y));\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20vec4\x20readProp(vec2\x20coords,\x20float\x20dx,\x20float\x20ddx,\x20float\x20dy,\x20float\x20ddy)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20return\x20abs(dx)\x20+\x20abs(dy)<\x20'+dA+'\x20&&\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20readMask(coords,\x20ddx,\x20ddy)\x20<\x20'+dN+'\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(ddx,\x20ddy)\x20/\x20size)\x20:\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(dx,\x20dy)\x20/\x20size);\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20float\x20traverse(vec2\x20coords,\x20float\x20dx,\x20float\x20dy)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20bool\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20d\x20=\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20di\x20=\x201;\x20di\x20<\x20'+dT+';\x20di++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20d\x20=\x20bg\x20?\x20d\x20:\x20float(di\x20*\x20'+dB+');\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x20d\x20*\x20dx,\x20d\x20*\x20dy)\x20<\x20'+dN+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20bool\x20bg1\x20=\x20bg;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20di\x20=\x201;\x20di\x20<\x20'+dB+';\x20di++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20float\x20d1\x20=\x20d\x20-\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg1\x20=\x20bg1\x20&&\x20readMask(coords,\x20d1\x20*\x20dx,\x20d1\x20*\x20dy)\x20<\x20'+dN+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20d\x20=\x20bg1\x20?\x20d1\x20:\x20d;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20return\x20bg\x20?\x20d\x20:\x20-1.0;\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20vec4\x20searchPart(vec2\x20coords,\x20vec4\x20part,\x20float\x20dx,\x20float\x20dy)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20bool\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20di\x20=\x201;\x20di\x20<\x20'+dy+';\x20di++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20float\x20df\x20=\x20float(di);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20vec3\x20partD\x20=\x20readPart(coords,\x20df\x20*\x20dx,\x20df\x20*\x20dy).rgb;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x20df\x20*\x20dx,\x20df\x20*\x20dy)\x20<\x20'+dN+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bool\x20closer\x20=\x20!bg\x20&&\x20(partD.r\x20>\x200.5\x20||\x20partD.g\x20>\x200.5)\x20&&\x20df\x20<\x20part.a;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20part.a\x20=\x20closer\x20?\x20df\x20:\x20part.a;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20part.rgb\x20=\x20closer\x20?\x20partD\x20:\x20part.rgb;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20float\x20df\x20=\x20float(di);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20vec2\x20partD\x20=\x20readPart(coords,\x20df\x20*\x20dx,\x20df\x20*\x20dy).rg;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x20df\x20*\x20dx,\x20df\x20*\x20dy)\x20<\x20'+dN+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20bool\x20closerR\x20=\x20!bg\x20&&\x20partD.r\x20>\x200.5\x20&&\x20df\x20<\x20part.z;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20bool\x20closerG\x20=\x20!bg\x20&&\x20partD.g\x20>\x200.5\x20&&\x20df\x20<\x20part.w;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20part.z\x20=\x20closerR\x20?\x20df\x20:\x20part.z;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20part.r\x20=\x20closerR\x20?\x20partD.r\x20:\x20part.r;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20part.w\x20=\x20closerG\x20?\x20df\x20:\x20part.w;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20part.g\x20=\x20closerG\x20?\x20partD.g\x20:\x20part.g;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20return\x20part;\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20void\x20main()\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20bool\x20bg\x20=\x20texture2D(mask,\x20(coords\x20-\x20box.xy)\x20/\x20(box.zw)).r\x20<\x20'+dN+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20color\x20=\x20texture2D(image,\x20coords);\x0a\x20\x20\x20\x20\x20\x20\x20\x20if\x20(bg)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20part\x20=\x20texture2D(part,\x20vec2(coords.x,\x201.0\x20-\x20coords.y));\x0a\x20\x20\x20\x20\x20\x20\x20\x20if\x20(part.g\x20>\x200.5\x20||\x20part.r\x20>\x200.5)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20part.a\x20=\x20float('+(0x2*dy+0x1)+');\x0a\x20\x20\x20\x20\x20\x20\x20\x20//\x20part.zw\x20=\x20vec2('+(0x2*dy+0x1)+');\x0a\x20\x20\x20\x20\x20\x20\x20\x20part\x20=\x20searchPart(coords,\x20part,\x201.0,\x200.0);\x0a\x20\x20\x20\x20\x20\x20\x20\x20part\x20=\x20searchPart(coords,\x20part,\x20-1.0,\x200.0);\x0a\x20\x20\x20\x20\x20\x20\x20\x20part\x20=\x20searchPart(coords,\x20part,\x200.0,\x201.0);\x0a\x20\x20\x20\x20\x20\x20\x20\x20part\x20=\x20searchPart(coords,\x20part,\x200.0,\x20-1.0);\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20//\x20if\x20(part.w\x20<\x20part.z\x20&&\x20part.w\x20<\x20float('+dy+'))\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20if\x20(part.g\x20>\x200.5\x20||\x20part.r\x20<=\x200.5)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20x0\x20=\x20traverse(coords,\x20-1.0,\x200.0);\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20x0\x20>\x200.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cx0\x20=\x20bg\x20?\x20readProp(coords,\x20-x0,\x20-x0\x20*\x202.0\x20+\x201.0,\x200.0,\x200.0)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20x0\x20=\x20bg\x20?\x201.0\x20/\x20x0\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20x1\x20=\x20traverse(coords,\x201.0,\x200.0);\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20x1\x20>\x200.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cx1\x20=\x20bg\x20?\x20readProp(coords,\x20x1,\x20x1\x20*\x202.0\x20-\x201.0,\x200.0,\x200.0)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20x1\x20=\x20bg\x20?\x201.0\x20/\x20x1\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20y0\x20=\x20traverse(coords,\x200.0,\x20-1.0);\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20y0\x20>\x200.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cy0\x20=\x20bg\x20?\x20readProp(coords,\x200.0,\x200.0,\x20-y0,\x20-2.0\x20*\x20y0\x20+\x201.0)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20y0\x20=\x20bg\x20?\x201.0\x20/\x20y0\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20y1\x20=\x20traverse(coords,\x200.0,\x201.0);\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20y1\x20>\x200.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cy1\x20=\x20bg\x20?\x20readProp(coords,\x200.0,\x200.0,\x20y1,\x202.0\x20*\x20y1\x20+\x201.0)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20y1\x20=\x20bg\x20?\x201.0\x20/\x20y1\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20s\x20=\x201.0\x20/\x20(x0\x20+\x20x1\x20+\x20y0\x20+\x20y1);\x0a\x20\x20\x20\x20\x20\x20\x20\x20color\x20=\x20cx0\x20*\x20x0\x20*\x20s\x20+\x20cx1\x20*\x20x1\x20*\x20s\x20+\x20cy0\x20*\x20y0\x20*\x20s\x20+\x20cy1\x20*\x20y1\x20*\x20s;\x0a\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20color;\x0a\x20\x20\x20\x20}\x0a';class di extends c{constructor(dD=[],dm=[]){super(['image','mask','part'],{'size':'2f','flip':'1f','box':'4f'},dP),this['patchParts']=dD,this['keepParts']=dm,du(this,'maskTexture'),du(this,'dilationShader'),du(this,'partsTarget'),du(this,'partsSkeletons',[]),du(this,'patchMaterial'),du(this,'keepMaterial');}['setParts'](dD=[],dm=[]){this['partsSkeletons']=[],this['patchParts']=dD,this['keepParts']=dm,this['partsTarget']&&(this['partsTarget']['renderList']=[...dD,...dm],this['partsTarget']['setMaterialForRendering'](dD,this['patchMaterial']),this['partsTarget']['setMaterialForRendering'](dm,this['keepMaterial']),this['partsTarget']['renderList']['forEach'](dS=>dS['skeleton']&&this['partsSkeletons']['indexOf'](dS['skeleton'])<0x0&&this['partsSkeletons']['push'](dS['skeleton'])));}async['load'](dD){if(!(dD instanceof j))return;const {scene:dm,shaderCtx:dS}=dD;if(this['loaded']||!dS)return;const dO={'width':0x100,'height':0x100};return this['maskTexture']=new f(dS,dO,!0x0),this['dilationShader']=new t(dS,dO,0x1),this['partsTarget']=new K('MasksTarget',this['size'],dm),this['partsTarget']['clearColor']=new A(0x0,0x0,0x0,0x1),this['patchMaterial']=new V('PatchMaskMaterial',dm),this['patchMaterial']['emissiveColor']=new P(0x1,0x0,0x0),this['patchMaterial']['disableLighting']=!0x0,this['keepMaterial']=new V('KeepMaskMaterial',dm),this['keepMaterial']['emissiveColor']=new P(0x0,0x1,0x0),this['keepMaterial']['disableLighting']=!0x0,this['setParts'](this['patchParts'],this['keepParts']),super['load'](dD);}['unload'](){var dD,dm,dS,dO,dx;this['loaded']&&((dD=this['dilationShader'])==null||dD['dispose'](),delete this['dilationShader'],(dm=this['maskTexture'])==null||dm['dispose'](),delete this['maskTexture'],(dS=this['partsTarget'])==null||dS['dispose'](),delete this['partsTarget'],(dO=this['patchMaterial'])==null||dO['dispose'](),delete this['patchMaterial'],(dx=this['keepMaterial'])==null||dx['dispose'](),delete this['keepMaterial'],super['unload']());}async['process'](dD,dm){var dS,dO,dx,dt;const dK=dD['poses']&&dD['poses']['length']>0x0&&dD['poses'][0x0]['mask'],{partsTarget:dV,partsSkeletons:dX,maskTexture:dI,dilationShader:db,shader:dg}=this;if(!dK||!dV||!dI||!db||!dg)return!0x1;dX['forEach'](dJ=>dJ['prepare']()),(dS=dV['renderList'])==null||dS['forEach'](dJ=>dJ['computeWorldMatrix'](!0x0)),dV['render'](),dI['resize'](dK['size']),dI['update'](dK['buffer']),db['resize'](dK['size']),db['process']([dI['texture']()||null]);const de=(dx=(dO=dV['getInternalTexture']())==null?void 0x0:dO['_hardwareTexture'])==null?void 0x0:dx['_webGLTexture'],dW=dK['box'];return dg['process']([dm,((dt=db['output'])==null?void 0x0:dt['texture']())||null,de||null],{'box':[dW[0x0][0x0],dW[0x0][0x1],dW[0x1][0x0]-dW[0x0][0x0],dW[0x1][0x1]-dW[0x0][0x1]]}),!0x0;}['setupVideo'](dD){var dm;super['setupVideo'](dD),(dm=this['partsTarget'])==null||dm['resize'](dD),this['setParts'](this['patchParts'],this['keepParts']);}}class dz extends J{constructor(dD,dm=0x0){super(),this['node']=dD,this['renderOrder']=dm;}async['load'](dD){if(!this['loaded'])return this['node']instanceof X&&(this['node']['material']&&(this['node']['material']['disableColorWrite']=!0x0,this['node']['material']['needDepthPrePass']=!0x0),this['node']['renderingGroupId']=this['renderOrder']),this['node']['getChildMeshes'](!0x1)['forEach'](dm=>{dm['material']&&(dm['material']['disableColorWrite']=!0x0,dm['material']['needDepthPrePass']=!0x0),dm['renderingGroupId']=this['renderOrder'];}),super['load'](dD);}}class dw extends I{constructor(dD,dm){super(dD,dm),this['disableColorWrite']=!0x0,this['needDepthPrePass']=!0x0;}}export{J as BabylonPlugin,W as BabylonRenderer,j as BabylonUniRenderer,dr as BodyPatchPlugin,di as BodypartPatchPlugin,d2 as FaceMaskPlugin,U as FacePlugin,k as FaceRenderer,F as FaceTrackPlugin,v as HeadTrackPlugin,dw as OccluderMaterial,dz as OccluderPlugin,d6 as PoseAlignPlugin,d7 as PoseOutfitPlugin,s as PosePlugin,l as PoseRenderer,d8 as PoseTwinPlugin};
