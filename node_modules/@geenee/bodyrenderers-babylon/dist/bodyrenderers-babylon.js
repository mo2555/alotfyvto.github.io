import{SceneRenderer as x,ScenePlugin as f,CanvasRenderer as P,VideoPlugin as A,ShaderProgram as y,ShaderPlugin as r,ShaderRenderer as g,ImageTexture as i}from'@geenee/armature';import*as u from'@babylonjs/core';import{meshReference as q,meshTriangles as G,meshUV as E,meshDesc as c}from'@geenee/bodytracking';class N extends x{constructor(x3,x4,x5){super({'container':x3,'mode':x4,'layerCount':0x2,'mirror':x5}),this['cameraAngle']=0xa/0xb4*Math['PI'];const x6=this['canvas']['layers'][0x1];this['renderer']=new u['Engine'](x6,!0x0,{'alpha':!0x0,'preserveDrawingBuffer':!0x0},!0x0);const x7=window['devicePixelRatio'];this['renderer']['setSize'](x6['clientWidth']*x7,x6['clientHeight']*x7),this['canvas']['on']('resize',()=>{this['renderer']['setSize'](x6['clientWidth']*x7,x6['clientHeight']*x7);}),this['scene']=new u['Scene'](this['renderer']),this['scene']['useRightHandedSystem']=!0x0,this['scene']['createDefaultEnvironment']({'createSkybox':!0x1,'createGround':!0x1}),this['scene']['clearColor']=new u['Color4'](0x0,0x0,0x0,0x0),this['camera']=new u['UniversalCamera']('camera',new u['Vector3'](0x0,0x0,0x0),this['scene']),this['camera']['rotationQuaternion']=new u['Quaternion'](0x1,0x0,0x0,0x0),this['camera']['fov']=this['cameraAngle'],this['camera']['minZ']=0.02,this['camera']['maxZ']=0x14;}['updateScene'](){var x3;(x3=this['scene'])==null||x3['render']();}['dispose'](){var x3;this['renderer']['dispose'](),this['camera']['dispose'](),(x3=this['scene'])==null||x3['dispose'](),super['dispose']();}['setupCamera'](x3,x4){super['setupCamera'](x3,x4),this['camera']['fov']=this['cameraAngle'],this['camera']['getProjectionMatrix'](!0x0);}}class F extends f{}class v extends F{}class p extends F{}class d extends x{constructor(x3,x4,x5){super({'container':x3,'mode':x4,'layerCount':0x1,'mirror':x5}),this['cameraAngle']=0xa/0xb4*Math['PI'];const x6=this['canvas']['layers'][0x0];this['renderer']=new u['Engine'](x6,!0x0,{'alpha':!0x0,'preserveDrawingBuffer':!0x0},!0x0);const x7=window['devicePixelRatio'];this['renderer']['setSize'](x6['clientWidth']*x7,x6['clientHeight']*x7),this['canvas']['on']('resize',()=>{this['renderer']['setSize'](x6['clientWidth']*x7,x6['clientHeight']*x7);}),this['scene']=new u['Scene'](this['renderer']),this['scene']['useRightHandedSystem']=!0x0,this['scene']['createDefaultEnvironment']({'createSkybox':!0x1,'createGround':!0x1}),this['scene']['clearColor']=new u['Color4'](0x0,0x0,0x0,0x0),this['camera']=new u['UniversalCamera']('camera',new u['Vector3'](0x0,0x0,0x0),this['scene']),this['camera']['rotationQuaternion']=new u['Quaternion'](0x1,0x0,0x0,0x0),this['camera']['fov']=this['cameraAngle'],this['camera']['minZ']=0.02,this['camera']['maxZ']=0x14,this['layer']=new u['Layer']('video',null,this['scene'],!0x0);}['updateVideo'](x3){var x4;if(!this['current']||!this['shader'])return;this['shader']['process']([this['current']],{'flip':[0x1]});const x5=(x4=this['shader']['output'])==null?void 0x0:x4['texture']();return x5&&(this['layer']['texture']=new u['BaseTexture'](this['renderer'],this['renderer']['wrapWebGLTexture'](x5))),P['prototype']['updateVideo']['call'](this,x3);}['updateScene'](){var x3;(x3=this['scene'])==null||x3['render']();}['dispose'](){var x3;this['layer']['dispose'](),this['camera']['dispose'](),(x3=this['scene'])==null||x3['dispose'](),this['renderer']['dispose'](),super['dispose']();}['setupVideo'](x3,x4){var x5,x6;P['prototype']['setupVideo']['call'](this,x3,x4);const {width:x7,height:x8}=this['videoSize'];(x5=this['input'])==null||x5['resize']({'width':x7,'height':x8}),(x6=this['shader'])==null||x6['resize']({'width':x7,'height':x8});}['setupCamera'](x3,x4){super['setupCamera'](x3,x4),this['camera']['fov']=this['cameraAngle'],this['camera']['getProjectionMatrix'](!0x0);}}class X extends d{}class a extends d{}class I extends F{constructor(x3,x4=!0x1){super(),this['node']=x3,this['shapeScale']=x4;}async['update'](x3,x4){if(!this['loaded'])return;const x5=x3['faces']&&x3['faces']['length']>0x0?x3['faces'][0x0]['transform']:void 0x0;if(!x5)return this['node']['setEnabled'](!0x1),super['update'](x3,x4);const x6=u['Vector3']['FromArray'](x5['translation']),x7=new u['Vector3']()['setAll'](x5['scale']),x8=u['Vector3']['FromArray'](x5['shapeScale'])['scale'](x5['scale']),x9=u['Quaternion']['FromArray'](x5['rotation']);return this['node']['setEnabled'](!0x0),this['node']['rotationQuaternion']=x9,this['node']['position']=x6,this['node']['scaling']=this['shapeScale']?x8:x7,super['update'](x3,x4);}}class w extends F{constructor(x3,x4=0x0,x5=!0x1){super(),this['node']=x3,this['facePoint']=x4,this['shapeScale']=x5;}async['update'](x3,x4){if(!this['loaded'])return;const {transform:x5=void 0x0,metric:x6=void 0x0}=x3['faces']&&x3['faces']['length']>0x0?x3['faces'][0x0]:{};if(!x5||!x6)return this['node']['setEnabled'](!0x1),super['update'](x3,x4);const x7=u['Vector3']['FromArray'](x6[this['facePoint']]),x8=new u['Vector3']()['setAll'](x5['scale']),x9=u['Vector3']['FromArray'](x5['shapeScale'])['scale'](x5['scale']),xx=u['Quaternion']['FromArray'](x5['rotation']);return this['node']['setEnabled'](!0x0),this['node']['rotationQuaternion']=xx,this['node']['position']=x7,this['node']['scaling']=this['shapeScale']?x9:x8,super['update'](x3,x4);}}class e extends F{constructor(x3){super(),this['mesh']=x3,this['pointCont']=q['length'];}async['load'](x3){this['loaded']||(await super['load'](x3),await this['setMesh'](this['mesh']));}async['update'](x3,x4){var x5;if(!this['loaded'])return;const x6=x3['faces']&&x3['faces']['length']>0x0?x3['faces'][0x0]['metric']:void 0x0;return!x6||!this['mesh']?((x5=this['mesh'])==null||x5['setEnabled'](!0x1),super['update'](x3,x4)):(this['mesh']['setEnabled'](!0x0),this['mesh']['updateVerticesData'](u['VertexBuffer']['PositionKind'],x6['slice'](0x0,this['pointCont'])['flat']()),super['update'](x3,x4));}async['setMesh'](x3){if(delete this['mesh'],this['mesh']=x3,!(!this['loaded']||!x3)){var x4=new u['VertexData']();x4['positions']=q['flat'](),x4['indices']=G['flat'](),x4['uvs']=E['flat'](),x4['normals']=[],u['VertexData']['ComputeNormals'](x4['positions'],x4['indices'],x4['normals']),x4['applyToMesh'](x3,!0x0),x3['renderingGroupId']=0x1;}}}class M extends A{async['update'](x3,x4){const x5=x3['faces']&&x3['faces']['length']>0x0?x3['faces'][0x0]['mesh']:void 0x0,{videoCtx:x6}=this;if(!x5||!x6)return super['update'](x3,x4);const {width:x7,height:x8}=x6['canvas'];x5['keypoints']['forEach'](xL=>x6['fillRect'](xL[0x0]*x7-0x2,xL[0x1]*x8-0x2,0x4,0x4)),x6['lineWidth']=0x4,x6['strokeStyle']='rgba(93,\x20111,\x20227,\x200.75)';const x9=[...c['lipsLowerOuter']]['reverse']();this['drawPath'](x6,[...c['lipsUpperOuter'],...x9]['map'](xL=>x5['keypoints'][xL]),!0x0);const xx=[...c['lipsLowerInner']]['reverse']();this['drawPath'](x6,[...c['lipsUpperInner'],...xx]['map'](xL=>x5['keypoints'][xL]),!0x0),x6['strokeStyle']='rgba(172,\x20110,\x20255,\x200.75)';const xf=[...c['rightEyeLower0']]['reverse']();this['drawPath'](x6,[...c['rightEyeUpper0'],...xf]['map'](xL=>x5['keypoints'][xL]),!0x0);const xP=[...c['rightEyeLower1']]['reverse']();this['drawPath'](x6,[...c['rightEyeUpper1'],...xP]['map'](xL=>x5['keypoints'][xL]),!0x0);const xA=[...c['leftEyeLower0']]['reverse']();this['drawPath'](x6,[...c['leftEyeUpper0'],...xA]['map'](xL=>x5['keypoints'][xL]),!0x0);const xy=[...c['leftEyeLower1']]['reverse']();this['drawPath'](x6,[...c['leftEyeUpper1'],...xy]['map'](xL=>x5['keypoints'][xL]),!0x0),x6['strokeStyle']='rgba(94,\x20214,\x20202,\x200.75)';const xr=[...c['rightEyebrowLower']]['reverse']();this['drawPath'](x6,[...c['rightEyebrowUpper'],...xr]['map'](xL=>x5['keypoints'][xL]),!0x0);const xg=[...c['leftEyebrowLower']]['reverse']();if(this['drawPath'](x6,[...c['leftEyebrowUpper'],...xg]['map'](xL=>x5['keypoints'][xL]),!0x0),x5['keypoints']['length']>0x1d4){x6['strokeStyle']='rgba(218,\x2060,\x20202,\x200.75)',this['drawPath'](x6,[...c['rightEyeIris']['slice'](0x1)]['map'](xq=>x5['keypoints'][xq]),!0x0),this['drawPath'](x6,[...c['leftEyeIris']['slice'](0x1)]['map'](xq=>x5['keypoints'][xq]),!0x0);const xL=x5['keypoints'][c['rightEyeIris'][0x0]],xi=x5['keypoints'][c['leftEyeIris'][0x0]],{width:xu,height:xb}=x6['canvas'];x6['beginPath'](),x6['ellipse'](xL[0x0]*xu,xL[0x1]*xb,0x3,0x3,0x0,0x0,0x2*Math['PI']),x6['stroke'](),x6['beginPath'](),x6['ellipse'](xi[0x0]*xu,xi[0x1]*xb,0x3,0x3,0x0,0x0,0x2*Math['PI']),x6['stroke']();}x6['lineWidth']=0.5,x6['strokeStyle']='rgba(180,\x20180,\x20180,\x200.75)';for(let xq=0x0;xq<G['length']/0x3;xq++){const xG=[G[xq*0x3],G[xq*0x3+0x1],G[xq*0x3+0x2]]['map'](xE=>x5['keypoints'][xE]);this['drawPath'](x6,xG,!0x0);}return super['update'](x3,x4);}['drawPath'](x3,x4,x5){const {width:x6,height:x7}=x3['canvas'],x8=new Path2D();x8['moveTo'](x4[0x0][0x0]*x6,x4[0x0][0x1]*x7);for(let x9=0x1;x9<x4['length'];x9++)x8['lineTo'](x4[x9][0x0]*x6,x4[x9][0x1]*x7);x5&&x8['closePath'](),x3['stroke'](x8);}}const s=['hips','spine','spine1','spine2','neck','head','headEnd','shoulderL','shoulderR','armL','armR','foreArmL','foreArmR','handL','handR','upLegL','upLegR','legL','legR','footL','footR','toeL','toeR'];function B(x3){return Object['fromEntries'](s['map'](x4=>[x4,x3(x4)]));}class l extends v{constructor(x3,x4={'spineCurve':0.5,'neckAdjust':0.01,'headRatio':0.32,'shoulderDY':-0.01,'shoulderDZ':0.005}){super(),this['node']=x3,this['tune']=x4,this['avatarLength']=0x1,this['alignScore']=0.9,this['alignVisibility']=0.9;}async['load'](x3){this['loaded']||(await super['load'](x3),await this['setNode'](this['node']));}['unload'](){!this['loaded']||(delete this['node'],delete this['skeleton'],delete this['skeletonRef'],delete this['spineRef'],super['unload']());}['setNode'](x3){var x4,x5;if(delete this['skeleton'],delete this['skeletonRef'],delete this['spineRef'],this['node']=x3,!this['loaded']||!x3)return;this['skeletonRef']=((x4=x3['getChildMeshes'](!0x1)['find'](xT=>xT['skeleton']))==null?void 0x0:x4['skeleton'])||void 0x0;const x6=(x5=this['skeletonRef'])==null?void 0x0:x5['bones'];if(!x6)return;const x7=xT=>{var xN;return(xN=x6['find'](xF=>xF['name']['toLowerCase']()['endsWith'](xT)))==null?void 0x0:xN['getTransformNode']();},x8={'hips':x7('hips'),'spine':x7('spine'),'spine1':x7('spine1'),'spine2':x7('spine2'),'neck':x7('neck'),'head':x7('head'),'headEnd':x7('headtop_end'),'shoulderL':x7('leftshoulder'),'shoulderR':x7('rightshoulder'),'armL':x7('leftarm'),'armR':x7('rightarm'),'foreArmL':x7('leftforearm'),'foreArmR':x7('rightforearm'),'handL':x7('lefthand'),'handR':x7('righthand'),'upLegL':x7('leftupleg'),'upLegR':x7('rightupleg'),'legL':x7('leftleg'),'legR':x7('rightleg'),'footL':x7('leftfoot'),'footR':x7('rightfoot'),'toeL':x7('lefttoebase'),'toeR':x7('righttoebase')};this['skeleton']=x8;const x9=x8['hips']['absolutePosition'],xx=x8['armL']['absolutePosition'],xf=x8['armR']['absolutePosition'],xP=u['Vector3']['Lerp'](xx,xf,0.5)['subtract'](x9)['length'](),xA=xx['subtract'](x9),xy=xf['subtract'](x9)['cross'](xA)['normalize'](),xr=x8['spine']['absolutePosition']['subtract'](x9),xg=u['Vector3']['Dot'](xr,xy),xL=xr['subtract'](xy['scale'](xg))['length'](),xi=x8['spine1']['absolutePosition']['subtract'](x9),xu=u['Vector3']['Dot'](xi,xy),xb=xi['subtract'](xy['scale'](xu))['length'](),xq=x8['spine2']['absolutePosition']['subtract'](x9),xG=u['Vector3']['Dot'](xq,xy),xE=xq['subtract'](xy['scale'](xG))['length'](),xc=x8['head']['absolutePosition'],xm=x8['headEnd']['absolutePosition']['subtract'](xc)['length']();this['avatarLength']=xP,this['spineRef']={'spine':[xL/xP,xg/xP],'spine1':[xb/xP,xu/xP],'spine2':[xE/xP,xG/xP],'head':[xm/xP,0x0]},x3 instanceof u['AbstractMesh']&&(x3['alwaysSelectAsActiveMesh']=!0x0),x3['getChildMeshes'](!0x1)['forEach'](xT=>{xT['alwaysSelectAsActiveMesh']=!0x0;});}async['update'](x3,x4){var x5;if(!this['loaded'])return;const x6=x3['poses']&&x3['poses']['length']>0x0?x3['poses'][0x0]['points']:void 0x0,{node:x7,skeleton:x8,spineRef:x9}=this;if(!x8||!x9||!x6||!x7)return x7==null||x7['setEnabled'](!0x1),super['update'](x3,x4);const xx=this['estimateBones'](x6,x9);return x7['setEnabled'](!0x0),(x5=this['skeletonRef'])==null||x5['returnToRest'](),this['updateSpine'](xx),this['updateHandL'](xx,x6),this['updateHandR'](xx,x6),this['updateLegL'](xx,x6),this['updateLegR'](xx,x6),super['update'](x3,x4);}['updateSpine'](x3){var x4;const {skeleton:x5,spineRef:x6}=this;if(!x5||!x6)return;this['alignBone'](x3['hips'],x5['hips'],!0x1),this['alignBone'](x3['spine'],x5['spine']),this['alignBone'](x3['spine1'],x5['spine1']),this['alignBone'](x3['spine2'],x5['spine2']),this['alignBone'](x3['neck'],x5['neck'],!0x1),this['alignBone'](x3['head'],x5['head'],!0x1);const x7=(x4=this['skeletonRef'])==null?void 0x0:x4['bones']['find'](x8=>x8['name']['endsWith']('HeadEnd'));if(x7){const {head:x8,headEnd:x9}=x3,xx=x9['position']['subtract'](x8['position'])['length']();x5['head']['scaling']['setAll'](1.05*xx/x7['position']['length']());}this['alignBone'](x3['shoulderL'],x5['shoulderL'],!0x1),this['alignBone'](x3['shoulderR'],x5['shoulderR'],!0x1);}['updateHandL'](x3,x4){const {skeleton:x5,spineRef:x6}=this;if(!x5||!x6)return;const {alignScore:x7,alignVisibility:x8}=this;this['alignBone'](x3['armL'],x5['armL']),!(x4['elbowL']['score']<x7&&x4['elbowL']['visibility']<x8)&&(this['alignBone'](x3['foreArmL'],x5['foreArmL']),this['alignBone'](x3['handL'],x5['handL']),x5['handL']['scaling']['setAll'](0.95));}['updateHandR'](x3,x4){const {skeleton:x5}=this;if(!x5)return;const {alignScore:x6,alignVisibility:x7}=this;this['alignBone'](x3['armR'],x5['armR']),!(x4['elbowR']['score']<x6&&x4['elbowR']['visibility']<x7)&&(this['alignBone'](x3['foreArmR'],x5['foreArmR']),this['alignBone'](x3['handR'],x5['handR']),x5['handR']['scaling']['setAll'](0.95));}['updateLegL'](x3,x4){const {skeleton:x5}=this;if(!x5)return;const {alignScore:x6,alignVisibility:x7}=this;x4['hipL']['score']<x6&&x4['hipL']['visibility']<x7||(this['alignBone'](x3['upLegL'],x5['upLegL'],!0x1),!(x4['kneeL']['score']<x6&&x4['kneeL']['visibility']<x7)&&(this['alignBone'](x3['legL'],x5['legL']),!(x4['ankleL']['score']<x6&&x4['ankleL']['visibility']<x7)&&(this['alignBone'](x3['footL'],x5['footL']),this['alignBone'](x3['toeL'],x5['toeL']))));}['updateLegR'](x3,x4){const {skeleton:x5}=this;if(!x5)return;const {alignScore:x6,alignVisibility:x7}=this;x4['hipR']['score']<x6&&x4['hipR']['visibility']<x7||(this['alignBone'](x3['upLegR'],x5['upLegR'],!0x1),!(x4['kneeR']['score']<x6&&x4['kneeR']['visibility']<x7)&&(this['alignBone'](x3['legR'],x5['legR']),!(x4['ankleR']['score']<x6&&x4['ankleR']['visibility']<x7)&&(this['alignBone'](x3['footR'],x5['footR']),this['alignBone'](x3['toeR'],x5['toeR']))));}['estimateBones'](x3,x4){var x5;const x6=new u['Vector3'](...x3['hipL']['metric']),x7=new u['Vector3'](...x3['hipR']['metric']),x8=u['Vector3']['Lerp'](x6,x7,0.5),x9=x6['subtract'](x7)['normalize'](),xx=x9['negate'](),xf=new u['Vector3'](...x3['shoulderL']['metric']),xP=new u['Vector3'](...x3['shoulderR']['metric']),xA=new u['Vector3'](...x3['elbowL']['metric']),xy=new u['Vector3'](...x3['elbowR']['metric']),xr=u['Vector3']['Lerp'](xf,xP,0.5),xg=xf['subtract'](xP)['normalize'](),xL=xf['subtract'](x8),xi=xP['subtract'](x8)['cross'](xL)['normalize']();if(this['tune']['shoulderDX']||this['tune']['shoulderDY']||this['tune']['shoulderDZ']){const fS=xg['scale'](this['tune']['shoulderDX']||0x0),fd=xr['subtract'](x8)['normalize']()['scale'](this['tune']['shoulderDY']||0x0)['add'](xi['scale'](((x5=this['tune'])==null?void 0x0:x5['shoulderDZ'])||0x0));xf['addInPlace'](fd)['addInPlace'](fS),xP['addInPlace'](fd)['addInPlace'](fS['negate']());}const xu=u['Vector3']['Lerp'](xf,xP,0.5),xb=xu['subtract'](x8)['normalize'](),xq=xA['subtract'](xf)['normalize'](),xG=xy['subtract'](xP)['normalize']();let xE;if(this['tune']['neckAdjust']){const fX=Math['abs'](xg['x']);xE=xb['scale'](fX*(u['Vector3']['Dot'](xb,xq)*-this['tune']['neckAdjust']+u['Vector3']['Dot'](xb,xG)*-this['tune']['neckAdjust'])),xu['addInPlace'](xE);}const xc=xu['subtract'](x8)['length'](),xm=this['tune']['shoulderOffset']||0.2,xT=u['Vector3']['Lerp'](xu,xf,xm),xN=u['Vector3']['Lerp'](xu,xP,xm),xF=new u['Vector3'](...x3['earL']['metric']),xv=new u['Vector3'](...x3['earR']['metric']),xp=u['Vector3']['Lerp'](xF,xv,0.5),xo=new u['Vector3'](...x3['nose']['metric']),xS=xp['subtract'](xo)['normalize'](),xd=xF['subtract'](xv)['normalize'](),xX=xd['cross'](xS)['add'](xS['scale'](0.05))['normalize'](),xa=this['tune']['headRatio']||0.32,xI=x4['head'][0x0]*xc,xQ=xp['add'](xX['cross'](xd)['scale'](0.025)),xw=xQ['add'](xX['scale'](-xa*xI)),xW=xQ['add'](xX['scale']((0x1-xa)*xI)),xM=u['Vector3']['Lerp'](xw,xW,0x2),xs=u['Vector3']['Lerp'](xg,xd,0.5),xB=xE?xf['add'](xE):xf['clone'](),xl=xE?xP['add'](xE):xP['clone'](),xR=u['Vector3']['Lerp'](x6,xB,x4['spine'][0x0]),xH=u['Vector3']['Lerp'](x7,xl,x4['spine'][0x0]),xk=u['Vector3']['Lerp'](xR,xH,0.5),xD=xR['subtract'](xH),xU=u['Vector3']['Lerp'](x6,xB,x4['spine1'][0x0]),xJ=u['Vector3']['Lerp'](x7,xl,x4['spine1'][0x0]),xK=u['Vector3']['Lerp'](xU,xJ,0.5),xh=xU['subtract'](xJ),xY=u['Vector3']['Lerp'](x6,xB,x4['spine2'][0x0]),xz=u['Vector3']['Lerp'](x7,xl,x4['spine2'][0x0]),xO=u['Vector3']['Lerp'](xY,xz,0.5),xC=xU['subtract'](xz);if(this['tune']['spineCurve']){const fa=xf['subtract'](x8),fI=xP['subtract'](x8)['cross'](fa)['normalize'](),fQ=this['tune']['spineCurve']*xc;xk['addInPlace'](fI['scale'](x4['spine'][0x1]*fQ)),xK['addInPlace'](fI['scale'](x4['spine1'][0x1]*fQ)),xO['addInPlace'](fI['scale'](x4['spine2'][0x1]*fQ));}const xZ=new u['Vector3'](...x3['wristL']['metric']),xj=xZ['subtract'](xA)['normalize']()['subtract'](xq)['negate'](),xV=xi['clone'](),xn=u['Vector3']['Lerp'](xj,xV,0.5),f0=new u['Vector3'](...x3['indexL']['metric']),f1=new u['Vector3'](...x3['pinkyL']['metric']),f2=u['Vector3']['Lerp'](f0,f1,0.5),f3=f1['subtract'](f0),f4=new u['Vector3'](...x3['wristR']['metric']),f5=f4['subtract'](xy)['normalize']()['subtract'](xG),f6=xi['negate'](),f7=u['Vector3']['Lerp'](f5,f6,0.5),f8=new u['Vector3'](...x3['indexR']['metric']),f9=new u['Vector3'](...x3['pinkyR']['metric']),fx=u['Vector3']['Lerp'](f8,f9,0.5),ff=f8['subtract'](f9),fP=new u['Vector3'](...x3['kneeL']['metric']),fA=new u['Vector3'](...x3['ankleL']['metric']),fy=new u['Vector3'](...x3['footIndexL']['metric']),fr=new u['Vector3'](...x3['heelL']['metric']),fg=fA['subtract'](fP)['normalize'](),fL=fy['subtract'](fr)['normalize'](),fi=fg['cross'](fL)['normalize'](),fu=u['Vector3']['Lerp'](fr,fy,0.8),fb=u['Vector3']['Lerp'](xx,fi,0.2),fq=u['Vector3']['Lerp'](xx,fi,0.6),fG=new u['Vector3'](...x3['kneeR']['metric']),fE=new u['Vector3'](...x3['ankleR']['metric']),fc=new u['Vector3'](...x3['footIndexR']['metric']),fm=new u['Vector3'](...x3['heelR']['metric']),fT=fE['subtract'](fG)['normalize'](),fN=fc['subtract'](fm)['normalize'](),fF=fT['cross'](fN)['normalize'](),fv=u['Vector3']['Lerp'](fm,fc,0.8),fp=u['Vector3']['Lerp'](xx,fF,0.2),fo=u['Vector3']['Lerp'](xx,fF,0.6);return{'hips':this['estimateBone'](x8,xk,x9),'spine':this['estimateBone'](xk,xK,xD),'spine1':this['estimateBone'](xK,xO,xh),'spine2':this['estimateBone'](xO,xu,xC),'neck':this['estimateBone'](xu,xw,xs),'head':this['estimateBone'](xw,xW,xd),'headEnd':this['estimateBone'](xW,xM,xd),'shoulderL':this['estimateBone'](xT,xf,xV),'armL':this['estimateBone'](xf,xA,xn),'foreArmL':this['estimateBone'](xA,xZ,xj),'handL':this['estimateBone'](xZ,f2,f3),'shoulderR':this['estimateBone'](xN,xP,f6),'armR':this['estimateBone'](xP,xy,f7),'foreArmR':this['estimateBone'](xy,f4,f5),'handR':this['estimateBone'](f4,fx,ff),'upLegL':this['estimateBone'](x6,fP,fb),'legL':this['estimateBone'](fP,fA,fq),'footL':this['estimateBone'](fA,fu,fi),'toeL':this['estimateBone'](fu,fy,fi),'upLegR':this['estimateBone'](x7,fG,fp),'legR':this['estimateBone'](fG,fE,fo),'footR':this['estimateBone'](fE,fv,fF),'toeR':this['estimateBone'](fv,fc,fF)};}['estimateBone'](x3,x4,x5){const x6=x4['subtract'](x3)['normalize'](),x7=x5['clone']()['normalize']()['cross'](x6)['normalize'](),x8=x6['cross'](x7);return{'position':x3['clone'](),'rotation':u['Quaternion']['RotationQuaternionFromAxis'](x8,x6,x7)};}['alignBone'](x3,x4,x5=!0x0){let x6=x3['rotation']['clone'](),x7=x3['position']['clone']();x4['parent']instanceof u['TransformNode']&&(x7=u['Vector3']['TransformCoordinates'](x7,x4['parent']['computeWorldMatrix'](!0x0)['clone']()['invert']()),x6=x4['parent']['absoluteRotationQuaternion']['conjugate']()['multiply'](x6),x5&&(x4['parent']['scaling']['setAll'](x7['length']()/x4['position']['length']()),x7=u['Vector3']['TransformCoordinates'](x3['position']['clone'](),x4['parent']['computeWorldMatrix'](!0x0)['clone']()['invert']()))),x4['position']=x7,x4['rotationQuaternion']=x6;}}class R extends l{constructor(x3,x4,x5={'spineCurve':0.5,'neckAdjust':0.01,'headRatio':0.32,'shoulderDY':-0.01,'shoulderDZ':0.005}){super(x3,x5),this['outfit']=x4;}['setNode'](x3){super['setNode'](x3);const {outfit:x4,node:x5}=this;!x4||!x5||x5['getChildMeshes']()['forEach'](x6=>{const x7=x8=>x8==null?void 0x0:x8['some'](x9=>typeof x9=='string'?x6['name']===x9:x9['test'](x6['name']));if(x7(x4['occluders'])){x6['material']&&(x6['material']['disableColorWrite']=!0x0,x6['material']['needDepthPrePass']=!0x0),x6['renderingGroupId']=0x0;return;}if(x7(x4['hidden'])){x6['setEnabled'](!0x1);return;}});}['setOutfit'](x3,x4){this['outfit']=x4,this['setNode'](x3);}}class k extends l{constructor(x3,x4,x5,x6,x7={'spineCurve':0.5,'neckAdjust':0.01,'headRatio':0.32,'shoulderDY':-0.01,'shoulderDZ':0.005}){super(x3,x7),this['translation']=x4,this['rotation']=x5,this['scale']=x6;}async['update'](x3,x4){await super['update'](x3,x4);const x5=x3['poses']&&x3['poses']['length']>0x0?x3['poses'][0x0]['points']:void 0x0,{node:x6,translation:x7,rotation:x8,scale:x9}=this;if(!x6||!x5)return;const xx=new u['Vector3'](...x5['hipL']['metric']),xf=new u['Vector3'](...x5['hipR']['metric']),xP=u['Vector3']['Lerp'](xx,xf,0.5);x6['position']=x7?xP['add'](x7):xP,x8&&(x6['rotationQuaternion']=x8),x9&&(x6['scaling']=new u['Vector3']()['setAll'](x9));}['updateSpine'](x3){const {skeleton:x4,spineRef:x5}=this;!x4||!x5||(this['alignBone'](x3['hips'],x4['hips']),this['alignBone'](x3['spine'],x4['spine']),this['alignBone'](x3['spine1'],x4['spine1']),this['alignBone'](x3['spine2'],x4['spine2']),this['alignBone'](x3['neck'],x4['neck']),this['alignBone'](x3['head'],x4['head']),this['alignBone'](x3['shoulderL'],x4['shoulderL']),this['alignBone'](x3['shoulderR'],x4['shoulderR']));}['alignBone'](x3,x4){let x5=x3['rotation']['clone']();x4['parent']instanceof u['TransformNode']&&(x4['parent']['computeWorldMatrix'](!0x0),x5=x4['parent']['absoluteRotationQuaternion']['conjugate']()['multiply'](x5)),x4['rotationQuaternion']=x5;}}class D extends A{async['update'](x3,x4){const x5=x3['poses']&&x3['poses']['length']>0x0?x3['poses'][0x0]:void 0x0,{videoCtx:x6}=this;if(!x5||!x6)return super['update'](x3,x4);const {points:x7,debug:x8}=x5,{width:x9,height:xx}=x6['canvas'];if(x6['fillStyle']='rgba(55,\x20145,\x20116,\x200.75)',x6['strokeStyle']='rgba(27,\x2074,\x2059,\x200.95)',x6['lineWidth']=0x2,Object['values'](x7)['forEach'](xA=>{xA['score']<0.5||(x6['beginPath'](),x6['arc'](xA['pixel'][0x0]*x9,xA['pixel'][0x1]*xx,0x6,0x0,0x2*Math['PI']),x6['fill'](),x6['stroke']());}),x6['strokeStyle']='rgba(43,\x20114,\x20135,\x200.75)',x6['lineWidth']=0x4,this['drawPath'](x6,x9,xx,[x7['shoulderL'],x7['shoulderR'],x7['hipR'],x7['hipL']],!0x0),this['drawPath'](x6,x9,xx,[x7['shoulderR'],x7['elbowL'],x7['wristL']]),this['drawPath'](x6,x9,xx,[x7['shoulderR'],x7['elbowR'],x7['wristR']]),this['drawPath'](x6,x9,xx,[x7['hipL'],x7['kneeL'],x7['ankleL']]),this['drawPath'](x6,x9,xx,[x7['hipR'],x7['kneeR'],x7['ankleR']]),!x8)return;const xf=[(x8['top'][0x0]-x8['center'][0x0])*x9,(x8['top'][0x1]-x8['center'][0x1])*xx],xP=Math['sqrt'](xf[0x0]*xf[0x0]+xf[0x1]*xf[0x1]);x6['fillStyle']='rgba(235,\x2072,\x200,\x200.3)',x6['strokeStyle']='rgba(105,\x2031,\x200,\x200.85)',x6['lineWidth']=0x4,x6['beginPath'](),x6['arc'](x8['center'][0x0]*x9,x8['center'][0x1]*xx,xP,0x0,0x2*Math['PI']),x6['fill'](),x6['stroke'](),x6['beginPath'](),x6['moveTo'](x8['center'][0x0]*x9,x8['center'][0x1]*xx),x6['lineTo'](x8['top'][0x0]*x9,x8['top'][0x1]*xx),x6['stroke']();}['drawPath'](x3,x4,x5,x6,x7){const x8=new Path2D();x8['moveTo'](x6[0x0]['pixel'][0x0]*x4,x6[0x0]['pixel'][0x1]*x5);for(let x9=0x1;x9<x6['length'];x9++)x6[x9]['score']>0.5&&x6[x9-0x1]['score']>0.5?x8['lineTo'](x6[x9]['pixel'][0x0]*x4,x6[x9]['pixel'][0x1]*x5):x8['moveTo'](x6[x9]['pixel'][0x0]*x4,x6[x9]['pixel'][0x1]*x5);x7&&x6[0x0]['score']>0.5&&x6[x6['length']-0x1]['score']>0.5&&x8['closePath'](),x3['stroke'](x8);}}class U extends y{constructor(x3,x4,x5=0x1){super(x3,x4,['image'],{'size':'2f','flip':'1f'},'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20precision\x20mediump\x20float;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20varying\x20vec2\x20coords;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uniform\x20vec2\x20size;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uniform\x20sampler2D\x20image;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20void\x20main()\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20float\x20res\x20=\x20texture2D(image,\x20coords).r;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20x\x20=\x20-'+x5+';\x20x\x20<=\x20'+x5+';\x20x++)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20y\x20=\x20-'+x5+';\x20y\x20<=\x20'+x5+';\x20y++)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20res\x20=\x20max(res,\x20texture2D(image,\x20coords\x20+\x20vec2(x,\x20y)\x20/\x20size).r);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20vec4(res,\x20res,\x20res,\x201.0);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}',void 0x0,!0x0);}}const J=0.5,K=0x200,h=20.1,Y='\x0a\x20\x20\x20\x20precision\x20mediump\x20float;\x0a\x20\x20\x20\x20varying\x20vec2\x20coords;\x0a\x20\x20\x20\x20uniform\x20vec2\x20size;\x0a\x20\x20\x20\x20uniform\x20vec4\x20box;\x0a\x20\x20\x20\x20uniform\x20sampler2D\x20image;\x0a\x20\x20\x20\x20uniform\x20sampler2D\x20mask;\x0a\x0a\x20\x20\x20\x20float\x20readMask(vec2\x20coords,\x20float\x20dx,\x20float\x20dy)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20return\x20texture2D(mask,\x20(coords\x20+\x20vec2(dx,\x20dy)\x20/\x20size\x20-\x20box.xy)\x20/\x20box.zw).r;\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20void\x20main()\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20bool\x20bg\x20=\x20texture2D(mask,\x20(coords\x20-\x20box.xy)\x20/\x20(box.zw)).r\x20<\x20'+J+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20color\x20=\x20texture2D(image,\x20coords);\x0a\x20\x20\x20\x20\x20\x20\x20\x20if\x20(bg)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20x0\x20=\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20xi\x20=\x201;\x20xi\x20<\x20'+K+';\x20xi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20x0\x20=\x20bg\x20?\x20x0\x20:\x20float(xi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x20-x0,\x200.0)\x20<\x20'+J+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cx0\x20=\x20bg\x20?\x20texture2D(image,\x20coords\x20+\x20vec2(-x0,\x200)\x20/\x20size)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20cx0\x20=\x20bg\x20&&\x20x0\x20<\x20'+h+'\x20&&\x20readMask(coords,\x20-x0\x20*\x202.0\x20+\x201.0,\x200.0)\x20<\x20'+J+'\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(-x0\x20*\x202.0\x20+\x201.0,\x200)\x20/\x20size)\x20:\x20cx0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20x0\x20=\x20bg\x20?\x201.0\x20/\x20x0\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20x1\x20=\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20xi\x20=\x201;\x20xi\x20<\x20'+K+';\x20xi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20x1\x20=\x20bg\x20?\x20x1\x20:\x20float(xi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x20x1,\x200.0)\x20<\x20'+J+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cx1\x20=\x20bg\x20?\x20texture2D(image,\x20coords\x20+\x20vec2(x1,\x200)\x20/\x20size)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20cx1\x20=\x20bg\x20&&\x20x1\x20<\x20'+h+'\x20&&\x20readMask(coords,\x20x1\x20*\x202.0\x20-\x201.0,\x200.0)\x20<\x20'+J+'\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(x1\x20*\x202.0\x20-\x201.0,\x200)\x20/\x20size)\x20:\x20cx1;\x0a\x20\x20\x20\x20\x20\x20\x20\x20x1\x20=\x20bg\x20?\x201.0\x20/\x20x1\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20y0\x20=\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20yi\x20=\x201;\x20yi\x20<\x20'+K+';\x20yi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20y0\x20=\x20bg\x20?\x20y0\x20:\x20float(yi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x200.0,\x20-y0)\x20<\x20'+J+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cy0\x20=\x20bg\x20?\x20texture2D(image,\x20coords\x20+\x20vec2(0,\x20-y0)\x20/\x20size)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20cy0\x20=\x20bg\x20&&\x20y0\x20<\x20'+h+'\x20&&\x20readMask(coords,\x200.0,\x20-2.0\x20*\x20y0\x20+\x201.0)\x20<\x20'+J+'\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(0,\x20-2.0\x20*\x20y0\x20+\x201.0)\x20/\x20size)\x20:\x20cy0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20y0\x20=\x20bg\x20?\x201.0\x20/\x20y0\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20y1\x20=\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20yi\x20=\x201;\x20yi\x20<\x20'+K+';\x20yi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20y1\x20=\x20bg\x20?\x20y1\x20:\x20float(yi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x200.0,\x20y1)\x20<\x20'+J+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cy1\x20=\x20bg\x20?\x20texture2D(image,\x20coords\x20+\x20vec2(0,\x20y1)\x20/\x20size)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20cy1\x20=\x20bg\x20&&\x20y1\x20<\x20'+h+'\x20&&\x20readMask(coords,\x200.0,\x202.0\x20*\x20y1\x20+\x201.0)\x20<\x20'+J+'\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(0,\x202.0\x20*\x20y1\x20+\x201.0)\x20/\x20size)\x20:\x20cy1;\x0a\x20\x20\x20\x20\x20\x20\x20\x20y1\x20=\x20bg\x20?\x201.0\x20/\x20y1\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20s\x20=\x201.0\x20/\x20(x0\x20+\x20x1\x20+\x20y0\x20+\x20y1);\x0a\x20\x20\x20\x20\x20\x20\x20\x20color\x20=\x20cx0\x20*\x20x0\x20*\x20s\x20+\x20cx1\x20*\x20x1\x20*\x20s\x20+\x20cy0\x20*\x20y0\x20*\x20s\x20+\x20cy1\x20*\x20y1\x20*\x20s;\x0a\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20color;\x0a\x20\x20\x20\x20}\x0a';class z extends r{constructor(){super(['image','mask'],{'size':'2f','flip':'1f','box':'4f'},Y);}async['load'](x3){const x4=x3 instanceof g&&x3['shaderCtx'];if(this['loaded']||!x4)return;const x5={'width':0x100,'height':0x100};return this['maskTexture']=new i(x4,x5,!0x0),this['dilationShader']=new U(x4,x5,0x2),super['load'](x3);}['unload'](){var x3,x4;!this['loaded']||((x3=this['dilationShader'])==null||x3['dispose'](),delete this['dilationShader'],(x4=this['maskTexture'])==null||x4['dispose'](),delete this['maskTexture'],super['unload']());}['process'](x3,x4){var x5,x6,x7,x8,x9,xx,xf,xP;const xA=x3['poses']&&x3['poses']['length']>0x0&&x3['poses'][0x0]['mask'];if(!xA)return!0x1;(x5=this['maskTexture'])==null||x5['resize'](xA['size']),(x6=this['maskTexture'])==null||x6['update'](xA['buffer']),(x7=this['dilationShader'])==null||x7['resize'](xA['size']),(x9=this['dilationShader'])==null||x9['process']([((x8=this['maskTexture'])==null?void 0x0:x8['texture']())||null]);const xy=xA['box'];return(xP=this['shader'])==null||xP['process']([x4,((xf=(xx=this['dilationShader'])==null?void 0x0:xx['output'])==null?void 0x0:xf['texture']())||null],{'box':[xy[0x0][0x0],xy[0x0][0x1],xy[0x1][0x0]-xy[0x0][0x0],xy[0x1][0x1]-xy[0x0][0x1]]}),!0x0;}}const C=0.5,t=0x200,Z=0x40,n=20.1,x0='\x0a\x20\x20\x20\x20precision\x20mediump\x20float;\x0a\x20\x20\x20\x20varying\x20vec2\x20coords;\x0a\x20\x20\x20\x20uniform\x20vec2\x20size;\x0a\x20\x20\x20\x20uniform\x20vec4\x20box;\x0a\x20\x20\x20\x20uniform\x20sampler2D\x20image;\x0a\x20\x20\x20\x20uniform\x20sampler2D\x20mask;\x0a\x20\x20\x20\x20uniform\x20sampler2D\x20part;\x0a\x0a\x20\x20\x20\x20float\x20readMask(vec2\x20coords,\x20float\x20dx,\x20float\x20dy)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20return\x20texture2D(mask,\x20(coords\x20+\x20vec2(dx,\x20dy)\x20/\x20size\x20-\x20box.xy)\x20/\x20box.zw).r;\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20vec4\x20readPart(vec2\x20coords,\x20int\x20dx,\x20int\x20dy)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec2\x20offset\x20=\x20coords\x20+\x20vec2(dx,\x20dy)\x20/\x20size;\x0a\x20\x20\x20\x20\x20\x20\x20\x20return\x20texture2D(part,\x20vec2(offset.x,\x201.0\x20-\x20offset.y));\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20void\x20main()\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20bool\x20bg\x20=\x20texture2D(mask,\x20(coords\x20-\x20box.xy)\x20/\x20(box.zw)).r\x20<\x20'+C+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20color\x20=\x20texture2D(image,\x20coords);\x0a\x20\x20\x20\x20\x20\x20\x20\x20if\x20(bg)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20part\x20=\x20texture2D(part,\x20vec2(coords.x,\x201.0\x20-\x20coords.y));\x0a\x20\x20\x20\x20\x20\x20\x20\x20if\x20(part.g\x20>\x200.5\x20||\x20part.r\x20>\x200.5)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20dmin\x20=\x20float('+(0x2*Z+0x1)+');\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20xi\x20=\x201;\x20xi\x20<\x20'+Z+';\x20xi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20partD\x20=\x20readPart(coords,\x20xi,\x200);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x20float(xi),\x200.0)\x20<\x20'+C+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bool\x20closer\x20=\x20!bg\x20&&\x20(partD.r\x20>\x200.5\x20||\x20partD.g\x20>\x200.5)\x20&&\x20float(xi)\x20<\x20dmin;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20part\x20=\x20closer\x20?\x20partD\x20:\x20part;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20dmin\x20=\x20closer\x20?\x20float(xi)\x20:\x20dmin;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20xi\x20=\x201;\x20xi\x20<\x20'+Z+';\x20xi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20partD\x20=\x20readPart(coords,\x20-xi,\x200);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x20float(-xi),\x200.0)\x20<\x20'+C+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bool\x20closer\x20=\x20!bg\x20&&\x20(partD.r\x20>\x200.5\x20||\x20partD.g\x20>\x200.5)\x20&&\x20float(xi)\x20<\x20dmin;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20part\x20=\x20closer\x20?\x20partD\x20:\x20part;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20dmin\x20=\x20closer\x20?\x20float(xi)\x20:\x20dmin;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20yi\x20=\x201;\x20yi\x20<\x20'+Z+';\x20yi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20partD\x20=\x20readPart(coords,\x200,\x20yi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x200.0,\x20float(yi))\x20<\x20'+C+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bool\x20closer\x20=\x20!bg\x20&&\x20(partD.r\x20>\x200.5\x20||\x20partD.g\x20>\x200.5)\x20&&\x20float(yi)\x20<\x20dmin;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20part\x20=\x20closer\x20?\x20partD\x20:\x20part;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20dmin\x20=\x20closer\x20?\x20float(yi)\x20:\x20dmin;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20yi\x20=\x201;\x20yi\x20<\x20'+Z+';\x20yi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20partD\x20=\x20readPart(coords,\x200,\x20-yi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x200.0,\x20float(-yi))\x20<\x20'+C+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bool\x20closer\x20=\x20!bg\x20&&\x20(partD.r\x20>\x200.5\x20||\x20partD.g\x20>\x200.5)\x20&&\x20float(yi)\x20<\x20dmin;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20part\x20=\x20closer\x20?\x20partD\x20:\x20part;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20dmin\x20=\x20closer\x20?\x20float(yi)\x20:\x20dmin;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20if\x20(part.g\x20>\x200.5\x20||\x20part.r\x20<=\x200.5)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20x0\x20=\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20xi\x20=\x201;\x20xi\x20<\x20'+t+';\x20xi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20x0\x20=\x20bg\x20?\x20x0\x20:\x20float(xi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x20-x0,\x200.0)\x20<\x20'+C+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cx0\x20=\x20bg\x20?\x20texture2D(image,\x20coords\x20+\x20vec2(-x0,\x200)\x20/\x20size)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20cx0\x20=\x20bg\x20&&\x20x0\x20<\x20'+n+'\x20&&\x20readMask(coords,\x20-x0\x20*\x202.0\x20+\x201.0,\x200.0)\x20<\x20'+C+'\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(-x0\x20*\x202.0\x20+\x201.0,\x200)\x20/\x20size)\x20:\x20cx0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20x0\x20=\x20bg\x20?\x201.0\x20/\x20x0\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20x1\x20=\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20xi\x20=\x201;\x20xi\x20<\x20'+t+';\x20xi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20x1\x20=\x20bg\x20?\x20x1\x20:\x20float(xi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x20x1,\x200.0)\x20<\x20'+C+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cx1\x20=\x20bg\x20?\x20texture2D(image,\x20coords\x20+\x20vec2(x1,\x200)\x20/\x20size)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20cx1\x20=\x20bg\x20&&\x20x1\x20<\x20'+n+'\x20&&\x20readMask(coords,\x20x1\x20*\x202.0\x20-\x201.0,\x200.0)\x20<\x20'+C+'\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(x1\x20*\x202.0\x20-\x201.0,\x200)\x20/\x20size)\x20:\x20cx1;\x0a\x20\x20\x20\x20\x20\x20\x20\x20x1\x20=\x20bg\x20?\x201.0\x20/\x20x1\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20y0\x20=\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20yi\x20=\x201;\x20yi\x20<\x20'+t+';\x20yi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20y0\x20=\x20bg\x20?\x20y0\x20:\x20float(yi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x200.0,\x20-y0)\x20<\x20'+C+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cy0\x20=\x20bg\x20?\x20texture2D(image,\x20coords\x20+\x20vec2(0,\x20-y0)\x20/\x20size)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20cy0\x20=\x20bg\x20&&\x20y0\x20<\x20'+n+'\x20&&\x20readMask(coords,\x200.0,\x20-2.0\x20*\x20y0\x20+\x201.0)\x20<\x20'+C+'\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(0,\x20-2.0\x20*\x20y0\x20+\x201.0)\x20/\x20size)\x20:\x20cy0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20y0\x20=\x20bg\x20?\x201.0\x20/\x20y0\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20y1\x20=\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20yi\x20=\x201;\x20yi\x20<\x20'+t+';\x20yi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20y1\x20=\x20bg\x20?\x20y1\x20:\x20float(yi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x200.0,\x20y1)\x20<\x20'+C+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cy1\x20=\x20bg\x20?\x20texture2D(image,\x20coords\x20+\x20vec2(0,\x20y1)\x20/\x20size)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20cy1\x20=\x20bg\x20&&\x20y1\x20<\x20'+n+'\x20&&\x20readMask(coords,\x200.0,\x202.0\x20*\x20y1\x20+\x201.0)\x20<\x20'+C+'\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(0,\x202.0\x20*\x20y1\x20+\x201.0)\x20/\x20size)\x20:\x20cy1;\x0a\x20\x20\x20\x20\x20\x20\x20\x20y1\x20=\x20bg\x20?\x201.0\x20/\x20y1\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20s\x20=\x201.0\x20/\x20(x0\x20+\x20x1\x20+\x20y0\x20+\x20y1);\x0a\x20\x20\x20\x20\x20\x20\x20\x20color\x20=\x20cx0\x20*\x20x0\x20*\x20s\x20+\x20cx1\x20*\x20x1\x20*\x20s\x20+\x20cy0\x20*\x20y0\x20*\x20s\x20+\x20cy1\x20*\x20y1\x20*\x20s;\x0a\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20color;\x0a\x20\x20\x20\x20}\x0a';class x1 extends r{constructor(x3=[],x4=[]){super(['image','mask','part'],{'size':'2f','flip':'1f','box':'4f'},x0),this['patchParts']=x3,this['keepParts']=x4,this['partsSkeletons']=[];}['setParts'](x3=[],x4=[]){this['partsSkeletons']=[],this['partsTarget']&&(this['patchParts']=x3,this['keepParts']=x4,this['partsTarget']['renderList']=[...x3,...x4],this['partsTarget']['setMaterialForRendering'](x3,this['patchMaterial']),this['partsTarget']['setMaterialForRendering'](x4,this['keepMaterial']),this['partsTarget']['renderList']['forEach'](x5=>x5['skeleton']&&this['partsSkeletons']['indexOf'](x5['skeleton'])<0x0&&this['partsSkeletons']['push'](x5['skeleton'])));}async['load'](x3){if(!(x3 instanceof d))return;const {scene:x4,shaderCtx:x5}=x3;if(this['loaded']||!x5)return;const x6={'width':0x100,'height':0x100};return this['maskTexture']=new i(x5,x6,!0x0),this['dilationShader']=new U(x5,x6,0x1),this['partsTarget']=new u['RenderTargetTexture']('masks',this['size'],x4),this['partsTarget']['clearColor']=new u['Color4'](0x0,0x0,0x0,0x1),this['patchMaterial']=new u['StandardMaterial']('PatchMaskMaterial',x4),this['patchMaterial']['emissiveColor']=new u['Color3'](0x0,0x1,0x0),this['keepMaterial']=new u['StandardMaterial']('KeepMaskMaterial',x4),this['keepMaterial']['emissiveColor']=new u['Color3'](0x1,0x0,0x0),this['setParts'](this['patchParts'],this['keepParts']),super['load'](x3);}['unload'](){var x3,x4,x5,x6,x7;!this['loaded']||((x3=this['dilationShader'])==null||x3['dispose'](),delete this['dilationShader'],(x4=this['maskTexture'])==null||x4['dispose'](),delete this['maskTexture'],(x5=this['partsTarget'])==null||x5['dispose'](),delete this['partsTarget'],(x6=this['patchMaterial'])==null||x6['dispose'](),delete this['patchMaterial'],(x7=this['keepMaterial'])==null||x7['dispose'](),delete this['keepMaterial'],super['unload']());}['process'](x3,x4){var x5,x6,x7,x8;const x9=x3['poses']&&x3['poses']['length']>0x0&&x3['poses'][0x0]['mask'],{partsTarget:xx,maskTexture:xf,dilationShader:xP,shader:xA}=this;if(!x9||!xx||!xf||!xP||!xA)return!0x1;this['partsSkeletons']['forEach'](xg=>xg['prepare']()),xx['render'](),xf['resize'](x9['size']),xf['update'](x9['buffer']),xP['resize'](x9['size']),xP['process']([((x5=this['maskTexture'])==null?void 0x0:x5['texture']())||null]);const xy=(x7=(x6=xx['getInternalTexture']())==null?void 0x0:x6['_hardwareTexture'])==null?void 0x0:x7['_webGLTexture'],xr=x9['box'];return xA==null||xA['process']([x4,((x8=xP['output'])==null?void 0x0:x8['texture']())||null,xy||null],{'box':[xr[0x0][0x0],xr[0x0][0x1],xr[0x1][0x0]-xr[0x0][0x0],xr[0x1][0x1]-xr[0x0][0x1]]}),!0x0;}['setupVideo'](x3){var x4;super['setupVideo'](x3),(x4=this['partsTarget'])==null||x4['resize'](x3),this['setParts'](this['patchParts'],this['keepParts']);}}class x2 extends F{constructor(x3,x4=0x0){super(),this['node']=x3,this['renderOrder']=x4;}async['load'](x3){if(!this['loaded'])return this['node']instanceof u['AbstractMesh']&&(this['node']['material']&&(this['node']['material']['disableColorWrite']=!0x0,this['node']['material']['needDepthPrePass']=!0x0),this['node']['renderingGroupId']=this['renderOrder']),this['node']['getChildMeshes'](!0x1)['forEach'](x4=>{x4['material']&&(x4['material']['disableColorWrite']=!0x0,x4['material']['needDepthPrePass']=!0x0),x4['renderingGroupId']=this['renderOrder'];}),super['load'](x3);}}export{F as BabylonPlugin,N as BabylonRenderer,d as BabylonUniRenderer,z as BodyPatchPlugin,x1 as BodypartPatchPlugin,s as BoneList,M as FaceDebugPlugin,e as FaceMaskPlugin,p as FacePlugin,a as FaceRenderer,w as FaceTrackPlugin,I as HeadTrackPlugin,x2 as OccluderPlugin,l as PoseAlignPlugin,D as PoseDebugPlugin,R as PoseOutfitPlugin,v as PosePlugin,X as PoseRenderer,k as PoseTwinPlugin,B as mapSkeleton};
